!function(t){function i(i){for(var s,n,a=i[0],l=i[1],h=i[2],u=0,_=[];u<a.length;u++)n=a[u],o[n]&&_.push(o[n][0]),o[n]=0;for(s in l)Object.prototype.hasOwnProperty.call(l,s)&&(t[s]=l[s]);for(c&&c(i);_.length;)_.shift()();return r.push.apply(r,h||[]),e()}function e(){for(var t,i=0;i<r.length;i++){for(var e=r[i],s=!0,a=1;a<e.length;a++){var l=e[a];0!==o[l]&&(s=!1)}s&&(r.splice(i--,1),t=n(n.s=e[0]))}return t}var s={},o={1:0};var r=[];function n(i){if(s[i])return s[i].exports;var e=s[i]={i:i,l:!1,exports:{}};return t[i].call(e.exports,e,e.exports,n),e.l=!0,e.exports}n.m=t,n.c=s,n.d=function(t,i,e){n.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:e})},n.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},n.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(i,"a",i),i},n.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},n.p="/";var a=window.webpackJsonp=window.webpackJsonp||[],l=a.push.bind(a);a.push=i,a=a.slice();for(var h=0;h<a.length;h++)i(a[h]);var c=l;r.push([22,0]),e()}([,function(t,i,e){"use strict";e.d(i,"e",function(){return s}),e.d(i,"d",function(){return a}),e.d(i,"a",function(){return l}),e.d(i,"b",function(){return h}),e.d(i,"c",function(){return _});var s,o,r,n=e(0);!function(t){t[t.Wall=0]="Wall",t[t.Door=1]="Door",t[t.Floor=2]="Floor"}(s||(s={}));class a{constructor(t,i,e){this.key=t,this.display=i,this.type=e,a.register(t,this)}static register(t,i){if(this.repository[t])throw`Tile '${t}' is already registered!`;this.repository[t]=i}static retrive(t){let i=this.repository[t];if(!i)throw`Tile '${t}' is not registered!`;return i}visibleThrough(){return this.type===s.Floor}}a.repository={},new a("R"," ",s.Floor),new a("C"," ",s.Floor),new a("W","#",s.Wall),new a("D","+",s.Door);class l{constructor(t,i){if(this.content=t,this.weight=i,t.length!==l.Dimensions||t.some(t=>t.length!==l.Dimensions))throw`Invalid block '${t}'`;this.id=t.map(t=>t.map(t=>t.key).join("")).join("")}matchRight(t){return this.matchHorizontal(this,t)}matchLeft(t){return this.matchHorizontal(t,this)}matchTop(t){return this.matchVertical(t,this)}matchBootom(t){return this.matchVertical(this,t)}mirrorVertically(){return new l(n.cloneDeep(this.content).reverse(),this.weight)}mirrorHorizontally(){return new l(n.cloneDeep(this.content).map(t=>t.reverse()),this.weight)}rotateRight(){return new l(this.rotate(n.cloneDeep(this.content)),this.weight)}rotate(t){let i;t=t.reverse();for(let e=0;e<t.length;e++)for(let s=0;s<e;s++)i=t[e][s],t[e][s]=t[s][e],t[s][e]=i;return t}matchHorizontal(t,i){return n.isEqual(t.content.map(t=>t[l.Dimensions-1]),i.content.map(t=>t[0]))}matchVertical(t,i){return n.isEqual(t.content[l.Dimensions-1],i.content[0])}}l.Dimensions=3,function(t){t[t.Top=0]="Top",t[t.Bottom=1]="Bottom",t[t.Left=2]="Left",t[t.Right=3]="Right"}(o||(o={}));class h{constructor(t){this.borderBlock=t,this.blocks=[],this.uniqBlockIds=new Set,this.neighbors={},this.addBlock(t)}addBlock(t,i=!1){if(this.uniqBlockIds.has(t.id))return;if(this.blocks.push(t),this.uniqBlockIds.add(t.id),this.findNeighbors(t),!i){const i=t.mirrorHorizontally();this.addBlock(i,!0),this.addBlock(t.mirrorVertically(),!0),this.addBlock(i.mirrorVertically(),!0)}let e=t.rotateRight();for(let t=0;t<3;t++)this.addBlock(e,!0),e=e.rotateRight()}available(t,i,e,s){let r=this.blocks;return void 0!==t&&(r=n.intersection(r,this.neighbors[t.id][o.Bottom])),void 0!==i&&(r=n.intersection(r,this.neighbors[i.id][o.Top])),void 0!==e&&(r=n.intersection(r,this.neighbors[e.id][o.Right])),void 0!==s&&(r=n.intersection(r,this.neighbors[s.id][o.Left])),n.sortBy(r,t=>Math.random()*t.weight)}findNeighbors(t){this.blocks.forEach(i=>{t.matchTop(i)&&(this.addNeighbor(t,i,o.Top),this.addNeighbor(i,t,o.Bottom)),t.matchBootom(i)&&(this.addNeighbor(t,i,o.Bottom),this.addNeighbor(i,t,o.Top)),t.matchLeft(i)&&(this.addNeighbor(t,i,o.Left),this.addNeighbor(i,t,o.Right)),t.matchRight(i)&&(this.addNeighbor(t,i,o.Right),this.addNeighbor(i,t,o.Left))})}addNeighbor(t,i,e){this.neighbors[t.id]||(this.neighbors[t.id]={[o.Top]:[],[o.Bottom]:[],[o.Left]:[],[o.Right]:[]}),this.neighbors[t.id][e].push(i)}}!function(t){t[t.EMPTY=0]="EMPTY",t[t.CONFIRMED=1]="CONFIRMED"}(r||(r={}));class c{constructor(){this.state=r.EMPTY}isFinished(){return void 0!==this.block&&this.state===r.CONFIRMED}confirmBlock(){this.state=r.CONFIRMED}}class u{static addDoor(){return Math.random()>.5}}class _{constructor(t,i,e){this.width=t,this.height=i,this.blockRepository=e,this.blockMap=[],this.map=[],this.steps=0,this.initializeBlockMap()}initializeBlockMap(){for(let t=0;t<this.height;t++){let i=[];for(let e=0;e<this.width;e++){let s=new c;0!==t&&0!==e&&t!==this.height-1&&e!==this.width-1||(s.confirmBlock(),s.block=this.blockRepository.borderBlock),i.push(s)}this.blockMap.push(i)}}toMap(){return this.map}fillMap(t,i){if(void 0!==this.blockMap[t][i].block)return!0;if(this.steps+=1,this.steps>1e5)throw"failed to generate";const e=this.blockMap[t-1][i].block,s=this.blockMap[t+1][i].block,o=this.blockMap[t][i-1].block,r=this.blockMap[t][i+1].block,n=this.blockRepository.available(e,s,o,r);for(let e=0;e<n.length;e++){const s=n[e];if(this.blockMap[t][i].block=s,this.fillMap(t-1,i)&&this.fillMap(t,i-1)&&this.fillMap(t+1,i)&&this.fillMap(t,i+1))break;this.blockMap[t][i].block=void 0}return void 0!==this.blockMap[t][i].block}postProcess(){this.buildMap(),this.addDoors()}buildMap(){const t=this.height-1,i=this.width-1;for(let e=1;e<t;e++)for(let s=0;s<l.Dimensions-(e===t-1?0:1);s++){let t=[];for(let o=1;o<i;o++){const r=this.blockMap[e][o].block;if(r){const e=r.content[s];t=t.concat(o===i-1?e:n.initial(e))}else{const i=new Array(l.Dimensions).fill(" ");t=t.concat(i)}}this.map.push(t)}}addDoors(){for(let t=1;t<this.map.length;t++){const i=this.map[t];for(let e=1;e<i.length;e++)"C"!==i[e].key||"R"!==this.map[t][e-1].key&&"R"!==this.map[t-1][e].key||!u.addDoor()||(i[e]=a.retrive("D"))}}}},,,function(module,__webpack_exports__,__webpack_require__){"use strict";var vue__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),_Cell_vue__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(6),_fov__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(7),lodash__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(0),lodash__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(lodash__WEBPACK_IMPORTED_MODULE_3__),_grid__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(1);__webpack_exports__.a=vue__WEBPACK_IMPORTED_MODULE_0__.a.extend({data:()=>({blocks:[{content:["WWW","WWW","WWW"],weight:.5},{content:["RRR","RRR","RRR"],weight:20},{content:["WCW","RRR","RRR"],weight:20},{content:["WWC","RRR","RRR"],weight:20},{content:["CWC","RRR","RRR"],weight:20},{content:["WWW","RRR","RRR"],weight:20},{content:["WCW","CRR","WRR"],weight:20},{content:["WWW","WRR","WRR"],weight:20},{content:["WWW","CRR","WRR"],weight:20},{content:["WWC","WRR","WRR"],weight:20},{content:["WWC","WRR","CRR"],weight:20},{content:["WWW","CCW","WCW"],weight:20},{content:["WWW","CCC","WWW"],weight:20},{content:["WCW","CCC","WWW"],weight:20},{content:["WCW","CCC","WCW"],weight:20}],map:[],radius:10,player:{x:1,y:1}}),components:{Cell:_Cell_vue__WEBPACK_IMPORTED_MODULE_1__.a},computed:{fov(){return this.map?new _fov__WEBPACK_IMPORTED_MODULE_2__.a(this.player.x,this.player.y,this.radius,this.map[0].length,this.map.length,(t,i)=>!this.map[i][t].visibleThrough()).build():[]}},methods:{updatePlayerPosition(t,i){this.player.x=t,this.player.y=i},buildMap(){let t=new _grid__WEBPACK_IMPORTED_MODULE_4__.b(new _grid__WEBPACK_IMPORTED_MODULE_4__.a(this.rawToTiles(this.blocks[0].content),this.blocks[0].weight));lodash__WEBPACK_IMPORTED_MODULE_3__.tail(this.blocks).forEach(({content:i,weight:e})=>{t.addBlock(new _grid__WEBPACK_IMPORTED_MODULE_4__.a(this.rawToTiles(i),e))});let i=new _grid__WEBPACK_IMPORTED_MODULE_4__.c(20,20,t);return i.fillMap(1,1),i.postProcess(),i.toMap()},rawToTiles(t){let i=[];return t.forEach(t=>{let e=[];t.split("").forEach(t=>{e.push(_grid__WEBPACK_IMPORTED_MODULE_4__.d.retrive(t))}),i.push(e)}),i},visibility(t,i){return this.fov[t][i].visible?{opacity:this.fov[t][i].degree}:{background:"black",color:"black"}}},created(){eval("this.map = this.buildMap()")}})},,function(t,i,e){"use strict";var s=e(2),o=e(1),r=s.a.extend({props:["cell","player"],computed:{style(){return this.player?"player":this.cell.type==o.e.Wall?"wall":this.cell.type==o.e.Door?"door":"floor"},symbol(){return this.player?"俺":" "==this.cell.display?"・":"+"==this.cell.display?"戸":"#"==this.cell.display?"＃":"E"}}}),n=e(5);var a=function(t){e(16)},l=Object(n.a)(r,function(){var t=this,i=t.$createElement;return(t._self._c||i)("td",{class:t.style,domProps:{textContent:t._s(t.symbol)},on:{mouseover:function(i){t.$emit("click")}}})},[],!1,a,null,null);i.a=l.exports},function(t,i,e){"use strict";e.d(i,"a",function(){return s});class s{constructor(t,i,e,s,o,r){this.startx=t,this.starty=i,this.radius=e,this.width=s,this.height=o,this.checkSolid=r,this.lightMap=[],this.doubleRadius=this.radius*this.radius}build(){this.lightMap=new Array(this.height);for(let t=0;t<this.height;t++){this.lightMap[t]=new Array(this.width);for(let i=0;i<this.width;i++)this.lightMap[t][i]={visible:!0,degree:.1}}return this.lightMap[this.starty][this.startx]={visible:!0,degree:1},this.checkSolid(this.startx,this.starty)||[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([t,i])=>{this.castLight(1,1,0,0,t,i,0),this.castLight(1,1,0,t,0,0,i)}),this.lightMap}castLight(t,i,e,s,o,r,n){if(i<e)return;let a=0,l=!1;for(let h=t;h<=this.radius&&!l;h++){let t=-h;for(let c=-h;c<=0;c++){let u=Math.round(this.startx+c*s+t*o),_=Math.round(this.starty+c*r+t*n),d=(c-.5)/(t+.5),p=(c+.5)/(t-.5);if(u>=0&&_>=0&&u<this.width&&_<this.height&&!(i<p)){if(e>d)break;this.doubleDistance(c,t)<=this.doubleRadius&&(this.lightMap[_][u]={visible:!0,degree:1-this.doubleDistance(c,t)/this.doubleRadius}),l?this.checkSolid(u,_)?a=p:(l=!1,i=a):this.checkSolid(u,_)&&h<this.radius&&(l=!0,this.castLight(h+1,i,d,s,o,r,n),a=p)}}}}doubleDistance(t,i){return t*t+i*i}}},function(t,i,e){"use strict";e.r(i);var s=e(2),o=e(4),r=e(5);var n=function(t){e(18)},a=Object(r.a)(o.a,function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{attrs:{id:"app"}},[e("div",{staticClass:"col"},[e("table",{staticClass:"game-table"},t._l(t.map,function(i,s){return e("tr",{staticClass:"row"},t._l(i,function(i,o){return e("Cell",{key:s+"-"+o,style:t.visibility(s,o),attrs:{cell:i,player:t.player.x==o&&t.player.y==s},on:{click:function(i){t.updatePlayerPosition(o,s)}}})}))})),e("button",{on:{click:function(i){t.map=t.buildMap()}}},[t._v("Generate!")]),e("label",[t._v("radius")]),e("input",{directives:[{name:"model",rawName:"v-model",value:t.radius,expression:"radius"}],attrs:{type:"number"},domProps:{value:t.radius},on:{input:function(i){i.target.composing||(t.radius=i.target.value)}}})]),e("div",{staticClass:"col"},t._l(t.blocks,function(i,s){return e("div",{staticClass:"block"},[e("div",{staticClass:"wrapper"},[e("table",{staticClass:"content game-table"},t._l(t.rawToTiles(i.content),function(i,s){return e("tr",{staticClass:"row"},t._l(i,function(t,i){return e("Cell",{key:s+"-"+i,attrs:{cell:t}})}))})),e("input",{directives:[{name:"model",rawName:"v-model",value:i.weight,expression:"tile.weight"}],attrs:{type:"number"},domProps:{value:i.weight},on:{input:function(e){e.target.composing||t.$set(i,"weight",e.target.value)}}})])])}))])},[],!1,n,null,null).exports;e(13),e(11);new s.a({el:"#app",render:t=>t(a)})},,,,,function(t,i,e){},,,function(t,i,e){},,function(t,i,e){},,,,function(t,i,e){t.exports=e(8)}]);
//# sourceMappingURL=main.c932854e.js.map
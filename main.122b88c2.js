!function(t){function e(e){for(var i,n,o=e[0],h=e[1],l=e[2],u=0,d=[];u<o.length;u++)n=o[u],r[n]&&d.push(r[n][0]),r[n]=0;for(i in h)Object.prototype.hasOwnProperty.call(h,i)&&(t[i]=h[i]);for(c&&c(e);d.length;)d.shift()();return a.push.apply(a,l||[]),s()}function s(){for(var t,e=0;e<a.length;e++){for(var s=a[e],i=!0,o=1;o<s.length;o++){var h=s[o];0!==r[h]&&(i=!1)}i&&(a.splice(e--,1),t=n(n.s=s[0]))}return t}var i={},r={0:0},a=[];function n(e){if(i[e])return i[e].exports;var s=i[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=i,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(s,i,function(e){return t[e]}.bind(null,i));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/onisun/";var o=window.webpackJsonp=window.webpackJsonp||[],h=o.push.bind(o);o.push=e,o=o.slice();for(var l=0;l<o.length;l++)e(o[l]);var c=h;a.push([29,1]),s()}([,,,,,,,function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},,,,,,,,,,,function(t,e,s){t.exports=s(83)},,,,,,,,,,,,,,,,function(t,e,s){"use strict";var i=s(7);s.n(i).a},,function(t,e,s){"use strict";var i=s(8);s.n(i).a},,function(t,e,s){"use strict";var i=s(9);s.n(i).a},,function(t,e,s){"use strict";var i=s(10);s.n(i).a},,function(t,e,s){"use strict";var i=s(11);s.n(i).a},,function(t,e,s){"use strict";var i=s(12);s.n(i).a},,function(t,e,s){"use strict";var i=s(13);s.n(i).a},,function(t,e,s){"use strict";var i=s(14);s.n(i).a},,function(t,e,s){"use strict";var i=s(15);s.n(i).a},,function(t,e,s){"use strict";var i=s(16);s.n(i).a},,function(t,e,s){"use strict";var i=s(17);s.n(i).a},,function(t,e,s){"use strict";var i=s(18);s.n(i).a},,,,,,,,,,function(t,e,s){},,,,,,function(t,e,s){"use strict";s.r(e);var i=s(1),r=s(0);const a=function(t,e,s){let i=Array(t);for(let r=0;r<t;r++){i[r]=new Array(e);for(let t=0;t<e;t++)i[r][t]=s(r,t)}return i};class n{constructor(t,e){this.x=t,this.y=e}eq(t){return this.x===t.x&&this.y===t.y}nextTo(t){return Math.abs(this.x-t.x)<=1&&Math.abs(this.y-t.y)<=1}copy(){return new n(this.x,this.y)}add(t){return new n(this.x+t.x,this.y+t.y)}wrappers(){return n.dxy.map(t=>this.add(t))}}n.dxy=[new n(-1,-1),new n(0,-1),new n(1,-1),new n(-1,0),new n(1,0),new n(-1,1),new n(0,1),new n(1,1)];class o{constructor(t){this.map=t,this.width=t.length,this.height=t[0].length}at(t,e){return this.map[t][e]}inRange(t){return t.x>=0&&t.y>=0&&t.x<this.width&&t.y<this.height}each(t){this.map.forEach((e,s)=>{e.forEach((e,i)=>{t(e,s,i)})})}}const h=function(t,e,s){let[i,r,a,o]=[t.x,e.x,t.y,e.y],h=Math.max(Math.abs(i-r),Math.abs(a-o));const l=new n((r-i)/h,(o-a)/h);for(;h>1;)i+=l.x,a+=l.y,s(Math.round(i),Math.round(a)),h-=1},l=function(t,e,s){h(t,e,s),s(e.x,e.y)};class c extends n{constructor(t,e){super(t,e)}multiple(t){return new n(this.x*t,this.y*t)}}c.up=new c(0,-1),c.down=new c(0,1),c.left=new c(-1,0),c.right=new c(1,0),c.upLeft=new c(-1,-1),c.upRight=new c(1,-1),c.downLeft=new c(-1,1),c.downRight=new c(1,1),c.all=[c.up,c.down,c.left,c.right,c.upLeft,c.upRight,c.downLeft,c.downRight];class u{affectPlayer(t){return this.affectCreature(t)}}class d extends u{affectCreature(t){return G.NOTHING}}class p extends d{constructor(t,e){super(),this.levelMap=t,this.game=e}affectPlayer(t){return t.removeImpact(m.Overloaded,"bag"),t.removeImpact(m.Stressed,"bag"),t.removeImpact(m.Loaded,"bag"),t.stuffWeight.current>t.carryingCapacity.flattenedStart?t.on(new qt(this.game,this.levelMap,vt.Overloaded)):(t.stuffWeight.current>t.carryingCapacity.overloadedStart?t.addImpact(m.Overloaded,"bag"):t.stuffWeight.current>t.carryingCapacity.loadedStart?t.addImpact(m.Loaded,"bag"):t.stuffWeight.current>t.carryingCapacity.stressed&&t.addImpact(m.Stressed,"bag"),G.NOTHING)}}class g{constructor(){this.bunch=[]}find(t){return this.bunch.find(e=>e.item.groupsWith(t))}remove(t,e){const s=this.find(t);void 0!==s&&(s.count===e?Object(r.remove)(this.bunch,t=>t.item.groupsWith(s.item)):s.count-=e)}put(t,e){const s=this.bunch.find(e=>e.item.groupsWith(t));s?s.count+=e:this.bunch.push({count:e,item:t})}clone(){let t=new g;return this.bunch.forEach(e=>{t.put(e.item,e.count)}),t}}var m,f,v;!function(t){t[t.Blind=0]="Blind",t[t.Stressed=1]="Stressed",t[t.Loaded=2]="Loaded",t[t.Overloaded=3]="Overloaded"}(m||(m={}));class w{constructor(){this.constEffects=[],this.tempEffects=0}addTempEffect(t){this.tempEffects+=t}addConstEffect(t){this.constEffects.push(t)}removeTempEffect(){this.tempEffects=0}removeConstEffect(t){Object(r.remove)(this.constEffects,e=>e===t)}active(){return this.tempEffects>0||this.constEffects.length>0}turn(){this.tempEffects>=1&&(this.tempEffects-=1)}}class y{constructor(){this.impacts=new Map}get activeImpacts(){let t=[];return this.impacts.forEach((e,s)=>{e.active()&&t.push(s)}),t}addImpact(t,e){this.impactByType(t).addTempEffect(e)}removeImpact(t){this.impactByType(t).removeTempEffect()}addConstImpact(t,e){this.impactByType(t).addConstEffect(e)}removeConstImpact(t,e){this.impactByType(t).removeConstEffect(e)}turn(){this.impacts.forEach(t=>t.turn())}impactByType(t){let e=this.impacts.get(t);return void 0!==e?e:(e=new w,this.impacts.set(t,e),e)}}!function(t){t[t.Wall=0]="Wall",t[t.Door=1]="Door",t[t.Floor=2]="Floor",t[t.StairwayDown=3]="StairwayDown",t[t.StairwayUp=4]="StairwayUp",t[t.Trap=5]="Trap",t[t.Trigger=6]="Trigger"}(f||(f={}));class b{constructor(t,e){this.key=t,this.kind=e}addItem(t,e){this.items||(this.items=new g),this.items.put(t,e)}free(t){return this.isFloor()&&this.passibleThrough(t)}isFloor(){return this.kind===f.Floor}visibleThrough(){return!0}passibleThrough(t){return t&&this.creature?this.kind!==f.Wall&&this.creature.id===t.id:this.kind!==f.Wall&&!this.creature}clone(t=this){let e=this.buildNew();return t.creature&&(e.creature=t.creature),e.items=t.items&&t.items.clone(),e}}class x extends b{visibleThrough(){return!0}visit(t){t.onFloor(this)}buildNew(){return new x(this.key,this.kind)}}class T extends x{constructor(){super("R",f.Floor)}}class C extends b{constructor(){super("D",f.Door)}visibleThrough(){return!1}visit(t){t.onDoor(this)}buildNew(){return new C}}class W extends b{constructor(){super("W",f.Wall)}visibleThrough(){return!1}visit(t){t.onWall(this)}buildNew(){return new W}}class M extends b{constructor(t,e,s,i){super(t,e),this.currentMap=s,this.adjacentMapName=i}enterPos(t,e){return this._enterPos?this._enterPos:this._enterPos=e.matchStairs(t.name)}visibleThrough(){return!0}}class I extends M{constructor(t,e){super(">",f.StairwayDown,t,e)}visit(t){t.onStairwayDown(this)}buildNew(){return new I(this.currentMap,this.adjacentMapName)}}class R extends M{constructor(t,e){super("<",f.StairwayUp,t,e)}visit(t){t.onStairwayUp(this)}buildNew(){return new R(this.currentMap,this.adjacentMapName)}}!function(t){t[t.AirBlow=0]="AirBlow",t[t.BareWire=1]="BareWire",t[t.FallingRock=2]="FallingRock",t[t.Hole=3]="Hole",t[t.Light=4]="Light",t[t.Teleportation=5]="Teleportation",t[t.Water=6]="Water"}(v||(v={}));class k extends b{constructor(t,e,s=!1){super("^",f.Trap),this.type=t,this.tile=e,this.revealed=s}visit(t){t.onTrap(this)}disarmTile({x:t,y:e},s,i,r){r.logger.succeededToUntrap(s),i.setTile(t,e,this.tile.clone(this))}}class S extends b{constructor(t=!0,e){super("T",f.Trigger),this.singleUse=t,this.tile=e}visit(t){t.onTrigger(this)}activate(t,e,s){if(this.singleUse){const{x:t,y:i}=e.creaturePos(s),r=this.clone();r.creature=s,e.setTile(t,i,r)}this.onTrigger(t,e,s)}buildNew(){return this.tile.clone()}}class P extends S{constructor(t,e=!0,s){super(e,s),this.message=t}onTrigger(t){t.logger.info(this.message)}}class E{onWall(t){this.default(t)}onFloor(t){this.default(t)}onStairwayDown(t){this.onStairway(t)}onStairwayUp(t){this.onStairway(t)}onDoor(t){this.default(t)}onTrigger(t){this.default(t)}onTrap(t){this.default(t)}onStairway(t){this.default(t)}default(t){}}const O=function(t,e,s,i){new class{constructor(t,e,s,i,r,a,n){this.startx=t,this.starty=e,this.radius=s,this.width=i,this.height=r,this.solidChecker=a,this.markVisible=n,this.doubleRadius=this.radius*this.radius}calc(){this.markVisible(this.startx,this.starty,1),this.solidChecker.isSolid(this.startx,this.starty)||[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([t,e])=>{this.castLight(1,1,0,0,t,e,0),this.castLight(1,1,0,t,0,0,e)})}castLight(t,e,s,i,r,a,n){if(e<s)return;let o=0,h=!1;for(let l=t;l<=this.radius&&!h;l++){let t=-l;for(let c=-l;c<=0;c++){let u=Math.round(this.startx+c*i+t*r),d=Math.round(this.starty+c*a+t*n),p=(c-.5)/(t+.5),g=(c+.5)/(t-.5);if(u>=0&&d>=0&&u<this.width&&d<this.height&&!(e<g)){if(s>p)break;this.doubleDistance(c,t)<=this.doubleRadius&&this.markVisible(u,d,1-this.doubleDistance(c,t)/this.doubleRadius),h?this.solidChecker.isSolid(u,d)?o=g:(h=!1,e=o):this.solidChecker.isSolid(u,d)&&l<this.radius&&(h=!0,this.castLight(l+1,e,p,i,r,a,n),o=g)}}}}doubleDistance(t,e){return t*t+e*e}}(t.x,t.y,e,i.width,i.height,new class extends E{constructor(t,e){super(),this.stage=t,this.pos=e,this.visible=!1}isSolid(t,e){return this.x=t,this.y=e,this.stage.at(t,e).visit(this),!this.visible}onDoor(t){this.visible=this.pos.x===this.x&&this.pos.y===this.y}default(t){this.x&&this.y&&(this.visible=this.stage.visibleThrough(this.x,this.y))}}(i,t),(t,e,r)=>{s.at(t,e).see(i.at(t,e),r)}).calc()};class N{constructor(t,e=t){this.max=t,this.current=e,this.modifiers=[]}get maximum(){return this.max}get atMax(){return this.max===this.current}decrease(t){this.current-=t}increase(t){this.current=Math.min(this.current+t,this.max)}constantIncrease(t){this.max+=t,this.increase(t)}constantDecrease(t){this.max-=t,this.decrease(t)}addModifier(t){this.modifiers.push(t)}removeModifier(t){Object(r.remove)(this.modifiers,e=>e===t)}get currentValue(){return this.current+Object(r.sum)(this.modifiers)}}class _{constructor(t,e=1,s=0){this.base=t,this.rate=e,this.extra=s}get current(){return this.base*this.rate-this.extra}add(t){this.base+=t}subtract(t){this.base-=t}}class D{constructor(t,e){this.strength=t,this.constitution=e,this.strengthRatio=5,this.constitutionRatio=3,this.base=10}recalculate(t,e){this.strength=t,this.constitution=e}get stressed(){return this.base+this.strength*this.strengthRatio+this.constitution*this.constitutionRatio}get loadedStart(){return 1.5*this.stressed}get overloadedStart(){return 2*this.loadedStart}get flattenedStart(){return 3*this.overloadedStart}}class A extends N{constructor(t,e=0,s=t.maxHealthValue){super(t.maxHealthValue,s),this.currentTurn=e,this.regenerationRate=t.regenerationRate,this.regenerationValue=t.regenerationValue}turn(){this.currentTurn+=1,this.currentTurn>=this.regenerationRate&&(this.currentTurn=0,this.increase(this.regenerationValue))}}class B extends _{get meleeAdjustment(){return this.current<5?-2:this.current>10?Math.floor((this.current-10)/2):0}}class $ extends _{get bodyControlAdjustment(){return this.current<5?-2:this.current>10?Math.floor(.9*(this.current-10)):0}get missileAdjustment(){return this.current<5?-2:this.current>10?Math.floor((this.current-10)/2):0}}var H,F;!function(t){t[t.Player=0]="Player",t[t.PlayerOnlyEnemy=1]="PlayerOnlyEnemy",t[t.FreeForAll=2]="FreeForAll"}(H||(H={})),function(t){t[t.GoStairwayDown=0]="GoStairwayDown",t[t.Inventory=1]="Inventory",t[t.PutOn=2]="PutOn",t[t.Throwing=3]="Throwing"}(F||(F={}));const L=[F.GoStairwayDown,F.Inventory,F.PutOn,F.Throwing];var G;!function(t){t[t.DIE=0]="DIE",t[t.HURT=1]="HURT",t[t.DODGE=2]="DODGE",t[t.THROW_DODGE=3]="THROW_DODGE",t[t.NOTHING=4]="NOTHING",t[t.RESIST=5]="RESIST"}(G||(G={}));class j{constructor(t,e=j.getId()){this.specie=t,this.id=e,this.stageMemories=new Map,this.dead=!1,this.health=new A(t)}static getId(){return this.lastId++}get name(){return this.specie.name}get clan(){return this.specie.clan}get protections(){return this.specie.protections}get throwDamages(){return this.specie.throwingDamages}get damages(){return this.specie.damages}can(t){return Object(r.includes)(this.specie.abilities,t)}on(t){return t.affectCreature(this)}get speed(){return this.specie.moveSpeed}stageMemory(t){const e=this.stageMemories.get(t.name);return e||this.visionMask(t)}visionMask(t){let e=this.stageMemories.get(t.name);return e?e.resetVisible():(e=new Ke(t.width,t.height),this.stageMemories.set(t.name,e)),O(t.creaturePos(this),this.visionRadius,e,t),e}get impactsBunch(){return this._impactsBunch||(this._impactsBunch=new y),this._impactsBunch}hasImpact(t){return Object(r.includes)(this.impacts,t)}addImpact(t,e){this.impactsBunch.addConstImpact(t,e)}removeImpact(t,e){this.impactsBunch.removeConstImpact(t,e)}get visionRadius(){return this.hasImpact(m.Blind)?0:this.specie.visionRadius}get bodyControl(){return this.specie.bodyControl}get impacts(){return this.impactsBunch.activeImpacts}hasResistance(t){return Object(r.includes)(this.resistances,t)}get resistances(){return this.specie.resistances}get weightWithCarryings(){return this.specie.weight}statsTurn(){this.health.turn(),this._impactsBunch&&this._impactsBunch.turn()}}j.lastId=0;class U extends E{constructor(t,e,s,i){super(),this.pos=t,this.creature=e,this.levelMap=s,this.game=i,this.reaction=G.NOTHING}onTrap(t){this.reaction=t.activate(this.pos,this.game,this.levelMap,this.creature)}onTrigger(t){t.activate(this.game,this.levelMap,this.creature)}}class q extends u{constructor(t,e,s,i=e){super(),this.game=t,this.levelMap=e,this.nextPoint=s,this.nextLevel=i}affectCreature(t){const e=this.levelMap.creaturePos(t);this.nextLevel.name!==this.levelMap.name?(this.levelMap.removeCreature(t),this.nextLevel.addCreature(this.nextPoint,t)):(this.levelMap.at(e.x,e.y).creature=void 0,this.levelMap.at(this.nextPoint.x,this.nextPoint.y).creature=t);const s=new U(this.nextPoint,t,this.levelMap,this.game);return this.nextLevel.at(this.nextPoint.x,this.nextPoint.y).visit(s),s.reaction}affectPlayer(t){return this.nextLevel&&this.levelMap.name!==this.nextLevel.name?(this.levelMap.reset(),this.nextLevel.enter(),this.affectCreature(t),this.game.currentMap=this.nextLevel):this.affectCreature(t),G.NOTHING}}class V{moveTo(t,e,s,i){return this.move(t,s,i,t=>e.eq(t))}move(t,e,s,i){const[r]=this.buildPath(t,e,i);if(r)return new q(s,e,r)}buildPath(t,e,s){return Ss(t.stageMemory(e),e.creaturePos(t),e=>e.tangible(t),s)}withinView(t,e,s){let i=a(t.width,t.height,()=>!1),r=[e];for(;r.length;){let e=[];r.forEach(r=>{if(!t.inRange(r))return;const a=t.at(r.x,r.y);a.visible&&!i[r.x][r.y]&&(i[r.x][r.y]=!0,s(r,a),r.wrappers().forEach(t=>e.push(t)))}),r=e}}enemies(t,e){return t.id!==e.id&&(t.clan===H.FreeForAll||e.clan===H.FreeForAll||(t.clan===H.Player&&e.clan===H.PlayerOnlyEnemy||e.clan===H.Player&&t.clan===H.PlayerOnlyEnemy))}}class Y extends V{constructor(){super(...arguments),this.destination=void 0}act(t,e,s){if(!this.foundNewTarget(t,e)||!this.destination)return this.checkCurrentTile(t,e,s);const i=this.goTo(t,e,s,this.destination);if(i)return i;this.destination=void 0,this.onCantMove(t)}goTo(t,e,s,i){return this.moveTo(t,i,e,s)}checkCurrentTile(t,e,s){if(this.destination&&e.creaturePos(t).eq(this.destination))return this.destination=void 0,this.onReach(t,e,s)}onMove(t){}onReach(t,e,s){}onCantMove(t){}}class z extends Y{constructor(t){super(),this.matcher=t}checkCurrentTile(t,e,s){let i=super.checkCurrentTile(t,e,s);if(i)return i;const r=e.creaturePos(t);return this.matcher(t.stageMemory(e).at(r.x,r.y))?(this.destination=void 0,this.onReach(t,e,s)):void 0}foundNewTarget(t,e){const s=Ss(t.stageMemory(e),e.creaturePos(t),e=>e.tangible(t),(t,e)=>this.matcher(e),!0);return!!s.length&&(this.destination=s.pop(),!0)}}class X extends V{act(t,e,s,i=!0){if(this.canAttack(t,e)){if(this.victim&&this.victimInAccess(t,e,this.victim))return new Yt(this.victim,e,s);if(!i)throw"Attacker got called twice";return this.pickNewVictim(t,e),this.act(t,e,s,!1)}}canAttack(t,e){return!!this.findCreature(t,e,e=>this.enemies(t,e))}victimInAccess(t,e,s){if(void 0===s)return!1;return!!this.findCreature(t,e,t=>t.id===s.id)}pickNewVictim(t,e){this.victim=this.findCreature(t,e,e=>this.enemies(t,e))}findCreature(t,e,s){const i=t.stageMemory(e);return e.creaturePos(t).wrappers().map(({x:t,y:e})=>i.at(t,e).creature).find(t=>!!t&&s(t))}}class J extends Y{foundNewTarget(t,e){return this.victimSet()&&this.buildVictimPath(t,e)||this.foundNewVictim(t,e)}onCantMove(){this.victimId=void 0}onReach(){this.victimId=void 0}victimSet(){return!!this.victimId}goTo(t,e,s){if(!this.destination)throw"Chaser.goTo: no destination";return this.followTo(t,this.destination,e,s)}buildVictimPath(t,e){return this.findCreature(t,e,t=>t.id===this.victimId)}foundNewVictim(t,e){return this.findCreature(t,e,e=>this.enemies(t,e))&&this.buildVictimPath(t,e)}findCreature(t,e,s){let i=!1;return this.withinView(t.stageMemory(e),e.creaturePos(t),({x:t,y:e},r)=>{const a=r.creature;!i&&a&&s(a)&&(this.destination=new n(t,e),this.victimId=a.id,i=!0)}),i}followTo(t,e,s,i){return this.move(t,s,i,t=>e.nextTo(t))}}const K=2;class Q extends Y{constructor(){super(...arguments),this.escapesFrom=[]}foundNewTarget(t,e){return this.foundEnemies(t,e)&&this.buildEscapePath(t,e)}buildEscapePath(t,e,s=t.visionRadius/2){if(s<=1)return this.destination=void 0,!1;const i=this.buildPath(t,e,({x:t,y:e})=>{return Object(r.sumBy)(this.escapesFrom,([s,i])=>Math.max(Math.abs(t-s.x),Math.abs(e-s.y)))>=s});return i.length?(this.destination=i.pop(),!0):this.buildEscapePath(t,e,s-K)}foundEnemies(t,e){return this.escapesFrom=[],this.withinView(t.stageMemory(e),e.creaturePos(t),(e,s)=>{const i=s.creature;i&&this.enemies(t,i)&&this.escapesFrom.push([e,i])}),this.escapesFrom.length>0}}class Z extends z{constructor(){super(t=>!t.seen)}}class tt extends V{act(t,e,s){const i=e.creaturePos(t);return this.move(t,e,s,t=>!i.eq(t))}}class et{constructor(t){this.game=t,this.player=t.player,this.logger=t.logger}}class st extends et{constructor(t,e){super(e),this.items=t}run(){}}class it extends V{constructor(t){super(),this.aiToRun=t,this.events=[]}pushEvent(t){this.events.push(t)}resetEvents(){this.events=[]}runEvents(){let t=!1;return this.events.forEach(e=>{t=!0,e.run()}),this.resetEvents(),t}}var rt=s(27);const at=10;class nt extends E{constructor(t){super(),this.tile=t,this.status=!1}addNode(){return this.status=!1,this.tile.visit(this),this.status}onDoor(){this.status=!0}}class ot extends V{constructor(){super(),this.step=at,this.firstCallPatrol=!0,this.i="a",this.graph=new rt.Graph,this.lastNodeVisit={},this.currentNodeID="a",this.markNodeVisited(this.currentNodeID),this.path=[]}act(t,e,s,i=!0){if(!(this.graph.nodes().length<=1)){if(this.firstCallPatrol){const s=e.creaturePos(t);this.addNode(s),this.firstCallPatrol=!1}return this.step+=1,this.path.length?this.moveToTarget(t,e,s,i):(this.targetNodeID&&(this.markNodeVisited(this.targetNodeID),this.currentNodeID=this.targetNodeID),this.pickUpNewTarget(t,e),this.moveToTarget(t,e,s,i))}}reset(){this.path=[]}trackMovement(t,e){(this.step>=at||new nt(e).addNode())&&this.addNode(t),this.step+=1}addNode(t){this.graph.setNode(this.i,t),this.currentNodeID&&this.currentNodeID!==this.i&&this.graph.setEdge(this.currentNodeID,this.i),this.currentNodeID=this.i,this.newNodeId(),this.step=0}buildNewPath(t,e){if(!this.targetNodeID)throw"Patrol has no next targetID";const s=this.graph.node(this.targetNodeID);this.path=this.buildPath(t,e,t=>s.eq(t))}pickUpNewTarget(t,e){let s=this.graph.nodes()[0],i=this.lastNodeVisit[s],r=this.graph.neighbors(this.currentNodeID);r&&r.forEach(t=>{i>(this.lastNodeVisit[t]||0)&&(s=t,i=this.lastNodeVisit[s])}),this.targetNodeID=s,this.buildNewPath(t,e)}moveToTarget(t,e,s,i){const r=this.path.shift();return r?t.stageMemory(e).at(r.x,r.y).tangible()?(this.buildNewPath(t,e),this.path.length?this.act(t,e,s,!1):void 0):new q(s,e,r):i?(this.path=[],this.act(t,e,s,!1)):(new tt).act(t,e,s)}markNodeVisited(t){this.lastNodeVisit[t]=this.step}newNodeId(){this.i=String.fromCharCode(this.i.charCodeAt(0)+1)}}var ht,lt,ct,ut,dt,pt,gt,mt,ft,vt;!function(t){t[t.AbilitiesPicking=0]="AbilitiesPicking",t[t.Death=1]="Death",t[t.Idle=2]="Idle",t[t.Inventory=3]="Inventory",t[t.ItemsListing=4]="ItemsListing",t[t.Missile=5]="Missile",t[t.ProfessionPicking=6]="ProfessionPicking",t[t.Look=7]="Look",t[t.Teleportation=8]="Teleportation",t[t.PickHandleOption=9]="PickHandleOption"}(ht||(ht={}));class wt{constructor(t,e,s){this.type=t,this.levelMap=e,this.game=s,this.player=this.game.player}get tile(){return this.levelMap.creatureTile(this.player)}endTurn(){this.game.player.ai.endTurn()}redirect(t){this.game.player.ai.redirect(t)}goIdle(){this.redirect(new xs(this.levelMap,this.game))}}class yt extends wt{constructor(t,e,s){super(ht.Death,e,s),this.dieReason=t}get playerName(){return this.game.player.name}}class bt extends et{constructor(t,e,s){super(s),this.level=t,this.levelMap=e}run(){this.level%3==0?this.game.player.ai.presenter=new Rs(this.level,this.levelMap,this.game):this.game.player.ai.presenter=new Ws(this.level,this.levelMap,this.game)}}class xt extends et{constructor(t,e,s){super(s),this.dieReason=t,this.levelMap=e}run(){this.game.player.rebuildVision(this.levelMap),this.game.playerTurn=!0,this.game.player.ai.presenter=new yt(this.dieReason,this.levelMap,this.game)}}class Tt extends et{constructor(t,e){super(e),this.levelMap=t}run(){this.game.player.rebuildVision(this.levelMap),this.game.playerTurn=!0,this.game.player.ai.presenter=new Ms(this.levelMap,this.game)}}class Ct extends it{constructor(){super(...arguments),this.presenter=null,this.levelUps=0}act(t,e,s){this.game=s,this.levelMap=e,this.presenter=new xs(e,this.game),this.game.playerTurn=!0}endTurn(){let t=this.events.pop();if(t)t.run();else if(this.game&&this.levelMap){this.game.player.on(new p(this.levelMap,this.game));let t=this.events.pop();t?t.run():(this.game.player.ai.runEvents(),this.game.playerTurn=!1,this.presenter=null)}}redirect(t){this.presenter=t}}class Wt extends z{constructor(){super(t=>!!t.items)}act(t,e,s){if(t.can(F.Inventory))return super.act(t,e,s)}onReach(t,e,s){const i=e.creatureTile(t);if(!i.items)throw"Picker.act : nothing to pick up";return t.ai.pushEvent(new st(i.items,s)),new ie(i,i.items.bunch,s)}}class Mt extends u{constructor(t){super(),this.levelMap=t}affectCreature(t){let e=t.stageMemory(this.levelMap);return this.levelMap.creaturePos(t).wrappers().forEach(({x:t,y:s})=>{e.at(t,s).see(this.levelMap.at(t,s),0)}),G.NOTHING}}class It extends V{act(t,e){if(!t.health.atMax)return new Mt(e)}}class Rt extends E{constructor(){super(...arguments),this.match=!1}onStairwayDown(){this.match=!0}}class kt extends E{constructor(t,e){super(),this.game=t,this.levelMap=e}onStairwayDown(t){const e=this.game.getMap(t.adjacentMapName);this.event=new q(this.game,this.levelMap,t.enterPos(this.levelMap,e),e)}}class St extends z{constructor(){super(t=>{const e=new Rt;return t.visit(e),e.match})}act(t,e,s){if(t.can(F.GoStairwayDown))return super.act(t,e,s)}onReach(t,e,s){const i=new kt(s,e);return e.creatureTile(t).visit(i),i.event}}class Pt extends V{act(t,e,s){if(!t.can(F.Throwing)||!this.hasMissile(t)||!this.canAttack(t,e,s))return;let i=[];if(!this.victim)throw"Thrower.act called when there is no victim";return h(e.creaturePos(t),e.creaturePos(this.victim),(t,e)=>i.push(new n(t,e))),new se(i,s,e,t=>{t===G.DIE&&(this.victim=void 0,this.previousVictim=void 0)})}hasMissile(t){return this.missiles=t.missile,void 0!==this.missiles}canAttack(t,e,s){return this.previousVictim=this.victim,this.victim=void 0,!(!this.previousVictim||!this.findWithId(t,e,this.previousVictim.id))||this.findCreature(t,e,e=>this.enemies(t,e))}findWithId(t,e,s){return this.findCreature(t,e,t=>s===t.id)}findCreature(t,e,s){const i=t.stageMemory(e),r=e.creaturePos(t);return this.withinView(i,e.creaturePos(t),(a,n)=>{const o=n.creature;!this.victim&&o&&s(o)&&!this.obstacles(t,r,i,a)&&(this.victim=e.at(a.x,a.y).creature)}),!!this.victim}obstacles(t,e,s,i){let r=!1;return h(e,i,(e,i)=>{r=r||s.at(e,i).tangible(t)}),r}}class Et extends u{constructor(t,e,s){super(),this.actor=t,this.levelMap=e,this.game=s}affectCreature(t){return G.NOTHING}affectPlayer(t){return t.level.add(1).forEach(e=>{t.ai.pushEvent(new bt(e,this.levelMap,this.game))}),G.NOTHING}}class Ot extends u{constructor(t,e,s,i){super(),this.impactType=t,this.source=e,this.game=s,this.duration=i}affectCreature(t){return t.hasImpact(this.impactType)&&this.applyImpact(),this.duration?t.impactsBunch.addImpact(this.impactType,this.duration):t.addImpact(this.impactType,this.source),G.NOTHING}applyImpact(){}}!function(t){t[t.Intangible=0]="Intangible",t[t.MagicDamage=1]="MagicDamage",t[t.TeleportationControl=2]="TeleportationControl",t[t.Insulator=3]="Insulator"}(lt||(lt={}));class Nt{constructor(){}static misses(t,e){return Math.random()>t/(t+Math.pow(.25*e,.8))}static lowerWeight(t,e=1){let s=0;for(let i=e;i<t;i++)this.chance(1,3)&&(s+=1);return Math.max(1,s)}static higherWeight(t,e=1){return t+e-this.lowerWeight(t,e)}static chance(t,e){return Object(r.random)(1,e)<=t}static dodges(t,e){return Math.random()<Math.atan(t/e)/Math.PI*2}static damage(t,e,s){if(t.every(({type:t,resistances:e})=>this.resistTo(t,e,s)))return{damage:0,resist:!0};return{damage:Object(r.sumBy)(t,({extra:t,dice:i,type:r,resistances:a})=>this.resistTo(r,a,s)?0:Math.floor(Math.max(0,t+this.dropDice(i)-this.protectionValue(r,e)))),resist:!1}}static resistTo(t,e,s){if(e&&Object(r.intersection)(s,e).length)return!0;switch(t){case fe.Melee:case fe.Pierce:case fe.Blunt:return Object(r.includes)(s,lt.Intangible);case fe.Magic:return Object(r.includes)(s,lt.MagicDamage);case fe.Pure:return!1}}static dropDice(t){return Object(r.sum)(Object(r.times)(t.times,()=>Object(r.random)(1,t.max)))}static protectionValue(t,e){return Object(r.sum)(e.map(({type:e,value:s})=>s*this.armorToDamageRatio(t,e)))}}Nt.armorToDamageRatio=((t,e)=>{switch(t){case fe.Melee:switch(e){case ft.Medium:return 2/3;case ft.Solid:return 4/3;default:return 1}case fe.Pierce:switch(e){case ft.Light:return.5;case ft.Medium:return 4/3;case ft.Solid:return 3;case ft.Unarmored:return.75;default:return 1}case fe.Blunt:switch(e){case ft.Medium:return 2;case ft.Solid:case ft.Unarmored:return.5;default:return 1}case fe.Magic:switch(e){case ft.Light:return 5/4;case ft.Medium:return.75;case ft.Heavy:return.5;case ft.Solid:return 3;default:return 1}case fe.Pure:return 0;default:throw"Got unknown type of damage!"}}),function(t){t[t.Corrosion=0]="Corrosion",t[t.Destroy=1]="Destroy"}(ct||(ct={})),function(t){t.cloth={affectedWithWater:void 0,firm:!1,fragile:!1,insulator:!1},t.flesh={affectedWithWater:void 0,firm:!0,fragile:!1,insulator:!0},t.glass={affectedWithWater:void 0,firm:!1,fragile:!0,insulator:!1},t.iron={affectedWithWater:ct.Corrosion,firm:!0,fragile:!1,insulator:!0},t.leather={affectedWithWater:void 0,firm:!1,fragile:!1,insulator:!1},t.paper={affectedWithWater:ct.Destroy,firm:!1,fragile:!1,insulator:!0},t.stone={affectedWithWater:void 0,firm:!0,fragile:!1,insulator:!0},t.wood={affectedWithWater:void 0,firm:!0,fragile:!1,insulator:!0}}(ut||(ut={})),function(t){t[t.WeaponOneHand=0]="WeaponOneHand",t[t.WearsOnHead=1]="WearsOnHead",t[t.WearsOnBody=2]="WearsOnBody",t[t.Ring=3]="Ring",t[t.Amulet=4]="Amulet",t[t.Throw=5]="Throw",t[t.Shoot=6]="Shoot",t[t.Boots=7]="Boots",t[t.Tool=8]="Tool",t[t.Belt=9]="Belt",t[t.Gloves=10]="Gloves",t[t.Gauntlets=11]="Gauntlets",t[t.Cloak=12]="Cloak",t[t.Scroll=13]="Scroll"}(dt||(dt={})),function(t){t[t.BodyArmor=0]="BodyArmor",t[t.OneHandWeapon=1]="OneHandWeapon",t[t.Consumable=2]="Consumable",t[t.Missile=3]="Missile",t[t.Potion=4]="Potion",t[t.MissileWeapon=5]="MissileWeapon",t[t.Boots=6]="Boots",t[t.Scrolls=7]="Scrolls"}(pt||(pt={})),function(t){t[t.MissileRock=0]="MissileRock",t[t.Sling=1]="Sling",t[t.Bow=2]="Bow",t[t.Arrows=3]="Arrows"}(gt||(gt={})),function(t){t[t.None=0]="None",t[t.Slightly=1]="Slightly",t[t.Mostly=2]="Mostly",t[t.Fully=3]="Fully"}(mt||(mt={}));class _t{constructor(t,e,s,i,r=[],a=_t.getId()){this.group=t,this.name=e,this.weight=s,this.material=i,this.usages=r,this.id=a,this.impacts=[],this.corrosionLevel=mt.None}static getId(){return this.lastId++}corrode(){switch(this.corrosionLevel){case mt.None:return this.corrosionLevel=mt.Slightly,!0;case mt.Slightly:return this.corrosionLevel=mt.Mostly,!0;case mt.Mostly:return this.corrosionLevel=mt.Fully,!0}return!1}get affectedWithWater(){return void 0!==this.material.affectedWithWater}get firm(){return this.material.firm}get insulator(){return this.material.insulator}get canSeeDetails(){return!0}clone(){return new _t(this.group,this.name,this.weight,this.material)}groupsWith(t){return this.name===t.name}worksWith(t){return!1}canThrow(t){return!0}}_t.lastId=0;class Dt extends _t{constructor(t){super(pt.Consumable,`${t.name}'s corpse`,t.weight,t.material),this.specie=t}}class At extends _t{constructor(t,e=ut.glass){super(pt.Potion,t,.2,e),this.name=t}}class Bt extends _t{constructor(t,e,s,i,r,a){super(t,e,s,i,a),this.rawDamages=r}get damages(){switch(this.corrosionLevel){case mt.Slightly:return this.damageWithCorrosion(1);case mt.Mostly:return this.damageWithCorrosion(2);case mt.Fully:return this.damageWithCorrosion(4);default:return this.rawDamages}}damageWithCorrosion(t){return this.rawDamages.map(({dice:e,type:s,extra:i})=>({dice:e,type:s,extra:i-t}))}}class $t extends Bt{constructor(t,e,s,i){super(pt.Missile,t,e,i,s,[])}}class Ht extends Bt{constructor(t,e,s,i){super(pt.MissileWeapon,t,e,i,s,[dt.Shoot])}}class Ft extends Bt{constructor(t,e,s,i){super(pt.OneHandWeapon,t,e,s,i,[dt.WeaponOneHand])}}!function(t){t[t.Light=0]="Light",t[t.Medium=1]="Medium",t[t.Heavy=2]="Heavy",t[t.Solid=3]="Solid",t[t.Unarmored=4]="Unarmored"}(ft||(ft={}));class Lt extends _t{constructor(t,e,s,i,r,a){super(t,e,s,i,[a]),this.rawProtections=r}get protections(){switch(this.corrosionLevel){case mt.Slightly:return this.protectionWithCorrosion(1);case mt.Mostly:return this.protectionWithCorrosion(2);case mt.Fully:return this.protectionWithCorrosion(4);default:return this.rawProtections}}protectionWithCorrosion(t){return this.rawProtections.map(({type:e,value:s})=>({type:e,value:s-t}))}}class Gt extends Lt{constructor(t,e,s,i){super(pt.BodyArmor,t,e,s,i,dt.WearsOnBody)}}class jt extends Lt{constructor(t,e,s,i){super(pt.Boots,t,e,s,i,dt.Boots)}}class Ut extends _t{constructor(t){super(pt.Scrolls,t,.1,ut.paper,[dt.Scroll])}}!function(t){t[t.Attack=0]="Attack",t[t.Missile=1]="Missile",t[t.Trap=2]="Trap",t[t.Overloaded=3]="Overloaded"}(vt||(vt={}));class qt extends u{constructor(t,e,s){super(),this.game=t,this.levelMap=e,this.reason=s}affectCreature(t){let e=this.levelMap.creatureTile(t);return this.levelMap.removeCreature(t),t.dead=!0,t.specie.leavesCorpseRatio>Math.random()&&e.addItem(new Dt(t.specie),1),t.inventoryItems.forEach(t=>e.addItem(t.item,t.count)),G.DIE}affectPlayer(t){return t.ai.pushEvent(new xt(this.reason,this.levelMap,this.game)),t.dead=!0,this.game.playerTurn=!0,G.DIE}}class Vt extends u{constructor(t,e,s,i){super(),this.damages=t,this.dieReason=e,this.levelMap=s,this.game=i}get damage(){if(this.doneDamage)return this.doneDamage;throw"HurtEvent.damage called but there is no done damage"}affectCreature(t){const{damage:e,resist:s}=Nt.damage(this.damages,t.protections,t.resistances);return this.doneDamage=e,s?G.RESIST:e>=t.health.currentValue?(t.on(new qt(this.game,this.levelMap,this.dieReason)),G.DIE):e<=0?G.NOTHING:(t.health.decrease(e),G.HURT)}}class Yt extends u{constructor(t,e,s){super(),this.victim=t,this.levelMap=e,this.game=s}affectCreature(t){const e=this.process(t);switch(e){case G.NOTHING:this.game.logger.noDamageToPlayer(t);break;case G.RESIST:this.game.logger.playerIgnoresDamage(t)}return e}affectPlayer(t){const e=this.process(t);switch(e){case G.NOTHING:this.game.logger.noDamageToTarget(t);break;case G.RESIST:this.game.logger.targetIgnoresDamage(this.victim)}return e}process(t){if(Nt.misses(t.bodyControl,this.victim.bodyControl))return this.game.logger.missMessage(this.game.player,t,this.victim),G.DODGE;const e=new Vt(t.damages,vt.Attack,this.levelMap,this.game),s=this.victim.on(e);switch(s){case G.DIE:t.on(new Et(this.victim,this.levelMap,this.game)),this.game.logger.killMessage(this.game.player,e.damage,t,this.victim);break;case G.HURT:this.game.logger.hurtMessage(this.game.player,e.damage,t,this.victim)}return s}}class zt extends u{constructor(t,e){super(),this.potion=t,this.game=e}affectCreature(t){return t.removeItem(this.potion,1),this.potion.onDrink(this.game),this.game.logger.drink(this.potion),G.NOTHING}}class Xt extends d{constructor(t,e,s){super(),this.tile=t,this.items=e,this.game=s}affectPlayer(t){return this.items.forEach(({item:e,count:s})=>{t.removeItem(e,s),t.stuffWeight.subtract(e.weight*s),this.game.logger.droppedItem(e,s),this.tile.addItem(e,s)}),G.NOTHING}}class Jt extends d{affectPlayer(t){return this.updateHealth(t),G.NOTHING}updateHealth(t){const e=t.constitution.current;e<3?t.health.constantDecrease(2):e<6?t.health.constantDecrease(1):e<12||(e<15?t.health.constantIncrease(1):e<18?t.health.constantIncrease(2):e<20?t.health.constantIncrease(3):t.health.constantIncrease(4)),t.health.maximum<1&&t.health.constantIncrease(1-t.health.maximum)}}class Kt{constructor(t){this.onDone=t}speed(){return-1}}class Qt extends Kt{constructor(t,e,s){super(s),this.item=t,this.frames=e}patchMemory(t){if(this.done())return;const[e]=this.frames.splice(0,1),s=t.at(e.x,e.y);s.visible?s.effect="-":this.patchMemory(t)}done(){return 0===this.frames.length}}class Zt extends u{constructor(t,e,s,i){super(),this.victim=t,this.missile=e,this.levelMap=s,this.game=i}affectCreature(t){if(Nt.misses(t.bodyControl,this.victim.bodyControl))return this.game.logger.throwMissMessage(this.game.player,t,this.victim,this.missile),G.THROW_DODGE;const{damage:e,resist:s}=Nt.damage(t.throwDamages,this.victim.protections,this.victim.resistances);return e>=this.victim.health.currentValue?(t.on(new Et(this.victim,this.levelMap,this.game)),this.game.logger.throwKillMessage(this.game.player,e,t,this.victim,this.missile),this.victim.on(new qt(this.game,this.levelMap,vt.Missile))):(this.victim.health.decrease(e),this.game.logger.throwHurtMessage(this.game.player,e,t,this.victim,this.missile),G.HURT)}}class te extends u{constructor(t,e){super(),this.slot=t,this.game=e}affectCreature(t){return G.NOTHING}affectPlayer(t){const e=this.slot.equipment;if(void 0===e)throw`Can not take off item from ${this.slot.name} - nothing equipped`;return this.slot.takeOff(),this.onTakeOff(t,e.item),t.inventory.putToBag(e.item,e.count),this.game.logger.takeOff(e.item),G.NOTHING}onTakeOff(t,e){e instanceof Lt&&e.protections.forEach(e=>{t.itemsProtections.splice(Object(r.findIndex)(t.itemsProtections,t=>t===e),1)}),e.impacts.forEach(s=>{t.on(new ae(s,e.name,this.game))})}}class ee extends u{constructor(t,e,s){super(),this.slot=t,this.count=e,this.game=s}affectCreature(t){return G.NOTHING}affectPlayer(t){if(!this.slot.equipment)throw`RemoveItemEvent: ${this.slot.name} has no equipment`;return this.slot.equipment.count===this.count?t.on(new te(this.slot,this.game)):(this.slot.equipment.count-=this.count,G.NOTHING)}}class se extends u{constructor(t,e,s,i){super(),this.path=t,this.game=e,this.levelMap=s,this.done=i}affectCreature(t){let e=t.missile;if(!e)throw"MissileAttackEvent called when actor has no missiles";return this.withMissile(t,e.item),G.NOTHING}affectPlayer(t){const e=t.missile;if(!e)throw"MissileAttackEvent: slot has no items";return this.withMissile(t,e.item),t.on(new ee(t.inventory.missileSlot,1,this.game)),t.stuffWeight.subtract(e.item.weight),G.NOTHING}withMissile(t,e){let s,i=[];this.path.forEach(t=>{if(!s){const e=this.levelMap.at(t.x,t.y);s=e.creature,i.push(t)}}),this.game.effect=new Qt(e,i,()=>{s?this.done(t.on(new Zt(s,e,this.levelMap,this.game))):this.done(G.NOTHING)})}}class ie extends d{constructor(t,e,s){super(),this.tile=t,this.items=e,this.game=s}affectPlayer(t){let e=this.tile.items;if(void 0===e)throw"Failed to pick up items - tile has no items";return this.withTileItems(t,e),G.NOTHING}withTileItems(t,e){this.items.forEach(({item:s,count:i})=>{t.addItem(s,i),t.stuffWeight.add(s.weight*i),this.game.logger.pickedUpItem(s,i),e.remove(s,i)})}}class re extends u{constructor(t,e,s){super(),this.slot=t,this.item=e,this.game=s}affectCreature(t){return G.NOTHING}affectPlayer(t){let e=t.inventory.findInBag(this.item);if(void 0===e)throw`Item ${this.item.name} can not be equipped - not found in inventory`;if(this.slot.equipment){const e=t.on(new te(this.slot,this.game));if(e!==G.NOTHING)return e}const s=this.slot.useSingleItem?1:e.count;return t.removeItem(this.item,s),this.slot.equip(this.item,s),this.onPutOn(t,this.item),this.game.logger.putOn(this.item),G.NOTHING}onPutOn(t,e){e instanceof Lt&&(t.itemsProtections=t.itemsProtections.concat(e.protections)),e.impacts.forEach(s=>{t.on(new Ot(s,e.name,this.game))})}}class ae extends u{constructor(t,e,s){super(),this.impactType=t,this.source=e,this.game=s}affectCreature(t){return G.NOTHING}}class ne extends u{constructor(t,e){super(),this.levelMap=t,this.game=e}playerSees(t){let{x:e,y:s}=this.levelMap.creaturePos(t);return this.game.player.stageMemory(this.levelMap).at(e,s).visible}}const oe=function(t,e,s){let i=t.width*t.height;for(;i>0;){const a=Object(r.random)(0,t.width-1),n=Object(r.random)(0,t.height-1);if(e(t.at(a,n)))return s(a,n),t;i--}throw"post add failed to add tile"},he=function(t,e){let s=t.width*t.height;for(;s>0;){const i=Object(r.random)(0,t.width-1),a=Object(r.random)(0,t.height-1),n=t.at(i,a);if(e(n))return{tile:n,x:i,y:a};s--}},le=function(t,e,s){t.each((t,i,r)=>{e(t)&&s(t,i,r)})};class ce extends ne{constructor(t,e,s){super(t,e),this.selfCast=s}affectCreature(t){return this.playerSees(t)?t.hasResistance(lt.TeleportationControl)||!this.teleport(t)?this.game.logger.creatureNotTeleported(t):this.game.logger.creatureTeleported(t):this.teleport(t),G.NOTHING}affectPlayer(t){return t.hasResistance(lt.TeleportationControl)?(this.selfCast||this.game.logger.playerTeleportationCaused(),t.ai.pushEvent(new Tt(this.levelMap,this.game)),this.game.playerTurn=!0):this.teleport(t)?this.selfCast||this.game.logger.playerTeleported():this.game.logger.playerNotTeleported(),G.NOTHING}teleport(t){let e=!1;try{oe(this.levelMap,t=>t.free(),(s,i)=>{e=!0,t.on(new q(this.game,this.levelMap,new n(s,i)))})}catch(t){}return e}}class ue extends ne{constructor(t,e,s,i,r){super(e,s),this.trap=t,this.onCreatureDodge=i,this.onCreatureActivated=r,this.dodgeRatio=t.dodgeRatio}affectCreature(t){const e=this.playerSees(t);return e&&(this.trap.revealed=!0),this.dodges(t)?(this.onCreatureDodge(e,!1),G.DODGE):this.onCreatureActivated(e,!1)}affectPlayer(t){return this.trap.revealed=!0,this.dodges(t)?(this.onCreatureDodge(!0,!0),G.DODGE):this.onCreatureActivated(!0,!0)}dodges(t){return Nt.dodges(t.bodyControl,this.dodgeRatio)}}class de extends u{constructor(t,e,s,i){super(),this.trapPosition=t,this.trap=e,this.levelMap=s,this.game=i}affectCreature(){return G.NOTHING}affectPlayer(t){return this.trap.untrap(this.trapPosition,t,this.levelMap,this.game),G.NOTHING}}class pe extends u{constructor(t,e,s){super(),this.damages=t,this.levelMap=e,this.game=s,this.playerReaction=G.NOTHING}affectCreature(t){return t.specie.material.affectedWithWater?t.on(new Vt(this.damages,vt.Trap,this.levelMap,this.game)):G.RESIST}affectPlayer(t){return this.affectBodyParts(t),this.affectInventory(t),this.affectEquipment(t),this.playerReaction}affectEquipment(t){t.dead||t.inventory.slots().forEach(e=>{if(e.equipment&&e.equipment.item.affectedWithWater){const{item:s,count:i}=e.equipment;switch(s.material.affectedWithWater){case ct.Corrosion:Nt.chance(1,3)&&s.corrode()&&this.game.logger.itemCorrode(s);break;case ct.Destroy:if(Nt.chance(1,4)){const r=Nt.lowerWeight(i);this.game.logger.itemDestroyByWater(s,r),t.on(new ee(e,r,this.game))}}}})}affectInventory(t){t.dead||t.inventory.cares().forEach(({count:e,item:s})=>{switch(s.material.affectedWithWater){case ct.Corrosion:Nt.chance(1,4)&&s.corrode()&&this.game.logger.itemCorrode(s);break;case ct.Destroy:if(Nt.chance(1,6)){const i=Nt.lowerWeight(e);this.game.logger.itemDestroyByWater(s,i),t.inventory.removeFromBag(s,i)}}})}affectBodyParts(t){t.inventory.bodyParts.forEach(e=>{if(!t.dead&&e.affectedWithWater)if(e.equipment)this.game.logger.waterBodyPartEquipmentResist(e,e.equipment.item),this.trackReaction(G.RESIST);else{let s=t.on(new Vt(this.damages,vt.Trap,this.levelMap,this.game));this.game.logger.waterBodyPartDamage(e,s),this.trackReaction(s)}})}trackReaction(t){this.playerReaction===G.HURT&&t===G.DIE?this.playerReaction=G.DIE:this.playerReaction===G.HURT?this.playerReaction=G.HURT:this.playerReaction=t}}var ge=function(t,e){return a(t[0].length,t.length,(s,i)=>{const r=e.get(t[i].charAt(s));if(r)return r();throw`drawn: Can not find char ${t[i].charAt(s)}`})};const me=60;Math.PI;var fe,ve,we,ye;!function(t){t[t.Melee=0]="Melee",t[t.Pierce=1]="Pierce",t[t.Blunt=2]="Blunt",t[t.Magic=3]="Magic",t[t.Pure=4]="Pure"}(fe||(fe={}));class be{constructor(t){this.requires=t,this.current=1,this.currentExperience=0,this.doneLeveling=!1,this.requiredExperience=this.requires[0]}add(t){if(this.doneLeveling)return[];this.currentExperience+=t;let e=[];for(;!this.doneLeveling&&this.currentExperience>=this.requiredExperience;)this.levelUp(),e.push(this.current);return e}levelUp(){this.current+=1;let t=this.requires[this.current-1];t?(this.currentExperience-=this.requiredExperience,this.requiredExperience=t):(this.currentExperience=this.requiredExperience,this.doneLeveling=!0)}}class xe{constructor(t){this.totalWeight=0,this.items=[],t.forEach(([t,e])=>this.add(t,e))}add(t,e){if(t<1)throw"Item's weight is lower than 1";this.items.push([t,e]),this.totalWeight+=Math.ceil(t)}pick(t){if(0===this.items.length)throw"Tried to use empty pool";let e=Object(r.random)(this.totalWeight);const s=this.items.find(([t,s])=>(e-=t)<=0);if(void 0!==s)return s[1](t);throw"Pool failed to pick anything"}merge(t){let e=new xe([]);return this.items.forEach(([t,s])=>e.add(t,s)),t.items.forEach(([t,s])=>e.add(t,s)),e}}class Te{constructor(){this.step=0,this.turns={}}add(t,e){const s=this.step+e;this.turns[s]?Object(r.includes)(this.turns[s],t)||this.turns[s].push(t):this.turns[s]=[t]}remove(t){Object(r.forEach)(this.turns,(e,s)=>{Object(r.remove)(e,e=>e===t)}),this.turns=Object(r.pickBy)(this.turns,t=>t.length>0)}next(){this.step=this.nextStep();const[t]=Object(r.pullAt)(this.turns[this.step],0);return 0===this.turns[this.step].length&&delete this.turns[this.step],void 0===t?this.next():t}actors(){if(0===Object(r.size)(this.turns))return[];this.step=this.nextStep();const t=this.turns[this.step];return delete this.turns[this.step],t}nextStep(){let t=Object(r.min)(Object(r.keys)(this.turns).map(t=>parseInt(t)));if(void 0===t)throw"Timeline.nextStep called when there is no ones turn";return t}}class Ce{constructor(){this.levels=[]}addStairDown(t,e){return this.addStairs(t,new I(t,e))}addStairUp(t,e){return this.addStairs(t,new R(t,e))}addStairs(t,e){return oe(t,t=>t.free(),(s,i)=>{t.setTile(s,i,e)}),t}}class We extends o{constructor(t,e){super(e),this.name=t,this.creatures=[],this.timeline=new Te}reset(){this.timeline=new Te}enter(){this.reset(),this.creatures.forEach(t=>this.timeline.add(t.id,t.speed))}creatureTile(t){let e;if(this.each(s=>{s.creature&&s.creature.id===t.id&&(e=s)}),!e)throw`Creature ${t.id} is not found on map ${this.name}`;return e}creaturePos(t){let e;if(this.each((s,i,r)=>{s.creature&&s.creature.id===t.id&&(e=new n(i,r))}),!e)throw`Creature ${t.id} is not found on map ${this.name}`;return e}addCreature(t,e){this.creatures.push(e),this.at(t.x,t.y).creature=e,this.timeline.add(e.id,e.speed)}removeCreature(t){let e=this.creaturePos(t);this.at(e.x,e.y).creature=void 0,Object(r.remove)(this.creatures,e=>e.id===t.id),this.timeline.remove(t.id)}visibleThrough(t,e){return this.map[t][e].visibleThrough()}passibleThrough(t,e){return this.map[t][e].passibleThrough()}setTile(t,e,s){this.map[t][e]=s}matchStairs(t){let e;if(this.each((s,i,r)=>{(s instanceof I||s instanceof R)&&s.adjacentMapName===t&&(e=new n(i,r))}),e)return e;throw`LevelMap ${this.name} failed to find stairs to ${t}`}}!function(t){t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARNING=2]="WARNING",t[t.DANGER=3]="DANGER"}(ve||(ve={}));class Me{constructor(t){this.messages=[],this.trapAirBlow=new Re(this,t),this.trapBareWire=new Se(this,t),this.trapFallingRock=new Pe(this,t),this.trapHole=new ke(this,t)}reset(){this.messages=[]}hurtMessage(t,e,s,i){this.debug(`${i.name} got ${e} damage from ${s.name}`)}killMessage(t,e,s,i){this.warning(`${i.name} got ${e} damage from ${s.name} causes them to die`)}missMessage(t,e,s){this.debug(`${e.name} misses ${s.name}!`)}throwMissMessage(t,e,s,i){this.debug(`${e.name} throws ${i.name} in ${s.name}, but misses!`)}throwKillMessage(t,e,s,i,r){this.warning(`${i.name} got ${e} damage from ${s.name} by ${r.name} causes them to die`)}throwHurtMessage(t,e,s,i,r){this.debug(`${i.name} got ${e} damage from ${s.name} by ${r.name}`)}ranIntoAnObstacle(){this.addMessage(ve.DEBUG,"You ran into a wall")}howToHandle(){this.addMessage(ve.DEBUG,"Don't know how to handle it")}noItemsToPickUp(){this.addMessage(ve.DEBUG,"You don't see anything to pick up")}takeOff(t){this.addMessage(ve.DEBUG,`You took off ${t.name}`)}putOn(t){this.addMessage(ve.DEBUG,`You put on ${t.name}`)}drink(t){this.addMessage(ve.INFO,`You drunk ${t.name}`)}nothingToShotWith(){this.addMessage(ve.DEBUG,"You have nothing to shoot with")}needMissileWeapon(){this.addMessage(ve.DEBUG,"Мне нужен лук или типа того")}youSteppedInTrap(){this.addMessage(ve.DANGER,"Я наступил в ловушку")}creatureSteppedInTrap(t){this.addMessage(ve.DANGER,`${t.name} наступил в ловушку`)}noDamageToPlayer(t){this.addMessage(ve.DEBUG,`${t.name} ударил по мне, но я не почувствовал боли`)}noDamageToTarget(t){this.addMessage(ve.DEBUG,`Удар пришелся по ${t.name} но остался незамеченным`)}playerIgnoresDamage(t){this.addMessage(ve.DEBUG,`Я игнорирую урон ${t.name}`)}targetIgnoresDamage(t){this.addMessage(ve.INFO,`${t.name} игнорирует урон`)}creatureTeleported(t){this.addMessage(ve.INFO,`${t.name} иcчез`)}creatureNotTeleported(t){this.addMessage(ve.INFO,`${t.name} озарился светом, но ничего не произошло`)}creatureDodgesTeleportationTrap(t){this.addMessage(ve.INFO,`${t.name} попал в ловушку телепортации но смог увернуться`)}playerTeleportationCaused(){this.addMessage(ve.INFO,"Что-то заставило меня телепортироваться")}playerTeleported(){this.addMessage(ve.INFO,"Яркая вспышка и я оказался в другом месте")}playerNotTeleported(){this.addMessage(ve.INFO,"Я озарился ярким светом, но ничего не произошло")}playerTeleportedWhereTheyWere(){this.addMessage(ve.INFO,"Я решил никуда не телепортироваться")}playerDodgesTeleportationTrap(){this.addMessage(ve.INFO,"Я попал в ловушку телепортации но смог увернуться")}lightTrapActivated(t,e,s,i){s?this.addMessage(ve.INFO,"Яркая вспышка света ослепила меня"):this.addMessage(ve.INFO,`${i.name} озарился яркой вспышкой света`)}lightTrapDodge(t,e,s,i){s?this.addMessage(ve.INFO,"Вспышка света чуть не ослепила меня"):this.addMessage(ve.INFO,`${i.name} озарился яркой вспышкой света`)}canNotUntrap(){this.addMessage(ve.INFO,"Не представляю, как это обезвредить")}failedToUntrap(t){this.addMessage(ve.WARNING,"У меня не получилось обезвредить ловушку")}succeededToUntrap(t){this.addMessage(ve.INFO,"Успешно обезвредил ловушку")}pickedUpItem(t,e){1===e?this.addMessage(ve.INFO,`You picked up ${t.name}`):this.addMessage(ve.INFO,`You picked up ${e} ${t.name}`)}droppedItem(t,e){1===e?this.addMessage(ve.INFO,`You dropped a ${t.name}`):this.addMessage(ve.INFO,`You dropped ${e} ${t.name}`)}waterTrapActivated(){this.info("Я попал в ловушку с водой")}waterBodyPartEquipmentResist(t,e){this.debug(`${e.name} защитил ${t.name} от воды`)}waterBodyPartDamage(t,e){switch(e){case G.DIE:this.danger(`Вода попала мне на ${t.name}, рана не совместима с жизнью`);break;case G.HURT:this.danger(`Вода обожгла мне ${t.name}`);break;case G.NOTHING:case G.RESIST:this.danger(`Вода попала мне на ${t.name}, но все обошлось`)}}waterTrapDamage(t,e,s,i,r){if(e)switch(i){case G.DIE:this.danger(`${r.name} растворился в потоках воды`);break;case G.DODGE:this.info(`${r.name} уклонился от потока воды`);break;case G.HURT:this.warning(`${r.name} пострадал от воды`);break;case G.NOTHING:case G.RESIST:s||this.debug(`${r.name} был облит водой`)}}itemCorrode(t){switch(t.corrosionLevel){case mt.Slightly:return this.info(`${t.name} немного заржавел`);case mt.Mostly:return this.info(`${t.name} значительно проржавел`);case mt.Fully:return this.warning(`${t.name} полностью проржавел`)}}itemDestroyByWater(t,e){this.warning(`${e} ${t.name} были уничтожены водой`)}debug(t){this.addMessage(ve.DEBUG,t)}info(t){this.addMessage(ve.INFO,t)}warning(t){this.addMessage(ve.WARNING,t)}danger(t){this.addMessage(ve.DANGER,t)}addMessage(t,e){const s=Object(r.last)(this.messages);s&&s.message===e?s.counter+=1:this.messages.push({level:t,message:e,counter:1})}}class Ie{constructor(t,e){this.logger=t,this.player=e}debug(t){this.logger.debug(t)}info(t){this.logger.info(t)}warning(t){this.logger.warning(t)}danger(t){this.logger.danger(t)}}class Re extends Ie{dodge(t,e,s){e?this.info("Я увернулся от потока воздуха"):t&&this.info(`${s.name} увернулся от потока воздуха`)}resist(t,e,s){e?this.debug("Поток воздуха чуть не снес меня"):t&&this.debug(`${s.name} попал в поток воздуха`)}activate(t,e,s){e?this.info("Меня снесло потоком воздуха"):t&&this.info(`${s.name} снесло потоком воздуха`)}handBlow(t){this.warning(`Поток воздуха выбил ${t.name} у меня из руки`)}headBlow(t){this.warning(`Поток воздуха снял ${t.name} с моей головы`)}}class ke extends Ie{dodge(t,e,s){e?this.warning("Я чуть не упал в яму"):t&&this.warning(`${s.name} чуть не упал в яму`)}activated(t,e,s){e?this.warning("Я упал в яму"):t&&this.warning(`${s.name} упал в яму`)}shallowActivated(t,e,s){e?this.warning("Я упал в неглубокую яму"):t&&this.warning(`${s.name} упал в неглубокую яму`)}}class Se extends Ie{activated(t,e,s){this.info(`${s.name} наступил на оголенный провод`)}doNotWant(){this.info("Трогать оголенный провод руками так себе затея")}resist(){this.info("Я наступил на оголенный провод, но все обошлось")}}class Pe extends Ie{resist(t){return this.info("Камень упал мне на голову, но каска защитила меня")}ranOut(){return this.debug("Громкий щелчок, но ничего не произошло")}dodge(t,e,s,i){this.info(`${i.name} увернулся от ловушки`)}activate(t,e,s,i,r){this.info(`${r.name} попал в ловушку`)}}class Ee{constructor(t,e){this.player=t,this.professionPicker=e,this.playerTurn=!1,this.running=!1,this.effect=null,this.maps=new Map,this.logger=new Me(t)}turn(){this.running||this.player.ai.presenter&&!this.effect||(this.running=!0,this.mutexTurn(),this.running=!1)}mutexTurn(){if(!this.player.ai.runEvents()){if(!this.currentMap)throw"mutexTurn: Map is undefined";if(this.effect)this.player.rebuildVision(this.currentMap),this.effect.patchMemory(this.player.stageMemory(this.currentMap)),this.effect.done()&&(this.effect.onDone(),this.effect=null);else{for(;!this.player.dead&&!this.playerTurn;)this.levelMapTurn();this.player.rebuildVision(this.currentMap)}}}getMap(t){const e=this.maps.get(t);if(!e)throw`Map ${t} is not found`;if(e instanceof We)return e;if(e instanceof Function){const s=e(t,this);return this.maps.set(t,s),s}throw`LevelMap with id ${t} is not found`}addMap(t,e){this.maps.set(t,e)}levelMapTurn(){if(!this.currentMap)throw"levelMapTurn: Map is undefined";let t=this.currentMap.timeline,e=this.currentMap;const s=t.next();if(void 0===s)throw"Timeline event is empty!";const i=e.creatures.find(t=>s===t.id);if(i){const r=i.act(e,this);r&&e.creatures.find(t=>s===t.id)&&t.add(s,r)}}}class Oe{constructor(t,e,s){this.usages=t,this.useSingleItem=e,this.equipment=s,this.name="InventorySlot"}matchingItems(t){return t.cares().filter(t=>this.match(t.item))}get insulator(){return!(!this.equipment||!this.equipment.item.insulator)}get firm(){return!(!this.equipment||!this.equipment.item.firm)}equip(t,e){if(this.equipment)throw`Slot ${this.name} is already equipped with ${this.equipment.item}`;this.equipment={count:e,item:t}}takeOff(){if(!this.equipment)throw`Slot ${this.name} has nothing to take off`;this.equipment=void 0}match(t){return Object(r.intersection)(t.usages,this.usages).length>0}withPairItem(t,e){return t.filter(t=>t.item.worksWith(e))}}class Ne extends Oe{get affectedWithWater(){return void 0!==this.material.affectedWithWater}}class _e extends Ne{constructor(t){super([dt.WeaponOneHand],!0),this.material=t,this.name="Правая рука"}}class De extends Ne{constructor(t){super([dt.WeaponOneHand],!0),this.material=t,this.name="Левая рука"}}class Ae extends Ne{constructor(t){super([dt.WearsOnHead],!0),this.material=t,this.name="Голова"}}class Be extends Ne{constructor(t){super([dt.WearsOnBody],!0),this.material=t,this.name="Корпус"}}class $e extends Ne{constructor(t){super([dt.Boots],!0),this.material=t,this.name="Ботинки"}}class He extends Oe{constructor(){super([dt.Gloves],!0),this.name="Перчатки"}}class Fe extends Oe{constructor(){super([dt.Gauntlets],!0),this.name="Наручи"}}class Le extends Oe{constructor(){super([dt.Belt],!0),this.name="Пояс"}}class Ge extends Oe{constructor(){super([dt.Amulet],!0),this.name="Амулет"}}class je extends Oe{constructor(){super([dt.Ring],!0),this.name="Левый палец"}}class Ue extends Oe{constructor(){super([dt.Ring],!0),this.name="Правый палец"}}class qe extends Oe{constructor(){super([dt.Cloak],!0),this.name="Плащ"}}class Ve extends Oe{constructor(){super([dt.Shoot],!0),this.name="Метательное"}matchingItems(t){let e=super.matchingItems(t),s=t.missileSlot.equipment;return s?this.withPairItem(e,s.item):e}}class Ye extends Oe{constructor(){super([dt.Throw],!1),this.name="Снаряды"}matchingItems(t){let e=t.cares(),s=t.missileWeaponSlot.equipment;return s?this.withPairItem(e,s.item):e}}class ze extends Oe{constructor(){super([dt.Tool],!0),this.name="Инструмент"}}class Xe{constructor(){this.bag=new g,this.headSlot=new Ae(ut.flesh),this.amuletSlot=new Ge,this.cloakSlot=new qe,this.chestSlot=new Be(ut.flesh),this.rightHandSlot=new _e(ut.flesh),this.leftHandSlot=new De(ut.flesh),this.leftFingerSlot=new je,this.rightFingerSlot=new Ue,this.glovesSlot=new He,this.gauntletsSlot=new Fe,this.beltSlot=new Le,this.bootsSlot=new $e(ut.flesh),this.missileWeaponSlot=new Ve,this.missileSlot=new Ye,this.toolsSlot=new ze}get bodyParts(){return[this.headSlot,this.rightHandSlot,this.leftHandSlot,this.chestSlot,this.bootsSlot]}slots(){return[this.headSlot,this.amuletSlot,this.cloakSlot,this.chestSlot,this.rightHandSlot,this.leftHandSlot,this.leftFingerSlot,this.rightFingerSlot,this.glovesSlot,this.gauntletsSlot,this.beltSlot,this.bootsSlot,this.missileWeaponSlot,this.missileSlot,this.toolsSlot]}get allItems(){return Object(r.concat)(this.cares(),Object(r.compact)(this.slots().map(t=>t.equipment)))}get unarmoredSlotsCount(){return[this.headSlot,this.chestSlot,this.glovesSlot,this.gauntletsSlot,this.beltSlot,this.bootsSlot].filter(t=>!t.equipment).length}cares(){return this.bag.bunch}findInBag(t){return this.bag.find(t)}putToBag(t,e){this.bag.put(t,e)}removeFromBag(t,e){this.bag.remove(t,e)}}class Je{constructor(t){this.tile=t,this.visible=!1,this.degree=0,this.seen=!1}get items(){return this.tile.items}get creature(){return this.tile.creature}see(t,e){this.visible=!0,this.degree=e,this.seen=!0,this.tile=t.clone()}tangible(t){return this.seen&&!this.tile.passibleThrough(t)}reset(){this.visible=!1,this.effect=void 0,this.tile.creature=void 0}visit(t){this.tile.visit(t)}}class Ke extends o{constructor(t,e){const s=new W;super(a(t,e,()=>new Je(s)))}resetVisible(){this.each(t=>t.reset())}}class Qe extends j{constructor(t,e,s,i,r,a){super(s),this.level=t,this.ai=e,this.professions=[],this.inventory=new Xe,this.itemsProtections=[],this.itemsResistances=[],this.strength=new B(i),this.dexterity=new $(r),this.constitution=new _(a),this.intelligence=new _(10),this.wisdom=new _(2),this.charisma=new _(2),this.stuffWeight=new _(0),this.carryingCapacity=new D(this.strength.current,this.constitution.current)}act(t,e){this.statsTurn(),this.visionMask(t);const s=this.ai.act(this,t,e);return s&&this.on(s),this.on(new p(t,e)),this.speed}rebuildVision(t){this.visionMask(t)}on(t){return t.affectPlayer(this)}get missile(){return this.inventory.missileSlot.equipment}get inventoryItems(){return this.inventory.allItems}addItem(t,e){this.inventory.putToBag(t,e)}removeItem(t,e){this.inventory.removeFromBag(t,e)}get weightWithCarryings(){return this.specie.weight+Object(r.sumBy)(this.inventory.allItems,({item:t,count:e})=>t.weight*e)}get bodyControl(){return this.specie.bodyControl+this.dexterity.bodyControlAdjustment}get throwDamages(){const t=this.dexterity.missileAdjustment;return Object(r.concat)(this.specie.throwingDamages,this.missileItemsDamages()).map(e=>{let s=Object(r.cloneDeep)(e);return s.extra+=t,s})}get damages(){const t=this.strength.meleeAdjustment;return Object(r.concat)(this.specie.damages,this.meleeItemsDamages()).map(e=>{let s=Object(r.cloneDeep)(e);return s.extra+=t,s})}get protections(){return Object(r.concat)(this.specie.protections,this.itemsProtections,[{type:ft.Unarmored,value:1*this.inventory.unarmoredSlotsCount}])}get resistances(){return Object(r.concat)(this.specie.resistances,this.itemsResistances)}meleeItemsDamages(){const t=this.inventory.rightHandSlot.equipment,e=this.inventory.leftHandSlot.equipment;return Object(r.concat)(t?t.item.damages:[],e?e.item.damages:[])}missileItemsDamages(){const t=this.inventory.missileSlot.equipment,e=this.inventory.missileWeaponSlot.equipment;return Object(r.concat)(t&&t.item.damages||[],e?e.item.damages:[])}}class Ze{constructor(t,e,s=1,i=0){this.id=t,this.name=e,this.level=s,this.points=i,this.talents=[],this.depthCost=3}}class ts{constructor(t,e,s){this.pool=t,this.maxLevel=e,this.maxTaken=s}available(t){let e,s=[];return this.canUpdate(t)?e=this.updatableProfession(t):this.canTakeNewProfession(t)&&(e=this.newFromPool(t)),void 0!==e&&s.push(e),this.canTakeNewProfession(t)?e=this.newFromPool(t,e&&e.id):this.canUpdate(t)&&(e=this.updatableProfession(t,e&&e.id)),void 0!==e&&s.push(e),s}canUpdate(t){return t.professions.some(t=>t.level<this.maxLevel)}updatableProfession(t,e){return Object(r.sample)(t.professions.filter(t=>e!==t.id))}canTakeNewProfession(t){return t.professions.length<this.maxTaken&&this.pool.length>t.professions.length}newFromPool(t,e){const s=t.professions.map(t=>t.id);return void 0!==e&&s.push(e),Object(r.sample)(this.pool.filter(t=>!Object(r.includes)(s,t.id)))}}!function(t){t[t.Available=0]="Available",t[t.Completed=1]="Completed",t[t.Unavailable=2]="Unavailable"}(we||(we={}));class es{constructor(t,e,s,i,r,a){this.id=t,this.name=e,this.depth=s,this.rank=i,this.maxRank=r,this.description=a}}class ss extends k{constructor(t,e=!1){super(v.AirBlow,t,e)}untrap(t,e,s,i){Nt.chance(4,6)?(i.logger.failedToUntrap(e),Nt.chance(3,5)&&this.activate(t,i,s,e)):this.disarmTile(t,e,s,i)}buildNew(){return new ss(this.tile,this.revealed)}get dodgeRatio(){return this.revealed?6:15}get creatureBlowThreshold(){return 60}activate(t,e,s,i){return i.on(new ue(this,s,e,(t,s)=>e.logger.trapAirBlow.dodge(t,s,i),(r,a)=>{if(i.weightWithCarryings>=this.creatureBlowThreshold)e.logger.trapAirBlow.resist(r,a,i);else{let n=this.randomPos(t,s,Nt.higherWeight(3,1),t=>t.passibleThrough(i));n.eq(t)?e.logger.trapAirBlow.resist(r,a,i):(e.logger.trapAirBlow.activate(r,a,i),i.on(new q(e,s,n)))}if(a){const i=e.player,r=i.inventory;[[r.headSlot,3,t=>e.logger.trapAirBlow.headBlow(t)],[r.rightHandSlot,40/i.strength.current,t=>e.logger.trapAirBlow.handBlow(t)],[r.leftHandSlot,45/i.strength.current,t=>e.logger.trapAirBlow.handBlow(t)]].forEach(([r,a,n])=>{r.equipment&&a>=3&&Nt.chance(1,Math.round(a))&&(n(r.equipment.item),this.throwItem(t,s,r.equipment.item),i.on(new ee(r,1,e)))})}return G.NOTHING}))}throwItem(t,e,s){let i=this.randomPos(t,e,Nt.lowerWeight(5,1),t=>t.isFloor());e.at(i.x,i.y).addItem(s,1)}randomPos(t,e,s,i){let a=t,o=!1;return Object(r.shuffle)(c.all).forEach(r=>{if(!o){let h=!1;l(t,t.add(r.multiple(s)),(t,s)=>{!h&&e.inRange(new n(t,s))&&i(e.at(t,s))?(a=new n(t,s),o=!0):h=!0})}}),a}}class is extends ne{constructor(t,e,s){super(e,s),this.trap=t}get hurtEvent(){return new Vt(this.damages,vt.Trap,this.levelMap,this.game)}get damages(){return[{type:fe.Pure,dice:{times:5,max:2},extra:5}]}affectCreature(t){const e=t.on(this.hurtEvent);return this.playerSees(t)&&(this.trap.revealed=!0),this.game.logger.trapBareWire.activated(this.playerSees(t),e,t),e}affectPlayer(t){if(this.trap.revealed=!0,t.inventory.bootsSlot.insulator)return this.game.logger.trapBareWire.resist(),G.RESIST;{const e=t.on(this.hurtEvent);return this.game.logger.trapBareWire.activated(!0,e,t),e}}}class rs extends k{constructor(t,e=!1){super(v.BareWire,t,e)}untrap(t,e,s,i){e.inventory.glovesSlot.insulator?Nt.chance(1,7)?(i.logger.failedToUntrap(e),this.activate(t,i,s,e)):this.disarmTile(t,e,s,i):i.logger.trapBareWire.doNotWant()}buildNew(){return new rs(this.tile,this.revealed)}get dodgeRatio(){return this.revealed?5:10}activate(t,e,s,i){return Nt.dodges(i.bodyControl,this.dodgeRatio)?G.DODGE:i.on(new is(this,s,e))}}class as extends k{constructor(t,e,s=!1,i=5){super(v.FallingRock,e,s),this.newRock=t,this.missilesCount=i}buildNew(){return new as(this.newRock,this.tile,this.revealed,this.missilesCount)}get dodgeRatio(){return this.revealed?3:12}get damages(){return[{type:fe.Blunt,extra:3,dice:{times:2,max:5}}]}untrap(t,e,s,i){if(Nt.chance(1,4)){i.logger.failedToUntrap(e);const r=s.at(t.x,t.y).creature;r?this.activate(t,i,s,r):this.throwMissile(t,s,i.logger)}else this.disarmTile(t,e,s,i)}activate(t,e,s,i){return this.throwMissile(t,s,e.logger)?i.on(new ue(this,s,e,(t,s)=>e.logger.trapFallingRock.dodge(e.player,t,s,i),(t,r)=>{if(r&&e.player.inventory.headSlot.firm)return e.logger.trapFallingRock.resist(e.player),G.RESIST;const a=i.on(new Vt(this.damages,vt.Trap,s,e));return e.logger.trapFallingRock.activate(e.player,t,r,a,i),a})):G.NOTHING}throwMissile(t,e,s){return this.missilesCount<=0?(s.trapFallingRock.ranOut(),!1):(this.missilesCount-=1,e.at(t.x,t.y).addItem(this.newRock(),1),!0)}}class ns extends k{constructor(t,e=!1){super(v.Hole,t,e)}buildNew(){return new ns(this.tile,this.revealed)}untrap(t,e,s,i){i.logger.canNotUntrap()}get dodgeRatio(){return this.revealed?1:5}activate(t,e,s,i){return i.on(new ue(this,s,e,(t,s)=>e.logger.trapHole.dodge(t,s,i),(t,r)=>{let a=this.fallEvent(e,s);return a?(e.logger.trapHole.activated(t,r,i),i.on(a),i.on(new Vt([{type:fe.Pure,dice:{times:3,max:2},extra:2}],vt.Trap,s,e))):(e.logger.trapHole.shallowActivated(t,r,i),i.on(new Mt(s)))}))}fallEvent(t,e){let s=void 0;return le(e,()=>!0,i=>{if(i instanceof I){let r=t.getMap(i.adjacentMapName),a=void 0;(a=he(r,t=>t.passibleThrough()))&&(s=new q(t,e,new n(a.x,a.y),r))}}),s}}class os extends k{constructor(t,e=!1){super(v.Light,t,e)}untrap(t,e,s,i){Nt.chance(1,3)?(i.logger.failedToUntrap(e),this.activate(t,i,s,e)):this.disarmTile(t,e,s,i)}buildNew(){return new os(this.tile,this.revealed)}get dodgeRatio(){return this.revealed?1:10}get duration(){return 10}activate(t,e,s,i){return i.on(new ue(this,s,e,(t,s)=>e.logger.lightTrapDodge(e.player,t,s,i),(t,s)=>i.hasImpact(m.Blind)?G.NOTHING:(e.logger.lightTrapActivated(e.player,t,s,i),i.on(new Ot(m.Blind,"trap",e,this.duration)))))}}class hs extends k{constructor(t,e=!1){super(v.Teleportation,t,e)}untrap(t,e,s,i){i.logger.canNotUntrap()}buildNew(){return new hs(this.tile,this.revealed)}get dodgeRatio(){return this.revealed?3:10}activate(t,e,s,i){return i.on(new ue(this,s,e,(t,s)=>{s?e.logger.playerDodgesTeleportationTrap():t&&e.logger.creatureDodgesTeleportationTrap(i)},(t,r)=>i.on(new ce(s,e,!1))))}}class ls extends k{constructor(t,e=!1){super(v.Water,t,e)}buildNew(){return new ls(this.tile,this.revealed)}get dodgeRatio(){return this.revealed?10:8}get damages(){return[{type:fe.Pure,extra:5,dice:{times:2,max:2}}]}untrap(t,e,s,i){Nt.chance(3,4)?(i.logger.failedToUntrap(e),Nt.chance(1,4)&&this.activate(t,i,s,e)):this.disarmTile(t,e,s,i)}activate(t,e,s,i){return i.on(new ue(this,s,e,(t,s)=>e.logger.waterTrapDamage(e.player,t,s,G.DODGE,i),(t,r)=>{r&&e.logger.waterTrapActivated();let a=i.on(new pe(this.damages,s,e));return r||e.logger.waterTrapDamage(e.player,t,r,a,i),a}))}}class cs extends wt{constructor(t,e){super(ht.ItemsListing,t,e),this.positions=[],this.initPositions()}close(){this.goIdle()}}class us extends cs{get singleItemMode(){return!0}}class ds extends cs{get singleItemMode(){return!1}}class ps extends us{constructor(){super(...arguments),this.title="Сумка"}initPositions(){this.positions=this.player.inventory.cares()}withItem(){this.endTurn()}}class gs extends us{constructor(){super(...arguments),this.title="Что выпить?"}initPositions(){this.positions=this.player.inventory.cares().filter(t=>t.item.group===pt.Potion)}withItem({item:t}){this.player.on(new zt(t,this.game)),this.endTurn()}}class ms extends ds{constructor(){super(...arguments),this.title="Что положить?"}initPositions(){this.positions=this.player.inventory.cares()}withItems(t){t.length?(this.player.on(new Xt(this.tile,t,this.game)),this.endTurn()):this.goIdle()}}class fs extends wt{constructor(t,e){super(ht.Inventory,t,e),this.positions=[],this.takeTime=!1,this.rebuildPositions()}takeOff(t){this.player.on(new te(t.inventorySlot,this.game)),this.takeTime=!0,this.rebuildPositions()}putOn(t){this.redirect(new ks(e=>{this.player.on(new re(t.inventorySlot,e.item,this.game)),this.takeTime=!0,this.rebuildPositions(),this.redirect(this)},t.availableItems,this.levelMap,this.game))}close(){this.takeTime?this.endTurn():this.redirect(new xs(this.levelMap,this.game))}rebuildPositions(){this.positions=this.player.inventory.slots().map(t=>({inventorySlot:t,item:t.equipment&&t.equipment.item,count:t.equipment&&t.equipment.count,availableItems:t.matchingItems(this.player.inventory)}))}}class vs extends wt{constructor(t,e){super(ht.Missile,t,e),this.targetEnemyIndex=void 0,this.enemies=[],this.path=[],this.findEnemies(),this.memory=this.player.stageMemory(this.levelMap),this.targetPos=this.resetTargetId()}nextTarget(){void 0!==this.targetEnemyIndex?(this.targetEnemyIndex+=1,this.targetEnemyIndex>=this.enemies.length&&(this.targetEnemyIndex=0),this.updateTarget(this.enemies[this.targetEnemyIndex])):this.resetTargetId()}previousTarget(){void 0!==this.targetEnemyIndex?(this.targetEnemyIndex-=1,this.targetEnemyIndex<0&&(this.targetEnemyIndex=this.enemies.length-1),this.updateTarget(this.enemies[this.targetEnemyIndex])):this.resetTargetId()}moveTarget(t){const e=this.targetPos.add(t);this.levelMap.at(e.x,e.y).visibleThrough()&&this.player.stageMemory(this.levelMap).at(e.x,e.y).visible&&(this.updateTarget(e),this.targetEnemyIndex=void 0)}attack(){this.targetPos.eq(this.levelMap.creaturePos(this.player))||this.player.on(new se(this.path,this.game,this.levelMap,()=>this.endTurn()))}close(){this.resetPath(),this.redirect(new xs(this.levelMap,this.game))}resetTargetId(){let t;return this.enemies.length?(this.targetEnemyIndex=0,t=this.enemies[this.targetEnemyIndex]):(this.targetEnemyIndex=void 0,t=this.levelMap.creaturePos(this.player)),this.updateTarget(t),t}resetPath(){this.path.forEach(({x:t,y:e})=>this.memory.at(t,e).effect=void 0)}updateTarget(t){this.resetPath(),this.targetPos=t.copy(),this.drawPath()}drawPath(){this.path=[];let t=!1;const e=this.levelMap,s=this.levelMap.creaturePos(this.player);l(s,this.targetPos,(s,i)=>{e.at(s,i).passibleThrough()||(t=!0),this.path.push(new n(s,i)),this.memory.at(s,i).effect=t?"o":"x"})}findEnemies(){this.enemies=[],this.player.stageMemory(this.levelMap).each((t,e,s)=>{t.visible&&t.creature&&t.creature.id!==this.player.id&&this.enemies.push(new n(e,s))})}}class ws extends wt{constructor(t,e,s,i){super(ht.PickHandleOption,e,s),this.options=t,this.withOption=i}pick(t){this.withOption(t)}close(){this.goIdle()}}class ys extends E{constructor(t,e,s){super(),this.position=t,this.game=e,this.levelMap=s,this.commands=[]}onStairway(t){const e=this.game.getMap(t.adjacentMapName);this.commands.push(["stairway",new q(this.game,this.levelMap,t.enterPos(this.levelMap,e),e)])}onTrap(t){t.revealed&&this.commands.push(["untrap",new de(this.position,t,this.levelMap,this.game)])}}class bs extends ys{onStairway(){}}class xs extends wt{constructor(t,e){super(ht.Idle,t,e)}inventoryCommand(){this.redirect(new fs(this.levelMap,this.game))}bagCommand(){this.redirect(new ps(this.levelMap,this.game))}stayCommand(){this.player.on(new Mt(this.levelMap)),this.endTurn()}dropCommand(){this.redirect(new ms(this.levelMap,this.game))}drinkCommand(){this.redirect(new gs(this.levelMap,this.game))}lookCommand(){this.redirect(new Cs(this.levelMap,this.game))}move(t){const e=this.levelMap.creaturePos(this.player).add(t),s=this.levelMap.at(e.x,e.y);s.passibleThrough(this.player)?this.player.on(new q(this.game,this.levelMap,e)):s.creature?this.player.on(new Yt(s.creature,this.levelMap,this.game)):(this.game.logger.ranIntoAnObstacle(),this.player.stageMemory(this.levelMap).at(e.x,e.y).see(s,0)),this.endTurn()}pickUpCommand(){const t=this.tile,e=t.items;void 0===e||0===e.bunch.length?this.game.logger.noItemsToPickUp():1===e.bunch.length?(this.player.on(new ie(t,e.bunch,this.game)),this.endTurn()):this.redirect(new Is(this.levelMap,this.game))}missileCommand(){const t=this.player.inventory.missileSlot.equipment;t&&t.item?t.item.canThrow(this.player)?this.redirect(new vs(this.levelMap,this.game)):this.game.logger.needMissileWeapon():this.game.logger.nothingToShotWith()}handleCommand(){let t=this.levelMap.creaturePos(this.player),e=new ys(t,this.game,this.levelMap),s=new bs(t,this.game,this.levelMap);this.tile.visit(e),t.wrappers().forEach(t=>{s.position=t,this.levelMap.at(t.x,t.y).visit(s)});const i=Object(r.concat)(e.commands,s.commands);switch(i.length){case 0:this.game.logger.howToHandle();break;case 1:this.player.on(i[0][1]),this.endTurn();break;default:this.redirect(new ws(i,this.levelMap,this.game,([t,e])=>{this.player.on(e),this.endTurn()}))}}}class Ts extends wt{constructor(t,e,s,i,r){super(t,e,s),this.effect=i,this.match=r,this.memory=this.player.stageMemory(this.levelMap),this.targetPos=e.creaturePos(this.player),this.drawTarget()}act(){this.removeEffect(),this.close()}get memoryTile(){return this.memory.at(this.targetPos.x,this.targetPos.y)}moveTarget(t){const e=this.targetPos.add(t);this.match(e)&&this.updateTarget(e)}removeEffect(){this.memory.at(this.targetPos.x,this.targetPos.y).effect=void 0}updateTarget(t){this.removeEffect(),this.targetPos=t.copy(),this.drawTarget()}drawTarget(){this.memoryTile.effect=this.effect}}!function(t){t[t.See=0]="See",t[t.Recall=1]="Recall",t[t.Hidden=2]="Hidden"}(ye||(ye={}));class Cs extends Ts{constructor(t,e){super(ht.Look,t,e,"_",t=>this.memory.inRange(t))}get title(){return this.memoryTile.visible?ye.See:this.memoryTile.seen?ye.Recall:ye.Hidden}get body(){let t=[];if(this.memoryTile.creature&&(this.memoryTile.creature.id===this.player.id?t.push("Это я"):t.push(`Это ${this.memoryTile.creature.name}`)),this.memoryTile.items)switch(this.memoryTile.items.bunch.length){case 0:break;case 1:t.push(`Лежит ${this.memoryTile.items.bunch[0].item.name}`);break;default:t.push("Лежит несколько предметов")}return t}close(){this.redirect(new xs(this.levelMap,this.game))}}class Ws extends wt{constructor(t,e,s){super(ht.AbilitiesPicking,e,s),this.level=t,this.options=[],this.options=this.player.professions.map(t=>({profession:t,talents:t.talents.map(e=>Object.assign({},e,{status:this.status(e,t)}))}))}get title(){return"Pick new talent"}pickTalent(t,e){const s=this.player.professions.find(e=>e.id===t);if(void 0===s)throw`Profession with id ${t} is not found`;let i=s.talents.find(t=>t.id===e);if(void 0===i)throw`Talent with id ${e} for profession ${s.name} is not found`;if(this.status(i,s)!==we.Available)throw`Talent with id ${e} for profession ${s.name} can not be upgraded`;i.rank+=1,1===i.rank&&i.onObtain(this.game),s.points+=1,this.player.on(new Jt),this.endTurn()}status(t,e){return t.rank===t.maxRank?we.Completed:t.depth*e.depthCost>e.points?we.Unavailable:we.Available}}class Ms extends Ts{constructor(t,e){super(ht.Teleportation,t,e,"x",({x:e,y:s})=>t.at(e,s).passibleThrough(this.player)&&this.memory.at(e,s).seen)}get title(){return"Выберите зону телепортации"}get body(){return[]}close(){this.targetPos.eq(this.levelMap.creaturePos(this.player))?this.game.logger.playerTeleportedWhereTheyWere():this.player.on(new q(this.game,this.levelMap,this.targetPos)),this.endTurn()}}class Is extends ds{constructor(){super(...arguments),this.title="Что поднять?"}initPositions(){const t=this.tile.items;if(void 0===t)throw"Failed to show pick up dialog - tile has no items";this.positions=t.bunch.map(t=>({item:t.item,count:t.count}))}withItems(t){this.player.on(new ie(this.tile,t,this.game)),this.endTurn()}}class Rs extends wt{constructor(t,e,s){super(ht.ProfessionPicking,e,s),this.level=t}get title(){return`Gained ${this.level} level`}get options(){return this.game.professionPicker.available(this.player)}pickProfession(t){let e=this.player.professions.find(e=>e.id===t.id);e?e.level+=1:this.player.professions.push(t),this.redirect(new Ws(this.level,this.levelMap,this.game))}}class ks extends us{constructor(t,e,s,i){super(s,i),this.onWithItem=t,this.positions=e,this.title="Что надеть?"}initPositions(){}withItem(t){this.onWithItem(t)}close(){this.redirect(new fs(this.levelMap,this.game))}}const Ss=function(t,e,s,i,n=!1){let o=a(t.width,t.height,()=>-1),h=[],l=[e],c=0;for(;l.length&&!h.length;){let e=[];l.forEach(r=>{if(!t.inRange(r))return;const a=t.at(r.x,r.y);s(a)||-1!==o[r.x][r.y]||(o[r.x][r.y]=c,i(r,a)?h.push(r):r.wrappers().forEach(t=>e.push(t)))}),c++,l=e}if(h.length){let t=Object(r.sample)(h);return Ps(n&&t?t:h[0],o)}return[]},Ps=function(t,e){let s,i=t,r=[i];for(;1!==e[i.x][i.y];){if(void 0===(s=n.dxy.find(t=>e[i.x+t.x]&&e[i.x+t.x][i.y+t.y]===e[i.x][i.y]-1)))return[];i=i.add(s),r.unshift(i)}return r};var Es=i.a.extend({name:"Logger",props:{logger:{type:Me,required:!0}},data:()=>({lastId:0}),computed:{messages(){const t=this.logger.messages.length,e=Object(r.takeRight)(this.logger.messages,Math.max(t-this.lastId,5));return this.lastId=t,e}},methods:{counter(t){if(t>1)return`x${t}`},rowClass(t){switch(t.level){case ve.DEBUG:return"debug";case ve.INFO:return"info";case ve.WARNING:return"warning";case ve.DANGER:return"danger"}}}}),Os=(s(45),s(2)),Ns=Object(Os.a)(Es,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"logger"},t._l(t.messages,function(e,i){return s("div",{key:i,class:t.rowClass(e)},[t._v(t._s(e.message)+"\n"+t._s(t.counter(e.counter)))])}))},[],!1,null,"4926948c",null);Ns.options.__file="Logger.vue";var _s=Ns.exports;class Ds{constructor(t,e,s,i,r,a,n){this.ch=t,this.r=e,this.g=s,this.b=i,this.br=r,this.bg=a,this.bb=n}getChar(){return this.ch}setChar(t){this.ch=t}setColor(t,e,s){this.r=t,this.g=e,this.b=s}setGrey(t){this.r=t,this.g=t,this.b=t}setBackground(t,e,s){this.br=t,this.bg=e,this.bb=s}backgroundToColor(){this.r=this.br,this.g=this.bg,this.b=this.bb}swapColors(){this.r=[this.br,this.br=this.r][0],this.g=[this.bg,this.bg=this.g][0],this.b=[this.bb,this.bb=this.b][0]}resetColor(){this.r=this.g=this.b=void 0}resetBackground(){this.br=this.bg=this.bb=void 0}getColorHex(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?"#"+this.r.toString(16)+this.g.toString(16)+this.b.toString(16):""}getBackgroundHex(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?"#"+this.br.toString(16)+this.bg.toString(16)+this.bb.toString(16):""}getColorRGB(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?`rgb(${this.r},${this.g},${this.b})`:""}getBackgroundRGB(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?`rgb(${this.br},${this.bg},${this.bb})`:""}getColorJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.r,g:this.g,b:this.b}:{}}getBackgroundJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.br,g:this.bg,b:this.bb}:{}}copy(t){this.ch=t.ch,this.r=t.r,this.g=t.g,this.b=t.b,this.br=t.br,this.bg=t.bg,this.bb=t.bb}clone(){return new Ds(this.ch,this.r,this.g,this.b,this.br,this.bg,this.bb)}}const As="unicodetiles",Bs=new Ds(" ");const $s="\nattribute vec2 position;\nattribute vec2 texCoord;\nattribute vec3 color;\nattribute vec3 bgColor;\nattribute float charIndex;\nuniform vec2 uResolution;\nuniform vec2 uTileCounts;\nuniform vec2 uPadding;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec2 tileCoords = floor(vec2(mod(charIndex, uTileCounts.x), charIndex / uTileCounts.x));\n  vTexCoord = (texCoord + tileCoords) / uTileCounts;\n  vTexCoord += (0.5 - texCoord) * uPadding;\n  vColor = color;\n  vBgColor = bgColor;\n  vec2 pos = position / uResolution * 2.0 - 1.0;\n  gl_Position = vec4(pos.x, -pos.y, 0.0, 1.0);\n}\n",Hs="\nprecision mediump float;\nuniform sampler2D uFont;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec4 color = texture2D(uFont, vTexCoord);\n  color.rgb = mix(vBgColor, vColor, color.rgb);\n  gl_FragColor = color;\n}\n";const Fs=function(t){return new class{constructor(t){if(this.view=t,this.view=t,this.canvas=document.createElement("canvas"),!this.canvas.getContext)throw"Canvas not supported";if(this.gl=this.canvas.getContext("experimental-webgl"),!this.gl)throw"WebGL not supported";if(t.elem.appendChild(this.canvas),this.charMap={},this.charArray=[],this.defaultColors={r:1,g:1,b:1,br:0,bg:0,bb:0},this.attribs={position:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},texCoord:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},color:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},bgColor:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},charIndex:{buffer:null,data:null,itemSize:1,location:null,hint:this.gl.DYNAMIC_DRAW}},this.offscreen||(this.offscreen=document.createElement("canvas")),this.offscreen.style.position="absolute",this.offscreen.style.top="0px",this.offscreen.style.left="0px",this.ctx=this.offscreen.getContext("2d"),!this.ctx)throw"Failed to acquire offscreen canvas drawing context";this.updateStyle(),this.canvas.width=(t.squarify?this.th:this.tw)*t.w,this.canvas.height=this.th*t.h,this.offscreen.width=0,this.offscreen.height=0,this.updateStyle(),this.gl.viewport(0,0,this.canvas.width,this.canvas.height);let e=this.compileShader(this.gl.VERTEX_SHADER,$s),s=this.compileShader(this.gl.FRAGMENT_SHADER,Hs),i=this.gl.createProgram();if(this.gl.attachShader(i,e),this.gl.attachShader(i,s),this.gl.linkProgram(i),this.gl.deleteShader(e),this.gl.deleteShader(s),!this.gl.getProgramParameter(i,this.gl.LINK_STATUS)){const t=`Error linking program: ${this.gl.getProgramInfoLog(i)}`;throw this.gl.deleteProgram(i),t}this.gl.useProgram(i),this.attribs.position.location=this.gl.getAttribLocation(i,"position"),this.attribs.texCoord.location=this.gl.getAttribLocation(i,"texCoord"),this.attribs.color.location=this.gl.getAttribLocation(i,"color"),this.attribs.bgColor.location=this.gl.getAttribLocation(i,"bgColor"),this.attribs.charIndex.location=this.gl.getAttribLocation(i,"charIndex"),this.initBuffers();let r=this.gl.getUniformLocation(i,"uResolution");this.gl.uniform2f(r,this.canvas.width,this.canvas.height),this.tileCountsLocation=this.gl.getUniformLocation(i,"uTileCounts"),this.gl.uniform2f(this.tileCountsLocation,this.view.w,this.view.h),this.paddingLocation=this.gl.getUniformLocation(i,"uPadding"),this.gl.uniform2f(this.paddingLocation,0,0);let a=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.cacheChars(" !\"#$%&'()*+,-./0123456789:<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.activeTexture(this.gl.TEXTURE0),setTimeout(()=>{this.updateStyle(),this.buildTexture(),this.render()},100)}getRendererString(){return"webgl"}buildTexture(){let t=this.offscreen.width/(this.tw+this.pad),e=this.offscreen.height/(this.th+this.pad);const s=this.charArray.length;s>Math.floor(t)*Math.floor(e)&&(e=(t=Math.ceil(Math.sqrt(s)))+2,this.offscreen.width=t*(this.tw+this.pad),this.offscreen.height=e*(this.th+this.pad),this.updateStyle(),this.gl.uniform2f(this.tileCountsLocation,t,e)),this.gl.uniform2f(this.paddingLocation,this.pad/this.offscreen.width,this.pad/this.offscreen.height);let i,r=0;this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.offscreen.width,this.offscreen.height),this.ctx.fillStyle="#ffffff";const a=.5*this.gap,n=this.tw+this.pad,o=this.th+this.pad;let h=.5*o;for(let s=0;s<e;++s){let e=.5*this.pad;for(let s=0;s<t&&void 0!==(i=this.charArray[r]);++s,++r)this.ctx.fillText(i,e+a,h),e+=n;if(!i)break;h+=o}this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.offscreen)}cacheChars(t,e=!0){if(!this.gl)return;let s=!1;for(let e=0;e<t.length;++e)this.charMap[t[e]]||(s=!0,this.charArray.push(t[e]),this.charMap[t[e]]=this.charArray.length-1);s&&e&&this.buildTexture()}updateStyle(t){t=t||window.getComputedStyle(this.view.elem,null),this.ctx.font=t.fontSize+"/"+t.lineHeight+" "+t.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="#ffffff",this.tw=this.ctx.measureText("幅").width,this.th=parseInt(t.fontSize,10),this.gap=this.view.squarify?this.th-this.tw:0,this.view.squarify&&(this.tw=this.th),this.pad=2*Math.ceil(.2*this.th);const e=t.color.match(/\d+/g),s=t.backgroundColor.match(/\d+/g);this.defaultColors.r=parseInt(e[0],10)/255,this.defaultColors.g=parseInt(e[1],10)/255,this.defaultColors.b=parseInt(e[2],10)/255,this.defaultColors.br=parseInt(s[0],10)/255,this.defaultColors.bg=parseInt(s[1],10)/255,this.defaultColors.bb=parseInt(s[2],10)/255}clear(){}render(){this.gl.clear(this.gl.COLOR_BUFFER_BIT);const t=this.view.w,e=this.view.h;let s=this.view.buffer,i=(this.view.defaultColor,this.view.defaultBackground,!1);for(let r=0;r<e;++r)for(let e=0;e<t;++e){const a=s[r][e];let n=this.charMap[a.ch];void 0===n&&(this.cacheChars(a.ch,!1),i=!0,n=this.charMap[a.ch]);const o=6*this.attribs.color.itemSize*(r*t+e),h=6*this.attribs.charIndex.itemSize*(r*t+e),l=void 0===a.r?this.defaultColors.r:a.r/255,c=void 0===a.g?this.defaultColors.g:a.g/255,u=void 0===a.b?this.defaultColors.b:a.b/255,d=void 0===a.br?this.defaultColors.br:a.br/255,p=void 0===a.bg?this.defaultColors.bg:a.bg/255,g=void 0===a.bb?this.defaultColors.bb:a.bb/255;for(let t=0;t<6;++t){const e=o+t*this.attribs.color.itemSize;this.attribs.color.data[e+0]=l,this.attribs.color.data[e+1]=c,this.attribs.color.data[e+2]=u,this.attribs.bgColor.data[e+0]=d,this.attribs.bgColor.data[e+1]=p,this.attribs.bgColor.data[e+2]=g,this.attribs.charIndex.data[h+t]=n}}i&&this.buildTexture(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.color.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.color.data,this.attribs.color.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.bgColor.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.bgColor.data,this.attribs.bgColor.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.charIndex.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.charIndex.data,this.attribs.charIndex.hint);const r=this.attribs.position;this.gl.drawArrays(this.gl.TRIANGLES,0,r.data.length/r.itemSize)}compileShader(t,e){const s=this.gl.createShader(t);if(this.gl.shaderSource(s,e),this.gl.compileShader(s),!this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)){const t="Error compiling shader: "+this.gl.getShaderInfoLog(s);throw this.gl.deleteShader(s),t}return s}initBuffers(){let t,e,s=this.attribs;const i=this.view.w,r=this.view.h;for(t in this.attribs)(e=s[t]).data=new Float32Array(6*e.itemSize*i*r);for(let t=0;t<r;++t)for(let e=0;e<i;++e){const r=6*s.position.itemSize*(t*i+e);this.insertQuad(s.position.data,r,e*this.tw,t*this.th,this.tw,this.th),this.insertQuad(s.texCoord.data,r,0,0,1,1)}for(t in this.attribs)(e=s[t]).buffer&&this.gl.deleteBuffer(e.buffer),e.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e.data,e.hint),this.gl.enableVertexAttribArray(e.location),this.gl.vertexAttribPointer(e.location,e.itemSize,this.gl.FLOAT,!1,0,0)}insertQuad(t,e,s,i,r,a){const n=s,o=i,h=s+r,l=i+a;t[e]=n,t[++e]=o,t[++e]=h,t[++e]=o,t[++e]=n,t[++e]=l,t[++e]=n,t[++e]=l,t[++e]=h,t[++e]=o,t[++e]=h,t[++e]=l}}(t)};var Ls,Gs;!function(t){t[t.AttackerTwoHandedWeapons=0]="AttackerTwoHandedWeapons",t[t.AttackerHeavyWeapons=1]="AttackerHeavyWeapons",t[t.AttackerLightWeapons=2]="AttackerLightWeapons",t[t.AttackerTwoWeapons=3]="AttackerTwoWeapons",t[t.AttackerDoubleTwoHandedWeapons=4]="AttackerDoubleTwoHandedWeapons",t[t.AttackerStrongGrip=5]="AttackerStrongGrip"}(Ls||(Ls={}));class js extends es{constructor(t,e,s,i,r,a=""){super(t,e,s,i,r,a)}}class Us extends js{constructor(){super(Ls.AttackerTwoHandedWeapons,"Двуручные оружия",0,0,3)}onObtain(t){}}!function(t){t[t.Attacker=0]="Attacker",t[t.Defender=1]="Defender"}(Gs||(Gs={}));class qs extends Ze{constructor(t=1){super(Gs.Attacker,"Оружейник",t),this.talents.push(new Us)}}class Vs extends Ze{constructor(t=1){super(Gs.Defender,"Защитник",t)}}class Ys extends ts{constructor(t,e=new qs,s=new Vs){super([e,s],3,6),this.attacker=e,this.defender=s}}class zs extends $t{worksWith(t){return t instanceof Js}}class Xs extends $t{worksWith(t){return t instanceof Ks}canThrow(t){return!!t.inventory.missileWeaponSlot.equipment}}class Js extends Ht{worksWith(t){return t instanceof zs}}class Ks extends Ht{worksWith(t){return t instanceof Xs}}const Qs=()=>new Ks("Обычный лук",1,[{type:fe.Pierce,dice:{times:1,max:3},extra:3}],ut.wood),Zs=()=>new zs("Маленький камень",.3,[{type:fe.Blunt,dice:{times:1,max:3},extra:2}],ut.stone),ti=()=>new Xs("Деревянная стрела",.2,[{type:fe.Pierce,dice:{times:1,max:4},extra:3}],ut.wood),ei=()=>new Xs("Железная стрела",.25,[{type:fe.Pierce,dice:{times:2,max:3},extra:3}],ut.iron);new xe([[1,()=>new Ft("Катана",1,ut.iron,[{type:fe.Melee,dice:{times:5,max:2},extra:0}])],[7,()=>new Ft("Кинжал",.8,ut.iron,[{type:fe.Melee,dice:{times:1,max:3},extra:2}])]]),new xe([[1,()=>new Gt("Кольчуга",5,ut.iron,[{type:ft.Medium,value:3}])],[5,()=>new Gt("Латы",3,ut.iron,[{type:ft.Heavy,value:5}])],[10,()=>new Gt("Роба",1,ut.iron,[{type:ft.Unarmored,value:1}])],[100,()=>new class extends At{constructor(){super("Зелье лечения")}onDrink(t){t.player.health.increase(5)}}]]);class si extends jt{constructor(){super("Кроссовки скорости света",.1,ut.cloth,[]),this.impacts=[m.Blind]}}const ii=(t,e=[],s)=>new class extends j{constructor(t,e,s=j.getId()){super(e,s),this.ai=t}act(t,e){this.statsTurn(),this.visionMask(t);const s=this.ai.act(this,t,e);return s&&this.on(s),this.on(new p(t,e)),this.speed}get missile(){if(this.specie.throwingItem)return{item:this.specie.throwingItem,count:1}}get inventoryItems(){return this.bag?this.bag.bunch:[]}addItem(t,e){this.bag||(this.bag=new g),this.bag.put(t,e)}removeItem(t,e){if(!this.bag)throw`Creature ${this.name} tried to remove item ${t.name} but it does not present`;this.bag.remove(t,e)}}(new class extends it{constructor(){super(),this.escaper=new Q,this.explorer=new Z,this.chaser=new J,this.attacker=new X,this.picker=new Wt,this.patrol=new ot,this.loiter=new tt,this.thrower=new Pt,this.descender=new St}act(t,e,s){let i;return this.runEvents(),this.feelsGood(t)?(i=this.attacker.act(t,e,s))||(i=this.thrower.act(t,e,s))||(i=this.chaser.act(t,e,s))||(i=this.picker.act(t,e,s))||(i=this.explore(t,e,s)):this.healthCritical(t)&&(i=this.escaper.act(t,e,s))||(i=this.attacker.act(t,e,s))||(i=this.thrower.act(t,e,s))||(i=this.chaser.act(t,e,s))||(i=(new It).act(t,e)),this.resetEvents(),i}feelsGood(t){return t.health.currentValue>.9*t.health.maximum}healthCritical(t){return t.health.currentValue<t.health.maximum/4}explore(t,e,s){let i;return(i=this.explorer.act(t,e,s))?t.dead||this.patrol.trackMovement(e.creaturePos(t),e.creatureTile(t)):(i=this.descender.act(t,e,s))||(i=this.patrol.act(t,e,s))||(i=this.loiter.act(t,e,s)),i}},{name:t,weight:10,clan:H.PlayerOnlyEnemy,abilities:[],protections:e,damages:s,maxHealthValue:1,regenerationRate:5,regenerationValue:1,resistances:[],visionRadius:5,moveSpeed:20,attackSpeed:20,bodyControl:5,leavesCorpseRatio:50,material:ut.flesh,throwingDamages:[]}),ri=()=>ii("Golem",[{type:ft.Solid,value:5}],[{type:fe.Blunt,dice:{times:1,max:5},extra:10}]),ai=(new xe([[100,()=>ii("Rat",[],[{type:fe.Melee,dice:{times:2,max:2},extra:0}])],[3,ri]]),new Map);ai.set("C",()=>new class extends x{}("C",f.Floor)),ai.set("W",()=>new W),ai.set("R",()=>new x("R",f.Floor)),ai.set("D",()=>new C);const ni="Traps",oi="2nd";class hi extends Ce{enter(t,e){(t.currentMap=t.getMap(ni)).addCreature(new n(3,27),e)}register(t){t.addMap(ni,(t,e)=>{let s=this.generateMap(t,["WWWWWWWWWWWWW","WWWWRRRWWWWWW","WWWWRRRWWWWWW","WWWWRRRWWWWWW","WWWWWCWWWWWWW","WRRRWCWRRRWWW","WRRRCCCRRRWWW","WRRRWCWRRRWWW","WWWWWCWWWWWWW","WRRRWCWRRRWWW","WRRRCCCRRRWWW","WRRRWCWRRRWWW","WWWWWCWWWWWWW","WRRRWCWRRRWWW","WRRRCCCRRRWWW","WRRRWCWRRRWWW","WWWWWCWWWWWWW","WRRRWCWRRRWWW","WRRRCCCRRRWWW","WRRRWCWRRRWWW","WWWWWCWWWWWWW","WRRRWCWRRRWWW","WRRRCCCRRRWWW","WRRRWCWRRRWWW","WWWWWCWWWWWWW","WWWWWCWRRRRRW","WRRRWCWRRRRRW","WRRRCCCRRRRRW","WRRRWCWRRRRRW","WWWWWCWRRRRRW","WWWWWWWWWWWWW"]);return s.setTile(5,2,new I(s,oi)),s.setTile(4,6,new P("Teleportation trap",!1,new T)),s.setTile(2,6,new hs(new T)),s.setTile(6,6,new P("Light trap",!1,new T)),s.setTile(8,6,new os(new T)),s.setTile(4,10,new P("Hole trap",!1,new T)),s.setTile(2,10,new ns(new T)),s.setTile(6,10,new P("Bare wire",!1,new T)),s.setTile(8,10,new rs(new T)),s.setTile(4,14,new P("Water trap",!1,new T)),s.setTile(2,14,new ls(new T)),s.setTile(6,14,new P("Falling rock trap",!1,new T)),s.setTile(8,14,new as(Zs,new T)),s.setTile(6,27,new P("Air blow trap",!1,new T)),s.setTile(9,27,new ss(new T)),s}),t.addMap(oi,(t,e)=>{let s=this.generateMap(t,["WWWWW","WRRRW","WRRRW","WRRRW","WWWWW"]);return s.setTile(2,1,new R(s,ni)),s.addCreature(new n(1,1),ri()),s})}generateMap(t,e){return new We(t,ge(e,ai))}}class li extends Ee{constructor(t){super(t,new Ys(t))}}const ci=120,ui=180,di={r:255,g:165,b:0};class pi extends Ds{lighted(t){return this}constructor(t,e=ci,s=ci,i=ci){super(t,e,s,i)}litBackground(t,e){return t.setBackground(di.r*e,di.g*e,di.b*e),t}litColor(t,e){return t.setColor(di.r*e,di.g*e,di.b*e),t}}class gi extends pi{constructor(t){super(t,ui,ui,ui)}}class mi extends gi{constructor(t,e,s,i){super(t),this.vr=e,this.vg=s,this.vb=i}lighted(t){let e=this.clone();return e.setColor(this.vr,this.vg,this.vb),e}}class fi extends pi{constructor(t,e,s,i){super(t),this.vr=e,this.vg=s,this.vb=i}lighted(t){let e=this.clone();return e.setColor(this.vr,this.vg,this.vb),e}}const vi=new fi("刀",200,200,200),wi=new fi("体",200,200,200),yi=new fi("胸",200,200,200),bi=new fi("石",200,200,200),xi=new fi("]",200,200,200),Ti=new fi("[",255,255,0),Ci=new fi("?",255,255,255),Wi=new fi("！",200,200,200),Mi=function(t){switch(t.group){case pt.OneHandWeapon:return vi;case pt.Consumable:return wi;case pt.BodyArmor:return yi;case pt.Missile:return bi;case pt.MissileWeapon:return xi;case pt.Potion:return Wi;case pt.Boots:return Ti;case pt.Scrolls:return Ci;default:return wi}},Ii=new class extends pi{constructor(){super("戸")}lighted(t){let e=this.clone();return this.litColor(e,t),e.swapColors(),e}},Ri=new class extends pi{constructor(){super("＃")}lighted(t){let e=this.clone();return this.litBackground(e,t),e.backgroundToColor(),e}},ki=new class extends pi{constructor(){super("・")}lighted(t){return this.litColor(this.clone(),t)}},Si=new class extends pi{constructor(){super("＞")}},Pi=new class extends pi{constructor(){super("＜")}},Ei=new pi("　",0,0,0),Oi=new pi("^",255,255,255),Ni=new pi("^",0,191,255),_i=new pi("^",255,255,0),Di=new pi("^",139,69,19),Ai=new pi("^",255,165,0),Bi=new pi("^",200,200,200),$i=new pi("^",0,0,205);const Hi=new class extends E{onWall(t){this.tile=Ri}onFloor(t){this.tile=ki}onStairwayDown(t){this.tile=Si}onStairwayUp(t){this.tile=Pi}onDoor(t){this.tile=Ii}onTrap(t){if(t.revealed)switch(t.type){case v.AirBlow:this.tile=Oi;break;case v.Teleportation:this.tile=Ni;break;case v.Light:this.tile=_i;break;case v.Hole:this.tile=Di;break;case v.BareWire:this.tile=Ai;break;case v.FallingRock:this.tile=Bi;break;case v.Water:this.tile=$i}else t.tile.visit(this)}onTrigger(t){t.tile.visit(this)}default(t){this.tile=Ei}},Fi=new mi("＠",0,255,0),Li=new mi("r",197,65,38),Gi=new mi("G",120,120,120),ji=new pi("　",0,0,0),Ui=[new fi("｜",200,200,200),new fi("／",200,200,200),new fi("ー",200,200,200),new fi("＼",200,200,200)];var qi=i.a.extend({props:["level","player","pos"],data:()=>({wholeMap:!1,term:null,eng:null,drawInterval:null,ts:Date.now(),interval:100,step:0}),methods:{getTile(t,e){const s=this.stage.at(t,e).effect,i=this.wholeMap?this.stage.at(t,e):this.stage.at(t,e).tile;if(!i)return ji;if(s){if(i.creature){let t=this.creatureTile(i.creature).clone();return t.setBackground(200,0,0),t}return new pi(s,200,200,0)}if(i.creature)return this.creatureTile(i.creature);if(i.items)switch(i.items.bunch.length){case 0:break;case 1:return Mi(i.items.bunch[0].item);default:const t=this.step%(3*this.animationFps+4);if(t<Ui.length)return Ui[t];{const t=Math.floor(this.step/(3*this.animationFps+4));return Mi(i.items.bunch[t%i.items.bunch.length].item)}}return function(t){return t.visit(Hi),Hi.tile}(i)},creatureTile:t=>"Rat"==t.name?Li:"Golem"==t.name?Gi:Fi,initViewport(){this.term=new class{constructor(t,e,s,i,r=!1){this.elem=t,this.w=e,this.h=s,this.squarify=r,this.cx=Math.floor(e/2),this.cy=Math.floor(s/2),this.elem.innerHTML="",-1===t.className.indexOf(As)&&(0===t.className.length?t.className=As:t.className+=" "+As),this.buffer=new Array(s);for(let t=0;t<s;++t){this.buffer[t]=new Array(e);for(let s=0;s<e;++s)this.buffer[t][s]=Bs}this.renderer=i(this)}updateStyle(t){const e=window.getComputedStyle(this.elem,null);this.defaultColor=e.color||void 0,this.defaultBackground=e.backgroundColor||void 0,t&&this.renderer.updateStyle(e)}getRendererString(){return this.renderer.getRendererString()}put(t,e,s){e<0||s<0||e>=this.w||s>=this.h||(this.buffer[s][e]=t)}unsafePut(t,e,s){this.buffer[s][e]=t}putString(t,e,s,i,r,a,n,o,h){const l=t.length;if(!(e<0||s<0))for(let c=0;c<l;++c){if(e>=this.w&&(e=0,++s),s>=this.h)return;const l=new Ds(t[c],i,r,a,n,o,h);this.unsafePut(l,e,s),++e}}get(t,e){return t<0||e<0||t>=this.w||e>=this.h?Bs:this.buffer[e][t]}clear(){for(let t=0;t<this.h;++t)for(let e=0;e<this.w;++e)this.buffer[t][e]=Bs;this.renderer.clear()}render(){this.renderer.render()}}(this.$refs.scene,Math.max(this.level.width,40),Math.max(this.level.height,40),Fs,!0),this.eng=new class{constructor(t,e,s,i){this.viewport=t,this.tileFunc=e,this.w=s,this.h=i,this.refreshCache=!0,this.cacheEnabled=!1,this.transitionDuration=0,this.cachex=0,this.cachey=0,this.tileCache=new Array(t.h),this.tileCache2=new Array(t.h);for(let e=0;e<t.h;++e)this.tileCache[e]=new Array(t.w),this.tileCache2[e]=new Array(t.w)}setTileFunc(t,e,s){e&&(this.transition=void 0,"string"==typeof e&&("boxin"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return t-=o,e-=h,Math.abs(t)<o*n&&Math.abs(e)<h*n?r:a}:"boxout"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return t-=o,e-=h,n=1-n,Math.abs(t)<o*n&&Math.abs(e)<h*n?a:r}:"circlein"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return(t-=o)*t+(e-=h)*e<(o*o+h*h)*n?r:a}:"circleout"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return(t-=o)*t+(e-=h)*e>(o*o+h*h)*(n=1-n)?r:a}:"random"===e&&(this.transition=function(t,e,s,i,r,a,n){return Math.random()>n?a:r})),this.transition&&(this.transitionTimer=(new Date).getTime(),this.transitionDuration=s||500)),this.tileFunc=t}setMaskFunc(t){this.maskFunc=t}setShaderFunc(t){this.shaderFunc=t}setWorldSize(t,e){this.w=t,this.h=e}setCacheEnabled(t){this.cacheEnabled=t,this.refreshCache=!0}update(t,e){t=t||0,e=e||0;const s=t-this.viewport.cx,i=e-this.viewport.cy,r=(new Date).getTime();let a,n;this.transition&&this.transitionTimer&&(a=(r-this.transitionTimer)/this.transitionDuration),a&&a>=1&&(this.transition=void 0);for(let t=0;t<this.viewport.h;++t)for(let e=0;e<this.viewport.w;++e){const o=e+s,h=t+i;if(this.w&&(o<0||o>=this.w))n=Bs;else if(this.h&&(h<0||h>=this.h))n=Bs;else if(this.maskFunc&&!this.maskFunc(o,h))n=Bs;else if(this.transition&&!this.refreshCache)n=this.transition(e,t,this.viewport.w,this.viewport.h,this.tileFunc(o,h),this.tileCache[t][e],a||0);else if(this.cacheEnabled&&!this.refreshCache){const t=o-this.cachex,e=h-this.cachey;t>=0&&t<this.viewport.w&&e>=0&&e<this.viewport.h?(n=this.tileCache[e][t])===Bs&&(n=this.tileFunc(o,h)):n=this.tileFunc(o,h)}else n=this.tileFunc(o,h);this.tileCache2[t][e]=n,this.shaderFunc&&n!==Bs&&(n=this.shaderFunc(n,o,h,r)),this.viewport.unsafePut(n,e,t)}this.cachex=s,this.cachey=i;const o=this.tileCache;this.tileCache=this.tileCache2,this.tileCache2=o,this.refreshCache=!1}}(this.term,(t,e)=>this.getTile(t,e),this.level.width,this.level.height),this.eng.setMaskFunc((t,e)=>this.wholeMap||this.stage.at(t,e).seen),this.eng.setShaderFunc((t,e,s,i)=>this.lighting(t,e,s,i)),clearInterval(this.drawInterval),this.drawInterval=setInterval(()=>{this.drawScene()},this.interval)},drawScene(){const t=Date.now();this.ts+1e3<t&&(this.ts=t),this.eng.update(this.pos.x,this.pos.y),this.term.render(),this.step+=1},lighting(t,e,s,i){if(this.wholeMap)return t.lighted(1);const r=this.stage.at(e,s);return r.visible&&t.lighted?t.lighted(r.degree):t}},computed:{stage(){return this.wholeMap?this.level:this.player.stageMemory(this.level)},animationFps(){return 1e3/this.interval},tileItems(){let t=this.stage.at(this.player.pos.x,this.player.pos.y).items();return t&&t.bunch}},mounted(){this.initViewport()},beforeDestroy(){clearInterval(this.drawInterval)},watch:{interval(){this.initViewport()},level(){clearInterval(this.drawInterval),this.initViewport()}}}),Vi=(s(47),Object(Os.a)(qi,function(){var t=this.$createElement;return(this._self._c||t)("div",{ref:"scene",staticClass:"unicodetiles"})},[],!1,null,null,null));Vi.options.__file="Scene.vue";var Yi=Vi.exports,zi=i.a.extend({name:"PrimaryAttribute",props:["name","slug","attr","fullName"],computed:{id(){return`${this.slug}-container`},modifier(){return Object(r.sum)(this.attr.modifiers)}}}),Xi=Object(Os.a)(zi,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"simple-popover",attrs:{id:t.id}},[s("div",{staticClass:"title"},[t._v(t._s(t.name))]),s("div",{staticClass:"value"},[t._v(t._s(t.attr.current))]),s("b-popover",{attrs:{target:t.id,triggers:"hover",container:t.id,placement:"top"}},[[s("big",{staticClass:"name"},[t._v(t._s(t.fullName))]),s("p",[s("span",{staticClass:"name"},[t._v("Базовый:")]),t._v(" "),s("span",{staticClass:"description"},[t._v(t._s(t.attr.current))])]),s("p",[s("span",{staticClass:"name"},[t._v("Модификатор:")]),t._v(" "),s("span",{staticClass:"description"},[t._v(t._s(t.modifier))])])]],2)],1)},[],!1,null,null,null);Xi.options.__file="PrimaryAttribute.vue";var Ji=Xi.exports;const Ki=function({extra:t,dice:{times:e,max:s},type:i}){let r=`${Qi(i)} ${e}d${s}`;return t&&(r+=`+${t}`),r},Qi=function(t){switch(t){case fe.Melee:return"Me";case fe.Pierce:return"Pi";case fe.Blunt:return"B";case fe.Magic:return"Mg";case fe.Pure:return"Pu";default:return"unknown damage type"}},Zi=function({type:t,value:e}){switch(t){case ft.Light:return`L${e}`;case ft.Medium:return`M${e}`;case ft.Heavy:return`H${e}`;case ft.Solid:return`S${e}`;case ft.Unarmored:return`U${e}`;default:return"unknown protection type"}};var tr=i.a.extend({name:"Stats",props:["creature","levelMap"],components:{PrimaryAttribute:Ji},computed:{levelProgress(){const t=this.creature.level;return`${t.currentExperience/t.requiredExperience*100}%`},healthLevel(){const t=this.creature.health;return`${t.currentValue/(t.maximum||0)*100}%`},protections(){return this.creature.protections.map(Zi).join(", ")},damages(){return this.creature.damages.map(Ki).join(", ")}},methods:{displayAttribute:t=>t.currentValue!=t.maximum?`${t.currentValue} / ${t.maximum}`:t.currentValue}}),er=(s(49),Object(Os.a)(tr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"panel container"},[s("div",{staticClass:"level cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.creature.level.current))]),s("div",{staticClass:"note"},[t._v("Уровень"),s("div",{staticClass:"progress"},[s("div",{staticClass:"progress-bar bg-success",style:{width:t.levelProgress},attrs:{role:"progressbar"}})])])]),s("div",{staticClass:"hp cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.displayAttribute(t.creature.health)))]),s("div",{staticClass:"bar",style:{height:t.healthLevel}})]),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"strength",name:"St","full-name":"Сила",attr:t.creature.strength}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"dexterity",name:"Dx","full-name":"Ловкость",attr:t.creature.dexterity}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"constitution",name:"Co","full-name":"Телосложение",attr:t.creature.constitution}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"intelligence",name:"In","full-name":"Интеллект",attr:t.creature.intelligence}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"wisdom",name:"Ws","full-name":"Мудрость",attr:t.creature.wisdom}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"charisma",name:"Ch","full-name":"Харизма",attr:t.creature.charisma}}),s("div",{staticClass:"cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.levelMap.name))])]),s("div",{staticClass:"cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.protections))])]),s("div",{staticClass:"cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.damages))])])],1)},[],!1,null,"20a5072e",null));er.options.__file="Stats.vue";var sr=er.exports,ir=i.a.extend({name:"Impacts",props:["impacts"],methods:{icon(t){switch(t){case m.Blind:return"blind";case m.Stressed:case m.Loaded:case m.Overloaded:return"weight"}},title(t){switch(t){case m.Blind:return"Слепота";case m.Stressed:return"Нагружен";case m.Loaded:return"Груженый";case m.Overloaded:return"Перегруженый"}}}}),rr=(s(51),Object(Os.a)(ir,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"panel"},t._l(t.impacts,function(e){return s("div",{staticClass:"impact-block"},[s("img",{staticClass:"icon",attrs:{src:"assets/impacts/"+t.icon(e)+".svg"}}),s("div",{staticClass:"title",domProps:{textContent:t._s(t.title(e))}})])}))},[],!1,null,"436b0ad3",null));rr.options.__file="Impacts.vue";var ar=rr.exports,nr=i.a.extend({name:"IdleView",props:["screen"],methods:{onEvent(t){switch(t.key){case"l":case"ArrowRight":return this.screen.move(c.right);case"h":case"ArrowLeft":return this.screen.move(c.left);case"k":case"ArrowUp":return this.screen.move(c.up);case"j":case"ArrowDown":return this.screen.move(c.down);case"y":return this.screen.move(c.upLeft);case"u":return this.screen.move(c.upRight);case"b":return this.screen.move(c.downLeft);case"n":return this.screen.move(c.downRight);case"H":return this.screen.handleCommand();case"L":return this.screen.lookCommand();case"s":case".":return this.screen.stayCommand();case"i":return this.screen.inventoryCommand();case"I":return this.screen.bagCommand();case"t":return this.screen.missileCommand();case",":return this.screen.pickUpCommand();case"d":return this.screen.dropCommand();case"D":return this.screen.drinkCommand();default:console.log("Key: ",t.key)}}}}),or=Object(Os.a)(nr,function(){var t=this.$createElement;return(this._self._c||t)("div")},[],!1,null,null,null);or.options.__file="IdleView.vue";var hr=or.exports,lr=i.a.extend({props:["screen"],data:()=>({picked:null}),methods:{close(t){const e=t||this.picked;e&&this.screen.pickProfession(e)},onEvent(t){switch(t.key){case"a":this.picked=this.screen.options[0];break;case"b":this.picked=this.screen.options[1];break;case" ":case"Enter":this.close();default:return}},iconPath:t=>"assets/professions/"+["acrobatic.svg","button-finger.svg","disintegrate.svg","flying-fox.svg","amputation.svg","catch.svg","divert.svg","fruiting.svg","annexation.svg","conversation.svg","dodging.svg","grab.svg","arrest.svg","convince.svg","drinking.svg","journey.svg","back-forth.svg","coronation.svg","drop-weapon.svg","juggler.svg","backstab.svg","crafting.svg","drowning.svg","jump-across.svg","boot-stomp.svg","crush.svg","eating.svg","kindle.svg","bowman.svg","discussion.svg","expander.svg","kneeling.svg"][t]}}),cr=(s(53),Object(Os.a)(lr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal text-center"},[s("div",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("div",{staticClass:"content"},t._l(t.screen.options,function(e){return s("div",{key:e.id,staticClass:"option p-2 m-3",class:{picked:t.picked&&t.picked.id===e.id},on:{click:function(s){t.picked=e},dblclick:function(s){t.close(e)}}},[s("img",{staticClass:"icon",attrs:{src:t.iconPath(e.id)}}),s("div",{staticClass:"name"},[t._v(t._s(e.name))])])})),s("div",{staticClass:"bottom"},[null!==t.picked?s("b-btn",{attrs:{variant:"success"},on:{click:t.close}},[t._v("Подтвердить")]):t._e()],1)])},[],!1,null,null,null));cr.options.__file="ProfessionPickingView.vue";var ur=cr.exports;var dr=i.a.extend({name:"Inventory",props:["screen"],data:()=>({page:0,perPage:20,selected:[]}),computed:{player(){return this.screen.player},carryingWeight(){return`Нагрузка ${Math.round(100*this.player.stuffWeight.current)/100} из ${this.player.carryingCapacity.stressed}`}},methods:{onEvent(t){switch(t.key){case"Escape":return this.screen.close();case"Enter":case" ":return this.screen.withItems(this.selected.map(t=>this.screen.positions[t]));default:return this.selectAt(t.key.charCodeAt(0)-97)}},selectAt(t){t>=0&&t<Math.min(this.perPage,this.screen.positions.length)&&(this.screen.singleItemMode?this.screen.withItem(this.screen.positions[t]):this.selected.indexOf(t)>=0?this.selected.splice(this.selected.indexOf(t),1):this.selected.push(t))},indexLetter:t=>String.fromCharCode(97+t),positionSelected(t){return this.selected.indexOf(t)>=0},positionStatus:t=>t.item?"text-success":"",itemWeight:t=>Math.round(t.item.weight*t.count*100)/100}}),pr=(s(55),Object(Os.a)(dr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("span",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("div",{staticClass:"subtitle my-3",domProps:{textContent:t._s(t.carryingWeight)}}),s("table",{staticClass:"container positions-list"},t._l(t.screen.positions,function(e,i){return s("tr",{key:i,class:t.positionStatus(e)},[s("td",{staticClass:"selected"},[t.positionSelected(i)?s("div",{staticClass:"sign"},[t._v("+")]):t._e()]),s("td",{staticClass:"letter"},[t._v(t._s(t.indexLetter(i)))]),s("td",{staticClass:"separator"},[t._v("—")]),s("td",{staticClass:"name"},[t._v(t._s(e.item.name)+" ("+t._s(e.count)+")")]),s("td",{staticClass:"weight"},[t._v("["+t._s(t.itemWeight(e))+"kg]")])])}))])},[],!1,null,null,null));pr.options.__file="ItemsListingView.vue";var gr=pr.exports;var mr=i.a.extend({props:["screen"],data:()=>({picked:null,professionIndex:0}),computed:{option(){return this.screen.options[this.professionIndex]},profession(){return this.option.profession},groupedTalents(){let t=new Array(5);for(let e=0;e<t.length;e++)t[e]=[];let e=0;return this.option.talents.forEach(s=>{s.status===we.Available&&Object.assign(s,{letter:String.fromCharCode(97+e++)}),t[s.depth].push(s)}),t}},methods:{close(t){const e=t||this.picked;e&&e.status===we.Available&&(this.screen.pickTalent(this.profession.id,e.id),this.picked=null)},pickTalent(t){t.status===we.Available&&(this.picked=t)},onEvent(t){switch(t.key){case" ":case"Enter":this.close();default:this.groupedTalents.forEach(e=>e.forEach(e=>{e.letter===t.key&&(this.picked=e)}));const e=parseInt(t.key);e>=1&&e<=this.screen.options.length&&(this.professionIndex=e-1)}},talentTip(t){let e=`${t.rank}/${t.maxRank}`;return t.rank>=t.maxRank?e:`${t.letter} ${e}`},talentStatus(t){if(this.picked&&this.picked.id===t.id)return"-selected";switch(t.status){case we.Available:return"-available";case we.Unavailable:return"-unavailable";case we.Completed:return"-completed"}},iconPath(t){switch(t){case Ls.AttackerTwoHandedWeapons:return"AttackerTwoHandedWeapons.svg";case Ls.AttackerHeavyWeapons:return"AttackerHeavyWeapons.svg";case Ls.AttackerLightWeapons:return"AttackerLightWeapons.svg";case Ls.AttackerTwoWeapons:return"AttackerTwoWeapons.svg";case Ls.AttackerDoubleTwoHandedWeapons:return"AttackerDoubleTwoHandedWeapons.svg";case Ls.AttackerStrongGrip:return"AttackerStrongGrip.svg"}}},watch:{professionIndex(){this.picked=null}}}),fr=(s(57),Object(Os.a)(mr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"simple-popover screen-modal text-center",attrs:{id:"talents-tree-container"}},[s("div",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("b-tabs",{staticClass:"tabs-list",attrs:{card:""},model:{value:t.professionIndex,callback:function(e){t.professionIndex=e},expression:"professionIndex"}},t._l(t.screen.player.professions,function(t){return s("b-tab",{key:t.id,attrs:{title:t.name,"no-body":""}})})),s("table",{staticClass:"content"},t._l(t.groupedTalents,function(e,i){return s("tr",{key:i},t._l(e,function(e,r){return s("td",{key:r,staticClass:"cell"},[s("div",{staticClass:"talent-cell",class:t.talentStatus(e),attrs:{id:r+"talentTree-"+i,variant:"primary"},on:{click:function(s){t.pickTalent(e)},dblclick:function(s){t.close(e)}}},[s("img",{staticClass:"icon",attrs:{src:"assets/talents/"+t.iconPath(e.id)}}),s("span",{staticClass:"level"},[t._v(t._s(t.talentTip(e)))]),s("b-popover",{attrs:{target:r+"talentTree-"+i,triggers:"hover",container:"talents-tree-container"}},[[s("p",{staticClass:"name"},[t._v(t._s(e.name))]),s("small",[s("p",{staticClass:"rank"},[t._v("Уровень "+t._s(e.rank)+"/"+t._s(e.maxRank))]),"-unavailable"===t.talentStatus(e)?s("p",{staticClass:"requirements"},[t._v("Требуется "+t._s(e.depth*t.profession.depthCost)+" очков в "+t._s(t.profession.name))]):t._e(),s("p",{staticClass:"description"},[t._v(t._s(e.description))])])]],2)],1)])}))})),null!==t.picked?s("b-btn",{attrs:{variant:"default"},on:{click:function(e){t.close()}}},[t._v("Подтвердить")]):t._e()],1)},[],!1,null,null,null));fr.options.__file="TalentsTreeView.vue";var vr=fr.exports;var wr=i.a.extend({name:"Inventory",props:["screen"],data:()=>({page:0,perPage:20}),computed:{player(){return this.screen.player},carryingWeight(){return`Нагрузка ${Math.round(100*this.player.stuffWeight.current)/100} из ${this.player.carryingCapacity.stressed}`}},methods:{onEvent(t){switch(t.key){case" ":case"Escape":return this.screen.close();default:return this.selectAt(t.key.charCodeAt(0)-97)}},selectAt(t){if(t>=0&&t<Math.min(this.perPage,this.screen.positions.length)){const e=this.screen.positions[t];e.item?this.screen.takeOff(e):e.availableItems.length&&this.screen.putOn(e)}},positionDetails(t){if(t.item&&t.item.canSeeDetails)return function(t){return t instanceof Bt?t.damages.map(Ki).join(","):t instanceof Lt?t.protections.map(Zi).join(","):void 0}(t.item)},indexLetter:t=>String.fromCharCode(97+t),positionStatus:t=>t.item?"text-success":"",displayBodyPart:t=>t.name,displayItem(t){if(t)return`${Mi(t).getChar()} ${t.name}`},itemName:t=>t.item&&t.count?`${t.item.name} ${t.count>1?`(${t.count})`:""}`:"-",itemWeight(t){if(t.item&&t.count)return`[${t.item.weight*t.count}kg]`},available:t=>t.item||t.availableItems.length,availableStatus(t){return this.available(t)?"-available":"-unavailable"}}}),yr=(s(59),Object(Os.a)(wr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("div",{staticClass:"h4 title"},[t._v("Инвентарь")]),s("div",{staticClass:"subtitle my-3",domProps:{textContent:t._s(t.carryingWeight)}}),s("table",{staticClass:"content inventory-list"},t._l(t.screen.positions,function(e,i){return s("tr",{key:i,class:t.availableStatus(e)},[s("td",{staticClass:"slot"},[s("span",{staticClass:"letter"},[t._v(t._s(t.indexLetter(i)))]),s("span",{staticClass:"dash"},[t._v("—")]),s("span",{staticClass:"part"},[t._v(t._s(t.displayBodyPart(e.inventorySlot)))]),s("span",{staticClass:"separator"},[t._v(":")])]),s("td",{staticClass:"name-slot"},[s("span",{staticClass:"name",class:t.positionStatus(e)},[t._v(t._s(t.itemName(e)))]),s("small",{staticClass:"details",domProps:{textContent:t._s(t.positionDetails(e))}})]),s("td",{staticClass:"weight"},[t._v(t._s(t.itemWeight(e)))])])}))])},[],!1,null,null,null));yr.options.__file="InventoryView.vue";var br=yr.exports,xr=i.a.extend({name:"PickPointView",props:["screen"],computed:{title(){switch(this.screen.title){case ye.See:return"Вижу ...";case ye.Recall:return"Вспоминаю ...";case ye.Hidden:return"Без понятия ...";default:return this.screen.title}}},methods:{close(t){this.screen.onInput(t)},onEvent(t){switch(t.key){case"l":case"ArrowRight":return this.screen.moveTarget(c.right);case"h":case"ArrowLeft":return this.screen.moveTarget(c.left);case"k":case"ArrowUp":return this.screen.moveTarget(c.up);case"j":case"ArrowDown":return this.screen.moveTarget(c.down);case"y":return this.screen.moveTarget(c.upLeft);case"u":return this.screen.moveTarget(c.upRight);case"b":return this.screen.moveTarget(c.downLeft);case"n":return this.screen.moveTarget(c.downRight);case"Escape":case" ":this.screen.close()}}}}),Tr=(s(61),Object(Os.a)(xr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"look-modal"},[s("div",{staticClass:"title",domProps:{textContent:t._s(t.title)}}),t._l(t.screen.body,function(e){return s("div",{domProps:{textContent:t._s(e)}})})],2)},[],!1,null,"7db82404",null));Tr.options.__file="PickPointView.vue";var Cr=Tr.exports,Wr=i.a.extend({name:"MissileView",props:["screen"],methods:{close(t){this.screen.onInput(t)},onEvent(t){switch(t.key){case"l":case"ArrowRight":return this.screen.moveTarget(c.right);case"h":case"ArrowLeft":return this.screen.moveTarget(c.left);case"k":case"ArrowUp":return this.screen.moveTarget(c.up);case"j":case"ArrowDown":return this.screen.moveTarget(c.down);case"y":return this.screen.moveTarget(c.upLeft);case"u":return this.screen.moveTarget(c.upRight);case"b":return this.screen.moveTarget(c.downLeft);case"n":return this.screen.moveTarget(c.downRight);case">":this.screen.nextTarget();break;case"<":this.screen.previousTarget();break;case"t":this.screen.attack();break;case"Escape":this.screen.close()}}}}),Mr=Object(Os.a)(Wr,function(){var t=this.$createElement;return(this._self._c||t)("div")},[],!1,null,null,null);Mr.options.__file="MissileView.vue";var Ir=Mr.exports,Rr=i.a.extend({name:"DeathView",props:["screen"],computed:{message(){switch(this.screen.dieReason){case vt.Attack:return"Смерть в бою честь для героя. Но жить мне все-таки нравилось больше";case vt.Missile:return"Раньше меня вела дорога приключений, но теперь и мне прострелили колено";case vt.Trap:return"Я так и не научился смотреть под ноги";case vt.Overloaded:return"Тяжко уйти от бремени, которое сам себе навязываешь.";default:return"Скучная смерть, которая даже не заслужила отдельного сообщения"}},signature(){return`Признался ${this.screen.playerName} перед смертью`}},methods:{onEvent(t){}}}),kr=(s(63),Object(Os.a)(Rr,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"screen-modal"},[e("div",{staticClass:"h4 title"},[this._v("Ты умер")]),e("div",{staticClass:"content mt-5"},[e("blockquote",{staticClass:"blockquote text-center signature"},[e("p",{staticClass:"mb-0",domProps:{textContent:this._s(this.message)}}),e("footer",{staticClass:"blockquote-footer",domProps:{textContent:this._s(this.signature)}})])])])},[],!1,null,null,null));kr.options.__file="DeathView.vue";var Sr=kr.exports;var Pr=i.a.extend({name:"PickSingleOptionView",props:["screen"],data:()=>({page:0,perPage:20,selected:[]}),computed:{title(){switch(this.screen.type){case ht.PickHandleOption:return"С чем взаимодействовать?"}}},methods:{optionName(t){switch(this.screen.type){case ht.PickHandleOption:return t[0]}},onEvent(t){switch(t.key){case"Escape":return this.screen.close();case"Enter":case" ":return this.screen.pickUpItems(this.selected.map(t=>this.screen.positions[t]));default:return this.selectAt(t.key.charCodeAt(0)-97)}},selectAt(t){t>=0&&t<Math.min(this.perPage,this.screen.options.length)&&this.screen.pick(this.screen.options[t])},indexLetter:t=>String.fromCharCode(97+t)}}),Er=(s(65),Object(Os.a)(Pr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("span",{staticClass:"title",domProps:{textContent:t._s(t.title)}}),s("table",{staticClass:"container options-list"},t._l(t.screen.options,function(e,i){return s("tr",{key:i},[s("td",{staticClass:"letter"},[t._v(t._s(t.indexLetter(i)))]),s("td",{staticClass:"separator"},[t._v("—")]),s("td",{staticClass:"name",domProps:{textContent:t._s(t.optionName(e))}})])}))])},[],!1,null,"08d3fe9c",null));Er.options.__file="PickSingleOptionView.vue";var Or=Er.exports,Nr=s(19),_r=i.a.extend({data:()=>({game:(new class{constructor(){this.game=new li(this.initPlayer());const t=new hi;t.register(this.game),t.enter(this.game,this.game.player);const e=this.game.player,s=this.game.professionPicker.available(e)[1];s&&e.professions.push(s);const i=new Ft("Кинжал",.8,ut.iron,[{type:fe.Melee,dice:{times:1,max:3},extra:2}]),r=new Ft("Катана",1,ut.iron,[{type:fe.Melee,dice:{times:5,max:2},extra:0}]),a=new Gt("Латы",1,ut.iron,[{type:ft.Heavy,value:5}]),n=new Ut("Свиток ххх"),o=ti(),h=ei(),l=Zs(),c=Qs();if(this.game.currentMap){const t=this.game.currentMap.creatureTile(e);t.addItem(i,2),t.addItem(r,1),t.addItem(a,1),t.addItem(o,5),t.addItem(h,5),t.addItem(l,5),t.addItem(c,2),t.addItem(n,20),e.on(new ie(t,[{item:i,count:2},{item:r,count:1},{item:a,count:1},{item:o,count:5},{item:h,count:5},{item:l,count:5},{item:c,count:2},{item:n,count:20}],this.game)),e.on(new re(e.inventory.missileWeaponSlot,c,this.game)),e.on(new re(e.inventory.missileSlot,o,this.game)),e.on(new re(e.inventory.rightHandSlot,r,this.game)),e.on(new re(e.inventory.chestSlot,a,this.game)),e.addItem(new si,1),this.game.logger.reset()}}initPlayer(){return new Qe(new be([1,3,5,10,20]),new Ct,{name:"Player",weight:80,clan:H.Player,abilities:L,protections:[],damages:[],maxHealthValue:10,regenerationRate:30,regenerationValue:1,resistances:[],visionRadius:10,moveSpeed:20,attackSpeed:20,bodyControl:5,leavesCorpseRatio:0,material:ut.flesh,throwingDamages:[]},12,12,15)}}).game,ts:Date.now(),loopIntervalId:void 0}),components:{Impacts:ar,Logger:_s,Scene:Yi,Stats:sr},computed:{viewComponent(){if(this.game.playerTurn&&this.game.player.ai.presenter)switch(this.game.player.ai.presenter.type){case ht.AbilitiesPicking:return vr;case ht.ProfessionPicking:return ur;case ht.Idle:return hr;case ht.ItemsListing:return gr;case ht.Inventory:return br;case ht.Missile:return Ir;case ht.Teleportation:case ht.Look:return Cr;case ht.Death:return Sr;case ht.PickHandleOption:return Or;default:throw`App: unknown presenter ${this.game.player.ai.presenter}`}}},methods:{loop(){this.game.turn()},onEvent(t){const e=this.$refs.viewComponent;e&&e.onEvent(t)}},created(){this.loopIntervalId=Object(Nr.setInterval)(this.loop,10),document.addEventListener("keydown",this.onEvent)},beforeDestroy(){Object(Nr.clearInterval)(this.loopIntervalId),document.removeEventListener("keydown",this.onEvent)}}),Dr=(s(67),Object(Os.a)(_r,function(){var t=this,e=t.$createElement,s=t._self._c||e;return t.game?s("div",{staticClass:"container-fluid",attrs:{id:"app"}},[t.game.player?s("Scene",{staticClass:"scene",attrs:{level:t.game.currentMap,player:t.game.player,pos:t.game.currentMap.creaturePos(t.game.player)}}):t._e(),t.game.player?s("Stats",{staticClass:"player-stats",attrs:{creature:t.game.player,"level-map":t.game.currentMap}}):t._e(),s("Logger",{staticClass:"logger-panel",attrs:{logger:t.game.logger}}),s("Impacts",{staticClass:"effect-panel",attrs:{impacts:t.game.player.impacts}}),t.game.playerTurn?s(t.viewComponent,{ref:"viewComponent",tag:"component",attrs:{screen:t.game.player.ai.presenter}}):t._e()],1):t._e()},[],!1,null,null,null));Dr.options.__file="App.vue";var Ar=Dr.exports,Br=s(28);s(77),s(79),s(81);i.a.use(Br.a),new i.a({el:"#app",render:t=>t(Ar)})}]);
//# sourceMappingURL=main.122b88c2.js.map
!function(t){function e(e){for(var i,n,o=e[0],h=e[1],c=e[2],u=0,d=[];u<o.length;u++)n=o[u],r[n]&&d.push(r[n][0]),r[n]=0;for(i in h)Object.prototype.hasOwnProperty.call(h,i)&&(t[i]=h[i]);for(l&&l(e);d.length;)d.shift()();return a.push.apply(a,c||[]),s()}function s(){for(var t,e=0;e<a.length;e++){for(var s=a[e],i=!0,o=1;o<s.length;o++){var h=s[o];0!==r[h]&&(i=!1)}i&&(a.splice(e--,1),t=n(n.s=s[0]))}return t}var i={},r={0:0},a=[];function n(e){if(i[e])return i[e].exports;var s=i[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=i,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(s,i,function(e){return t[e]}.bind(null,i));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/onisun/";var o=window.webpackJsonp=window.webpackJsonp||[],h=o.push.bind(o);o.push=e,o=o.slice();for(var c=0;c<o.length;c++)e(o[c]);var l=h;a.push([29,1]),s()}([,,,,,,,function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},,,,,,,,,,,function(t,e,s){t.exports=s(83)},,,,,,,,,,,,,,,,function(t,e,s){"use strict";var i=s(7);s.n(i).a},,function(t,e,s){"use strict";var i=s(8);s.n(i).a},,function(t,e,s){"use strict";var i=s(9);s.n(i).a},,function(t,e,s){"use strict";var i=s(10);s.n(i).a},,function(t,e,s){"use strict";var i=s(11);s.n(i).a},,function(t,e,s){"use strict";var i=s(12);s.n(i).a},,function(t,e,s){"use strict";var i=s(13);s.n(i).a},,function(t,e,s){"use strict";var i=s(14);s.n(i).a},,function(t,e,s){"use strict";var i=s(15);s.n(i).a},,function(t,e,s){"use strict";var i=s(16);s.n(i).a},,function(t,e,s){"use strict";var i=s(17);s.n(i).a},,function(t,e,s){"use strict";var i=s(18);s.n(i).a},,,,,,,,,,function(t,e,s){},,,,,,function(t,e,s){"use strict";s.r(e);var i=s(1),r=s(0);const a=function(t){return String.fromCharCode(t.charCodeAt(0)+1)},n=function(t,e,s){let i=Array(t);for(let r=0;r<t;r++){i[r]=new Array(e);for(let t=0;t<e;t++)i[r][t]=s(r,t)}return i};class o{constructor(t,e){this.x=t,this.y=e}eq(t){return this.x===t.x&&this.y===t.y}nextTo(t){return Math.abs(this.x-t.x)<=1&&Math.abs(this.y-t.y)<=1}copy(){return new o(this.x,this.y)}add(t){return new o(this.x+t.x,this.y+t.y)}wrappers(){return o.dxy.map(t=>this.add(t))}}o.dxy=[new o(-1,-1),new o(0,-1),new o(1,-1),new o(-1,0),new o(1,0),new o(-1,1),new o(0,1),new o(1,1)];class h{constructor(t){this.map=t,this.width=t.length,this.height=t[0].length}at(t,e){return this.map[t][e]}inRange(t){return t.x>=0&&t.y>=0&&t.x<this.width&&t.y<this.height}each(t){this.map.forEach((e,s)=>{e.forEach((e,i)=>{t(e,s,i)})})}}const c=function(t,e,s){let[i,r,a,n]=[t.x,e.x,t.y,e.y],h=Math.max(Math.abs(i-r),Math.abs(a-n));const c=new o((r-i)/h,(n-a)/h);for(;h>1;)i+=c.x,a+=c.y,s(Math.round(i),Math.round(a)),h-=1},l=function(t,e,s){c(t,e,s),s(e.x,e.y)};class u extends o{constructor(t,e){super(t,e)}}u.up=new u(0,-1),u.down=new u(0,1),u.left=new u(-1,0),u.right=new u(1,0),u.upLeft=new u(-1,-1),u.upRight=new u(1,-1),u.downLeft=new u(-1,1),u.downRight=new u(1,1);class d{affectPlayer(t){return this.affectCreature(t)}}class p extends d{affectCreature(t){return j.NOTHING}}class m extends p{constructor(t,e){super(),this.levelMap=t,this.game=e}affectPlayer(t){return t.removeImpact(f.Overloaded,"bag"),t.removeImpact(f.Stressed,"bag"),t.removeImpact(f.Loaded,"bag"),t.stuffWeight.current>t.carryingCapacity.flattenedStart?t.on(new Gt(this.game,this.levelMap,Tt.Overloaded)):(t.stuffWeight.current>t.carryingCapacity.overloadedStart?t.addImpact(f.Overloaded,"bag"):t.stuffWeight.current>t.carryingCapacity.loadedStart?t.addImpact(f.Loaded,"bag"):t.stuffWeight.current>t.carryingCapacity.stressed&&t.addImpact(f.Stressed,"bag"),j.NOTHING)}}class g{constructor(){this.bunch=[]}find(t){return this.bunch.find(e=>e.item.groupsWith(t))}remove(t,e){const s=this.find(t);void 0!==s&&(s.count===e?Object(r.remove)(this.bunch,t=>t.item.groupsWith(s.item)):s.count-=e)}put(t,e){const s=this.bunch.find(e=>e.item.groupsWith(t));s?s.count+=e:this.bunch.push({count:e,item:t})}clone(){let t=new g;return this.bunch.forEach(e=>{t.put(e.item,e.count)}),t}}var f,v,w;!function(t){t[t.Blind=0]="Blind",t[t.Stressed=1]="Stressed",t[t.Loaded=2]="Loaded",t[t.Overloaded=3]="Overloaded"}(f||(f={}));class b{constructor(){this.constEffects=[],this.tempEffects=0}addTempEffect(t){this.tempEffects+=t}addConstEffect(t){this.constEffects.push(t)}removeTempEffect(){this.tempEffects=0}removeConstEffect(t){Object(r.remove)(this.constEffects,e=>e===t)}active(){return this.tempEffects>0||this.constEffects.length>0}turn(){this.tempEffects>=1&&(this.tempEffects-=1)}}class y{constructor(){this.impacts=new Map}get activeImpacts(){let t=[];return this.impacts.forEach((e,s)=>{e.active()&&t.push(s)}),t}addImpact(t,e){this.impactByType(t).addTempEffect(e)}removeImpact(t){this.impactByType(t).removeTempEffect()}addConstImpact(t,e){this.impactByType(t).addConstEffect(e)}removeConstImpact(t,e){this.impactByType(t).removeConstEffect(e)}turn(){this.impacts.forEach(t=>t.turn())}impactByType(t){let e=this.impacts.get(t);return void 0!==e?e:(e=new b,this.impacts.set(t,e),e)}}!function(t){t[t.Wall=0]="Wall",t[t.Door=1]="Door",t[t.Floor=2]="Floor",t[t.StairwayDown=3]="StairwayDown",t[t.StairwayUp=4]="StairwayUp",t[t.Trap=5]="Trap",t[t.Trigger=6]="Trigger"}(v||(v={}));class x{constructor(t,e){this.key=t,this.kind=e}addItem(t,e){this.items||(this.items=new g),this.items.put(t,e)}isFloor(){return this.kind===v.Floor}visibleThrough(){return!0}passibleThrough(t){return t&&this.creature?this.kind!==v.Wall&&this.creature.id===t.id:this.kind!==v.Wall&&!this.creature}clone(){let t=this.buildNew();return this.creature&&(t.creature=this.creature),t.items=this.items&&this.items.clone(),t}}class C extends x{visibleThrough(){return!0}visit(t){t.onFloor(this)}buildNew(){return new C(this.key,this.kind)}}class T extends C{constructor(){super("R",v.Floor)}}class M extends x{constructor(){super("D",v.Door)}visibleThrough(){return!1}visit(t){t.onDoor(this)}buildNew(){return new M}}class I extends x{constructor(){super("W",v.Wall)}visibleThrough(){return!1}visit(t){t.onWall(this)}buildNew(){return new I}}class k extends x{constructor(t,e,s,i){super(t,e),this.currentMap=s,this.adjacentMapId=i}visibleThrough(){return!0}}class W extends k{constructor(t,e){super(">",v.StairwayDown,t,e)}visit(t){t.onStairwayDown(this)}buildNew(){return new W(this.currentMap,this.adjacentMapId)}}class R extends k{constructor(t,e){super("<",v.StairwayUp,t,e)}visit(t){t.onStairwayUp(this)}buildNew(){return new R(this.currentMap,this.adjacentMapId)}}!function(t){t[t.Teleportation=0]="Teleportation",t[t.Light=1]="Light"}(w||(w={}));class P extends x{constructor(t=!1,e){super("^",v.Trap),this.revealed=t,this.type=e}visit(t){t.onTrap(this)}activate(t,e,s){this.affect(t,e,s)}}class S extends x{constructor(t=!0,e){super("T",v.Trigger),this.singleUse=t,this.tile=e}visit(t){t.onTrigger(this)}activate(t,e,s){if(this.singleUse){const{x:t,y:i}=e.creaturePos(s),r=this.clone();r.creature=s,e.setTile(t,i,r)}this.onTrigger(t,e,s)}buildNew(){return this.tile.clone()}}class E extends S{constructor(t,e=!0,s){super(e,s),this.message=t}onTrigger(t){t.logger.info(this.message)}}class _{onWall(t){this.default(t)}onFloor(t){this.default(t)}onStairwayDown(t){this.onStairway(t)}onStairwayUp(t){this.onStairway(t)}onDoor(t){this.default(t)}onTrigger(t){this.default(t)}onTrap(t){this.default(t)}onStairway(t){this.default(t)}default(t){}}const O=function(t,e,s,i){new class{constructor(t,e,s,i,r,a,n){this.startx=t,this.starty=e,this.radius=s,this.width=i,this.height=r,this.solidChecker=a,this.markVisible=n,this.doubleRadius=this.radius*this.radius}calc(){this.markVisible(this.startx,this.starty,1),this.solidChecker.isSolid(this.startx,this.starty)||[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([t,e])=>{this.castLight(1,1,0,0,t,e,0),this.castLight(1,1,0,t,0,0,e)})}castLight(t,e,s,i,r,a,n){if(e<s)return;let o=0,h=!1;for(let c=t;c<=this.radius&&!h;c++){let t=-c;for(let l=-c;l<=0;l++){let u=Math.round(this.startx+l*i+t*r),d=Math.round(this.starty+l*a+t*n),p=(l-.5)/(t+.5),m=(l+.5)/(t-.5);if(u>=0&&d>=0&&u<this.width&&d<this.height&&!(e<m)){if(s>p)break;this.doubleDistance(l,t)<=this.doubleRadius&&this.markVisible(u,d,1-this.doubleDistance(l,t)/this.doubleRadius),h?this.solidChecker.isSolid(u,d)?o=m:(h=!1,e=o):this.solidChecker.isSolid(u,d)&&c<this.radius&&(h=!0,this.castLight(c+1,e,p,i,r,a,n),o=m)}}}}doubleDistance(t,e){return t*t+e*e}}(t.x,t.y,e,i.width,i.height,new class extends _{constructor(t,e){super(),this.stage=t,this.pos=e,this.visible=!1}isSolid(t,e){return this.x=t,this.y=e,this.stage.at(t,e).visit(this),!this.visible}onDoor(t){this.visible=this.pos.x===this.x&&this.pos.y===this.y}default(t){this.x&&this.y&&(this.visible=this.stage.visibleThrough(this.x,this.y))}}(i,t),(t,e,r)=>{s.at(t,e).see(i.at(t,e),r)}).calc()};class A{constructor(t,e=t){this.max=t,this.current=e,this.modifiers=[]}get maximum(){return this.max}get atMax(){return this.max===this.current}decrease(t){this.current-=t}increase(t){this.current=Math.min(this.current+t,this.max)}constantIncrease(t){this.max+=t,this.increase(t)}constantDecrease(t){this.max-=t,this.decrease(t)}addModifier(t){this.modifiers.push(t)}removeModifier(t){Object(r.remove)(this.modifiers,e=>e===t)}get currentValue(){return this.current+Object(r.sum)(this.modifiers)}}class D{constructor(t,e,s){this.attack=t,this.defense=e,this.dexterity=s}with(t,e){e(this.attack,t.attack),e(this.defense,t.defense)}}class N extends D{constructor({attack:t=0,defense:e=0,dexterity:s=0}){super(t,e,s)}withWeight(t,e,s){s(this.attack,t.attack,e.attack),s(this.defense,t.defense,e.defense)}}class ${constructor(t,e=1,s=0){this.base=t,this.rate=e,this.extra=s}get current(){return this.base*this.rate-this.extra}add(t){this.base+=t}subtract(t){this.base-=t}}class B{constructor(t,e){this.strength=t,this.constitution=e,this.strengthRatio=5,this.constitutionRatio=3,this.base=10}recalculate(t,e){this.strength=t,this.constitution=e}get stressed(){return this.base+this.strength*this.strengthRatio+this.constitution*this.constitutionRatio}get loadedStart(){return 1.5*this.stressed}get overloadedStart(){return 2*this.loadedStart}get flattenedStart(){return 3*this.overloadedStart}}class L extends A{constructor(t,e=0,s=t.maxHealthValue){super(t.maxHealthValue,s),this.currentTurn=e,this.regenerationRate=t.regenerationRate,this.regenerationValue=t.regenerationValue}turn(){this.currentTurn+=1,this.currentTurn>=this.regenerationRate&&(this.currentTurn=0,this.increase(this.regenerationValue))}}class H extends ${get meleeAdjustment(){return this.current<5?-2:this.current>10?Math.floor((this.current-10)/2):0}}var F,G;!function(t){t[t.Player=0]="Player",t[t.PlayerOnlyEnemy=1]="PlayerOnlyEnemy",t[t.FreeForAll=2]="FreeForAll"}(F||(F={})),function(t){t[t.GoStairwayDown=0]="GoStairwayDown",t[t.Inventory=1]="Inventory",t[t.PutOn=2]="PutOn",t[t.Throwing=3]="Throwing"}(G||(G={}));const U=[G.GoStairwayDown,G.Inventory,G.PutOn,G.Throwing];var j;!function(t){t[t.DIE=0]="DIE",t[t.HURT=1]="HURT",t[t.DODGE=2]="DODGE",t[t.THROW_DODGE=3]="THROW_DODGE",t[t.NOTHING=4]="NOTHING",t[t.RESIST=5]="RESIST"}(j||(j={}));class V{constructor(t,e=V.getId()){this.specie=t,this.id=e,this.stageMemories=new Map,this.dead=!1,this.health=new L(t)}static getId(){return this.lastId++}get name(){return this.specie.name}get clan(){return this.specie.clan}get protections(){return this.specie.protections}get damages(){return this.specie.damages}can(t){return Object(r.includes)(this.specie.abilities,t)}on(t){return t.affectCreature(this)}get speed(){return this.specie.moveSpeed}stageMemory(t){const e=this.stageMemories.get(t.id);return e||this.visionMask(t)}visionMask(t){let e=this.stageMemories.get(t.id);return e?e.resetVisible():(e=new Le(t.width,t.height),this.stageMemories.set(t.id,e)),O(t.creaturePos(this),this.visionRadius,e,t),e}get impactsBunch(){return this._impactsBunch||(this._impactsBunch=new y),this._impactsBunch}hasImpact(t){return Object(r.includes)(this.impacts,t)}addImpact(t,e){this.impactsBunch.addConstImpact(t,e)}removeImpact(t,e){this.impactsBunch.removeConstImpact(t,e)}get visionRadius(){return this.hasImpact(f.Blind)?0:this.specie.visionRadius}get bodyControl(){return this.specie.bodyControl}get impacts(){return this.impactsBunch.activeImpacts}hasResistance(t){return Object(r.includes)(this.resistances,t)}get resistances(){return this.specie.resistances}statsTurn(){this.health.turn(),this._impactsBunch&&this._impactsBunch.turn()}}V.lastId=0;class q extends _{constructor(t,e,s){super(),this.creature=t,this.levelMap=e,this.game=s}onTrap(t){t.activate(this.game,this.levelMap,this.creature)}onTrigger(t){t.activate(this.game,this.levelMap,this.creature)}}class Y extends d{constructor(t,e,s,i){super(),this.game=t,this.levelMap=e,this.nextPoint=s,this.nextLevel=i}affectCreature(t){const e=this.levelMap.creaturePos(t);return this.nextLevel&&this.nextLevel.id!==this.levelMap.id?(this.levelMap.removeCreature(t),this.nextLevel.addCreature(this.nextPoint,t)):(this.levelMap.at(e.x,e.y).creature=void 0,this.levelMap.at(this.nextPoint.x,this.nextPoint.y).creature=t),(this.nextLevel||this.levelMap).at(this.nextPoint.x,this.nextPoint.y).visit(new q(t,this.levelMap,this.game)),j.NOTHING}affectPlayer(t){return this.nextLevel&&this.levelMap.id!==this.nextLevel.id?(this.levelMap.reset(),this.nextLevel.enter(),this.affectCreature(t),this.game.currentMap=this.nextLevel):this.affectCreature(t),j.NOTHING}}class z{moveTo(t,e,s,i){return this.move(t,s,i,t=>e.eq(t))}move(t,e,s,i){const[r]=this.buildPath(t,e,i);if(r)return new Y(s,e,r)}buildPath(t,e,s){return cs(t.stageMemory(e),e.creaturePos(t),e=>e.tangible(t),s)}withinView(t,e,s){let i=n(t.width,t.height,()=>!1),r=[e];for(;r.length;){let e=[];r.forEach(r=>{if(!t.inRange(r))return;const a=t.at(r.x,r.y);a.visible&&!i[r.x][r.y]&&(i[r.x][r.y]=!0,s(r,a),r.wrappers().forEach(t=>e.push(t)))}),r=e}}enemies(t,e){return t.id!==e.id&&(t.clan===F.FreeForAll||e.clan===F.FreeForAll||(t.clan===F.Player&&e.clan===F.PlayerOnlyEnemy||e.clan===F.Player&&t.clan===F.PlayerOnlyEnemy))}}class X extends z{constructor(){super(...arguments),this.destination=void 0}act(t,e,s){if(!this.foundNewTarget(t,e)||!this.destination)return this.checkCurrentTile(t,e,s);const i=this.goTo(t,e,s,this.destination);if(i)return i;this.destination=void 0,this.onCantMove(t)}goTo(t,e,s,i){return this.moveTo(t,i,e,s)}checkCurrentTile(t,e,s){if(this.destination&&e.creaturePos(t).eq(this.destination))return this.destination=void 0,this.onReach(t,e,s)}onMove(t){}onReach(t,e,s){}onCantMove(t){}}class J extends X{constructor(t){super(),this.matcher=t}checkCurrentTile(t,e,s){let i=super.checkCurrentTile(t,e,s);if(i)return i;const r=e.creaturePos(t);return this.matcher(t.stageMemory(e).at(r.x,r.y))?(this.destination=void 0,this.onReach(t,e,s)):void 0}foundNewTarget(t,e){const s=cs(t.stageMemory(e),e.creaturePos(t),e=>e.tangible(t),(t,e)=>this.matcher(e),!0);return!!s.length&&(this.destination=s.pop(),!0)}}class K extends z{act(t,e,s,i=!0){if(this.canAttack(t,e)){if(this.victim&&this.victimInAccess(t,e,this.victim))return new jt(this.victim,e,s);if(!i)throw"Attacker got called twice";return this.pickNewVictim(t,e),this.act(t,e,s,!1)}}canAttack(t,e){return!!this.findCreature(t,e,e=>this.enemies(t,e))}victimInAccess(t,e,s){if(void 0===s)return!1;return!!this.findCreature(t,e,t=>t.id===s.id)}pickNewVictim(t,e){this.victim=this.findCreature(t,e,e=>this.enemies(t,e))}findCreature(t,e,s){const i=t.stageMemory(e);return e.creaturePos(t).wrappers().map(({x:t,y:e})=>i.at(t,e).creature).find(t=>!!t&&s(t))}}class Q extends X{foundNewTarget(t,e){return this.victimSet()&&this.buildVictimPath(t,e)||this.foundNewVictim(t,e)}onCantMove(){this.victimId=void 0}onReach(){this.victimId=void 0}victimSet(){return!!this.victimId}goTo(t,e,s){if(!this.destination)throw"Chaser.goTo: no destination";return this.followTo(t,this.destination,e,s)}buildVictimPath(t,e){return this.findCreature(t,e,t=>t.id===this.victimId)}foundNewVictim(t,e){return this.findCreature(t,e,e=>this.enemies(t,e))&&this.buildVictimPath(t,e)}findCreature(t,e,s){let i=!1;return this.withinView(t.stageMemory(e),e.creaturePos(t),({x:t,y:e},r)=>{const a=r.creature;!i&&a&&s(a)&&(this.destination=new o(t,e),this.victimId=a.id,i=!0)}),i}followTo(t,e,s,i){return this.move(t,s,i,t=>e.nextTo(t))}}class Z{constructor(t){this.game=t,this.player=t.player,this.logger=t.logger}}class tt extends Z{constructor(t,e){super(e),this.items=t}run(){}immediate(){return!1}}class et extends z{constructor(t){super(),this.aiToRun=t,this.events=[]}pushEvent(t){this.events.push(t)}resetEvents(){this.events=[]}runEvents(){this.events.forEach(t=>{t.run()}),this.resetEvents()}}const st=2;class it extends X{constructor(){super(...arguments),this.escapesFrom=[]}foundNewTarget(t,e){return this.foundEnemies(t,e)&&this.buildEscapePath(t,e)}buildEscapePath(t,e,s=t.visionRadius/2){if(s<=1)return this.destination=void 0,!1;const i=this.buildPath(t,e,({x:t,y:e})=>{return Object(r.sumBy)(this.escapesFrom,([s,i])=>Math.max(Math.abs(t-s.x),Math.abs(e-s.y)))>=s});return i.length?(this.destination=i.pop(),!0):this.buildEscapePath(t,e,s-st)}foundEnemies(t,e){return this.escapesFrom=[],this.withinView(t.stageMemory(e),e.creaturePos(t),(e,s)=>{const i=s.creature;i&&this.enemies(t,i)&&this.escapesFrom.push([e,i])}),this.escapesFrom.length>0}}class rt extends J{constructor(){super(t=>!t.seen)}}class at extends J{constructor(){super(t=>!!t.items)}act(t,e,s){if(t.can(G.Inventory))return super.act(t,e,s)}onReach(t,e,s){const i=e.creatureTile(t);if(!i.items)throw"Picker.act : nothing to pick up";return t.ai.pushEvent(new tt(i.items,s)),new te(i,i.items.bunch,s)}}var nt=s(27);class ot extends z{act(t,e,s){const i=e.creaturePos(t);return this.move(t,e,s,t=>!i.eq(t))}}const ht=10;class ct extends _{constructor(t){super(),this.tile=t,this.status=!1}addNode(){return this.status=!1,this.tile.visit(this),this.status}onDoor(){this.status=!0}}class lt extends z{constructor(){super(),this.step=ht,this.firstCallPatrol=!0,this.i="a",this.graph=new nt.Graph,this.lastNodeVisit={},this.currentNodeID="a",this.markNodeVisited(this.currentNodeID),this.path=[]}act(t,e,s,i=!0){if(!(this.graph.nodes().length<=1)){if(this.firstCallPatrol){const s=e.creaturePos(t);this.addNode(s),this.firstCallPatrol=!1}return this.step+=1,this.path.length?this.moveToTarget(t,e,s,i):(this.targetNodeID&&(this.markNodeVisited(this.targetNodeID),this.currentNodeID=this.targetNodeID),this.pickUpNewTarget(t,e),this.moveToTarget(t,e,s,i))}}reset(){this.path=[]}trackMovement(t,e){(this.step>=ht||new ct(e).addNode())&&this.addNode(t),this.step+=1}addNode(t){this.graph.setNode(this.i,t),this.currentNodeID&&this.currentNodeID!==this.i&&this.graph.setEdge(this.currentNodeID,this.i),this.currentNodeID=this.i,this.i=a(this.i),this.step=0}buildNewPath(t,e){if(!this.targetNodeID)throw"Patrol has no next targetID";const s=this.graph.node(this.targetNodeID);this.path=this.buildPath(t,e,t=>s.eq(t))}pickUpNewTarget(t,e){let s=this.graph.nodes()[0],i=this.lastNodeVisit[s],r=this.graph.neighbors(this.currentNodeID);r&&r.forEach(t=>{i>(this.lastNodeVisit[t]||0)&&(s=t,i=this.lastNodeVisit[s])}),this.targetNodeID=s,this.buildNewPath(t,e)}moveToTarget(t,e,s,i){const r=this.path.shift();return r?t.stageMemory(e).at(r.x,r.y).tangible()?(this.buildNewPath(t,e),this.path.length?this.act(t,e,s,!1):void 0):new Y(s,e,r):i?(this.path=[],this.act(t,e,s,!1)):(new ot).act(t,e,s)}markNodeVisited(t){this.lastNodeVisit[t]=this.step}}class ut extends z{act(t,e,s){if(!t.can(G.Throwing)||!this.hasMissile(t)||!this.canAttack(t,e,s))return;let i=[];if(!this.victim)throw"Thrower.act called when there is no victim";return c(e.creaturePos(t),e.creaturePos(this.victim),(t,e)=>i.push(new o(t,e))),new Zt(i,s,e,t=>{t===j.DIE&&(this.victim=void 0,this.previousVictim=void 0)})}hasMissile(t){return this.missiles=t.missile,void 0!==this.missiles}canAttack(t,e,s){return this.previousVictim=this.victim,this.victim=void 0,!(!this.previousVictim||!this.findWithId(t,e,this.previousVictim.id))||this.findCreature(t,e,e=>this.enemies(t,e))}findWithId(t,e,s){return this.findCreature(t,e,t=>s===t.id)}findCreature(t,e,s){const i=t.stageMemory(e),r=e.creaturePos(t);return this.withinView(i,e.creaturePos(t),(a,n)=>{const o=n.creature;!this.victim&&o&&s(o)&&!this.obstacles(t,r,i,a)&&(this.victim=e.at(a.x,a.y).creature)}),!!this.victim}obstacles(t,e,s,i){let r=!1;return c(e,i,(e,i)=>{r=r||s.at(e,i).tangible(t)}),r}}class dt extends _{constructor(){super(...arguments),this.match=!1}onStairwayDown(){this.match=!0}}class pt extends _{constructor(t,e,s){super(),this.actor=t,this.game=e,this.levelMap=s}onStairwayDown(t){const e=this.game.getMap(t.adjacentMapId);t.enterPos=e.matchStairs(this.levelMap.id,this.levelMap.creaturePos(this.actor)),this.event=new Y(this.game,this.levelMap,t.enterPos,e)}}class mt extends J{constructor(){super(t=>{const e=new dt;return t.visit(e),e.match})}act(t,e,s){if(t.can(G.GoStairwayDown))return super.act(t,e,s)}onReach(t,e,s){const i=new pt(t,s,e);return e.creatureTile(t).visit(i),i.event}}class gt extends d{constructor(t){super(),this.levelMap=t}affectCreature(t){let e=t.stageMemory(this.levelMap);return this.levelMap.creaturePos(t).wrappers().forEach(({x:t,y:s})=>{e.at(t,s).see(this.levelMap.at(t,s),0)}),j.NOTHING}}class ft extends z{act(t,e){if(!t.health.atMax)return new gt(e)}}var vt,wt,bt,yt,xt,Ct,Tt;!function(t){t[t.AbilitiesPicking=0]="AbilitiesPicking",t[t.Death=1]="Death",t[t.Idle=2]="Idle",t[t.Inventory=3]="Inventory",t[t.ItemsListing=4]="ItemsListing",t[t.Missile=5]="Missile",t[t.ProfessionPicking=6]="ProfessionPicking",t[t.Look=7]="Look",t[t.Teleportation=8]="Teleportation",t[t.PickHandleOption=9]="PickHandleOption"}(vt||(vt={}));class Mt{constructor(t,e,s){this.type=t,this.levelMap=e,this.game=s,this.player=this.game.player}get tile(){return this.levelMap.creatureTile(this.player)}endTurn(){this.game.player.ai.endTurn()}redirect(t){this.game.player.ai.redirect(t)}goIdle(){this.redirect(new Ke(this.levelMap,this.game))}}class It extends Mt{constructor(t,e,s){super(vt.Death,e,s),this.dieReason=t}get playerName(){return this.game.player.name}}class kt extends Z{constructor(t,e,s){super(s),this.level=t,this.levelMap=e}run(){if(!this.game.ai)throw"AINewLevelEvent.run: game.ai is undefined";this.level%3==0?this.game.ai.presenter=new hs(this.level,this.levelMap,this.game):this.game.ai.presenter=new as(this.level,this.levelMap,this.game)}immediate(){return!0}}class Wt extends Z{constructor(t,e){super(e),this.levelMap=t}run(){if(!this.game.ai)throw"AINewLevelEvent.run: game.ai is undefined";this.game.player.rebuildVision(this.levelMap),this.game.ai.presenter=new ns(this.levelMap,this.game)}immediate(){return!0}}class Rt extends et{constructor(){super(...arguments),this.presenter=null,this.levelUps=0}act(t,e,s){this.game=s,this.levelMap=e,this.presenter=new Ke(e,this.game),this.game.ai=this}endTurn(){let t=this.events.pop();if(t)t.run();else if(this.game&&this.levelMap){this.game.player.on(new m(this.levelMap,this.game));let t=this.events.pop();t?t.run():(this.game.player.ai.runEvents(),this.game.ai=null,this.presenter=null)}}redirect(t){this.presenter=t}}class Pt extends d{constructor(t,e,s){super(),this.actor=t,this.levelMap=e,this.game=s}affectCreature(t){return j.NOTHING}affectPlayer(t){return t.level.add(1).forEach(e=>{t.ai.pushEvent(new kt(e,this.levelMap,this.game))}),j.NOTHING}}class St extends d{constructor(t,e,s,i){super(),this.impactType=t,this.source=e,this.game=s,this.duration=i}affectCreature(t){return t.hasImpact(this.impactType)&&this.applyImpact(),this.duration?t.impactsBunch.addImpact(this.impactType,this.duration):t.addImpact(this.impactType,this.source),j.NOTHING}applyImpact(){}}!function(t){t[t.Intangible=0]="Intangible",t[t.MagicDamage=1]="MagicDamage",t[t.TeleportationControl=2]="TeleportationControl"}(wt||(wt={}));class Et{constructor(){}static misses(t,e){return Math.random()>t/(t+Math.pow(.25*e,.8))}static dodges(t,e){return Math.random()<Math.atan(t/e)/Math.PI*2}static throwDamageTo(t,e){return 10}static damage(t,e,s){if(t.every(({type:t,resistances:e})=>this.resistTo(t,e,s)))return{damage:0,resist:!0};return{damage:Object(r.sumBy)(t,({extra:t,dice:i,type:r,resistances:a})=>this.resistTo(r,a,s)?0:Math.floor(Math.max(0,t+this.dropDice(i)-this.protectionValue(r,e)))),resist:!1}}static resistTo(t,e,s){if(e&&Object(r.intersection)(s,e).length)return!0;switch(t){case le.Melee:case le.Pierce:case le.Blunt:return Object(r.includes)(s,wt.Intangible);case le.Magic:return Object(r.includes)(s,wt.MagicDamage);case le.Pure:return!1}}static dropDice(t){return Object(r.sum)(Object(r.times)(t.times,()=>Object(r.random)(1,t.max)))}static protectionValue(t,e){return Object(r.sum)(e.map(({type:e,value:s})=>s*this.armorToDamageRatio(t,e)))}}Et.armorToDamageRatio=((t,e)=>{switch(t){case le.Melee:switch(e){case Ct.Medium:return 2/3;case Ct.Solid:return 4/3;default:return 1}case le.Pierce:switch(e){case Ct.Light:return.5;case Ct.Medium:return 4/3;case Ct.Solid:return 3;case Ct.Unarmored:return.75;default:return 1}case le.Blunt:switch(e){case Ct.Medium:return 2;case Ct.Solid:case Ct.Unarmored:return.5;default:return 1}case le.Magic:switch(e){case Ct.Light:return 5/4;case Ct.Medium:return.75;case Ct.Heavy:return.5;case Ct.Solid:return 3;default:return 1}case le.Pure:return 0;default:throw"Got unknown type of damage!"}}),function(t){t[t.WeaponOneHand=0]="WeaponOneHand",t[t.WearsOnHead=1]="WearsOnHead",t[t.WearsOnBody=2]="WearsOnBody",t[t.Ring=3]="Ring",t[t.Amulet=4]="Amulet",t[t.Throw=5]="Throw",t[t.Shoot=6]="Shoot",t[t.Boots=7]="Boots",t[t.Tool=8]="Tool",t[t.Belt=9]="Belt",t[t.Gloves=10]="Gloves",t[t.Gauntlets=11]="Gauntlets",t[t.Cloak=12]="Cloak"}(bt||(bt={})),function(t){t[t.BodyArmor=0]="BodyArmor",t[t.OneHandWeapon=1]="OneHandWeapon",t[t.Consumable=2]="Consumable",t[t.Missile=3]="Missile",t[t.Potion=4]="Potion",t[t.MissileWeapon=5]="MissileWeapon",t[t.Boots=6]="Boots"}(yt||(yt={})),function(t){t[t.MissileRock=0]="MissileRock",t[t.Sling=1]="Sling",t[t.Bow=2]="Bow",t[t.Arrows=3]="Arrows"}(xt||(xt={}));class _t{constructor(t,e,s,i=[],r=new N({}),a=_t.getId()){this.group=t,this.name=e,this.weight=s,this.usages=i,this.modifier=r,this.id=a,this.impacts=[]}static getId(){return this.lastId++}get canSeeDetails(){return!0}clone(){return new _t(this.group,this.name,this.weight)}groupsWith(t){return this.name===t.name}worksWith(t){return!1}canThrow(t){return!0}}_t.lastId=0;class Ot extends _t{constructor(t){super(yt.Consumable,`${t.name}'s corpse`,t.weight),this.specie=t}}class At extends _t{constructor(t){super(yt.Potion,t,.2),this.name=t}}class Dt extends _t{constructor(t,e,s){super(yt.Missile,t,e,[],s)}}class Nt extends _t{constructor(t,e,s){super(yt.MissileWeapon,t,e,[bt.Shoot],s)}}class $t extends _t{constructor(t,e,s,i,r){super(t,e,s,[r]),this.damages=i}}class Bt extends $t{constructor(t,e,s){super(yt.OneHandWeapon,t,e,s,bt.WeaponOneHand)}}!function(t){t[t.Light=0]="Light",t[t.Medium=1]="Medium",t[t.Heavy=2]="Heavy",t[t.Solid=3]="Solid",t[t.Unarmored=4]="Unarmored"}(Ct||(Ct={}));class Lt extends _t{constructor(t,e,s,i,r){super(t,e,s,[r]),this.protections=i}}class Ht extends Lt{constructor(t,e,s){super(yt.BodyArmor,t,e,s,bt.WearsOnBody)}}class Ft extends Lt{constructor(t,e,s){super(yt.Boots,t,e,s,bt.Boots)}}!function(t){t[t.Attack=0]="Attack",t[t.Missile=1]="Missile",t[t.Trap=2]="Trap",t[t.Overloaded=3]="Overloaded"}(Tt||(Tt={}));class Gt extends d{constructor(t,e,s){super(),this.game=t,this.levelMap=e,this.reason=s}affectCreature(t){let e=this.levelMap.creatureTile(t);return this.levelMap.removeCreature(t),t.dead=!0,e.addItem(new Ot(t.specie),1),t.inventoryItems.forEach(t=>e.addItem(t.item,t.count)),j.DIE}affectPlayer(t){return t.ai.presenter=new It(this.reason,this.levelMap,this.game),t.dead=!0,this.game.ai=t.ai,j.DIE}}class Ut extends d{constructor(t,e,s){super(),this.damages=t,this.levelMap=e,this.game=s}get damage(){if(this.doneDamage)return this.doneDamage;throw"HurtEvent.damage called but there is no done damage"}affectCreature(t){const{damage:e,resist:s}=Et.damage(this.damages,t.protections,t.resistances);return this.doneDamage=e,s?j.RESIST:e>=t.health.currentValue?(t.on(new Gt(this.game,this.levelMap,Tt.Attack)),j.DIE):e<=0?j.NOTHING:(t.health.decrease(e),j.HURT)}}class jt extends d{constructor(t,e,s){super(),this.victim=t,this.levelMap=e,this.game=s}affectCreature(t){const e=this.process(t);switch(e){case j.NOTHING:this.game.logger.noDamageToPlayer(t);break;case j.RESIST:this.game.logger.playerIgnoresDamage(t)}return e}affectPlayer(t){const e=this.process(t);switch(e){case j.NOTHING:this.game.logger.noDamageToTarget(t);break;case j.RESIST:this.game.logger.targetIgnoresDamage(this.victim)}return e}process(t){if(Et.misses(t.bodyControl,this.victim.bodyControl))return this.game.logger.missMessage(t,this.victim),j.DODGE;const e=new Ut(t.damages,this.levelMap,this.game),s=this.victim.on(e);switch(s){case j.DIE:t.on(new Pt(this.victim,this.levelMap,this.game)),this.game.logger.killMessage(e.damage,t,this.victim);break;case j.HURT:this.game.logger.hurtMessage(e.damage,t,this.victim)}return s}}class Vt extends d{constructor(t,e){super(),this.potion=t,this.game=e}affectCreature(t){return t.removeItem(this.potion,1),this.potion.onDrink(this.game),this.game.logger.drink(this.potion),j.NOTHING}}class qt extends p{constructor(t,e,s){super(),this.tile=t,this.items=e,this.game=s}affectPlayer(t){return this.items.forEach(({item:e,count:s})=>{t.removeItem(e,s),t.stuffWeight.subtract(e.weight*s),this.game.logger.droppedItem(e,s),this.tile.addItem(e,s)}),j.NOTHING}}class Yt extends p{affectPlayer(t){return this.updateHealth(t),j.NOTHING}updateHealth(t){const e=t.constitution.current;e<3?t.health.constantDecrease(2):e<6?t.health.constantDecrease(1):e<12||(e<15?t.health.constantIncrease(1):e<18?t.health.constantIncrease(2):e<20?t.health.constantIncrease(3):t.health.constantIncrease(4)),t.health.maximum<1&&t.health.constantIncrease(1-t.health.maximum)}}class zt{constructor(t){this.onDone=t}speed(){return-1}}class Xt extends zt{constructor(t,e,s){super(s),this.item=t,this.frames=e}patchMemory(t){if(this.done())return;const[e]=this.frames.splice(0,1),s=t.at(e.x,e.y);s.visible?s.effect="-":this.patchMemory(t)}done(){return 0===this.frames.length}}class Jt extends d{constructor(t,e,s,i){super(),this.victim=t,this.missile=e,this.levelMap=s,this.game=i}affectCreature(t){if(Et.misses(t.bodyControl,this.victim.bodyControl))return this.game.logger.throwMissMessage(t,this.victim,this.missile),j.THROW_DODGE;const e=Et.throwDamageTo(10,10);return e>=this.victim.health.currentValue?(t.on(new Pt(this.victim,this.levelMap,this.game)),this.game.logger.throwKillMessage(e,t,this.victim,this.missile),this.victim.on(new Gt(this.game,this.levelMap,Tt.Missile))):(this.victim.health.decrease(e),this.game.logger.throwHurtMessage(e,t,this.victim,this.missile),j.HURT)}}class Kt extends d{constructor(t,e){super(),this.slot=t,this.game=e}affectCreature(t){return j.NOTHING}affectPlayer(t){const e=this.slot.equipment;if(void 0===e)throw`Can not take off item from ${this.slot.name} - nothing equipped`;return this.slot.takeOff(),this.onTakeOff(t,e.item),t.inventory.putToBag(e.item,e.count),this.game.logger.takeOff(e.item),j.NOTHING}onTakeOff(t,e){e instanceof Lt&&e.protections.forEach(e=>{t.itemsProtections.splice(Object(r.findIndex)(t.itemsProtections,t=>t===e),1)}),e instanceof $t&&e.damages.forEach(e=>{t.itemsDamages.splice(Object(r.findIndex)(t.itemsDamages,t=>t===e),1)}),e.impacts.forEach(s=>{t.on(new se(s,e.name,this.game))})}}class Qt extends d{constructor(t,e,s){super(),this.slot=t,this.count=e,this.game=s}affectCreature(t){return j.NOTHING}affectPlayer(t){if(!this.slot.equipment)throw`RemoveItemEvent: ${this.slot.name} has no equipment`;return this.slot.equipment.count===this.count?t.on(new Kt(this.slot,this.game)):(this.slot.equipment.count-=this.count,j.NOTHING)}}class Zt extends d{constructor(t,e,s,i){super(),this.path=t,this.game=e,this.levelMap=s,this.done=i}affectCreature(t){let e=t.missile;if(!e)throw"MissileAttackEvent called when actor has no missiles";return this.withMissile(t,e.item),j.NOTHING}affectPlayer(t){const e=t.missile;if(!e)throw"MissileAttackEvent: slot has no items";return this.withMissile(t,e.item),t.on(new Qt(t.inventory.missileSlot,1,this.game)),t.stuffWeight.subtract(e.item.weight),j.NOTHING}withMissile(t,e){let s,i=[];this.path.forEach(t=>{if(!s){const e=this.levelMap.at(t.x,t.y);s=e.creature,i.push(t)}}),this.game.effect=new Xt(e,i,()=>{s?this.done(t.on(new Jt(s,e,this.levelMap,this.game))):this.done(j.NOTHING)})}}class te extends p{constructor(t,e,s){super(),this.tile=t,this.items=e,this.game=s}affectPlayer(t){let e=this.tile.items;if(void 0===e)throw"Failed to pick up items - tile has no items";return this.withTileItems(t,e),j.NOTHING}withTileItems(t,e){this.items.forEach(({item:s,count:i})=>{t.addItem(s,i),t.stuffWeight.add(s.weight*i),this.game.logger.pickedUpItem(s,i),e.remove(s,i)})}}class ee extends d{constructor(t,e,s){super(),this.slot=t,this.item=e,this.game=s}affectCreature(t){return j.NOTHING}affectPlayer(t){let e=t.inventory.findInBag(this.item);if(void 0===e)throw`Item ${this.item.name} can not be equipped - not found in inventory`;if(this.slot.equipment){const e=t.on(new Kt(this.slot,this.game));if(e!==j.NOTHING)return e}const s=this.slot.useSingleItem?1:e.count;return t.removeItem(this.item,s),this.slot.equip(this.item,s),this.onPutOn(t,this.item),this.game.logger.putOn(this.item),j.NOTHING}onPutOn(t,e){e instanceof Lt&&(t.itemsProtections=t.itemsProtections.concat(e.protections)),e instanceof $t&&(t.itemsDamages=t.itemsDamages.concat(e.damages)),e.impacts.forEach(s=>{t.on(new St(s,e.name,this.game))})}}class se extends d{constructor(t,e,s){super(),this.impactType=t,this.source=e,this.game=s}affectCreature(t){return j.NOTHING}}class ie extends d{constructor(t,e){super(),this.levelMap=t,this.game=e}playerSees(t){let{x:e,y:s}=this.levelMap.creaturePos(t);return this.game.player.stageMemory(this.levelMap).at(e,s).visible}}const re=function(t,e,s){let i=t.width*t.height;for(;i>0;){const a=Object(r.random)(0,t.width-1),n=Object(r.random)(0,t.height-1);if(e(t.at(a,n)))return s(a,n),t;i--}throw"post add failed to add tile"};class ae extends ie{constructor(t,e,s){super(t,e),this.selfCast=s}affectCreature(t){return this.playerSees(t)?t.hasResistance(wt.TeleportationControl)||!this.teleport(t)?this.game.logger.creatureNotTeleported(t):this.game.logger.creatureTeleported(t):this.teleport(t),j.NOTHING}affectPlayer(t){return t.hasResistance(wt.TeleportationControl)?(this.selfCast||this.game.logger.playerTeleportationCaused(),t.ai.pushEvent(new Wt(this.levelMap,this.game)),this.game.ai=t.ai):this.teleport(t)?this.selfCast||this.game.logger.playerTeleported():this.game.logger.playerNotTeleported(),j.NOTHING}teleport(t){let e=!1;try{re(this.levelMap,t=>t.isFloor()&&t.passibleThrough(),(s,i)=>{e=!0,t.on(new Y(this.game,this.levelMap,new o(s,i)))})}catch(t){}return e}}class ne extends ie{constructor(t,e,s,i,r,a){super(s,i),this.trap=t,this.dodgeRatio=e,this.onCreatureDodge=r,this.onCreatureActivated=a}affectCreature(t){const e=this.playerSees(t);return e&&(this.trap.revealed=!0),this.dodges(t)?(this.onCreatureDodge(e,!1),j.DODGE):this.onCreatureActivated(e,!1)}affectPlayer(t){return this.trap.revealed=!0,this.dodges(t)?(this.onCreatureDodge(!0,!0),j.DODGE):this.onCreatureActivated(!0,!0)}dodges(t){return Et.dodges(t.bodyControl,this.dodgeRatio)}}class oe extends d{constructor(t,e,s,i){super(),this.trapPosition=t,this.trap=e,this.levelMap=s,this.game=i}affectCreature(){return j.NOTHING}affectPlayer(t){return this.trap.untrap(this.trapPosition,this.levelMap,this.game),j.NOTHING}}var he=function(t,e){return n(t[0].length,t.length,(s,i)=>{const r=e.get(t[i].charAt(s));if(r)return r();throw`drawn: Can not find char ${t[i].charAt(s)}`})};const ce=60;Math.PI;var le,ue,de,pe;!function(t){t[t.Melee=0]="Melee",t[t.Pierce=1]="Pierce",t[t.Blunt=2]="Blunt",t[t.Magic=3]="Magic",t[t.Pure=4]="Pure"}(le||(le={}));class me{constructor(t){this.requires=t,this.current=1,this.currentExperience=0,this.doneLeveling=!1,this.requiredExperience=this.requires[0]}add(t){if(this.doneLeveling)return[];this.currentExperience+=t;let e=[];for(;!this.doneLeveling&&this.currentExperience>=this.requiredExperience;)this.levelUp(),e.push(this.current);return e}levelUp(){this.current+=1;let t=this.requires[this.current-1];t?(this.currentExperience-=this.requiredExperience,this.requiredExperience=t):(this.currentExperience=this.requiredExperience,this.doneLeveling=!0)}}class ge{constructor(t){this.totalWeight=0,this.items=[],t.forEach(([t,e])=>this.add(t,e))}add(t,e){if(t<1)throw"Item's weight is lower than 1";this.items.push([t,e]),this.totalWeight+=Math.ceil(t)}pick(t){if(0===this.items.length)throw"Tried to use empty pool";let e=Object(r.random)(this.totalWeight);const s=this.items.find(([t,s])=>(e-=t)<=0);if(void 0!==s)return s[1](t);throw"Pool failed to pick anything"}merge(t){let e=new ge([]);return this.items.forEach(([t,s])=>e.add(t,s)),t.items.forEach(([t,s])=>e.add(t,s)),e}}class fe{constructor(){this.step=0,this.turns={}}add(t,e){const s=this.step+e;this.turns[s]?Object(r.includes)(this.turns[s],t)||this.turns[s].push(t):this.turns[s]=[t]}remove(t){Object(r.forEach)(this.turns,(e,s)=>{Object(r.remove)(e,e=>e===t)}),this.turns=Object(r.pickBy)(this.turns,t=>t.length>0)}next(){this.step=this.nextStep();const[t]=Object(r.pullAt)(this.turns[this.step],0);return 0===this.turns[this.step].length&&delete this.turns[this.step],void 0===t?this.next():t}actors(){if(0===Object(r.size)(this.turns))return[];this.step=this.nextStep();const t=this.turns[this.step];return delete this.turns[this.step],t}nextStep(){let t=Object(r.min)(Object(r.keys)(this.turns).map(t=>parseInt(t)));if(void 0===t)throw"Timeline.nextStep called when there is no ones turn";return t}}class ve{constructor(){this.levels=[]}addStairDown(t,e){return this.addStairs(t,new W(t,e))}addStairUp(t,e){return this.addStairs(t,new R(t,e))}addStairs(t,e){return re(t,t=>t.isFloor()&&t.passibleThrough(),(s,i)=>{t.setTile(s,i,e)}),t}}class we extends h{constructor(t,e){super(e),this.id=t,this.creatures=[],this.name="unnamed",this.timeline=new fe}reset(){this.timeline=new fe}enter(){this.reset(),this.creatures.forEach(t=>this.timeline.add(t.id,t.speed))}creatureTile(t){let e;if(this.each(s=>{s.creature&&s.creature.id===t.id&&(e=s)}),!e)throw`Creature ${t.id} is not found on map ${this.id}`;return e}creaturePos(t){let e;if(this.each((s,i,r)=>{s.creature&&s.creature.id===t.id&&(e=new o(i,r))}),!e)throw`Creature ${t.id} is not found on map ${this.id}`;return e}addCreature(t,e){this.creatures.push(e),this.at(t.x,t.y).creature=e,this.timeline.add(e.id,e.speed)}removeCreature(t){let e=this.creaturePos(t);this.at(e.x,e.y).creature=void 0,Object(r.remove)(this.creatures,e=>e.id===t.id),this.timeline.remove(t.id)}visibleThrough(t,e){return this.map[t][e].visibleThrough()}passibleThrough(t,e){return this.map[t][e].passibleThrough()}setTile(t,e,s){this.map[t][e]=s}matchStairs(t,e){let s;if(this.each((i,r,a)=>{(i instanceof W||i instanceof R)&&i.adjacentMapId===t&&(i.enterPos=e,s=new o(r,a))}),s)return s;throw`LevelMap ${this.name} failed to find stairs to ${t}`}}!function(t){t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARNING=2]="WARNING",t[t.DANGER=3]="DANGER"}(ue||(ue={}));class be{constructor(){this.messages=[]}reset(){this.messages=[]}hurtMessage(t,e,s){this.debug(`${s.name} got ${t} damage from ${e.name}`)}killMessage(t,e,s){this.warning(`${s.name} got ${t} damage from ${e.name} causes them to die`)}missMessage(t,e){this.debug(`${t.name} misses ${e.name}!`)}throwMissMessage(t,e,s){this.debug(`${t.name} throws ${s.name} in ${e.name}, but misses!`)}throwKillMessage(t,e,s,i){this.warning(`${s.name} got ${t} damage from ${e.name} by ${i.name} causes them to die`)}throwHurtMessage(t,e,s,i){this.debug(`${s.name} got ${t} damage from ${e.name} by ${i.name}`)}ranIntoAnObstacle(){this.addMessage(ue.DEBUG,"You ran into a wall")}howToHandle(){this.addMessage(ue.DEBUG,"Don't know how to handle it")}noItemsToPickUp(){this.addMessage(ue.DEBUG,"You don't see anything to pick up")}takeOff(t){this.addMessage(ue.DEBUG,`You took off ${t.name}`)}putOn(t){this.addMessage(ue.DEBUG,`You put on ${t.name}`)}drink(t){this.addMessage(ue.INFO,`You drunk ${t.name}`)}nothingToShotWith(){this.addMessage(ue.DEBUG,"You have nothing to shoot with")}needMissileWeapon(){this.addMessage(ue.DEBUG,"Мне нужен лук или типа того")}youSteppedInTrap(){this.addMessage(ue.DANGER,"Я наступил в ловушку")}creatureSteppedInTrap(t){this.addMessage(ue.DANGER,`${t.name} наступил в ловушку`)}noDamageToPlayer(t){this.addMessage(ue.DEBUG,`${t.name} ударил по мне, но я не почувствовал боли`)}noDamageToTarget(t){this.addMessage(ue.DEBUG,`Удар пришелся по ${t.name} но остался незамеченным`)}playerIgnoresDamage(t){this.addMessage(ue.DEBUG,`Я игнорирую урон ${t.name}`)}targetIgnoresDamage(t){this.addMessage(ue.INFO,`${t.name} игнорирует урон`)}creatureTeleported(t){this.addMessage(ue.INFO,`${t.name} иcчез`)}creatureNotTeleported(t){this.addMessage(ue.INFO,`${t.name} озарился светом, но ничего не произошло`)}creatureDodgesTeleportationTrap(t){this.addMessage(ue.INFO,`${t.name} попал в ловушку телепортации но смог увернуться`)}playerTeleportationCaused(){this.addMessage(ue.INFO,"Что-то заставило меня телепортироваться")}playerTeleported(){this.addMessage(ue.INFO,"Яркая вспышка и я оказался в другом месте")}playerNotTeleported(){this.addMessage(ue.INFO,"Я озарился ярким светом, но ничего не произошло")}playerTeleportedWhereTheyWere(){this.addMessage(ue.INFO,"Я решил никуда не телепортироваться")}playerDodgesTeleportationTrap(){this.addMessage(ue.INFO,"Я попал в ловушку телепортации но смог увернуться")}canNotUntrap(){this.addMessage(ue.INFO,"Не представляю, как это обезвредить")}pickedUpItem(t,e){1===e?this.addMessage(ue.INFO,`You picked up ${t.name}`):this.addMessage(ue.INFO,`You picked up ${e} ${t.name}`)}droppedItem(t,e){1===e?this.addMessage(ue.INFO,`You dropped a ${t.name}`):this.addMessage(ue.INFO,`You dropped ${e} ${t.name}`)}debug(t){this.addMessage(ue.DEBUG,t)}info(t){this.addMessage(ue.INFO,t)}warning(t){this.addMessage(ue.WARNING,t)}danger(t){this.addMessage(ue.DANGER,t)}addMessage(t,e){const s=Object(r.last)(this.messages);s&&s.message===e?s.counter+=1:this.messages.push({level:t,message:e,counter:1})}}class ye{constructor(t,e){this.player=t,this.professionPicker=e,this.logger=new be,this.ai=null,this.running=!1,this.effect=null,this.maps=new Map}turn(){if(!(this.running||this.ai&&!this.effect)){if(this.running=!0,!this.currentMap)throw"levelMapTurn: Map is undefined";if(this.effect)this.player.rebuildVision(this.currentMap),this.effect.patchMemory(this.player.stageMemory(this.currentMap)),this.effect.done()&&(this.effect.onDone(),this.effect=null),this.running=!1;else{for(;!this.player.dead&&!this.ai;)this.levelMapTurn();this.player.rebuildVision(this.currentMap)}this.running=!1}}getMap(t){const e=this.maps.get(t);if(!e)throw`Map with id ${t} is not found`;if(e instanceof we)return e;if(e instanceof Function){const s=e(t,this);return this.maps.set(t,s),s}throw`LevelMap with id ${t} is not found`}addMap(t,e){this.maps.set(t,e)}levelMapTurn(){if(!this.currentMap)throw"levelMapTurn: Map is undefined";let t=this.currentMap.timeline,e=this.currentMap;const s=t.next();if(void 0===s)throw"Timeline event is empty!";const i=e.creatures.find(t=>s===t.id);if(i){const r=i.act(e,this);r&&e.creatures.find(t=>s===t.id)&&t.add(s,r)}}}class xe{constructor(t,e,s){this.usages=t,this.useSingleItem=e,this.equipment=s,this.name="InventorySlot"}matchingItems(t){return t.cares().filter(t=>this.match(t.item))}equip(t,e){if(this.equipment)throw`Slot ${this.name} is already equipped with ${this.equipment.item}`;this.equipment={count:e,item:t}}takeOff(){if(!this.equipment)throw`Slot ${this.name} has nothing to take off`;this.equipment=void 0}match(t){return Object(r.intersection)(t.usages,this.usages).length>0}withPairItem(t,e){return t.filter(t=>t.item.worksWith(e))}}class Ce extends xe{constructor(){super([bt.WeaponOneHand],!0),this.name="Правая рука"}}class Te extends xe{constructor(){super([bt.WeaponOneHand],!0),this.name="Левая рука"}}class Me extends xe{constructor(){super([bt.WearsOnHead],!0),this.name="Голова"}}class Ie extends xe{constructor(){super([bt.WearsOnBody],!0),this.name="Корпус"}}class ke extends xe{constructor(){super([bt.Gloves],!0),this.name="Перчатки"}}class We extends xe{constructor(){super([bt.Gauntlets],!0),this.name="Наручи"}}class Re extends xe{constructor(){super([bt.Belt],!0),this.name="Пояс"}}class Pe extends xe{constructor(){super([bt.Boots],!0),this.name="Ботинки"}}class Se extends xe{constructor(){super([bt.Amulet],!0),this.name="Амулет"}}class Ee extends xe{constructor(){super([bt.Ring],!0),this.name="Левый палец"}}class _e extends xe{constructor(){super([bt.Ring],!0),this.name="Правый палец"}}class Oe extends xe{constructor(){super([bt.Cloak],!0),this.name="Плащ"}}class Ae extends xe{constructor(){super([bt.Shoot],!0),this.name="Метательное"}matchingItems(t){let e=super.matchingItems(t),s=t.missileSlot.equipment;return s?this.withPairItem(e,s.item):e}}class De extends xe{constructor(){super([bt.Throw],!1),this.name="Снаряды"}matchingItems(t){let e=t.cares(),s=t.missileWeaponSlot.equipment;return s?this.withPairItem(e,s.item):e}}class Ne extends xe{constructor(){super([bt.Tool],!0),this.name="Инструмент"}}class $e{constructor(){this.bag=new g,this.headSlot=new Me,this.amuletSlot=new Se,this.cloakSlot=new Oe,this.chestSlot=new Ie,this.rightHandSlot=new Ce,this.leftHandSlot=new Te,this.leftFingerSlot=new Ee,this.rightFingerSlot=new _e,this.glovesSlot=new ke,this.gauntletsSlot=new We,this.beltSlot=new Re,this.bootsSlot=new Pe,this.missileWeaponSlot=new Ae,this.missileSlot=new De,this.toolsSlot=new Ne}slots(){return[this.headSlot,this.amuletSlot,this.cloakSlot,this.chestSlot,this.rightHandSlot,this.leftHandSlot,this.leftFingerSlot,this.rightFingerSlot,this.glovesSlot,this.gauntletsSlot,this.beltSlot,this.bootsSlot,this.missileWeaponSlot,this.missileSlot,this.toolsSlot]}get allItems(){return Object(r.concat)(this.cares(),Object(r.compact)(this.slots().map(t=>t.equipment)))}get unarmoredSlotsCount(){return[this.headSlot,this.chestSlot,this.glovesSlot,this.gauntletsSlot,this.beltSlot,this.bootsSlot].filter(t=>!t.equipment).length}cares(){return this.bag.bunch}findInBag(t){return this.bag.find(t)}putToBag(t,e){this.bag.put(t,e)}removeFromBag(t,e){this.bag.remove(t,e)}}class Be{constructor(t){this.tile=t,this.visible=!1,this.degree=0,this.seen=!1}get items(){return this.tile.items}get creature(){return this.tile.creature}see(t,e){this.visible=!0,this.degree=e,this.seen=!0,this.tile=t.clone()}tangible(t){return this.seen&&!this.tile.passibleThrough(t)}reset(){this.visible=!1,this.effect=void 0,this.tile.creature=void 0}visit(t){this.tile.visit(t)}}class Le extends h{constructor(t,e){const s=new I;super(n(t,e,()=>new Be(s)))}resetVisible(){this.each(t=>t.reset())}}class He extends V{constructor(t,e,s,i,r){super(s),this.level=t,this.ai=e,this.professions=[],this.inventory=new $e,this.itemsProtections=[],this.itemsDamages=[],this.itemsResistances=[],this.strength=new H(i),this.dexterity=new $(2),this.constitution=new $(r),this.intelligence=new $(2),this.wisdom=new $(2),this.charisma=new $(2),this.stuffWeight=new $(0),this.carryingCapacity=new B(this.strength.current,this.constitution.current)}act(t,e){this.statsTurn(),this.visionMask(t);const s=this.ai.act(this,t,e);return s&&this.on(s),this.on(new m(t,e)),this.speed}rebuildVision(t){this.visionMask(t)}on(t){return t.affectPlayer(this)}get missile(){return this.inventory.missileSlot.equipment}get inventoryItems(){return this.inventory.allItems}addItem(t,e){this.inventory.putToBag(t,e)}removeItem(t,e){this.inventory.removeFromBag(t,e)}get damages(){const t=this.strength.meleeAdjustment;return Object(r.concat)(this.specie.damages,this.itemsDamages).map(e=>{let s=Object(r.cloneDeep)(e);return s.extra+=t,s})}get protections(){return Object(r.concat)(this.specie.protections,this.itemsProtections,[{type:Ct.Unarmored,value:1*this.inventory.unarmoredSlotsCount}])}get resistances(){return Object(r.concat)(this.specie.resistances,this.itemsResistances)}}class Fe{constructor(t,e,s=1,i=0){this.id=t,this.name=e,this.level=s,this.points=i,this.talents=[],this.depthCost=3}}class Ge{constructor(t,e,s){this.pool=t,this.maxLevel=e,this.maxTaken=s}available(t){let e,s=[];return this.canUpdate(t)?e=this.updatableProfession(t):this.canTakeNewProfession(t)&&(e=this.newFromPool(t)),void 0!==e&&s.push(e),this.canTakeNewProfession(t)?e=this.newFromPool(t,e&&e.id):this.canUpdate(t)&&(e=this.updatableProfession(t,e&&e.id)),void 0!==e&&s.push(e),s}canUpdate(t){return t.professions.some(t=>t.level<this.maxLevel)}updatableProfession(t,e){return Object(r.sample)(t.professions.filter(t=>e!==t.id))}canTakeNewProfession(t){return t.professions.length<this.maxTaken&&this.pool.length>t.professions.length}newFromPool(t,e){const s=t.professions.map(t=>t.id);return void 0!==e&&s.push(e),Object(r.sample)(this.pool.filter(t=>!Object(r.includes)(s,t.id)))}}!function(t){t[t.Available=0]="Available",t[t.Completed=1]="Completed",t[t.Unavailable=2]="Unavailable"}(de||(de={}));class Ue{constructor(t,e,s,i,r,a){this.id=t,this.name=e,this.depth=s,this.rank=i,this.maxRank=r,this.description=a}}class je extends P{constructor(t=!1){super(t,w.Light)}untrap(t,e,s){s.logger.canNotUntrap()}buildNew(){return new je(this.revealed)}affect(t,e,s){s.on(new ne(this,this.revealed?0:10,e,t,(e,i)=>{i?t.logger.playerDodgesTeleportationTrap():e&&t.logger.creatureDodgesTeleportationTrap(s)},(e,i)=>s.on(new St(f.Blind,"trap",t,10))))}}class Ve extends P{constructor(t=!1){super(t,w.Teleportation)}untrap(t,e,s){s.logger.canNotUntrap()}buildNew(){return new Ve(this.revealed)}affect(t,e,s){s.on(new ne(this,this.revealed?3:10,e,t,(e,i)=>{i?t.logger.playerDodgesTeleportationTrap():e&&t.logger.creatureDodgesTeleportationTrap(s)},(i,r)=>s.on(new ae(e,t,!1))))}}class qe extends Mt{constructor(t,e){super(vt.Inventory,t,e),this.positions=[],this.takeTime=!1,this.rebuildPositions()}takeOff(t){this.player.on(new Kt(t.inventorySlot,this.game)),this.takeTime=!0,this.rebuildPositions()}putOn(t){this.redirect(new ts(e=>{this.player.on(new ee(t.inventorySlot,e.item,this.game)),this.takeTime=!0,this.rebuildPositions(),this.redirect(this)},t.availableItems,this.levelMap,this.game))}close(){this.takeTime?this.endTurn():this.redirect(new Ke(this.levelMap,this.game))}rebuildPositions(){this.positions=this.player.inventory.slots().map(t=>({inventorySlot:t,item:t.equipment&&t.equipment.item,count:t.equipment&&t.equipment.count,availableItems:t.matchingItems(this.player.inventory)}))}}class Ye extends Mt{constructor(t,e){super(vt.Missile,t,e),this.targetEnemyIndex=void 0,this.enemies=[],this.path=[],this.findEnemies(),this.memory=this.player.stageMemory(this.levelMap),this.targetPos=this.resetTargetId()}nextTarget(){void 0!==this.targetEnemyIndex?(this.targetEnemyIndex+=1,this.targetEnemyIndex>=this.enemies.length&&(this.targetEnemyIndex=0),this.updateTarget(this.enemies[this.targetEnemyIndex])):this.resetTargetId()}previousTarget(){void 0!==this.targetEnemyIndex?(this.targetEnemyIndex-=1,this.targetEnemyIndex<0&&(this.targetEnemyIndex=this.enemies.length-1),this.updateTarget(this.enemies[this.targetEnemyIndex])):this.resetTargetId()}moveTarget(t){const e=this.targetPos.add(t);this.levelMap.at(e.x,e.y).visibleThrough()&&this.player.stageMemory(this.levelMap).at(e.x,e.y).visible&&(this.updateTarget(e),this.targetEnemyIndex=void 0)}attack(){this.targetPos.eq(this.levelMap.creaturePos(this.player))||this.player.on(new Zt(this.path,this.game,this.levelMap,()=>this.endTurn()))}close(){this.resetPath(),this.redirect(new Ke(this.levelMap,this.game))}resetTargetId(){let t;return this.enemies.length?(this.targetEnemyIndex=0,t=this.enemies[this.targetEnemyIndex]):(this.targetEnemyIndex=void 0,t=this.levelMap.creaturePos(this.player)),this.updateTarget(t),t}resetPath(){this.path.forEach(({x:t,y:e})=>this.memory.at(t,e).effect=void 0)}updateTarget(t){this.resetPath(),this.targetPos=t.copy(),this.drawPath()}drawPath(){this.path=[];let t=!1;const e=this.levelMap,s=this.levelMap.creaturePos(this.player);l(s,this.targetPos,(s,i)=>{e.at(s,i).passibleThrough()||(t=!0),this.path.push(new o(s,i)),this.memory.at(s,i).effect=t?"o":"x"})}findEnemies(){this.enemies=[],this.player.stageMemory(this.levelMap).each((t,e,s)=>{t.visible&&t.creature&&t.creature.id!==this.player.id&&this.enemies.push(new o(e,s))})}}class ze extends Mt{constructor(t,e,s,i){super(vt.PickHandleOption,e,s),this.options=t,this.withOption=i}pick(t){this.withOption(t)}close(){this.goIdle()}}class Xe extends _{constructor(t,e,s,i){super(),this.position=t,this.game=e,this.levelMap=s,this.player=i,this.commands=[]}onStairway(t){const e=this.game.getMap(t.adjacentMapId);t.enterPos=e.matchStairs(this.levelMap.id,this.levelMap.creaturePos(this.player)),this.commands.push(["stairway",new Y(this.game,this.levelMap,t.enterPos,e)])}onTrap(t){t.revealed&&this.commands.push(["untrap",new oe(this.position,t,this.levelMap,this.game)])}}class Je extends Xe{onStairway(){}}class Ke extends Mt{constructor(t,e){super(vt.Idle,t,e)}inventoryCommand(){this.redirect(new qe(this.levelMap,this.game))}bagCommand(){this.redirect(new es(this.levelMap,this.game))}stayCommand(){this.player.on(new gt(this.levelMap)),this.endTurn()}dropCommand(){this.redirect(new Ze(this.levelMap,this.game))}drinkCommand(){this.redirect(new ss(this.levelMap,this.game))}lookCommand(){this.redirect(new rs(this.levelMap,this.game))}move(t){const e=this.levelMap.creaturePos(this.player).add(t),s=this.levelMap.at(e.x,e.y);s.passibleThrough(this.player)?this.player.on(new Y(this.game,this.levelMap,e)):s.creature?this.player.on(new jt(s.creature,this.levelMap,this.game)):(this.game.logger.ranIntoAnObstacle(),this.player.stageMemory(this.levelMap).at(e.x,e.y).see(s,0)),this.endTurn()}pickUpCommand(){const t=this.tile,e=t.items;void 0===e||0===e.bunch.length?this.game.logger.noItemsToPickUp():1===e.bunch.length?(this.player.on(new te(t,e.bunch,this.game)),this.endTurn()):this.redirect(new os(this.levelMap,this.game))}missileCommand(){const t=this.player.inventory.missileSlot.equipment;t&&t.item?t.item.canThrow(this.player)?this.redirect(new Ye(this.levelMap,this.game)):this.game.logger.needMissileWeapon():this.game.logger.nothingToShotWith()}handleCommand(){let t=this.levelMap.creaturePos(this.player),e=new Xe(t,this.game,this.levelMap,this.player),s=new Je(t,this.game,this.levelMap,this.player);this.tile.visit(e),t.wrappers().forEach(t=>{s.position=t,this.levelMap.at(t.x,t.y).visit(s)});const i=Object(r.concat)(e.commands,s.commands);switch(i.length){case 0:this.game.logger.howToHandle();break;case 1:this.player.on(i[0][1]),this.endTurn();break;default:this.redirect(new ze(i,this.levelMap,this.game,([t,e])=>{this.player.on(e),this.endTurn()}))}}}class Qe extends Mt{constructor(t,e){super(vt.ItemsListing,t,e),this.positions=[],this.title="unnamed",this.initPositions()}close(){this.redirect(new Ke(this.levelMap,this.game))}}class Ze extends Qe{constructor(){super(...arguments),this.title="Что положить?"}initPositions(){this.positions=this.player.inventory.cares()}pickUpItems(t){t.length?(this.player.on(new qt(this.tile,t,this.game)),this.endTurn()):this.redirect(new Ke(this.levelMap,this.game))}}class ts extends Qe{constructor(t,e,s,i){super(s,i),this.onWithItem=t,this.positions=e,this.title="Что надеть?",this.singleItemMode=!0}initPositions(){}pickUpItems(t){}withItem(t){this.onWithItem(t)}close(){this.redirect(new qe(this.levelMap,this.game))}}class es extends Qe{constructor(){super(...arguments),this.title="Сумка",this.singleItemMode=!0}initPositions(){this.positions=this.player.inventory.cares()}pickUpItems(t){}withItem(t){this.endTurn()}}class ss extends Qe{constructor(){super(...arguments),this.title="Что выпить?",this.singleItemMode=!0}initPositions(){this.positions=this.player.inventory.cares().filter(t=>t.item.group===yt.Potion)}pickUpItems(t){}withItem(t){this.player.on(new Vt(t.item,this.game)),this.endTurn()}}class is extends Mt{constructor(t,e,s,i,r){super(t,e,s),this.effect=i,this.match=r,this.memory=this.player.stageMemory(this.levelMap),this.targetPos=e.creaturePos(this.player)}act(){this.removeEffect(),this.close()}get memoryTile(){return this.memory.at(this.targetPos.x,this.targetPos.y)}moveTarget(t){const e=this.targetPos.add(t);this.match(e)&&this.updateTarget(e)}removeEffect(){this.memory.at(this.targetPos.x,this.targetPos.y).effect=void 0}updateTarget(t){this.removeEffect(),this.targetPos=t.copy(),this.drawTarget()}drawTarget(){this.memoryTile.effect=this.effect}}!function(t){t[t.See=0]="See",t[t.Recall=1]="Recall",t[t.Hidden=2]="Hidden"}(pe||(pe={}));class rs extends is{constructor(t,e){super(vt.Look,t,e,"_",t=>this.memory.inRange(t))}get title(){return this.memoryTile.visible?pe.See:this.memoryTile.seen?pe.Recall:pe.Hidden}get body(){let t=[];if(this.memoryTile.creature&&(this.memoryTile.creature.id===this.player.id?t.push("Это я"):t.push(`Это ${this.memoryTile.creature.name}`)),this.memoryTile.items)switch(this.memoryTile.items.bunch.length){case 0:break;case 1:t.push(`Лежит ${this.memoryTile.items.bunch[0].item.name}`);break;default:t.push("Лежит несколько предметов")}return t}close(){this.redirect(new Ke(this.levelMap,this.game))}}class as extends Mt{constructor(t,e,s){super(vt.AbilitiesPicking,e,s),this.level=t,this.options=[],this.options=this.player.professions.map(t=>({profession:t,talents:t.talents.map(e=>Object.assign({},e,{status:this.status(e,t)}))}))}get title(){return"Pick new talent"}pickTalent(t,e){const s=this.player.professions.find(e=>e.id===t);if(void 0===s)throw`Profession with id ${t} is not found`;let i=s.talents.find(t=>t.id===e);if(void 0===i)throw`Talent with id ${e} for profession ${s.name} is not found`;if(this.status(i,s)!==de.Available)throw`Talent with id ${e} for profession ${s.name} can not be upgraded`;i.rank+=1,1===i.rank&&i.onObtain(this.game),s.points+=1,this.player.on(new Yt),this.endTurn()}status(t,e){return t.rank===t.maxRank?de.Completed:t.depth*e.depthCost>e.points?de.Unavailable:de.Available}}class ns extends is{constructor(t,e){super(vt.Teleportation,t,e,"x",({x:e,y:s})=>t.at(e,s).passibleThrough(this.player)&&this.memory.at(e,s).seen)}get title(){return"Выберите зону телепортации"}get body(){return[]}close(){this.targetPos.eq(this.levelMap.creaturePos(this.player))?this.game.logger.playerTeleportedWhereTheyWere():this.player.on(new Y(this.game,this.levelMap,this.targetPos)),this.endTurn()}}class os extends Qe{constructor(){super(...arguments),this.title="Что поднять?"}initPositions(){const t=this.tile.items;if(void 0===t)throw"Failed to show pick up dialog - tile has no items";this.positions=t.bunch.map(t=>({item:t.item,count:t.count}))}pickUpItems(t){this.player.on(new te(this.tile,t,this.game)),this.endTurn()}}class hs extends Mt{constructor(t,e,s){super(vt.ProfessionPicking,e,s),this.level=t}get title(){return`Gained ${this.level} level`}get options(){return this.game.professionPicker.available(this.player)}pickProfession(t){let e=this.player.professions.find(e=>e.id===t.id);e?e.level+=1:this.player.professions.push(t),this.redirect(new as(this.level,this.levelMap,this.game))}}const cs=function(t,e,s,i,a=!1){let o=n(t.width,t.height,()=>-1),h=[],c=[e],l=0;for(;c.length&&!h.length;){let e=[];c.forEach(r=>{if(!t.inRange(r))return;const a=t.at(r.x,r.y);s(a)||-1!==o[r.x][r.y]||(o[r.x][r.y]=l,i(r,a)?h.push(r):r.wrappers().forEach(t=>e.push(t)))}),l++,c=e}if(h.length){let t=Object(r.sample)(h);return ls(a&&t?t:h[0],o)}return[]},ls=function(t,e){let s,i=t,r=[i];for(;1!==e[i.x][i.y];){if(void 0===(s=o.dxy.find(t=>e[i.x+t.x]&&e[i.x+t.x][i.y+t.y]===e[i.x][i.y]-1)))return[];i=i.add(s),r.unshift(i)}return r};var us=i.a.extend({name:"Logger",props:{logger:{type:be,required:!0}},data:()=>({lastId:0}),computed:{messages(){const t=this.logger.messages.length,e=Object(r.takeRight)(this.logger.messages,Math.max(t-this.lastId,5));return this.lastId=t,e}},methods:{counter(t){if(t>1)return`x${t}`},rowClass(t){switch(t.level){case ue.DEBUG:return"debug";case ue.INFO:return"info";case ue.WARNING:return"warning";case ue.DANGER:return"danger"}}}}),ds=(s(45),s(2)),ps=Object(ds.a)(us,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"logger"},t._l(t.messages,function(e,i){return s("div",{key:i,class:t.rowClass(e)},[t._v(t._s(e.message)+"\n"+t._s(t.counter(e.counter)))])}))},[],!1,null,"4926948c",null);ps.options.__file="Logger.vue";var ms=ps.exports;class gs{constructor(t,e,s,i,r,a,n){this.ch=t,this.r=e,this.g=s,this.b=i,this.br=r,this.bg=a,this.bb=n}getChar(){return this.ch}setChar(t){this.ch=t}setColor(t,e,s){this.r=t,this.g=e,this.b=s}setGrey(t){this.r=t,this.g=t,this.b=t}setBackground(t,e,s){this.br=t,this.bg=e,this.bb=s}backgroundToColor(){this.r=this.br,this.g=this.bg,this.b=this.bb}swapColors(){this.r=[this.br,this.br=this.r][0],this.g=[this.bg,this.bg=this.g][0],this.b=[this.bb,this.bb=this.b][0]}resetColor(){this.r=this.g=this.b=void 0}resetBackground(){this.br=this.bg=this.bb=void 0}getColorHex(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?"#"+this.r.toString(16)+this.g.toString(16)+this.b.toString(16):""}getBackgroundHex(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?"#"+this.br.toString(16)+this.bg.toString(16)+this.bb.toString(16):""}getColorRGB(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?`rgb(${this.r},${this.g},${this.b})`:""}getBackgroundRGB(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?`rgb(${this.br},${this.bg},${this.bb})`:""}getColorJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.r,g:this.g,b:this.b}:{}}getBackgroundJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.br,g:this.bg,b:this.bb}:{}}copy(t){this.ch=t.ch,this.r=t.r,this.g=t.g,this.b=t.b,this.br=t.br,this.bg=t.bg,this.bb=t.bb}clone(){return new gs(this.ch,this.r,this.g,this.b,this.br,this.bg,this.bb)}}const fs="unicodetiles",vs=new gs(" ");const ws="\nattribute vec2 position;\nattribute vec2 texCoord;\nattribute vec3 color;\nattribute vec3 bgColor;\nattribute float charIndex;\nuniform vec2 uResolution;\nuniform vec2 uTileCounts;\nuniform vec2 uPadding;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec2 tileCoords = floor(vec2(mod(charIndex, uTileCounts.x), charIndex / uTileCounts.x));\n  vTexCoord = (texCoord + tileCoords) / uTileCounts;\n  vTexCoord += (0.5 - texCoord) * uPadding;\n  vColor = color;\n  vBgColor = bgColor;\n  vec2 pos = position / uResolution * 2.0 - 1.0;\n  gl_Position = vec4(pos.x, -pos.y, 0.0, 1.0);\n}\n",bs="\nprecision mediump float;\nuniform sampler2D uFont;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec4 color = texture2D(uFont, vTexCoord);\n  color.rgb = mix(vBgColor, vColor, color.rgb);\n  gl_FragColor = color;\n}\n";const ys=function(t){return new class{constructor(t){if(this.view=t,this.view=t,this.canvas=document.createElement("canvas"),!this.canvas.getContext)throw"Canvas not supported";if(this.gl=this.canvas.getContext("experimental-webgl"),!this.gl)throw"WebGL not supported";if(t.elem.appendChild(this.canvas),this.charMap={},this.charArray=[],this.defaultColors={r:1,g:1,b:1,br:0,bg:0,bb:0},this.attribs={position:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},texCoord:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},color:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},bgColor:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},charIndex:{buffer:null,data:null,itemSize:1,location:null,hint:this.gl.DYNAMIC_DRAW}},this.offscreen||(this.offscreen=document.createElement("canvas")),this.offscreen.style.position="absolute",this.offscreen.style.top="0px",this.offscreen.style.left="0px",this.ctx=this.offscreen.getContext("2d"),!this.ctx)throw"Failed to acquire offscreen canvas drawing context";this.updateStyle(),this.canvas.width=(t.squarify?this.th:this.tw)*t.w,this.canvas.height=this.th*t.h,this.offscreen.width=0,this.offscreen.height=0,this.updateStyle(),this.gl.viewport(0,0,this.canvas.width,this.canvas.height);let e=this.compileShader(this.gl.VERTEX_SHADER,ws),s=this.compileShader(this.gl.FRAGMENT_SHADER,bs),i=this.gl.createProgram();if(this.gl.attachShader(i,e),this.gl.attachShader(i,s),this.gl.linkProgram(i),this.gl.deleteShader(e),this.gl.deleteShader(s),!this.gl.getProgramParameter(i,this.gl.LINK_STATUS)){const t=`Error linking program: ${this.gl.getProgramInfoLog(i)}`;throw this.gl.deleteProgram(i),t}this.gl.useProgram(i),this.attribs.position.location=this.gl.getAttribLocation(i,"position"),this.attribs.texCoord.location=this.gl.getAttribLocation(i,"texCoord"),this.attribs.color.location=this.gl.getAttribLocation(i,"color"),this.attribs.bgColor.location=this.gl.getAttribLocation(i,"bgColor"),this.attribs.charIndex.location=this.gl.getAttribLocation(i,"charIndex"),this.initBuffers();let r=this.gl.getUniformLocation(i,"uResolution");this.gl.uniform2f(r,this.canvas.width,this.canvas.height),this.tileCountsLocation=this.gl.getUniformLocation(i,"uTileCounts"),this.gl.uniform2f(this.tileCountsLocation,this.view.w,this.view.h),this.paddingLocation=this.gl.getUniformLocation(i,"uPadding"),this.gl.uniform2f(this.paddingLocation,0,0);let a=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.cacheChars(" !\"#$%&'()*+,-./0123456789:<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.activeTexture(this.gl.TEXTURE0),setTimeout(()=>{this.updateStyle(),this.buildTexture(),this.render()},100)}getRendererString(){return"webgl"}buildTexture(){let t=this.offscreen.width/(this.tw+this.pad),e=this.offscreen.height/(this.th+this.pad);const s=this.charArray.length;s>Math.floor(t)*Math.floor(e)&&(e=(t=Math.ceil(Math.sqrt(s)))+2,this.offscreen.width=t*(this.tw+this.pad),this.offscreen.height=e*(this.th+this.pad),this.updateStyle(),this.gl.uniform2f(this.tileCountsLocation,t,e)),this.gl.uniform2f(this.paddingLocation,this.pad/this.offscreen.width,this.pad/this.offscreen.height);let i,r=0;this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.offscreen.width,this.offscreen.height),this.ctx.fillStyle="#ffffff";const a=.5*this.gap,n=this.tw+this.pad,o=this.th+this.pad;let h=.5*o;for(let s=0;s<e;++s){let e=.5*this.pad;for(let s=0;s<t&&void 0!==(i=this.charArray[r]);++s,++r)this.ctx.fillText(i,e+a,h),e+=n;if(!i)break;h+=o}this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.offscreen)}cacheChars(t,e=!0){if(!this.gl)return;let s=!1;for(let e=0;e<t.length;++e)this.charMap[t[e]]||(s=!0,this.charArray.push(t[e]),this.charMap[t[e]]=this.charArray.length-1);s&&e&&this.buildTexture()}updateStyle(t){t=t||window.getComputedStyle(this.view.elem,null),this.ctx.font=t.fontSize+"/"+t.lineHeight+" "+t.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="#ffffff",this.tw=this.ctx.measureText("幅").width,this.th=parseInt(t.fontSize,10),this.gap=this.view.squarify?this.th-this.tw:0,this.view.squarify&&(this.tw=this.th),this.pad=2*Math.ceil(.2*this.th);const e=t.color.match(/\d+/g),s=t.backgroundColor.match(/\d+/g);this.defaultColors.r=parseInt(e[0],10)/255,this.defaultColors.g=parseInt(e[1],10)/255,this.defaultColors.b=parseInt(e[2],10)/255,this.defaultColors.br=parseInt(s[0],10)/255,this.defaultColors.bg=parseInt(s[1],10)/255,this.defaultColors.bb=parseInt(s[2],10)/255}clear(){}render(){this.gl.clear(this.gl.COLOR_BUFFER_BIT);const t=this.view.w,e=this.view.h;let s=this.view.buffer,i=(this.view.defaultColor,this.view.defaultBackground,!1);for(let r=0;r<e;++r)for(let e=0;e<t;++e){const a=s[r][e];let n=this.charMap[a.ch];void 0===n&&(this.cacheChars(a.ch,!1),i=!0,n=this.charMap[a.ch]);const o=6*this.attribs.color.itemSize*(r*t+e),h=6*this.attribs.charIndex.itemSize*(r*t+e),c=void 0===a.r?this.defaultColors.r:a.r/255,l=void 0===a.g?this.defaultColors.g:a.g/255,u=void 0===a.b?this.defaultColors.b:a.b/255,d=void 0===a.br?this.defaultColors.br:a.br/255,p=void 0===a.bg?this.defaultColors.bg:a.bg/255,m=void 0===a.bb?this.defaultColors.bb:a.bb/255;for(let t=0;t<6;++t){const e=o+t*this.attribs.color.itemSize;this.attribs.color.data[e+0]=c,this.attribs.color.data[e+1]=l,this.attribs.color.data[e+2]=u,this.attribs.bgColor.data[e+0]=d,this.attribs.bgColor.data[e+1]=p,this.attribs.bgColor.data[e+2]=m,this.attribs.charIndex.data[h+t]=n}}i&&this.buildTexture(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.color.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.color.data,this.attribs.color.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.bgColor.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.bgColor.data,this.attribs.bgColor.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.charIndex.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.charIndex.data,this.attribs.charIndex.hint);const r=this.attribs.position;this.gl.drawArrays(this.gl.TRIANGLES,0,r.data.length/r.itemSize)}compileShader(t,e){const s=this.gl.createShader(t);if(this.gl.shaderSource(s,e),this.gl.compileShader(s),!this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)){const t="Error compiling shader: "+this.gl.getShaderInfoLog(s);throw this.gl.deleteShader(s),t}return s}initBuffers(){let t,e,s=this.attribs;const i=this.view.w,r=this.view.h;for(t in this.attribs)(e=s[t]).data=new Float32Array(6*e.itemSize*i*r);for(let t=0;t<r;++t)for(let e=0;e<i;++e){const r=6*s.position.itemSize*(t*i+e);this.insertQuad(s.position.data,r,e*this.tw,t*this.th,this.tw,this.th),this.insertQuad(s.texCoord.data,r,0,0,1,1)}for(t in this.attribs)(e=s[t]).buffer&&this.gl.deleteBuffer(e.buffer),e.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e.data,e.hint),this.gl.enableVertexAttribArray(e.location),this.gl.vertexAttribPointer(e.location,e.itemSize,this.gl.FLOAT,!1,0,0)}insertQuad(t,e,s,i,r,a){const n=s,o=i,h=s+r,c=i+a;t[e]=n,t[++e]=o,t[++e]=h,t[++e]=o,t[++e]=n,t[++e]=c,t[++e]=n,t[++e]=c,t[++e]=h,t[++e]=o,t[++e]=h,t[++e]=c}}(t)};var xs,Cs;!function(t){t[t.AttackerTwoHandedWeapons=0]="AttackerTwoHandedWeapons",t[t.AttackerHeavyWeapons=1]="AttackerHeavyWeapons",t[t.AttackerLightWeapons=2]="AttackerLightWeapons",t[t.AttackerTwoWeapons=3]="AttackerTwoWeapons",t[t.AttackerDoubleTwoHandedWeapons=4]="AttackerDoubleTwoHandedWeapons",t[t.AttackerStrongGrip=5]="AttackerStrongGrip"}(xs||(xs={}));class Ts extends Ue{constructor(t,e,s,i,r,a=""){super(t,e,s,i,r,a)}}class Ms extends Ts{constructor(){super(xs.AttackerTwoHandedWeapons,"Двуручные оружия",0,0,3)}onObtain(t){}}!function(t){t[t.Attacker=0]="Attacker",t[t.Defender=1]="Defender"}(Cs||(Cs={}));class Is extends Fe{constructor(t=1){super(Cs.Attacker,"Оружейник",t),this.talents.push(new Ms)}}class ks extends Fe{constructor(t=1){super(Cs.Defender,"Защитник",t),this.talents.push(new Ms)}}class Ws extends Ge{constructor(t,e=new Is,s=new ks){super([e,s],3,6),this.attacker=e,this.defender=s}}class Rs extends Dt{worksWith(t){return t instanceof Ss}}class Ps extends Dt{worksWith(t){return t instanceof Es}canThrow(t){return!!t.inventory.missileWeaponSlot.equipment}}class Ss extends Nt{worksWith(t){return t instanceof Rs}}class Es extends Nt{worksWith(t){return t instanceof Ps}}const _s=new N({}),Os=()=>new Es("Обычный лук",1,_s),As=()=>new Rs("Маленький камень",.3,_s),Ds=()=>new Ps("Деревянная стрела",.2,_s),Ns=()=>new Ps("Железная стрела",.25,_s);new ge([[1,()=>new Bt("Катана",1,[{type:le.Melee,dice:{times:5,max:2},extra:0}])],[7,()=>new Bt("Кинжал",.8,[{type:le.Melee,dice:{times:1,max:3},extra:2}])]]),new ge([[1,()=>new Ht("Кольчуга",5,[{type:Ct.Medium,value:3}])],[5,()=>new Ht("Латы",3,[{type:Ct.Heavy,value:5}])],[10,()=>new Ht("Роба",1,[{type:Ct.Unarmored,value:1}])],[100,()=>new class extends At{constructor(){super("Зелье лечения")}onDrink(t){t.player.health.increase(5)}}]]);class $s extends Ft{constructor(){super("Кроссовки скорости света",.1,[]),this.impacts=[f.Blind]}}const Bs=(t,e=[],s)=>new class extends V{constructor(t,e,s=V.getId()){super(e,s),this.ai=t}act(t,e){this.statsTurn(),this.visionMask(t);const s=this.ai.act(this,t,e);return s&&this.on(s),this.on(new m(t,e)),this.speed}get missile(){if(this.specie.throwingItem)return{item:this.specie.throwingItem,count:1}}get inventoryItems(){return this.bag?this.bag.bunch:[]}addItem(t,e){this.bag||(this.bag=new g),this.bag.put(t,e)}removeItem(t,e){if(!this.bag)throw`Creature ${this.name} tried to remove item ${t.name} but it does not present`;this.bag.remove(t,e)}}(new class extends et{constructor(){super(),this.escaper=new it,this.explorer=new rt,this.chaser=new Q,this.attacker=new K,this.picker=new at,this.patrol=new lt,this.loiter=new ot,this.thrower=new ut,this.descender=new mt}act(t,e,s){let i;return this.runEvents(),this.feelsGood(t)?(i=this.attacker.act(t,e,s))||(i=this.thrower.act(t,e,s))||(i=this.chaser.act(t,e,s))||(i=this.picker.act(t,e,s))||(i=this.explore(t,e,s)):this.healthCritical(t)&&(i=this.escaper.act(t,e,s))||(i=this.attacker.act(t,e,s))||(i=this.thrower.act(t,e,s))||(i=this.chaser.act(t,e,s))||(i=(new ft).act(t,e)),this.resetEvents(),i}feelsGood(t){return t.health.currentValue>.9*t.health.maximum}healthCritical(t){return t.health.currentValue<t.health.maximum/4}explore(t,e,s){let i;return(i=this.explorer.act(t,e,s))?t.dead||this.patrol.trackMovement(e.creaturePos(t),e.creatureTile(t)):(i=this.descender.act(t,e,s))||(i=this.patrol.act(t,e,s))||(i=this.loiter.act(t,e,s)),i}},{name:t,weight:10,clan:F.PlayerOnlyEnemy,abilities:[],protections:e,damages:s,maxHealthValue:1,regenerationRate:5,regenerationValue:1,resistances:[],visionRadius:5,moveSpeed:20,attackSpeed:20,bodyControl:5}),Ls=()=>Bs("Rat",[],[{type:le.Melee,dice:{times:2,max:2},extra:0}]),Hs=(new ge([[100,Ls],[3,()=>Bs("Golem",[{type:Ct.Solid,value:5}],[{type:le.Blunt,dice:{times:1,max:5},extra:10}])]]),new Map);Hs.set("C",()=>new class extends C{}("C",v.Floor)),Hs.set("W",()=>new I),Hs.set("R",()=>new C("R",v.Floor)),Hs.set("D",()=>new M);const Fs=1,Gs=Fs+1;class Us extends ve{enter(t,e){(t.currentMap=t.getMap(Fs)).addCreature(new o(5,2),e)}register(t){t.addMap(Fs,(t,e)=>{let s=this.generateMap(t,["WWWWWWWWWWW","WWWWRRRWWWW","WWWWRRRWWWW","WWWWRRRWWWW","WWWWWCWWWWW","WRRRWCWRRRW","WRRRCCCRRRW","WRRRWCWRRRW","WWWWWCWWWWW","WRRRWCWRRRW","WRRRCCCRRRW","WRRRWCWRRRW","WWWWWCWWWWW","WRRRWCWRRRW","WRRRCCCRRRW","WRRRWCWRRRW","WWWWWCWWWWW","WRRRWCWRRRW","WRRRCCCRRRW","WRRRWCWRRRW","WWWWWCWWWWW","WRRRWCWRRRW","WRRRCCCRRRW","WRRRWCWRRRW","WWWWWCWWWWW","WRRRWCWRRRW","WRRRCCCRRRW","WRRRWCWRRRW","WWWWWWWWWWW"]);return s.name="Traps",s.setTile(4,6,new E("Teleportation trap",!1,new T)),s.setTile(2,6,new Ve),s.setTile(6,6,new E("Light trap",!1,new T)),s.setTile(8,6,new je),s}),t.addMap(Gs,(t,e)=>{let s=this.generateMap(t,["WWWWW","WRRRW","WRRRW","WRRRW","WWWWW"]);return s.name="2nd",s.setTile(2,2,new Ve),s.addCreature(new o(2,4),Ls()),s})}generateMap(t,e){return new we(t,he(e,Hs))}}class js extends ye{constructor(t){super(t,new Ws(t))}}const Vs=120,qs=180,Ys={r:255,g:165,b:0};class zs extends gs{lighted(t){return this}constructor(t,e=Vs,s=Vs,i=Vs){super(t,e,s,i)}litBackground(t,e){return t.setBackground(Ys.r*e,Ys.g*e,Ys.b*e),t}litColor(t,e){return t.setColor(Ys.r*e,Ys.g*e,Ys.b*e),t}}class Xs extends zs{constructor(t){super(t,qs,qs,qs)}}class Js extends Xs{constructor(t,e,s,i){super(t),this.vr=e,this.vg=s,this.vb=i}lighted(t){let e=this.clone();return e.setColor(this.vr,this.vg,this.vb),e}}class Ks extends zs{constructor(t,e,s,i){super(t),this.vr=e,this.vg=s,this.vb=i}lighted(t){let e=this.clone();return e.setColor(this.vr,this.vg,this.vb),e}}const Qs=new Ks("刀",200,200,200),Zs=new Ks("体",200,200,200),ti=new Ks("胸",200,200,200),ei=new Ks("石",200,200,200),si=new Ks("]",200,200,200),ii=new Ks("[",255,255,0),ri=new Ks("！",200,200,200),ai=function(t){switch(t.group){case yt.OneHandWeapon:return Qs;case yt.Consumable:return Zs;case yt.BodyArmor:return ti;case yt.Missile:return ei;case yt.MissileWeapon:return si;case yt.Potion:return ri;case yt.Boots:return ii;default:return Zs}},ni=new class extends zs{constructor(){super("戸")}lighted(t){let e=this.clone();return this.litColor(e,t),e.swapColors(),e}},oi=new class extends zs{constructor(){super("＃")}lighted(t){let e=this.clone();return this.litBackground(e,t),e.backgroundToColor(),e}},hi=new class extends zs{constructor(){super("・")}lighted(t){return this.litColor(this.clone(),t)}},ci=new class extends zs{constructor(){super("＞")}},li=new class extends zs{constructor(){super("＜")}},ui=new zs("　",0,0,0),di=new zs("^",0,191,255),pi=new zs("^",255,255,0);const mi=new class extends _{onWall(t){this.tile=oi}onFloor(t){this.tile=hi}onStairwayDown(t){this.tile=ci}onStairwayUp(t){this.tile=li}onDoor(t){this.tile=ni}onTrap(t){if(t.revealed)switch(t.type){case w.Teleportation:this.tile=di;break;case w.Light:this.tile=pi}else this.tile=hi}onTrigger(t){t.tile.visit(this)}default(t){this.tile=ui}},gi=new Js("＠",0,255,0),fi=new Js("r",197,65,38),vi=new Js("G",120,120,120),wi=new zs("　",0,0,0),bi=[new Ks("｜",200,200,200),new Ks("／",200,200,200),new Ks("ー",200,200,200),new Ks("＼",200,200,200)];var yi=i.a.extend({props:["level","player","pos"],data:()=>({wholeMap:!1,term:null,eng:null,drawInterval:null,ts:Date.now(),interval:100,step:0}),methods:{getTile(t,e){const s=this.stage.at(t,e).effect,i=this.wholeMap?this.stage.at(t,e):this.stage.at(t,e).tile;if(!i)return wi;if(s){if(i.creature){let t=this.creatureTile(i.creature).clone();return t.setBackground(200,0,0),t}return new zs(s,200,200,0)}if(i.creature)return this.creatureTile(i.creature);if(i.items)switch(i.items.bunch.length){case 0:break;case 1:return ai(i.items.bunch[0].item);default:const t=this.step%(3*this.animationFps+4);if(t<bi.length)return bi[t];{const t=Math.floor(this.step/(3*this.animationFps+4));return ai(i.items.bunch[t%i.items.bunch.length].item)}}return function(t){return t.visit(mi),mi.tile}(i)},creatureTile:t=>"Rat"==t.name?fi:"Golem"==t.name?vi:gi,initViewport(){this.term=new class{constructor(t,e,s,i,r=!1){this.elem=t,this.w=e,this.h=s,this.squarify=r,this.cx=Math.floor(e/2),this.cy=Math.floor(s/2),this.elem.innerHTML="",-1===t.className.indexOf(fs)&&(0===t.className.length?t.className=fs:t.className+=" "+fs),this.buffer=new Array(s);for(let t=0;t<s;++t){this.buffer[t]=new Array(e);for(let s=0;s<e;++s)this.buffer[t][s]=vs}this.renderer=i(this)}updateStyle(t){const e=window.getComputedStyle(this.elem,null);this.defaultColor=e.color||void 0,this.defaultBackground=e.backgroundColor||void 0,t&&this.renderer.updateStyle(e)}getRendererString(){return this.renderer.getRendererString()}put(t,e,s){e<0||s<0||e>=this.w||s>=this.h||(this.buffer[s][e]=t)}unsafePut(t,e,s){this.buffer[s][e]=t}putString(t,e,s,i,r,a,n,o,h){const c=t.length;if(!(e<0||s<0))for(let l=0;l<c;++l){if(e>=this.w&&(e=0,++s),s>=this.h)return;const c=new gs(t[l],i,r,a,n,o,h);this.unsafePut(c,e,s),++e}}get(t,e){return t<0||e<0||t>=this.w||e>=this.h?vs:this.buffer[e][t]}clear(){for(let t=0;t<this.h;++t)for(let e=0;e<this.w;++e)this.buffer[t][e]=vs;this.renderer.clear()}render(){this.renderer.render()}}(this.$refs.scene,Math.max(this.level.width,40),Math.max(this.level.height,40),ys,!0),this.eng=new class{constructor(t,e,s,i){this.viewport=t,this.tileFunc=e,this.w=s,this.h=i,this.refreshCache=!0,this.cacheEnabled=!1,this.transitionDuration=0,this.cachex=0,this.cachey=0,this.tileCache=new Array(t.h),this.tileCache2=new Array(t.h);for(let e=0;e<t.h;++e)this.tileCache[e]=new Array(t.w),this.tileCache2[e]=new Array(t.w)}setTileFunc(t,e,s){e&&(this.transition=void 0,"string"==typeof e&&("boxin"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return t-=o,e-=h,Math.abs(t)<o*n&&Math.abs(e)<h*n?r:a}:"boxout"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return t-=o,e-=h,n=1-n,Math.abs(t)<o*n&&Math.abs(e)<h*n?a:r}:"circlein"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return(t-=o)*t+(e-=h)*e<(o*o+h*h)*n?r:a}:"circleout"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return(t-=o)*t+(e-=h)*e>(o*o+h*h)*(n=1-n)?r:a}:"random"===e&&(this.transition=function(t,e,s,i,r,a,n){return Math.random()>n?a:r})),this.transition&&(this.transitionTimer=(new Date).getTime(),this.transitionDuration=s||500)),this.tileFunc=t}setMaskFunc(t){this.maskFunc=t}setShaderFunc(t){this.shaderFunc=t}setWorldSize(t,e){this.w=t,this.h=e}setCacheEnabled(t){this.cacheEnabled=t,this.refreshCache=!0}update(t,e){t=t||0,e=e||0;const s=t-this.viewport.cx,i=e-this.viewport.cy,r=(new Date).getTime();let a,n;this.transition&&this.transitionTimer&&(a=(r-this.transitionTimer)/this.transitionDuration),a&&a>=1&&(this.transition=void 0);for(let t=0;t<this.viewport.h;++t)for(let e=0;e<this.viewport.w;++e){const o=e+s,h=t+i;if(this.w&&(o<0||o>=this.w))n=vs;else if(this.h&&(h<0||h>=this.h))n=vs;else if(this.maskFunc&&!this.maskFunc(o,h))n=vs;else if(this.transition&&!this.refreshCache)n=this.transition(e,t,this.viewport.w,this.viewport.h,this.tileFunc(o,h),this.tileCache[t][e],a||0);else if(this.cacheEnabled&&!this.refreshCache){const t=o-this.cachex,e=h-this.cachey;t>=0&&t<this.viewport.w&&e>=0&&e<this.viewport.h?(n=this.tileCache[e][t])===vs&&(n=this.tileFunc(o,h)):n=this.tileFunc(o,h)}else n=this.tileFunc(o,h);this.tileCache2[t][e]=n,this.shaderFunc&&n!==vs&&(n=this.shaderFunc(n,o,h,r)),this.viewport.unsafePut(n,e,t)}this.cachex=s,this.cachey=i;const o=this.tileCache;this.tileCache=this.tileCache2,this.tileCache2=o,this.refreshCache=!1}}(this.term,(t,e)=>this.getTile(t,e),this.level.width,this.level.height),this.eng.setMaskFunc((t,e)=>this.wholeMap||this.stage.at(t,e).seen),this.eng.setShaderFunc((t,e,s,i)=>this.lighting(t,e,s,i)),clearInterval(this.drawInterval),this.drawInterval=setInterval(()=>{this.drawScene()},this.interval)},drawScene(){const t=Date.now();this.ts+1e3<t&&(this.ts=t),this.eng.update(this.pos.x,this.pos.y),this.term.render(),this.step+=1},lighting(t,e,s,i){if(this.wholeMap)return t.lighted(1);const r=this.stage.at(e,s);return r.visible&&t.lighted?t.lighted(r.degree):t}},computed:{stage(){return this.wholeMap?this.level:this.player.stageMemory(this.level)},animationFps(){return 1e3/this.interval},tileItems(){let t=this.stage.at(this.player.pos.x,this.player.pos.y).items();return t&&t.bunch}},mounted(){this.initViewport()},beforeDestroy(){clearInterval(this.drawInterval)},watch:{interval(){this.initViewport()}}}),xi=(s(47),Object(ds.a)(yi,function(){var t=this.$createElement;return(this._self._c||t)("div",{ref:"scene",staticClass:"unicodetiles"})},[],!1,null,null,null));xi.options.__file="Scene.vue";var Ci=xi.exports,Ti=i.a.extend({name:"PrimaryAttribute",props:["name","slug","attr","fullName"],computed:{id(){return`${this.slug}-container`},modifier(){return Object(r.sum)(this.attr.modifiers)}}}),Mi=Object(ds.a)(Ti,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"simple-popover",attrs:{id:t.id}},[s("div",{staticClass:"title"},[t._v(t._s(t.name))]),s("div",{staticClass:"value"},[t._v(t._s(t.attr.current))]),s("b-popover",{attrs:{target:t.id,triggers:"hover",container:t.id,placement:"top"}},[[s("big",{staticClass:"name"},[t._v(t._s(t.fullName))]),s("p",[s("span",{staticClass:"name"},[t._v("Базовый:")]),t._v(" "),s("span",{staticClass:"description"},[t._v(t._s(t.attr.current))])]),s("p",[s("span",{staticClass:"name"},[t._v("Модификатор:")]),t._v(" "),s("span",{staticClass:"description"},[t._v(t._s(t.modifier))])])]],2)],1)},[],!1,null,null,null);Mi.options.__file="PrimaryAttribute.vue";var Ii=Mi.exports;const ki=function({extra:t,dice:{times:e,max:s},type:i}){let r=`${Wi(i)} ${e}d${s}`;return t&&(r+=`+${t}`),r},Wi=function(t){switch(t){case le.Melee:return"Me";case le.Pierce:return"Pi";case le.Blunt:return"B";case le.Magic:return"Mg";case le.Pure:return"Pu";default:return"unknown damage type"}},Ri=function({type:t,value:e}){switch(t){case Ct.Light:return`L${e}`;case Ct.Medium:return`M${e}`;case Ct.Heavy:return`H${e}`;case Ct.Solid:return`S${e}`;case Ct.Unarmored:return`U${e}`;default:return"unknown protection type"}};var Pi=i.a.extend({name:"Stats",props:["creature","levelMap"],components:{PrimaryAttribute:Ii},computed:{levelProgress(){const t=this.creature.level;return`${t.currentExperience/t.requiredExperience*100}%`},healthLevel(){const t=this.creature.health;return`${t.currentValue/(t.maximum||0)*100}%`},protections(){return this.creature.protections.map(Ri).join(", ")},damages(){return this.creature.damages.map(ki).join(", ")}},methods:{displayAttribute:t=>t.currentValue!=t.maximum?`${t.currentValue} / ${t.maximum}`:t.currentValue}}),Si=(s(49),Object(ds.a)(Pi,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"panel container"},[s("div",{staticClass:"level cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.creature.level.current))]),s("div",{staticClass:"note"},[t._v("Уровень"),s("div",{staticClass:"progress"},[s("div",{staticClass:"progress-bar bg-success",style:{width:t.levelProgress},attrs:{role:"progressbar"}})])])]),s("div",{staticClass:"hp cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.displayAttribute(t.creature.health)))]),s("div",{staticClass:"bar",style:{height:t.healthLevel}})]),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"strength",name:"St","full-name":"Сила",attr:t.creature.strength}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"dexterity",name:"Dx","full-name":"Ловкость",attr:t.creature.dexterity}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"constitution",name:"Co","full-name":"Телосложение",attr:t.creature.constitution}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"intelligence",name:"In","full-name":"Интеллект",attr:t.creature.intelligence}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"wisdom",name:"Ws","full-name":"Мудрость",attr:t.creature.wisdom}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"charisma",name:"Ch","full-name":"Харизма",attr:t.creature.charisma}}),s("div",{staticClass:"cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.levelMap.name))])]),s("div",{staticClass:"cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.protections))])]),s("div",{staticClass:"cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.damages))])])],1)},[],!1,null,"20a5072e",null));Si.options.__file="Stats.vue";var Ei=Si.exports,_i=i.a.extend({name:"Impacts",props:["impacts"],methods:{icon(t){switch(t){case f.Blind:return"blind";case f.Stressed:case f.Loaded:case f.Overloaded:return"weight"}},title(t){switch(t){case f.Blind:return"Слепота";case f.Stressed:return"Нагружен";case f.Loaded:return"Груженый";case f.Overloaded:return"Перегруженый"}}}}),Oi=(s(51),Object(ds.a)(_i,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"panel"},t._l(t.impacts,function(e){return s("div",{staticClass:"impact-block"},[s("img",{staticClass:"icon",attrs:{src:"assets/impacts/"+t.icon(e)+".svg"}}),s("div",{staticClass:"title",domProps:{textContent:t._s(t.title(e))}})])}))},[],!1,null,"436b0ad3",null));Oi.options.__file="Impacts.vue";var Ai=Oi.exports,Di=i.a.extend({name:"IdleView",props:["screen"],methods:{onEvent(t){switch(t.key){case"l":case"ArrowRight":return this.screen.move(u.right);case"h":case"ArrowLeft":return this.screen.move(u.left);case"k":case"ArrowUp":return this.screen.move(u.up);case"j":case"ArrowDown":return this.screen.move(u.down);case"y":return this.screen.move(u.upLeft);case"u":return this.screen.move(u.upRight);case"b":return this.screen.move(u.downLeft);case"n":return this.screen.move(u.downRight);case"H":return this.screen.handleCommand();case"L":return this.screen.lookCommand();case"s":case".":return this.screen.stayCommand();case"i":return this.screen.inventoryCommand();case"I":return this.screen.bagCommand();case"t":return this.screen.missileCommand();case",":return this.screen.pickUpCommand();case"d":return this.screen.dropCommand();case"D":return this.screen.drinkCommand();default:console.log("Key: ",t.key)}}}}),Ni=Object(ds.a)(Di,function(){var t=this.$createElement;return(this._self._c||t)("div")},[],!1,null,null,null);Ni.options.__file="IdleView.vue";var $i=Ni.exports,Bi=i.a.extend({props:["screen"],data:()=>({picked:null}),methods:{close(t){const e=t||this.picked;e&&this.screen.pickProfession(e)},onEvent(t){switch(t.key){case"a":this.picked=this.screen.options[0];break;case"b":this.picked=this.screen.options[1];break;case" ":case"Enter":this.close();default:return}},iconPath:t=>"assets/professions/"+["acrobatic.svg","button-finger.svg","disintegrate.svg","flying-fox.svg","amputation.svg","catch.svg","divert.svg","fruiting.svg","annexation.svg","conversation.svg","dodging.svg","grab.svg","arrest.svg","convince.svg","drinking.svg","journey.svg","back-forth.svg","coronation.svg","drop-weapon.svg","juggler.svg","backstab.svg","crafting.svg","drowning.svg","jump-across.svg","boot-stomp.svg","crush.svg","eating.svg","kindle.svg","bowman.svg","discussion.svg","expander.svg","kneeling.svg"][t]}}),Li=(s(53),Object(ds.a)(Bi,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal text-center"},[s("div",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("div",{staticClass:"content"},t._l(t.screen.options,function(e){return s("div",{key:e.id,staticClass:"option p-2 m-3",class:{picked:t.picked&&t.picked.id===e.id},on:{click:function(s){t.picked=e},dblclick:function(s){t.close(e)}}},[s("img",{staticClass:"icon",attrs:{src:t.iconPath(e.id)}}),s("div",{staticClass:"name"},[t._v(t._s(e.name))])])})),s("div",{staticClass:"bottom"},[null!==t.picked?s("b-btn",{attrs:{variant:"success"},on:{click:t.close}},[t._v("Подтвердить")]):t._e()],1)])},[],!1,null,null,null));Li.options.__file="ProfessionPickingView.vue";var Hi=Li.exports;var Fi=i.a.extend({name:"Inventory",props:["screen"],data:()=>({page:0,perPage:20,selected:[]}),computed:{player(){return this.screen.player},carryingWeight(){return`Нагрузка ${Math.round(100*this.player.stuffWeight.current)/100} из ${this.player.carryingCapacity.stressed}`}},methods:{onEvent(t){switch(t.key){case"Escape":return this.screen.close();case"Enter":case" ":return this.screen.pickUpItems(this.selected.map(t=>this.screen.positions[t]));default:return this.selectAt(t.key.charCodeAt(0)-97)}},selectAt(t){t>=0&&t<Math.min(this.perPage,this.screen.positions.length)&&(this.screen.singleItemMode?this.screen.withItem(this.screen.positions[t]):this.selected.indexOf(t)>=0?this.selected.splice(this.selected.indexOf(t),1):this.selected.push(t))},indexLetter:t=>String.fromCharCode(97+t),positionSelected(t){return this.selected.indexOf(t)>=0},positionStatus:t=>t.item?"text-success":"",itemWeight:t=>t.item.weight*t.count}}),Gi=(s(55),Object(ds.a)(Fi,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("span",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("div",{staticClass:"subtitle my-3",domProps:{textContent:t._s(t.carryingWeight)}}),s("table",{staticClass:"container positions-list"},t._l(t.screen.positions,function(e,i){return s("tr",{key:i,class:t.positionStatus(e)},[s("td",{staticClass:"selected"},[t.positionSelected(i)?s("div",{staticClass:"sign"},[t._v("+")]):t._e()]),s("td",{staticClass:"letter"},[t._v(t._s(t.indexLetter(i)))]),s("td",{staticClass:"separator"},[t._v("—")]),s("td",{staticClass:"name"},[t._v(t._s(e.item.name)+" ("+t._s(e.count)+")")]),s("td",{staticClass:"weight"},[t._v("["+t._s(t.itemWeight(e))+"kg]")])])}))])},[],!1,null,null,null));Gi.options.__file="ItemsListingView.vue";var Ui=Gi.exports;var ji=i.a.extend({props:["screen"],data:()=>({picked:null,professionIndex:0}),computed:{option(){return this.screen.options[this.professionIndex]},profession(){return this.option.profession},groupedTalents(){let t=new Array(5);for(let e=0;e<t.length;e++)t[e]=[];let e=0;return this.option.talents.forEach(s=>{s.status===de.Available&&Object.assign(s,{letter:String.fromCharCode(97+e++)}),t[s.depth].push(s)}),t}},methods:{close(t){const e=t||this.picked;e&&e.status===de.Available&&(this.screen.pickTalent(this.profession.id,e.id),this.picked=null)},pickTalent(t){t.status===de.Available&&(this.picked=t)},onEvent(t){switch(t.key){case" ":case"Enter":this.close();default:this.groupedTalents.forEach(e=>e.forEach(e=>{e.letter===t.key&&(this.picked=e)}));const e=parseInt(t.key);e>=1&&e<=this.screen.options.length&&(this.professionIndex=e-1)}},talentTip(t){let e=`${t.rank}/${t.maxRank}`;return t.rank>=t.maxRank?e:`${t.letter} ${e}`},talentStatus(t){if(this.picked&&this.picked.id===t.id)return"-selected";switch(t.status){case de.Available:return"-available";case de.Unavailable:return"-unavailable";case de.Completed:return"-completed"}},iconPath(t){switch(t){case xs.AttackerTwoHandedWeapons:return"AttackerTwoHandedWeapons.svg";case xs.AttackerHeavyWeapons:return"AttackerHeavyWeapons.svg";case xs.AttackerLightWeapons:return"AttackerLightWeapons.svg";case xs.AttackerTwoWeapons:return"AttackerTwoWeapons.svg";case xs.AttackerDoubleTwoHandedWeapons:return"AttackerDoubleTwoHandedWeapons.svg";case xs.AttackerStrongGrip:return"AttackerStrongGrip.svg"}}},watch:{professionIndex(){this.picked=null}}}),Vi=(s(57),Object(ds.a)(ji,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"simple-popover screen-modal text-center",attrs:{id:"talents-tree-container"}},[s("div",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("b-tabs",{staticClass:"tabs-list",attrs:{card:""},model:{value:t.professionIndex,callback:function(e){t.professionIndex=e},expression:"professionIndex"}},t._l(t.screen.player.professions,function(t){return s("b-tab",{key:t.id,attrs:{title:t.name,"no-body":""}})})),s("table",{staticClass:"content"},t._l(t.groupedTalents,function(e,i){return s("tr",{key:i},t._l(e,function(e,r){return s("td",{key:r,staticClass:"cell"},[s("div",{staticClass:"talent-cell",class:t.talentStatus(e),attrs:{id:r+"talentTree-"+i,variant:"primary"},on:{click:function(s){t.pickTalent(e)},dblclick:function(s){t.close(e)}}},[s("img",{staticClass:"icon",attrs:{src:"assets/talents/"+t.iconPath(e.id)}}),s("span",{staticClass:"level"},[t._v(t._s(t.talentTip(e)))]),s("b-popover",{attrs:{target:r+"talentTree-"+i,triggers:"hover",container:"talents-tree-container"}},[[s("p",{staticClass:"name"},[t._v(t._s(e.name))]),s("small",[s("p",{staticClass:"rank"},[t._v("Уровень "+t._s(e.rank)+"/"+t._s(e.maxRank))]),"-unavailable"===t.talentStatus(e)?s("p",{staticClass:"requirements"},[t._v("Требуется "+t._s(e.depth*t.profession.depthCost)+" очков в "+t._s(t.profession.name))]):t._e(),s("p",{staticClass:"description"},[t._v(t._s(e.description))])])]],2)],1)])}))})),null!==t.picked?s("b-btn",{attrs:{variant:"default"},on:{click:function(e){t.close()}}},[t._v("Подтвердить")]):t._e()],1)},[],!1,null,null,null));Vi.options.__file="TalentsTreeView.vue";var qi=Vi.exports;var Yi=i.a.extend({name:"Inventory",props:["screen"],data:()=>({page:0,perPage:20}),computed:{player(){return this.screen.player},carryingWeight(){return`Нагрузка ${Math.round(100*this.player.stuffWeight.current)/100} из ${this.player.carryingCapacity.stressed}`}},methods:{onEvent(t){switch(t.key){case" ":case"Escape":return this.screen.close();default:return this.selectAt(t.key.charCodeAt(0)-97)}},selectAt(t){if(t>=0&&t<Math.min(this.perPage,this.screen.positions.length)){const e=this.screen.positions[t];e.item?this.screen.takeOff(e):e.availableItems.length&&this.screen.putOn(e)}},positionDetails(t){if(t.item&&t.item.canSeeDetails)return function(t){return t instanceof $t?t.damages.map(ki).join(","):t instanceof Lt?t.protections.map(Ri).join(","):void 0}(t.item)},indexLetter:t=>String.fromCharCode(97+t),positionStatus:t=>t.item?"text-success":"",displayBodyPart:t=>t.name,displayItem(t){if(t)return`${ai(t).getChar()} ${t.name}`},itemName:t=>t.item&&t.count?`${t.item.name} ${t.count>1?`(${t.count})`:""}`:"-",itemWeight(t){if(t.item&&t.count)return`[${t.item.weight*t.count}kg]`},available:t=>t.item||t.availableItems.length,availableStatus(t){return this.available(t)?"-available":"-unavailable"}}}),zi=(s(59),Object(ds.a)(Yi,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("div",{staticClass:"h4 title"},[t._v("Инвентарь")]),s("div",{staticClass:"subtitle my-3",domProps:{textContent:t._s(t.carryingWeight)}}),s("table",{staticClass:"content inventory-list"},t._l(t.screen.positions,function(e,i){return s("tr",{key:i,class:t.availableStatus(e)},[s("td",{staticClass:"slot"},[s("span",{staticClass:"letter"},[t._v(t._s(t.indexLetter(i)))]),s("span",{staticClass:"dash"},[t._v("—")]),s("span",{staticClass:"part"},[t._v(t._s(t.displayBodyPart(e.inventorySlot)))]),s("span",{staticClass:"separator"},[t._v(":")])]),s("td",{staticClass:"name-slot"},[s("span",{staticClass:"name",class:t.positionStatus(e)},[t._v(t._s(t.itemName(e)))]),s("small",{staticClass:"details",domProps:{textContent:t._s(t.positionDetails(e))}})]),s("td",{staticClass:"weight"},[t._v(t._s(t.itemWeight(e)))])])}))])},[],!1,null,null,null));zi.options.__file="InventoryView.vue";var Xi=zi.exports,Ji=i.a.extend({name:"LookView",props:["screen"],computed:{title(){switch(this.screen.title){case pe.See:return"Вижу ...";case pe.Recall:return"Вспоминаю ...";case pe.Hidden:return"Без понятия ...";default:return this.screen.title}}},methods:{close(t){this.screen.onInput(t)},onEvent(t){switch(t.key){case"l":case"ArrowRight":return this.screen.moveTarget(u.right);case"h":case"ArrowLeft":return this.screen.moveTarget(u.left);case"k":case"ArrowUp":return this.screen.moveTarget(u.up);case"j":case"ArrowDown":return this.screen.moveTarget(u.down);case"y":return this.screen.moveTarget(u.upLeft);case"u":return this.screen.moveTarget(u.upRight);case"b":return this.screen.moveTarget(u.downLeft);case"n":return this.screen.moveTarget(u.downRight);case"Escape":case" ":this.screen.close()}}}}),Ki=(s(61),Object(ds.a)(Ji,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"look-modal"},[s("div",{staticClass:"title",domProps:{textContent:t._s(t.title)}}),t._l(t.screen.body,function(e){return s("div",{domProps:{textContent:t._s(e)}})})],2)},[],!1,null,"500ea8d4",null));Ki.options.__file="LookView.vue";var Qi=Ki.exports,Zi=i.a.extend({name:"MissileView",props:["screen"],methods:{close(t){this.screen.onInput(t)},onEvent(t){switch(t.key){case"l":case"ArrowRight":return this.screen.moveTarget(u.right);case"h":case"ArrowLeft":return this.screen.moveTarget(u.left);case"k":case"ArrowUp":return this.screen.moveTarget(u.up);case"j":case"ArrowDown":return this.screen.moveTarget(u.down);case"y":return this.screen.moveTarget(u.upLeft);case"u":return this.screen.moveTarget(u.upRight);case"b":return this.screen.moveTarget(u.downLeft);case"n":return this.screen.moveTarget(u.downRight);case">":this.screen.nextTarget();break;case"<":this.screen.previousTarget();break;case"t":this.screen.attack();break;case"Escape":this.screen.close()}}}}),tr=Object(ds.a)(Zi,function(){var t=this.$createElement;return(this._self._c||t)("div")},[],!1,null,null,null);tr.options.__file="MissileView.vue";var er=tr.exports,sr=i.a.extend({name:"DeathView",props:["screen"],computed:{message(){switch(this.screen.dieReason){case Tt.Attack:return"Смерть в бою честь для героя. Но жить мне все-таки нравилось больше";case Tt.Missile:return"Раньше меня вела дорога приключений, но теперь и мне прострелили колено";case Tt.Trap:return"Я так и не научился смотреть под ноги";case Tt.Overloaded:return"Тяжко уйти от бремени, которое сам себе навязываешь.";default:return"Скучная смерть, которая даже не заслужила отдельного сообщения"}},signature(){return`Признался ${this.screen.playerName} перед смертью`}},methods:{onEvent(t){}}}),ir=(s(63),Object(ds.a)(sr,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"screen-modal"},[e("div",{staticClass:"h4 title"},[this._v("Ты умер")]),e("div",{staticClass:"content mt-5"},[e("blockquote",{staticClass:"blockquote text-center signature"},[e("p",{staticClass:"mb-0",domProps:{textContent:this._s(this.message)}}),e("footer",{staticClass:"blockquote-footer",domProps:{textContent:this._s(this.signature)}})])])])},[],!1,null,null,null));ir.options.__file="DeathView.vue";var rr=ir.exports;var ar=i.a.extend({name:"PickSingleOptionView",props:["screen"],data:()=>({page:0,perPage:20,selected:[]}),computed:{title(){switch(this.screen.type){case vt.PickHandleOption:return"С чем взаимодействовать?"}}},methods:{optionName(t){switch(this.screen.type){case vt.PickHandleOption:return t[0]}},onEvent(t){switch(t.key){case"Escape":return this.screen.close();case"Enter":case" ":return this.screen.pickUpItems(this.selected.map(t=>this.screen.positions[t]));default:return this.selectAt(t.key.charCodeAt(0)-97)}},selectAt(t){t>=0&&t<Math.min(this.perPage,this.screen.options.length)&&this.screen.pick(this.screen.options[t])},indexLetter:t=>String.fromCharCode(97+t)}}),nr=(s(65),Object(ds.a)(ar,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("span",{staticClass:"title",domProps:{textContent:t._s(t.title)}}),s("table",{staticClass:"container options-list"},t._l(t.screen.options,function(e,i){return s("tr",{key:i},[s("td",{staticClass:"letter"},[t._v(t._s(t.indexLetter(i)))]),s("td",{staticClass:"separator"},[t._v("—")]),s("td",{staticClass:"name",domProps:{textContent:t._s(t.optionName(e))}})])}))])},[],!1,null,"08d3fe9c",null));nr.options.__file="PickSingleOptionView.vue";var or=nr.exports,hr=s(19),cr=i.a.extend({data:()=>({game:(new class{constructor(){this.game=new js(this.initPlayer());const t=new Us;t.register(this.game),t.enter(this.game,this.game.player);const e=this.game.player,s=this.game.professionPicker.available(e)[1];s&&e.professions.push(s);const i=new Bt("Кинжал",.8,[{type:le.Melee,dice:{times:1,max:3},extra:2}]),r=new Bt("Катана",1,[{type:le.Melee,dice:{times:5,max:2},extra:0}]),a=new Ht("Латы",1,[{type:Ct.Heavy,value:5}]),n=Ds(),o=Ns(),h=As(),c=Os();if(this.game.currentMap){const t=this.game.currentMap.creatureTile(e);t.addItem(i,2),t.addItem(r,1),t.addItem(a,1),t.addItem(n,5),t.addItem(o,5),t.addItem(h,5),t.addItem(c,2),e.on(new te(t,[{item:i,count:2},{item:r,count:1},{item:a,count:1},{item:n,count:5},{item:o,count:5},{item:h,count:5},{item:c,count:2}],this.game)),e.on(new ee(e.inventory.missileWeaponSlot,c,this.game)),e.on(new ee(e.inventory.missileSlot,n,this.game)),e.on(new ee(e.inventory.rightHandSlot,r,this.game)),e.on(new ee(e.inventory.chestSlot,a,this.game)),e.addItem(new $s,1),this.game.logger.reset()}}initPlayer(){return new He(new me([1,3,5,10,20]),new Rt,{name:"Player",weight:80,clan:F.Player,abilities:U,protections:[],damages:[],maxHealthValue:10,regenerationRate:30,regenerationValue:1,resistances:[],visionRadius:10,moveSpeed:20,attackSpeed:20,bodyControl:5},12,15)}}).game,ts:Date.now(),loopIntervalId:void 0}),components:{Impacts:Ai,Logger:ms,Scene:Ci,Stats:Ei},computed:{viewComponent(){switch(this.game.ai&&this.game.ai.presenter&&this.game.ai.presenter.type){case vt.AbilitiesPicking:return qi;case vt.ProfessionPicking:return Hi;case vt.Idle:return $i;case vt.ItemsListing:return Ui;case vt.Inventory:return Xi;case vt.Missile:return er;case vt.Teleportation:case vt.Look:return Qi;case vt.Death:return rr;case vt.PickHandleOption:return or;default:throw`App: unknown presenter ${this.game.ai.presenter}`}}},methods:{loop(){this.game.turn()},onEvent(t){const e=this.$refs.viewComponent;e&&e.onEvent(t)}},created(){this.loopIntervalId=Object(hr.setInterval)(this.loop,10),document.addEventListener("keydown",this.onEvent)},beforeDestroy(){Object(hr.clearInterval)(this.loopIntervalId),document.removeEventListener("keydown",this.onEvent)}}),lr=(s(67),Object(ds.a)(cr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return t.game?s("div",{staticClass:"container-fluid",attrs:{id:"app"}},[t.game.player?s("Scene",{staticClass:"scene",attrs:{level:t.game.currentMap,player:t.game.player,pos:t.game.currentMap.creaturePos(t.game.player)}}):t._e(),t.game.player?s("Stats",{staticClass:"player-stats",attrs:{creature:t.game.player,"level-map":t.game.currentMap}}):t._e(),s("Logger",{staticClass:"logger-panel",attrs:{logger:t.game.logger}}),s("Impacts",{staticClass:"effect-panel",attrs:{impacts:t.game.player.impacts}}),t.game.ai?s(t.viewComponent,{ref:"viewComponent",tag:"component",attrs:{screen:t.game.ai.presenter}}):t._e()],1):t._e()},[],!1,null,null,null));lr.options.__file="App.vue";var ur=lr.exports,dr=s(28);s(77),s(79),s(81);i.a.use(dr.a),new i.a({el:"#app",render:t=>t(ur)})}]);
//# sourceMappingURL=main.6fe7827b.js.map
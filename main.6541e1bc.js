!function(t){function e(e){for(var i,n,o=e[0],h=e[1],l=e[2],u=0,d=[];u<o.length;u++)n=o[u],r[n]&&d.push(r[n][0]),r[n]=0;for(i in h)Object.prototype.hasOwnProperty.call(h,i)&&(t[i]=h[i]);for(c&&c(e);d.length;)d.shift()();return a.push.apply(a,l||[]),s()}function s(){for(var t,e=0;e<a.length;e++){for(var s=a[e],i=!0,o=1;o<s.length;o++){var h=s[o];0!==r[h]&&(i=!1)}i&&(a.splice(e--,1),t=n(n.s=s[0]))}return t}var i={},r={0:0},a=[];function n(e){if(i[e])return i[e].exports;var s=i[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=i,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(s,i,function(e){return t[e]}.bind(null,i));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/onisun/";var o=window.webpackJsonp=window.webpackJsonp||[],h=o.push.bind(o);o.push=e,o=o.slice();for(var l=0;l<o.length;l++)e(o[l]);var c=h;a.push([37,1]),s()}([,,,,,,,function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},,,,,,,,,,,,,,,,,,function(t,e,s){t.exports=s(109)},,,,,,,,,,,,,,,,,,,,,,,,,,,function(t,e,s){},,,,,,,,,,,,,,,,,,,function(t,e,s){"use strict";var i=s(7);s.n(i).a},,function(t,e,s){"use strict";var i=s(8);s.n(i).a},,function(t,e,s){"use strict";var i=s(9);s.n(i).a},,function(t,e,s){"use strict";var i=s(10);s.n(i).a},,function(t,e,s){"use strict";var i=s(11);s.n(i).a},,function(t,e,s){"use strict";var i=s(12);s.n(i).a},,function(t,e,s){"use strict";var i=s(13);s.n(i).a},,function(t,e,s){"use strict";var i=s(14);s.n(i).a},,function(t,e,s){"use strict";var i=s(15);s.n(i).a},,function(t,e,s){"use strict";var i=s(16);s.n(i).a},,function(t,e,s){"use strict";var i=s(17);s.n(i).a},,function(t,e,s){"use strict";var i=s(18);s.n(i).a},,function(t,e,s){"use strict";var i=s(19);s.n(i).a},,function(t,e,s){"use strict";s.r(e);var i=s(1),r=s(36),a=s(34),n=s.n(a),o=(s(64),s(66),s(68),s(0));const h=function(t,e,s){let i=Array(t);for(let r=0;r<t;r++){i[r]=new Array(e);for(let t=0;t<e;t++)i[r][t]=s(r,t)}return i};class l{constructor(t,e){this.x=t,this.y=e}eq(t){return this.x===t.x&&this.y===t.y}nextTo(t){return Math.abs(this.x-t.x)<=1&&Math.abs(this.y-t.y)<=1}copy(){return new l(this.x,this.y)}add(t){return new l(this.x+t.x,this.y+t.y)}wrappers(){return l.dxy.map(t=>this.add(t))}}l.dxy=[new l(-1,-1),new l(0,-1),new l(1,-1),new l(-1,0),new l(1,0),new l(-1,1),new l(0,1),new l(1,1)];class c{constructor(t){this.map=t,this.width=t.length,this.height=t[0].length}at(t,e){return this.map[t][e]}inRange(t){return t.x>=0&&t.y>=0&&t.x<this.width&&t.y<this.height}each(t){this.map.forEach((e,s)=>{e.forEach((e,i)=>{t(e,s,i)})})}}const u=function(t,e,s){let[i,r,a,n]=[t.x,e.x,t.y,e.y],o=Math.max(Math.abs(i-r),Math.abs(a-n));const h=new l((r-i)/o,(n-a)/o);for(;o>1;)i+=h.x,a+=h.y,s(Math.round(i),Math.round(a)),o-=1},d=function(t,e,s){u(t,e,s),s(e.x,e.y)};class p extends l{constructor(t,e){super(t,e)}multiple(t){return new l(this.x*t,this.y*t)}}p.up=new p(0,-1),p.down=new p(0,1),p.left=new p(-1,0),p.right=new p(1,0),p.upLeft=new p(-1,-1),p.upRight=new p(1,-1),p.downLeft=new p(-1,1),p.downRight=new p(1,1),p.all=[p.up,p.down,p.left,p.right,p.upLeft,p.upRight,p.downLeft,p.downRight];class m{affectPlayer(t){return this.affectCreature(t)}}class g extends m{affectCreature(t){return Y.NOTHING}}class f extends g{constructor(t,e){super(),this.levelMap=t,this.game=e}affectPlayer(t){return t.removeImpact(w.Overloaded,"bag"),t.removeImpact(w.Stressed,"bag"),t.removeImpact(w.Loaded,"bag"),t.stuffWeight.current>t.carryingCapacity.flattenedStart?t.on(new Jt(this.game,this.levelMap,Tt.Overloaded)):(t.stuffWeight.current>t.carryingCapacity.overloadedStart?t.addImpact(w.Overloaded,"bag"):t.stuffWeight.current>t.carryingCapacity.loadedStart?t.addImpact(w.Loaded,"bag"):t.stuffWeight.current>t.carryingCapacity.stressed&&t.addImpact(w.Stressed,"bag"),Y.NOTHING)}}class v{constructor(){this.bunch=[]}find(t){return this.bunch.find(e=>e.item.groupsWith(t))}remove(t,e){const s=this.find(t);void 0!==s&&(s.count===e?Object(o.remove)(this.bunch,t=>t.item.groupsWith(s.item)):s.count-=e)}put(t,e){const s=this.bunch.find(e=>e.item.groupsWith(t));s?s.count+=e:this.bunch.push({count:e,item:t})}clone(){let t=new v;return this.bunch.forEach(e=>{t.put(e.item,e.count)}),t}}var w,y,b;!function(t){t[t.Blind=0]="Blind",t[t.Stressed=1]="Stressed",t[t.Loaded=2]="Loaded",t[t.Overloaded=3]="Overloaded"}(w||(w={}));class x{constructor(){this.constEffects=[],this.tempEffects=0}addTempEffect(t){this.tempEffects+=t}addConstEffect(t){this.constEffects.push(t)}removeTempEffect(){this.tempEffects=0}removeConstEffect(t){Object(o.remove)(this.constEffects,e=>e===t)}active(){return this.tempEffects>0||this.constEffects.length>0}turn(){this.tempEffects>=1&&(this.tempEffects-=1)}}class T{constructor(){this.impacts=new Map}get activeImpacts(){let t=[];return this.impacts.forEach((e,s)=>{e.active()&&t.push(s)}),t}addImpact(t,e){this.impactByType(t).addTempEffect(e)}removeImpact(t){this.impactByType(t).removeTempEffect()}addConstImpact(t,e){this.impactByType(t).addConstEffect(e)}removeConstImpact(t,e){this.impactByType(t).removeConstEffect(e)}turn(){this.impacts.forEach(t=>t.turn())}impactByType(t){let e=this.impacts.get(t);return void 0!==e?e:(e=new x,this.impacts.set(t,e),e)}}!function(t){t[t.Wall=0]="Wall",t[t.Door=1]="Door",t[t.Floor=2]="Floor",t[t.StairwayDown=3]="StairwayDown",t[t.StairwayUp=4]="StairwayUp",t[t.Trap=5]="Trap",t[t.Trigger=6]="Trigger"}(y||(y={}));class C{constructor(t,e){this.key=t,this.kind=e}addItem(t,e){this.items||(this.items=new v),this.items.put(t,e)}free(t){return this.isFloor()&&this.passibleThrough(t)}isFloor(){return this.kind===y.Floor}visibleThrough(){return!0}passibleThrough(t){return t&&this.creature?this.kind!==y.Wall&&this.creature.id===t.id:this.kind!==y.Wall&&!this.creature}clone(t=this){let e=this.buildNew();return t.creature&&(e.creature=t.creature),e.items=t.items&&t.items.clone(),e}}class W extends C{visibleThrough(){return!0}visit(t){t.onFloor(this)}buildNew(){return new W(this.key,this.kind)}}class M extends W{}class I extends W{constructor(){super("R",y.Floor)}}class R extends C{constructor(){super("D",y.Door)}visibleThrough(){return!1}visit(t){t.onDoor(this)}buildNew(){return new R}}class k extends C{constructor(){super("W",y.Wall)}visibleThrough(){return!1}visit(t){t.onWall(this)}buildNew(){return new k}}class S extends C{constructor(t,e,s,i){super(t,e),this.currentMap=s,this.adjacentMapName=i}enterPos(t,e){return this._enterPos?this._enterPos:this._enterPos=e.matchStairs(t.name)}visibleThrough(){return!0}}class P extends S{constructor(t,e){super(">",y.StairwayDown,t,e)}visit(t){t.onStairwayDown(this)}buildNew(){return new P(this.currentMap,this.adjacentMapName)}}class E extends S{constructor(t,e){super("<",y.StairwayUp,t,e)}visit(t){t.onStairwayUp(this)}buildNew(){return new E(this.currentMap,this.adjacentMapName)}}!function(t){t[t.AirBlow=0]="AirBlow",t[t.BareWire=1]="BareWire",t[t.FallingRock=2]="FallingRock",t[t.Hole=3]="Hole",t[t.Light=4]="Light",t[t.Teleportation=5]="Teleportation",t[t.Water=6]="Water"}(b||(b={}));class O extends C{constructor(t,e,s=!1){super("^",y.Trap),this.type=t,this.tile=e,this.revealed=s}visit(t){t.onTrap(this)}disarmTile({x:t,y:e},s,i,r){r.logger.succeededToUntrap(s),i.setTile(t,e,this.tile.clone(this))}}class _ extends C{constructor(t=!0,e){super("T",y.Trigger),this.singleUse=t,this.tile=e}visit(t){t.onTrigger(this)}activate(t,e,s){if(this.singleUse){const{x:t,y:i}=e.creaturePos(s),r=this.clone();r.creature=s,e.setTile(t,i,r)}this.onTrigger(t,e,s)}buildNew(){return this.tile.clone()}}class N extends _{constructor(t,e=!0,s){super(e,s),this.message=t}onTrigger(t){t.logger.info(this.message)}}class D{onWall(t){this.default(t)}onFloor(t){this.default(t)}onStairwayDown(t){this.onStairway(t)}onStairwayUp(t){this.onStairway(t)}onDoor(t){this.default(t)}onTrigger(t){this.default(t)}onTrap(t){this.default(t)}onStairway(t){this.default(t)}default(t){}}const A=function(t,e,s,i){new class{constructor(t,e,s,i,r,a,n){this.startx=t,this.starty=e,this.radius=s,this.width=i,this.height=r,this.solidChecker=a,this.markVisible=n,this.doubleRadius=this.radius*this.radius}calc(){this.markVisible(this.startx,this.starty,1),this.solidChecker.isSolid(this.startx,this.starty)||[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([t,e])=>{this.castLight(1,1,0,0,t,e,0),this.castLight(1,1,0,t,0,0,e)})}castLight(t,e,s,i,r,a,n){if(e<s)return;let o=0,h=!1;for(let l=t;l<=this.radius&&!h;l++){let t=-l;for(let c=-l;c<=0;c++){let u=Math.round(this.startx+c*i+t*r),d=Math.round(this.starty+c*a+t*n),p=(c-.5)/(t+.5),m=(c+.5)/(t-.5);if(u>=0&&d>=0&&u<this.width&&d<this.height&&!(e<m)){if(s>p)break;this.doubleDistance(c,t)<=this.doubleRadius&&this.markVisible(u,d,1-this.doubleDistance(c,t)/this.doubleRadius),h?this.solidChecker.isSolid(u,d)?o=m:(h=!1,e=o):this.solidChecker.isSolid(u,d)&&l<this.radius&&(h=!0,this.castLight(l+1,e,p,i,r,a,n),o=m)}}}}doubleDistance(t,e){return t*t+e*e}}(t.x,t.y,e,i.width,i.height,new class extends D{constructor(t,e){super(),this.stage=t,this.pos=e,this.visible=!1}isSolid(t,e){return this.x=t,this.y=e,this.stage.at(t,e).visit(this),!this.visible}onDoor(t){this.visible=this.pos.x===this.x&&this.pos.y===this.y}default(t){this.x&&this.y&&(this.visible=this.stage.visibleThrough(this.x,this.y))}}(i,t),(t,e,r)=>{s.at(t,e).see(i.at(t,e),r)}).calc()};class B{constructor(t,e=t){this.max=t,this.current=e,this.modifiers=[]}get maximum(){return this.max}get atMax(){return this.max===this.current}decrease(t){this.current-=t}increase(t){this.current=Math.min(this.current+t,this.max)}constantIncrease(t){this.max+=t,this.increase(t)}constantDecrease(t){this.max-=t,this.decrease(t)}addModifier(t){this.modifiers.push(t)}removeModifier(t){Object(o.remove)(this.modifiers,e=>e===t)}get currentValue(){return this.current+Object(o.sum)(this.modifiers)}}class ${constructor(t,e=1,s=0){this.base=t,this.rate=e,this.extra=s}get current(){return this.base*this.rate-this.extra}add(t){this.base+=t}subtract(t){this.base-=t}}class H{constructor(t,e){this.strength=t,this.constitution=e,this.strengthRatio=5,this.constitutionRatio=3,this.base=10}recalculate(t,e){this.strength=t,this.constitution=e}get stressed(){return this.base+this.strength*this.strengthRatio+this.constitution*this.constitutionRatio}get loadedStart(){return 1.5*this.stressed}get overloadedStart(){return 2*this.loadedStart}get flattenedStart(){return 3*this.overloadedStart}}class F extends B{constructor(t,e=0,s=t.maxHealthValue){super(t.maxHealthValue,s),this.currentTurn=e,this.regenerationRate=t.regenerationRate,this.regenerationValue=t.regenerationValue}turn(){this.currentTurn+=1,this.currentTurn>=this.regenerationRate&&(this.currentTurn=0,this.increase(this.regenerationValue))}}class L extends ${get meleeAdjustment(){return this.current<5?-2:this.current>10?Math.floor((this.current-10)/2):0}}class G extends ${get levelUpHPBonus(){return this.current<3?-2:this.current<6?-1:this.current<12?0:this.current<15?1:this.current<18?2:this.current<20?3:4}}class j extends ${get bodyControlAdjustment(){return this.current<5?-2:this.current>10?Math.floor(.9*(this.current-10)):0}get missileAdjustment(){return this.current<5?-2:this.current>10?Math.floor((this.current-10)/2):0}}var U,q;!function(t){t[t.Player=0]="Player",t[t.PlayerOnlyEnemy=1]="PlayerOnlyEnemy",t[t.FreeForAll=2]="FreeForAll"}(U||(U={})),function(t){t[t.GoStairwayDown=0]="GoStairwayDown",t[t.Inventory=1]="Inventory",t[t.PutOn=2]="PutOn",t[t.Throwing=3]="Throwing"}(q||(q={}));const V=[q.GoStairwayDown,q.Inventory,q.PutOn,q.Throwing];var Y;!function(t){t[t.DIE=0]="DIE",t[t.HURT=1]="HURT",t[t.DODGE=2]="DODGE",t[t.THROW_DODGE=3]="THROW_DODGE",t[t.NOTHING=4]="NOTHING",t[t.RESIST=5]="RESIST"}(Y||(Y={}));class z{constructor(t,e=z.getId()){this.specie=t,this.id=e,this.stageMemories=new Map,this.dead=!1,this.health=new F(t)}static getId(){return this.lastId++}get name(){return this.specie.name}get clan(){return this.specie.clan}get protections(){return this.specie.protections}get throwDamages(){return this.specie.throwingDamages}get damages(){return this.specie.damages}can(t){return Object(o.includes)(this.specie.abilities,t)}on(t){return t.affectCreature(this)}get speed(){return this.specie.moveSpeed}stageMemory(t){const e=this.stageMemories.get(t.name);return e||this.visionMask(t)}visionMask(t){let e=this.stageMemories.get(t.name);return e?e.resetVisible():(e=new is(t.width,t.height),this.stageMemories.set(t.name,e)),A(t.creaturePos(this),this.visionRadius,e,t),e}get impactsBunch(){return this._impactsBunch||(this._impactsBunch=new T),this._impactsBunch}hasImpact(t){return Object(o.includes)(this.impacts,t)}addImpact(t,e){this.impactsBunch.addConstImpact(t,e)}removeImpact(t,e){this.impactsBunch.removeConstImpact(t,e)}get visionRadius(){return this.hasImpact(w.Blind)?0:this.specie.visionRadius}get bodyControl(){return this.specie.bodyControl}get impacts(){return this.impactsBunch.activeImpacts}hasResistance(t){return Object(o.includes)(this.resistances,t)}get resistances(){return this.specie.resistances}get weightWithCarryings(){return this.specie.weight}statsTurn(){this.health.turn(),this._impactsBunch&&this._impactsBunch.turn()}}z.lastId=0;class X extends D{constructor(t,e,s,i){super(),this.pos=t,this.creature=e,this.levelMap=s,this.game=i,this.reaction=Y.NOTHING}onTrap(t){this.reaction=t.activate(this.pos,this.game,this.levelMap,this.creature)}onTrigger(t){t.activate(this.game,this.levelMap,this.creature)}}class J extends m{constructor(t,e,s,i=e){super(),this.game=t,this.levelMap=e,this.nextPoint=s,this.nextLevel=i}affectCreature(t){const e=this.levelMap.creaturePos(t);this.nextLevel.name!==this.levelMap.name?(this.levelMap.removeCreature(t),this.nextLevel.addCreature(this.nextPoint,t)):(this.levelMap.at(e.x,e.y).creature=void 0,this.levelMap.at(this.nextPoint.x,this.nextPoint.y).creature=t);const s=new X(this.nextPoint,t,this.levelMap,this.game);return this.nextLevel.at(this.nextPoint.x,this.nextPoint.y).visit(s),s.reaction}affectPlayer(t){return this.nextLevel&&this.levelMap.name!==this.nextLevel.name?(this.levelMap.reset(),this.nextLevel.enter(),this.affectCreature(t),this.game.currentMap=this.nextLevel):this.affectCreature(t),Y.NOTHING}}class K{moveTo(t,e,s,i){return this.move(t,s,i,t=>e.eq(t))}move(t,e,s,i){const[r]=this.buildPath(t,e,i);if(r)return new J(s,e,r)}buildPath(t,e,s){return Bs(t.stageMemory(e),e.creaturePos(t),e=>e.tangible(t),s)}withinView(t,e,s){let i=h(t.width,t.height,()=>!1),r=[e];for(;r.length;){let e=[];r.forEach(r=>{if(!t.inRange(r))return;const a=t.at(r.x,r.y);a.visible&&!i[r.x][r.y]&&(i[r.x][r.y]=!0,s(r,a),r.wrappers().forEach(t=>e.push(t)))}),r=e}}enemies(t,e){return t.id!==e.id&&(t.clan===U.FreeForAll||e.clan===U.FreeForAll||(t.clan===U.Player&&e.clan===U.PlayerOnlyEnemy||e.clan===U.Player&&t.clan===U.PlayerOnlyEnemy))}}class Q extends K{constructor(){super(...arguments),this.destination=void 0}act(t,e,s){if(!this.foundNewTarget(t,e)||!this.destination)return this.checkCurrentTile(t,e,s);const i=this.goTo(t,e,s,this.destination);if(i)return i;this.destination=void 0,this.onCantMove(t)}goTo(t,e,s,i){return this.moveTo(t,i,e,s)}checkCurrentTile(t,e,s){if(this.destination&&e.creaturePos(t).eq(this.destination))return this.destination=void 0,this.onReach(t,e,s)}onMove(t){}onReach(t,e,s){}onCantMove(t){}}class Z extends Q{constructor(t){super(),this.matcher=t}checkCurrentTile(t,e,s){let i=super.checkCurrentTile(t,e,s);if(i)return i;const r=e.creaturePos(t);return this.matcher(t.stageMemory(e).at(r.x,r.y))?(this.destination=void 0,this.onReach(t,e,s)):void 0}foundNewTarget(t,e){const s=Bs(t.stageMemory(e),e.creaturePos(t),e=>e.tangible(t),(t,e)=>this.matcher(e),!0);return!!s.length&&(this.destination=s.pop(),!0)}}class tt extends K{act(t,e,s,i=!0){if(this.canAttack(t,e)){if(this.victim&&this.victimInAccess(t,e,this.victim))return new Qt(this.victim,e,s);if(!i)throw"Attacker got called twice";return this.pickNewVictim(t,e),this.act(t,e,s,!1)}}canAttack(t,e){return!!this.findCreature(t,e,e=>this.enemies(t,e))}victimInAccess(t,e,s){if(void 0===s)return!1;return!!this.findCreature(t,e,t=>t.id===s.id)}pickNewVictim(t,e){this.victim=this.findCreature(t,e,e=>this.enemies(t,e))}findCreature(t,e,s){const i=t.stageMemory(e);return e.creaturePos(t).wrappers().map(({x:t,y:e})=>i.at(t,e).creature).find(t=>!!t&&s(t))}}class et extends Q{foundNewTarget(t,e){return this.victimSet()&&this.buildVictimPath(t,e)||this.foundNewVictim(t,e)}onCantMove(){this.victimId=void 0}onReach(){this.victimId=void 0}victimSet(){return!!this.victimId}goTo(t,e,s){if(!this.destination)throw"Chaser.goTo: no destination";return this.followTo(t,this.destination,e,s)}buildVictimPath(t,e){return this.findCreature(t,e,t=>t.id===this.victimId)}foundNewVictim(t,e){return this.findCreature(t,e,e=>this.enemies(t,e))&&this.buildVictimPath(t,e)}findCreature(t,e,s){let i=!1;return this.withinView(t.stageMemory(e),e.creaturePos(t),({x:t,y:e},r)=>{const a=r.creature;!i&&a&&s(a)&&(this.destination=new l(t,e),this.victimId=a.id,i=!0)}),i}followTo(t,e,s,i){return this.move(t,s,i,t=>e.nextTo(t))}}const st=2;class it extends Q{constructor(){super(...arguments),this.escapesFrom=[]}foundNewTarget(t,e){return this.foundEnemies(t,e)&&this.buildEscapePath(t,e)}buildEscapePath(t,e,s=t.visionRadius/2){if(s<=1)return this.destination=void 0,!1;const i=this.buildPath(t,e,({x:t,y:e})=>{return Object(o.sumBy)(this.escapesFrom,([s,i])=>Math.max(Math.abs(t-s.x),Math.abs(e-s.y)))>=s});return i.length?(this.destination=i.pop(),!0):this.buildEscapePath(t,e,s-st)}foundEnemies(t,e){return this.escapesFrom=[],this.withinView(t.stageMemory(e),e.creaturePos(t),(e,s)=>{const i=s.creature;i&&this.enemies(t,i)&&this.escapesFrom.push([e,i])}),this.escapesFrom.length>0}}class rt extends Z{constructor(){super(t=>!t.seen)}}class at extends K{act(t,e,s){const i=e.creaturePos(t);return this.move(t,e,s,t=>!i.eq(t))}}class nt{constructor(t){this.game=t,this.player=t.player,this.logger=t.logger}}class ot extends nt{constructor(t,e){super(e),this.items=t}run(){}}class ht extends K{constructor(t){super(),this.aiToRun=t,this.events=[]}pushEvent(t){this.events.push(t)}resetEvents(){this.events=[]}runEvents(){let t=!1;return this.events.forEach(e=>{t=!0,e.run()}),this.resetEvents(),t}}var lt=s(35);const ct=10;class ut extends D{constructor(t){super(),this.tile=t,this.status=!1}addNode(){return this.status=!1,this.tile.visit(this),this.status}onDoor(){this.status=!0}}class dt extends K{constructor(){super(),this.step=ct,this.firstCallPatrol=!0,this.i="a",this.graph=new lt.Graph,this.lastNodeVisit={},this.currentNodeID="a",this.markNodeVisited(this.currentNodeID),this.path=[]}act(t,e,s,i=!0){if(!(this.graph.nodes().length<=1)){if(this.firstCallPatrol){const s=e.creaturePos(t);this.addNode(s),this.firstCallPatrol=!1}return this.step+=1,this.path.length?this.moveToTarget(t,e,s,i):(this.targetNodeID&&(this.markNodeVisited(this.targetNodeID),this.currentNodeID=this.targetNodeID),this.pickUpNewTarget(t,e),this.moveToTarget(t,e,s,i))}}reset(){this.path=[]}trackMovement(t,e){(this.step>=ct||new ut(e).addNode())&&this.addNode(t),this.step+=1}addNode(t){this.graph.setNode(this.i,t),this.currentNodeID&&this.currentNodeID!==this.i&&this.graph.setEdge(this.currentNodeID,this.i),this.currentNodeID=this.i,this.newNodeId(),this.step=0}buildNewPath(t,e){if(!this.targetNodeID)throw"Patrol has no next targetID";const s=this.graph.node(this.targetNodeID);this.path=this.buildPath(t,e,t=>s.eq(t))}pickUpNewTarget(t,e){let s=this.graph.nodes()[0],i=this.lastNodeVisit[s],r=this.graph.neighbors(this.currentNodeID);r&&r.forEach(t=>{i>(this.lastNodeVisit[t]||0)&&(s=t,i=this.lastNodeVisit[s])}),this.targetNodeID=s,this.buildNewPath(t,e)}moveToTarget(t,e,s,i){const r=this.path.shift();return r?t.stageMemory(e).at(r.x,r.y).tangible()?(this.buildNewPath(t,e),this.path.length?this.act(t,e,s,!1):void 0):new J(s,e,r):i?(this.path=[],this.act(t,e,s,!1)):(new at).act(t,e,s)}markNodeVisited(t){this.lastNodeVisit[t]=this.step}newNodeId(){this.i=String.fromCharCode(this.i.charCodeAt(0)+1)}}var pt,mt,gt,ft,vt,wt,yt,bt,xt,Tt;!function(t){t[t.AbilitiesPicking=0]="AbilitiesPicking",t[t.Death=1]="Death",t[t.Idle=2]="Idle",t[t.Inventory=3]="Inventory",t[t.ItemsListing=4]="ItemsListing",t[t.Missile=5]="Missile",t[t.ProfessionPicking=6]="ProfessionPicking",t[t.Look=7]="Look",t[t.Teleportation=8]="Teleportation",t[t.PickHandleOption=9]="PickHandleOption",t[t.CharacterInfo=10]="CharacterInfo"}(pt||(pt={}));class Ct{constructor(t,e){this.levelMap=t,this.game=e,this.player=this.game.player}get tile(){return this.levelMap.creatureTile(this.player)}endTurn(){this.game.player.ai.endTurn(this.game,this.levelMap)}redirect(t){this.game.player.ai.redirect(t)}goIdle(){this.redirect(new Ss(this.levelMap,this.game))}}class Wt extends Ct{constructor(t,e,s){super(e,s),this.dieReason=t}get type(){return pt.Death}get playerName(){return this.game.player.name}}class Mt extends nt{constructor(t,e,s){super(s),this.level=t,this.levelMap=e}run(){this.level%3==0?this.game.player.ai.presenter=new Ds(this.level,this.levelMap,this.game):this.game.player.ai.presenter=new Os(this.level,this.levelMap,this.game)}}class It extends nt{constructor(t,e,s){super(s),this.dieReason=t,this.levelMap=e}run(){this.game.player.rebuildVision(this.levelMap),this.game.playerTurn=!0,this.game.player.ai.presenter=new Wt(this.dieReason,this.levelMap,this.game)}}class Rt extends nt{constructor(t,e){super(e),this.levelMap=t}run(){this.game.player.rebuildVision(this.levelMap),this.game.playerTurn=!0,this.game.player.ai.presenter=new _s(this.levelMap,this.game)}}class kt extends ht{constructor(){super(...arguments),this.presenter=null,this.levelUps=0}act(t,e,s){this.presenter=new Ss(e,s),s.playerTurn=!0}endTurn(t,e){let s=this.events.pop();if(s)s.run();else if(t&&e){t.player.on(new f(e,t));let s=this.events.pop();s?s.run():(t.player.ai.runEvents(),t.playerTurn=!1,this.presenter=null)}}redirect(t){this.presenter=t}}class St extends Z{constructor(){super(t=>!!t.items)}act(t,e,s){if(t.can(q.Inventory))return super.act(t,e,s)}onReach(t,e,s){const i=e.creatureTile(t);if(!i.items)throw"Picker.act : nothing to pick up";return t.ai.pushEvent(new ot(i.items,s)),new he(i,i.items.bunch,s)}}class Pt extends m{constructor(t){super(),this.levelMap=t}affectCreature(t){let e=t.stageMemory(this.levelMap);return this.levelMap.creaturePos(t).wrappers().forEach(({x:t,y:s})=>{e.at(t,s).see(this.levelMap.at(t,s),0)}),Y.NOTHING}}class Et extends K{act(t,e){if(!t.health.atMax)return new Pt(e)}}class Ot extends D{constructor(){super(...arguments),this.match=!1}onStairwayDown(){this.match=!0}}class _t extends D{constructor(t,e){super(),this.game=t,this.levelMap=e}onStairwayDown(t){const e=this.game.getMap(t.adjacentMapName);this.event=new J(this.game,this.levelMap,t.enterPos(this.levelMap,e),e)}}class Nt extends Z{constructor(){super(t=>{const e=new Ot;return t.visit(e),e.match})}act(t,e,s){if(t.can(q.GoStairwayDown))return super.act(t,e,s)}onReach(t,e,s){const i=new _t(s,e);return e.creatureTile(t).visit(i),i.event}}class Dt extends K{act(t,e,s){if(!t.can(q.Throwing)||!this.hasMissile(t)||!this.canAttack(t,e,s))return;let i=[];if(!this.victim)throw"Thrower.act called when there is no victim";return u(e.creaturePos(t),e.creaturePos(this.victim),(t,e)=>i.push(new l(t,e))),new oe(i,s,e,t=>{t===Y.DIE&&(this.victim=void 0,this.previousVictim=void 0)})}hasMissile(t){return this.missiles=t.missile,void 0!==this.missiles}canAttack(t,e,s){return this.previousVictim=this.victim,this.victim=void 0,!(!this.previousVictim||!this.findWithId(t,e,this.previousVictim.id))||this.findCreature(t,e,e=>this.enemies(t,e))}findWithId(t,e,s){return this.findCreature(t,e,t=>s===t.id)}findCreature(t,e,s){const i=t.stageMemory(e),r=e.creaturePos(t);return this.withinView(i,e.creaturePos(t),(a,n)=>{const o=n.creature;!this.victim&&o&&s(o)&&!this.obstacles(t,r,i,a)&&(this.victim=e.at(a.x,a.y).creature)}),!!this.victim}obstacles(t,e,s,i){let r=!1;return u(e,i,(e,i)=>{r=r||s.at(e,i).tangible(t)}),r}}class At extends m{constructor(t,e,s){super(),this.actor=t,this.levelMap=e,this.game=s}affectCreature(t){return Y.NOTHING}affectPlayer(t){return t.level.add(1).forEach(e=>{t.ai.pushEvent(new Mt(e,this.levelMap,this.game))}),Y.NOTHING}}class Bt extends m{constructor(t,e,s,i){super(),this.impactType=t,this.source=e,this.game=s,this.duration=i}affectCreature(t){return t.hasImpact(this.impactType)&&this.applyImpact(),this.duration?t.impactsBunch.addImpact(this.impactType,this.duration):t.addImpact(this.impactType,this.source),Y.NOTHING}applyImpact(){}}!function(t){t[t.Intangible=0]="Intangible",t[t.MagicDamage=1]="MagicDamage",t[t.TeleportationControl=2]="TeleportationControl",t[t.Insulator=3]="Insulator"}(mt||(mt={}));class $t{constructor(){}static misses(t,e){return Math.random()>t/(t+Math.pow(.25*e,.8))}static lowerWeight(t,e=1){let s=0;for(let i=e;i<t;i++)this.chance(1,3)&&(s+=1);return Math.max(1,s)}static higherWeight(t,e=1){return t+e-this.lowerWeight(t,e)}static chance(t,e){return Object(o.random)(1,e)<=t}static dodges(t,e){return Math.random()<Math.atan(t/e)/Math.PI*2}static damage(t,e,s){if(t.every(({type:t,resistances:e})=>this.resistTo(t,e,s)))return{damage:0,resist:!0};return{damage:Object(o.sumBy)(t,({extra:t,dice:i,type:r,resistances:a})=>this.resistTo(r,a,s)?0:Math.floor(Math.max(0,t+this.dropDice(i)-this.protectionValue(r,e)))),resist:!1}}static resistTo(t,e,s){if(e&&Object(o.intersection)(s,e).length)return!0;switch(t){case xe.Melee:case xe.Pierce:case xe.Blunt:return Object(o.includes)(s,mt.Intangible);case xe.Magic:return Object(o.includes)(s,mt.MagicDamage);case xe.Pure:return!1}}static dropDice(t){return Object(o.sum)(Object(o.times)(t.times,()=>Object(o.random)(1,t.max)))}static protectionValue(t,e){return Object(o.sum)(e.map(({type:e,value:s})=>s*this.armorToDamageRatio(t,e)))}}$t.armorToDamageRatio=((t,e)=>{switch(t){case xe.Melee:switch(e){case xt.Medium:return 2/3;case xt.Solid:return 4/3;default:return 1}case xe.Pierce:switch(e){case xt.Light:return.5;case xt.Medium:return 4/3;case xt.Solid:return 3;case xt.Unarmored:return.75;default:return 1}case xe.Blunt:switch(e){case xt.Medium:return 2;case xt.Solid:case xt.Unarmored:return.5;default:return 1}case xe.Magic:switch(e){case xt.Light:return 5/4;case xt.Medium:return.75;case xt.Heavy:return.5;case xt.Solid:return 3;default:return 1}case xe.Pure:return 0;default:throw"Got unknown type of damage!"}}),function(t){t[t.Corrosion=0]="Corrosion",t[t.Destroy=1]="Destroy"}(gt||(gt={})),function(t){t.cloth={affectedWithWater:void 0,firm:!1,fragile:!1,insulator:!1},t.flesh={affectedWithWater:void 0,firm:!0,fragile:!1,insulator:!0},t.glass={affectedWithWater:void 0,firm:!1,fragile:!0,insulator:!1},t.iron={affectedWithWater:gt.Corrosion,firm:!0,fragile:!1,insulator:!0},t.leather={affectedWithWater:void 0,firm:!1,fragile:!1,insulator:!1},t.paper={affectedWithWater:gt.Destroy,firm:!1,fragile:!1,insulator:!0},t.stone={affectedWithWater:void 0,firm:!0,fragile:!1,insulator:!0},t.wood={affectedWithWater:void 0,firm:!0,fragile:!1,insulator:!0}}(ft||(ft={})),function(t){t[t.WeaponOneHand=0]="WeaponOneHand",t[t.WearsOnHead=1]="WearsOnHead",t[t.WearsOnBody=2]="WearsOnBody",t[t.Ring=3]="Ring",t[t.Amulet=4]="Amulet",t[t.Throw=5]="Throw",t[t.Shoot=6]="Shoot",t[t.Boots=7]="Boots",t[t.Tool=8]="Tool",t[t.Belt=9]="Belt",t[t.Gloves=10]="Gloves",t[t.Gauntlets=11]="Gauntlets",t[t.Cloak=12]="Cloak",t[t.Scroll=13]="Scroll"}(vt||(vt={})),function(t){t[t.BodyArmor=0]="BodyArmor",t[t.OneHandWeapon=1]="OneHandWeapon",t[t.Consumable=2]="Consumable",t[t.Missile=3]="Missile",t[t.Potion=4]="Potion",t[t.MissileWeapon=5]="MissileWeapon",t[t.Boots=6]="Boots",t[t.Scrolls=7]="Scrolls",t[t.Hat=8]="Hat"}(wt||(wt={})),function(t){t[t.MissileRock=0]="MissileRock",t[t.Sling=1]="Sling",t[t.Bow=2]="Bow",t[t.Arrows=3]="Arrows"}(yt||(yt={})),function(t){t[t.None=0]="None",t[t.Slightly=1]="Slightly",t[t.Mostly=2]="Mostly",t[t.Fully=3]="Fully"}(bt||(bt={}));class Ht{constructor(t,e,s,i,r=[],a=Ht.getId()){this.group=t,this.name=e,this.weight=s,this.material=i,this.usages=r,this.id=a,this.impacts=[],this.corrosionLevel=bt.None}static getId(){return this.lastId++}corrode(){switch(this.corrosionLevel){case bt.None:return this.corrosionLevel=bt.Slightly,!0;case bt.Slightly:return this.corrosionLevel=bt.Mostly,!0;case bt.Mostly:return this.corrosionLevel=bt.Fully,!0}return!1}get affectedWithWater(){return void 0!==this.material.affectedWithWater}get firm(){return this.material.firm}get insulator(){return this.material.insulator}get canSeeDetails(){return!0}clone(){return new Ht(this.group,this.name,this.weight,this.material)}groupsWith(t){return this.name===t.name}worksWith(t){return!1}canThrow(t){return!0}}Ht.lastId=0;class Ft extends Ht{constructor(t){super(wt.Consumable,`${t.name}'s corpse`,t.weight,t.material),this.specie=t}}class Lt extends Ht{constructor(t,e=ft.glass){super(wt.Potion,t,.2,e),this.name=t}}class Gt extends Ht{constructor(t,e,s,i,r,a){super(t,e,s,i,a),this.rawDamages=r}get damages(){switch(this.corrosionLevel){case bt.Slightly:return this.damageWithCorrosion(1);case bt.Mostly:return this.damageWithCorrosion(2);case bt.Fully:return this.damageWithCorrosion(4);default:return this.rawDamages}}damageWithCorrosion(t){return this.rawDamages.map(({dice:e,type:s,extra:i})=>({dice:e,type:s,extra:i-t}))}}class jt extends Gt{constructor(t,e,s,i){super(wt.Missile,t,e,i,s,[])}}class Ut extends Gt{constructor(t,e,s,i){super(wt.MissileWeapon,t,e,i,s,[vt.Shoot])}}class qt extends Gt{constructor(t,e,s,i){super(wt.OneHandWeapon,t,e,s,i,[vt.WeaponOneHand])}}!function(t){t[t.Light=0]="Light",t[t.Medium=1]="Medium",t[t.Heavy=2]="Heavy",t[t.Solid=3]="Solid",t[t.Unarmored=4]="Unarmored"}(xt||(xt={}));class Vt extends Ht{constructor(t,e,s,i,r,a){super(t,e,s,i,[a]),this.rawProtections=r}get protections(){switch(this.corrosionLevel){case bt.Slightly:return this.protectionWithCorrosion(1);case bt.Mostly:return this.protectionWithCorrosion(2);case bt.Fully:return this.protectionWithCorrosion(4);default:return this.rawProtections}}protectionWithCorrosion(t){return this.rawProtections.map(({type:e,value:s})=>({type:e,value:s-t}))}}class Yt extends Vt{constructor(t,e,s,i){super(wt.BodyArmor,t,e,s,i,vt.WearsOnBody)}}class zt extends Vt{constructor(t,e,s,i){super(wt.Boots,t,e,s,i,vt.Boots)}}class Xt extends Ht{constructor(t){super(wt.Scrolls,t,.1,ft.paper,[vt.Scroll])}}!function(t){t[t.Attack=0]="Attack",t[t.Missile=1]="Missile",t[t.Trap=2]="Trap",t[t.Overloaded=3]="Overloaded"}(Tt||(Tt={}));class Jt extends m{constructor(t,e,s){super(),this.game=t,this.levelMap=e,this.reason=s}affectCreature(t){let e=this.levelMap.creatureTile(t);return this.levelMap.removeCreature(t),t.dead=!0,t.specie.leavesCorpseRatio>Math.random()&&e.addItem(new Ft(t.specie),1),t.inventoryItems.forEach(t=>e.addItem(t.item,t.count)),Y.DIE}affectPlayer(t){return t.ai.pushEvent(new It(this.reason,this.levelMap,this.game)),t.dead=!0,this.game.playerTurn=!0,Y.DIE}}class Kt extends m{constructor(t,e,s,i){super(),this.damages=t,this.dieReason=e,this.levelMap=s,this.game=i}get damage(){if(this.doneDamage)return this.doneDamage;throw"HurtEvent.damage called but there is no done damage"}affectCreature(t){const{damage:e,resist:s}=$t.damage(this.damages,t.protections,t.resistances);return this.doneDamage=e,s?Y.RESIST:e>=t.health.currentValue?(t.on(new Jt(this.game,this.levelMap,this.dieReason)),Y.DIE):e<=0?Y.NOTHING:(t.health.decrease(e),Y.HURT)}}class Qt extends m{constructor(t,e,s){super(),this.victim=t,this.levelMap=e,this.game=s}affectCreature(t){const e=this.process(t);switch(e){case Y.NOTHING:this.game.logger.noDamageToPlayer(t);break;case Y.RESIST:this.game.logger.playerIgnoresDamage(t)}return e}affectPlayer(t){const e=this.process(t);switch(e){case Y.NOTHING:this.game.logger.noDamageToTarget(t);break;case Y.RESIST:this.game.logger.targetIgnoresDamage(this.victim)}return e}process(t){if($t.misses(t.bodyControl,this.victim.bodyControl))return this.game.logger.missMessage(this.game.player,t,this.victim),Y.DODGE;const e=new Kt(t.damages,Tt.Attack,this.levelMap,this.game),s=this.victim.on(e);switch(s){case Y.DIE:t.on(new At(this.victim,this.levelMap,this.game)),this.game.logger.killMessage(this.game.player,e.damage,t,this.victim);break;case Y.HURT:this.game.logger.hurtMessage(this.game.player,e.damage,t,this.victim)}return s}}class Zt extends m{constructor(t,e){super(),this.potion=t,this.game=e}affectCreature(t){return t.removeItem(this.potion,1),this.potion.onDrink(this.game),this.game.logger.drink(this.potion),Y.NOTHING}}class te extends g{constructor(t,e,s){super(),this.tile=t,this.items=e,this.game=s}affectPlayer(t){return this.items.forEach(({item:e,count:s})=>{t.removeItem(e,s),t.stuffWeight.subtract(e.weight*s),this.game.logger.droppedItem(e,s),this.tile.addItem(e,s)}),Y.NOTHING}}class ee extends g{affectPlayer(t){return this.updateHealth(t),Y.NOTHING}updateHealth(t){t.health.constantIncrease(t.constitution.levelUpHPBonus),t.health.maximum<1&&t.health.constantIncrease(1-t.health.maximum)}}class se{constructor(t){this.onDone=t}speed(){return-1}}class ie extends se{constructor(t,e,s){super(s),this.item=t,this.frames=e}patchMemory(t){if(this.done())return;const[e]=this.frames.splice(0,1),s=t.at(e.x,e.y);s.visible?s.effect="-":this.patchMemory(t)}done(){return 0===this.frames.length}}class re extends m{constructor(t,e,s,i){super(),this.victim=t,this.missile=e,this.levelMap=s,this.game=i}affectCreature(t){if($t.misses(t.bodyControl,this.victim.bodyControl))return this.game.logger.throwMissMessage(this.game.player,t,this.victim,this.missile),Y.THROW_DODGE;const{damage:e,resist:s}=$t.damage(t.throwDamages,this.victim.protections,this.victim.resistances);return e>=this.victim.health.currentValue?(t.on(new At(this.victim,this.levelMap,this.game)),this.game.logger.throwKillMessage(this.game.player,e,t,this.victim,this.missile),this.victim.on(new Jt(this.game,this.levelMap,Tt.Missile))):(this.victim.health.decrease(e),this.game.logger.throwHurtMessage(this.game.player,e,t,this.victim,this.missile),Y.HURT)}}class ae extends m{constructor(t,e){super(),this.slot=t,this.game=e}affectCreature(t){return Y.NOTHING}affectPlayer(t){const e=this.slot.equipment;if(void 0===e)throw`Can not take off item from ${this.slot.name} - nothing equipped`;return this.slot.takeOff(),this.onTakeOff(t,e.item),t.inventory.putToBag(e.item,e.count),this.game.logger.takeOff(e.item),Y.NOTHING}onTakeOff(t,e){e instanceof Vt&&e.protections.forEach(e=>{t.itemsProtections.splice(Object(o.findIndex)(t.itemsProtections,t=>t===e),1)}),e.impacts.forEach(s=>{t.on(new ce(s,e.name,this.game))})}}class ne extends m{constructor(t,e,s){super(),this.slot=t,this.count=e,this.game=s}affectCreature(t){return Y.NOTHING}affectPlayer(t){if(!this.slot.equipment)throw`RemoveItemEvent: ${this.slot.name} has no equipment`;return this.slot.equipment.count===this.count?t.on(new ae(this.slot,this.game)):(this.slot.equipment.count-=this.count,Y.NOTHING)}}class oe extends m{constructor(t,e,s,i){super(),this.path=t,this.game=e,this.levelMap=s,this.done=i}affectCreature(t){let e=t.missile;if(!e)throw"MissileAttackEvent called when actor has no missiles";return this.withMissile(t,e.item),Y.NOTHING}affectPlayer(t){const e=t.missile;if(!e)throw"MissileAttackEvent: slot has no items";return this.withMissile(t,e.item),t.on(new ne(t.inventory.missileSlot,1,this.game)),t.stuffWeight.subtract(e.item.weight),Y.NOTHING}withMissile(t,e){let s,i=[];this.path.forEach(t=>{if(!s){const e=this.levelMap.at(t.x,t.y);s=e.creature,i.push(t)}}),this.game.effect=new ie(e,i,()=>{s?this.done(t.on(new re(s,e,this.levelMap,this.game))):this.done(Y.NOTHING)})}}class he extends g{constructor(t,e,s){super(),this.tile=t,this.items=e,this.game=s}affectPlayer(t){let e=this.tile.items;if(void 0===e)throw"Failed to pick up items - tile has no items";return this.withTileItems(t,e),Y.NOTHING}withTileItems(t,e){this.items.forEach(({item:s,count:i})=>{t.addItem(s,i),t.stuffWeight.add(s.weight*i),this.game.logger.pickedUpItem(s,i),e.remove(s,i)})}}class le extends m{constructor(t,e,s){super(),this.slot=t,this.item=e,this.game=s}affectCreature(t){return Y.NOTHING}affectPlayer(t){let e=t.inventory.findInBag(this.item);if(void 0===e)throw`Item ${this.item.name} can not be equipped - not found in inventory`;if(this.slot.equipment){const e=t.on(new ae(this.slot,this.game));if(e!==Y.NOTHING)return e}const s=this.slot.useSingleItem?1:e.count;return t.removeItem(this.item,s),this.slot.equip(this.item,s),this.onPutOn(t,this.item),this.game.logger.putOn(this.item),Y.NOTHING}onPutOn(t,e){e instanceof Vt&&(t.itemsProtections=t.itemsProtections.concat(e.protections)),e.impacts.forEach(s=>{t.on(new Bt(s,e.name,this.game))})}}class ce extends m{constructor(t,e,s){super(),this.impactType=t,this.source=e,this.game=s}affectCreature(t){return Y.NOTHING}}class ue extends m{constructor(t,e){super(),this.levelMap=t,this.game=e}playerSees(t){let{x:e,y:s}=this.levelMap.creaturePos(t);return this.game.player.stageMemory(this.levelMap).at(e,s).visible}}const de=function(t,e,s){let i=t.width*t.height;for(;i>0;){const r=Object(o.random)(0,t.width-1),a=Object(o.random)(0,t.height-1);if(e(t.at(r,a)))return s(r,a),t;i--}throw"post add failed to add tile"},pe=function(t,e){let s=t.width*t.height;for(;s>0;){const i=Object(o.random)(0,t.width-1),r=Object(o.random)(0,t.height-1),a=t.at(i,r);if(e(a))return{tile:a,x:i,y:r};s--}},me=function(t,e,s){t.each((t,i,r)=>{e(t)&&s(t,i,r)})};class ge extends ue{constructor(t,e,s){super(t,e),this.selfCast=s}affectCreature(t){return this.playerSees(t)?t.hasResistance(mt.TeleportationControl)||!this.teleport(t)?this.game.logger.creatureNotTeleported(t):this.game.logger.creatureTeleported(t):this.teleport(t),Y.NOTHING}affectPlayer(t){return t.hasResistance(mt.TeleportationControl)?(this.selfCast||this.game.logger.playerTeleportationCaused(),t.ai.pushEvent(new Rt(this.levelMap,this.game)),this.game.playerTurn=!0):this.teleport(t)?this.selfCast||this.game.logger.playerTeleported():this.game.logger.playerNotTeleported(),Y.NOTHING}teleport(t){let e=!1;try{de(this.levelMap,t=>t.free(),(s,i)=>{e=!0,t.on(new J(this.game,this.levelMap,new l(s,i)))})}catch(t){}return e}}class fe extends ue{constructor(t,e,s,i,r){super(e,s),this.trap=t,this.onCreatureDodge=i,this.onCreatureActivated=r,this.dodgeRatio=t.dodgeRatio}affectCreature(t){const e=this.playerSees(t);return e&&(this.trap.revealed=!0),this.dodges(t)?(this.onCreatureDodge(e,!1),Y.DODGE):this.onCreatureActivated(e,!1)}affectPlayer(t){return this.trap.revealed=!0,this.dodges(t)?(this.onCreatureDodge(!0,!0),Y.DODGE):this.onCreatureActivated(!0,!0)}dodges(t){return $t.dodges(t.bodyControl,this.dodgeRatio)}}class ve extends m{constructor(t,e,s,i){super(),this.trapPosition=t,this.trap=e,this.levelMap=s,this.game=i}affectCreature(){return Y.NOTHING}affectPlayer(t){return this.trap.untrap(this.trapPosition,t,this.levelMap,this.game),Y.NOTHING}}class we extends m{constructor(t,e,s){super(),this.damages=t,this.levelMap=e,this.game=s,this.playerReaction=Y.NOTHING}affectCreature(t){return t.specie.material.affectedWithWater?t.on(new Kt(this.damages,Tt.Trap,this.levelMap,this.game)):Y.RESIST}affectPlayer(t){return this.affectBodyParts(t),this.affectInventory(t),this.affectEquipment(t),this.playerReaction}affectEquipment(t){t.dead||t.inventory.slots().forEach(e=>{if(e.equipment&&e.equipment.item.affectedWithWater){const{item:s,count:i}=e.equipment;switch(s.material.affectedWithWater){case gt.Corrosion:$t.chance(1,3)&&s.corrode()&&this.game.logger.itemCorrode(s);break;case gt.Destroy:if($t.chance(1,4)){const r=$t.lowerWeight(i);this.game.logger.itemDestroyByWater(s,r),t.on(new ne(e,r,this.game))}}}})}affectInventory(t){t.dead||t.inventory.cares().forEach(({count:e,item:s})=>{switch(s.material.affectedWithWater){case gt.Corrosion:$t.chance(1,4)&&s.corrode()&&this.game.logger.itemCorrode(s);break;case gt.Destroy:if($t.chance(1,6)){const i=$t.lowerWeight(e);this.game.logger.itemDestroyByWater(s,i),t.inventory.removeFromBag(s,i)}}})}affectBodyParts(t){t.inventory.bodyParts.forEach(e=>{if(!t.dead&&e.affectedWithWater)if(e.equipment)this.game.logger.waterBodyPartEquipmentResist(e,e.equipment.item),this.trackReaction(Y.RESIST);else{let s=t.on(new Kt(this.damages,Tt.Trap,this.levelMap,this.game));this.game.logger.waterBodyPartDamage(e,s),this.trackReaction(s)}})}trackReaction(t){this.playerReaction===Y.HURT&&t===Y.DIE?this.playerReaction=Y.DIE:this.playerReaction===Y.HURT?this.playerReaction=Y.HURT:this.playerReaction=t}}var ye=function(t,e){return h(t[0].length,t.length,(s,i)=>{const r=e.get(t[i].charAt(s));if(r)return r();throw`drawn: Can not find char ${t[i].charAt(s)}`})};const be=60;Math.PI;var xe,Te,Ce,We,Me;!function(t){t[t.Melee=0]="Melee",t[t.Pierce=1]="Pierce",t[t.Blunt=2]="Blunt",t[t.Magic=3]="Magic",t[t.Pure=4]="Pure"}(xe||(xe={})),function(t){t[t.Neuter=0]="Neuter",t[t.Female=1]="Female",t[t.Male=2]="Male"}(Te||(Te={}));class Ie{constructor(t){this.requires=t,this.current=1,this.currentExperience=0,this.doneLeveling=!1,this.requiredExperience=this.requires[0]}add(t){if(this.doneLeveling)return[];this.currentExperience+=t;let e=[];for(;!this.doneLeveling&&this.currentExperience>=this.requiredExperience;)this.levelUp(),e.push(this.current);return e}levelUp(){this.current+=1;let t=this.requires[this.current-1];t?(this.currentExperience-=this.requiredExperience,this.requiredExperience=t):(this.currentExperience=this.requiredExperience,this.doneLeveling=!0)}}class Re{constructor(t){this.totalWeight=0,this.items=[],t.forEach(([t,e])=>this.add(t,e))}add(t,e){if(t<1)throw"Item's weight is lower than 1";this.items.push([t,e]),this.totalWeight+=Math.ceil(t)}pick(t){if(0===this.items.length)throw"Tried to use empty pool";let e=Object(o.random)(this.totalWeight);const s=this.items.find(([t,s])=>(e-=t)<=0);if(void 0!==s)return s[1](t);throw"Pool failed to pick anything"}merge(t){let e=new Re([]);return this.items.forEach(([t,s])=>e.add(t,s)),t.items.forEach(([t,s])=>e.add(t,s)),e}}class ke{constructor(){this.step=0,this.turns={}}add(t,e){const s=this.step+e;this.turns[s]?Object(o.includes)(this.turns[s],t)||this.turns[s].push(t):this.turns[s]=[t]}remove(t){Object(o.forEach)(this.turns,(e,s)=>{Object(o.remove)(e,e=>e===t)}),this.turns=Object(o.pickBy)(this.turns,t=>t.length>0)}next(){this.step=this.nextStep();const[t]=Object(o.pullAt)(this.turns[this.step],0);return 0===this.turns[this.step].length&&delete this.turns[this.step],void 0===t?this.next():t}actors(){if(0===Object(o.size)(this.turns))return[];this.step=this.nextStep();const t=this.turns[this.step];return delete this.turns[this.step],t}nextStep(){let t=Object(o.min)(Object(o.keys)(this.turns).map(t=>parseInt(t)));if(void 0===t)throw"Timeline.nextStep called when there is no ones turn";return t}}class Se{constructor(){this.levels=[]}addStairDown(t,e){return this.addStairs(t,new P(t,e))}addStairUp(t,e){return this.addStairs(t,new E(t,e))}addStairs(t,e){return de(t,t=>t.free(),(s,i)=>{t.setTile(s,i,e)}),t}}class Pe extends c{constructor(t,e){super(e),this.name=t,this.creatures=[],this.timeline=new ke}reset(){this.timeline=new ke}enter(){this.reset(),this.creatures.forEach(t=>this.timeline.add(t.id,t.speed))}creatureTile(t){let e;if(this.each(s=>{s.creature&&s.creature.id===t.id&&(e=s)}),!e)throw`Creature ${t.id} ${t.name} is not found on map ${this.name}`;return e}creaturePos(t){let e;if(this.each((s,i,r)=>{s.creature&&s.creature.id===t.id&&(e=new l(i,r))}),!e)throw`Creature ${t.id} ${t.name} is not found on map ${this.name}`;return e}addCreature(t,e){this.creatures.push(e),this.at(t.x,t.y).creature=e,this.timeline.add(e.id,e.speed)}removeCreature(t){let e=this.creaturePos(t);this.at(e.x,e.y).creature=void 0,Object(o.remove)(this.creatures,e=>e.id===t.id),this.timeline.remove(t.id)}visibleThrough(t,e){return this.map[t][e].visibleThrough()}passibleThrough(t,e){return this.map[t][e].passibleThrough()}setTile(t,e,s){this.map[t][e]=s}matchStairs(t){let e;if(this.each((s,i,r)=>{(s instanceof P||s instanceof E)&&s.adjacentMapName===t&&(e=new l(i,r))}),e)return e;throw`LevelMap ${this.name} failed to find stairs to ${t}`}}!function(t){t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARNING=2]="WARNING",t[t.DANGER=3]="DANGER"}(Ce||(Ce={}));class Ee{constructor(t){this.messages=[],this.trapAirBlow=new _e(this,t),this.trapBareWire=new De(this,t),this.trapFallingRock=new Ae(this,t),this.trapHole=new Ne(this,t)}reset(){this.messages=[]}hurtMessage(t,e,s,i){this.debug(`${i.name} got ${e} damage from ${s.name}`)}killMessage(t,e,s,i){this.warning(`${i.name} got ${e} damage from ${s.name} causes them to die`)}missMessage(t,e,s){this.debug(`${e.name} misses ${s.name}!`)}throwMissMessage(t,e,s,i){this.debug(`${e.name} throws ${i.name} in ${s.name}, but misses!`)}throwKillMessage(t,e,s,i,r){this.warning(`${i.name} got ${e} damage from ${s.name} by ${r.name} causes them to die`)}throwHurtMessage(t,e,s,i,r){this.debug(`${i.name} got ${e} damage from ${s.name} by ${r.name}`)}ranIntoAnObstacle(){this.addMessage(Ce.DEBUG,"You ran into a wall")}howToHandle(){this.addMessage(Ce.DEBUG,"Don't know how to handle it")}noItemsToPickUp(){this.addMessage(Ce.DEBUG,"You don't see anything to pick up")}takeOff(t){this.addMessage(Ce.DEBUG,`You took off ${t.name}`)}putOn(t){this.addMessage(Ce.DEBUG,`You put on ${t.name}`)}drink(t){this.addMessage(Ce.INFO,`You drunk ${t.name}`)}nothingToShotWith(){this.addMessage(Ce.DEBUG,"You have nothing to shoot with")}needMissileWeapon(){this.addMessage(Ce.DEBUG,"Мне нужен лук или типа того")}youSteppedInTrap(){this.addMessage(Ce.DANGER,"Я наступил в ловушку")}creatureSteppedInTrap(t){this.addMessage(Ce.DANGER,`${t.name} наступил в ловушку`)}noDamageToPlayer(t){this.addMessage(Ce.DEBUG,`${t.name} ударил по мне, но я не почувствовал боли`)}noDamageToTarget(t){this.addMessage(Ce.DEBUG,`Удар пришелся по ${t.name} но остался незамеченным`)}playerIgnoresDamage(t){this.addMessage(Ce.DEBUG,`Я игнорирую урон ${t.name}`)}targetIgnoresDamage(t){this.addMessage(Ce.INFO,`${t.name} игнорирует урон`)}creatureTeleported(t){this.addMessage(Ce.INFO,`${t.name} иcчез`)}creatureNotTeleported(t){this.addMessage(Ce.INFO,`${t.name} озарился светом, но ничего не произошло`)}creatureDodgesTeleportationTrap(t){this.addMessage(Ce.INFO,`${t.name} попал в ловушку телепортации но смог увернуться`)}playerTeleportationCaused(){this.addMessage(Ce.INFO,"Что-то заставило меня телепортироваться")}playerTeleported(){this.addMessage(Ce.INFO,"Яркая вспышка и я оказался в другом месте")}playerNotTeleported(){this.addMessage(Ce.INFO,"Я озарился ярким светом, но ничего не произошло")}playerTeleportedWhereTheyWere(){this.addMessage(Ce.INFO,"Я решил никуда не телепортироваться")}playerDodgesTeleportationTrap(){this.addMessage(Ce.INFO,"Я попал в ловушку телепортации но смог увернуться")}lightTrapActivated(t,e,s,i){s?this.addMessage(Ce.INFO,"Яркая вспышка света ослепила меня"):this.addMessage(Ce.INFO,`${i.name} озарился яркой вспышкой света`)}lightTrapDodge(t,e,s,i){s?this.addMessage(Ce.INFO,"Вспышка света чуть не ослепила меня"):this.addMessage(Ce.INFO,`${i.name} озарился яркой вспышкой света`)}canNotUntrap(){this.addMessage(Ce.INFO,"Не представляю, как это обезвредить")}failedToUntrap(t){this.addMessage(Ce.WARNING,"У меня не получилось обезвредить ловушку")}succeededToUntrap(t){this.addMessage(Ce.INFO,"Успешно обезвредил ловушку")}pickedUpItem(t,e){1===e?this.addMessage(Ce.INFO,`You picked up ${t.name}`):this.addMessage(Ce.INFO,`You picked up ${e} ${t.name}`)}droppedItem(t,e){1===e?this.addMessage(Ce.INFO,`You dropped a ${t.name}`):this.addMessage(Ce.INFO,`You dropped ${e} ${t.name}`)}waterTrapActivated(){this.info("Я попал в ловушку с водой")}waterBodyPartEquipmentResist(t,e){this.debug(`${e.name} защитил ${t.name} от воды`)}waterBodyPartDamage(t,e){switch(e){case Y.DIE:this.danger(`Вода попала мне на ${t.name}, рана не совместима с жизнью`);break;case Y.HURT:this.danger(`Вода обожгла мне ${t.name}`);break;case Y.NOTHING:case Y.RESIST:this.danger(`Вода попала мне на ${t.name}, но все обошлось`)}}waterTrapDamage(t,e,s,i,r){if(e)switch(i){case Y.DIE:this.danger(`${r.name} растворился в потоках воды`);break;case Y.DODGE:this.info(`${r.name} уклонился от потока воды`);break;case Y.HURT:this.warning(`${r.name} пострадал от воды`);break;case Y.NOTHING:case Y.RESIST:s||this.debug(`${r.name} был облит водой`)}}itemCorrode(t){switch(t.corrosionLevel){case bt.Slightly:return this.info(`${t.name} немного заржавел`);case bt.Mostly:return this.info(`${t.name} значительно проржавел`);case bt.Fully:return this.warning(`${t.name} полностью проржавел`)}}itemDestroyByWater(t,e){this.warning(`${e} ${t.name} были уничтожены водой`)}debug(t){this.addMessage(Ce.DEBUG,t)}info(t){this.addMessage(Ce.INFO,t)}warning(t){this.addMessage(Ce.WARNING,t)}danger(t){this.addMessage(Ce.DANGER,t)}addMessage(t,e){const s=Object(o.last)(this.messages);s&&s.message===e?s.counter+=1:this.messages.push({level:t,message:e,counter:1})}}class Oe{constructor(t,e){this.logger=t,this.player=e}debug(t){this.logger.debug(t)}info(t){this.logger.info(t)}warning(t){this.logger.warning(t)}danger(t){this.logger.danger(t)}}class _e extends Oe{dodge(t,e,s){e?this.info("Я увернулся от потока воздуха"):t&&this.info(`${s.name} увернулся от потока воздуха`)}resist(t,e,s){e?this.debug("Поток воздуха чуть не снес меня"):t&&this.debug(`${s.name} попал в поток воздуха`)}activate(t,e,s){e?this.info("Меня снесло потоком воздуха"):t&&this.info(`${s.name} снесло потоком воздуха`)}handBlow(t){this.warning(`Поток воздуха выбил ${t.name} у меня из руки`)}headBlow(t){this.warning(`Поток воздуха снял ${t.name} с моей головы`)}}class Ne extends Oe{dodge(t,e,s){e?this.warning("Я чуть не упал в яму"):t&&this.warning(`${s.name} чуть не упал в яму`)}activated(t,e,s){e?this.warning("Я упал в яму"):t&&this.warning(`${s.name} упал в яму`)}shallowActivated(t,e,s){e?this.warning("Я упал в неглубокую яму"):t&&this.warning(`${s.name} упал в неглубокую яму`)}}class De extends Oe{activated(t,e,s){this.info(`${s.name} наступил на оголенный провод`)}doNotWant(){this.info("Трогать оголенный провод руками так себе затея")}resist(){this.info("Я наступил на оголенный провод, но все обошлось")}}class Ae extends Oe{resist(t){return this.info("Камень упал мне на голову, но каска защитила меня")}ranOut(){return this.debug("Громкий щелчок, но ничего не произошло")}dodge(t,e,s,i){this.info(`${i.name} увернулся от ловушки`)}activate(t,e,s,i,r){this.info(`${r.name} попал в ловушку`)}}class Be{constructor(t,e){this.player=t,this.professionPicker=e,this.playerTurn=!1,this.running=!1,this.effect=null,this.maps=new Map,this.logger=new Ee(t)}turn(){this.running||this.player.ai.presenter&&!this.effect||(this.running=!0,this.mutexTurn(),this.running=!1)}mutexTurn(){if(!this.player.ai.runEvents()){if(!this.currentMap)throw"mutexTurn: Map is undefined";if(this.effect)this.player.rebuildVision(this.currentMap),this.effect.patchMemory(this.player.stageMemory(this.currentMap)),this.effect.done()&&(this.effect.onDone(),this.effect=null);else{for(;!this.player.dead&&!this.playerTurn;)this.levelMapTurn();this.player.rebuildVision(this.currentMap)}}}getMap(t){const e=this.maps.get(t);if(!e)throw`Map ${t} is not found`;if(e instanceof Pe)return e;if(e instanceof Function){const s=e(t,this);return this.maps.set(t,s),s}throw`LevelMap with id ${t} is not found`}addMap(t,e){this.maps.set(t,e)}levelMapTurn(){if(!this.currentMap)throw"levelMapTurn: Map is undefined";let t=this.currentMap.timeline,e=this.currentMap;const s=t.next();if(void 0===s)throw"Timeline event is empty!";const i=e.creatures.find(t=>s===t.id);if(i){const r=i.act(e,this);r&&e.creatures.find(t=>s===t.id)&&t.add(s,r)}}}class $e{constructor(t,e,s){this.usages=t,this.useSingleItem=e,this.equipment=s,this.name="InventorySlot"}matchingItems(t){return t.cares().filter(t=>this.match(t.item))}get insulator(){return!(!this.equipment||!this.equipment.item.insulator)}get firm(){return!(!this.equipment||!this.equipment.item.firm)}equip(t,e){if(this.equipment)throw`Slot ${this.name} is already equipped with ${this.equipment.item}`;this.equipment={count:e,item:t}}takeOff(){if(!this.equipment)throw`Slot ${this.name} has nothing to take off`;this.equipment=void 0}match(t){return Object(o.intersection)(t.usages,this.usages).length>0}withPairItem(t,e){return t.filter(t=>t.item.worksWith(e))}}class He extends $e{get affectedWithWater(){return void 0!==this.material.affectedWithWater}}class Fe extends He{constructor(t){super([vt.WeaponOneHand],!0),this.material=t,this.name="Правая рука"}}class Le extends He{constructor(t){super([vt.WeaponOneHand],!0),this.material=t,this.name="Левая рука"}}class Ge extends He{constructor(t){super([vt.WearsOnHead],!0),this.material=t,this.name="Голова"}}class je extends He{constructor(t){super([vt.WearsOnBody],!0),this.material=t,this.name="Корпус"}}class Ue extends He{constructor(t){super([vt.Boots],!0),this.material=t,this.name="Ботинки"}}class qe extends $e{constructor(){super([vt.Gloves],!0),this.name="Перчатки"}}class Ve extends $e{constructor(){super([vt.Gauntlets],!0),this.name="Наручи"}}class Ye extends $e{constructor(){super([vt.Belt],!0),this.name="Пояс"}}class ze extends $e{constructor(){super([vt.Amulet],!0),this.name="Амулет"}}class Xe extends $e{constructor(){super([vt.Ring],!0),this.name="Левый палец"}}class Je extends $e{constructor(){super([vt.Ring],!0),this.name="Правый палец"}}class Ke extends $e{constructor(){super([vt.Cloak],!0),this.name="Плащ"}}class Qe extends $e{constructor(){super([vt.Shoot],!0),this.name="Метательное"}matchingItems(t){let e=super.matchingItems(t),s=t.missileSlot.equipment;return s?this.withPairItem(e,s.item):e}}class Ze extends $e{constructor(){super([vt.Throw],!1),this.name="Снаряды"}matchingItems(t){let e=t.cares(),s=t.missileWeaponSlot.equipment;return s?this.withPairItem(e,s.item):e}}class ts extends $e{constructor(){super([vt.Tool],!0),this.name="Инструмент"}}class es{constructor(){this.bag=new v,this.headSlot=new Ge(ft.flesh),this.amuletSlot=new ze,this.cloakSlot=new Ke,this.chestSlot=new je(ft.flesh),this.rightHandSlot=new Fe(ft.flesh),this.leftHandSlot=new Le(ft.flesh),this.leftFingerSlot=new Xe,this.rightFingerSlot=new Je,this.glovesSlot=new qe,this.gauntletsSlot=new Ve,this.beltSlot=new Ye,this.bootsSlot=new Ue(ft.flesh),this.missileWeaponSlot=new Qe,this.missileSlot=new Ze,this.toolsSlot=new ts}get bodyParts(){return[this.headSlot,this.rightHandSlot,this.leftHandSlot,this.chestSlot,this.bootsSlot]}slots(){return[this.headSlot,this.amuletSlot,this.cloakSlot,this.chestSlot,this.rightHandSlot,this.leftHandSlot,this.leftFingerSlot,this.rightFingerSlot,this.glovesSlot,this.gauntletsSlot,this.beltSlot,this.bootsSlot,this.missileWeaponSlot,this.missileSlot,this.toolsSlot]}get allItems(){return Object(o.concat)(this.cares(),Object(o.compact)(this.slots().map(t=>t.equipment)))}get unarmoredSlotsCount(){return[this.headSlot,this.chestSlot,this.glovesSlot,this.gauntletsSlot,this.beltSlot,this.bootsSlot].filter(t=>!t.equipment).length}cares(){return this.bag.bunch}findInBag(t){return this.bag.find(t)}putToBag(t,e){this.bag.put(t,e)}removeFromBag(t,e){this.bag.remove(t,e)}}class ss{constructor(t){this.tile=t,this.visible=!1,this.degree=0,this.seen=!1}get items(){return this.tile.items}get creature(){return this.tile.creature}see(t,e){this.visible=!0,this.degree=e,this.seen=!0,this.tile=t.clone()}tangible(t){return this.seen&&!this.tile.passibleThrough(t)}reset(){this.visible=!1,this.effect=void 0,this.tile.creature=void 0}visit(t){this.tile.visit(t)}}class is extends c{constructor(t,e){const s=new k;super(h(t,e,()=>new ss(s)))}resetVisible(){this.each(t=>t.reset())}}class rs{constructor(){this.total=0,this.stat=new Map}add(t){const e=this.stat.get(t);e?this.stat.set(t,e+1):this.stat.set(t,1)}get all(){return Object(o.sortBy)(Array.from(this.stat),([t,e])=>t)}}class as extends z{constructor(t,e,s,i,r,a){super(s),this.level=t,this.ai=e,this.professions=[],this.inventory=new es,this.itemsProtections=[],this.itemsResistances=[],this.killStat=new rs,this.strength=new L(i),this.dexterity=new j(r),this.constitution=new G(a),this.intelligence=new $(10),this.wisdom=new $(2),this.charisma=new $(2),this.stuffWeight=new $(0),this.carryingCapacity=new H(this.strength.current,this.constitution.current)}act(t,e){this.statsTurn(),this.visionMask(t);const s=this.ai.act(this,t,e);return s&&this.on(s),this.on(new f(t,e)),this.speed}rebuildVision(t){this.visionMask(t)}on(t){return t.affectPlayer(this)}get missile(){return this.inventory.missileSlot.equipment}get inventoryItems(){return this.inventory.allItems}addItem(t,e){this.inventory.putToBag(t,e)}removeItem(t,e){this.inventory.removeFromBag(t,e)}get weightWithCarryings(){return this.specie.weight+Object(o.sumBy)(this.inventory.allItems,({item:t,count:e})=>t.weight*e)}get bodyControl(){return this.specie.bodyControl+this.dexterity.bodyControlAdjustment}get throwDamages(){const t=this.dexterity.missileAdjustment;return Object(o.concat)(this.specie.throwingDamages,this.missileItemsDamages()).map(e=>{let s=Object(o.cloneDeep)(e);return s.extra+=t,s})}get damages(){const t=this.strength.meleeAdjustment;return Object(o.concat)(this.specie.damages,this.meleeItemsDamages()).map(e=>{let s=Object(o.cloneDeep)(e);return s.extra+=t,s})}get protections(){return Object(o.concat)(this.specie.protections,this.itemsProtections,[{type:xt.Unarmored,value:1*this.inventory.unarmoredSlotsCount}])}get resistances(){return Object(o.concat)(this.specie.resistances,this.itemsResistances)}meleeItemsDamages(){const t=this.inventory.rightHandSlot.equipment,e=this.inventory.leftHandSlot.equipment;return Object(o.concat)(t?t.item.damages:[],e?e.item.damages:[])}missileItemsDamages(){const t=this.inventory.missileSlot.equipment,e=this.inventory.missileWeaponSlot.equipment;return Object(o.concat)(t&&t.item.damages||[],e?e.item.damages:[])}}class ns{constructor(t,e,s=1,i=0){this.id=t,this.name=e,this.level=s,this.points=i,this.talents=[],this.depthCost=3}}class os{constructor(t,e,s){this.pool=t,this.maxLevel=e,this.maxTaken=s}available(t){let e,s=[];return this.canUpdate(t)?e=this.updatableProfession(t):this.canTakeNewProfession(t)&&(e=this.newFromPool(t)),void 0!==e&&s.push(e),this.canTakeNewProfession(t)?e=this.newFromPool(t,e&&e.id):this.canUpdate(t)&&(e=this.updatableProfession(t,e&&e.id)),void 0!==e&&s.push(e),s}canUpdate(t){return t.professions.some(t=>t.level<this.maxLevel)}updatableProfession(t,e){return Object(o.sample)(t.professions.filter(t=>e!==t.id))}canTakeNewProfession(t){return t.professions.length<this.maxTaken&&this.pool.length>t.professions.length}newFromPool(t,e){const s=t.professions.map(t=>t.id);return void 0!==e&&s.push(e),Object(o.sample)(this.pool.filter(t=>!Object(o.includes)(s,t.id)))}}!function(t){t[t.Available=0]="Available",t[t.Completed=1]="Completed",t[t.Unavailable=2]="Unavailable"}(We||(We={}));class hs{constructor(t,e,s,i,r,a){this.id=t,this.name=e,this.depth=s,this.rank=i,this.maxRank=r,this.description=a}}class ls extends O{constructor(t,e=!1){super(b.AirBlow,t,e)}untrap(t,e,s,i){$t.chance(4,6)?(i.logger.failedToUntrap(e),$t.chance(3,5)&&this.activate(t,i,s,e)):this.disarmTile(t,e,s,i)}buildNew(){return new ls(this.tile,this.revealed)}get dodgeRatio(){return this.revealed?6:15}get creatureWeightBlowThreshold(){return 60}activate(t,e,s,i){return i.on(new fe(this,s,e,(t,s)=>e.logger.trapAirBlow.dodge(t,s,i),(r,a)=>{if(i.weightWithCarryings>=this.creatureWeightBlowThreshold)e.logger.trapAirBlow.resist(r,a,i);else{let n=this.randomPos(t,s,$t.higherWeight(3,1),t=>t.passibleThrough(i));n.eq(t)?e.logger.trapAirBlow.resist(r,a,i):(e.logger.trapAirBlow.activate(r,a,i),i.on(new J(e,s,n)))}if(a){const i=e.player,r=i.inventory;[[r.headSlot,3,t=>e.logger.trapAirBlow.headBlow(t)],[r.rightHandSlot,40/i.strength.current,t=>e.logger.trapAirBlow.handBlow(t)],[r.leftHandSlot,45/i.strength.current,t=>e.logger.trapAirBlow.handBlow(t)]].forEach(([r,a,n])=>{r.equipment&&a>=3&&$t.chance(1,Math.round(a))&&(n(r.equipment.item),this.throwItem(t,s,r.equipment.item),i.on(new ne(r,1,e)))})}return Y.NOTHING}))}throwItem(t,e,s){let i=this.randomPos(t,e,$t.lowerWeight(5,1),t=>t.isFloor());e.at(i.x,i.y).addItem(s,1)}randomPos(t,e,s,i){let r=t,a=!1;return Object(o.shuffle)(p.all).forEach(n=>{if(!a){let o=!1;d(t,t.add(n.multiple(s)),(t,s)=>{!o&&e.inRange(new l(t,s))&&i(e.at(t,s))?(r=new l(t,s),a=!0):o=!0})}}),r}}class cs extends ue{constructor(t,e,s){super(e,s),this.trap=t}get hurtEvent(){return new Kt(this.damages,Tt.Trap,this.levelMap,this.game)}get damages(){return[{type:xe.Pure,dice:{times:5,max:2},extra:5}]}affectCreature(t){const e=t.on(this.hurtEvent);return this.playerSees(t)&&(this.trap.revealed=!0),this.game.logger.trapBareWire.activated(this.playerSees(t),e,t),e}affectPlayer(t){if(this.trap.revealed=!0,t.inventory.bootsSlot.insulator)return this.game.logger.trapBareWire.resist(),Y.RESIST;{const e=t.on(this.hurtEvent);return this.game.logger.trapBareWire.activated(!0,e,t),e}}}class us extends O{constructor(t,e=!1){super(b.BareWire,t,e)}untrap(t,e,s,i){e.inventory.glovesSlot.insulator?$t.chance(1,7)?(i.logger.failedToUntrap(e),this.activate(t,i,s,e)):this.disarmTile(t,e,s,i):i.logger.trapBareWire.doNotWant()}buildNew(){return new us(this.tile,this.revealed)}get dodgeRatio(){return this.revealed?5:10}activate(t,e,s,i){return $t.dodges(i.bodyControl,this.dodgeRatio)?Y.DODGE:i.on(new cs(this,s,e))}}class ds extends O{constructor(t,e,s=!1,i=5){super(b.FallingRock,e,s),this.newRock=t,this.missilesCount=i}buildNew(){return new ds(this.newRock,this.tile,this.revealed,this.missilesCount)}get dodgeRatio(){return this.revealed?3:12}get damages(){return[{type:xe.Blunt,extra:3,dice:{times:2,max:5}}]}untrap(t,e,s,i){if($t.chance(1,4)){i.logger.failedToUntrap(e);const r=s.at(t.x,t.y).creature;r?this.activate(t,i,s,r):this.throwMissile(t,s,i.logger)}else this.disarmTile(t,e,s,i)}activate(t,e,s,i){return this.throwMissile(t,s,e.logger)?i.on(new fe(this,s,e,(t,s)=>e.logger.trapFallingRock.dodge(e.player,t,s,i),(t,r)=>{if(r&&e.player.inventory.headSlot.firm)return e.logger.trapFallingRock.resist(e.player),Y.RESIST;const a=i.on(new Kt(this.damages,Tt.Trap,s,e));return e.logger.trapFallingRock.activate(e.player,t,r,a,i),a})):Y.NOTHING}throwMissile(t,e,s){return this.missilesCount<=0?(s.trapFallingRock.ranOut(),!1):(this.missilesCount-=1,e.at(t.x,t.y).addItem(this.newRock(),1),!0)}}class ps extends O{constructor(t,e=!1){super(b.Hole,t,e)}buildNew(){return new ps(this.tile,this.revealed)}untrap(t,e,s,i){i.logger.canNotUntrap()}get dodgeRatio(){return this.revealed?1:5}activate(t,e,s,i){return i.on(new fe(this,s,e,(t,s)=>e.logger.trapHole.dodge(t,s,i),(t,r)=>{let a=this.fallEvent(e,s);return a?(e.logger.trapHole.activated(t,r,i),i.on(a),i.on(new Kt([{type:xe.Pure,dice:{times:3,max:2},extra:2}],Tt.Trap,s,e))):(e.logger.trapHole.shallowActivated(t,r,i),i.on(new Pt(s)))}))}fallEvent(t,e){let s=void 0;return me(e,()=>!0,i=>{if(i instanceof P){let r=t.getMap(i.adjacentMapName),a=void 0;(a=pe(r,t=>t.passibleThrough()))&&(s=new J(t,e,new l(a.x,a.y),r))}}),s}}class ms extends O{constructor(t,e=!1){super(b.Light,t,e)}untrap(t,e,s,i){$t.chance(1,3)?(i.logger.failedToUntrap(e),this.activate(t,i,s,e)):this.disarmTile(t,e,s,i)}buildNew(){return new ms(this.tile,this.revealed)}get dodgeRatio(){return this.revealed?1:10}get duration(){return 10}activate(t,e,s,i){return i.on(new fe(this,s,e,(t,s)=>e.logger.lightTrapDodge(e.player,t,s,i),(t,s)=>i.hasImpact(w.Blind)?Y.NOTHING:(e.logger.lightTrapActivated(e.player,t,s,i),i.on(new Bt(w.Blind,"trap",e,this.duration)))))}}class gs extends O{constructor(t,e=!1){super(b.Teleportation,t,e)}untrap(t,e,s,i){i.logger.canNotUntrap()}buildNew(){return new gs(this.tile,this.revealed)}get dodgeRatio(){return this.revealed?3:10}activate(t,e,s,i){return i.on(new fe(this,s,e,(t,s)=>{s?e.logger.playerDodgesTeleportationTrap():t&&e.logger.creatureDodgesTeleportationTrap(i)},(t,r)=>i.on(new ge(s,e,!1))))}}class fs extends O{constructor(t,e=!1){super(b.Water,t,e)}buildNew(){return new fs(this.tile,this.revealed)}get dodgeRatio(){return this.revealed?10:8}get damages(){return[{type:xe.Pure,extra:5,dice:{times:2,max:2}}]}untrap(t,e,s,i){$t.chance(3,4)?(i.logger.failedToUntrap(e),$t.chance(1,4)&&this.activate(t,i,s,e)):this.disarmTile(t,e,s,i)}activate(t,e,s,i){return i.on(new fe(this,s,e,(t,s)=>e.logger.waterTrapDamage(e.player,t,s,Y.DODGE,i),(t,r)=>{r&&e.logger.waterTrapActivated();let a=i.on(new we(this.damages,s,e));return r||e.logger.waterTrapDamage(e.player,t,r,a,i),a}))}}class vs extends Ct{constructor(t,e){super(t,e),this.positions=[],this.initPositions()}get type(){return pt.ItemsListing}close(){this.goIdle()}}class ws extends vs{get singleItemMode(){return!0}}class ys extends vs{get singleItemMode(){return!1}}class bs extends ws{constructor(){super(...arguments),this.title="Сумка"}initPositions(){this.positions=this.player.inventory.cares()}withItem(){this.endTurn()}}class xs extends Ct{get type(){return pt.CharacterInfo}get baseInfo(){return[{name:"name",value:this.game.player.name}]}}class Ts extends ws{constructor(){super(...arguments),this.title="Что выпить?"}initPositions(){this.positions=this.player.inventory.cares().filter(t=>t.item.group===wt.Potion)}withItem({item:t}){this.player.on(new Zt(t,this.game)),this.endTurn()}}class Cs extends ys{constructor(){super(...arguments),this.title="Что положить?"}initPositions(){this.positions=this.player.inventory.cares()}withItems(t){t.length?(this.player.on(new te(this.tile,t,this.game)),this.endTurn()):this.goIdle()}}class Ws extends Ct{constructor(t,e){super(t,e),this.positions=[],this.takeTime=!1,this.rebuildPositions()}get type(){return pt.Inventory}takeOff(t){this.player.on(new ae(t.inventorySlot,this.game)),this.takeTime=!0,this.rebuildPositions()}putOn(t){this.redirect(new As(e=>{this.player.on(new le(t.inventorySlot,e.item,this.game)),this.takeTime=!0,this.rebuildPositions(),this.redirect(this)},t.availableItems,this.levelMap,this.game))}close(){this.takeTime?this.endTurn():this.redirect(new Ss(this.levelMap,this.game))}rebuildPositions(){this.positions=this.player.inventory.slots().map(t=>({inventorySlot:t,item:t.equipment&&t.equipment.item,count:t.equipment&&t.equipment.count,availableItems:t.matchingItems(this.player.inventory)}))}}class Ms extends Ct{constructor(t,e){super(t,e),this.targetEnemyIndex=void 0,this.enemies=[],this.path=[],this.findEnemies(),this.memory=this.player.stageMemory(this.levelMap),this.targetPos=this.resetTargetId()}get type(){return pt.Missile}nextTarget(){void 0!==this.targetEnemyIndex?(this.targetEnemyIndex+=1,this.targetEnemyIndex>=this.enemies.length&&(this.targetEnemyIndex=0),this.updateTarget(this.enemies[this.targetEnemyIndex])):this.resetTargetId()}previousTarget(){void 0!==this.targetEnemyIndex?(this.targetEnemyIndex-=1,this.targetEnemyIndex<0&&(this.targetEnemyIndex=this.enemies.length-1),this.updateTarget(this.enemies[this.targetEnemyIndex])):this.resetTargetId()}moveTarget(t){const e=this.targetPos.add(t);this.levelMap.at(e.x,e.y).visibleThrough()&&this.player.stageMemory(this.levelMap).at(e.x,e.y).visible&&(this.updateTarget(e),this.targetEnemyIndex=void 0)}attack(){this.targetPos.eq(this.levelMap.creaturePos(this.player))||this.player.on(new oe(this.path,this.game,this.levelMap,()=>this.endTurn()))}close(){this.resetPath(),this.redirect(new Ss(this.levelMap,this.game))}resetTargetId(){let t;return this.enemies.length?(this.targetEnemyIndex=0,t=this.enemies[this.targetEnemyIndex]):(this.targetEnemyIndex=void 0,t=this.levelMap.creaturePos(this.player)),this.updateTarget(t),t}resetPath(){this.path.forEach(({x:t,y:e})=>this.memory.at(t,e).effect=void 0)}updateTarget(t){this.resetPath(),this.targetPos=t.copy(),this.drawPath()}drawPath(){this.path=[];let t=!1;const e=this.levelMap,s=this.levelMap.creaturePos(this.player);d(s,this.targetPos,(s,i)=>{e.at(s,i).passibleThrough()||(t=!0),this.path.push(new l(s,i)),this.memory.at(s,i).effect=t?"o":"x"})}findEnemies(){this.enemies=[],this.player.stageMemory(this.levelMap).each((t,e,s)=>{t.visible&&t.creature&&t.creature.id!==this.player.id&&this.enemies.push(new l(e,s))})}}class Is extends Ct{constructor(t,e,s,i){super(e,s),this.options=t,this.withOption=i}get type(){return pt.PickHandleOption}pick(t){this.withOption(t)}close(){this.goIdle()}}class Rs extends D{constructor(t,e,s){super(),this.position=t,this.game=e,this.levelMap=s,this.commands=[]}onStairway(t){const e=this.game.getMap(t.adjacentMapName);this.commands.push(["stairway",new J(this.game,this.levelMap,t.enterPos(this.levelMap,e),e)])}onTrap(t){t.revealed&&this.commands.push(["untrap",new ve(this.position,t,this.levelMap,this.game)])}}class ks extends Rs{onStairway(){}}class Ss extends Ct{get type(){return pt.Idle}inventoryCommand(){this.redirect(new Ws(this.levelMap,this.game))}characterInfo(){this.redirect(new xs(this.levelMap,this.game))}bagCommand(){this.redirect(new bs(this.levelMap,this.game))}stayCommand(){this.player.on(new Pt(this.levelMap)),this.endTurn()}dropCommand(){this.redirect(new Cs(this.levelMap,this.game))}drinkCommand(){this.redirect(new Ts(this.levelMap,this.game))}lookCommand(){this.redirect(new Es(this.levelMap,this.game))}move(t){const e=this.levelMap.creaturePos(this.player).add(t),s=this.levelMap.at(e.x,e.y);s.passibleThrough(this.player)?this.player.on(new J(this.game,this.levelMap,e)):s.creature?this.player.on(new Qt(s.creature,this.levelMap,this.game)):(this.game.logger.ranIntoAnObstacle(),this.player.stageMemory(this.levelMap).at(e.x,e.y).see(s,0)),this.endTurn()}pickUpCommand(){const t=this.tile,e=t.items;void 0===e||0===e.bunch.length?this.game.logger.noItemsToPickUp():1===e.bunch.length?(this.player.on(new he(t,e.bunch,this.game)),this.endTurn()):this.redirect(new Ns(this.levelMap,this.game))}missileCommand(){const t=this.player.inventory.missileSlot.equipment;t&&t.item?t.item.canThrow(this.player)?this.redirect(new Ms(this.levelMap,this.game)):this.game.logger.needMissileWeapon():this.game.logger.nothingToShotWith()}handleCommand(){let t=this.levelMap.creaturePos(this.player),e=new Rs(t,this.game,this.levelMap),s=new ks(t,this.game,this.levelMap);this.tile.visit(e),t.wrappers().forEach(t=>{s.position=t,this.levelMap.at(t.x,t.y).visit(s)});const i=Object(o.concat)(e.commands,s.commands);switch(i.length){case 0:this.game.logger.howToHandle();break;case 1:this.player.on(i[0][1]),this.endTurn();break;default:this.redirect(new Is(i,this.levelMap,this.game,([t,e])=>{this.player.on(e),this.endTurn()}))}}}class Ps extends Ct{constructor(t,e,s,i){super(t,e),this.effect=s,this.match=i,this.memory=this.player.stageMemory(this.levelMap),this.targetPos=t.creaturePos(this.player),this.drawTarget()}act(){this.removeEffect(),this.close()}get memoryTile(){return this.memory.at(this.targetPos.x,this.targetPos.y)}moveTarget(t){const e=this.targetPos.add(t);this.match(e)&&this.updateTarget(e)}removeEffect(){this.memory.at(this.targetPos.x,this.targetPos.y).effect=void 0}updateTarget(t){this.removeEffect(),this.targetPos=t.copy(),this.drawTarget()}drawTarget(){this.memoryTile.effect=this.effect}}!function(t){t[t.See=0]="See",t[t.Recall=1]="Recall",t[t.Hidden=2]="Hidden"}(Me||(Me={}));class Es extends Ps{constructor(t,e){super(t,e,"_",t=>this.memory.inRange(t))}get type(){return pt.Look}get title(){return this.memoryTile.visible?Me.See:this.memoryTile.seen?Me.Recall:Me.Hidden}get body(){let t=[];if(this.memoryTile.creature&&(this.memoryTile.creature.id===this.player.id?t.push("Это я"):t.push(`Это ${this.memoryTile.creature.name}`)),this.memoryTile.items)switch(this.memoryTile.items.bunch.length){case 0:break;case 1:t.push(`Лежит ${this.memoryTile.items.bunch[0].item.name}`);break;default:t.push("Лежит несколько предметов")}return t}close(){this.redirect(new Ss(this.levelMap,this.game))}}class Os extends Ct{constructor(t,e,s){super(e,s),this.level=t,this.options=[],this.options=this.player.professions.map(t=>({profession:t,talents:t.talents.map(e=>Object.assign({},e,{status:this.status(e,t)}))}))}get type(){return pt.AbilitiesPicking}get title(){return"Pick new talent"}pickTalent(t,e){const s=this.player.professions.find(e=>e.id===t);if(void 0===s)throw`Profession with id ${t} is not found`;let i=s.talents.find(t=>t.id===e);if(void 0===i)throw`Talent with id ${e} for profession ${s.name} is not found`;if(this.status(i,s)!==We.Available)throw`Talent with id ${e} for profession ${s.name} can not be upgraded`;i.rank+=1,1===i.rank&&i.onObtain(this.game),s.points+=1,this.player.on(new ee),this.endTurn()}status(t,e){return t.rank===t.maxRank?We.Completed:t.depth*e.depthCost>e.points?We.Unavailable:We.Available}}class _s extends Ps{constructor(t,e){super(t,e,"x",({x:e,y:s})=>t.at(e,s).passibleThrough(this.player)&&this.memory.at(e,s).seen)}get type(){return pt.Teleportation}get title(){return"Выберите зону телепортации"}get body(){return[]}close(){this.targetPos.eq(this.levelMap.creaturePos(this.player))?this.game.logger.playerTeleportedWhereTheyWere():this.player.on(new J(this.game,this.levelMap,this.targetPos)),this.endTurn()}}class Ns extends ys{constructor(){super(...arguments),this.title="Что поднять?"}initPositions(){const t=this.tile.items;if(void 0===t)throw"Failed to show pick up dialog - tile has no items";this.positions=t.bunch.map(t=>({item:t.item,count:t.count}))}withItems(t){this.player.on(new he(this.tile,t,this.game)),this.endTurn()}}class Ds extends Ct{constructor(t,e,s){super(e,s),this.level=t}get type(){return pt.ProfessionPicking}get title(){return`Gained ${this.level} level`}get options(){return this.game.professionPicker.available(this.player)}pickProfession(t){let e=this.player.professions.find(e=>e.id===t.id);e?e.level+=1:this.player.professions.push(t),this.redirect(new Os(this.level,this.levelMap,this.game))}}class As extends ws{constructor(t,e,s,i){super(s,i),this.onWithItem=t,this.positions=e,this.title="Что надеть?"}initPositions(){}withItem(t){this.onWithItem(t)}close(){this.redirect(new Ws(this.levelMap,this.game))}}const Bs=function(t,e,s,i,r=!1){let a=h(t.width,t.height,()=>-1),n=[],l=[e],c=0;for(;l.length&&!n.length;){let e=[];l.forEach(r=>{if(!t.inRange(r))return;const o=t.at(r.x,r.y);s(o)||-1!==a[r.x][r.y]||(a[r.x][r.y]=c,i(r,o)?n.push(r):r.wrappers().forEach(t=>e.push(t)))}),c++,l=e}if(n.length){let t=Object(o.sample)(n);return $s(r&&t?t:n[0],a)}return[]},$s=function(t,e){let s,i=t,r=[i];for(;1!==e[i.x][i.y];){if(void 0===(s=l.dxy.find(t=>e[i.x+t.x]&&e[i.x+t.x][i.y+t.y]===e[i.x][i.y]-1)))return[];i=i.add(s),r.unshift(i)}return r};var Hs=i.a.extend({name:"Logger",props:{logger:{type:Ee,required:!0}},data:()=>({lastId:0}),computed:{messages(){const t=this.logger.messages.length,e=Object(o.takeRight)(this.logger.messages,Math.max(t-this.lastId,5));return this.lastId=t,e}},methods:{counter(t){if(t>1)return`x${t}`},rowClass(t){switch(t.level){case Ce.DEBUG:return"debug";case Ce.INFO:return"info";case Ce.WARNING:return"warning";case Ce.DANGER:return"danger"}}}}),Fs=(s(83),s(2)),Ls=Object(Fs.a)(Hs,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"logger"},t._l(t.messages,function(e,i){return s("div",{key:i,class:t.rowClass(e)},[t._v(t._s(e.message)+"\n"+t._s(t.counter(e.counter)))])}))},[],!1,null,"4926948c",null);Ls.options.__file="Logger.vue";var Gs=Ls.exports;class js{constructor(t,e,s,i,r,a,n){this.ch=t,this.r=e,this.g=s,this.b=i,this.br=r,this.bg=a,this.bb=n}getChar(){return this.ch}setChar(t){this.ch=t}setColor(t,e,s){this.r=t,this.g=e,this.b=s}setGrey(t){this.r=t,this.g=t,this.b=t}setBackground(t,e,s){this.br=t,this.bg=e,this.bb=s}backgroundToColor(){this.r=this.br,this.g=this.bg,this.b=this.bb}swapColors(){this.r=[this.br,this.br=this.r][0],this.g=[this.bg,this.bg=this.g][0],this.b=[this.bb,this.bb=this.b][0]}resetColor(){this.r=this.g=this.b=void 0}resetBackground(){this.br=this.bg=this.bb=void 0}getColorHex(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?"#"+this.r.toString(16)+this.g.toString(16)+this.b.toString(16):""}getBackgroundHex(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?"#"+this.br.toString(16)+this.bg.toString(16)+this.bb.toString(16):""}getColorRGB(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?`rgb(${this.r},${this.g},${this.b})`:""}getBackgroundRGB(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?`rgb(${this.br},${this.bg},${this.bb})`:""}getColorJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.r,g:this.g,b:this.b}:{}}getBackgroundJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.br,g:this.bg,b:this.bb}:{}}copy(t){this.ch=t.ch,this.r=t.r,this.g=t.g,this.b=t.b,this.br=t.br,this.bg=t.bg,this.bb=t.bb}clone(){return new js(this.ch,this.r,this.g,this.b,this.br,this.bg,this.bb)}}const Us="unicodetiles",qs=new js(" ");const Vs="\nattribute vec2 position;\nattribute vec2 texCoord;\nattribute vec3 color;\nattribute vec3 bgColor;\nattribute float charIndex;\nuniform vec2 uResolution;\nuniform vec2 uTileCounts;\nuniform vec2 uPadding;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec2 tileCoords = floor(vec2(mod(charIndex, uTileCounts.x), charIndex / uTileCounts.x));\n  vTexCoord = (texCoord + tileCoords) / uTileCounts;\n  vTexCoord += (0.5 - texCoord) * uPadding;\n  vColor = color;\n  vBgColor = bgColor;\n  vec2 pos = position / uResolution * 2.0 - 1.0;\n  gl_Position = vec4(pos.x, -pos.y, 0.0, 1.0);\n}\n",Ys="\nprecision mediump float;\nuniform sampler2D uFont;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec4 color = texture2D(uFont, vTexCoord);\n  color.rgb = mix(vBgColor, vColor, color.rgb);\n  gl_FragColor = color;\n}\n";const zs=function(t){return new class{constructor(t){if(this.view=t,this.view=t,this.canvas=document.createElement("canvas"),!this.canvas.getContext)throw"Canvas not supported";if(this.gl=this.canvas.getContext("experimental-webgl"),!this.gl)throw"WebGL not supported";if(t.elem.appendChild(this.canvas),this.charMap={},this.charArray=[],this.defaultColors={r:1,g:1,b:1,br:0,bg:0,bb:0},this.attribs={position:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},texCoord:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},color:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},bgColor:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},charIndex:{buffer:null,data:null,itemSize:1,location:null,hint:this.gl.DYNAMIC_DRAW}},this.offscreen||(this.offscreen=document.createElement("canvas")),this.offscreen.style.position="absolute",this.offscreen.style.top="0px",this.offscreen.style.left="0px",this.ctx=this.offscreen.getContext("2d"),!this.ctx)throw"Failed to acquire offscreen canvas drawing context";this.updateStyle(),this.canvas.width=(t.squarify?this.th:this.tw)*t.w,this.canvas.height=this.th*t.h,this.offscreen.width=0,this.offscreen.height=0,this.updateStyle(),this.gl.viewport(0,0,this.canvas.width,this.canvas.height);let e=this.compileShader(this.gl.VERTEX_SHADER,Vs),s=this.compileShader(this.gl.FRAGMENT_SHADER,Ys),i=this.gl.createProgram();if(this.gl.attachShader(i,e),this.gl.attachShader(i,s),this.gl.linkProgram(i),this.gl.deleteShader(e),this.gl.deleteShader(s),!this.gl.getProgramParameter(i,this.gl.LINK_STATUS)){const t=`Error linking program: ${this.gl.getProgramInfoLog(i)}`;throw this.gl.deleteProgram(i),t}this.gl.useProgram(i),this.attribs.position.location=this.gl.getAttribLocation(i,"position"),this.attribs.texCoord.location=this.gl.getAttribLocation(i,"texCoord"),this.attribs.color.location=this.gl.getAttribLocation(i,"color"),this.attribs.bgColor.location=this.gl.getAttribLocation(i,"bgColor"),this.attribs.charIndex.location=this.gl.getAttribLocation(i,"charIndex"),this.initBuffers();let r=this.gl.getUniformLocation(i,"uResolution");this.gl.uniform2f(r,this.canvas.width,this.canvas.height),this.tileCountsLocation=this.gl.getUniformLocation(i,"uTileCounts"),this.gl.uniform2f(this.tileCountsLocation,this.view.w,this.view.h),this.paddingLocation=this.gl.getUniformLocation(i,"uPadding"),this.gl.uniform2f(this.paddingLocation,0,0);let a=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.cacheChars(" !\"#$%&'()*+,-./0123456789:<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.activeTexture(this.gl.TEXTURE0),setTimeout(()=>{this.updateStyle(),this.buildTexture(),this.render()},100)}getRendererString(){return"webgl"}buildTexture(){let t=this.offscreen.width/(this.tw+this.pad),e=this.offscreen.height/(this.th+this.pad);const s=this.charArray.length;s>Math.floor(t)*Math.floor(e)&&(e=(t=Math.ceil(Math.sqrt(s)))+2,this.offscreen.width=t*(this.tw+this.pad),this.offscreen.height=e*(this.th+this.pad),this.updateStyle(),this.gl.uniform2f(this.tileCountsLocation,t,e)),this.gl.uniform2f(this.paddingLocation,this.pad/this.offscreen.width,this.pad/this.offscreen.height);let i,r=0;this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.offscreen.width,this.offscreen.height),this.ctx.fillStyle="#ffffff";const a=.5*this.gap,n=this.tw+this.pad,o=this.th+this.pad;let h=.5*o;for(let s=0;s<e;++s){let e=.5*this.pad;for(let s=0;s<t&&void 0!==(i=this.charArray[r]);++s,++r)this.ctx.fillText(i,e+a,h),e+=n;if(!i)break;h+=o}this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.offscreen)}cacheChars(t,e=!0){if(!this.gl)return;let s=!1;for(let e=0;e<t.length;++e)this.charMap[t[e]]||(s=!0,this.charArray.push(t[e]),this.charMap[t[e]]=this.charArray.length-1);s&&e&&this.buildTexture()}updateStyle(t){t=t||window.getComputedStyle(this.view.elem,null),this.ctx.font=t.fontSize+"/"+t.lineHeight+" "+t.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="#ffffff",this.tw=this.ctx.measureText("幅").width,this.th=parseInt(t.fontSize,10),this.gap=this.view.squarify?this.th-this.tw:0,this.view.squarify&&(this.tw=this.th),this.pad=2*Math.ceil(.2*this.th);const e=t.color.match(/\d+/g),s=t.backgroundColor.match(/\d+/g);this.defaultColors.r=parseInt(e[0],10)/255,this.defaultColors.g=parseInt(e[1],10)/255,this.defaultColors.b=parseInt(e[2],10)/255,this.defaultColors.br=parseInt(s[0],10)/255,this.defaultColors.bg=parseInt(s[1],10)/255,this.defaultColors.bb=parseInt(s[2],10)/255}clear(){}render(){this.gl.clear(this.gl.COLOR_BUFFER_BIT);const t=this.view.w,e=this.view.h;let s=this.view.buffer,i=(this.view.defaultColor,this.view.defaultBackground,!1);for(let r=0;r<e;++r)for(let e=0;e<t;++e){const a=s[r][e];let n=this.charMap[a.ch];void 0===n&&(this.cacheChars(a.ch,!1),i=!0,n=this.charMap[a.ch]);const o=6*this.attribs.color.itemSize*(r*t+e),h=6*this.attribs.charIndex.itemSize*(r*t+e),l=void 0===a.r?this.defaultColors.r:a.r/255,c=void 0===a.g?this.defaultColors.g:a.g/255,u=void 0===a.b?this.defaultColors.b:a.b/255,d=void 0===a.br?this.defaultColors.br:a.br/255,p=void 0===a.bg?this.defaultColors.bg:a.bg/255,m=void 0===a.bb?this.defaultColors.bb:a.bb/255;for(let t=0;t<6;++t){const e=o+t*this.attribs.color.itemSize;this.attribs.color.data[e+0]=l,this.attribs.color.data[e+1]=c,this.attribs.color.data[e+2]=u,this.attribs.bgColor.data[e+0]=d,this.attribs.bgColor.data[e+1]=p,this.attribs.bgColor.data[e+2]=m,this.attribs.charIndex.data[h+t]=n}}i&&this.buildTexture(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.color.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.color.data,this.attribs.color.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.bgColor.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.bgColor.data,this.attribs.bgColor.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.charIndex.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.charIndex.data,this.attribs.charIndex.hint);const r=this.attribs.position;this.gl.drawArrays(this.gl.TRIANGLES,0,r.data.length/r.itemSize)}compileShader(t,e){const s=this.gl.createShader(t);if(this.gl.shaderSource(s,e),this.gl.compileShader(s),!this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)){const t="Error compiling shader: "+this.gl.getShaderInfoLog(s);throw this.gl.deleteShader(s),t}return s}initBuffers(){let t,e,s=this.attribs;const i=this.view.w,r=this.view.h;for(t in this.attribs)(e=s[t]).data=new Float32Array(6*e.itemSize*i*r);for(let t=0;t<r;++t)for(let e=0;e<i;++e){const r=6*s.position.itemSize*(t*i+e);this.insertQuad(s.position.data,r,e*this.tw,t*this.th,this.tw,this.th),this.insertQuad(s.texCoord.data,r,0,0,1,1)}for(t in this.attribs)(e=s[t]).buffer&&this.gl.deleteBuffer(e.buffer),e.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e.data,e.hint),this.gl.enableVertexAttribArray(e.location),this.gl.vertexAttribPointer(e.location,e.itemSize,this.gl.FLOAT,!1,0,0)}insertQuad(t,e,s,i,r,a){const n=s,o=i,h=s+r,l=i+a;t[e]=n,t[++e]=o,t[++e]=h,t[++e]=o,t[++e]=n,t[++e]=l,t[++e]=n,t[++e]=l,t[++e]=h,t[++e]=o,t[++e]=h,t[++e]=l}}(t)};var Xs,Js;!function(t){t[t.AttackerTwoHandedWeapons=0]="AttackerTwoHandedWeapons",t[t.AttackerHeavyWeapons=1]="AttackerHeavyWeapons",t[t.AttackerLightWeapons=2]="AttackerLightWeapons",t[t.AttackerTwoWeapons=3]="AttackerTwoWeapons",t[t.AttackerDoubleTwoHandedWeapons=4]="AttackerDoubleTwoHandedWeapons",t[t.AttackerStrongGrip=5]="AttackerStrongGrip"}(Xs||(Xs={}));class Ks extends hs{constructor(t,e,s,i,r,a=""){super(t,e,s,i,r,a)}}class Qs extends Ks{constructor(){super(Xs.AttackerTwoHandedWeapons,"Двуручные оружия",0,0,3)}onObtain(t){}}!function(t){t[t.Attacker=0]="Attacker",t[t.Defender=1]="Defender"}(Js||(Js={}));class Zs extends ns{constructor(t=1){super(Js.Attacker,"Оружейник",t),this.talents.push(new Qs)}}class ti extends ns{constructor(t=1){super(Js.Defender,"Защитник",t)}}class ei extends os{constructor(t,e=new Zs,s=new ti){super([e,s],3,6),this.attacker=e,this.defender=s}}class si extends jt{worksWith(t){return t instanceof ri}}class ii extends jt{worksWith(t){return t instanceof ai}canThrow(t){return!!t.inventory.missileWeaponSlot.equipment}}class ri extends Ut{worksWith(t){return t instanceof si}}class ai extends Ut{worksWith(t){return t instanceof ii}}const ni=()=>new ai("Обычный лук",1,[{type:xe.Pierce,dice:{times:1,max:3},extra:3}],ft.wood),oi=()=>new si("Маленький камень",.3,[{type:xe.Blunt,dice:{times:1,max:3},extra:2}],ft.stone),hi=()=>new ii("Деревянная стрела",.2,[{type:xe.Pierce,dice:{times:1,max:4},extra:3}],ft.wood),li=()=>new ii("Железная стрела",.25,[{type:xe.Pierce,dice:{times:2,max:3},extra:3}],ft.iron);new Re([[1,()=>new qt("Катана",1,ft.iron,[{type:xe.Melee,dice:{times:5,max:2},extra:0}])],[7,()=>new qt("Кинжал",.8,ft.iron,[{type:xe.Melee,dice:{times:1,max:3},extra:2}])]]),new Re([[1,()=>new Yt("Кольчуга",5,ft.iron,[{type:xt.Medium,value:3}])],[5,()=>new Yt("Латы",3,ft.iron,[{type:xt.Heavy,value:5}])],[10,()=>new Yt("Роба",1,ft.iron,[{type:xt.Unarmored,value:1}])],[100,()=>new class extends Lt{constructor(){super("Зелье лечения")}onDrink(t){t.player.health.increase(5)}}]]);class ci extends zt{constructor(){super("Кроссовки скорости света",.1,ft.cloth,[]),this.impacts=[w.Blind]}}class ui extends ht{constructor(){super(),this.escaper=new it,this.explorer=new rt,this.chaser=new et,this.attacker=new tt,this.picker=new St,this.patrol=new dt,this.loiter=new at,this.thrower=new Dt,this.descender=new Nt}act(t,e,s){let i;return this.runEvents(),this.feelsGood(t)?(i=this.attacker.act(t,e,s))||(i=this.thrower.act(t,e,s))||(i=this.chaser.act(t,e,s))||(i=this.picker.act(t,e,s))||(i=this.explore(t,e,s)):this.healthCritical(t)&&(i=this.escaper.act(t,e,s))||(i=this.attacker.act(t,e,s))||(i=this.thrower.act(t,e,s))||(i=this.chaser.act(t,e,s))||(i=(new Et).act(t,e)),this.resetEvents(),i}feelsGood(t){return t.health.currentValue>.9*t.health.maximum}healthCritical(t){return t.health.currentValue<t.health.maximum/4}explore(t,e,s){let i;return(i=this.explorer.act(t,e,s))?t.dead||this.patrol.trackMovement(e.creaturePos(t),e.creatureTile(t)):(i=this.descender.act(t,e,s))||(i=this.patrol.act(t,e,s))||(i=this.loiter.act(t,e,s)),i}}const di=(t,e=[],s)=>new class extends z{constructor(t,e,s=z.getId()){super(e,s),this.ai=t}act(t,e){this.statsTurn(),this.visionMask(t);const s=this.ai.act(this,t,e);return s&&this.on(s),this.on(new f(t,e)),this.speed}get missile(){if(this.specie.throwingItem)return{item:this.specie.throwingItem,count:1}}get inventoryItems(){return this.bag?this.bag.bunch:[]}addItem(t,e){this.bag||(this.bag=new v),this.bag.put(t,e)}removeItem(t,e){if(!this.bag)throw`Creature ${this.name} tried to remove item ${t.name} but it does not present`;this.bag.remove(t,e)}}(new ui,{name:t,weight:10,clan:U.PlayerOnlyEnemy,abilities:[],protections:e,damages:s,maxHealthValue:1,regenerationRate:5,regenerationValue:1,resistances:[],visionRadius:5,moveSpeed:20,attackSpeed:20,bodyControl:5,leavesCorpseRatio:50,material:ft.flesh,throwingDamages:[]}),pi=()=>di("Golem",[{type:xt.Solid,value:5}],[{type:xe.Blunt,dice:{times:1,max:5},extra:10}]),mi=(new Re([[100,()=>di("Rat",[],[{type:xe.Melee,dice:{times:2,max:2},extra:0}])],[3,pi]]),new Map);mi.set("C",()=>new M("C",y.Floor)),mi.set("W",()=>new k),mi.set("R",()=>new W("R",y.Floor)),mi.set("D",()=>new R);const gi="Traps",fi="2nd";class vi extends Se{enter(t,e){(t.currentMap=t.getMap(gi)).addCreature(new l(3,27),e)}register(t){t.addMap(gi,(t,e)=>{let s=this.generateMap(t,["WWWWWWWWWWWWW","WWWWRRRWWWWWW","WWWWRRRWWWWWW","WWWWRRRWWWWWW","WWWWWCWWWWWWW","WRRRWCWRRRWWW","WRRRCCCRRRWWW","WRRRWCWRRRWWW","WWWWWCWWWWWWW","WRRRWCWRRRWWW","WRRRCCCRRRWWW","WRRRWCWRRRWWW","WWWWWCWWWWWWW","WRRRWCWRRRWWW","WRRRCCCRRRWWW","WRRRWCWRRRWWW","WWWWWCWWWWWWW","WRRRWCWRRRWWW","WRRRCCCRRRWWW","WRRRWCWRRRWWW","WWWWWCWWWWWWW","WRRRWCWRRRWWW","WRRRCCCRRRWWW","WRRRWCWRRRWWW","WWWWWCWWWWWWW","WWWWWCWRRRRRW","WRRRWCWRRRRRW","WRRRCCCRRRRRW","WRRRWCWRRRRRW","WWWWWCWRRRRRW","WWWWWWWWWWWWW"]);return s.setTile(5,2,new P(s,fi)),s.setTile(4,6,new N("Teleportation trap",!1,new I)),s.setTile(2,6,new gs(new I)),s.setTile(6,6,new N("Light trap",!1,new I)),s.setTile(8,6,new ms(new I)),s.setTile(4,10,new N("Hole trap",!1,new I)),s.setTile(2,10,new ps(new I)),s.setTile(6,10,new N("Bare wire",!1,new I)),s.setTile(8,10,new us(new I)),s.setTile(4,14,new N("Water trap",!1,new I)),s.setTile(2,14,new fs(new I)),s.setTile(6,14,new N("Falling rock trap",!1,new I)),s.setTile(8,14,new ds(oi,new I)),s.setTile(6,27,new N("Air blow trap",!1,new I)),s.setTile(9,27,new ls(new I)),s}),t.addMap(fi,(t,e)=>{let s=this.generateMap(t,["WWWWW","WRRRW","WRRRW","WRRRW","WWWWW"]);return s.setTile(2,1,new E(s,gi)),s.addCreature(new l(1,1),pi()),s})}generateMap(t,e){return new Pe(t,ye(e,mi))}}const wi=new Map;wi.set("C",()=>new M("C",y.Floor)),wi.set("W",()=>new k),wi.set("R",()=>new W("R",y.Floor)),wi.set("D",()=>new R);class yi extends Be{constructor(t){super(t,new ei(t))}}var bi;!function(t){t[t.Human=0]="Human",t[t.Dwarf=1]="Dwarf"}(bi||(bi={}));const xi=120,Ti=180,Ci={r:255,g:165,b:0};class Wi extends js{lighted(t){return this}constructor(t,e=xi,s=xi,i=xi){super(t,e,s,i)}litBackground(t,e){return t.setBackground(Ci.r*e,Ci.g*e,Ci.b*e),t}litColor(t,e){return t.setColor(Ci.r*e,Ci.g*e,Ci.b*e),t}}class Mi extends Wi{constructor(t){super(t,Ti,Ti,Ti)}}class Ii extends Mi{constructor(t,e,s,i){super(t),this.vr=e,this.vg=s,this.vb=i}lighted(t){let e=this.clone();return e.setColor(this.vr,this.vg,this.vb),e}}class Ri extends Wi{constructor(t,e,s,i){super(t),this.vr=e,this.vg=s,this.vb=i}lighted(t){let e=this.clone();return e.setColor(this.vr,this.vg,this.vb),e}}const ki=new Ri("刀",200,200,200),Si=new Ri("体",200,200,200),Pi=new Ri("胸",200,200,200),Ei=new Ri("石",200,200,200),Oi=new Ri("]",200,200,200),_i=new Ri("[",255,255,0),Ni=new Ri("?",255,255,255),Di=new Ri("！",200,200,200),Ai=function(t){switch(t.group){case wt.OneHandWeapon:return ki;case wt.Consumable:return Si;case wt.BodyArmor:return Pi;case wt.Missile:return Ei;case wt.MissileWeapon:return Oi;case wt.Potion:return Di;case wt.Boots:return _i;case wt.Scrolls:return Ni;default:return Si}},Bi=new class extends Wi{constructor(){super("戸")}lighted(t){let e=this.clone();return this.litColor(e,t),e.swapColors(),e}},$i=new class extends Wi{constructor(){super("＃")}lighted(t){let e=this.clone();return this.litBackground(e,t),e.backgroundToColor(),e}},Hi=new class extends Wi{constructor(){super("・")}lighted(t){return this.litColor(this.clone(),t)}},Fi=new class extends Wi{constructor(){super("＞")}},Li=new class extends Wi{constructor(){super("＜")}},Gi=new Wi("　",0,0,0),ji=new Wi("^",255,255,255),Ui=new Wi("^",0,191,255),qi=new Wi("^",255,255,0),Vi=new Wi("^",139,69,19),Yi=new Wi("^",255,165,0),zi=new Wi("^",200,200,200),Xi=new Wi("^",0,0,205);const Ji=new class extends D{onWall(t){this.tile=$i}onFloor(t){this.tile=Hi}onStairwayDown(t){this.tile=Fi}onStairwayUp(t){this.tile=Li}onDoor(t){this.tile=Bi}onTrap(t){if(t.revealed)switch(t.type){case b.AirBlow:this.tile=ji;break;case b.Teleportation:this.tile=Ui;break;case b.Light:this.tile=qi;break;case b.Hole:this.tile=Vi;break;case b.BareWire:this.tile=Yi;break;case b.FallingRock:this.tile=zi;break;case b.Water:this.tile=Xi}else t.tile.visit(this)}onTrigger(t){t.tile.visit(this)}default(t){this.tile=Gi}},Ki=new Ii("＠",0,255,0),Qi=new Ii("r",197,65,38),Zi=new Ii("G",120,120,120),tr=new Wi("　",0,0,0),er=[new Ri("｜",200,200,200),new Ri("／",200,200,200),new Ri("ー",200,200,200),new Ri("＼",200,200,200)];var sr=i.a.extend({props:["level","player","pos"],data:()=>({wholeMap:!1,term:null,eng:null,drawInterval:null,ts:Date.now(),interval:100,step:0}),methods:{getTile(t,e){const s=this.stage.at(t,e).effect,i=this.wholeMap?this.stage.at(t,e):this.stage.at(t,e).tile;if(!i)return tr;if(s){if(i.creature){let t=this.creatureTile(i.creature).clone();return t.setBackground(200,0,0),t}return new Wi(s,200,200,0)}if(i.creature)return this.creatureTile(i.creature);if(i.items)switch(i.items.bunch.length){case 0:break;case 1:return Ai(i.items.bunch[0].item);default:const t=this.step%(3*this.animationFps+4);if(t<er.length)return er[t];{const t=Math.floor(this.step/(3*this.animationFps+4));return Ai(i.items.bunch[t%i.items.bunch.length].item)}}return function(t){return t.visit(Ji),Ji.tile}(i)},creatureTile:t=>"Rat"==t.name?Qi:"Golem"==t.name?Zi:Ki,initViewport(){this.term=new class{constructor(t,e,s,i,r=!1){this.elem=t,this.w=e,this.h=s,this.squarify=r,this.cx=Math.floor(e/2),this.cy=Math.floor(s/2),this.elem.innerHTML="",-1===t.className.indexOf(Us)&&(0===t.className.length?t.className=Us:t.className+=" "+Us),this.buffer=new Array(s);for(let t=0;t<s;++t){this.buffer[t]=new Array(e);for(let s=0;s<e;++s)this.buffer[t][s]=qs}this.renderer=i(this)}updateStyle(t){const e=window.getComputedStyle(this.elem,null);this.defaultColor=e.color||void 0,this.defaultBackground=e.backgroundColor||void 0,t&&this.renderer.updateStyle(e)}getRendererString(){return this.renderer.getRendererString()}put(t,e,s){e<0||s<0||e>=this.w||s>=this.h||(this.buffer[s][e]=t)}unsafePut(t,e,s){this.buffer[s][e]=t}putString(t,e,s,i,r,a,n,o,h){const l=t.length;if(!(e<0||s<0))for(let c=0;c<l;++c){if(e>=this.w&&(e=0,++s),s>=this.h)return;const l=new js(t[c],i,r,a,n,o,h);this.unsafePut(l,e,s),++e}}get(t,e){return t<0||e<0||t>=this.w||e>=this.h?qs:this.buffer[e][t]}clear(){for(let t=0;t<this.h;++t)for(let e=0;e<this.w;++e)this.buffer[t][e]=qs;this.renderer.clear()}render(){this.renderer.render()}}(this.$refs.scene,Math.max(this.level.width,40),Math.max(this.level.height,40),zs,!0),this.eng=new class{constructor(t,e,s,i){this.viewport=t,this.tileFunc=e,this.w=s,this.h=i,this.refreshCache=!0,this.cacheEnabled=!1,this.transitionDuration=0,this.cachex=0,this.cachey=0,this.tileCache=new Array(t.h),this.tileCache2=new Array(t.h);for(let e=0;e<t.h;++e)this.tileCache[e]=new Array(t.w),this.tileCache2[e]=new Array(t.w)}setTileFunc(t,e,s){e&&(this.transition=void 0,"string"==typeof e&&("boxin"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return t-=o,e-=h,Math.abs(t)<o*n&&Math.abs(e)<h*n?r:a}:"boxout"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return t-=o,e-=h,n=1-n,Math.abs(t)<o*n&&Math.abs(e)<h*n?a:r}:"circlein"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return(t-=o)*t+(e-=h)*e<(o*o+h*h)*n?r:a}:"circleout"===e?this.transition=function(t,e,s,i,r,a,n){const o=.5*s,h=.5*i;return(t-=o)*t+(e-=h)*e>(o*o+h*h)*(n=1-n)?r:a}:"random"===e&&(this.transition=function(t,e,s,i,r,a,n){return Math.random()>n?a:r})),this.transition&&(this.transitionTimer=(new Date).getTime(),this.transitionDuration=s||500)),this.tileFunc=t}setMaskFunc(t){this.maskFunc=t}setShaderFunc(t){this.shaderFunc=t}setWorldSize(t,e){this.w=t,this.h=e}setCacheEnabled(t){this.cacheEnabled=t,this.refreshCache=!0}update(t,e){t=t||0,e=e||0;const s=t-this.viewport.cx,i=e-this.viewport.cy,r=(new Date).getTime();let a,n;this.transition&&this.transitionTimer&&(a=(r-this.transitionTimer)/this.transitionDuration),a&&a>=1&&(this.transition=void 0);for(let t=0;t<this.viewport.h;++t)for(let e=0;e<this.viewport.w;++e){const o=e+s,h=t+i;if(this.w&&(o<0||o>=this.w))n=qs;else if(this.h&&(h<0||h>=this.h))n=qs;else if(this.maskFunc&&!this.maskFunc(o,h))n=qs;else if(this.transition&&!this.refreshCache)n=this.transition(e,t,this.viewport.w,this.viewport.h,this.tileFunc(o,h),this.tileCache[t][e],a||0);else if(this.cacheEnabled&&!this.refreshCache){const t=o-this.cachex,e=h-this.cachey;t>=0&&t<this.viewport.w&&e>=0&&e<this.viewport.h?(n=this.tileCache[e][t])===qs&&(n=this.tileFunc(o,h)):n=this.tileFunc(o,h)}else n=this.tileFunc(o,h);this.tileCache2[t][e]=n,this.shaderFunc&&n!==qs&&(n=this.shaderFunc(n,o,h,r)),this.viewport.unsafePut(n,e,t)}this.cachex=s,this.cachey=i;const o=this.tileCache;this.tileCache=this.tileCache2,this.tileCache2=o,this.refreshCache=!1}}(this.term,(t,e)=>this.getTile(t,e),this.level.width,this.level.height),this.eng.setMaskFunc((t,e)=>this.wholeMap||this.stage.at(t,e).seen),this.eng.setShaderFunc((t,e,s,i)=>this.lighting(t,e,s,i)),clearInterval(this.drawInterval),this.drawInterval=setInterval(()=>{this.drawScene()},this.interval)},drawScene(){const t=Date.now();this.ts+1e3<t&&(this.ts=t),this.eng.update(this.pos.x,this.pos.y),this.term.render(),this.step+=1},lighting(t,e,s,i){if(this.wholeMap)return t.lighted(1);const r=this.stage.at(e,s);return r.visible&&t.lighted?t.lighted(r.degree):t}},computed:{stage(){return this.wholeMap?this.level:this.player.stageMemory(this.level)},animationFps(){return 1e3/this.interval}},mounted(){this.initViewport()},beforeDestroy(){clearInterval(this.drawInterval)},watch:{interval(){this.initViewport()},level(){clearInterval(this.drawInterval),this.initViewport()}}}),ir=(s(85),Object(Fs.a)(sr,function(){var t=this.$createElement;return(this._self._c||t)("div",{ref:"scene",staticClass:"unicodetiles"})},[],!1,null,null,null));ir.options.__file="Scene.vue";var rr=ir.exports,ar=i.a.extend({name:"PrimaryAttribute",props:["name","slug","attr","fullName"],computed:{id(){return`${this.slug}-container`},modifier(){return Object(o.sum)(this.attr.modifiers)}}}),nr=Object(Fs.a)(ar,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"simple-popover",attrs:{id:t.id}},[s("div",{staticClass:"title"},[t._v(t._s(t.name))]),s("div",{staticClass:"value"},[t._v(t._s(t.attr.current))]),s("b-popover",{attrs:{target:t.id,triggers:"hover",container:t.id,placement:"top"}},[[s("big",{staticClass:"name"},[t._v(t._s(t.fullName))]),s("p",[s("span",{staticClass:"name"},[t._v("Базовый:")]),t._v(" "),s("span",{staticClass:"description"},[t._v(t._s(t.attr.current))])]),s("p",[s("span",{staticClass:"name"},[t._v("Модификатор:")]),t._v(" "),s("span",{staticClass:"description"},[t._v(t._s(t.modifier))])])]],2)],1)},[],!1,null,null,null);nr.options.__file="PrimaryAttribute.vue";var or=nr.exports;const hr=function({extra:t,dice:{times:e,max:s},type:i}){let r=`${lr(i)} ${e}d${s}`;return t&&(r+=`+${t}`),r},lr=function(t){switch(t){case xe.Melee:return"Me";case xe.Pierce:return"Pi";case xe.Blunt:return"B";case xe.Magic:return"Mg";case xe.Pure:return"Pu";default:return"unknown damage type"}},cr=function({type:t,value:e}){switch(t){case xt.Light:return`L${e}`;case xt.Medium:return`M${e}`;case xt.Heavy:return`H${e}`;case xt.Solid:return`S${e}`;case xt.Unarmored:return`U${e}`;default:return"unknown protection type"}};var ur=i.a.extend({name:"Stats",props:["creature","levelMap"],components:{PrimaryAttribute:or},computed:{levelProgress(){const t=this.creature.level;return`${t.currentExperience/t.requiredExperience*100}%`},healthLevel(){const t=this.creature.health;return`${t.currentValue/(t.maximum||0)*100}%`},protections(){return this.creature.protections.map(cr).join(", ")},damages(){return this.creature.damages.map(hr).join(", ")}},methods:{displayAttribute:t=>t.currentValue!=t.maximum?`${t.currentValue} / ${t.maximum}`:t.currentValue}}),dr=(s(87),Object(Fs.a)(ur,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"panel container"},[s("div",{staticClass:"level cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.creature.level.current))]),s("div",{staticClass:"note"},[t._v("Уровень"),s("div",{staticClass:"progress"},[s("div",{staticClass:"progress-bar bg-success",style:{width:t.levelProgress},attrs:{role:"progressbar"}})])])]),s("div",{staticClass:"hp cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.displayAttribute(t.creature.health)))]),s("div",{staticClass:"bar",style:{height:t.healthLevel}})]),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"strength",name:"St","full-name":"Сила",attr:t.creature.strength}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"dexterity",name:"Dx","full-name":"Ловкость",attr:t.creature.dexterity}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"constitution",name:"Co","full-name":"Телосложение",attr:t.creature.constitution}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"intelligence",name:"In","full-name":"Интеллект",attr:t.creature.intelligence}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"wisdom",name:"Ws","full-name":"Мудрость",attr:t.creature.wisdom}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"charisma",name:"Ch","full-name":"Харизма",attr:t.creature.charisma}}),s("div",{staticClass:"cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.levelMap.name))])]),s("div",{staticClass:"cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.protections))])]),s("div",{staticClass:"cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.damages))])])],1)},[],!1,null,"20a5072e",null));dr.options.__file="Stats.vue";var pr=dr.exports,mr=i.a.extend({name:"Impacts",props:["impacts"],methods:{icon(t){switch(t){case w.Blind:return"blind";case w.Stressed:case w.Loaded:case w.Overloaded:return"weight"}},title(t){switch(t){case w.Blind:return"Слепота";case w.Stressed:return"Нагружен";case w.Loaded:return"Груженый";case w.Overloaded:return"Перегруженый"}}}}),gr=(s(89),Object(Fs.a)(mr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"panel"},t._l(t.impacts,function(e){return s("div",{staticClass:"impact-block"},[s("img",{staticClass:"icon",attrs:{src:"assets/impacts/"+t.icon(e)+".svg"}}),s("div",{staticClass:"title",domProps:{textContent:t._s(t.title(e))}})])}))},[],!1,null,"436b0ad3",null));gr.options.__file="Impacts.vue";var fr=gr.exports,vr=i.a.extend({name:"IdleView",props:["screen"],methods:{onEvent(t){switch(t.key){case"l":case"ArrowRight":return this.screen.move(p.right);case"h":case"ArrowLeft":return this.screen.move(p.left);case"k":case"ArrowUp":return this.screen.move(p.up);case"j":case"ArrowDown":return this.screen.move(p.down);case"y":return this.screen.move(p.upLeft);case"u":return this.screen.move(p.upRight);case"b":return this.screen.move(p.downLeft);case"n":return this.screen.move(p.downRight);case"H":return this.screen.handleCommand();case"L":return this.screen.lookCommand();case"s":case".":return this.screen.stayCommand();case"i":return this.screen.inventoryCommand();case"I":return this.screen.bagCommand();case"t":return this.screen.missileCommand();case",":return this.screen.pickUpCommand();case"d":return this.screen.dropCommand();case"D":return this.screen.drinkCommand();case"@":return this.screen.characterInfo();default:console.log("Key: ",t.key)}}}}),wr=Object(Fs.a)(vr,function(){var t=this.$createElement;return(this._self._c||t)("div")},[],!1,null,null,null);wr.options.__file="IdleView.vue";var yr=wr.exports,br=i.a.extend({props:["screen"],data:()=>({picked:null}),methods:{close(t){const e=t||this.picked;e&&this.screen.pickProfession(e)},onEvent(t){switch(t.key){case"a":this.picked=this.screen.options[0];break;case"b":this.picked=this.screen.options[1];break;case" ":case"Enter":this.close();default:return}},iconPath:t=>"assets/professions/"+["acrobatic.svg","button-finger.svg","disintegrate.svg","flying-fox.svg","amputation.svg","catch.svg","divert.svg","fruiting.svg","annexation.svg","conversation.svg","dodging.svg","grab.svg","arrest.svg","convince.svg","drinking.svg","journey.svg","back-forth.svg","coronation.svg","drop-weapon.svg","juggler.svg","backstab.svg","crafting.svg","drowning.svg","jump-across.svg","boot-stomp.svg","crush.svg","eating.svg","kindle.svg","bowman.svg","discussion.svg","expander.svg","kneeling.svg"][t]}}),xr=(s(91),Object(Fs.a)(br,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal text-center"},[s("div",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("div",{staticClass:"content"},t._l(t.screen.options,function(e){return s("div",{key:e.id,staticClass:"option p-2 m-3",class:{picked:t.picked&&t.picked.id===e.id},on:{click:function(s){t.picked=e},dblclick:function(s){t.close(e)}}},[s("img",{staticClass:"icon",attrs:{src:t.iconPath(e.id)}}),s("div",{staticClass:"name"},[t._v(t._s(e.name))])])})),s("div",{staticClass:"bottom"},[null!==t.picked?s("b-btn",{attrs:{variant:"success"},on:{click:t.close}},[t._v("Подтвердить")]):t._e()],1)])},[],!1,null,null,null));xr.options.__file="ProfessionPickingView.vue";var Tr=xr.exports;var Cr=i.a.extend({name:"Inventory",props:["screen"],data:()=>({page:0,perPage:20,selected:[]}),computed:{player(){return this.screen.player},carryingWeight(){return`Нагрузка ${Math.round(100*this.player.stuffWeight.current)/100} из ${this.player.carryingCapacity.stressed}`}},methods:{onEvent(t){switch(t.key){case"Escape":return this.screen.close();case"Enter":case" ":return this.screen.withItems(this.selected.map(t=>this.screen.positions[t]));default:return this.selectAt(t.key.charCodeAt(0)-97)}},selectAt(t){t>=0&&t<Math.min(this.perPage,this.screen.positions.length)&&(this.screen.singleItemMode?this.screen.withItem(this.screen.positions[t]):this.selected.indexOf(t)>=0?this.selected.splice(this.selected.indexOf(t),1):this.selected.push(t))},indexLetter:t=>String.fromCharCode(97+t),positionSelected(t){return this.selected.indexOf(t)>=0},positionStatus:t=>t.item?"text-success":"",itemWeight:t=>Math.round(t.item.weight*t.count*100)/100}}),Wr=(s(93),Object(Fs.a)(Cr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("span",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("div",{staticClass:"subtitle my-3",domProps:{textContent:t._s(t.carryingWeight)}}),s("table",{staticClass:"container positions-list"},t._l(t.screen.positions,function(e,i){return s("tr",{key:i,class:t.positionStatus(e)},[s("td",{staticClass:"selected"},[t.positionSelected(i)?s("div",{staticClass:"sign"},[t._v("+")]):t._e()]),s("td",{staticClass:"letter"},[t._v(t._s(t.indexLetter(i)))]),s("td",{staticClass:"separator"},[t._v("—")]),s("td",{staticClass:"name"},[t._v(t._s(e.item.name)+" ("+t._s(e.count)+")")]),s("td",{staticClass:"weight"},[t._v("["+t._s(t.itemWeight(e))+"kg]")])])}))])},[],!1,null,null,null));Wr.options.__file="ItemsListingView.vue";var Mr=Wr.exports;var Ir=i.a.extend({props:["screen"],data:()=>({picked:null,professionIndex:0}),computed:{option(){return this.screen.options[this.professionIndex]},profession(){return this.option.profession},groupedTalents(){let t=new Array(5);for(let e=0;e<t.length;e++)t[e]=[];let e=0;return this.option.talents.forEach(s=>{s.status===We.Available&&Object.assign(s,{letter:String.fromCharCode(97+e++)}),t[s.depth].push(s)}),t}},methods:{close(t){const e=t||this.picked;e&&e.status===We.Available&&(this.screen.pickTalent(this.profession.id,e.id),this.picked=null)},pickTalent(t){t.status===We.Available&&(this.picked=t)},onEvent(t){switch(t.key){case" ":case"Enter":this.close();default:this.groupedTalents.forEach(e=>e.forEach(e=>{e.letter===t.key&&(this.picked=e)}));const e=parseInt(t.key);e>=1&&e<=this.screen.options.length&&(this.professionIndex=e-1)}},talentTip(t){let e=`${t.rank}/${t.maxRank}`;return t.rank>=t.maxRank?e:`${t.letter} ${e}`},talentStatus(t){if(this.picked&&this.picked.id===t.id)return"-selected";switch(t.status){case We.Available:return"-available";case We.Unavailable:return"-unavailable";case We.Completed:return"-completed"}},iconPath(t){switch(t){case Xs.AttackerTwoHandedWeapons:return"AttackerTwoHandedWeapons.svg";case Xs.AttackerHeavyWeapons:return"AttackerHeavyWeapons.svg";case Xs.AttackerLightWeapons:return"AttackerLightWeapons.svg";case Xs.AttackerTwoWeapons:return"AttackerTwoWeapons.svg";case Xs.AttackerDoubleTwoHandedWeapons:return"AttackerDoubleTwoHandedWeapons.svg";case Xs.AttackerStrongGrip:return"AttackerStrongGrip.svg"}}},watch:{professionIndex(){this.picked=null}}}),Rr=(s(95),Object(Fs.a)(Ir,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"simple-popover screen-modal text-center",attrs:{id:"talents-tree-container"}},[s("div",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("b-tabs",{staticClass:"tabs-list",attrs:{card:""},model:{value:t.professionIndex,callback:function(e){t.professionIndex=e},expression:"professionIndex"}},t._l(t.screen.player.professions,function(t){return s("b-tab",{key:t.id,attrs:{title:t.name,"no-body":""}})})),s("table",{staticClass:"content"},t._l(t.groupedTalents,function(e,i){return s("tr",{key:i},t._l(e,function(e,r){return s("td",{key:r,staticClass:"cell"},[s("div",{staticClass:"talent-cell",class:t.talentStatus(e),attrs:{id:r+"talentTree-"+i,variant:"primary"},on:{click:function(s){t.pickTalent(e)},dblclick:function(s){t.close(e)}}},[s("img",{staticClass:"icon",attrs:{src:"assets/talents/"+t.iconPath(e.id)}}),s("span",{staticClass:"level"},[t._v(t._s(t.talentTip(e)))]),s("b-popover",{attrs:{target:r+"talentTree-"+i,triggers:"hover",container:"talents-tree-container"}},[[s("p",{staticClass:"name"},[t._v(t._s(e.name))]),s("small",[s("p",{staticClass:"rank"},[t._v("Уровень "+t._s(e.rank)+"/"+t._s(e.maxRank))]),"-unavailable"===t.talentStatus(e)?s("p",{staticClass:"requirements"},[t._v("Требуется "+t._s(e.depth*t.profession.depthCost)+" очков в "+t._s(t.profession.name))]):t._e(),s("p",{staticClass:"description"},[t._v(t._s(e.description))])])]],2)],1)])}))})),null!==t.picked?s("b-btn",{attrs:{variant:"default"},on:{click:function(e){t.close()}}},[t._v("Подтвердить")]):t._e()],1)},[],!1,null,null,null));Rr.options.__file="TalentsTreeView.vue";var kr=Rr.exports;var Sr=i.a.extend({name:"Inventory",props:["screen"],data:()=>({page:0,perPage:20}),computed:{player(){return this.screen.player},carryingWeight(){return`Нагрузка ${Math.round(100*this.player.stuffWeight.current)/100} из ${this.player.carryingCapacity.stressed}`}},methods:{onEvent(t){switch(t.key){case" ":case"Escape":return this.screen.close();default:return this.selectAt(t.key.charCodeAt(0)-97)}},selectAt(t){if(t>=0&&t<Math.min(this.perPage,this.screen.positions.length)){const e=this.screen.positions[t];e.item?this.screen.takeOff(e):e.availableItems.length&&this.screen.putOn(e)}},positionDetails(t){if(t.item&&t.item.canSeeDetails)return function(t){return t instanceof Gt?t.damages.map(hr).join(","):t instanceof Vt?t.protections.map(cr).join(","):void 0}(t.item)},indexLetter:t=>String.fromCharCode(97+t),positionStatus:t=>t.item?"text-success":"",displayBodyPart:t=>t.name,displayItem(t){if(t)return`${Ai(t).getChar()} ${t.name}`},itemName:t=>t.item&&t.count?`${t.item.name} ${t.count>1?`(${t.count})`:""}`:"-",itemWeight(t){if(t.item&&t.count)return`[${t.item.weight*t.count}kg]`},available:t=>t.item||t.availableItems.length,availableStatus(t){return this.available(t)?"-available":"-unavailable"}}}),Pr=(s(97),Object(Fs.a)(Sr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("div",{staticClass:"h4 title"},[t._v("Инвентарь")]),s("div",{staticClass:"subtitle my-3",domProps:{textContent:t._s(t.carryingWeight)}}),s("table",{staticClass:"content inventory-list"},t._l(t.screen.positions,function(e,i){return s("tr",{key:i,class:t.availableStatus(e)},[s("td",{staticClass:"slot"},[s("span",{staticClass:"letter"},[t._v(t._s(t.indexLetter(i)))]),s("span",{staticClass:"dash"},[t._v("—")]),s("span",{staticClass:"part"},[t._v(t._s(t.displayBodyPart(e.inventorySlot)))]),s("span",{staticClass:"separator"},[t._v(":")])]),s("td",{staticClass:"name-slot"},[s("span",{staticClass:"name",class:t.positionStatus(e)},[t._v(t._s(t.itemName(e)))]),s("small",{staticClass:"details",domProps:{textContent:t._s(t.positionDetails(e))}})]),s("td",{staticClass:"weight"},[t._v(t._s(t.itemWeight(e)))])])}))])},[],!1,null,null,null));Pr.options.__file="InventoryView.vue";var Er=Pr.exports,Or=i.a.extend({name:"PickPointView",props:["screen"],computed:{title(){switch(this.screen.title){case Me.See:return"Вижу ...";case Me.Recall:return"Вспоминаю ...";case Me.Hidden:return"Без понятия ...";default:return this.screen.title}}},methods:{close(t){this.screen.onInput(t)},onEvent(t){switch(t.key){case"l":case"ArrowRight":return this.screen.moveTarget(p.right);case"h":case"ArrowLeft":return this.screen.moveTarget(p.left);case"k":case"ArrowUp":return this.screen.moveTarget(p.up);case"j":case"ArrowDown":return this.screen.moveTarget(p.down);case"y":return this.screen.moveTarget(p.upLeft);case"u":return this.screen.moveTarget(p.upRight);case"b":return this.screen.moveTarget(p.downLeft);case"n":return this.screen.moveTarget(p.downRight);case"Escape":case" ":this.screen.close()}}}}),_r=(s(99),Object(Fs.a)(Or,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"look-modal"},[s("div",{staticClass:"title",domProps:{textContent:t._s(t.title)}}),t._l(t.screen.body,function(e){return s("div",{domProps:{textContent:t._s(e)}})})],2)},[],!1,null,"7db82404",null));_r.options.__file="PickPointView.vue";var Nr=_r.exports,Dr=i.a.extend({name:"MissileView",props:["screen"],methods:{close(t){this.screen.onInput(t)},onEvent(t){switch(t.key){case"l":case"ArrowRight":return this.screen.moveTarget(p.right);case"h":case"ArrowLeft":return this.screen.moveTarget(p.left);case"k":case"ArrowUp":return this.screen.moveTarget(p.up);case"j":case"ArrowDown":return this.screen.moveTarget(p.down);case"y":return this.screen.moveTarget(p.upLeft);case"u":return this.screen.moveTarget(p.upRight);case"b":return this.screen.moveTarget(p.downLeft);case"n":return this.screen.moveTarget(p.downRight);case">":this.screen.nextTarget();break;case"<":this.screen.previousTarget();break;case"t":this.screen.attack();break;case"Escape":this.screen.close()}}}}),Ar=Object(Fs.a)(Dr,function(){var t=this.$createElement;return(this._self._c||t)("div")},[],!1,null,null,null);Ar.options.__file="MissileView.vue";var Br=Ar.exports,$r=i.a.extend({name:"DeathView",props:["screen"],computed:{message(){switch(this.screen.dieReason){case Tt.Attack:return"Смерть в бою честь для героя. Но жить мне все-таки нравилось больше";case Tt.Missile:return"Раньше меня вела дорога приключений, но теперь и мне прострелили колено";case Tt.Trap:return"Я так и не научился смотреть под ноги";case Tt.Overloaded:return"Тяжко уйти от бремени, которое сам себе навязываешь.";default:return"Скучная смерть, которая даже не заслужила отдельного сообщения"}},signature(){return`Признался ${this.screen.playerName} перед смертью`}},methods:{onEvent(t){}}}),Hr=(s(101),Object(Fs.a)($r,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"screen-modal"},[e("div",{staticClass:"h4 title"},[this._v("Ты умер")]),e("div",{staticClass:"content mt-5"},[e("blockquote",{staticClass:"blockquote text-center signature"},[e("p",{staticClass:"mb-0",domProps:{textContent:this._s(this.message)}}),e("footer",{staticClass:"blockquote-footer",domProps:{textContent:this._s(this.signature)}})])])])},[],!1,null,null,null));Hr.options.__file="DeathView.vue";var Fr=Hr.exports;var Lr=i.a.extend({name:"PickSingleOptionView",props:["screen"],data:()=>({page:0,perPage:20,selected:[]}),computed:{title(){switch(this.screen.type){case pt.PickHandleOption:return"С чем взаимодействовать?"}}},methods:{optionName(t){switch(this.screen.type){case pt.PickHandleOption:return t[0]}},onEvent(t){switch(t.key){case"Escape":return this.screen.close();case"Enter":case" ":return this.screen.pickUpItems(this.selected.map(t=>this.screen.positions[t]));default:return this.selectAt(t.key.charCodeAt(0)-97)}},selectAt(t){t>=0&&t<Math.min(this.perPage,this.screen.options.length)&&this.screen.pick(this.screen.options[t])},indexLetter:t=>String.fromCharCode(97+t)}}),Gr=(s(103),Object(Fs.a)(Lr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("span",{staticClass:"title",domProps:{textContent:t._s(t.title)}}),s("table",{staticClass:"container options-list"},t._l(t.screen.options,function(e,i){return s("tr",{key:i},[s("td",{staticClass:"letter"},[t._v(t._s(t.indexLetter(i)))]),s("td",{staticClass:"separator"},[t._v("—")]),s("td",{staticClass:"name",domProps:{textContent:t._s(t.optionName(e))}})])}))])},[],!1,null,"08d3fe9c",null));Gr.options.__file="PickSingleOptionView.vue";var jr=Gr.exports,Ur=i.a.extend({name:"CharacterInfoView",props:["screen"],computed:{baseInfo:()=>[{name:"name",value:"Ilya"}]},methods:{onEvent(t){}}}),qr=(s(105),Object(Fs.a)(Ur,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("div",{staticClass:"title"},[t._v("Character Information")]),s("div",{staticClass:"content"},[s("div",{staticClass:"row"},[s("div",{staticClass:"col-md-4"},t._l(t.baseInfo,function(e){return s("div",{staticClass:"attribute-row"},[s("span",{staticClass:"name"},[t._v(t._s(t._f("t")(e.name,"presenters.characterInfo"))+":\n")]),s("span",{staticClass:"value",domProps:{textContent:t._s(e.value)}})])})),s("div",{staticClass:"col-md-4"})])])])},[],!1,null,"36c0e233",null));qr.options.__file="CharacterInfoView.vue";var Vr=qr.exports,Yr=s(20),zr=i.a.extend({data:()=>({game:(new class{constructor(){this.game=new yi(this.initPlayer());const t=new vi;t.register(this.game),t.enter(this.game,this.game.player);const e=this.game.player,s=this.game.professionPicker.available(e)[1];s&&e.professions.push(s);const i=new qt("Кинжал",.8,ft.iron,[{type:xe.Melee,dice:{times:1,max:3},extra:2}]),r=new qt("Катана",1,ft.iron,[{type:xe.Melee,dice:{times:5,max:2},extra:0}]),a=new Yt("Латы",1,ft.iron,[{type:xt.Heavy,value:5}]),n=new Xt("Свиток ххх"),o=hi(),h=li(),l=oi(),c=ni();if(this.game.currentMap){const t=this.game.currentMap.creatureTile(e);t.addItem(i,2),t.addItem(r,1),t.addItem(a,1),t.addItem(o,5),t.addItem(h,5),t.addItem(l,5),t.addItem(c,2),t.addItem(n,20),e.on(new he(t,[{item:i,count:2},{item:r,count:1},{item:a,count:1},{item:o,count:5},{item:h,count:5},{item:l,count:5},{item:c,count:2},{item:n,count:20}],this.game)),e.on(new le(e.inventory.missileWeaponSlot,c,this.game)),e.on(new le(e.inventory.missileSlot,o,this.game)),e.on(new le(e.inventory.rightHandSlot,r,this.game)),e.on(new le(e.inventory.chestSlot,a,this.game)),e.addItem(new ci,1),this.game.logger.reset()}}initPlayer(){return new as(new Ie([1,3,5,10,20]),new kt,{name:"Player",weight:80,clan:U.Player,abilities:V,protections:[],damages:[],maxHealthValue:10,regenerationRate:30,regenerationValue:1,resistances:[],visionRadius:10,moveSpeed:20,attackSpeed:20,bodyControl:5,leavesCorpseRatio:0,material:ft.flesh,throwingDamages:[]},12,12,15)}}).game,ts:Date.now(),loopIntervalId:void 0}),components:{Impacts:fr,Logger:Gs,Scene:rr,Stats:pr},computed:{viewComponent(){if(this.game.playerTurn&&this.game.player.ai.presenter)switch(this.game.player.ai.presenter.type){case pt.AbilitiesPicking:return kr;case pt.ProfessionPicking:return Tr;case pt.Idle:return yr;case pt.ItemsListing:return Mr;case pt.Inventory:return Er;case pt.Missile:return Br;case pt.Teleportation:case pt.Look:return Nr;case pt.Death:return Fr;case pt.PickHandleOption:return jr;case pt.CharacterInfo:return Vr;default:throw`App: unknown presenter ${this.game.player.ai.presenter}`}}},methods:{loop(){this.game.turn()},onEvent(t){const e=this.$refs.viewComponent;e&&e.onEvent(t)}},created(){this.loopIntervalId=Object(Yr.setInterval)(this.loop,10),document.addEventListener("keydown",this.onEvent)},beforeDestroy(){Object(Yr.clearInterval)(this.loopIntervalId),document.removeEventListener("keydown",this.onEvent)}}),Xr=(s(107),Object(Fs.a)(zr,function(){var t=this,e=t.$createElement,s=t._self._c||e;return t.game?s("div",{staticClass:"container-fluid",attrs:{id:"app"}},[t.game.player?s("Scene",{staticClass:"scene",attrs:{level:t.game.currentMap,player:t.game.player,pos:t.game.currentMap.creaturePos(t.game.player)}}):t._e(),t.game.player?s("Stats",{staticClass:"player-stats",attrs:{creature:t.game.player,"level-map":t.game.currentMap}}):t._e(),s("Logger",{staticClass:"logger-panel",attrs:{logger:t.game.logger}}),s("Impacts",{staticClass:"effect-panel",attrs:{impacts:t.game.player.impacts}}),t.game.playerTurn?s(t.viewComponent,{ref:"viewComponent",tag:"component",attrs:{screen:t.game.player.ai.presenter}}):t._e()],1):t._e()},[],!1,null,null,null));Xr.options.__file="App.vue";var Jr=Xr.exports;i.a.use(r.a),fetch("locales/en.json").then(t=>t.json()).then(t=>{const e=new n.a({phrases:t,locale:"en"});new i.a({el:"#app",render:t=>t(Jr)}),i.a.filter("t",(t,s,i)=>e.t(`${s}.${t}`,i))})}]);
//# sourceMappingURL=main.6541e1bc.js.map
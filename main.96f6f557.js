!function(t){function e(e){for(var i,n,h=e[0],o=e[1],l=e[2],u=0,d=[];u<h.length;u++)n=h[u],r[n]&&d.push(r[n][0]),r[n]=0;for(i in o)Object.prototype.hasOwnProperty.call(o,i)&&(t[i]=o[i]);for(c&&c(e);d.length;)d.shift()();return a.push.apply(a,l||[]),s()}function s(){for(var t,e=0;e<a.length;e++){for(var s=a[e],i=!0,h=1;h<s.length;h++){var o=s[h];0!==r[o]&&(i=!1)}i&&(a.splice(e--,1),t=n(n.s=s[0]))}return t}var i={},r={0:0},a=[];function n(e){if(i[e])return i[e].exports;var s=i[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=i,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(s,i,function(e){return t[e]}.bind(null,i));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/onisun/";var h=window.webpackJsonp=window.webpackJsonp||[],o=h.push.bind(h);h.push=e,h=h.slice();for(var l=0;l<h.length;l++)e(h[l]);var c=o;a.push([18,1]),s()}({18:function(t,e,s){t.exports=s(53)},35:function(t,e,s){"use strict";var i=s(6);s.n(i).a},37:function(t,e,s){"use strict";var i=s(7);s.n(i).a},47:function(t,e,s){},53:function(t,e,s){"use strict";s.r(e);var i=s(4),r=s(0);class a{constructor(t,e,s,i){if(this.x=t,this.y=e,this.w=s,this.h=i,s<=0||i<=0)throw`Rect ${t} ${e} ${s} ${i}: size is negative or zero`}move(t,e){this.x+=t,this.y+=e}}const n=function(t){return Math.floor(Math.random()*t)},h=function(t,e,s){let i=Array(t);for(let r=0;r<t;r++){i[r]=new Array(e);for(let t=0;t<e;t++)i[r][t]=s(r,t)}return i};class o{constructor(t,e){this.x=t,this.y=e}eq(t){return this.x===t.x&&this.y===t.y}nextTo(t){return Math.abs(this.x-t.x)<=1&&Math.abs(this.y-t.y)<=1}copy(){return new o(this.x,this.y)}add(t){return new o(this.x+t.x,this.y+t.y)}wrappers(){return o.dxy.map(t=>this.add(t))}}o.dxy=[new o(-1,-1),new o(0,-1),new o(1,-1),new o(-1,0),new o(1,0),new o(-1,1),new o(0,1),new o(1,1)];class l{constructor(t){this.map=t,this.width=t.length,this.height=t[0].length}at(t,e){return this.map[t][e]}inRange(t){return t.x>=0&&t.y>=0&&t.x<this.width&&t.y<this.height}each(t){this.map.forEach((e,s)=>{e.forEach((e,i)=>{t(e,s,i)})})}}const c=function(t,e){let s;if(e>0)for(let i=0;i<e;i++)s=t.pop(),t.unshift(s);else if(e<0)for(let i=e;i<0;i++)s=t.shift(),t.push(s);return t},u=function(t,e,s){let[i,r,a,n]=[t.x,e.x,t.y,e.y],h=Math.max(Math.abs(i-r),Math.abs(a-n));const l=new o((r-i)/h,(n-a)/h);for(;h>1;)i+=l.x,a+=l.y,s(Math.round(i),Math.round(a)),h-=1},d=function(t,e,s){u(t,e,s),s(e.x,e.y)};class m extends o{constructor(t,e){super(t,e)}multiple(t){return new o(this.x*t,this.y*t)}}m.up=new m(0,-1),m.down=new m(0,1),m.left=new m(-1,0),m.right=new m(1,0),m.upLeft=new m(-1,-1),m.upRight=new m(1,-1),m.downLeft=new m(-1,1),m.downRight=new m(1,1),m.all=[m.up,m.down,m.left,m.right,m.upLeft,m.upRight,m.downLeft,m.downRight];const g=function(t){const e=Object(r.min)(t);if(void 0!==e)return e;throw"minUnsafe got empty array"};class p{affectPlayer(t){return this.affectCreature(t)}}class f extends p{affectCreature(t){return q.NOTHING}}class w extends f{constructor(t,e){super(),this.levelMap=t,this.game=e}affectPlayer(t){return t.removeImpact(y.Overloaded,"bag"),t.removeImpact(y.Stressed,"bag"),t.removeImpact(y.Loaded,"bag"),t.stuffWeight.current>t.carryingCapacity.flattenedStart?t.on(new _t(this.game,this.levelMap,bt.Overloaded)):(t.stuffWeight.current>t.carryingCapacity.overloadedStart?t.addImpact(y.Overloaded,"bag"):t.stuffWeight.current>t.carryingCapacity.loadedStart?t.addImpact(y.Loaded,"bag"):t.stuffWeight.current>t.carryingCapacity.stressed&&t.addImpact(y.Stressed,"bag"),q.NOTHING)}}class v{constructor(){this.bunch=[]}find(t){return this.bunch.find(e=>e.item.groupsWith(t))}remove(t,e){const s=this.find(t);void 0!==s&&(s.count===e?Object(r.remove)(this.bunch,t=>t.item.groupsWith(s.item)):s.count-=e)}put(t,e){const s=this.bunch.find(e=>e.item.groupsWith(t));s?s.count+=e:this.bunch.push({count:e,item:t})}clone(){let t=new v;return this.bunch.forEach(e=>{t.put(e.item,e.count)}),t}}var y,b,x;!function(t){t[t.Blind=0]="Blind",t[t.Stressed=1]="Stressed",t[t.Loaded=2]="Loaded",t[t.Overloaded=3]="Overloaded"}(y||(y={}));class M{constructor(){this.constEffects=[],this.tempEffects=0}addTempEffect(t){this.tempEffects+=t}addConstEffect(t){this.constEffects.push(t)}removeTempEffect(){this.tempEffects=0}removeConstEffect(t){Object(r.remove)(this.constEffects,e=>e===t)}active(){return this.tempEffects>0||this.constEffects.length>0}turn(){this.tempEffects>=1&&(this.tempEffects-=1)}}class T{constructor(){this.impacts=new Map}get activeImpacts(){let t=[];return this.impacts.forEach((e,s)=>{e.active()&&t.push(s)}),t}addImpact(t,e){this.impactByType(t).addTempEffect(e)}removeImpact(t){this.impactByType(t).removeTempEffect()}addConstImpact(t,e){this.impactByType(t).addConstEffect(e)}removeConstImpact(t,e){this.impactByType(t).removeConstEffect(e)}turn(){this.impacts.forEach(t=>t.turn())}impactByType(t){let e=this.impacts.get(t);return void 0!==e?e:(e=new M,this.impacts.set(t,e),e)}}!function(t){t[t.Wall=0]="Wall",t[t.Door=1]="Door",t[t.Floor=2]="Floor",t[t.StairwayDown=3]="StairwayDown",t[t.StairwayUp=4]="StairwayUp",t[t.Trap=5]="Trap",t[t.Trigger=6]="Trigger"}(b||(b={}));class I{constructor(t,e){this.key=t,this.kind=e}addItem(t,e){this.items||(this.items=new v),this.items.put(t,e)}free(t){return this.isFloor()&&this.passibleThrough(t)}isFloor(){return this.kind===b.Floor}visibleThrough(){return!0}passibleThrough(t){return t&&this.creature?this.kind!==b.Wall&&this.creature.id===t.id:this.kind!==b.Wall&&!this.creature}clone(t=this){let e=this.buildNew();return t.creature&&(e.creature=t.creature),e.items=t.items&&t.items.clone(),e}}class C extends I{visibleThrough(){return!0}visit(t){t.onFloor(this)}buildNew(){return new C(this.key,this.kind)}}class S extends C{}class P extends C{constructor(){super("R",b.Floor)}}class E extends I{constructor(){super("D",b.Door)}visibleThrough(){return!1}visit(t){t.onDoor(this)}buildNew(){return new E}}class k extends I{constructor(){super("W",b.Wall)}visibleThrough(){return!1}visit(t){t.onWall(this)}buildNew(){return new k}}class O extends I{constructor(t,e,s,i){super(t,e),this.currentMap=s,this.adjacentMapName=i}enterPos(t,e){return this._enterPos?this._enterPos:this._enterPos=e.matchStairs(t.name)}visibleThrough(){return!0}}class N extends O{constructor(t,e){super(">",b.StairwayDown,t,e)}visit(t){t.onStairwayDown(this)}buildNew(){return new N(this.currentMap,this.adjacentMapName)}}class D extends O{constructor(t,e){super("<",b.StairwayUp,t,e)}visit(t){t.onStairwayUp(this)}buildNew(){return new D(this.currentMap,this.adjacentMapName)}}!function(t){t[t.AirBlow=0]="AirBlow",t[t.BareWire=1]="BareWire",t[t.FallingRock=2]="FallingRock",t[t.Hole=3]="Hole",t[t.Light=4]="Light",t[t.Teleportation=5]="Teleportation",t[t.Water=6]="Water"}(x||(x={}));class R{onWall(t){this.default(t)}onFloor(t){this.default(t)}onStairwayDown(t){this.onStairway(t)}onStairwayUp(t){this.onStairway(t)}onDoor(t){this.default(t)}onTrigger(t){this.default(t)}onTrap(t){this.default(t)}onStairway(t){this.default(t)}default(t){}}const A=function(t,e,s,i){new class{constructor(t,e,s,i,r,a,n){this.startx=t,this.starty=e,this.radius=s,this.width=i,this.height=r,this.solidChecker=a,this.markVisible=n,this.doubleRadius=this.radius*this.radius}calc(){this.markVisible(this.startx,this.starty,1),this.solidChecker.isSolid(this.startx,this.starty)||[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([t,e])=>{this.castLight(1,1,0,0,t,e,0),this.castLight(1,1,0,t,0,0,e)})}castLight(t,e,s,i,r,a,n){if(e<s)return;let h=0,o=!1;for(let l=t;l<=this.radius&&!o;l++){let t=-l;for(let c=-l;c<=0;c++){let u=Math.round(this.startx+c*i+t*r),d=Math.round(this.starty+c*a+t*n),m=(c-.5)/(t+.5),g=(c+.5)/(t-.5);if(u>=0&&d>=0&&u<this.width&&d<this.height&&!(e<g)){if(s>m)break;this.doubleDistance(c,t)<=this.doubleRadius&&this.markVisible(u,d,1-this.doubleDistance(c,t)/this.doubleRadius),o?this.solidChecker.isSolid(u,d)?h=g:(o=!1,e=h):this.solidChecker.isSolid(u,d)&&l<this.radius&&(o=!0,this.castLight(l+1,e,m,i,r,a,n),h=g)}}}}doubleDistance(t,e){return t*t+e*e}}(t.x,t.y,e,i.width,i.height,new class extends R{constructor(t,e){super(),this.stage=t,this.pos=e,this.visible=!1}isSolid(t,e){return this.x=t,this.y=e,this.stage.at(t,e).visit(this),!this.visible}onDoor(t){this.visible=this.pos.x===this.x&&this.pos.y===this.y}default(t){this.x&&this.y&&(this.visible=this.stage.visibleThrough(this.x,this.y))}}(i,t),(t,e,r)=>{s.at(t,e).see(i.at(t,e),r)}).calc()};class W{constructor(t,e=t){this.max=t,this.current=e,this.modifiers=[]}get maximum(){return this.max}get atMax(){return this.max===this.current}decrease(t){this.current-=t}increase(t){this.current=Math.min(this.current+t,this.max)}constantIncrease(t){this.max+=t,this.increase(t)}constantDecrease(t){this.max-=t,this.decrease(t)}addModifier(t){this.modifiers.push(t)}removeModifier(t){Object(r.remove)(this.modifiers,e=>e===t)}get currentValue(){return this.current+Object(r.sum)(this.modifiers)}}class F{constructor(t,e=1,s=0){this.base=t,this.rate=e,this.extra=s}get current(){return this.base*this.rate-this.extra}add(t){this.base+=t}subtract(t){this.base-=t}}class B{constructor(t,e){this.strength=t,this.constitution=e,this.strengthRatio=5,this.constitutionRatio=3,this.base=10}recalculate(t,e){this.strength=t,this.constitution=e}get stressed(){return this.base+this.strength*this.strengthRatio+this.constitution*this.constitutionRatio}get loadedStart(){return 1.5*this.stressed}get overloadedStart(){return 2*this.loadedStart}get flattenedStart(){return 3*this.overloadedStart}}class H extends W{constructor(t,e=0,s=t.maxHealthValue){super(t.maxHealthValue,s),this.currentTurn=e,this.regenerationRate=t.regenerationRate,this.regenerationValue=t.regenerationValue}turn(){this.currentTurn+=1,this.currentTurn>=this.regenerationRate&&(this.currentTurn=0,this.increase(this.regenerationValue))}}class $ extends F{get meleeAdjustment(){return this.current<5?-2:this.current>10?Math.floor((this.current-10)/2):0}}class G extends F{get levelUpHPBonus(){return this.current<3?-2:this.current<6?-1:this.current<12?0:this.current<15?1:this.current<18?2:this.current<20?3:4}}class L extends F{get bodyControlAdjustment(){return this.current<5?-2:this.current>10?Math.floor(.9*(this.current-10)):0}get missileAdjustment(){return this.current<5?-2:this.current>10?Math.floor((this.current-10)/2):0}}var U,j;!function(t){t[t.Player=0]="Player",t[t.PlayerOnlyEnemy=1]="PlayerOnlyEnemy",t[t.FreeForAll=2]="FreeForAll"}(U||(U={})),function(t){t[t.GoStairwayDown=0]="GoStairwayDown",t[t.Inventory=1]="Inventory",t[t.PutOn=2]="PutOn",t[t.Throwing=3]="Throwing"}(j||(j={}));const _=[j.GoStairwayDown,j.Inventory,j.PutOn,j.Throwing];var q;!function(t){t[t.DIE=0]="DIE",t[t.HURT=1]="HURT",t[t.DODGE=2]="DODGE",t[t.THROW_DODGE=3]="THROW_DODGE",t[t.NOTHING=4]="NOTHING",t[t.RESIST=5]="RESIST"}(q||(q={}));class V{constructor(t,e=V.getId()){this.specie=t,this.id=e,this.stageMemories=new Map,this.dead=!1,this.health=new H(t)}static getId(){return this.lastId++}get name(){return this.specie.name}get clan(){return this.specie.clan}get protections(){return this.specie.protections}get throwDamages(){return this.specie.throwingDamages}get damages(){return this.specie.damages}can(t){return Object(r.includes)(this.specie.abilities,t)}on(t){return t.affectCreature(this)}get speed(){return this.specie.moveSpeed}stageMemory(t){const e=this.stageMemories.get(t.name);return e||this.visionMask(t)}visionMask(t){let e=this.stageMemories.get(t.name);return e?e.resetVisible():(e=new Ke(t.width,t.height),this.stageMemories.set(t.name,e)),A(t.creaturePos(this),this.visionRadius,e,t),e}get impactsBunch(){return this._impactsBunch||(this._impactsBunch=new T),this._impactsBunch}hasImpact(t){return Object(r.includes)(this.impacts,t)}addImpact(t,e){this.impactsBunch.addConstImpact(t,e)}removeImpact(t,e){this.impactsBunch.removeConstImpact(t,e)}get visionRadius(){return this.hasImpact(y.Blind)?0:this.specie.visionRadius}get bodyControl(){return this.specie.bodyControl}get impacts(){return this.impactsBunch.activeImpacts}hasResistance(t){return Object(r.includes)(this.resistances,t)}get resistances(){return this.specie.resistances}get weightWithCarryings(){return this.specie.weight}statsTurn(){this.health.turn(),this._impactsBunch&&this._impactsBunch.turn()}}V.lastId=0;class z extends R{constructor(t,e,s,i){super(),this.pos=t,this.creature=e,this.levelMap=s,this.game=i,this.reaction=q.NOTHING}onTrap(t){this.reaction=t.activate(this.pos,this.game,this.levelMap,this.creature)}onTrigger(t){t.activate(this.game,this.levelMap,this.creature)}}class Y extends p{constructor(t,e,s,i=e){super(),this.game=t,this.levelMap=e,this.nextPoint=s,this.nextLevel=i}affectCreature(t){const e=this.levelMap.creaturePos(t);this.nextLevel.name!==this.levelMap.name?(this.levelMap.removeCreature(t),this.nextLevel.addCreature(this.nextPoint,t)):(this.levelMap.at(e.x,e.y).creature=void 0,this.levelMap.at(this.nextPoint.x,this.nextPoint.y).creature=t);const s=new z(this.nextPoint,t,this.levelMap,this.game);return this.nextLevel.at(this.nextPoint.x,this.nextPoint.y).visit(s),s.reaction}affectPlayer(t){return this.nextLevel&&this.levelMap.name!==this.nextLevel.name?(this.levelMap.reset(),this.nextLevel.enter(),this.affectCreature(t),this.game.currentMap=this.nextLevel):this.affectCreature(t),q.NOTHING}}class X{moveTo(t,e,s,i){return this.move(t,s,i,t=>e.eq(t))}move(t,e,s,i){const[r]=this.buildPath(t,e,i);if(r)return new Y(s,e,r)}buildPath(t,e,s){return xs(t.stageMemory(e),e.creaturePos(t),e=>e.tangible(t),s)}withinView(t,e,s){let i=h(t.width,t.height,()=>!1),r=[e];for(;r.length;){let e=[];r.forEach(r=>{if(!t.inRange(r))return;const a=t.at(r.x,r.y);a.visible&&!i[r.x][r.y]&&(i[r.x][r.y]=!0,s(r,a),r.wrappers().forEach(t=>e.push(t)))}),r=e}}enemies(t,e){return t.id!==e.id&&(t.clan===U.FreeForAll||e.clan===U.FreeForAll||(t.clan===U.Player&&e.clan===U.PlayerOnlyEnemy||e.clan===U.Player&&t.clan===U.PlayerOnlyEnemy))}}class J extends X{constructor(){super(...arguments),this.destination=void 0}act(t,e,s){if(!this.foundNewTarget(t,e)||!this.destination)return this.checkCurrentTile(t,e,s);const i=this.goTo(t,e,s,this.destination);if(i)return i;this.destination=void 0,this.onCantMove(t)}goTo(t,e,s,i){return this.moveTo(t,i,e,s)}checkCurrentTile(t,e,s){if(this.destination&&e.creaturePos(t).eq(this.destination))return this.destination=void 0,this.onReach(t,e,s)}onMove(t){}onReach(t,e,s){}onCantMove(t){}}class K extends J{constructor(t){super(),this.matcher=t}checkCurrentTile(t,e,s){let i=super.checkCurrentTile(t,e,s);if(i)return i;const r=e.creaturePos(t);return this.matcher(t.stageMemory(e).at(r.x,r.y))?(this.destination=void 0,this.onReach(t,e,s)):void 0}foundNewTarget(t,e){const s=xs(t.stageMemory(e),e.creaturePos(t),e=>e.tangible(t),(t,e)=>this.matcher(e),!0);return!!s.length&&(this.destination=s.pop(),!0)}}class Q extends X{act(t,e,s,i=!0){if(this.canAttack(t,e)){if(this.victim&&this.victimInAccess(t,e,this.victim))return new Vt(this.victim,e,s);if(!i)throw"Attacker got called twice";return this.pickNewVictim(t,e),this.act(t,e,s,!1)}}canAttack(t,e){return!!this.findCreature(t,e,e=>this.enemies(t,e))}victimInAccess(t,e,s){if(void 0===s)return!1;return!!this.findCreature(t,e,t=>t.id===s.id)}pickNewVictim(t,e){this.victim=this.findCreature(t,e,e=>this.enemies(t,e))}findCreature(t,e,s){const i=t.stageMemory(e);return e.creaturePos(t).wrappers().map(({x:t,y:e})=>i.at(t,e).creature).find(t=>!!t&&s(t))}}class Z extends J{foundNewTarget(t,e){return this.victimSet()&&this.buildVictimPath(t,e)||this.foundNewVictim(t,e)}onCantMove(){this.victimId=void 0}onReach(){this.victimId=void 0}victimSet(){return!!this.victimId}goTo(t,e,s){if(!this.destination)throw"Chaser.goTo: no destination";return this.followTo(t,this.destination,e,s)}buildVictimPath(t,e){return this.findCreature(t,e,t=>t.id===this.victimId)}foundNewVictim(t,e){return this.findCreature(t,e,e=>this.enemies(t,e))&&this.buildVictimPath(t,e)}findCreature(t,e,s){let i=!1;return this.withinView(t.stageMemory(e),e.creaturePos(t),({x:t,y:e},r)=>{const a=r.creature;!i&&a&&s(a)&&(this.destination=new o(t,e),this.victimId=a.id,i=!0)}),i}followTo(t,e,s,i){return this.move(t,s,i,t=>e.nextTo(t))}}const tt=2;class et extends J{constructor(){super(...arguments),this.escapesFrom=[]}foundNewTarget(t,e){return this.foundEnemies(t,e)&&this.buildEscapePath(t,e)}buildEscapePath(t,e,s=t.visionRadius/2){if(s<=1)return this.destination=void 0,!1;const i=this.buildPath(t,e,({x:t,y:e})=>{return Object(r.sumBy)(this.escapesFrom,([s,i])=>Math.max(Math.abs(t-s.x),Math.abs(e-s.y)))>=s});return i.length?(this.destination=i.pop(),!0):this.buildEscapePath(t,e,s-tt)}foundEnemies(t,e){return this.escapesFrom=[],this.withinView(t.stageMemory(e),e.creaturePos(t),(e,s)=>{const i=s.creature;i&&this.enemies(t,i)&&this.escapesFrom.push([e,i])}),this.escapesFrom.length>0}}class st extends K{constructor(){super(t=>!t.seen)}}class it extends X{act(t,e,s){const i=e.creaturePos(t);return this.move(t,e,s,t=>!i.eq(t))}}class rt{constructor(t){this.game=t,this.player=t.player,this.logger=t.logger}}class at extends rt{constructor(t,e){super(e),this.items=t}run(){}}class nt extends X{constructor(t){super(),this.aiToRun=t,this.events=[]}pushEvent(t){this.events.push(t)}resetEvents(){this.events=[]}runEvents(){let t=!1;return this.events.forEach(e=>{t=!0,e.run()}),this.resetEvents(),t}}var ht=s(16);const ot=10;class lt extends R{constructor(t){super(),this.tile=t,this.status=!1}addNode(){return this.status=!1,this.tile.visit(this),this.status}onDoor(){this.status=!0}}class ct extends X{constructor(){super(),this.step=ot,this.firstCallPatrol=!0,this.i="a",this.graph=new ht.Graph,this.lastNodeVisit={},this.currentNodeID="a",this.markNodeVisited(this.currentNodeID),this.path=[]}act(t,e,s,i=!0){if(!(this.graph.nodes().length<=1)){if(this.firstCallPatrol){const s=e.creaturePos(t);this.addNode(s),this.firstCallPatrol=!1}return this.step+=1,this.path.length?this.moveToTarget(t,e,s,i):(this.targetNodeID&&(this.markNodeVisited(this.targetNodeID),this.currentNodeID=this.targetNodeID),this.pickUpNewTarget(t,e),this.moveToTarget(t,e,s,i))}}reset(){this.path=[]}trackMovement(t,e){(this.step>=ot||new lt(e).addNode())&&this.addNode(t),this.step+=1}addNode(t){this.graph.setNode(this.i,t),this.currentNodeID&&this.currentNodeID!==this.i&&this.graph.setEdge(this.currentNodeID,this.i),this.currentNodeID=this.i,this.newNodeId(),this.step=0}buildNewPath(t,e){if(!this.targetNodeID)throw"Patrol has no next targetID";const s=this.graph.node(this.targetNodeID);this.path=this.buildPath(t,e,t=>s.eq(t))}pickUpNewTarget(t,e){let s=this.graph.nodes()[0],i=this.lastNodeVisit[s],r=this.graph.neighbors(this.currentNodeID);r&&r.forEach(t=>{i>(this.lastNodeVisit[t]||0)&&(s=t,i=this.lastNodeVisit[s])}),this.targetNodeID=s,this.buildNewPath(t,e)}moveToTarget(t,e,s,i){const r=this.path.shift();return r?t.stageMemory(e).at(r.x,r.y).tangible()?(this.buildNewPath(t,e),this.path.length?this.act(t,e,s,!1):void 0):new Y(s,e,r):i?(this.path=[],this.act(t,e,s,!1)):(new it).act(t,e,s)}markNodeVisited(t){this.lastNodeVisit[t]=this.step}newNodeId(){this.i=String.fromCharCode(this.i.charCodeAt(0)+1)}}var ut,dt,mt,gt,pt,ft,wt,vt,yt,bt;!function(t){t[t.AbilitiesPicking=0]="AbilitiesPicking",t[t.Death=1]="Death",t[t.Idle=2]="Idle",t[t.Inventory=3]="Inventory",t[t.ItemsListing=4]="ItemsListing",t[t.Missile=5]="Missile",t[t.ProfessionPicking=6]="ProfessionPicking",t[t.Look=7]="Look",t[t.Teleportation=8]="Teleportation",t[t.PickHandleOption=9]="PickHandleOption"}(ut||(ut={}));class xt{constructor(t,e,s){this.type=t,this.levelMap=e,this.game=s,this.player=this.game.player}get tile(){return this.levelMap.creatureTile(this.player)}endTurn(){this.game.player.ai.endTurn(this.game,this.levelMap)}redirect(t){this.game.player.ai.redirect(t)}goIdle(){this.redirect(new gs(this.levelMap,this.game))}}class Mt extends xt{constructor(t,e,s){super(ut.Death,e,s),this.dieReason=t}get playerName(){return this.game.player.name}}class Tt extends rt{constructor(t,e,s){super(s),this.level=t,this.levelMap=e}run(){this.level%3==0?this.game.player.ai.presenter=new ys(this.level,this.levelMap,this.game):this.game.player.ai.presenter=new ws(this.level,this.levelMap,this.game)}}class It extends rt{constructor(t,e,s){super(s),this.dieReason=t,this.levelMap=e}run(){this.game.player.rebuildVision(this.levelMap),this.game.playerTurn=!0,this.game.player.ai.presenter=new Mt(this.dieReason,this.levelMap,this.game)}}class Ct extends nt{constructor(){super(...arguments),this.presenter=null,this.levelUps=0}act(t,e,s){this.presenter=new gs(e,s),s.playerTurn=!0}endTurn(t,e){let s=this.events.pop();if(s)s.run();else if(t&&e){t.player.on(new w(e,t));let s=this.events.pop();s?s.run():(t.player.ai.runEvents(),t.playerTurn=!1,this.presenter=null)}}redirect(t){this.presenter=t}}class St extends Ct{constructor(t){super(),this.ai=t}act(t,e,s){let i=this.ai.act(t,e,s);return s.playerTurn=!0,i}}class Pt extends K{constructor(){super(t=>!!t.items)}act(t,e,s){if(t.can(j.Inventory))return super.act(t,e,s)}onReach(t,e,s){const i=e.creatureTile(t);if(!i.items)throw"Picker.act : nothing to pick up";return t.ai.pushEvent(new at(i.items,s)),new se(i,i.items.bunch,s)}}class Et extends p{constructor(t){super(),this.levelMap=t}affectCreature(t){let e=t.stageMemory(this.levelMap);return this.levelMap.creaturePos(t).wrappers().forEach(({x:t,y:s})=>{e.at(t,s).see(this.levelMap.at(t,s),0)}),q.NOTHING}}class kt extends X{act(t,e){if(!t.health.atMax)return new Et(e)}}class Ot extends R{constructor(){super(...arguments),this.match=!1}onStairwayDown(){this.match=!0}}class Nt extends R{constructor(t,e){super(),this.game=t,this.levelMap=e}onStairwayDown(t){const e=this.game.getMap(t.adjacentMapName);this.event=new Y(this.game,this.levelMap,t.enterPos(this.levelMap,e),e)}}class Dt extends K{constructor(){super(t=>{const e=new Ot;return t.visit(e),e.match})}act(t,e,s){if(t.can(j.GoStairwayDown))return super.act(t,e,s)}onReach(t,e,s){const i=new Nt(s,e);return e.creatureTile(t).visit(i),i.event}}class Rt extends X{act(t,e,s){if(!t.can(j.Throwing)||!this.hasMissile(t)||!this.canAttack(t,e,s))return;let i=[];if(!this.victim)throw"Thrower.act called when there is no victim";return u(e.creaturePos(t),e.creaturePos(this.victim),(t,e)=>i.push(new o(t,e))),new ee(i,s,e,t=>{t===q.DIE&&(this.victim=void 0,this.previousVictim=void 0)})}hasMissile(t){return this.missiles=t.missile,void 0!==this.missiles}canAttack(t,e,s){return this.previousVictim=this.victim,this.victim=void 0,!(!this.previousVictim||!this.findWithId(t,e,this.previousVictim.id))||this.findCreature(t,e,e=>this.enemies(t,e))}findWithId(t,e,s){return this.findCreature(t,e,t=>s===t.id)}findCreature(t,e,s){const i=t.stageMemory(e),r=e.creaturePos(t);return this.withinView(i,e.creaturePos(t),(a,n)=>{const h=n.creature;!this.victim&&h&&s(h)&&!this.obstacles(t,r,i,a)&&(this.victim=e.at(a.x,a.y).creature)}),!!this.victim}obstacles(t,e,s,i){let r=!1;return u(e,i,(e,i)=>{r=r||s.at(e,i).tangible(t)}),r}}class At extends p{constructor(t,e,s){super(),this.actor=t,this.levelMap=e,this.game=s}affectCreature(t){return q.NOTHING}affectPlayer(t){return t.level.add(1).forEach(e=>{t.ai.pushEvent(new Tt(e,this.levelMap,this.game))}),q.NOTHING}}class Wt extends p{constructor(t,e,s,i){super(),this.impactType=t,this.source=e,this.game=s,this.duration=i}affectCreature(t){return t.hasImpact(this.impactType)&&this.applyImpact(),this.duration?t.impactsBunch.addImpact(this.impactType,this.duration):t.addImpact(this.impactType,this.source),q.NOTHING}applyImpact(){}}!function(t){t[t.Intangible=0]="Intangible",t[t.MagicDamage=1]="MagicDamage",t[t.TeleportationControl=2]="TeleportationControl",t[t.Insulator=3]="Insulator"}(dt||(dt={}));class Ft{constructor(){}static misses(t,e){return Math.random()>t/(t+Math.pow(.25*e,.8))}static lowerWeight(t,e=1){let s=0;for(let i=e;i<t;i++)this.chance(1,3)&&(s+=1);return Math.max(1,s)}static higherWeight(t,e=1){return t+e-this.lowerWeight(t,e)}static chance(t,e){return Object(r.random)(1,e)<=t}static dodges(t,e){return Math.random()<Math.atan(t/e)/Math.PI*2}static damage(t,e,s){if(t.every(({type:t,resistances:e})=>this.resistTo(t,e,s)))return{damage:0,resist:!0};return{damage:Object(r.sumBy)(t,({extra:t,dice:i,type:r,resistances:a})=>this.resistTo(r,a,s)?0:Math.floor(Math.max(0,t+this.dropDice(i)-this.protectionValue(r,e)))),resist:!1}}static resistTo(t,e,s){if(e&&Object(r.intersection)(s,e).length)return!0;switch(t){case ge.Melee:case ge.Pierce:case ge.Blunt:return Object(r.includes)(s,dt.Intangible);case ge.Magic:return Object(r.includes)(s,dt.MagicDamage);case ge.Pure:return!1}}static dropDice(t){return Object(r.sum)(Object(r.times)(t.times,()=>Object(r.random)(1,t.max)))}static protectionValue(t,e){return Object(r.sum)(e.map(({type:e,value:s})=>s*this.armorToDamageRatio(t,e)))}}Ft.armorToDamageRatio=((t,e)=>{switch(t){case ge.Melee:switch(e){case yt.Medium:return 2/3;case yt.Solid:return 4/3;default:return 1}case ge.Pierce:switch(e){case yt.Light:return.5;case yt.Medium:return 4/3;case yt.Solid:return 3;case yt.Unarmored:return.75;default:return 1}case ge.Blunt:switch(e){case yt.Medium:return 2;case yt.Solid:case yt.Unarmored:return.5;default:return 1}case ge.Magic:switch(e){case yt.Light:return 5/4;case yt.Medium:return.75;case yt.Heavy:return.5;case yt.Solid:return 3;default:return 1}case ge.Pure:return 0;default:throw"Got unknown type of damage!"}}),function(t){t[t.Corrosion=0]="Corrosion",t[t.Destroy=1]="Destroy"}(mt||(mt={})),function(t){t.cloth={affectedWithWater:void 0,firm:!1,fragile:!1,insulator:!1},t.flesh={affectedWithWater:void 0,firm:!0,fragile:!1,insulator:!0},t.glass={affectedWithWater:void 0,firm:!1,fragile:!0,insulator:!1},t.iron={affectedWithWater:mt.Corrosion,firm:!0,fragile:!1,insulator:!0},t.leather={affectedWithWater:void 0,firm:!1,fragile:!1,insulator:!1},t.paper={affectedWithWater:mt.Destroy,firm:!1,fragile:!1,insulator:!0},t.stone={affectedWithWater:void 0,firm:!0,fragile:!1,insulator:!0},t.wood={affectedWithWater:void 0,firm:!0,fragile:!1,insulator:!0}}(gt||(gt={})),function(t){t[t.WeaponOneHand=0]="WeaponOneHand",t[t.WearsOnHead=1]="WearsOnHead",t[t.WearsOnBody=2]="WearsOnBody",t[t.Ring=3]="Ring",t[t.Amulet=4]="Amulet",t[t.Throw=5]="Throw",t[t.Shoot=6]="Shoot",t[t.Boots=7]="Boots",t[t.Tool=8]="Tool",t[t.Belt=9]="Belt",t[t.Gloves=10]="Gloves",t[t.Gauntlets=11]="Gauntlets",t[t.Cloak=12]="Cloak",t[t.Scroll=13]="Scroll"}(pt||(pt={})),function(t){t[t.BodyArmor=0]="BodyArmor",t[t.OneHandWeapon=1]="OneHandWeapon",t[t.Consumable=2]="Consumable",t[t.Missile=3]="Missile",t[t.Potion=4]="Potion",t[t.MissileWeapon=5]="MissileWeapon",t[t.Boots=6]="Boots",t[t.Scrolls=7]="Scrolls",t[t.Hat=8]="Hat"}(ft||(ft={})),function(t){t[t.MissileRock=0]="MissileRock",t[t.Sling=1]="Sling",t[t.Bow=2]="Bow",t[t.Arrows=3]="Arrows"}(wt||(wt={})),function(t){t[t.None=0]="None",t[t.Slightly=1]="Slightly",t[t.Mostly=2]="Mostly",t[t.Fully=3]="Fully"}(vt||(vt={}));class Bt{constructor(t,e,s,i,r=[],a=Bt.getId()){this.group=t,this.name=e,this.weight=s,this.material=i,this.usages=r,this.id=a,this.impacts=[],this.corrosionLevel=vt.None}static getId(){return this.lastId++}corrode(){switch(this.corrosionLevel){case vt.None:return this.corrosionLevel=vt.Slightly,!0;case vt.Slightly:return this.corrosionLevel=vt.Mostly,!0;case vt.Mostly:return this.corrosionLevel=vt.Fully,!0}return!1}get affectedWithWater(){return void 0!==this.material.affectedWithWater}get firm(){return this.material.firm}get insulator(){return this.material.insulator}get canSeeDetails(){return!0}clone(){return new Bt(this.group,this.name,this.weight,this.material)}groupsWith(t){return this.name===t.name}worksWith(t){return!1}canThrow(t){return!0}}Bt.lastId=0;class Ht extends Bt{constructor(t){super(ft.Consumable,`${t.name}'s corpse`,t.weight,t.material),this.specie=t}}class $t extends Bt{constructor(t,e=gt.glass){super(ft.Potion,t,.2,e),this.name=t}}class Gt extends Bt{constructor(t,e,s,i,r,a){super(t,e,s,i,a),this.rawDamages=r}get damages(){switch(this.corrosionLevel){case vt.Slightly:return this.damageWithCorrosion(1);case vt.Mostly:return this.damageWithCorrosion(2);case vt.Fully:return this.damageWithCorrosion(4);default:return this.rawDamages}}damageWithCorrosion(t){return this.rawDamages.map(({dice:e,type:s,extra:i})=>({dice:e,type:s,extra:i-t}))}}class Lt extends Gt{constructor(t,e,s,i){super(ft.OneHandWeapon,t,e,s,i,[pt.WeaponOneHand])}}!function(t){t[t.Light=0]="Light",t[t.Medium=1]="Medium",t[t.Heavy=2]="Heavy",t[t.Solid=3]="Solid",t[t.Unarmored=4]="Unarmored"}(yt||(yt={}));class Ut extends Bt{constructor(t,e,s,i,r,a){super(t,e,s,i,[a]),this.rawProtections=r}get protections(){switch(this.corrosionLevel){case vt.Slightly:return this.protectionWithCorrosion(1);case vt.Mostly:return this.protectionWithCorrosion(2);case vt.Fully:return this.protectionWithCorrosion(4);default:return this.rawProtections}}protectionWithCorrosion(t){return this.rawProtections.map(({type:e,value:s})=>({type:e,value:s-t}))}}class jt extends Ut{constructor(t,e,s,i){super(ft.BodyArmor,t,e,s,i,pt.WearsOnBody)}}!function(t){t[t.Attack=0]="Attack",t[t.Missile=1]="Missile",t[t.Trap=2]="Trap",t[t.Overloaded=3]="Overloaded"}(bt||(bt={}));class _t extends p{constructor(t,e,s){super(),this.game=t,this.levelMap=e,this.reason=s}affectCreature(t){let e=this.levelMap.creatureTile(t);return this.levelMap.removeCreature(t),t.dead=!0,t.specie.leavesCorpseRatio>Math.random()&&e.addItem(new Ht(t.specie),1),t.inventoryItems.forEach(t=>e.addItem(t.item,t.count)),q.DIE}affectPlayer(t){return t.ai.pushEvent(new It(this.reason,this.levelMap,this.game)),t.dead=!0,this.game.playerTurn=!0,q.DIE}}class qt extends p{constructor(t,e,s,i){super(),this.damages=t,this.dieReason=e,this.levelMap=s,this.game=i}get damage(){if(this.doneDamage)return this.doneDamage;throw"HurtEvent.damage called but there is no done damage"}affectCreature(t){const{damage:e,resist:s}=Ft.damage(this.damages,t.protections,t.resistances);return this.doneDamage=e,s?q.RESIST:e>=t.health.currentValue?(t.on(new _t(this.game,this.levelMap,this.dieReason)),q.DIE):e<=0?q.NOTHING:(t.health.decrease(e),q.HURT)}}class Vt extends p{constructor(t,e,s){super(),this.victim=t,this.levelMap=e,this.game=s}affectCreature(t){const e=this.process(t);switch(e){case q.NOTHING:this.game.logger.noDamageToPlayer(t);break;case q.RESIST:this.game.logger.playerIgnoresDamage(t)}return e}affectPlayer(t){const e=this.process(t);switch(e){case q.NOTHING:this.game.logger.noDamageToTarget(t);break;case q.RESIST:this.game.logger.targetIgnoresDamage(this.victim)}return e}process(t){if(Ft.misses(t.bodyControl,this.victim.bodyControl))return this.game.logger.missMessage(this.game.player,t,this.victim),q.DODGE;const e=new qt(t.damages,bt.Attack,this.levelMap,this.game),s=this.victim.on(e);switch(s){case q.DIE:t.on(new At(this.victim,this.levelMap,this.game)),this.game.logger.killMessage(this.game.player,e.damage,t,this.victim);break;case q.HURT:this.game.logger.hurtMessage(this.game.player,e.damage,t,this.victim)}return s}}class zt extends p{constructor(t,e){super(),this.potion=t,this.game=e}affectCreature(t){return t.removeItem(this.potion,1),this.potion.onDrink(this.game),this.game.logger.drink(this.potion),q.NOTHING}}class Yt extends f{constructor(t,e,s){super(),this.tile=t,this.items=e,this.game=s}affectPlayer(t){return this.items.forEach(({item:e,count:s})=>{t.removeItem(e,s),t.stuffWeight.subtract(e.weight*s),this.game.logger.droppedItem(e,s),this.tile.addItem(e,s)}),q.NOTHING}}class Xt extends f{affectPlayer(t){return this.updateHealth(t),q.NOTHING}updateHealth(t){t.health.constantIncrease(t.constitution.levelUpHPBonus),t.health.maximum<1&&t.health.constantIncrease(1-t.health.maximum)}}class Jt{constructor(t){this.onDone=t}speed(){return-1}}class Kt extends Jt{constructor(t,e,s){super(s),this.item=t,this.frames=e}patchMemory(t){if(this.done())return;const[e]=this.frames.splice(0,1),s=t.at(e.x,e.y);s.visible?s.effect="-":this.patchMemory(t)}done(){return 0===this.frames.length}}class Qt extends p{constructor(t,e,s,i){super(),this.victim=t,this.missile=e,this.levelMap=s,this.game=i}affectCreature(t){if(Ft.misses(t.bodyControl,this.victim.bodyControl))return this.game.logger.throwMissMessage(this.game.player,t,this.victim,this.missile),q.THROW_DODGE;const{damage:e,resist:s}=Ft.damage(t.throwDamages,this.victim.protections,this.victim.resistances);return e>=this.victim.health.currentValue?(t.on(new At(this.victim,this.levelMap,this.game)),this.game.logger.throwKillMessage(this.game.player,e,t,this.victim,this.missile),this.victim.on(new _t(this.game,this.levelMap,bt.Missile))):(this.victim.health.decrease(e),this.game.logger.throwHurtMessage(this.game.player,e,t,this.victim,this.missile),q.HURT)}}class Zt extends p{constructor(t,e){super(),this.slot=t,this.game=e}affectCreature(t){return q.NOTHING}affectPlayer(t){const e=this.slot.equipment;if(void 0===e)throw`Can not take off item from ${this.slot.name} - nothing equipped`;return this.slot.takeOff(),this.onTakeOff(t,e.item),t.inventory.putToBag(e.item,e.count),this.game.logger.takeOff(e.item),q.NOTHING}onTakeOff(t,e){e instanceof Ut&&e.protections.forEach(e=>{t.itemsProtections.splice(Object(r.findIndex)(t.itemsProtections,t=>t===e),1)}),e.impacts.forEach(s=>{t.on(new re(s,e.name,this.game))})}}class te extends p{constructor(t,e,s){super(),this.slot=t,this.count=e,this.game=s}affectCreature(t){return q.NOTHING}affectPlayer(t){if(!this.slot.equipment)throw`RemoveItemEvent: ${this.slot.name} has no equipment`;return this.slot.equipment.count===this.count?t.on(new Zt(this.slot,this.game)):(this.slot.equipment.count-=this.count,q.NOTHING)}}class ee extends p{constructor(t,e,s,i){super(),this.path=t,this.game=e,this.levelMap=s,this.done=i}affectCreature(t){let e=t.missile;if(!e)throw"MissileAttackEvent called when actor has no missiles";return this.withMissile(t,e.item),q.NOTHING}affectPlayer(t){const e=t.missile;if(!e)throw"MissileAttackEvent: slot has no items";return this.withMissile(t,e.item),t.on(new te(t.inventory.missileSlot,1,this.game)),t.stuffWeight.subtract(e.item.weight),q.NOTHING}withMissile(t,e){let s,i=[];this.path.forEach(t=>{if(!s){const e=this.levelMap.at(t.x,t.y);s=e.creature,i.push(t)}}),this.game.effect=new Kt(e,i,()=>{s?this.done(t.on(new Qt(s,e,this.levelMap,this.game))):this.done(q.NOTHING)})}}class se extends f{constructor(t,e,s){super(),this.tile=t,this.items=e,this.game=s}affectPlayer(t){let e=this.tile.items;if(void 0===e)throw"Failed to pick up items - tile has no items";return this.withTileItems(t,e),q.NOTHING}withTileItems(t,e){this.items.forEach(({item:s,count:i})=>{t.addItem(s,i),t.stuffWeight.add(s.weight*i),this.game.logger.pickedUpItem(s,i),e.remove(s,i)})}}class ie extends p{constructor(t,e,s){super(),this.slot=t,this.item=e,this.game=s}affectCreature(t){return q.NOTHING}affectPlayer(t){let e=t.inventory.findInBag(this.item);if(void 0===e)throw`Item ${this.item.name} can not be equipped - not found in inventory`;if(this.slot.equipment){const e=t.on(new Zt(this.slot,this.game));if(e!==q.NOTHING)return e}const s=this.slot.useSingleItem?1:e.count;return t.removeItem(this.item,s),this.slot.equip(this.item,s),this.onPutOn(t,this.item),this.game.logger.putOn(this.item),q.NOTHING}onPutOn(t,e){e instanceof Ut&&(t.itemsProtections=t.itemsProtections.concat(e.protections)),e.impacts.forEach(s=>{t.on(new Wt(s,e.name,this.game))})}}class re extends p{constructor(t,e,s){super(),this.impactType=t,this.source=e,this.game=s}affectCreature(t){return q.NOTHING}}const ae=function(t,e,s){for(let i=1;i<e.width-1;i++)for(let r=1;r<e.height-1;r++)e.at(i,r).passibleThrough()&&Math.random()<t&&e.addCreature(new o(i,r),s.pick(null));return e},ne=function(t){let e=t.width,s=t.height,i=0,r=0;for(let a=1;a<t.height-1;a++)for(let n=1;n<t.width-1;n++)t.at(n,a).passibleThrough()&&(r=Math.max(a,r),i=Math.max(n,i),s=Math.min(a,s),e=Math.min(n,e));const a=Math.floor((t.width-(i-e))/2)-e,n=Math.floor((t.height-(r-s))/2)-s;return c(t.map,a),t.map.forEach(t=>c(t,n)),t},he=function(t,e,s){let i=t.width*t.height;for(;i>0;){const a=Object(r.random)(0,t.width-1),n=Object(r.random)(0,t.height-1);if(e(t.at(a,n)))return s(a,n),t;i--}throw"post add failed to add tile"};class oe extends p{constructor(t,e,s,i){super(),this.trapPosition=t,this.trap=e,this.levelMap=s,this.game=i}affectCreature(){return q.NOTHING}affectPlayer(t){return this.trap.untrap(this.trapPosition,t,this.levelMap,this.game),q.NOTHING}}const le=0,ce=60,ue=Math.PI/(2*ce);class de extends a{notCross(t){return t.x-le>this.x+this.w||t.y-le>this.y+this.h||t.x+t.w<this.x-le||t.y+t.h<this.y-le}pointWithin(){return new o(this.x+1+n(this.w-1),this.y+1+n(this.h-1))}add(t,e,s){let i=0;for(;i<this.w;){let r=0;for(;r<this.h;)t[this.x+i][this.y+r]=s(),e[this.x+i][this.y+r]=!1,r++;i++}}}class me extends a{constructor(t,e,s,i){super(t,e,s,i),this.lined=t>=s&&e>=i||s>=t&&i>=e}add(t,e,s){let[i,r,a]=this.horizontalLine(),n=0;for(;n<a;)e[i+n][r]&&(t[i+n][r]=s()),n+=1;let[h,o,l]=this.verticalLine(),c=0;for(;c<l;)e[h][o+c]&&(t[h][o+c]=s()),c+=1}horizontalLine(){return this.lined?[Math.min(this.x,this.w),Math.max(this.y,this.h),Math.abs(this.w-this.x)]:[Math.min(this.x,this.w),Math.min(this.y,this.h),Math.abs(this.w-this.x)]}verticalLine(){return this.lined,[Math.min(this.x,this.w),Math.min(this.y,this.h),Math.abs(this.h-this.y)]}}var ge,pe,fe,we,ve,ye=function(t,e,s,i,r,a,o,l){const c=new class{constructor(t,e,s,i,r){this.maxX=t,this.maxY=e,this.minSize=s,this.maxSize=i,this.roomsCount=r;let a=new Array(this.roomsCount).fill(void 0).map(t=>this.generateRoom());this.rooms=this.normalize(this.ray(a)),this.roads=this.buildRoads(this.rooms)}generateRoom(){return new de(0,0,this.minSize+n(this.maxSize-this.minSize),this.minSize+n(this.maxSize-this.minSize))}ray(t){return t.reduce((t,e)=>{for(let s=0,i=n(360)/180*Math.PI;s<ce;i+=ue,s++){const s=Math.cos(i),r=Math.sin(i);let a=1,n=0,h=0,o=new de(e.x,e.y,e.w,e.h);for(;Math.abs(n)<this.maxX/2&&Math.abs(h)<this.maxY/2;){let e=Math.round(a*s),i=Math.round(a*r);for(;e===n&&i===h;)a+=1,e=Math.round(a*s),i=Math.round(a*r);if(o.move(e-n,i-h),n=e,h=i,t.every(t=>o.notCross(t)))return t.push(o),t}}return t},[])}normalize(t){if(0===t.length)return t;const e=g(t.map(t=>t.x))-1;t.forEach(t=>{t.move(-e,0)}),t=t.filter(t=>t.x+t.w<this.maxX);const s=g(t.map(t=>t.y))-1;return t.forEach(t=>{t.move(0,-s)}),t.filter(t=>t.y+t.h<this.maxY)}buildRoads(t){let e=t.map(t=>t.pointWithin());const s=e.shift();if(!s)throw"Dungeon.buildRoads rooms array is empty";let i=[s],r=[];const a=function(t,e){return Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)};for(;e.length;){let t=e.shift();if(!t)throw"Dungeon.buildRoads rooms array is empty";let s=t,n=i[0],h=a(s,n);i.forEach(t=>{const e=a(t,s);e<h&&(n=t,h=e)}),i.push(s),r.push(new me(s.x,s.y,n.x,n.y))}return r}}(t,e,s,i,r);let u=h(t,e,l),d=h(t,e,()=>!0);for(let t=0;t<c.rooms.length;t++)c.rooms[t].add(u,d,a);for(let t=0;t<c.roads.length;t++)c.roads[t].add(u,d,o);return u};!function(t){t[t.Melee=0]="Melee",t[t.Pierce=1]="Pierce",t[t.Blunt=2]="Blunt",t[t.Magic=3]="Magic",t[t.Pure=4]="Pure"}(ge||(ge={})),function(t){t[t.Neuter=0]="Neuter",t[t.Female=1]="Female",t[t.Male=2]="Male"}(pe||(pe={}));class be{constructor(t){this.requires=t,this.current=1,this.currentExperience=0,this.doneLeveling=!1,this.requiredExperience=this.requires[0]}add(t){if(this.doneLeveling)return[];this.currentExperience+=t;let e=[];for(;!this.doneLeveling&&this.currentExperience>=this.requiredExperience;)this.levelUp(),e.push(this.current);return e}levelUp(){this.current+=1;let t=this.requires[this.current-1];t?(this.currentExperience-=this.requiredExperience,this.requiredExperience=t):(this.currentExperience=this.requiredExperience,this.doneLeveling=!0)}}class xe{constructor(t){this.totalWeight=0,this.items=[],t.forEach(([t,e])=>this.add(t,e))}add(t,e){if(t<1)throw"Item's weight is lower than 1";this.items.push([t,e]),this.totalWeight+=Math.ceil(t)}pick(t){if(0===this.items.length)throw"Tried to use empty pool";let e=Object(r.random)(this.totalWeight);const s=this.items.find(([t,s])=>(e-=t)<=0);if(void 0!==s)return s[1](t);throw"Pool failed to pick anything"}merge(t){let e=new xe([]);return this.items.forEach(([t,s])=>e.add(t,s)),t.items.forEach(([t,s])=>e.add(t,s)),e}}class Me{constructor(){this.step=0,this.turns={}}add(t,e){const s=this.step+e;this.turns[s]?Object(r.includes)(this.turns[s],t)||this.turns[s].push(t):this.turns[s]=[t]}remove(t){Object(r.forEach)(this.turns,(e,s)=>{Object(r.remove)(e,e=>e===t)}),this.turns=Object(r.pickBy)(this.turns,t=>t.length>0)}next(){this.step=this.nextStep();const[t]=Object(r.pullAt)(this.turns[this.step],0);return 0===this.turns[this.step].length&&delete this.turns[this.step],void 0===t?this.next():t}actors(){if(0===Object(r.size)(this.turns))return[];this.step=this.nextStep();const t=this.turns[this.step];return delete this.turns[this.step],t}nextStep(){let t=Object(r.min)(Object(r.keys)(this.turns).map(t=>parseInt(t)));if(void 0===t)throw"Timeline.nextStep called when there is no ones turn";return t}}class Te{constructor(){this.levels=[]}addStairDown(t,e){return this.addStairs(t,new N(t,e))}addStairUp(t,e){return this.addStairs(t,new D(t,e))}addStairs(t,e){return he(t,t=>t.free(),(s,i)=>{t.setTile(s,i,e)}),t}}class Ie extends l{constructor(t,e){super(e),this.name=t,this.creatures=[],this.timeline=new Me}reset(){this.timeline=new Me}enter(){this.reset(),this.creatures.forEach(t=>this.timeline.add(t.id,t.speed))}creatureTile(t){let e;if(this.each(s=>{s.creature&&s.creature.id===t.id&&(e=s)}),!e)throw`Creature ${t.id} ${t.name} is not found on map ${this.name}`;return e}creaturePos(t){let e;if(this.each((s,i,r)=>{s.creature&&s.creature.id===t.id&&(e=new o(i,r))}),!e)throw`Creature ${t.id} ${t.name} is not found on map ${this.name}`;return e}addCreature(t,e){this.creatures.push(e),this.at(t.x,t.y).creature=e,this.timeline.add(e.id,e.speed)}removeCreature(t){let e=this.creaturePos(t);this.at(e.x,e.y).creature=void 0,Object(r.remove)(this.creatures,e=>e.id===t.id),this.timeline.remove(t.id)}visibleThrough(t,e){return this.map[t][e].visibleThrough()}passibleThrough(t,e){return this.map[t][e].passibleThrough()}setTile(t,e,s){this.map[t][e]=s}matchStairs(t){let e;if(this.each((s,i,r)=>{(s instanceof N||s instanceof D)&&s.adjacentMapName===t&&(e=new o(i,r))}),e)return e;throw`LevelMap ${this.name} failed to find stairs to ${t}`}}!function(t){t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARNING=2]="WARNING",t[t.DANGER=3]="DANGER"}(fe||(fe={}));class Ce{constructor(t){this.messages=[],this.trapAirBlow=new Pe(this,t),this.trapBareWire=new ke(this,t),this.trapFallingRock=new Oe(this,t),this.trapHole=new Ee(this,t)}reset(){this.messages=[]}hurtMessage(t,e,s,i){this.debug(`${i.name} got ${e} damage from ${s.name}`)}killMessage(t,e,s,i){this.warning(`${i.name} got ${e} damage from ${s.name} causes them to die`)}missMessage(t,e,s){this.debug(`${e.name} misses ${s.name}!`)}throwMissMessage(t,e,s,i){this.debug(`${e.name} throws ${i.name} in ${s.name}, but misses!`)}throwKillMessage(t,e,s,i,r){this.warning(`${i.name} got ${e} damage from ${s.name} by ${r.name} causes them to die`)}throwHurtMessage(t,e,s,i,r){this.debug(`${i.name} got ${e} damage from ${s.name} by ${r.name}`)}ranIntoAnObstacle(){this.addMessage(fe.DEBUG,"You ran into a wall")}howToHandle(){this.addMessage(fe.DEBUG,"Don't know how to handle it")}noItemsToPickUp(){this.addMessage(fe.DEBUG,"You don't see anything to pick up")}takeOff(t){this.addMessage(fe.DEBUG,`You took off ${t.name}`)}putOn(t){this.addMessage(fe.DEBUG,`You put on ${t.name}`)}drink(t){this.addMessage(fe.INFO,`You drunk ${t.name}`)}nothingToShotWith(){this.addMessage(fe.DEBUG,"You have nothing to shoot with")}needMissileWeapon(){this.addMessage(fe.DEBUG,"Мне нужен лук или типа того")}youSteppedInTrap(){this.addMessage(fe.DANGER,"Я наступил в ловушку")}creatureSteppedInTrap(t){this.addMessage(fe.DANGER,`${t.name} наступил в ловушку`)}noDamageToPlayer(t){this.addMessage(fe.DEBUG,`${t.name} ударил по мне, но я не почувствовал боли`)}noDamageToTarget(t){this.addMessage(fe.DEBUG,`Удар пришелся по ${t.name} но остался незамеченным`)}playerIgnoresDamage(t){this.addMessage(fe.DEBUG,`Я игнорирую урон ${t.name}`)}targetIgnoresDamage(t){this.addMessage(fe.INFO,`${t.name} игнорирует урон`)}creatureTeleported(t){this.addMessage(fe.INFO,`${t.name} иcчез`)}creatureNotTeleported(t){this.addMessage(fe.INFO,`${t.name} озарился светом, но ничего не произошло`)}creatureDodgesTeleportationTrap(t){this.addMessage(fe.INFO,`${t.name} попал в ловушку телепортации но смог увернуться`)}playerTeleportationCaused(){this.addMessage(fe.INFO,"Что-то заставило меня телепортироваться")}playerTeleported(){this.addMessage(fe.INFO,"Яркая вспышка и я оказался в другом месте")}playerNotTeleported(){this.addMessage(fe.INFO,"Я озарился ярким светом, но ничего не произошло")}playerTeleportedWhereTheyWere(){this.addMessage(fe.INFO,"Я решил никуда не телепортироваться")}playerDodgesTeleportationTrap(){this.addMessage(fe.INFO,"Я попал в ловушку телепортации но смог увернуться")}lightTrapActivated(t,e,s,i){s?this.addMessage(fe.INFO,"Яркая вспышка света ослепила меня"):this.addMessage(fe.INFO,`${i.name} озарился яркой вспышкой света`)}lightTrapDodge(t,e,s,i){s?this.addMessage(fe.INFO,"Вспышка света чуть не ослепила меня"):this.addMessage(fe.INFO,`${i.name} озарился яркой вспышкой света`)}canNotUntrap(){this.addMessage(fe.INFO,"Не представляю, как это обезвредить")}failedToUntrap(t){this.addMessage(fe.WARNING,"У меня не получилось обезвредить ловушку")}succeededToUntrap(t){this.addMessage(fe.INFO,"Успешно обезвредил ловушку")}pickedUpItem(t,e){1===e?this.addMessage(fe.INFO,`You picked up ${t.name}`):this.addMessage(fe.INFO,`You picked up ${e} ${t.name}`)}droppedItem(t,e){1===e?this.addMessage(fe.INFO,`You dropped a ${t.name}`):this.addMessage(fe.INFO,`You dropped ${e} ${t.name}`)}waterTrapActivated(){this.info("Я попал в ловушку с водой")}waterBodyPartEquipmentResist(t,e){this.debug(`${e.name} защитил ${t.name} от воды`)}waterBodyPartDamage(t,e){switch(e){case q.DIE:this.danger(`Вода попала мне на ${t.name}, рана не совместима с жизнью`);break;case q.HURT:this.danger(`Вода обожгла мне ${t.name}`);break;case q.NOTHING:case q.RESIST:this.danger(`Вода попала мне на ${t.name}, но все обошлось`)}}waterTrapDamage(t,e,s,i,r){if(e)switch(i){case q.DIE:this.danger(`${r.name} растворился в потоках воды`);break;case q.DODGE:this.info(`${r.name} уклонился от потока воды`);break;case q.HURT:this.warning(`${r.name} пострадал от воды`);break;case q.NOTHING:case q.RESIST:s||this.debug(`${r.name} был облит водой`)}}itemCorrode(t){switch(t.corrosionLevel){case vt.Slightly:return this.info(`${t.name} немного заржавел`);case vt.Mostly:return this.info(`${t.name} значительно проржавел`);case vt.Fully:return this.warning(`${t.name} полностью проржавел`)}}itemDestroyByWater(t,e){this.warning(`${e} ${t.name} были уничтожены водой`)}debug(t){this.addMessage(fe.DEBUG,t)}info(t){this.addMessage(fe.INFO,t)}warning(t){this.addMessage(fe.WARNING,t)}danger(t){this.addMessage(fe.DANGER,t)}addMessage(t,e){const s=Object(r.last)(this.messages);s&&s.message===e?s.counter+=1:this.messages.push({level:t,message:e,counter:1})}}class Se{constructor(t,e){this.logger=t,this.player=e}debug(t){this.logger.debug(t)}info(t){this.logger.info(t)}warning(t){this.logger.warning(t)}danger(t){this.logger.danger(t)}}class Pe extends Se{dodge(t,e,s){e?this.info("Я увернулся от потока воздуха"):t&&this.info(`${s.name} увернулся от потока воздуха`)}resist(t,e,s){e?this.debug("Поток воздуха чуть не снес меня"):t&&this.debug(`${s.name} попал в поток воздуха`)}activate(t,e,s){e?this.info("Меня снесло потоком воздуха"):t&&this.info(`${s.name} снесло потоком воздуха`)}handBlow(t){this.warning(`Поток воздуха выбил ${t.name} у меня из руки`)}headBlow(t){this.warning(`Поток воздуха снял ${t.name} с моей головы`)}}class Ee extends Se{dodge(t,e,s){e?this.warning("Я чуть не упал в яму"):t&&this.warning(`${s.name} чуть не упал в яму`)}activated(t,e,s){e?this.warning("Я упал в яму"):t&&this.warning(`${s.name} упал в яму`)}shallowActivated(t,e,s){e?this.warning("Я упал в неглубокую яму"):t&&this.warning(`${s.name} упал в неглубокую яму`)}}class ke extends Se{activated(t,e,s){this.info(`${s.name} наступил на оголенный провод`)}doNotWant(){this.info("Трогать оголенный провод руками так себе затея")}resist(){this.info("Я наступил на оголенный провод, но все обошлось")}}class Oe extends Se{resist(t){return this.info("Камень упал мне на голову, но каска защитила меня")}ranOut(){return this.debug("Громкий щелчок, но ничего не произошло")}dodge(t,e,s,i){this.info(`${i.name} увернулся от ловушки`)}activate(t,e,s,i,r){this.info(`${r.name} попал в ловушку`)}}class Ne{constructor(t,e){this.player=t,this.professionPicker=e,this.playerTurn=!1,this.running=!1,this.effect=null,this.maps=new Map,this.logger=new Ce(t)}turn(){this.running||this.player.ai.presenter&&!this.effect||(this.running=!0,this.mutexTurn(),this.running=!1)}mutexTurn(){if(!this.player.ai.runEvents()){if(!this.currentMap)throw"mutexTurn: Map is undefined";if(this.effect)this.player.rebuildVision(this.currentMap),this.effect.patchMemory(this.player.stageMemory(this.currentMap)),this.effect.done()&&(this.effect.onDone(),this.effect=null);else{for(;!this.player.dead&&!this.playerTurn;)this.levelMapTurn();this.player.rebuildVision(this.currentMap)}}}getMap(t){const e=this.maps.get(t);if(!e)throw`Map ${t} is not found`;if(e instanceof Ie)return e;if(e instanceof Function){const s=e(t,this);return this.maps.set(t,s),s}throw`LevelMap with id ${t} is not found`}addMap(t,e){this.maps.set(t,e)}levelMapTurn(){if(!this.currentMap)throw"levelMapTurn: Map is undefined";let t=this.currentMap.timeline,e=this.currentMap;const s=t.next();if(void 0===s)throw"Timeline event is empty!";const i=e.creatures.find(t=>s===t.id);if(i){const r=i.act(e,this);r&&e.creatures.find(t=>s===t.id)&&t.add(s,r)}}}class De{constructor(t,e,s){this.usages=t,this.useSingleItem=e,this.equipment=s,this.name="InventorySlot"}matchingItems(t){return t.cares().filter(t=>this.match(t.item))}get insulator(){return!(!this.equipment||!this.equipment.item.insulator)}get firm(){return!(!this.equipment||!this.equipment.item.firm)}equip(t,e){if(this.equipment)throw`Slot ${this.name} is already equipped with ${this.equipment.item}`;this.equipment={count:e,item:t}}takeOff(){if(!this.equipment)throw`Slot ${this.name} has nothing to take off`;this.equipment=void 0}match(t){return Object(r.intersection)(t.usages,this.usages).length>0}withPairItem(t,e){return t.filter(t=>t.item.worksWith(e))}}class Re extends De{get affectedWithWater(){return void 0!==this.material.affectedWithWater}}class Ae extends Re{constructor(t){super([pt.WeaponOneHand],!0),this.material=t,this.name="Правая рука"}}class We extends Re{constructor(t){super([pt.WeaponOneHand],!0),this.material=t,this.name="Левая рука"}}class Fe extends Re{constructor(t){super([pt.WearsOnHead],!0),this.material=t,this.name="Голова"}}class Be extends Re{constructor(t){super([pt.WearsOnBody],!0),this.material=t,this.name="Корпус"}}class He extends Re{constructor(t){super([pt.Boots],!0),this.material=t,this.name="Ботинки"}}class $e extends De{constructor(){super([pt.Gloves],!0),this.name="Перчатки"}}class Ge extends De{constructor(){super([pt.Gauntlets],!0),this.name="Наручи"}}class Le extends De{constructor(){super([pt.Belt],!0),this.name="Пояс"}}class Ue extends De{constructor(){super([pt.Amulet],!0),this.name="Амулет"}}class je extends De{constructor(){super([pt.Ring],!0),this.name="Левый палец"}}class _e extends De{constructor(){super([pt.Ring],!0),this.name="Правый палец"}}class qe extends De{constructor(){super([pt.Cloak],!0),this.name="Плащ"}}class Ve extends De{constructor(){super([pt.Shoot],!0),this.name="Метательное"}matchingItems(t){let e=super.matchingItems(t),s=t.missileSlot.equipment;return s?this.withPairItem(e,s.item):e}}class ze extends De{constructor(){super([pt.Throw],!1),this.name="Снаряды"}matchingItems(t){let e=t.cares(),s=t.missileWeaponSlot.equipment;return s?this.withPairItem(e,s.item):e}}class Ye extends De{constructor(){super([pt.Tool],!0),this.name="Инструмент"}}class Xe{constructor(){this.bag=new v,this.headSlot=new Fe(gt.flesh),this.amuletSlot=new Ue,this.cloakSlot=new qe,this.chestSlot=new Be(gt.flesh),this.rightHandSlot=new Ae(gt.flesh),this.leftHandSlot=new We(gt.flesh),this.leftFingerSlot=new je,this.rightFingerSlot=new _e,this.glovesSlot=new $e,this.gauntletsSlot=new Ge,this.beltSlot=new Le,this.bootsSlot=new He(gt.flesh),this.missileWeaponSlot=new Ve,this.missileSlot=new ze,this.toolsSlot=new Ye}get bodyParts(){return[this.headSlot,this.rightHandSlot,this.leftHandSlot,this.chestSlot,this.bootsSlot]}slots(){return[this.headSlot,this.amuletSlot,this.cloakSlot,this.chestSlot,this.rightHandSlot,this.leftHandSlot,this.leftFingerSlot,this.rightFingerSlot,this.glovesSlot,this.gauntletsSlot,this.beltSlot,this.bootsSlot,this.missileWeaponSlot,this.missileSlot,this.toolsSlot]}get allItems(){return Object(r.concat)(this.cares(),Object(r.compact)(this.slots().map(t=>t.equipment)))}get unarmoredSlotsCount(){return[this.headSlot,this.chestSlot,this.glovesSlot,this.gauntletsSlot,this.beltSlot,this.bootsSlot].filter(t=>!t.equipment).length}cares(){return this.bag.bunch}findInBag(t){return this.bag.find(t)}putToBag(t,e){this.bag.put(t,e)}removeFromBag(t,e){this.bag.remove(t,e)}}class Je{constructor(t){this.tile=t,this.visible=!1,this.degree=0,this.seen=!1}get items(){return this.tile.items}get creature(){return this.tile.creature}see(t,e){this.visible=!0,this.degree=e,this.seen=!0,this.tile=t.clone()}tangible(t){return this.seen&&!this.tile.passibleThrough(t)}reset(){this.visible=!1,this.effect=void 0,this.tile.creature=void 0}visit(t){this.tile.visit(t)}}class Ke extends l{constructor(t,e){const s=new k;super(h(t,e,()=>new Je(s)))}resetVisible(){this.each(t=>t.reset())}}class Qe{constructor(){this.total=0,this.stat=new Map}add(t){const e=this.stat.get(t);e?this.stat.set(t,e+1):this.stat.set(t,1)}get all(){return Object(r.sortBy)(Array.from(this.stat),([t,e])=>t)}}class Ze extends V{constructor(t,e,s,i,r,a){super(s),this.level=t,this.ai=e,this.professions=[],this.inventory=new Xe,this.itemsProtections=[],this.itemsResistances=[],this.killStat=new Qe,this.strength=new $(i),this.dexterity=new L(r),this.constitution=new G(a),this.intelligence=new F(10),this.wisdom=new F(2),this.charisma=new F(2),this.stuffWeight=new F(0),this.carryingCapacity=new B(this.strength.current,this.constitution.current)}act(t,e){this.statsTurn(),this.visionMask(t);const s=this.ai.act(this,t,e);return s&&this.on(s),this.on(new w(t,e)),this.speed}rebuildVision(t){this.visionMask(t)}on(t){return t.affectPlayer(this)}get missile(){return this.inventory.missileSlot.equipment}get inventoryItems(){return this.inventory.allItems}addItem(t,e){this.inventory.putToBag(t,e)}removeItem(t,e){this.inventory.removeFromBag(t,e)}get weightWithCarryings(){return this.specie.weight+Object(r.sumBy)(this.inventory.allItems,({item:t,count:e})=>t.weight*e)}get bodyControl(){return this.specie.bodyControl+this.dexterity.bodyControlAdjustment}get throwDamages(){const t=this.dexterity.missileAdjustment;return Object(r.concat)(this.specie.throwingDamages,this.missileItemsDamages()).map(e=>{let s=Object(r.cloneDeep)(e);return s.extra+=t,s})}get damages(){const t=this.strength.meleeAdjustment;return Object(r.concat)(this.specie.damages,this.meleeItemsDamages()).map(e=>{let s=Object(r.cloneDeep)(e);return s.extra+=t,s})}get protections(){return Object(r.concat)(this.specie.protections,this.itemsProtections,[{type:yt.Unarmored,value:1*this.inventory.unarmoredSlotsCount}])}get resistances(){return Object(r.concat)(this.specie.resistances,this.itemsResistances)}meleeItemsDamages(){const t=this.inventory.rightHandSlot.equipment,e=this.inventory.leftHandSlot.equipment;return Object(r.concat)(t?t.item.damages:[],e?e.item.damages:[])}missileItemsDamages(){const t=this.inventory.missileSlot.equipment,e=this.inventory.missileWeaponSlot.equipment;return Object(r.concat)(t&&t.item.damages||[],e?e.item.damages:[])}}class ts{constructor(t,e,s=1,i=0){this.id=t,this.name=e,this.level=s,this.points=i,this.talents=[],this.depthCost=3}}class es{constructor(t,e,s){this.pool=t,this.maxLevel=e,this.maxTaken=s}available(t){let e,s=[];return this.canUpdate(t)?e=this.updatableProfession(t):this.canTakeNewProfession(t)&&(e=this.newFromPool(t)),void 0!==e&&s.push(e),this.canTakeNewProfession(t)?e=this.newFromPool(t,e&&e.id):this.canUpdate(t)&&(e=this.updatableProfession(t,e&&e.id)),void 0!==e&&s.push(e),s}canUpdate(t){return t.professions.some(t=>t.level<this.maxLevel)}updatableProfession(t,e){return Object(r.sample)(t.professions.filter(t=>e!==t.id))}canTakeNewProfession(t){return t.professions.length<this.maxTaken&&this.pool.length>t.professions.length}newFromPool(t,e){const s=t.professions.map(t=>t.id);return void 0!==e&&s.push(e),Object(r.sample)(this.pool.filter(t=>!Object(r.includes)(s,t.id)))}}!function(t){t[t.Available=0]="Available",t[t.Completed=1]="Completed",t[t.Unavailable=2]="Unavailable"}(we||(we={}));class ss{constructor(t,e,s,i,r,a){this.id=t,this.name=e,this.depth=s,this.rank=i,this.maxRank=r,this.description=a}}class is extends xt{constructor(t,e){super(ut.ItemsListing,t,e),this.positions=[],this.initPositions()}close(){this.goIdle()}}class rs extends is{get singleItemMode(){return!0}}class as extends is{get singleItemMode(){return!1}}class ns extends rs{constructor(){super(...arguments),this.title="Сумка"}initPositions(){this.positions=this.player.inventory.cares()}withItem(){this.endTurn()}}class hs extends rs{constructor(){super(...arguments),this.title="Что выпить?"}initPositions(){this.positions=this.player.inventory.cares().filter(t=>t.item.group===ft.Potion)}withItem({item:t}){this.player.on(new zt(t,this.game)),this.endTurn()}}class os extends as{constructor(){super(...arguments),this.title="Что положить?"}initPositions(){this.positions=this.player.inventory.cares()}withItems(t){t.length?(this.player.on(new Yt(this.tile,t,this.game)),this.endTurn()):this.goIdle()}}class ls extends xt{constructor(t,e){super(ut.Inventory,t,e),this.positions=[],this.takeTime=!1,this.rebuildPositions()}takeOff(t){this.player.on(new Zt(t.inventorySlot,this.game)),this.takeTime=!0,this.rebuildPositions()}putOn(t){this.redirect(new bs(e=>{this.player.on(new ie(t.inventorySlot,e.item,this.game)),this.takeTime=!0,this.rebuildPositions(),this.redirect(this)},t.availableItems,this.levelMap,this.game))}close(){this.takeTime?this.endTurn():this.redirect(new gs(this.levelMap,this.game))}rebuildPositions(){this.positions=this.player.inventory.slots().map(t=>({inventorySlot:t,item:t.equipment&&t.equipment.item,count:t.equipment&&t.equipment.count,availableItems:t.matchingItems(this.player.inventory)}))}}class cs extends xt{constructor(t,e){super(ut.Missile,t,e),this.targetEnemyIndex=void 0,this.enemies=[],this.path=[],this.findEnemies(),this.memory=this.player.stageMemory(this.levelMap),this.targetPos=this.resetTargetId()}nextTarget(){void 0!==this.targetEnemyIndex?(this.targetEnemyIndex+=1,this.targetEnemyIndex>=this.enemies.length&&(this.targetEnemyIndex=0),this.updateTarget(this.enemies[this.targetEnemyIndex])):this.resetTargetId()}previousTarget(){void 0!==this.targetEnemyIndex?(this.targetEnemyIndex-=1,this.targetEnemyIndex<0&&(this.targetEnemyIndex=this.enemies.length-1),this.updateTarget(this.enemies[this.targetEnemyIndex])):this.resetTargetId()}moveTarget(t){const e=this.targetPos.add(t);this.levelMap.at(e.x,e.y).visibleThrough()&&this.player.stageMemory(this.levelMap).at(e.x,e.y).visible&&(this.updateTarget(e),this.targetEnemyIndex=void 0)}attack(){this.targetPos.eq(this.levelMap.creaturePos(this.player))||this.player.on(new ee(this.path,this.game,this.levelMap,()=>this.endTurn()))}close(){this.resetPath(),this.redirect(new gs(this.levelMap,this.game))}resetTargetId(){let t;return this.enemies.length?(this.targetEnemyIndex=0,t=this.enemies[this.targetEnemyIndex]):(this.targetEnemyIndex=void 0,t=this.levelMap.creaturePos(this.player)),this.updateTarget(t),t}resetPath(){this.path.forEach(({x:t,y:e})=>this.memory.at(t,e).effect=void 0)}updateTarget(t){this.resetPath(),this.targetPos=t.copy(),this.drawPath()}drawPath(){this.path=[];let t=!1;const e=this.levelMap,s=this.levelMap.creaturePos(this.player);d(s,this.targetPos,(s,i)=>{e.at(s,i).passibleThrough()||(t=!0),this.path.push(new o(s,i)),this.memory.at(s,i).effect=t?"o":"x"})}findEnemies(){this.enemies=[],this.player.stageMemory(this.levelMap).each((t,e,s)=>{t.visible&&t.creature&&t.creature.id!==this.player.id&&this.enemies.push(new o(e,s))})}}class us extends xt{constructor(t,e,s,i){super(ut.PickHandleOption,e,s),this.options=t,this.withOption=i}pick(t){this.withOption(t)}close(){this.goIdle()}}class ds extends R{constructor(t,e,s){super(),this.position=t,this.game=e,this.levelMap=s,this.commands=[]}onStairway(t){const e=this.game.getMap(t.adjacentMapName);this.commands.push(["stairway",new Y(this.game,this.levelMap,t.enterPos(this.levelMap,e),e)])}onTrap(t){t.revealed&&this.commands.push(["untrap",new oe(this.position,t,this.levelMap,this.game)])}}class ms extends ds{onStairway(){}}class gs extends xt{constructor(t,e){super(ut.Idle,t,e)}inventoryCommand(){this.redirect(new ls(this.levelMap,this.game))}bagCommand(){this.redirect(new ns(this.levelMap,this.game))}stayCommand(){this.player.on(new Et(this.levelMap)),this.endTurn()}dropCommand(){this.redirect(new os(this.levelMap,this.game))}drinkCommand(){this.redirect(new hs(this.levelMap,this.game))}lookCommand(){this.redirect(new fs(this.levelMap,this.game))}move(t){const e=this.levelMap.creaturePos(this.player).add(t),s=this.levelMap.at(e.x,e.y);s.passibleThrough(this.player)?this.player.on(new Y(this.game,this.levelMap,e)):s.creature?this.player.on(new Vt(s.creature,this.levelMap,this.game)):(this.game.logger.ranIntoAnObstacle(),this.player.stageMemory(this.levelMap).at(e.x,e.y).see(s,0)),this.endTurn()}pickUpCommand(){const t=this.tile,e=t.items;void 0===e||0===e.bunch.length?this.game.logger.noItemsToPickUp():1===e.bunch.length?(this.player.on(new se(t,e.bunch,this.game)),this.endTurn()):this.redirect(new vs(this.levelMap,this.game))}missileCommand(){const t=this.player.inventory.missileSlot.equipment;t&&t.item?t.item.canThrow(this.player)?this.redirect(new cs(this.levelMap,this.game)):this.game.logger.needMissileWeapon():this.game.logger.nothingToShotWith()}handleCommand(){let t=this.levelMap.creaturePos(this.player),e=new ds(t,this.game,this.levelMap),s=new ms(t,this.game,this.levelMap);this.tile.visit(e),t.wrappers().forEach(t=>{s.position=t,this.levelMap.at(t.x,t.y).visit(s)});const i=Object(r.concat)(e.commands,s.commands);switch(i.length){case 0:this.game.logger.howToHandle();break;case 1:this.player.on(i[0][1]),this.endTurn();break;default:this.redirect(new us(i,this.levelMap,this.game,([t,e])=>{this.player.on(e),this.endTurn()}))}}}class ps extends xt{constructor(t,e,s,i,r){super(t,e,s),this.effect=i,this.match=r,this.memory=this.player.stageMemory(this.levelMap),this.targetPos=e.creaturePos(this.player),this.drawTarget()}act(){this.removeEffect(),this.close()}get memoryTile(){return this.memory.at(this.targetPos.x,this.targetPos.y)}moveTarget(t){const e=this.targetPos.add(t);this.match(e)&&this.updateTarget(e)}removeEffect(){this.memory.at(this.targetPos.x,this.targetPos.y).effect=void 0}updateTarget(t){this.removeEffect(),this.targetPos=t.copy(),this.drawTarget()}drawTarget(){this.memoryTile.effect=this.effect}}!function(t){t[t.See=0]="See",t[t.Recall=1]="Recall",t[t.Hidden=2]="Hidden"}(ve||(ve={}));class fs extends ps{constructor(t,e){super(ut.Look,t,e,"_",t=>this.memory.inRange(t))}get title(){return this.memoryTile.visible?ve.See:this.memoryTile.seen?ve.Recall:ve.Hidden}get body(){let t=[];if(this.memoryTile.creature&&(this.memoryTile.creature.id===this.player.id?t.push("Это я"):t.push(`Это ${this.memoryTile.creature.name}`)),this.memoryTile.items)switch(this.memoryTile.items.bunch.length){case 0:break;case 1:t.push(`Лежит ${this.memoryTile.items.bunch[0].item.name}`);break;default:t.push("Лежит несколько предметов")}return t}close(){this.redirect(new gs(this.levelMap,this.game))}}class ws extends xt{constructor(t,e,s){super(ut.AbilitiesPicking,e,s),this.level=t,this.options=[],this.options=this.player.professions.map(t=>({profession:t,talents:t.talents.map(e=>Object.assign({},e,{status:this.status(e,t)}))}))}get title(){return"Pick new talent"}pickTalent(t,e){const s=this.player.professions.find(e=>e.id===t);if(void 0===s)throw`Profession with id ${t} is not found`;let i=s.talents.find(t=>t.id===e);if(void 0===i)throw`Talent with id ${e} for profession ${s.name} is not found`;if(this.status(i,s)!==we.Available)throw`Talent with id ${e} for profession ${s.name} can not be upgraded`;i.rank+=1,1===i.rank&&i.onObtain(this.game),s.points+=1,this.player.on(new Xt),this.endTurn()}status(t,e){return t.rank===t.maxRank?we.Completed:t.depth*e.depthCost>e.points?we.Unavailable:we.Available}}class vs extends as{constructor(){super(...arguments),this.title="Что поднять?"}initPositions(){const t=this.tile.items;if(void 0===t)throw"Failed to show pick up dialog - tile has no items";this.positions=t.bunch.map(t=>({item:t.item,count:t.count}))}withItems(t){this.player.on(new se(this.tile,t,this.game)),this.endTurn()}}class ys extends xt{constructor(t,e,s){super(ut.ProfessionPicking,e,s),this.level=t}get title(){return`Gained ${this.level} level`}get options(){return this.game.professionPicker.available(this.player)}pickProfession(t){let e=this.player.professions.find(e=>e.id===t.id);e?e.level+=1:this.player.professions.push(t),this.redirect(new ws(this.level,this.levelMap,this.game))}}class bs extends rs{constructor(t,e,s,i){super(s,i),this.onWithItem=t,this.positions=e,this.title="Что надеть?"}initPositions(){}withItem(t){this.onWithItem(t)}close(){this.redirect(new ls(this.levelMap,this.game))}}const xs=function(t,e,s,i,a=!1){let n=h(t.width,t.height,()=>-1),o=[],l=[e],c=0;for(;l.length&&!o.length;){let e=[];l.forEach(r=>{if(!t.inRange(r))return;const a=t.at(r.x,r.y);s(a)||-1!==n[r.x][r.y]||(n[r.x][r.y]=c,i(r,a)?o.push(r):r.wrappers().forEach(t=>e.push(t)))}),c++,l=e}if(o.length){let t=Object(r.sample)(o);return Ms(a&&t?t:o[0],n)}return[]},Ms=function(t,e){let s,i=t,r=[i];for(;1!==e[i.x][i.y];){if(void 0===(s=o.dxy.find(t=>e[i.x+t.x]&&e[i.x+t.x][i.y+t.y]===e[i.x][i.y]-1)))return[];i=i.add(s),r.unshift(i)}return r};var Ts,Is;!function(t){t[t.AttackerTwoHandedWeapons=0]="AttackerTwoHandedWeapons",t[t.AttackerHeavyWeapons=1]="AttackerHeavyWeapons",t[t.AttackerLightWeapons=2]="AttackerLightWeapons",t[t.AttackerTwoWeapons=3]="AttackerTwoWeapons",t[t.AttackerDoubleTwoHandedWeapons=4]="AttackerDoubleTwoHandedWeapons",t[t.AttackerStrongGrip=5]="AttackerStrongGrip"}(Ts||(Ts={}));class Cs extends ss{constructor(t,e,s,i,r,a=""){super(t,e,s,i,r,a)}}class Ss extends Cs{constructor(){super(Ts.AttackerTwoHandedWeapons,"Двуручные оружия",0,0,3)}onObtain(t){}}!function(t){t[t.Attacker=0]="Attacker",t[t.Defender=1]="Defender"}(Is||(Is={}));class Ps extends ts{constructor(t=1){super(Is.Attacker,"Оружейник",t),this.talents.push(new Ss)}}class Es extends ts{constructor(t=1){super(Is.Defender,"Защитник",t)}}class ks extends es{constructor(t,e=new Ps,s=new Es){super([e,s],3,6),this.attacker=e,this.defender=s}}new xe([[1,()=>new Lt("Катана",1,gt.iron,[{type:ge.Melee,dice:{times:5,max:2},extra:0}])],[7,()=>new Lt("Кинжал",.8,gt.iron,[{type:ge.Melee,dice:{times:1,max:3},extra:2}])]]),new xe([[1,()=>new jt("Кольчуга",5,gt.iron,[{type:yt.Medium,value:3}])],[5,()=>new jt("Латы",3,gt.iron,[{type:yt.Heavy,value:5}])],[10,()=>new jt("Роба",1,gt.iron,[{type:yt.Unarmored,value:1}])],[100,()=>new class extends $t{constructor(){super("Зелье лечения")}onDrink(t){t.player.health.increase(5)}}]]);class Os extends nt{constructor(){super(),this.escaper=new et,this.explorer=new st,this.chaser=new Z,this.attacker=new Q,this.picker=new Pt,this.patrol=new ct,this.loiter=new it,this.thrower=new Rt,this.descender=new Dt}act(t,e,s){let i;return this.runEvents(),this.feelsGood(t)?(i=this.attacker.act(t,e,s))||(i=this.thrower.act(t,e,s))||(i=this.chaser.act(t,e,s))||(i=this.picker.act(t,e,s))||(i=this.explore(t,e,s)):this.healthCritical(t)&&(i=this.escaper.act(t,e,s))||(i=this.attacker.act(t,e,s))||(i=this.thrower.act(t,e,s))||(i=this.chaser.act(t,e,s))||(i=(new kt).act(t,e)),this.resetEvents(),i}feelsGood(t){return t.health.currentValue>.9*t.health.maximum}healthCritical(t){return t.health.currentValue<t.health.maximum/4}explore(t,e,s){let i;return(i=this.explorer.act(t,e,s))?t.dead||this.patrol.trackMovement(e.creaturePos(t),e.creatureTile(t)):(i=this.descender.act(t,e,s))||(i=this.patrol.act(t,e,s))||(i=this.loiter.act(t,e,s)),i}}const Ns=(t,e=[],s)=>new class extends V{constructor(t,e,s=V.getId()){super(e,s),this.ai=t}act(t,e){this.statsTurn(),this.visionMask(t);const s=this.ai.act(this,t,e);return s&&this.on(s),this.on(new w(t,e)),this.speed}get missile(){if(this.specie.throwingItem)return{item:this.specie.throwingItem,count:1}}get inventoryItems(){return this.bag?this.bag.bunch:[]}addItem(t,e){this.bag||(this.bag=new v),this.bag.put(t,e)}removeItem(t,e){if(!this.bag)throw`Creature ${this.name} tried to remove item ${t.name} but it does not present`;this.bag.remove(t,e)}}(new Os,{name:t,weight:10,clan:U.PlayerOnlyEnemy,abilities:[],protections:e,damages:s,maxHealthValue:1,regenerationRate:5,regenerationValue:1,resistances:[],visionRadius:5,moveSpeed:20,attackSpeed:20,bodyControl:5,leavesCorpseRatio:50,material:gt.flesh,throwingDamages:[]}),Ds=()=>Ns("Golem",[{type:yt.Solid,value:5}],[{type:ge.Blunt,dice:{times:1,max:5},extra:10}]),Rs=new xe([[100,()=>Ns("Rat",[],[{type:ge.Melee,dice:{times:2,max:2},extra:0}])],[3,Ds]]),As=new Map;As.set("C",()=>new S("C",b.Floor)),As.set("W",()=>new k),As.set("R",()=>new C("R",b.Floor)),As.set("D",()=>new E);const Ws="title",Fs={addDoors:!1,minSize:3,maxSize:8,roomsCount:20,addTraps:!1,width:100,height:100},Bs=new Map;Bs.set("C",()=>new S("C",b.Floor)),Bs.set("W",()=>new k),Bs.set("R",()=>new C("R",b.Floor)),Bs.set("D",()=>new E);class Hs extends Te{enter(t,e){const s=t.currentMap=t.getMap(Ws);he(s,t=>t.isFloor()&&t.passibleThrough(),(t,i)=>{s.addCreature(new o(t,i),e)})}register(t){t.addMap(Ws,(t,e)=>ae(0,this.generateMap(Ws),Rs))}generateMap(t){let e=new Ie(t,ye(Fs.width,Fs.height,Fs.minSize,Fs.maxSize,Fs.roomsCount,()=>new P,()=>new S("C",b.Floor),()=>new k));return ne(e),e}}class $s extends Ne{constructor(){super(...arguments),this.turns=0}turn(){super.turn(),this.currentMap&&this.playerTurn&&(this.turns+=1,this.player.ai.endTurn(this,this.currentMap))}get done(){return this.player.dead||this.turns>150}}class Gs{static titleGame(){let t=new Ze(new be([1,3,5,10,20]),new St(new Os),{name:"Player",weight:80,clan:U.Player,abilities:_,protections:[],damages:[{type:ge.Pure,dice:{times:3,max:3},extra:1}],maxHealthValue:10,regenerationRate:1,regenerationValue:1,resistances:[],visionRadius:10,moveSpeed:20,attackSpeed:20,bodyControl:5,leavesCorpseRatio:0,material:gt.flesh,throwingDamages:[]},12,12,15),e=new $s(t,new ks(t)),s=new Hs;return s.register(e),s.enter(e,t),e}}var Ls;!function(t){t[t.Human=0]="Human",t[t.Dwarf=1]="Dwarf"}(Ls||(Ls={}));class Us{constructor(t,e,s,i,r,a,n){this.ch=t,this.r=e,this.g=s,this.b=i,this.br=r,this.bg=a,this.bb=n}getChar(){return this.ch}setChar(t){this.ch=t}setColor(t,e,s){this.r=t,this.g=e,this.b=s}setGrey(t){this.r=t,this.g=t,this.b=t}setBackground(t,e,s){this.br=t,this.bg=e,this.bb=s}backgroundToColor(){this.r=this.br,this.g=this.bg,this.b=this.bb}swapColors(){this.r=[this.br,this.br=this.r][0],this.g=[this.bg,this.bg=this.g][0],this.b=[this.bb,this.bb=this.b][0]}resetColor(){this.r=this.g=this.b=void 0}resetBackground(){this.br=this.bg=this.bb=void 0}getColorHex(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?"#"+this.r.toString(16)+this.g.toString(16)+this.b.toString(16):""}getBackgroundHex(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?"#"+this.br.toString(16)+this.bg.toString(16)+this.bb.toString(16):""}getColorRGB(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?`rgb(${this.r},${this.g},${this.b})`:""}getBackgroundRGB(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?`rgb(${this.br},${this.bg},${this.bb})`:""}getColorJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.r,g:this.g,b:this.b}:{}}getBackgroundJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.br,g:this.bg,b:this.bb}:{}}copy(t){this.ch=t.ch,this.r=t.r,this.g=t.g,this.b=t.b,this.br=t.br,this.bg=t.bg,this.bb=t.bb}clone(){return new Us(this.ch,this.r,this.g,this.b,this.br,this.bg,this.bb)}}const js="unicodetiles",_s=new Us(" ");const qs="\nattribute vec2 position;\nattribute vec2 texCoord;\nattribute vec3 color;\nattribute vec3 bgColor;\nattribute float charIndex;\nuniform vec2 uResolution;\nuniform vec2 uTileCounts;\nuniform vec2 uPadding;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec2 tileCoords = floor(vec2(mod(charIndex, uTileCounts.x), charIndex / uTileCounts.x));\n  vTexCoord = (texCoord + tileCoords) / uTileCounts;\n  vTexCoord += (0.5 - texCoord) * uPadding;\n  vColor = color;\n  vBgColor = bgColor;\n  vec2 pos = position / uResolution * 2.0 - 1.0;\n  gl_Position = vec4(pos.x, -pos.y, 0.0, 1.0);\n}\n",Vs="\nprecision mediump float;\nuniform sampler2D uFont;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec4 color = texture2D(uFont, vTexCoord);\n  color.rgb = mix(vBgColor, vColor, color.rgb);\n  gl_FragColor = color;\n}\n";const zs=function(t){return new class{constructor(t){if(this.view=t,this.view=t,this.canvas=document.createElement("canvas"),!this.canvas.getContext)throw"Canvas not supported";if(this.gl=this.canvas.getContext("experimental-webgl"),!this.gl)throw"WebGL not supported";if(t.elem.appendChild(this.canvas),this.charMap={},this.charArray=[],this.defaultColors={r:1,g:1,b:1,br:0,bg:0,bb:0},this.attribs={position:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},texCoord:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},color:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},bgColor:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},charIndex:{buffer:null,data:null,itemSize:1,location:null,hint:this.gl.DYNAMIC_DRAW}},this.offscreen||(this.offscreen=document.createElement("canvas")),this.offscreen.style.position="absolute",this.offscreen.style.top="0px",this.offscreen.style.left="0px",this.ctx=this.offscreen.getContext("2d"),!this.ctx)throw"Failed to acquire offscreen canvas drawing context";this.updateStyle(),this.canvas.width=(t.squarify?this.th:this.tw)*t.w,this.canvas.height=this.th*t.h,this.offscreen.width=0,this.offscreen.height=0,this.updateStyle(),this.gl.viewport(0,0,this.canvas.width,this.canvas.height);let e=this.compileShader(this.gl.VERTEX_SHADER,qs),s=this.compileShader(this.gl.FRAGMENT_SHADER,Vs),i=this.gl.createProgram();if(this.gl.attachShader(i,e),this.gl.attachShader(i,s),this.gl.linkProgram(i),this.gl.deleteShader(e),this.gl.deleteShader(s),!this.gl.getProgramParameter(i,this.gl.LINK_STATUS)){const t=`Error linking program: ${this.gl.getProgramInfoLog(i)}`;throw this.gl.deleteProgram(i),t}this.gl.useProgram(i),this.attribs.position.location=this.gl.getAttribLocation(i,"position"),this.attribs.texCoord.location=this.gl.getAttribLocation(i,"texCoord"),this.attribs.color.location=this.gl.getAttribLocation(i,"color"),this.attribs.bgColor.location=this.gl.getAttribLocation(i,"bgColor"),this.attribs.charIndex.location=this.gl.getAttribLocation(i,"charIndex"),this.initBuffers();let r=this.gl.getUniformLocation(i,"uResolution");this.gl.uniform2f(r,this.canvas.width,this.canvas.height),this.tileCountsLocation=this.gl.getUniformLocation(i,"uTileCounts"),this.gl.uniform2f(this.tileCountsLocation,this.view.w,this.view.h),this.paddingLocation=this.gl.getUniformLocation(i,"uPadding"),this.gl.uniform2f(this.paddingLocation,0,0);let a=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.cacheChars(" !\"#$%&'()*+,-./0123456789:<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.activeTexture(this.gl.TEXTURE0),setTimeout(()=>{this.updateStyle(),this.buildTexture(),this.render()},100)}getRendererString(){return"webgl"}buildTexture(){let t=this.offscreen.width/(this.tw+this.pad),e=this.offscreen.height/(this.th+this.pad);const s=this.charArray.length;s>Math.floor(t)*Math.floor(e)&&(e=(t=Math.ceil(Math.sqrt(s)))+2,this.offscreen.width=t*(this.tw+this.pad),this.offscreen.height=e*(this.th+this.pad),this.updateStyle(),this.gl.uniform2f(this.tileCountsLocation,t,e)),this.gl.uniform2f(this.paddingLocation,this.pad/this.offscreen.width,this.pad/this.offscreen.height);let i,r=0;this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.offscreen.width,this.offscreen.height),this.ctx.fillStyle="#ffffff";const a=.5*this.gap,n=this.tw+this.pad,h=this.th+this.pad;let o=.5*h;for(let s=0;s<e;++s){let e=.5*this.pad;for(let s=0;s<t&&void 0!==(i=this.charArray[r]);++s,++r)this.ctx.fillText(i,e+a,o),e+=n;if(!i)break;o+=h}this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.offscreen)}cacheChars(t,e=!0){if(!this.gl)return;let s=!1;for(let e=0;e<t.length;++e)this.charMap[t[e]]||(s=!0,this.charArray.push(t[e]),this.charMap[t[e]]=this.charArray.length-1);s&&e&&this.buildTexture()}updateStyle(t){t=t||window.getComputedStyle(this.view.elem,null),this.ctx.font=t.fontSize+"/"+t.lineHeight+" "+t.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="#ffffff",this.tw=this.ctx.measureText("幅").width,this.th=parseInt(t.fontSize,10),this.gap=this.view.squarify?this.th-this.tw:0,this.view.squarify&&(this.tw=this.th),this.pad=2*Math.ceil(.2*this.th);const e=t.color.match(/\d+/g),s=t.backgroundColor.match(/\d+/g);this.defaultColors.r=parseInt(e[0],10)/255,this.defaultColors.g=parseInt(e[1],10)/255,this.defaultColors.b=parseInt(e[2],10)/255,this.defaultColors.br=parseInt(s[0],10)/255,this.defaultColors.bg=parseInt(s[1],10)/255,this.defaultColors.bb=parseInt(s[2],10)/255}clear(){}render(){this.gl.clear(this.gl.COLOR_BUFFER_BIT);const t=this.view.w,e=this.view.h;let s=this.view.buffer,i=(this.view.defaultColor,this.view.defaultBackground,!1);for(let r=0;r<e;++r)for(let e=0;e<t;++e){const a=s[r][e];let n=this.charMap[a.ch];void 0===n&&(this.cacheChars(a.ch,!1),i=!0,n=this.charMap[a.ch]);const h=6*this.attribs.color.itemSize*(r*t+e),o=6*this.attribs.charIndex.itemSize*(r*t+e),l=void 0===a.r?this.defaultColors.r:a.r/255,c=void 0===a.g?this.defaultColors.g:a.g/255,u=void 0===a.b?this.defaultColors.b:a.b/255,d=void 0===a.br?this.defaultColors.br:a.br/255,m=void 0===a.bg?this.defaultColors.bg:a.bg/255,g=void 0===a.bb?this.defaultColors.bb:a.bb/255;for(let t=0;t<6;++t){const e=h+t*this.attribs.color.itemSize;this.attribs.color.data[e+0]=l,this.attribs.color.data[e+1]=c,this.attribs.color.data[e+2]=u,this.attribs.bgColor.data[e+0]=d,this.attribs.bgColor.data[e+1]=m,this.attribs.bgColor.data[e+2]=g,this.attribs.charIndex.data[o+t]=n}}i&&this.buildTexture(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.color.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.color.data,this.attribs.color.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.bgColor.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.bgColor.data,this.attribs.bgColor.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.charIndex.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.charIndex.data,this.attribs.charIndex.hint);const r=this.attribs.position;this.gl.drawArrays(this.gl.TRIANGLES,0,r.data.length/r.itemSize)}compileShader(t,e){const s=this.gl.createShader(t);if(this.gl.shaderSource(s,e),this.gl.compileShader(s),!this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)){const t="Error compiling shader: "+this.gl.getShaderInfoLog(s);throw this.gl.deleteShader(s),t}return s}initBuffers(){let t,e,s=this.attribs;const i=this.view.w,r=this.view.h;for(t in this.attribs)(e=s[t]).data=new Float32Array(6*e.itemSize*i*r);for(let t=0;t<r;++t)for(let e=0;e<i;++e){const r=6*s.position.itemSize*(t*i+e);this.insertQuad(s.position.data,r,e*this.tw,t*this.th,this.tw,this.th),this.insertQuad(s.texCoord.data,r,0,0,1,1)}for(t in this.attribs)(e=s[t]).buffer&&this.gl.deleteBuffer(e.buffer),e.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e.data,e.hint),this.gl.enableVertexAttribArray(e.location),this.gl.vertexAttribPointer(e.location,e.itemSize,this.gl.FLOAT,!1,0,0)}insertQuad(t,e,s,i,r,a){const n=s,h=i,o=s+r,l=i+a;t[e]=n,t[++e]=h,t[++e]=o,t[++e]=h,t[++e]=n,t[++e]=l,t[++e]=n,t[++e]=l,t[++e]=o,t[++e]=h,t[++e]=o,t[++e]=l}}(t)},Ys=120,Xs=180,Js={r:255,g:165,b:0};class Ks extends Us{lighted(t){return this}constructor(t,e=Ys,s=Ys,i=Ys){super(t,e,s,i)}litBackground(t,e){return t.setBackground(Js.r*e,Js.g*e,Js.b*e),t}litColor(t,e){return t.setColor(Js.r*e,Js.g*e,Js.b*e),t}}class Qs extends Ks{constructor(t){super(t,Xs,Xs,Xs)}}class Zs extends Qs{constructor(t,e,s,i){super(t),this.vr=e,this.vg=s,this.vb=i}lighted(t){let e=this.clone();return e.setColor(this.vr,this.vg,this.vb),e}}class ti extends Ks{constructor(t,e,s,i){super(t),this.vr=e,this.vg=s,this.vb=i}lighted(t){let e=this.clone();return e.setColor(this.vr,this.vg,this.vb),e}}const ei=new ti("刀",200,200,200),si=new ti("体",200,200,200),ii=new ti("胸",200,200,200),ri=new ti("石",200,200,200),ai=new ti("]",200,200,200),ni=new ti("[",255,255,0),hi=new ti("?",255,255,255),oi=new ti("！",200,200,200),li=function(t){switch(t.group){case ft.OneHandWeapon:return ei;case ft.Consumable:return si;case ft.BodyArmor:return ii;case ft.Missile:return ri;case ft.MissileWeapon:return ai;case ft.Potion:return oi;case ft.Boots:return ni;case ft.Scrolls:return hi;default:return si}},ci=new class extends Ks{constructor(){super("戸")}lighted(t){let e=this.clone();return this.litColor(e,t),e.swapColors(),e}},ui=new class extends Ks{constructor(){super("＃")}lighted(t){let e=this.clone();return this.litBackground(e,t),e.backgroundToColor(),e}},di=new class extends Ks{constructor(){super("・")}lighted(t){return this.litColor(this.clone(),t)}},mi=new class extends Ks{constructor(){super("＞")}},gi=new class extends Ks{constructor(){super("＜")}},pi=new Ks("　",0,0,0),fi=new Ks("^",255,255,255),wi=new Ks("^",0,191,255),vi=new Ks("^",255,255,0),yi=new Ks("^",139,69,19),bi=new Ks("^",255,165,0),xi=new Ks("^",200,200,200),Mi=new Ks("^",0,0,205);const Ti=new class extends R{onWall(t){this.tile=ui}onFloor(t){this.tile=di}onStairwayDown(t){this.tile=mi}onStairwayUp(t){this.tile=gi}onDoor(t){this.tile=ci}onTrap(t){if(t.revealed)switch(t.type){case x.AirBlow:this.tile=fi;break;case x.Teleportation:this.tile=wi;break;case x.Light:this.tile=vi;break;case x.Hole:this.tile=yi;break;case x.BareWire:this.tile=bi;break;case x.FallingRock:this.tile=xi;break;case x.Water:this.tile=Mi}else t.tile.visit(this)}onTrigger(t){t.tile.visit(this)}default(t){this.tile=pi}},Ii=new Zs("＠",0,255,0),Ci=new Zs("r",197,65,38),Si=new Zs("G",120,120,120),Pi=new Ks("　",0,0,0),Ei=[new ti("｜",200,200,200),new ti("／",200,200,200),new ti("ー",200,200,200),new ti("＼",200,200,200)];var ki=i.a.extend({props:["level","player","pos"],data:()=>({wholeMap:!1,term:null,eng:null,drawInterval:null,ts:Date.now(),interval:100,step:0}),methods:{getTile(t,e){const s=this.stage.at(t,e).effect,i=this.wholeMap?this.stage.at(t,e):this.stage.at(t,e).tile;if(!i)return Pi;if(s){if(i.creature){let t=this.creatureTile(i.creature).clone();return t.setBackground(200,0,0),t}return new Ks(s,200,200,0)}if(i.creature)return this.creatureTile(i.creature);if(i.items)switch(i.items.bunch.length){case 0:break;case 1:return li(i.items.bunch[0].item);default:const t=this.step%(3*this.animationFps+4);if(t<Ei.length)return Ei[t];{const t=Math.floor(this.step/(3*this.animationFps+4));return li(i.items.bunch[t%i.items.bunch.length].item)}}return function(t){return t.visit(Ti),Ti.tile}(i)},creatureTile:t=>"Rat"==t.name?Ci:"Golem"==t.name?Si:Ii,initViewport(){this.term=new class{constructor(t,e,s,i,r=!1){this.elem=t,this.w=e,this.h=s,this.squarify=r,this.cx=Math.floor(e/2),this.cy=Math.floor(s/2),this.elem.innerHTML="",-1===t.className.indexOf(js)&&(0===t.className.length?t.className=js:t.className+=" "+js),this.buffer=new Array(s);for(let t=0;t<s;++t){this.buffer[t]=new Array(e);for(let s=0;s<e;++s)this.buffer[t][s]=_s}this.renderer=i(this)}updateStyle(t){const e=window.getComputedStyle(this.elem,null);this.defaultColor=e.color||void 0,this.defaultBackground=e.backgroundColor||void 0,t&&this.renderer.updateStyle(e)}getRendererString(){return this.renderer.getRendererString()}put(t,e,s){e<0||s<0||e>=this.w||s>=this.h||(this.buffer[s][e]=t)}unsafePut(t,e,s){this.buffer[s][e]=t}putString(t,e,s,i,r,a,n,h,o){const l=t.length;if(!(e<0||s<0))for(let c=0;c<l;++c){if(e>=this.w&&(e=0,++s),s>=this.h)return;const l=new Us(t[c],i,r,a,n,h,o);this.unsafePut(l,e,s),++e}}get(t,e){return t<0||e<0||t>=this.w||e>=this.h?_s:this.buffer[e][t]}clear(){for(let t=0;t<this.h;++t)for(let e=0;e<this.w;++e)this.buffer[t][e]=_s;this.renderer.clear()}render(){this.renderer.render()}}(this.$refs.scene,Math.max(this.level.width,40),Math.max(this.level.height,40),zs,!0),this.eng=new class{constructor(t,e,s,i){this.viewport=t,this.tileFunc=e,this.w=s,this.h=i,this.refreshCache=!0,this.cacheEnabled=!1,this.transitionDuration=0,this.cachex=0,this.cachey=0,this.tileCache=new Array(t.h),this.tileCache2=new Array(t.h);for(let e=0;e<t.h;++e)this.tileCache[e]=new Array(t.w),this.tileCache2[e]=new Array(t.w)}setTileFunc(t,e,s){e&&(this.transition=void 0,"string"==typeof e&&("boxin"===e?this.transition=function(t,e,s,i,r,a,n){const h=.5*s,o=.5*i;return t-=h,e-=o,Math.abs(t)<h*n&&Math.abs(e)<o*n?r:a}:"boxout"===e?this.transition=function(t,e,s,i,r,a,n){const h=.5*s,o=.5*i;return t-=h,e-=o,n=1-n,Math.abs(t)<h*n&&Math.abs(e)<o*n?a:r}:"circlein"===e?this.transition=function(t,e,s,i,r,a,n){const h=.5*s,o=.5*i;return(t-=h)*t+(e-=o)*e<(h*h+o*o)*n?r:a}:"circleout"===e?this.transition=function(t,e,s,i,r,a,n){const h=.5*s,o=.5*i;return(t-=h)*t+(e-=o)*e>(h*h+o*o)*(n=1-n)?r:a}:"random"===e&&(this.transition=function(t,e,s,i,r,a,n){return Math.random()>n?a:r})),this.transition&&(this.transitionTimer=(new Date).getTime(),this.transitionDuration=s||500)),this.tileFunc=t}setMaskFunc(t){this.maskFunc=t}setShaderFunc(t){this.shaderFunc=t}setWorldSize(t,e){this.w=t,this.h=e}setCacheEnabled(t){this.cacheEnabled=t,this.refreshCache=!0}update(t,e){t=t||0,e=e||0;const s=t-this.viewport.cx,i=e-this.viewport.cy,r=(new Date).getTime();let a,n;this.transition&&this.transitionTimer&&(a=(r-this.transitionTimer)/this.transitionDuration),a&&a>=1&&(this.transition=void 0);for(let t=0;t<this.viewport.h;++t)for(let e=0;e<this.viewport.w;++e){const h=e+s,o=t+i;if(this.w&&(h<0||h>=this.w))n=_s;else if(this.h&&(o<0||o>=this.h))n=_s;else if(this.maskFunc&&!this.maskFunc(h,o))n=_s;else if(this.transition&&!this.refreshCache)n=this.transition(e,t,this.viewport.w,this.viewport.h,this.tileFunc(h,o),this.tileCache[t][e],a||0);else if(this.cacheEnabled&&!this.refreshCache){const t=h-this.cachex,e=o-this.cachey;t>=0&&t<this.viewport.w&&e>=0&&e<this.viewport.h?(n=this.tileCache[e][t])===_s&&(n=this.tileFunc(h,o)):n=this.tileFunc(h,o)}else n=this.tileFunc(h,o);this.tileCache2[t][e]=n,this.shaderFunc&&n!==_s&&(n=this.shaderFunc(n,h,o,r)),this.viewport.unsafePut(n,e,t)}this.cachex=s,this.cachey=i;const h=this.tileCache;this.tileCache=this.tileCache2,this.tileCache2=h,this.refreshCache=!1}}(this.term,(t,e)=>this.getTile(t,e),this.level.width,this.level.height),this.eng.setMaskFunc((t,e)=>this.wholeMap||this.stage.at(t,e).seen),this.eng.setShaderFunc((t,e,s,i)=>this.lighting(t,e,s,i)),clearInterval(this.drawInterval),this.drawInterval=setInterval(()=>{this.drawScene()},this.interval)},drawScene(){const t=Date.now();this.ts+1e3<t&&(this.ts=t),this.eng.update(this.pos.x,this.pos.y),this.term.render(),this.step+=1},lighting(t,e,s,i){if(this.wholeMap)return t.lighted(1);const r=this.stage.at(e,s);return r.visible&&t.lighted?t.lighted(r.degree):t}},computed:{stage(){return this.wholeMap?this.level:this.player.stageMemory(this.level)},animationFps(){return 1e3/this.interval}},mounted(){this.initViewport()},beforeDestroy(){clearInterval(this.drawInterval)},watch:{interval(){this.initViewport()},level(){clearInterval(this.drawInterval),this.initViewport()}}}),Oi=(s(35),s(8)),Ni=Object(Oi.a)(ki,function(){var t=this.$createElement;return(this._self._c||t)("div",{ref:"scene",staticClass:"unicodetiles"})},[],!1,null,null,null);Ni.options.__file="Scene.vue";var Di=Ni.exports;var Ri;!function(t){t[t.Title=0]="Title",t[t.Gender=1]="Gender",t[t.Race=2]="Race",t[t.PrimaryAttributes=3]="PrimaryAttributes",t[t.Final=4]="Final"}(Ri||(Ri={}));var Ai=i.a.extend({name:"Title",data:()=>({game:null,loopIntervalId:void 0,state:{stage:Ri.Title}}),computed:{genderName(){return this.state.gender===pe.Male?"male":"female"},raceName(){return this.state.race===Ls.Human?"human":"dwarf"},subtitle(){switch(this.state.stage){case Ri.Gender:return"Choose a gender:";case Ri.Race:return`You are ${this.genderName}. Choose a race:`;case Ri.PrimaryAttributes:return`You are ${this.genderName} ${this.raceName}. Choose your attributes:`;default:return""}},options(){switch(this.state.stage){case Ri.Title:return[{char:"N",name:"New game",command:()=>this.state={stage:Ri.Gender}}];case Ri.Gender:return[{char:"M",name:"Male",command:()=>this.state={stage:Ri.Race,gender:pe.Male}},{char:"F",name:"Female",command:()=>this.state={stage:Ri.Race,gender:pe.Female}},{char:"*",name:"Random",separator:!0,command:()=>this.state={stage:Ri.Race,gender:Object(r.sample)([pe.Male,pe.Female])||pe.Male}},{char:"=",name:"Back",separator:!0,command:()=>this.state={stage:Ri.Title}}];case Ri.Race:return[{char:"H",name:"Human",command:()=>Object.assign(this.state,{stage:Ri.PrimaryAttributes,race:Ls.Human})},{char:"D",name:"Dwarf",command:()=>Object.assign(this.state,{stage:Ri.PrimaryAttributes,race:Ls.Dwarf})},{char:"*",name:"Random",separator:!0,command:()=>Object.assign(this.state,{stage:Ri.PrimaryAttributes,race:Object(r.sample)([Ls.Dwarf,Ls.Human])||Ls.Human})},{char:"=",name:"Back",separator:!0,command:()=>this.state={stage:Ri.Gender}}];case Ri.PrimaryAttributes:return[{char:"*",name:"Random",separator:!0,command:()=>Object.assign(this.state,{stage:Ri.Final})},{char:"M",name:"Manually",command:()=>Object.assign(this.state,{stage:Ri.PrimaryAttributes})},{char:"=",name:"Back",separator:!0,command:()=>this.state={stage:Ri.Gender}}];default:return[]}},pos(){if(this.game&&this.game.currentMap)return new o(Math.round(.5*this.game.currentMap.width),Math.round(.4*this.game.currentMap.height))}},components:{Scene:Di},methods:{loop(){this.game&&(this.game.turn(),this.game.done&&(this.game=Gs.titleGame()))},onEvent(t){let e=this.options.find(e=>e.char===t.key.toUpperCase());e?e.command():console.log(t.key)}},created(){this.loopIntervalId=window.setInterval(this.loop,100),document.addEventListener("keydown",this.onEvent)},mounted(){this.game=Gs.titleGame()},beforeDestroy(){clearInterval(this.loopIntervalId),document.removeEventListener("keydown",this.onEvent)}}),Wi=(s(37),Object(Oi.a)(Ai,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"app"}},[t.game?s("Scene",{attrs:{level:t.game.currentMap,player:t.game.player,pos:t.pos}}):t._e(),s("div",{staticClass:"title-view screen-modal"},[s("pre",{staticClass:"title"},[t._v(" ██████╗ ███╗   ██╗██╗███████╗██╗   ██╗███╗   ██╗\n██╔═══██╗████╗  ██║██║██╔════╝██║   ██║████╗  ██║\n██║   ██║██╔██╗ ██║██║███████╗██║   ██║██╔██╗ ██║\n██║   ██║██║╚██╗██║██║╚════██║██║   ██║██║╚██╗██║\n╚██████╔╝██║ ╚████║██║███████║╚██████╔╝██║ ╚████║\n ╚═════╝ ╚═╝  ╚═══╝╚═╝╚══════╝ ╚═════╝ ╚═╝  ╚═══╝")]),s("div",{staticClass:"subtitle",domProps:{textContent:t._s(t.subtitle)}}),s("div",{staticClass:"content"},t._l(t.options,function(e){return s("div",{staticClass:"menu-option",class:{"mt-2":e.separator}},[t._v("["),s("span",{staticClass:"char",domProps:{textContent:t._s(e.char)}}),t._v("]\n"+t._s(e.name))])}))])],1)},[],!1,null,"4ba0d40e",null));Wi.options.__file="Title.vue";var Fi=Wi.exports,Bi=s(17);s(47),s(49),s(51);i.a.use(Bi.a),new i.a({el:"#app",render:t=>t(Fi)})},6:function(t,e,s){},7:function(t,e,s){}});
//# sourceMappingURL=main.96f6f557.js.map
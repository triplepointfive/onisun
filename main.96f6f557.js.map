{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./components/Scene.vue?bf04","webpack:///./components/Title.vue?0dec","webpack:///./src/engine/utils/utils.ts","webpack:///./src/engine/events/internal.ts","webpack:///./src/engine/events/player_event.ts","webpack:///./src/engine/events/after_event.ts","webpack:///./src/engine/lib/bunch.ts","webpack:///./src/engine/lib/impact.ts","webpack:///./src/engine/models/tile.ts","webpack:///./src/engine/lib/map_fov.ts","webpack:///./src/engine/utils/fov.ts","webpack:///./src/engine/lib/attribute.ts","webpack:///./src/engine/lib/stat.ts","webpack:///./src/engine/models/creature.ts","webpack:///./src/engine/events/move_event.ts","webpack:///./src/engine/ai/internal.ts","webpack:///./src/engine/ai/attacker.ts","webpack:///./src/engine/ai/chaser.ts","webpack:///./src/engine/ai/escaper.ts","webpack:///./src/engine/ai/explorer.ts","webpack:///./src/engine/ai/loiter.ts","webpack:///./src/engine/ai/meta_ai.ts","webpack:///./src/engine/ai/patrol.ts","webpack:///./src/engine/presenters/internal.ts","webpack:///./src/engine/models/specie.ts","webpack:///./src/engine/lib/material.ts","webpack:///./src/engine/models/item.ts","webpack:///./src/engine/events/die_event.ts","webpack:///./src/engine/presenters/death_presenter.ts","webpack:///./src/engine/ai/player_ai.ts","webpack:///./src/engine/ai/picker.ts","webpack:///./src/engine/events/stay_event.ts","webpack:///./src/engine/ai/selfhealer.ts","webpack:///./src/engine/ai/descender.ts","webpack:///./src/engine/ai/thrower.ts","webpack:///./src/engine/events/add_experience_event.ts","webpack:///./src/engine/events/add_impact_event.ts","webpack:///./src/engine/lib/calculator.ts","webpack:///./src/engine/events/hurt_event.ts","webpack:///./src/engine/events/attack_event.ts","webpack:///./src/engine/events/drink_potion_event.ts","webpack:///./src/engine/events/drop_items_event.ts","webpack:///./src/engine/events/level_up_event.ts","webpack:///./src/engine/models/tile_effect.ts","webpack:///./src/engine/events/throw_event.ts","webpack:///./src/engine/events/take_off_item_event.ts","webpack:///./src/engine/events/remove_item_event.ts","webpack:///./src/engine/events/missile_attack_event.ts","webpack:///./src/engine/events/pick_up_items_event.ts","webpack:///./src/engine/events/put_on_item_event.ts","webpack:///./src/engine/events/remove_impact_event.ts","webpack:///./src/engine/generator/post.ts","webpack:///./src/engine/events/untrap_event.ts","webpack:///./src/engine/generator/dungeon.ts","webpack:///./src/engine/lib/damage.ts","webpack:///./src/engine/lib/gender.ts","webpack:///./src/engine/models/logger.ts","webpack:///./src/engine/models/talent.ts","webpack:///./src/engine/presenters/look_presenter.ts","webpack:///./src/engine/lib/level.ts","webpack:///./src/engine/lib/pool.ts","webpack:///./src/engine/lib/timeline.ts","webpack:///./src/engine/models/dungeon.ts","webpack:///./src/engine/models/level_map.ts","webpack:///./src/engine/models/game.ts","webpack:///./src/engine/models/inventory_slot.ts","webpack:///./src/engine/models/inventory.ts","webpack:///./src/engine/models/memory.ts","webpack:///./src/engine/utils/kill_stat.ts","webpack:///./src/engine/models/player.ts","webpack:///./src/engine/models/profession.ts","webpack:///./src/engine/presenters/items_listing_presenter.ts","webpack:///./src/engine/presenters/bag_presenter.ts","webpack:///./src/engine/presenters/drink_presenter.ts","webpack:///./src/engine/presenters/drop_items_presenter.ts","webpack:///./src/engine/presenters/inventory_presenter.ts","webpack:///./src/engine/presenters/missile_presenter.ts","webpack:///./src/engine/presenters/pick_single_option_presenter.ts","webpack:///./src/engine/presenters/idle_presenter.ts","webpack:///./src/engine/presenters/pick_point_presenter.ts","webpack:///./src/engine/presenters/talents_tree_presenter.ts","webpack:///./src/engine/presenters/pick_up_presenter.ts","webpack:///./src/engine/presenters/profession_picking_presenter.ts","webpack:///./src/engine/presenters/put_on_items_presenter.ts","webpack:///./src/engine/utils/lee_path.ts","webpack:///./src/onisun/talents.ts","webpack:///./src/onisun/professions.ts","webpack:///./src/onisun/items.ts","webpack:///./src/onisun/potions.ts","webpack:///./src/onisun/ai.ts","webpack:///./src/onisun/creatures.ts","webpack:///./src/onisun/dungeons/tutorial_dungeon.ts","webpack:///./src/onisun/dungeons/title_dungeon.ts","webpack:///./src/onisun.ts","webpack:///./vendor/unicodetiles.ts/src/unicodetiles.ts","webpack:///./vendor/unicodetiles.ts/src/CanvasRenderer.ts","webpack:///./vendor/unicodetiles.ts/src/WebGLRenderer.ts","webpack:///./components/scene_tiles.ts","webpack:///./components/Scene.vue?a309","webpack:///./components/Scene.vue?972d","webpack:///./components/Scene.vue","webpack:///./components/Scene.vue?8979","webpack:///./components/Title.vue?038d","webpack:///./components/Title.vue?85f3","webpack:///./components/Title.vue","webpack:///./components/Title.vue?1630","webpack:///./components/index.ts"],"names":["webpackJsonpCallback","data","moduleId","chunkId","chunkIds","moreModules","executeModules","i","resolves","length","installedChunks","push","Object","prototype","hasOwnProperty","call","modules","parentJsonpFunction","shift","deferredModules","apply","checkDeferredModules","result","deferredModule","fulfilled","j","depId","splice","__webpack_require__","s","installedModules","0","exports","module","l","m","c","d","name","getter","o","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","p","jsonpArray","window","oldJsonpFunction","slice","Rect","[object Object]","x","y","w","h","this","rand","max","Math","floor","random","twoDimArray","width","height","field","Array","Point","point","abs","dxy","map","add","Mapped","on","forEach","column","tile","cycle","list","dx","pop","unshift","bresenham","p0","p1","x0","x1","y0","y1","steps","delta","round","bresenhamInclusion","Direction","super","ratio","up","down","left","right","upLeft","upRight","downLeft","downRight","all","minUnsafe","elem","lodash","undefined","CreatureEvent","subject","affectCreature","player_event_PlayerEvent","creature","Reaction","NOTHING","after_event_AfterEvent","levelMap","game","player","removeImpact","ImpactType","Overloaded","Stressed","Loaded","stuffWeight","current","carryingCapacity","flattenedStart","die_event_DieEvent","DieReason","overloadedStart","addImpact","loadedStart","stressed","bunch_ItemsBunch","bunch","item","find","invItem","groupsWith","count","inventoryItem","inv","groupedItem","put","TileTypes","TrapType","impact_Impact","constEffects","tempEffects","turns","effect","impact","ImpactBunch","impacts","Map","activeImpacts","types","type","active","impactByType","addTempEffect","removeTempEffect","addConstEffect","removeConstEffect","turn","set","tile_Tile","kind","items","isFloor","passibleThrough","Floor","actor","Wall","id","from","buildNew","clone","tileVisitor","onFloor","Corridor","tile_Room","Door","onDoor","onWall","Stairway","currentMap","adjacentMapName","adjacentMap","_enterPos","matchStairs","StairwayDown","onStairwayDown","StairwayUp","onStairwayUp","TileVisitor","wall","default","stairway","onStairway","door","trigger","trap","buildFov","pos","radius","memory","startx","starty","solidChecker","markVisible","doubleRadius","isSolid","dy","castLight","row","start","end","xx","xy","yx","yy","newStart","blocked","distance","deltaY","deltaX","currentX","currentY","leftSlope","rightSlope","doubleDistance","stage","visible","at","visit","visibleThrough","degree","see","calc","attribute_Attribute","modifiers","maximum","atMax","modifier","min","increase","decrease","val","currentValue","Stat","base","rate","extra","CapacityLimitStat","strength","constitution","strengthRatio","constitutionRatio","stat_HealthStat","specie","currentTurn","maxHealthValue","regenerationRate","regenerationValue","StrengthStat","meleeAdjustment","ConstitutionStat","levelUpHPBonus","DexterityStat","bodyControlAdjustment","missileAdjustment","Clan","Ability","allAbilities","GoStairwayDown","Inventory","PutOn","Throwing","creature_Creature","getId","stageMemories","dead","health","lastId","clan","protections","throwDamages","throwingDamages","damages","ability","abilities","event","speed","moveSpeed","visionMask","resetVisible","memory_Memory","creaturePos","visionRadius","impactsBunch","_impactsBunch","addConstImpact","removeConstImpact","hasImpact","Blind","bodyControl","resistance","resistances","weightWithCarryings","weight","move_event_SteppingTileVisitor","reaction","activate","move_event_MoveEvent","nextPoint","nextLevel","removeCreature","addCreature","visitor","reset","enter","internal_AI","destination","move","eq","dest","buildPath","leePath","stageMemory","tangible","tileVisited","pointsToCheck","wavePoints","inRange","wrappers","dist","enemy","FreeForAll","Player","PlayerOnlyEnemy","FollowTargetAI","foundNewTarget","checkCurrentTile","goTo","onCantMove","moveTo","onReach","internal_GoToTileAI","matcher","path","attacker_Attacker","firstTurn","canAttack","victim","victimInAccess","attack_event_AttackEvent","pickNewVictim","act","findCreature","enemies","condition","chaser_Chaser","victimSet","buildVictimPath","foundNewVictim","victimId","followTo","withinView","nextTo","STEP_DISTANCE","escaper_Escaper","escapesFrom","foundEnemies","buildEscapePath","minDistance","explorer_Explorer","seen","loiter_Loiter","AIEvent","logger","AIItemPickedEvent","meta_ai_MetaAI","aiToRun","events","res","run","resetEvents","NEW_POINT_EVERY","patrol_PatrolTileVisitor","status","patrol_Patrol","step","firstCallPatrol","graph","graphlib","lastNodeVisit","currentNodeID","markNodeVisited","nodes","addNode","moveToTarget","targetNodeID","pickUpNewTarget","setNode","setEdge","newNodeId","node","seenLastID","seenLastStep","neighbors","nodeID","buildNewPath","String","fromCharCode","charCodeAt","PresenterType","Resistance","WaterAffect","Material","Usage","ItemGroup","ItemSubgroup","CorrosionLevel","ProtectionType","internal_Presenter","creatureTile","ai","endTurn","presenter","redirect","idle_presenter_IdlePresenter","death_presenter_DeathPresenter","dieReason","Death","playerName","player_ai_AINewLevelEvent","level","profession_picking_presenter_ProfessionPickingPresenter","talents_tree_presenter_TalentsTreePresenter","player_ai_AIDieEvent","rebuildVision","playerTurn","player_ai_PlayerAI","levelUps","runEvents","PlayerBorgAI","picker_Picker","can","pushEvent","pick_up_items_event_PickUpItemsEvent","stay_event_StayEvent","selfhealer_SelfHealer","descender_StairwayDownFinderVisitor","match","descender_StairwayDownTileMoverVisitor","getMap","enterPos","descender_Descender","thrower_Thrower","hasMissile","missile_attack_event_MissileAttackEvent","DIE","previousVictim","missiles","missile","findWithId","obstacles","target","add_experience_event_AddExperienceEvent","add_impact_event_AddImpactEvent","impactType","source","duration","applyImpact","calculator_Calculator","attackerBC","victimBC","pow","chance","lowerWeight","hit","of","actorBC","atan","PI","protectionTypes","victimResistances","every","resistTo","damage","resist","dice","dropDice","protectionValue","damageType","DamageType","Melee","Pierce","Blunt","Intangible","Magic","MagicDamage","Pure","times","armorToDamageRatio","armorType","Medium","Solid","Light","Unarmored","Heavy","cloth","affectedWithWater","firm","fragile","insulator","flesh","glass","iron","Corrosion","leather","paper","Destroy","stone","wood","Item","group","material","usages","corrosionLevel","None","Slightly","Mostly","Fully","canSeeDetails","Corpse","Consumable","item_Potion","Potion","Weapon","rawDamages","damageWithCorrosion","penalty","OneHandWeapon","WeaponOneHand","Armor","rawProtections","usage","protectionWithCorrosion","BodyArmor","WearsOnBody","reason","leavesCorpseRatio","addItem","inventoryItems","hurt_event_HurtEvent","doneDamage","RESIST","HURT","process","noDamageToPlayer","playerIgnoresDamage","noDamageToTarget","targetIgnoresDamage","misses","missMessage","DODGE","hurtEvent","Attack","killMessage","hurtMessage","drink_potion_event_DrinkPotionEvent","potion","removeItem","onDrink","drink","drop_items_event_DropItemsEvent","subtract","droppedItem","level_up_event_LevelUpEvent","updateHealth","constantIncrease","TileEffect","onDone","ItemFlightTileEffect","frames","done","patchMemory","throw_event_ThrowEvent","throwMissMessage","THROW_DODGE","throwKillMessage","Missile","throwHurtMessage","take_off_item_event_TakeOffItemEvent","slot","equipment","takeOff","onTakeOff","inventory","putToBag","itemProtection","itemsProtections","protection","remove_impact_event_RemoveImpactEvent","remove_item_event_RemoveItemEvent","withMissile","missileSlot","flightPath","tileItems","withTileItems","pickedUpItem","remove","put_on_item_event_PutOnItemEvent","groupItem","findInBag","useSingleItem","equip","onPutOn","putOn","concat","addCreatures","creaturesPool","pick","centralize","minX","minY","maxX","maxY","withMatchingTile","onValid","iters","untrap_event_UntrapEvent","trapPosition","untrap","THICKNESS","RAY_TURNS","DELTA_ANGLE","dungeon_Room","rect","walls","newRoomSpace","dungeon_Road","lined","newCorridor","hx","hy","horizontalLine","vx","vy","verticalLine","Gender","LogLevel","TalentStatus","LookPresenterVisibility","generator_dungeon","dimX","dimY","minSize","maxSize","roomsCount","newWall","dungeon","rooms","fill","_","generateRoom","normalize","ray","roads","buildRoads","reduce","pickedRooms","currentRoom","angle","cos","sin","roomToMove","ndx","ndy","room","notCross","filter","points","pointWithin","firstPoint","connectedPoints","point1","point2","maybePoint","currentPoint","pointToConnect","currentDistance","Level","requires","currentExperience","doneLeveling","requiredExperience","exp","levelUp","pool_Pool","totalWeight","ceil","input","found","pool","totalPool","timeline_Timeline","ts","element","nextStep","next","actors","parseInt","dungeon_Dungeon","levels","adjustMapName","addStairs","free","setTile","level_map_LevelMap","creatures","timeline","each","adjustName","stairPos","logger_Logger","messages","trapAirBlow","TrapAirBlowLogger","trapBareWire","TrapBareWireLogger","trapFallingRock","TrapFallingRockLogger","trapHole","TrapHoleLogger","debug","warning","addMessage","DEBUG","INFO","DANGER","sees","isPlayer","WARNING","info","bodyPart","danger","message","lastRow","counter","SubLogger","game_Game","professionPicker","running","maps","mutexTurn","levelMapTurn","Function","builtLevelMap","generator","actorId","inventory_slot_InventorySlot","cares","itemGroup","baseMatch","worksWith","BodyPart","inventory_slot_RightHandSlot","inventory_slot_LeftHandSlot","inventory_slot_HeadSlot","WearsOnHead","inventory_slot_ChestSlot","inventory_slot_BootsSlot","Boots","inventory_slot_GlovesSlot","Gloves","inventory_slot_GauntletsSlot","Gauntlets","inventory_slot_BeltSlot","Belt","inventory_slot_AmuletSlot","Amulet","inventory_slot_LeftFingerSlot","Ring","inventory_slot_RightFingerSlot","inventory_slot_CloakSlot","Cloak","inventory_slot_MissileWeaponSlot","Shoot","matchingItems","withPairItem","inventory_slot_MissileSlot","Throw","missileWeapon","missileWeaponSlot","inventory_slot_ToolsSlot","Tool","inventory_Inventory","bag","headSlot","amuletSlot","cloakSlot","chestSlot","rightHandSlot","leftHandSlot","leftFingerSlot","rightFingerSlot","glovesSlot","gauntletsSlot","beltSlot","bootsSlot","toolsSlot","bodyParts","allItems","slots","unarmoredSlotsCount","MemoryTile","baseTile","kill_stat_KillStat","total","stat","player_Player","strengthValue","dexterityValue","constitutionValue","professions","itemsResistances","killStat","dexterity","intelligence","wisdom","charisma","statsTurn","command","affectPlayer","removeFromBag","dexterityAdjustment","missileItemsDamages","dmg","strengthAdjustment","meleeItemsDamages","rightHandEq","leftHandEq","missileEq","missileWeaponEq","Profession","talents","depthCost","profession_ProfessionPicker","maxLevel","maxTaken","pickedProfession","canUpdate","updatableProfession","canTakeNewProfession","newFromPool","some","profession","excludeId","excluding","Talent","depth","rank","maxRank","description","items_listing_presenter_ItemsListingPresenter","ItemsListing","positions","initPositions","goIdle","SingleItemUseListingPresenter","singleItemMode","MultipleItemUseListingPresenter","bag_presenter_BagPresenter","title","drink_presenter_DrinkPresenter","drop_items_presenter_DropItemsPresenter","inventory_presenter_InventoryPresenter","takeTime","rebuildPositions","position","inventorySlot","put_on_items_presenter_PutOnItemsPresenter","availableItems","missile_presenter_MissilePresenter","targetEnemyIndex","findEnemies","targetPos","resetTargetId","updateTarget","direction","resetPath","newPos","copy","drawPath","stop","pick_single_option_presenter_PickSingleOptionPresenter","options","withOption","PickHandleOption","option","idle_presenter_HandleTileVisitor","commands","revealed","AdjustHandleTileVisitor","Idle","look_presenter_LookPresenter","ranIntoAnObstacle","noItemsToPickUp","pick_up_presenter_PickUpPresenter","canThrow","needMissileWeapon","nothingToShotWith","adjustVisitor","howToHandle","pick_point_presenter_PickPointPresenter","drawTarget","removeEffect","close","memoryTile","Look","See","Recall","Hidden","body","AbilitiesPicking","talent","assign","professionId","talentId","Available","onObtain","Completed","Unavailable","ProfessionPicking","available","playerProfession","onWithItem","randomDestination","pointsToVisit","randomPointToVisit","buildRoad","lastPoint","chain","dp","OnisunTalentId","OnisunProfessionId","talents_OnisunTalent","AttackerTwoHandedWeapons","professions_OnisunAttackerProfession","Attacker","professions_OnisunDefenderProfession","Defender","professions_OnisunProfessionPicker","attacker","defender","ai_Dispatcher","escaper","explorer","chaser","picker","patrol","loiter","thrower","descender","feelsGood","explore","healthCritical","trackMovement","newCreature","throwingItem","attackSpeed","golem","creaturesPool1","tiles","titleId","config","addDoors","addTraps","title_dungeon_tiles","title_dungeon_TitleDungeon","addMap","generateMap","onisun_TitleGame","onisun_Application","register","Race","unicodetiles_Tile","ch","g","b","br","bg","bb","grey","toString","other","CSSCLASS","NULLTILE","VERTEX_SHADER","FRAGMENT_SHADER","webGLRenderer","viewport","view","canvas","document","createElement","getContext","gl","appendChild","charMap","charArray","defaultColors","attribs","buffer","itemSize","location","hint","STATIC_DRAW","texCoord","color","DYNAMIC_DRAW","bgColor","charIndex","offscreen","style","top","ctx","updateStyle","squarify","th","tw","vertexShader","compileShader","fragmentShader","program","createProgram","attachShader","linkProgram","deleteShader","getProgramParameter","LINK_STATUS","msg","getProgramInfoLog","deleteProgram","useProgram","getAttribLocation","initBuffers","resolutionLocation","getUniformLocation","uniform2f","tileCountsLocation","paddingLocation","texture","createTexture","bindTexture","TEXTURE_2D","cacheChars","texParameteri","TEXTURE_MAG_FILTER","NEAREST","TEXTURE_MIN_FILTER","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","activeTexture","TEXTURE0","setTimeout","buildTexture","render","pad","charCount","sqrt","fillStyle","fillRect","halfGap","gap","fillText","texImage2D","RGBA","UNSIGNED_BYTE","chars","build","changed","getComputedStyle","font","fontSize","lineHeight","fontFamily","textBaseline","measureText","backgroundColor","clear","COLOR_BUFFER_BIT","newChars","defaultColor","defaultBackground","k","kk","bindBuffer","ARRAY_BUFFER","bufferData","attrib","drawArrays","TRIANGLES","shader","createShader","shaderSource","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","a","Float32Array","insertQuad","deleteBuffer","createBuffer","enableVertexAttribArray","vertexAttribPointer","FLOAT","arr","x2","y2","DEFAULT_GREY","IMPORTANT_GREY","DEFAULT_LIT","scene_tiles_DisplayTile","char","setBackground","setColor","ImportantTile","CreatureTile","vr","vg","vb","ItemTile","WEAPON","CORPSE","BODY_ARMOR","MISSILE","MISSILE_WEAPON","BOOTS","SCROLL","POTION","displayItem","MissileWeapon","Scrolls","DOOR","litColor","swapColors","WALL","litBackground","backgroundToColor","FLOOR","STAIRWAY_DOWN","STAIRWAY_UP","NULL_TILE","AIR_BLOW_TRAP","TELEPORTATION_TRAP","LIGHT_TRAP","HOLE_TRAP","BARE_WIRE_TRAP","FALLING_ROCK_TRAP","WATER_TRAP","displayTileVisitor","AirBlow","Teleportation","Hole","BareWire","FallingRock","Water","HUMAN","RAT","GOLEM","Scenevue_type_script_lang_ts_NULL_TILE","nextItemAnimation","components_Scenevue_type_script_lang_ts_","vue_runtime_esm","extend","props","wholeMap","term","eng","drawInterval","Date","now","interval","methods","dTile","frame","animationFps","itemId","displayTile","renderer","cx","cy","innerHTML","className","indexOf","updateRenderer","getRendererString","str","len","unsafePut","$refs","scene","tileFunc","refreshCache","cacheEnabled","transitionDuration","cachex","cachey","tileCache","tileCache2","func","transition","new_t","old_t","factor","halfw","halfh","transitionTimer","getTime","maskFunc","shaderFunc","timeNow","transTime","ixx","jyy","lookupx","lookupy","tempCache","getTile","setMaskFunc","setShaderFunc","time","lighting","clearInterval","setInterval","drawScene","update","lighted","fovTile","computed","initViewport","watch","component","componentNormalizer","_h","$createElement","_self","_c","ref","staticClass","__file","Scene","Stage","components_Titlevue_type_script_lang_ts_","loopIntervalId","state","Title","gender","Male","race","Human","genderName","PrimaryAttributes","raceName","Female","separator","Dwarf","Final","components","titleGame","toUpperCase","console","log","loop","addEventListener","onEvent","removeEventListener","Title_component","_vm","attrs","_e","_v","domProps","textContent","_s","subtitle","_l","class","mt-2","use","es","el"],"mappings":"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","file":"main.96f6f557.js","sourcesContent":[" \t// install a JSONP callback for chunk loading\n \tfunction webpackJsonpCallback(data) {\n \t\tvar chunkIds = data[0];\n \t\tvar moreModules = data[1];\n \t\tvar executeModules = data[2];\n\n \t\t// add \"moreModules\" to the modules object,\n \t\t// then flag all \"chunkIds\" as loaded and fire callback\n \t\tvar moduleId, chunkId, i = 0, resolves = [];\n \t\tfor(;i < chunkIds.length; i++) {\n \t\t\tchunkId = chunkIds[i];\n \t\t\tif(installedChunks[chunkId]) {\n \t\t\t\tresolves.push(installedChunks[chunkId][0]);\n \t\t\t}\n \t\t\tinstalledChunks[chunkId] = 0;\n \t\t}\n \t\tfor(moduleId in moreModules) {\n \t\t\tif(Object.prototype.hasOwnProperty.call(moreModules, moduleId)) {\n \t\t\t\tmodules[moduleId] = moreModules[moduleId];\n \t\t\t}\n \t\t}\n \t\tif(parentJsonpFunction) parentJsonpFunction(data);\n\n \t\twhile(resolves.length) {\n \t\t\tresolves.shift()();\n \t\t}\n\n \t\t// add entry modules from loaded chunk to deferred list\n \t\tdeferredModules.push.apply(deferredModules, executeModules || []);\n\n \t\t// run deferred modules when all chunks ready\n \t\treturn checkDeferredModules();\n \t};\n \tfunction checkDeferredModules() {\n \t\tvar result;\n \t\tfor(var i = 0; i < deferredModules.length; i++) {\n \t\t\tvar deferredModule = deferredModules[i];\n \t\t\tvar fulfilled = true;\n \t\t\tfor(var j = 1; j < deferredModule.length; j++) {\n \t\t\t\tvar depId = deferredModule[j];\n \t\t\t\tif(installedChunks[depId] !== 0) fulfilled = false;\n \t\t\t}\n \t\t\tif(fulfilled) {\n \t\t\t\tdeferredModules.splice(i--, 1);\n \t\t\t\tresult = __webpack_require__(__webpack_require__.s = deferredModule[0]);\n \t\t\t}\n \t\t}\n \t\treturn result;\n \t}\n\n \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading chunks\n \t// undefined = chunk not loaded, null = chunk preloaded/prefetched\n \t// Promise = chunk loading, 0 = chunk loaded\n \tvar installedChunks = {\n \t\t0: 0\n \t};\n\n \tvar deferredModules = [];\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/onisun/\";\n\n \tvar jsonpArray = window[\"webpackJsonp\"] = window[\"webpackJsonp\"] || [];\n \tvar oldJsonpFunction = jsonpArray.push.bind(jsonpArray);\n \tjsonpArray.push = webpackJsonpCallback;\n \tjsonpArray = jsonpArray.slice();\n \tfor(var i = 0; i < jsonpArray.length; i++) webpackJsonpCallback(jsonpArray[i]);\n \tvar parentJsonpFunction = oldJsonpFunction;\n\n\n \t// add entry module to deferred list\n \tdeferredModules.push([18,1]);\n \t// run deferred modules when ready\n \treturn checkDeferredModules();\n","import mod from \"-!../node_modules/mini-css-extract-plugin/dist/loader.js!../node_modules/css-loader/index.js??ref--1-oneOf-2-1!../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../node_modules/sass-loader/lib/loader.js??ref--1-oneOf-2-2!../node_modules/vue-loader/lib/index.js??vue-loader-options!./Scene.vue?vue&type=style&index=0&lang=scss&\"; export default mod; export * from \"-!../node_modules/mini-css-extract-plugin/dist/loader.js!../node_modules/css-loader/index.js??ref--1-oneOf-2-1!../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../node_modules/sass-loader/lib/loader.js??ref--1-oneOf-2-2!../node_modules/vue-loader/lib/index.js??vue-loader-options!./Scene.vue?vue&type=style&index=0&lang=scss&\"","import mod from \"-!../node_modules/mini-css-extract-plugin/dist/loader.js!../node_modules/css-loader/index.js??ref--1-oneOf-2-1!../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../node_modules/sass-loader/lib/loader.js??ref--1-oneOf-2-2!../node_modules/vue-loader/lib/index.js??vue-loader-options!./Title.vue?vue&type=style&index=0&id=4ba0d40e&lang=scss&scoped=true&\"; export default mod; export * from \"-!../node_modules/mini-css-extract-plugin/dist/loader.js!../node_modules/css-loader/index.js??ref--1-oneOf-2-1!../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../node_modules/sass-loader/lib/loader.js??ref--1-oneOf-2-2!../node_modules/vue-loader/lib/index.js??vue-loader-options!./Title.vue?vue&type=style&index=0&id=4ba0d40e&lang=scss&scoped=true&\"","import { min } from 'lodash'\n\nexport class Rect {\n  constructor(\n    public x: number,\n    public y: number,\n    public w: number,\n    public h: number\n  ) {\n    if (w <= 0 || h <= 0) {\n      throw `Rect ${x} ${y} ${w} ${h}: size is negative or zero`\n    }\n  }\n\n  move(x: number, y: number): void {\n    this.x += x\n    this.y += y\n  }\n}\n\nexport const rand = function(max: number): number {\n  return Math.floor(Math.random() * max)\n}\n\nexport const twoDimArray = function<T>(\n  width: number,\n  height: number,\n  value: (x: number, y: number) => T\n): T[][] {\n  let field = Array(width)\n\n  for (let i = 0; i < width; i++) {\n    field[i] = new Array(height)\n    for (let j = 0; j < height; j++) {\n      field[i][j] = value(i, j)\n    }\n  }\n\n  return field\n}\n\nexport class Point {\n  constructor(public x: number, public y: number) {}\n\n  public static readonly dxy = [\n    new Point(-1, -1),\n    new Point(0, -1),\n    new Point(1, -1),\n    new Point(-1, 0),\n    new Point(1, 0),\n    new Point(-1, 1),\n    new Point(0, 1),\n    new Point(1, 1),\n  ]\n\n  public eq(point: Point): boolean {\n    return this.x === point.x && this.y === point.y\n  }\n\n  public nextTo(point: Point): boolean {\n    return Math.abs(this.x - point.x) <= 1 && Math.abs(this.y - point.y) <= 1\n  }\n\n  public copy(): Point {\n    return new Point(this.x, this.y)\n  }\n\n  public add(point: Point): Point {\n    return new Point(this.x + point.x, this.y + point.y)\n  }\n\n  public wrappers(): Point[] {\n    return Point.dxy.map(point => this.add(point))\n  }\n}\n\nexport abstract class Mapped<T> {\n  public readonly width: number\n  public readonly height: number\n\n  constructor(public map: T[][]) {\n    this.width = map.length\n    this.height = map[0].length\n  }\n\n  public at(x: number, y: number): T {\n    return this.map[x][y]\n  }\n\n  public inRange(point: Point): boolean {\n    return (\n      point.x >= 0 &&\n      point.y >= 0 &&\n      point.x < this.width &&\n      point.y < this.height\n    )\n  }\n\n  public each(on: (tile: T, x: number, y: number) => any): void {\n    this.map.forEach((column, x) => {\n      column.forEach((tile, y) => {\n        on(tile, x, y)\n      })\n    })\n  }\n}\n\nexport const cycle = function(list: any[], dx: number): any[] {\n  let x\n  if (dx > 0) {\n    for (let i = 0; i < dx; i++) {\n      x = list.pop()\n      list.unshift(x)\n    }\n  } else if (dx < 0) {\n    for (let i = dx; i < 0; i++) {\n      x = list.shift()\n      list.push(x)\n    }\n  }\n\n  return list\n}\n\nexport const bresenham = function(\n  p0: Point,\n  p1: Point,\n  on: (x: number, y: number) => void\n): void {\n  let [x0, x1, y0, y1] = [p0.x, p1.x, p0.y, p1.y]\n  let steps = Math.max(Math.abs(x0 - x1), Math.abs(y0 - y1))\n  const delta = new Point((x1 - x0) / steps, (y1 - y0) / steps)\n\n  while (steps > 1) {\n    x0 += delta.x\n    y0 += delta.y\n\n    on(Math.round(x0), Math.round(y0))\n\n    steps -= 1\n  }\n}\n\nexport const bresenhamInclusion = function(\n  p0: Point,\n  p1: Point,\n  on: (x: number, y: number) => void\n): void {\n  bresenham(p0, p1, on)\n  on(p1.x, p1.y)\n}\n\nexport class Direction extends Point {\n  private constructor(x: number, y: number) {\n    super(x, y)\n  }\n\n  static readonly up = new Direction(0, -1)\n  static readonly down = new Direction(0, 1)\n  static readonly left = new Direction(-1, 0)\n  static readonly right = new Direction(1, 0)\n\n  static readonly upLeft = new Direction(-1, -1)\n  static readonly upRight = new Direction(1, -1)\n  static readonly downLeft = new Direction(-1, 1)\n  static readonly downRight = new Direction(1, 1)\n\n  static readonly all = [\n    Direction.up,\n    Direction.down,\n    Direction.left,\n    Direction.right,\n    Direction.upLeft,\n    Direction.upRight,\n    Direction.downLeft,\n    Direction.downRight,\n  ]\n\n  public multiple(ratio: number): Point {\n    return new Point(this.x * ratio, this.y * ratio)\n  }\n}\n\nexport const minUnsafe = function<T>(list: T[]): T {\n  const elem = min(list)\n  if (elem !== undefined) {\n    return elem\n  }\n\n  throw 'minUnsafe got empty array'\n}\n","import { Creature, Reaction } from '../models/creature'\nimport { Player } from '../models/player'\n\nexport abstract class CreatureEvent {\n  public abstract affectCreature(subject: Creature): Reaction\n  public affectPlayer(subject: Player): Reaction {\n    return this.affectCreature(subject)\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { Creature, Reaction } from '../models/creature'\n\nexport class PlayerEvent extends CreatureEvent {\n  public affectCreature(creature: Creature): Reaction {\n    return Reaction.NOTHING\n  }\n}\n","import { DieEvent, DieReason, Game, ImpactType, LevelMap } from '../../engine'\nimport { Reaction } from '../models/creature'\nimport { Player } from '../models/player'\nimport { PlayerEvent } from './player_event'\n\nexport class AfterEvent extends PlayerEvent {\n  constructor(private levelMap: LevelMap, private game: Game) {\n    super()\n  }\n\n  public affectPlayer(player: Player): Reaction {\n    player.removeImpact(ImpactType.Overloaded, 'bag')\n    player.removeImpact(ImpactType.Stressed, 'bag')\n    player.removeImpact(ImpactType.Loaded, 'bag')\n\n    if (player.stuffWeight.current > player.carryingCapacity.flattenedStart) {\n      return player.on(\n        new DieEvent(this.game, this.levelMap, DieReason.Overloaded)\n      )\n    }\n\n    if (player.stuffWeight.current > player.carryingCapacity.overloadedStart) {\n      player.addImpact(ImpactType.Overloaded, 'bag')\n    } else if (\n      player.stuffWeight.current > player.carryingCapacity.loadedStart\n    ) {\n      player.addImpact(ImpactType.Loaded, 'bag')\n    } else if (player.stuffWeight.current > player.carryingCapacity.stressed) {\n      player.addImpact(ImpactType.Stressed, 'bag')\n    }\n\n    return Reaction.NOTHING\n  }\n}\n","import { remove } from 'lodash'\n\ninterface Grouping {\n  groupsWith(item: Grouping): boolean\n}\n\nexport interface GroupedItem<Item> {\n  count: number\n  item: Item\n}\n\nexport class ItemsBunch<Item extends Grouping> {\n  public bunch: GroupedItem<Item>[] = []\n\n  public find(item: Item): GroupedItem<Item> | undefined {\n    return this.bunch.find(invItem => invItem.item.groupsWith(item))\n  }\n\n  public remove(item: Item, count: number): void {\n    const invItem = this.find(item)\n\n    if (invItem === undefined) {\n      // TODO: Fail if removes item that's not in bunch yet?\n      return\n    } else if (invItem.count === count) {\n      remove(this.bunch, inventoryItem =>\n        inventoryItem.item.groupsWith(invItem.item)\n      )\n    } else {\n      invItem.count -= count\n    }\n  }\n\n  public put(item: Item, count: number): void {\n    const invItem = this.bunch.find(inv => inv.item.groupsWith(item))\n\n    if (invItem) {\n      invItem.count += count\n    } else {\n      this.bunch.push({ count: count, item: item })\n    }\n  }\n\n  public clone(): ItemsBunch<Item> {\n    let bunch = new ItemsBunch<Item>()\n\n    this.bunch.forEach(groupedItem => {\n      bunch.put(groupedItem.item, groupedItem.count)\n    })\n\n    return bunch\n  }\n}\n","import { remove } from 'lodash'\n\nexport enum ImpactType {\n  Blind,\n  Stressed,\n  Loaded,\n  Overloaded,\n}\n\nclass Impact {\n  private constEffects: string[] = []\n  private tempEffects: number = 0\n\n  constructor() {}\n\n  public addTempEffect(turns: number): void {\n    this.tempEffects += turns\n  }\n\n  public addConstEffect(effect: string): void {\n    // TODO: Validate keys do not repeat\n    this.constEffects.push(effect)\n  }\n\n  public removeTempEffect(): void {\n    this.tempEffects = 0\n  }\n\n  public removeConstEffect(effect: string): void {\n    remove(this.constEffects, impact => impact === effect)\n  }\n\n  public active(): boolean {\n    return this.tempEffects > 0 || this.constEffects.length > 0\n  }\n\n  public turn(): void {\n    if (this.tempEffects >= 1) {\n      this.tempEffects -= 1\n    }\n  }\n}\n\nexport class ImpactBunch {\n  private impacts: Map<ImpactType, Impact> = new Map()\n\n  get activeImpacts(): ImpactType[] {\n    let types: ImpactType[] = []\n\n    this.impacts.forEach((impact, type) => {\n      if (impact.active()) {\n        types.push(type)\n      }\n    })\n\n    return types\n  }\n\n  public addImpact(type: ImpactType, turns: number): void {\n    this.impactByType(type).addTempEffect(turns)\n  }\n\n  public removeImpact(type: ImpactType): void {\n    this.impactByType(type).removeTempEffect()\n  }\n\n  public addConstImpact(type: ImpactType, effect: string): void {\n    this.impactByType(type).addConstEffect(effect)\n  }\n\n  public removeConstImpact(type: ImpactType, effect: string): void {\n    this.impactByType(type).removeConstEffect(effect)\n  }\n\n  public turn(): void {\n    this.impacts.forEach(impact => impact.turn())\n  }\n\n  protected impactByType(type: ImpactType): Impact {\n    let impact = this.impacts.get(type)\n    if (impact !== undefined) {\n      return impact\n    }\n\n    impact = new Impact()\n    this.impacts.set(type, impact)\n    return impact\n  }\n}\n","import { Creature, Reaction } from './creature'\nimport { Point } from '../utils/utils'\nimport { LevelMap } from './level_map'\nimport { Item } from './item'\nimport { Game } from './game'\nimport { ItemsBunch } from '../lib/bunch'\nimport { Player } from './player'\n\nexport enum TileTypes {\n  Wall,\n  Door,\n  Floor,\n  StairwayDown,\n  StairwayUp,\n  Trap,\n  Trigger,\n}\n\nexport abstract class Tile {\n  public creature?: Creature\n  public items: ItemsBunch<Item> | undefined\n\n  constructor(public key: string, public kind: TileTypes) {}\n\n  public addItem(item: Item, count: number): void {\n    if (!this.items) {\n      this.items = new ItemsBunch()\n    }\n\n    this.items.put(item, count)\n  }\n\n  public free(creature?: Creature): boolean {\n    return this.isFloor() && this.passibleThrough(creature)\n  }\n\n  public isFloor(): boolean {\n    return this.kind === TileTypes.Floor\n  }\n\n  public visibleThrough(): boolean {\n    return true\n  }\n\n  public passibleThrough(actor?: Creature): boolean {\n    if (actor && this.creature) {\n      return this.kind !== TileTypes.Wall && this.creature.id === actor.id\n    }\n\n    return this.kind !== TileTypes.Wall && !this.creature\n  }\n\n  public abstract visit(tileVisitor: TileVisitor): void\n\n  public clone(from: Tile = this): Tile {\n    let tile = this.buildNew() // TODO: Rethink & make clear\n\n    if (from.creature) {\n      tile.creature = from.creature\n    }\n    tile.items = from.items && from.items.clone()\n    return tile\n  }\n\n  protected abstract buildNew(): Tile\n}\n\nexport class Floor extends Tile {\n  public visibleThrough(): boolean {\n    return true\n  }\n\n  public visit(tileVisitor: TileVisitor): void {\n    tileVisitor.onFloor(this)\n  }\n\n  protected buildNew(): Tile {\n    return new Floor(this.key, this.kind)\n  }\n}\n\nexport class Corridor extends Floor {}\n\nexport class Room extends Floor {\n  constructor() {\n    super('R', TileTypes.Floor)\n  }\n}\n\nexport class Door extends Tile {\n  constructor() {\n    super('D', TileTypes.Door)\n  }\n\n  public visibleThrough(): boolean {\n    return false\n  }\n\n  public visit(tileVisitor: TileVisitor): void {\n    tileVisitor.onDoor(this)\n  }\n\n  protected buildNew(): Tile {\n    return new Door()\n  }\n}\n\nexport class Wall extends Tile {\n  constructor() {\n    super('W', TileTypes.Wall)\n  }\n\n  public visibleThrough(): boolean {\n    return false\n  }\n\n  public visit(tileVisitor: TileVisitor): void {\n    tileVisitor.onWall(this)\n  }\n\n  protected buildNew(): Tile {\n    return new Wall()\n  }\n}\n\nexport abstract class Stairway extends Tile {\n  private _enterPos: Point | undefined\n\n  constructor(\n    key: string,\n    type: TileTypes,\n    public currentMap: LevelMap,\n    public adjacentMapName: string\n  ) {\n    super(key, type)\n  }\n\n  public enterPos(levelMap: LevelMap, adjacentMap: LevelMap): Point {\n    if (this._enterPos) {\n      return this._enterPos\n    }\n\n    return (this._enterPos = adjacentMap.matchStairs(levelMap.name))\n  }\n\n  public visibleThrough(): boolean {\n    return true\n  }\n}\n\nexport class StairwayDown extends Stairway {\n  constructor(currentMap: LevelMap, adjacentMapName: string) {\n    super('>', TileTypes.StairwayDown, currentMap, adjacentMapName)\n  }\n\n  public visit(tileVisitor: TileVisitor): void {\n    tileVisitor.onStairwayDown(this)\n  }\n\n  protected buildNew(): Tile {\n    return new StairwayDown(this.currentMap, this.adjacentMapName)\n  }\n}\n\nexport class StairwayUp extends Stairway {\n  constructor(currentMap: LevelMap, adjacentMapName: string) {\n    super('<', TileTypes.StairwayUp, currentMap, adjacentMapName)\n  }\n\n  public visit(tileVisitor: TileVisitor): void {\n    tileVisitor.onStairwayUp(this)\n  }\n\n  protected buildNew(): Tile {\n    return new StairwayUp(this.currentMap, this.adjacentMapName)\n  }\n}\n\nexport enum TrapType {\n  AirBlow,\n  BareWire,\n  FallingRock,\n  Hole,\n  Light,\n  Teleportation,\n  Water,\n}\n\nexport abstract class Trap extends Tile {\n  constructor(\n    public readonly type: number,\n    public tile: Tile,\n    public revealed: boolean = false\n  ) {\n    super('^', TileTypes.Trap)\n  }\n\n  public visit(tileVisitor: TileVisitor): void {\n    tileVisitor.onTrap(this)\n  }\n\n  abstract get dodgeRatio(): number\n\n  public abstract activate(\n    pos: Point,\n    game: Game,\n    levelMap: LevelMap,\n    creature: Creature\n  ): Reaction\n\n  protected disarmTile(\n    { x, y }: Point,\n    player: Player,\n    levelMap: LevelMap,\n    game: Game\n  ): void {\n    game.logger.succeededToUntrap(player)\n    levelMap.setTile(x, y, this.tile.clone(this))\n  }\n\n  public abstract untrap(\n    pos: Point,\n    player: Player,\n    levelMap: LevelMap,\n    game: Game\n  ): void\n}\n\nexport abstract class TriggerTile extends Tile {\n  constructor(public singleUse: boolean = true, public tile: Tile) {\n    super('T', TileTypes.Trigger)\n  }\n\n  public visit(tileVisitor: TileVisitor): void {\n    tileVisitor.onTrigger(this)\n  }\n\n  public activate(game: Game, levelMap: LevelMap, actor: Creature): void {\n    if (this.singleUse) {\n      const { x, y } = levelMap.creaturePos(actor)\n      const tile = this.clone()\n      tile.creature = actor\n      levelMap.setTile(x, y, tile)\n    }\n\n    this.onTrigger(game, levelMap, actor)\n  }\n\n  public buildNew(): Tile {\n    return this.tile.clone()\n  }\n\n  protected abstract onTrigger(\n    game: Game,\n    levelMap: LevelMap,\n    actor: Creature\n  ): void\n}\n\nexport class LogMessageTrigger extends TriggerTile {\n  constructor(private message: string, singleUse: boolean = true, tile: Tile) {\n    super(singleUse, tile)\n  }\n\n  protected onTrigger(game: Game): void {\n    game.logger.info(this.message)\n  }\n}\n\n// TODO: Add return type?\nexport abstract class TileVisitor {\n  public onWall(wall: Wall): void {\n    this.default(wall)\n  }\n\n  public onFloor(floor: Floor): void {\n    this.default(floor)\n  }\n\n  public onStairwayDown(stairway: StairwayDown): void {\n    this.onStairway(stairway)\n  }\n\n  public onStairwayUp(stairway: StairwayUp): void {\n    this.onStairway(stairway)\n  }\n\n  public onDoor(door: Door): void {\n    this.default(door)\n  }\n\n  public onTrigger(trigger: TriggerTile): void {\n    this.default(trigger)\n  }\n\n  public onTrap(trap: Trap): void {\n    this.default(trap)\n  }\n\n  protected onStairway(stairway: Stairway): void {\n    this.default(stairway)\n  }\n\n  protected default(tile: Tile): void {}\n}\n","import { Fov } from '../utils/fov'\nimport { TileVisitor, Door, Tile } from '../models/tile'\nimport { LevelMap } from '../models/level_map'\nimport { Point } from '../utils/utils'\nimport { Memory } from '../models/memory'\n\nclass VisibilityTileVisitor extends TileVisitor {\n  public visible: boolean = false\n  private x: number | undefined\n  private y: number | undefined\n\n  constructor(private stage: LevelMap, private pos: Point) {\n    super()\n  }\n\n  public isSolid(x: number, y: number): boolean {\n    this.x = x\n    this.y = y\n    this.stage.at(x, y).visit(this)\n    return !this.visible\n  }\n\n  public onDoor(door: Door) {\n    this.visible = this.pos.x === this.x && this.pos.y === this.y\n  }\n\n  protected default(tile: Tile) {\n    if (this.x && this.y) {\n      this.visible = this.stage.visibleThrough(this.x, this.y)\n    }\n  }\n}\n\nexport const buildFov = function(\n  pos: Point,\n  radius: number,\n  memory: Memory,\n  levelMap: LevelMap\n): void {\n  const see = (x: number, y: number, degree: number): void => {\n    memory.at(x, y).see(levelMap.at(x, y), degree)\n  }\n\n  new Fov(\n    pos.x,\n    pos.y,\n    radius,\n    levelMap.width,\n    levelMap.height,\n    new VisibilityTileVisitor(levelMap, pos),\n    see\n  ).calc()\n}\n","interface SolidChecker {\n  isSolid(x: number, y: number): boolean\n}\n\nexport class Fov {\n  private doubleRadius: number\n\n  constructor(\n    private startx: number,\n    private starty: number,\n    private radius: number,\n    private width: number,\n    private height: number,\n    private solidChecker: SolidChecker,\n    private markVisible: (x: number, y: number, degree: number) => void\n  ) {\n    this.doubleRadius = this.radius * this.radius\n  }\n\n  public calc(): void {\n    this.markVisible(this.startx, this.starty, 1)\n\n    if (!this.solidChecker.isSolid(this.startx, this.starty)) {\n      ;[[1, 1], [1, -1], [-1, 1], [-1, -1]].forEach(([dx, dy]) => {\n        this.castLight(1, 1.0, 0.0, 0, dx, dy, 0)\n        this.castLight(1, 1.0, 0.0, dx, 0, 0, dy)\n      })\n    }\n  }\n\n  private castLight(\n    row: number,\n    start: number,\n    end: number,\n    xx: number,\n    xy: number,\n    yx: number,\n    yy: number\n  ) {\n    if (start < end) {\n      return\n    }\n\n    let newStart = 0.0\n    let blocked = false\n\n    for (let distance = row; distance <= this.radius && !blocked; distance++) {\n      let deltaY = -distance\n\n      for (let deltaX: number = -distance; deltaX <= 0; deltaX++) {\n        let currentX = Math.round(this.startx + deltaX * xx + deltaY * xy)\n        let currentY = Math.round(this.starty + deltaX * yx + deltaY * yy)\n        let leftSlope = (deltaX - 0.5) / (deltaY + 0.5)\n        let rightSlope = (deltaX + 0.5) / (deltaY - 0.5)\n\n        if (\n          !(\n            currentX >= 0 &&\n            currentY >= 0 &&\n            currentX < this.width &&\n            currentY < this.height\n          ) ||\n          start < rightSlope\n        ) {\n          continue\n        } else if (end > leftSlope) {\n          break\n        }\n\n        // check if it's within the lightable area and light if needed\n        if (this.doubleDistance(deltaX, deltaY) <= this.doubleRadius) {\n          this.markVisible(\n            currentX,\n            currentY,\n            1 - this.doubleDistance(deltaX, deltaY) / this.doubleRadius\n          )\n        }\n\n        if (blocked) {\n          // previous cell was a blocking one\n          if (this.solidChecker.isSolid(currentX, currentY)) {\n            // hit a wall\n            newStart = rightSlope\n          } else {\n            blocked = false\n            start = newStart\n          }\n        } else {\n          if (\n            this.solidChecker.isSolid(currentX, currentY) &&\n            distance < this.radius\n          ) {\n            // hit a wall within sight line\n            blocked = true\n            this.castLight(distance + 1, start, leftSlope, xx, xy, yx, yy)\n            newStart = rightSlope\n          }\n        }\n      }\n    }\n  }\n\n  private doubleDistance(x: number, y: number): number {\n    return x * x + y * y\n  }\n}\n","import { remove, sum } from 'lodash'\n\nexport class Attribute {\n  public modifiers: number[] = []\n\n  constructor(protected max: number, public current: number = max) {}\n\n  get maximum(): number {\n    return this.max\n  }\n\n  get atMax(): boolean {\n    return this.max === this.current\n  }\n\n  public decrease(modifier: number) {\n    this.current -= modifier\n  }\n\n  public increase(modifier: number) {\n    this.current = Math.min(this.current + modifier, this.max)\n  }\n\n  public constantIncrease(modifier: number) {\n    this.max += modifier\n    this.increase(modifier)\n  }\n\n  public constantDecrease(modifier: number) {\n    this.max -= modifier\n    this.decrease(modifier)\n  }\n\n  public addModifier(modifier: number) {\n    this.modifiers.push(modifier)\n  }\n\n  public removeModifier(modifier: number) {\n    remove(this.modifiers, val => val === modifier)\n  }\n\n  get currentValue(): number {\n    return this.current + sum(this.modifiers)\n  }\n}\n\nexport class PositiveAttribute extends Attribute {\n  get currentValue(): number {\n    const value = super.currentValue\n    return value >= 1 ? value : 1\n  }\n\n  public constantDecrease(modifier: number) {\n    this.max = Math.max(1, this.max - modifier)\n    this.decrease(modifier)\n  }\n\n  public decrease(modifier: number) {\n    this.current = Math.max(1, this.current - modifier)\n  }\n}\n","import { Specie } from '../models/specie'\nimport { Attribute } from './attribute'\n\nexport class Stat {\n  constructor(\n    public base: number,\n    public rate: number = 1,\n    public extra: number = 0\n  ) {}\n\n  get current(): number {\n    return this.base * this.rate - this.extra\n  }\n\n  public add(val: number): void {\n    this.base += val\n  }\n\n  public subtract(val: number): void {\n    this.base -= val\n  }\n}\n\nexport class CapacityLimitStat {\n  private strengthRatio: number = 5\n  private constitutionRatio: number = 3\n  private base: number = 10\n\n  constructor(private strength: number, private constitution: number) {}\n\n  public recalculate(strength: number, constitution: number) {\n    this.strength = strength\n    this.constitution = constitution\n  }\n\n  get stressed(): number {\n    return (\n      this.base +\n      this.strength * this.strengthRatio +\n      this.constitution * this.constitutionRatio\n    )\n  }\n\n  get loadedStart(): number {\n    return this.stressed * 1.5\n  }\n\n  get overloadedStart(): number {\n    return this.loadedStart * 2\n  }\n\n  get flattenedStart(): number {\n    return this.overloadedStart * 3\n  }\n}\n\nexport class HealthStat extends Attribute {\n  private regenerationRate: number\n  private regenerationValue: number\n\n  constructor(\n    specie: Specie,\n    private currentTurn = 0,\n    currentValue = specie.maxHealthValue\n  ) {\n    super(specie.maxHealthValue, currentValue)\n\n    this.regenerationRate = specie.regenerationRate\n    this.regenerationValue = specie.regenerationValue\n  }\n\n  public turn(): void {\n    this.currentTurn += 1\n\n    if (this.currentTurn >= this.regenerationRate) {\n      this.currentTurn = 0\n      this.increase(this.regenerationValue)\n    }\n  }\n}\n\nexport class StrengthStat extends Stat {\n  get meleeAdjustment(): number {\n    if (this.current < 5) {\n      return -2\n    } else if (this.current > 10) {\n      return Math.floor((this.current - 10) / 2)\n    } else {\n      return 0\n    }\n  }\n}\n\nexport class ConstitutionStat extends Stat {\n  get levelUpHPBonus(): number {\n    if (this.current < 3) {\n      return -2\n    } else if (this.current < 6) {\n      return -1\n    } else if (this.current < 12) {\n      return 0\n    } else if (this.current < 15) {\n      return 1\n    } else if (this.current < 18) {\n      return 2\n    } else if (this.current < 20) {\n      return 3\n    } else {\n      return 4\n    }\n  }\n}\n\nexport class DexterityStat extends Stat {\n  get bodyControlAdjustment(): number {\n    if (this.current < 5) {\n      return -2\n    } else if (this.current > 10) {\n      return Math.floor((this.current - 10) * 0.9)\n    } else {\n      return 0\n    }\n  }\n\n  get missileAdjustment(): number {\n    if (this.current < 5) {\n      return -2\n    } else if (this.current > 10) {\n      return Math.floor((this.current - 10) / 2)\n    } else {\n      return 0\n    }\n  }\n}\n","import { includes } from 'lodash'\nimport { Game, GroupedItem, ImpactBunch, LevelMap, Memory } from '../../engine'\nimport { MetaAI } from '../ai/meta_ai'\nimport { AfterEvent } from '../events/after_event'\nimport { CreatureEvent } from '../events/internal'\nimport { ItemsBunch } from '../lib/bunch'\nimport { ImpactType } from '../lib/impact'\nimport { buildFov } from '../lib/map_fov'\nimport { HealthStat } from '../lib/stat'\nimport { Item, Missile, Protection } from './item'\nimport { Damage } from '../lib/damage'\nimport { Specie, Resistance } from './specie'\n\nexport enum Clan {\n  Player,\n  PlayerOnlyEnemy,\n  FreeForAll,\n}\n\nexport enum Ability {\n  GoStairwayDown,\n  Inventory,\n  PutOn,\n  Throwing,\n}\n\nexport const allAbilities = [\n  Ability.GoStairwayDown,\n  Ability.Inventory,\n  Ability.PutOn,\n  Ability.Throwing,\n]\n\nexport type CreatureId = number\n\nexport enum Reaction {\n  DIE,\n  HURT,\n  DODGE,\n  THROW_DODGE,\n  NOTHING,\n  RESIST,\n}\n\nexport abstract class Creature {\n  private static lastId: CreatureId = 0\n  public static getId(): CreatureId {\n    return this.lastId++\n  }\n\n  protected stageMemories: Map<string, Memory> = new Map()\n\n  public dead: boolean = false\n\n  public health: HealthStat\n\n  constructor(public specie: Specie, public id: CreatureId = Creature.getId()) {\n    this.health = new HealthStat(specie)\n  }\n\n  get name(): string {\n    return this.specie.name\n  }\n\n  get clan(): Clan {\n    return this.specie.clan\n  }\n\n  get protections(): Protection[] {\n    return this.specie.protections\n  }\n\n  get throwDamages(): Damage[] {\n    return this.specie.throwingDamages\n  }\n\n  get damages(): Damage[] {\n    return this.specie.damages\n  }\n\n  public can(ability: Ability) {\n    return includes(this.specie.abilities, ability)\n  }\n\n  public on(event: CreatureEvent): Reaction {\n    return event.affectCreature(this)\n  }\n\n  get speed(): number {\n    return this.specie.moveSpeed\n  }\n\n  public stageMemory(levelMap: LevelMap): Memory {\n    const memory = this.stageMemories.get(levelMap.name)\n\n    if (memory) {\n      return memory\n    }\n\n    return this.visionMask(levelMap)\n  }\n\n  public visionMask(levelMap: LevelMap): Memory {\n    let memory = this.stageMemories.get(levelMap.name)\n\n    if (memory) {\n      memory.resetVisible()\n    } else {\n      memory = new Memory(levelMap.width, levelMap.height)\n\n      this.stageMemories.set(levelMap.name, memory)\n    }\n\n    buildFov(levelMap.creaturePos(this), this.visionRadius, memory, levelMap)\n\n    return memory\n  }\n\n  public abstract act(levelMap: LevelMap, game: Game): number\n\n  private _impactsBunch: ImpactBunch | undefined\n\n  get impactsBunch(): ImpactBunch {\n    if (!this._impactsBunch) {\n      this._impactsBunch = new ImpactBunch()\n    }\n\n    return this._impactsBunch\n  }\n\n  public hasImpact(type: ImpactType): boolean {\n    return includes(this.impacts, type)\n  }\n\n  public addImpact(type: ImpactType, effect: string): void {\n    this.impactsBunch.addConstImpact(type, effect)\n  }\n\n  public removeImpact(type: ImpactType, effect: string): void {\n    this.impactsBunch.removeConstImpact(type, effect)\n  }\n\n  get visionRadius(): number {\n    if (this.hasImpact(ImpactType.Blind)) {\n      return 0\n    }\n\n    return this.specie.visionRadius\n  }\n\n  get bodyControl(): number {\n    return this.specie.bodyControl\n  }\n\n  get impacts(): ImpactType[] {\n    return this.impactsBunch.activeImpacts\n  }\n\n  public hasResistance(resistance: Resistance): boolean {\n    return includes(this.resistances, resistance)\n  }\n\n  get resistances(): Resistance[] {\n    return this.specie.resistances\n  }\n\n  get weightWithCarryings(): number {\n    return this.specie.weight\n  }\n\n  abstract get missile(): GroupedItem<Missile> | undefined\n  abstract get inventoryItems(): GroupedItem<Item>[]\n\n  public abstract addItem(item: Item, count: number): void\n  public abstract removeItem(item: Item, count: number): void\n\n  public statsTurn(): void {\n    this.health.turn()\n\n    if (this._impactsBunch) {\n      // TODO: When ran out - disappear\n      this._impactsBunch.turn()\n    }\n  }\n}\n\nexport class AICreature extends Creature {\n  private bag?: ItemsBunch<Item>\n\n  constructor(\n    public ai: MetaAI,\n    specie: Specie,\n    id: CreatureId = Creature.getId()\n  ) {\n    super(specie, id)\n  }\n\n  public act(levelMap: LevelMap, game: Game): number {\n    this.statsTurn()\n    this.visionMask(levelMap)\n\n    const command = this.ai.act(this, levelMap, game)\n    if (command) {\n      this.on(command)\n    }\n\n    this.on(new AfterEvent(levelMap, game))\n\n    return this.speed\n  }\n\n  get missile(): GroupedItem<Missile> | undefined {\n    // TODO: Remove perpetuum items?\n    if (this.specie.throwingItem) {\n      return { item: this.specie.throwingItem, count: 1 }\n    }\n  }\n\n  get inventoryItems(): GroupedItem<Item>[] {\n    return this.bag ? this.bag.bunch : []\n  }\n\n  public addItem(item: Item, count: number): void {\n    if (!this.bag) {\n      this.bag = new ItemsBunch()\n    }\n\n    this.bag.put(item, count)\n  }\n\n  public removeItem(item: Item, count: number): void {\n    if (!this.bag) {\n      throw `Creature ${this.name} tried to remove item ${\n        item.name\n      } but it does not present`\n    }\n\n    this.bag.remove(item, count)\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { LevelMap } from '../models/level_map'\nimport { TileVisitor, TriggerTile } from '../models/tile'\nimport { Creature, Game, Trap, Point, Reaction } from '../../engine'\nimport { Player } from '../models/player'\n\nclass SteppingTileVisitor extends TileVisitor {\n  public reaction: Reaction = Reaction.NOTHING\n\n  constructor(\n    private pos: Point,\n    private creature: Creature,\n    private levelMap: LevelMap,\n    private game: Game\n  ) {\n    super()\n  }\n\n  public onTrap(trap: Trap): void {\n    this.reaction = trap.activate(\n      this.pos,\n      this.game,\n      this.levelMap,\n      this.creature\n    )\n  }\n\n  public onTrigger(trigger: TriggerTile): void {\n    trigger.activate(this.game, this.levelMap, this.creature)\n  }\n}\n\nexport class MoveEvent extends CreatureEvent {\n  constructor(\n    private game: Game,\n    private levelMap: LevelMap,\n    private nextPoint: Point,\n    private nextLevel: LevelMap = levelMap\n  ) {\n    super()\n  }\n\n  public affectCreature(actor: Creature): Reaction {\n    const pos = this.levelMap.creaturePos(actor)\n\n    if (this.nextLevel.name !== this.levelMap.name) {\n      this.levelMap.removeCreature(actor)\n      this.nextLevel.addCreature(this.nextPoint, actor)\n    } else {\n      this.levelMap.at(pos.x, pos.y).creature = undefined\n      this.levelMap.at(this.nextPoint.x, this.nextPoint.y).creature = actor\n    }\n\n    const visitor = new SteppingTileVisitor(\n      this.nextPoint,\n      actor,\n      this.levelMap,\n      this.game\n    )\n    this.nextLevel.at(this.nextPoint.x, this.nextPoint.y).visit(visitor)\n\n    return visitor.reaction\n  }\n\n  public affectPlayer(player: Player): Reaction {\n    if (this.nextLevel && this.levelMap.name !== this.nextLevel.name) {\n      this.levelMap.reset()\n      this.nextLevel.enter()\n\n      this.affectCreature(player)\n\n      this.game.currentMap = this.nextLevel\n    } else {\n      this.affectCreature(player)\n    }\n\n    return Reaction.NOTHING\n  }\n}\n","import { Point, twoDimArray } from '../utils/utils'\nimport { Creature, Clan } from '../models/creature'\n\nimport { MemoryTile, Memory } from '../models/memory'\nimport { MoveEvent } from '../events/move_event'\nimport { Game } from '../models/game'\nimport { LevelMap, CreatureEvent, leePath } from '../../engine'\n\nexport abstract class AI {\n  public abstract act(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined\n\n  protected moveTo(\n    actor: Creature,\n    destination: Point,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    return this.move(actor, levelMap, game, point => destination.eq(point))\n  }\n\n  protected move(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game,\n    dest: (point: Point, tile: MemoryTile) => boolean\n  ): CreatureEvent | undefined {\n    const [point] = this.buildPath(actor, levelMap, dest)\n\n    if (point) {\n      return new MoveEvent(game, levelMap, point)\n    }\n  }\n\n  protected buildPath(\n    actor: Creature,\n    levelMap: LevelMap,\n    dest: (point: Point, tile: MemoryTile) => boolean\n  ): Point[] {\n    return leePath(\n      actor.stageMemory(levelMap),\n      levelMap.creaturePos(actor),\n      tile => tile.tangible(actor),\n      dest\n    )\n  }\n\n  protected withinView(\n    map: Memory,\n    pos: Point,\n    visit: (point: Point, tile: MemoryTile) => void\n  ): void {\n    let tileVisited: boolean[][] = twoDimArray(\n      map.width,\n      map.height,\n      () => false\n    )\n    let pointsToCheck: Point[] = [pos]\n\n    while (pointsToCheck.length) {\n      let wavePoints: Point[] = []\n\n      pointsToCheck.forEach((point: Point) => {\n        if (!map.inRange(point)) {\n          return\n        }\n\n        const tile = map.at(point.x, point.y)\n        if (!tile.visible || tileVisited[point.x][point.y]) {\n          return\n        }\n\n        tileVisited[point.x][point.y] = true\n\n        visit(point, tile)\n\n        point.wrappers().forEach(dist => wavePoints.push(dist))\n      })\n\n      pointsToCheck = wavePoints\n    }\n  }\n\n  public enemies(actor: Creature, enemy: Creature): boolean {\n    if (actor.id === enemy.id) {\n      return false\n    }\n\n    if (actor.clan === Clan.FreeForAll || enemy.clan === Clan.FreeForAll) {\n      return true\n    }\n\n    if (actor.clan === Clan.Player && enemy.clan === Clan.PlayerOnlyEnemy) {\n      return true\n    }\n\n    if (enemy.clan === Clan.Player && actor.clan === Clan.PlayerOnlyEnemy) {\n      return true\n    }\n\n    return false\n  }\n}\n\nexport abstract class FollowTargetAI extends AI {\n  public destination?: Point = undefined\n\n  public act(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    if (!this.foundNewTarget(actor, levelMap) || !this.destination) {\n      return this.checkCurrentTile(actor, levelMap, game)\n    }\n\n    const event = this.goTo(actor, levelMap, game, this.destination)\n    if (event) {\n      return event\n    }\n\n    this.destination = undefined\n    this.onCantMove(actor)\n\n    return\n  }\n\n  protected goTo(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game,\n    point: Point\n  ): CreatureEvent | undefined {\n    return this.moveTo(actor, point, levelMap, game)\n  }\n\n  protected checkCurrentTile(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    if (this.destination && levelMap.creaturePos(actor).eq(this.destination)) {\n      this.destination = undefined\n      return this.onReach(actor, levelMap, game)\n    }\n  }\n\n  protected abstract foundNewTarget(\n    actor: Creature,\n    levelMap: LevelMap\n  ): boolean\n  protected onMove(actor: Creature): void {}\n  protected onReach(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    return\n  }\n  protected onCantMove(actor: Creature): void {}\n}\n\nexport abstract class GoToTileAI extends FollowTargetAI {\n  constructor(protected matcher: (tile: MemoryTile) => boolean) {\n    super()\n  }\n\n  protected checkCurrentTile(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    let event = super.checkCurrentTile(actor, levelMap, game)\n\n    if (event) {\n      return event\n    }\n\n    const pos = levelMap.creaturePos(actor)\n    if (this.matcher(actor.stageMemory(levelMap).at(pos.x, pos.y))) {\n      this.destination = undefined\n      return this.onReach(actor, levelMap, game)\n    }\n  }\n\n  protected foundNewTarget(actor: Creature, levelMap: LevelMap): boolean {\n    const path = leePath(\n      actor.stageMemory(levelMap),\n      levelMap.creaturePos(actor),\n      tile => tile.tangible(actor),\n      (point, tile) => this.matcher(tile),\n      true\n    )\n\n    if (path.length) {\n      this.destination = path.pop()\n      return true\n    } else {\n      return false\n    }\n  }\n}\n","import { AttackEvent, Game } from '../../engine'\nimport { Creature } from '../models/creature'\nimport { AI } from './internal'\nimport { LevelMap } from '../models/level_map'\nimport { CreatureEvent } from '../events/internal'\n\nexport class Attacker extends AI {\n  public victim?: Creature\n\n  public act(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game,\n    firstTurn: boolean = true\n  ): CreatureEvent | undefined {\n    if (!this.canAttack(actor, levelMap)) {\n      return\n    }\n\n    if (this.victim && this.victimInAccess(actor, levelMap, this.victim)) {\n      return new AttackEvent(this.victim, levelMap, game)\n    } else {\n      if (!firstTurn) {\n        throw 'Attacker got called twice'\n      }\n\n      this.pickNewVictim(actor, levelMap)\n      return this.act(actor, levelMap, game, false)\n    }\n  }\n\n  private canAttack(actor: Creature, levelMap: LevelMap): boolean {\n    const creature = this.findCreature(actor, levelMap, creature =>\n      this.enemies(actor, creature)\n    )\n    return !!creature\n  }\n\n  private victimInAccess(\n    actor: Creature,\n    levelMap: LevelMap,\n    victim: Creature | undefined\n  ): boolean {\n    if (victim === undefined) {\n      return false\n    }\n\n    const creature = this.findCreature(\n      actor,\n      levelMap,\n      (creature: Creature) => creature.id === victim.id\n    )\n    return !!creature\n  }\n\n  private pickNewVictim(actor: Creature, levelMap: LevelMap) {\n    this.victim = this.findCreature(actor, levelMap, creature =>\n      this.enemies(actor, creature)\n    )\n  }\n\n  private findCreature(\n    actor: Creature,\n    levelMap: LevelMap,\n    condition: (creature: Creature) => boolean\n  ): Creature | undefined {\n    const memory = actor.stageMemory(levelMap)\n\n    return levelMap\n      .creaturePos(actor)\n      .wrappers()\n      .map(({ x, y }) => memory.at(x, y).creature)\n      .find(\n        (creature: Creature | undefined) =>\n          creature ? condition(creature) : false\n      )\n  }\n}\n","import { Creature, CreatureId } from '../models/creature'\nimport { Game } from '../models/game'\nimport { Point } from '../utils/utils'\nimport { FollowTargetAI } from './internal'\nimport { CreatureEvent } from '../events/internal'\nimport { LevelMap } from '../models/level_map'\n\nexport class Chaser extends FollowTargetAI {\n  private victimId?: CreatureId\n\n  protected foundNewTarget(actor: Creature, levelMap: LevelMap): boolean {\n    // Is there a victim and a path to it?\n    return (\n      (this.victimSet() && this.buildVictimPath(actor, levelMap)) ||\n      this.foundNewVictim(actor, levelMap)\n    )\n  }\n\n  protected onCantMove(): void {\n    this.victimId = undefined\n  }\n\n  protected onReach(): CreatureEvent | undefined {\n    this.victimId = undefined\n    return\n  }\n\n  private victimSet(): boolean {\n    return !!this.victimId\n  }\n\n  protected goTo(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    if (!this.destination) {\n      throw 'Chaser.goTo: no destination'\n    }\n    return this.followTo(actor, this.destination, levelMap, game)\n  }\n\n  private buildVictimPath(actor: Creature, levelMap: LevelMap): boolean {\n    return this.findCreature(\n      actor,\n      levelMap,\n      creature => creature.id === this.victimId\n    )\n  }\n\n  private foundNewVictim(actor: Creature, levelMap: LevelMap): boolean {\n    // Found new victim and built path to it\n    return (\n      this.findCreature(actor, levelMap, creature =>\n        this.enemies(actor, creature)\n      ) && this.buildVictimPath(actor, levelMap)\n    )\n  }\n\n  private findCreature(\n    actor: Creature,\n    levelMap: LevelMap,\n    condition: (creature: Creature) => boolean\n  ): boolean {\n    let result: boolean = false\n\n    this.withinView(\n      actor.stageMemory(levelMap),\n      levelMap.creaturePos(actor),\n      ({ x, y }, tile) => {\n        const creature = tile.creature\n\n        if (!result && creature && condition(creature)) {\n          this.destination = new Point(x, y)\n          this.victimId = creature.id\n          result = true\n        }\n      }\n    )\n\n    return result\n  }\n\n  protected followTo(\n    actor: Creature,\n    destination: Point,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    return this.move(actor, levelMap, game, point => destination.nextTo(point))\n  }\n}\n","import { FollowTargetAI } from './internal'\nimport { Creature } from '../models/creature'\nimport { Point, LevelMap } from '../../engine'\n\nimport { sumBy } from 'lodash'\n\nconst STEP_DISTANCE = 2\n\nexport class Escaper extends FollowTargetAI {\n  private escapesFrom: [Point, Creature][] = []\n\n  protected foundNewTarget(actor: Creature, levelMap: LevelMap): boolean {\n    return (\n      this.foundEnemies(actor, levelMap) &&\n      this.buildEscapePath(actor, levelMap)\n    )\n  }\n\n  private buildEscapePath(\n    actor: Creature,\n    levelMap: LevelMap,\n    minDistance: number = actor.visionRadius / 2\n  ): boolean {\n    if (minDistance <= 1) {\n      this.destination = undefined\n      return false\n    }\n\n    const path = this.buildPath(actor, levelMap, ({ x, y }) => {\n      const score = sumBy(this.escapesFrom, ([pos, enemy]) => {\n        // I don't use pathfinding since it should try\n        // to run away from those who are visible, so the path\n        // to them should be straightforward.\n        return Math.max(Math.abs(x - pos.x), Math.abs(y - pos.y))\n      })\n\n      return score >= minDistance\n    })\n\n    if (path.length) {\n      this.destination = path.pop()\n      return true\n    } else {\n      return this.buildEscapePath(actor, levelMap, minDistance - STEP_DISTANCE)\n    }\n  }\n\n  private foundEnemies(actor: Creature, levelMap: LevelMap): boolean {\n    this.escapesFrom = []\n\n    this.withinView(\n      actor.stageMemory(levelMap),\n      levelMap.creaturePos(actor),\n      (point, tile) => {\n        const creature = tile.creature\n\n        if (creature && this.enemies(actor, creature)) {\n          this.escapesFrom.push([point, creature])\n        }\n      }\n    )\n\n    return this.escapesFrom.length > 0\n  }\n}\n","import { GoToTileAI } from './internal'\n\nexport class Explorer extends GoToTileAI {\n  constructor() {\n    super(tile => !tile.seen)\n  }\n}\n","import { AI } from './internal'\nimport { Creature } from '../models/creature'\nimport { Game } from '../models/game'\nimport { Point, LevelMap } from '../../engine'\nimport { CreatureEvent } from '../events/internal'\n\nexport class Loiter extends AI {\n  public act(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    const pos = levelMap.creaturePos(actor)\n\n    return this.move(actor, levelMap, game, (point: Point) => !pos.eq(point))\n  }\n}\n","import { AI } from './internal'\nimport { Player } from '../models/player'\nimport { Logger } from '../models/logger'\nimport { Game, ItemsBunch, Item } from '../../engine'\n\nexport abstract class AIEvent {\n  protected logger: Logger\n  protected player: Player\n\n  constructor(protected game: Game) {\n    this.player = game.player\n    this.logger = game.logger\n  }\n\n  public abstract run(): void\n}\n\nexport class AIItemPickedEvent extends AIEvent {\n  constructor(public items: ItemsBunch<Item>, game: Game) {\n    super(game)\n  }\n\n  public run(): void {}\n}\n\nexport abstract class MetaAI extends AI {\n  constructor(public aiToRun: AI | undefined = undefined) {\n    super()\n  }\n  protected events: AIEvent[] = []\n\n  public pushEvent(event: AIEvent) {\n    this.events.push(event)\n  }\n\n  protected resetEvents(): void {\n    this.events = []\n  }\n\n  public runEvents(): boolean {\n    let res = false\n    this.events.forEach(event => {\n      res = true\n      event.run()\n    })\n\n    this.resetEvents()\n    return res\n  }\n}\n","import { AI } from './internal'\n\nimport { Point } from '../utils/utils'\nimport { Creature } from '../models/creature'\n\nimport * as graphlib from 'graphlib'\nimport { Loiter } from './loiter'\nimport { TileVisitor, Tile } from '../models/tile'\nimport { MoveEvent } from '../events/move_event'\nimport { Game } from '../models/game'\nimport { CreatureEvent } from '../events/internal'\nimport { LevelMap } from '../models/level_map'\n\ntype NodeID = string\n\nconst NEW_POINT_EVERY: number = 10\n\nclass PatrolTileVisitor extends TileVisitor {\n  public status: boolean = false\n\n  constructor(private tile: Tile) {\n    super()\n  }\n\n  public addNode(): boolean {\n    this.status = false\n    this.tile.visit(this)\n    return this.status\n  }\n\n  public onDoor() {\n    this.status = true\n  }\n}\n\nexport class Patrol extends AI {\n  private i: NodeID\n  private graph: graphlib.Graph\n  private lastNodeVisit: { [key: string]: number }\n  private currentNodeID: NodeID\n  private targetNodeID: NodeID | undefined\n  private path: Point[]\n  private step: number = NEW_POINT_EVERY\n  private firstCallPatrol: boolean = true\n\n  constructor() {\n    super()\n    this.i = 'a'\n\n    this.graph = new graphlib.Graph()\n\n    this.lastNodeVisit = {}\n\n    this.currentNodeID = 'a' // TODO: Check it, was undefined\n    this.markNodeVisited(this.currentNodeID)\n    this.path = []\n  }\n\n  public act(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game,\n    firstTurn: boolean = true\n  ): CreatureEvent | undefined {\n    if (this.graph.nodes().length <= 1) {\n      return\n    }\n\n    if (this.firstCallPatrol) {\n      const pos = levelMap.creaturePos(actor)\n      this.addNode(pos)\n      this.firstCallPatrol = false\n    }\n\n    this.step += 1\n\n    if (this.path.length) {\n      return this.moveToTarget(actor, levelMap, game, firstTurn)\n    } else {\n      if (this.targetNodeID) {\n        this.markNodeVisited(this.targetNodeID)\n        this.currentNodeID = this.targetNodeID\n      }\n\n      this.pickUpNewTarget(actor, levelMap)\n      return this.moveToTarget(actor, levelMap, game, firstTurn)\n    }\n  }\n\n  public reset(): void {\n    this.path = []\n  }\n\n  public trackMovement(pos: Point, tile: Tile): void {\n    if (this.step >= NEW_POINT_EVERY || new PatrolTileVisitor(tile).addNode()) {\n      this.addNode(pos)\n    }\n    this.step += 1\n  }\n\n  // TODO: If close enough to another node, use it instead.\n  public addNode(point: Point): void {\n    this.graph.setNode(this.i, point)\n    if (this.currentNodeID && this.currentNodeID !== this.i) {\n      this.graph.setEdge(this.currentNodeID, this.i)\n    }\n    this.currentNodeID = this.i\n    this.newNodeId()\n    this.step = 0\n  }\n\n  private buildNewPath(actor: Creature, levelMap: LevelMap): void {\n    // TODO: Remove this\n    if (!this.targetNodeID) {\n      throw 'Patrol has no next targetID'\n    }\n    const pos: Point = this.graph.node(this.targetNodeID)\n\n    this.path = this.buildPath(actor, levelMap, point => pos.eq(point))\n  }\n\n  private pickUpNewTarget(actor: Creature, levelMap: LevelMap): void {\n    let seenLastID: NodeID = this.graph.nodes()[0],\n      seenLastStep: number = this.lastNodeVisit[seenLastID],\n      nodes = this.graph.neighbors(this.currentNodeID)\n\n    if (nodes) {\n      nodes.forEach((nodeID: NodeID) => {\n        if (seenLastStep > (this.lastNodeVisit[nodeID] || 0)) {\n          seenLastID = nodeID\n          seenLastStep = this.lastNodeVisit[seenLastID]\n        }\n      })\n    }\n\n    this.targetNodeID = seenLastID\n    this.buildNewPath(actor, levelMap)\n  }\n\n  private moveToTarget(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game,\n    firstTurn: boolean\n  ): CreatureEvent | undefined {\n    const nextPoint: Point | undefined = this.path.shift()\n\n    if (!nextPoint) {\n      if (firstTurn) {\n        this.path = []\n        return this.act(actor, levelMap, game, false)\n      } else {\n        return new Loiter().act(actor, levelMap, game)\n      }\n    } else if (\n      actor\n        .stageMemory(levelMap)\n        .at(nextPoint.x, nextPoint.y)\n        .tangible()\n    ) {\n      this.buildNewPath(actor, levelMap)\n\n      if (this.path.length) {\n        return this.act(actor, levelMap, game, false)\n      }\n    } else {\n      return new MoveEvent(game, levelMap, nextPoint)\n    }\n  }\n\n  private markNodeVisited(nodeID: NodeID): void {\n    this.lastNodeVisit[nodeID] = this.step\n  }\n\n  private newNodeId(): void {\n    this.i = String.fromCharCode(this.i.charCodeAt(0) + 1)\n  }\n}\n","import { Player } from '../models/player'\nimport { LevelMap } from '../models/level_map'\nimport { Tile } from '../models/tile'\nimport { Game, IdlePresenter } from '../../engine'\n\nexport enum PresenterType {\n  AbilitiesPicking,\n  Death,\n  Idle,\n  Inventory,\n  ItemsListing,\n  Missile,\n  ProfessionPicking,\n  Look,\n  Teleportation,\n  PickHandleOption,\n}\n\nexport abstract class Presenter {\n  public player: Player\n\n  constructor(\n    public readonly type: PresenterType,\n    protected levelMap: LevelMap,\n    protected game: Game\n  ) {\n    this.player = this.game.player\n  }\n\n  get tile(): Tile {\n    return this.levelMap.creatureTile(this.player)\n  }\n\n  protected endTurn(): void {\n    this.game.player.ai.endTurn(this.game, this.levelMap)\n  }\n\n  protected redirect(presenter: Presenter): void {\n    this.game.player.ai.redirect(presenter)\n  }\n\n  protected goIdle(): void {\n    this.redirect(new IdlePresenter(this.levelMap, this.game))\n  }\n}\n","import { Missile, Protection } from './item'\nimport { Damage } from '../lib/damage'\nimport { Clan, Ability } from './creature'\nimport { Material } from '../lib/material'\n\nexport enum Resistance {\n  Intangible,\n  MagicDamage,\n  TeleportationControl,\n  Insulator,\n}\n\nexport interface Specie {\n  name: string\n  weight: number\n  clan: Clan\n  abilities: Ability[]\n\n  protections: Protection[]\n  damages: Damage[]\n  bodyControl: number\n\n  throwingItem?: Missile\n  throwingDamages: Damage[]\n\n  maxHealthValue: number\n  regenerationRate: number\n  regenerationValue: number\n\n  resistances: Resistance[]\n\n  visionRadius: number\n  moveSpeed: number\n  attackSpeed: number\n\n  leavesCorpseRatio: number\n\n  material: Material\n}\n","export enum WaterAffect {\n  Corrosion,\n  Destroy,\n}\n\nexport interface Material {\n  readonly affectedWithWater?: WaterAffect\n  readonly firm: boolean\n  readonly fragile: boolean\n  readonly insulator: boolean\n}\n\nexport namespace Material {\n  export const cloth: Material = {\n    affectedWithWater: undefined,\n    firm: false,\n    fragile: false,\n    insulator: false,\n  }\n\n  export const flesh: Material = {\n    affectedWithWater: undefined,\n    firm: true,\n    fragile: false,\n    insulator: true,\n  }\n\n  export const glass: Material = {\n    affectedWithWater: undefined,\n    firm: false,\n    fragile: true,\n    insulator: false,\n  }\n\n  export const iron: Material = {\n    affectedWithWater: WaterAffect.Corrosion,\n    firm: true,\n    fragile: false,\n    insulator: true,\n  }\n\n  export const leather: Material = {\n    affectedWithWater: undefined,\n    firm: false,\n    fragile: false,\n    insulator: false,\n  }\n\n  export const paper: Material = {\n    affectedWithWater: WaterAffect.Destroy,\n    firm: false,\n    fragile: false,\n    insulator: true,\n  }\n\n  export const stone: Material = {\n    affectedWithWater: undefined,\n    firm: true,\n    fragile: false,\n    insulator: true,\n  }\n\n  export const wood: Material = {\n    affectedWithWater: undefined,\n    firm: true,\n    fragile: false,\n    insulator: true,\n  }\n}\n","import { Player } from './player'\nimport { Specie } from './specie'\n\nimport { Game } from './game'\nimport { Damage } from '../lib/damage'\nimport { ImpactType } from '../lib/impact'\nimport { Material, WaterAffect } from '../lib/material'\n\nexport enum Usage {\n  WeaponOneHand,\n  WearsOnHead,\n  WearsOnBody,\n  Ring,\n  Amulet,\n  Throw,\n  Shoot,\n  Boots,\n  Tool,\n  Belt,\n  Gloves,\n  Gauntlets,\n  Cloak,\n  Scroll,\n}\n\nexport enum ItemGroup {\n  BodyArmor,\n  OneHandWeapon,\n  Consumable,\n  Missile,\n  Potion,\n  MissileWeapon,\n  Boots,\n  Scrolls,\n  Hat,\n}\n\nexport enum ItemSubgroup {\n  MissileRock,\n  Sling,\n\n  Bow,\n  Arrows,\n}\n\nexport type ItemId = number\n\nexport enum CorrosionLevel {\n  None,\n  Slightly,\n  Mostly,\n  Fully,\n}\n\nexport class Item {\n  private static lastId: ItemId = 0\n  public static getId(): ItemId {\n    return this.lastId++\n  }\n\n  public impacts: ImpactType[] = []\n  public corrosionLevel: CorrosionLevel = CorrosionLevel.None\n\n  constructor(\n    public group: ItemGroup,\n    public name: string,\n    public weight: number,\n    public material: Material,\n    public readonly usages: Usage[] = [],\n    public id: ItemId = Item.getId()\n  ) {}\n\n  // TODO: Recalculate stats on corrosion\n  public corrode(): boolean {\n    switch (this.corrosionLevel) {\n      case CorrosionLevel.None:\n        this.corrosionLevel = CorrosionLevel.Slightly\n        return true\n      case CorrosionLevel.Slightly:\n        this.corrosionLevel = CorrosionLevel.Mostly\n        return true\n      case CorrosionLevel.Mostly:\n        this.corrosionLevel = CorrosionLevel.Fully\n        return true\n    }\n\n    return false\n  }\n\n  get affectedWithWater(): boolean {\n    return this.material.affectedWithWater !== undefined\n  }\n\n  get firm(): boolean {\n    return this.material.firm\n  }\n\n  get insulator(): boolean {\n    return this.material.insulator\n  }\n\n  get canSeeDetails(): boolean {\n    return true\n  }\n\n  public clone(): Item {\n    return new Item(this.group, this.name, this.weight, this.material)\n  }\n\n  public groupsWith(item: Item): boolean {\n    return this.name === item.name\n  }\n\n  public worksWith(item: Item): boolean {\n    return false\n  }\n\n  public canThrow(player: Player): boolean {\n    return true\n  }\n}\n\nexport class Corpse extends Item {\n  constructor(public readonly specie: Specie) {\n    super(\n      ItemGroup.Consumable,\n      `${specie.name}'s corpse`,\n      specie.weight,\n      specie.material\n    )\n  }\n}\n\nexport abstract class Potion extends Item {\n  constructor(public name: string, material: Material = Material.glass) {\n    super(ItemGroup.Potion, name, 0.2, material)\n  }\n\n  abstract onDrink(game: Game): void\n}\n\nexport abstract class Weapon extends Item {\n  constructor(\n    group: ItemGroup,\n    name: string,\n    weight: number,\n    material: Material,\n    protected rawDamages: Damage[],\n    usages: Usage[]\n  ) {\n    super(group, name, weight, material, usages)\n  }\n\n  get damages(): Damage[] {\n    switch (this.corrosionLevel) {\n      case CorrosionLevel.Slightly:\n        return this.damageWithCorrosion(1)\n      case CorrosionLevel.Mostly:\n        return this.damageWithCorrosion(2)\n      case CorrosionLevel.Fully:\n        return this.damageWithCorrosion(4)\n      default:\n        return this.rawDamages\n    }\n  }\n\n  protected damageWithCorrosion(penalty: number): Damage[] {\n    return this.rawDamages.map(({ dice, type, extra }: Damage) => {\n      return { dice, type, extra: extra - penalty }\n    })\n  }\n}\n\nexport abstract class Missile extends Weapon {\n  constructor(\n    name: string,\n    weight: number,\n    damages: Damage[],\n    material: Material\n  ) {\n    super(ItemGroup.Missile, name, weight, material, damages, [])\n  }\n}\n\nexport abstract class MissileWeapon extends Weapon {\n  constructor(\n    name: string,\n    weight: number,\n    damages: Damage[],\n    material: Material\n  ) {\n    super(ItemGroup.MissileWeapon, name, weight, material, damages, [\n      Usage.Shoot,\n    ])\n  }\n}\n\nexport class OneHandWeapon extends Weapon {\n  constructor(\n    name: string,\n    weight: number,\n    material: Material,\n    damages: Damage[]\n  ) {\n    super(ItemGroup.OneHandWeapon, name, weight, material, damages, [\n      Usage.WeaponOneHand,\n    ])\n  }\n}\n\nexport enum ProtectionType {\n  Light,\n  Medium,\n  Heavy,\n  Solid,\n  Unarmored,\n}\n\nexport type Protection = {\n  type: ProtectionType\n  value: number\n}\n\nexport abstract class Armor extends Item {\n  constructor(\n    group: ItemGroup,\n    name: string,\n    weight: number,\n    material: Material,\n    protected readonly rawProtections: Protection[],\n    usage: Usage\n  ) {\n    super(group, name, weight, material, [usage])\n  }\n\n  get protections(): Protection[] {\n    switch (this.corrosionLevel) {\n      case CorrosionLevel.Slightly:\n        return this.protectionWithCorrosion(1)\n      case CorrosionLevel.Mostly:\n        return this.protectionWithCorrosion(2)\n      case CorrosionLevel.Fully:\n        return this.protectionWithCorrosion(4)\n      default:\n        return this.rawProtections\n    }\n  }\n\n  protected protectionWithCorrosion(penalty: number): Protection[] {\n    return this.rawProtections.map(({ type, value }: Protection) => {\n      return { type, value: value - penalty }\n    })\n  }\n}\n\nexport class BodyArmor extends Armor {\n  constructor(\n    name: string,\n    weight: number,\n    material: Material,\n    protections: Protection[]\n  ) {\n    super(\n      ItemGroup.BodyArmor,\n      name,\n      weight,\n      material,\n      protections,\n      Usage.WearsOnBody\n    )\n  }\n}\n\nexport class Boots extends Armor {\n  constructor(\n    name: string,\n    weight: number,\n    material: Material,\n    protections: Protection[]\n  ) {\n    super(ItemGroup.Boots, name, weight, material, protections, Usage.Boots)\n  }\n}\n\nexport class Hat extends Armor {\n  constructor(\n    name: string,\n    weight: number,\n    material: Material,\n    protections: Protection[]\n  ) {\n    super(ItemGroup.Hat, name, weight, material, protections, Usage.WearsOnHead)\n  }\n}\n\nexport class Scroll extends Item {\n  constructor(name: string) {\n    super(ItemGroup.Scrolls, name, 0.1, Material.paper, [Usage.Scroll])\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { Creature, Reaction } from '../models/creature'\nimport { Player } from '../models/player'\nimport { Corpse } from '../models/item'\nimport { LevelMap } from '../models/level_map'\nimport { Game } from '../models/game'\nimport { DeathPresenter } from '../presenters/death_presenter'\nimport { AIDieEvent } from '../ai/player_ai'\n\nexport enum DieReason {\n  Attack,\n  Missile,\n  Trap,\n  Overloaded,\n}\n\nexport class DieEvent extends CreatureEvent {\n  constructor(\n    private game: Game,\n    private levelMap: LevelMap,\n    private reason: DieReason\n  ) {\n    super()\n  }\n\n  public affectCreature(creature: Creature): Reaction {\n    let tile = this.levelMap.creatureTile(creature)\n\n    this.levelMap.removeCreature(creature)\n    creature.dead = true\n\n    if (creature.specie.leavesCorpseRatio > Math.random()) {\n      tile.addItem(new Corpse(creature.specie), 1)\n    }\n\n    creature.inventoryItems.forEach(invItem =>\n      tile.addItem(invItem.item, invItem.count)\n    )\n\n    return Reaction.DIE\n  }\n\n  public affectPlayer(player: Player): Reaction {\n    player.ai.pushEvent(new AIDieEvent(this.reason, this.levelMap, this.game))\n    player.dead = true\n    this.game.playerTurn = true\n\n    return Reaction.DIE\n  }\n}\n","import { DieReason } from '../events/die_event'\nimport { Game } from '../models/game'\nimport { Presenter, PresenterType } from './internal'\nimport { LevelMap } from '../models/level_map'\n\nexport class DeathPresenter extends Presenter {\n  constructor(public dieReason: DieReason, levelMap: LevelMap, game: Game) {\n    super(PresenterType.Death, levelMap, game)\n  }\n\n  get playerName(): string {\n    return this.game.player.name\n  }\n}\n","import {\n  AfterEvent,\n  Game,\n  IdlePresenter,\n  LevelMap,\n  ProfessionPickingPresenter,\n  TalentsTreePresenter,\n  TeleportationPresenter,\n} from '../../engine'\nimport { DieReason } from '../events/die_event'\nimport { CreatureEvent } from '../events/internal'\nimport { Player } from '../models/player'\nimport { DeathPresenter } from '../presenters/death_presenter'\nimport { Presenter } from '../presenters/internal'\nimport { AIEvent, MetaAI } from './meta_ai'\n\nexport class AINewLevelEvent extends AIEvent {\n  constructor(public level: number, private levelMap: LevelMap, game: Game) {\n    super(game)\n  }\n\n  public run(): void {\n    if (this.level % 3 === 0) {\n      this.game.player.ai.presenter = new ProfessionPickingPresenter(\n        this.level,\n        this.levelMap,\n        this.game\n      )\n    } else {\n      this.game.player.ai.presenter = new TalentsTreePresenter(\n        this.level,\n        this.levelMap,\n        this.game\n      )\n    }\n  }\n}\n\nexport class AIDieEvent extends AIEvent {\n  constructor(\n    private dieReason: DieReason,\n    private levelMap: LevelMap,\n    game: Game\n  ) {\n    super(game)\n  }\n\n  public run(): void {\n    this.game.player.rebuildVision(this.levelMap)\n    this.game.playerTurn = true\n    this.game.player.ai.presenter = new DeathPresenter(\n      this.dieReason,\n      this.levelMap,\n      this.game\n    )\n  }\n}\n\nexport class AITeleportationEvent extends AIEvent {\n  constructor(private levelMap: LevelMap, game: Game) {\n    super(game)\n  }\n\n  public run(): void {\n    // TODO: Rethink whether should be here\n    this.game.player.rebuildVision(this.levelMap)\n    this.game.playerTurn = true\n    this.game.player.ai.presenter = new TeleportationPresenter(\n      this.levelMap,\n      this.game\n    )\n  }\n}\n\nexport class PlayerAI extends MetaAI {\n  public presenter: Presenter | null = null\n  public levelUps: number = 0\n\n  public act(\n    player: Player,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    this.presenter = new IdlePresenter(levelMap, game)\n    game.playerTurn = true\n\n    return\n  }\n\n  public endTurn(game: Game, levelMap: LevelMap): void {\n    let event = this.events.pop()\n    if (event) {\n      event.run()\n    } else if (game && levelMap) {\n      game.player.on(new AfterEvent(levelMap, game))\n\n      let event = this.events.pop()\n      if (event) {\n        event.run()\n      } else {\n        game.player.ai.runEvents()\n        game.playerTurn = false\n        this.presenter = null\n      }\n    }\n  }\n\n  public redirect(presenter: Presenter): void {\n    this.presenter = presenter\n  }\n}\n\nexport class PlayerBorgAI extends PlayerAI {\n  constructor(private ai: MetaAI) {\n    super()\n  }\n\n  public act(\n    player: Player,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    let event = this.ai.act(player, levelMap, game)\n\n    game.playerTurn = true\n\n    return event\n  }\n}\n","import { PickUpItemsEvent, LevelMap } from '../../engine'\nimport { Ability, Creature, AICreature } from '../models/creature'\nimport { Game } from '../models/game'\nimport { GoToTileAI } from './internal'\nimport { AIItemPickedEvent } from './meta_ai'\nimport { CreatureEvent } from '../events/internal'\nimport { MemoryTile } from '../models/memory'\n\nexport class Picker extends GoToTileAI {\n  constructor() {\n    super((tile: MemoryTile) => !!tile.items)\n  }\n\n  public act(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    if (actor.can(Ability.Inventory)) {\n      return super.act(actor, levelMap, game)\n    }\n  }\n\n  protected onReach(\n    actor: AICreature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    const tile = levelMap.creatureTile(actor)\n\n    if (!tile.items) {\n      throw 'Picker.act : nothing to pick up'\n    }\n\n    actor.ai.pushEvent(new AIItemPickedEvent(tile.items, game))\n\n    return new PickUpItemsEvent(tile, tile.items.bunch, game)\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { Reaction, Creature } from '../models/creature'\nimport { LevelMap } from '../models/level_map'\n\nexport class StayEvent extends CreatureEvent {\n  constructor(private levelMap: LevelMap) {\n    super()\n  }\n\n  public affectCreature(creature: Creature): Reaction {\n    let memory = creature.stageMemory(this.levelMap)\n\n    this.levelMap\n      .creaturePos(creature)\n      .wrappers()\n      .forEach(({ x, y }) => {\n        memory.at(x, y).see(this.levelMap.at(x, y), 0)\n      })\n\n    return Reaction.NOTHING\n  }\n}\n","import { Creature } from '../models/creature'\nimport { AI } from './internal'\nimport { StayEvent } from '../events/stay_event'\nimport { CreatureEvent } from '../events/internal'\nimport { LevelMap } from '../models/level_map'\n\nexport class SelfHealer extends AI {\n  public act(actor: Creature, levelMap: LevelMap): CreatureEvent | undefined {\n    if (actor.health.atMax) {\n      return\n    }\n\n    return new StayEvent(levelMap)\n  }\n}\n","import {\n  Ability,\n  Creature,\n  Game,\n  StairwayDown,\n  MoveEvent,\n  LevelMap,\n} from '../../engine'\nimport { CreatureEvent } from '../events/internal'\nimport { TileVisitor } from '../models/tile'\nimport { GoToTileAI } from './internal'\n\nclass StairwayDownFinderVisitor extends TileVisitor {\n  public match = false\n\n  public onStairwayDown(): void {\n    this.match = true\n  }\n}\n\nclass StairwayDownTileMoverVisitor extends TileVisitor {\n  public event: CreatureEvent | undefined\n\n  constructor(private game: Game, private levelMap: LevelMap) {\n    super()\n  }\n\n  public onStairwayDown(stairway: StairwayDown): void {\n    const adjacentMap = this.game.getMap(stairway.adjacentMapName)\n\n    this.event = new MoveEvent(\n      this.game,\n      this.levelMap,\n      stairway.enterPos(this.levelMap, adjacentMap),\n      adjacentMap\n    )\n  }\n}\n\nexport class Descender extends GoToTileAI {\n  constructor() {\n    super(tile => {\n      const visitor = new StairwayDownFinderVisitor()\n      tile.visit(visitor)\n      return visitor.match\n    })\n  }\n\n  public act(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    if (actor.can(Ability.GoStairwayDown)) {\n      return super.act(actor, levelMap, game)\n    }\n  }\n\n  protected onReach(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    // Should stay here at least for a turn\n    const visitor = new StairwayDownTileMoverVisitor(game, levelMap),\n      tile = levelMap.creatureTile(actor)\n\n    tile.visit(visitor)\n    return visitor.event\n  }\n}\n","import { AI } from './internal'\nimport { Creature, Ability, Reaction, CreatureId } from '../models/creature'\nimport { Point, bresenham } from '../utils/utils'\nimport { MissileAttackEvent, GroupedItem } from '../../engine'\nimport { Game } from '../models/game'\nimport { LevelMap } from '../models/level_map'\nimport { Memory } from '../models/memory'\nimport { CreatureEvent } from '../events/internal'\nimport { Item } from '../models/item'\n\nexport class Thrower extends AI {\n  public victim: Creature | undefined\n  public previousVictim: Creature | undefined\n  public missiles: GroupedItem<Item> | undefined\n\n  public act(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    if (\n      !actor.can(Ability.Throwing) ||\n      !this.hasMissile(actor) ||\n      !this.canAttack(actor, levelMap, game)\n    ) {\n      return\n    }\n\n    let path: Point[] = []\n\n    if (!this.victim) {\n      throw 'Thrower.act called when there is no victim'\n    }\n\n    bresenham(\n      levelMap.creaturePos(actor),\n      levelMap.creaturePos(this.victim),\n      (x, y) => path.push(new Point(x, y))\n    )\n\n    return new MissileAttackEvent(\n      path,\n      game,\n      levelMap,\n      (reaction: Reaction) => {\n        if (reaction === Reaction.DIE) {\n          this.victim = undefined\n          this.previousVictim = undefined\n        }\n      }\n    )\n  }\n\n  private hasMissile(actor: Creature): boolean {\n    this.missiles = actor.missile\n    return this.missiles !== undefined\n  }\n\n  private canAttack(actor: Creature, levelMap: LevelMap, game: Game): boolean {\n    this.previousVictim = this.victim\n    this.victim = undefined\n\n    if (this.previousVictim) {\n      if (this.findWithId(actor, levelMap, this.previousVictim.id)) {\n        return true\n      }\n    }\n\n    return this.findCreature(actor, levelMap, creature =>\n      this.enemies(actor, creature)\n    )\n  }\n\n  private findWithId(\n    actor: Creature,\n    levelMap: LevelMap,\n    victimId: CreatureId\n  ): boolean {\n    return this.findCreature(\n      actor,\n      levelMap,\n      creature => victimId === creature.id\n    )\n  }\n\n  private findCreature(\n    actor: Creature,\n    levelMap: LevelMap,\n    condition: (creature: Creature) => boolean\n  ): boolean {\n    const memory = actor.stageMemory(levelMap),\n      pos = levelMap.creaturePos(actor)\n\n    this.withinView(memory, levelMap.creaturePos(actor), (point, tile) => {\n      const creature = tile.creature\n\n      if (\n        !this.victim &&\n        creature &&\n        condition(creature) &&\n        !this.obstacles(actor, pos, memory, point)\n      ) {\n        this.victim = levelMap.at(point.x, point.y).creature\n      }\n    })\n\n    return !!this.victim\n  }\n\n  private obstacles(\n    actor: Creature,\n    pos: Point,\n    memory: Memory,\n    target: Point\n  ): boolean {\n    let obstacles = false\n\n    bresenham(pos, target, (x, y) => {\n      obstacles = obstacles || memory.at(x, y).tangible(actor)\n    })\n\n    return obstacles\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { Creature, Reaction } from '../models/creature'\nimport { Player } from '../models/player'\nimport { Game, AINewLevelEvent, LevelMap } from '../../engine'\n\nexport class AddExperienceEvent extends CreatureEvent {\n  constructor(\n    public actor: Creature,\n    private levelMap: LevelMap,\n    private game: Game\n  ) {\n    super()\n  }\n\n  public affectCreature(subject: Creature): Reaction {\n    return Reaction.NOTHING\n  }\n\n  public affectPlayer(subject: Player): Reaction {\n    subject.level.add(1).forEach(level => {\n      subject.ai.pushEvent(new AINewLevelEvent(level, this.levelMap, this.game))\n    })\n\n    return Reaction.NOTHING\n  }\n}\n","import { ImpactType } from '../lib/impact'\nimport { Creature, Reaction } from '../models/creature'\nimport { Game } from '../models/game'\nimport { CreatureEvent } from './internal'\n\nexport class AddImpactEvent extends CreatureEvent {\n  constructor(\n    private impactType: ImpactType,\n    private source: string,\n    private game: Game,\n    private duration?: number\n  ) {\n    super()\n  }\n\n  public affectCreature(creature: Creature): Reaction {\n    // Different messages for player\n\n    if (creature.hasImpact(this.impactType)) {\n      this.applyImpact()\n    }\n\n    if (this.duration) {\n      creature.impactsBunch.addImpact(this.impactType, this.duration)\n    } else {\n      creature.addImpact(this.impactType, this.source)\n    }\n\n    return Reaction.NOTHING\n  }\n\n  protected applyImpact(): void {}\n}\n","import { includes, intersection, random, sum, sumBy, times } from 'lodash'\nimport { DamageType, ProtectionType } from '../../engine'\nimport { Protection } from '../models/item'\nimport { Resistance } from '../models/specie'\nimport { Damage, Dice } from './damage'\n\nexport type DamageOrResist = { damage: number; resist: boolean }\n\nexport class Calculator {\n  private constructor() {}\n\n  public static misses(attackerBC: number, victimBC: number): boolean {\n    return (\n      Math.random() > attackerBC / (attackerBC + Math.pow(victimBC * 0.25, 0.8))\n    )\n  }\n\n  // Random with luck based align to get low value\n  public static lowerWeight(max: number, min: number = 1): number {\n    let count = 0\n\n    for (let i = min; i < max; i++) {\n      if (this.chance(1, 3)) {\n        count += 1\n      }\n    }\n\n    return Math.max(1, count)\n  }\n  // Random with luck based align to get high value\n  public static higherWeight(max: number, min: number = 1): number {\n    return max + min - this.lowerWeight(max, min)\n  }\n\n  public static chance(hit: number, of: number): boolean {\n    return random(1, of) <= hit\n  }\n\n  // Function result varies from 0 to 1. Ratio defines the speed of growing.\n  // E.g. dodges(10, 1) = 0.93\n  //      dodges(10, 5) = 0.7\n  public static dodges(actorBC: number, ratio: number): boolean {\n    return Math.random() < (Math.atan(actorBC / ratio) / Math.PI) * 2\n  }\n\n  public static damage(\n    damages: Damage[],\n    protectionTypes: Protection[],\n    victimResistances: Resistance[]\n  ): DamageOrResist {\n    if (\n      damages.every(({ type, resistances }) =>\n        this.resistTo(type, resistances, victimResistances)\n      )\n    ) {\n      return { damage: 0, resist: true }\n    }\n\n    const damage = sumBy(\n      damages,\n      ({ extra, dice, type, resistances }): number => {\n        if (this.resistTo(type, resistances, victimResistances)) {\n          return 0\n        }\n\n        return Math.floor(\n          Math.max(\n            0,\n            extra +\n              this.dropDice(dice) -\n              this.protectionValue(type, protectionTypes)\n          )\n        )\n      }\n    )\n\n    return { damage, resist: false }\n  }\n\n  protected static resistTo(\n    damageType: DamageType,\n    resistances: Resistance[] | undefined,\n    victimResistances: Resistance[]\n  ): boolean {\n    if (resistances && intersection(victimResistances, resistances).length) {\n      return true\n    }\n\n    switch (damageType) {\n      case DamageType.Melee:\n      case DamageType.Pierce:\n      case DamageType.Blunt:\n        return includes(victimResistances, Resistance.Intangible)\n      case DamageType.Magic:\n        return includes(victimResistances, Resistance.MagicDamage)\n      case DamageType.Pure:\n        return false\n    }\n  }\n\n  protected static dropDice(dice: Dice): number {\n    return sum(times(dice.times, () => random(1, dice.max)))\n  }\n\n  protected static protectionValue(\n    damageType: DamageType,\n    protections: Protection[]\n  ): number {\n    return sum(\n      protections.map(\n        ({ type, value }: Protection): number =>\n          value * this.armorToDamageRatio(damageType, type)\n      )\n    )\n  }\n\n  protected static armorToDamageRatio = (\n    damageType: DamageType,\n    armorType: ProtectionType\n  ): number => {\n    switch (damageType) {\n      case DamageType.Melee:\n        switch (armorType) {\n          case ProtectionType.Medium:\n            return 2 / 3\n          case ProtectionType.Solid:\n            return 4 / 3\n          default:\n            return 1\n        }\n      case DamageType.Pierce:\n        switch (armorType) {\n          case ProtectionType.Light:\n            return 1 / 2\n          case ProtectionType.Medium:\n            return 4 / 3\n          case ProtectionType.Solid:\n            return 3\n          case ProtectionType.Unarmored:\n            return 3 / 4\n          default:\n            return 1\n        }\n      case DamageType.Blunt:\n        switch (armorType) {\n          case ProtectionType.Medium:\n            return 2\n          case ProtectionType.Solid:\n            return 1 / 2\n          case ProtectionType.Unarmored:\n            return 1 / 2\n          default:\n            return 1\n        }\n      case DamageType.Magic:\n        switch (armorType) {\n          case ProtectionType.Light:\n            return 5 / 4\n          case ProtectionType.Medium:\n            return 3 / 4\n          case ProtectionType.Heavy:\n            return 1 / 2\n          case ProtectionType.Solid:\n            return 3\n          default:\n            return 1\n        }\n      case DamageType.Pure:\n        return 0\n      default:\n        throw 'Got unknown type of damage!'\n    }\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { LevelMap } from '../models/level_map'\nimport { Creature, Reaction } from '../models/creature'\nimport { Damage } from '../lib/damage'\nimport { Game } from '../models/game'\nimport { DieEvent, DieReason } from './die_event'\nimport { Calculator } from '../lib/calculator'\n\nexport class HurtEvent extends CreatureEvent {\n  private doneDamage: number | undefined\n\n  constructor(\n    private damages: Damage[],\n    private dieReason: DieReason,\n    private levelMap: LevelMap,\n    private game: Game\n  ) {\n    super()\n  }\n\n  get damage(): number {\n    if (this.doneDamage) {\n      return this.doneDamage\n    } else {\n      throw `HurtEvent.damage called but there is no done damage`\n    }\n  }\n\n  public affectCreature(subject: Creature): Reaction {\n    const { damage, resist } = Calculator.damage(\n      this.damages,\n      subject.protections,\n      subject.resistances\n    )\n\n    this.doneDamage = damage\n\n    if (resist) {\n      return Reaction.RESIST\n    }\n\n    if (damage >= subject.health.currentValue) {\n      subject.on(new DieEvent(this.game, this.levelMap, this.dieReason))\n      return Reaction.DIE\n    } else if (damage <= 0) {\n      return Reaction.NOTHING\n    } else {\n      subject.health.decrease(damage)\n      return Reaction.HURT\n    }\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { Creature, Reaction } from '../models/creature'\nimport { AddExperienceEvent } from './add_experience_event'\nimport { Game } from '../models/game'\nimport { LevelMap } from '../models/level_map'\nimport { Calculator } from '../lib/calculator'\nimport { HurtEvent } from './hurt_event'\nimport { DieReason } from './die_event'\n\nexport class AttackEvent extends CreatureEvent {\n  constructor(\n    private victim: Creature,\n    private levelMap: LevelMap,\n    private game: Game\n  ) {\n    super()\n  }\n\n  public affectCreature(actor: Creature): Reaction {\n    const reaction = this.process(actor)\n\n    switch (reaction) {\n      case Reaction.NOTHING:\n        // TODO: victim is not always a player, should be another message as well\n        this.game.logger.noDamageToPlayer(actor)\n        break\n      case Reaction.RESIST:\n        // TODO: victim is not always a player, should be another message as well\n        this.game.logger.playerIgnoresDamage(actor)\n        break\n    }\n\n    return reaction\n  }\n\n  public affectPlayer(actor: Creature): Reaction {\n    const reaction = this.process(actor)\n\n    switch (reaction) {\n      case Reaction.NOTHING:\n        this.game.logger.noDamageToTarget(actor)\n        break\n      case Reaction.RESIST:\n        this.game.logger.targetIgnoresDamage(this.victim)\n        break\n    }\n\n    return reaction\n  }\n\n  protected process(actor: Creature): Reaction {\n    if (Calculator.misses(actor.bodyControl, this.victim.bodyControl)) {\n      this.game.logger.missMessage(this.game.player, actor, this.victim)\n      return Reaction.DODGE\n    }\n\n    const hurtEvent = new HurtEvent(\n        actor.damages,\n        DieReason.Attack,\n        this.levelMap,\n        this.game\n      ),\n      reaction = this.victim.on(hurtEvent)\n\n    switch (reaction) {\n      case Reaction.DIE:\n        actor.on(new AddExperienceEvent(this.victim, this.levelMap, this.game))\n        this.game.logger.killMessage(\n          this.game.player,\n          hurtEvent.damage,\n          actor,\n          this.victim\n        )\n        break\n      case Reaction.HURT:\n        this.game.logger.hurtMessage(\n          this.game.player,\n          hurtEvent.damage,\n          actor,\n          this.victim\n        )\n        break\n    }\n\n    return reaction\n  }\n}\n","import { Creature, Reaction } from '../models/creature'\nimport { CreatureEvent } from './internal'\nimport { Potion, Game } from '../../engine'\n\nexport class DrinkPotionEvent extends CreatureEvent {\n  constructor(private potion: Potion, private game: Game) {\n    super()\n  }\n\n  public affectCreature(actor: Creature): Reaction {\n    actor.removeItem(this.potion, 1)\n    this.potion.onDrink(this.game)\n    // TODO: Different messages for player and creatures\n    this.game.logger.drink(this.potion)\n    return Reaction.NOTHING\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { Tile, GroupedItem, Game } from '../../engine'\nimport { Creature, Reaction } from '../models/creature'\nimport { Player } from '../models/player'\nimport { Item } from '../models/item'\nimport { PlayerEvent } from './player_event'\n\nexport class DropItemsEvent extends PlayerEvent {\n  constructor(\n    private tile: Tile,\n    private items: GroupedItem<Item>[],\n    private game: Game\n  ) {\n    super()\n  }\n\n  public affectPlayer(player: Player): Reaction {\n    // TODO: Validate items are part of positions\n    this.items.forEach(({ item, count }) => {\n      player.removeItem(item, count)\n      player.stuffWeight.subtract(item.weight * count)\n\n      this.game.logger.droppedItem(item, count)\n      this.tile.addItem(item, count)\n    })\n\n    return Reaction.NOTHING\n  }\n}\n","import { PlayerEvent } from './player_event'\nimport { Reaction } from '../models/creature'\nimport { Player } from '../models/player'\n\nexport class LevelUpEvent extends PlayerEvent {\n  public affectPlayer(player: Player): Reaction {\n    this.updateHealth(player)\n\n    return Reaction.NOTHING\n  }\n\n  protected updateHealth(player: Player): void {\n    player.health.constantIncrease(player.constitution.levelUpHPBonus)\n\n    if (player.health.maximum < 1) {\n      player.health.constantIncrease(1 - player.health.maximum)\n    }\n\n    // TODO: Add per race / class hp increase\n  }\n}\n","import { Item } from './item'\nimport { Point } from '../utils/utils'\nimport { Memory } from './memory'\n\nexport abstract class TileEffect {\n  constructor(public onDone: () => void) {}\n\n  public abstract done(): boolean\n  public abstract patchMemory(memory: Memory): void\n  public speed(): number {\n    return -1\n  }\n}\n\nexport class ItemFlightTileEffect extends TileEffect {\n  constructor(\n    public readonly item: Item,\n    private frames: Point[],\n    onDone: () => void\n  ) {\n    super(onDone)\n  }\n\n  public patchMemory(memory: Memory): void {\n    if (this.done()) {\n      return\n    }\n\n    const [point] = this.frames.splice(0, 1)\n    const tile = memory.at(point.x, point.y)\n\n    if (tile.visible) {\n      tile.effect = '-'\n    } else {\n      // Skipping effect if it's not visible\n      this.patchMemory(memory)\n    }\n  }\n\n  public done(): boolean {\n    return this.frames.length === 0\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { Creature, Reaction } from '../models/creature'\nimport { AddExperienceEvent } from './add_experience_event'\nimport { Item } from '../models/item'\nimport { Game } from '../models/game'\nimport { DieEvent, DieReason } from './die_event'\nimport { LevelMap } from '../../engine'\nimport { Calculator } from '../lib/calculator'\n\nexport class ThrowEvent extends CreatureEvent {\n  constructor(\n    public victim: Creature,\n    public missile: Item,\n    private levelMap: LevelMap,\n    private game: Game\n  ) {\n    super()\n  }\n\n  public affectCreature(actor: Creature): Reaction {\n    if (Calculator.misses(actor.bodyControl, this.victim.bodyControl)) {\n      this.game.logger.throwMissMessage(\n        this.game.player,\n        actor,\n        this.victim,\n        this.missile\n      )\n      return Reaction.THROW_DODGE\n    }\n\n    // TODO: Check if hit with shooter's BC\n\n    // TODO: Check has no resistances\n    const { damage, resist } = Calculator.damage(\n      actor.throwDamages,\n      this.victim.protections,\n      this.victim.resistances\n    )\n\n    if (damage >= this.victim.health.currentValue) {\n      actor.on(new AddExperienceEvent(this.victim, this.levelMap, this.game))\n      this.game.logger.throwKillMessage(\n        this.game.player,\n        damage,\n        actor,\n        this.victim,\n        this.missile\n      )\n      return this.victim.on(\n        new DieEvent(this.game, this.levelMap, DieReason.Missile)\n      )\n    } else {\n      this.victim.health.decrease(damage)\n      this.game.logger.throwHurtMessage(\n        this.game.player,\n        damage,\n        actor,\n        this.victim,\n        this.missile\n      )\n      return Reaction.HURT\n    }\n  }\n}\n","import {\n  InventorySlot,\n  CreatureEvent,\n  Game,\n  Item,\n  Armor,\n  RemoveImpactEvent,\n} from '../../engine'\nimport { Reaction, Creature } from '../models/creature'\nimport { Player } from '../models/player'\nimport { findIndex } from 'lodash'\nimport { Protection, Weapon } from '../models/item'\nimport { Damage } from '../lib/damage'\n\nexport class TakeOffItemEvent extends CreatureEvent {\n  constructor(private slot: InventorySlot, private game: Game) {\n    super()\n  }\n\n  public affectCreature(actor: Creature): Reaction {\n    return Reaction.NOTHING\n  }\n\n  public affectPlayer(player: Player): Reaction {\n    const equipment = this.slot.equipment\n\n    if (equipment === undefined) {\n      throw `Can not take off item from ${this.slot.name} - nothing equipped`\n    }\n\n    this.slot.takeOff()\n    this.onTakeOff(player, equipment.item)\n    player.inventory.putToBag(equipment.item, equipment.count)\n    this.game.logger.takeOff(equipment.item)\n\n    return Reaction.NOTHING\n  }\n\n  private onTakeOff(player: Player, item: Item): void {\n    if (item instanceof Armor) {\n      item.protections.forEach((itemProtection: Protection) => {\n        player.itemsProtections.splice(\n          findIndex(\n            player.itemsProtections,\n            protection => protection === itemProtection\n          ),\n          1\n        )\n      })\n    }\n\n    item.impacts.forEach(impact => {\n      player.on(new RemoveImpactEvent(impact, item.name, this.game))\n    })\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { Reaction, Creature } from '../models/creature'\nimport { Player } from '../models/player'\nimport { InventorySlot } from '../models/inventory_slot'\nimport { TakeOffItemEvent } from './take_off_item_event'\nimport { Game } from '../models/game'\n\nexport class RemoveItemEvent extends CreatureEvent {\n  constructor(\n    private slot: InventorySlot,\n    private count: number,\n    private game: Game\n  ) {\n    super()\n  }\n\n  public affectCreature(creature: Creature): Reaction {\n    return Reaction.NOTHING\n  }\n\n  public affectPlayer(player: Player): Reaction {\n    if (!this.slot.equipment) {\n      throw `RemoveItemEvent: ${this.slot.name} has no equipment`\n    }\n\n    if (this.slot.equipment.count === this.count) {\n      return player.on(new TakeOffItemEvent(this.slot, this.game))\n    } else {\n      this.slot.equipment.count -= this.count\n    }\n\n    return Reaction.NOTHING\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { Point } from '../utils/utils'\nimport { Creature, Reaction } from '../models/creature'\nimport { Player } from '../models/player'\nimport { ItemFlightTileEffect } from '../models/tile_effect'\nimport { ThrowEvent } from './throw_event'\nimport { Game } from '../models/game'\nimport { LevelMap } from '../models/level_map'\nimport { Missile } from '../models/item'\nimport { RemoveItemEvent } from './remove_item_event'\n\nexport class MissileAttackEvent extends CreatureEvent {\n  constructor(\n    private path: Point[],\n    private game: Game,\n    private levelMap: LevelMap,\n    private done: (reaction: Reaction) => void\n  ) {\n    super()\n  }\n\n  public affectCreature(actor: Creature): Reaction {\n    let missile = actor.missile\n\n    if (!missile) {\n      throw 'MissileAttackEvent called when actor has no missiles'\n    }\n\n    this.withMissile(actor, missile.item)\n\n    return Reaction.NOTHING\n  }\n\n  public affectPlayer(player: Player): Reaction {\n    const missile = player.missile\n\n    if (!missile) {\n      throw 'MissileAttackEvent: slot has no items'\n    }\n\n    this.withMissile(player, missile.item)\n\n    player.on(new RemoveItemEvent(player.inventory.missileSlot, 1, this.game))\n    player.stuffWeight.subtract(missile.item.weight)\n\n    return Reaction.NOTHING\n  }\n\n  private withMissile(actor: Creature, missile: Missile): void {\n    let flightPath: Point[] = [],\n      victim: Creature | undefined\n\n    this.path.forEach(point => {\n      if (!victim) {\n        const tile = this.levelMap.at(point.x, point.y)\n        victim = tile.creature\n        flightPath.push(point)\n      }\n    })\n\n    this.game.effect = new ItemFlightTileEffect(missile, flightPath, () => {\n      if (victim) {\n        this.done(\n          actor.on(new ThrowEvent(victim, missile, this.levelMap, this.game))\n        )\n      } else {\n        this.done(Reaction.NOTHING)\n      }\n    })\n  }\n}\n","import { Game, GroupedItem, ItemsBunch, Tile } from '../../engine'\nimport { Creature, Reaction } from '../models/creature'\nimport { Player } from '../models/player'\nimport { Item } from '../models/item'\nimport { PlayerEvent } from './player_event'\n\nexport class PickUpItemsEvent extends PlayerEvent {\n  constructor(\n    private tile: Tile,\n    private items: GroupedItem<Item>[],\n    private game: Game\n  ) {\n    super()\n  }\n\n  public affectPlayer(player: Player): Reaction {\n    let tileItems: ItemsBunch<Item> | undefined = this.tile.items\n\n    if (tileItems === undefined) {\n      throw 'Failed to pick up items - tile has no items'\n    } else {\n      this.withTileItems(player, tileItems)\n    }\n\n    return Reaction.NOTHING\n  }\n\n  protected withTileItems(subject: Player, tileItems: ItemsBunch<Item>) {\n    this.items.forEach(({ item, count }) => {\n      subject.addItem(item, count)\n      subject.stuffWeight.add(item.weight * count)\n\n      this.game.logger.pickedUpItem(item, count)\n      tileItems.remove(item, count)\n    })\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { InventorySlot, Item, Game } from '../../engine'\nimport { Creature, Reaction } from '../models/creature'\nimport { Player } from '../models/player'\nimport { TakeOffItemEvent } from './take_off_item_event'\nimport { Armor, Weapon } from '../models/item'\nimport { AddImpactEvent } from './add_impact_event'\n\nexport class PutOnItemEvent extends CreatureEvent {\n  constructor(\n    private slot: InventorySlot,\n    private item: Item,\n    private game: Game\n  ) {\n    super()\n  }\n\n  public affectCreature(creature: Creature): Reaction {\n    return Reaction.NOTHING\n  }\n\n  public affectPlayer(player: Player): Reaction {\n    let inventory = player.inventory,\n      groupItem = inventory.findInBag(this.item)\n\n    if (groupItem === undefined) {\n      throw `Item ${\n        this.item.name\n      } can not be equipped - not found in inventory`\n    }\n\n    // TODO: assert that can't equip more than have in inventory\n    // TODO: assert can equip\n    if (this.slot.equipment) {\n      const reaction = player.on(new TakeOffItemEvent(this.slot, this.game))\n      if (reaction !== Reaction.NOTHING) {\n        return reaction\n      }\n    }\n\n    const count = this.slot.useSingleItem ? 1 : groupItem.count\n\n    player.removeItem(this.item, count)\n    this.slot.equip(this.item, count)\n    this.onPutOn(player, this.item)\n\n    this.game.logger.putOn(this.item)\n\n    return Reaction.NOTHING\n  }\n\n  private onPutOn(player: Player, item: Item): void {\n    if (item instanceof Armor) {\n      player.itemsProtections = player.itemsProtections.concat(item.protections)\n    }\n\n    item.impacts.forEach(impact => {\n      player.on(new AddImpactEvent(impact, item.name, this.game))\n    })\n  }\n}\n","import { CreatureEvent } from './internal'\nimport { Creature, Reaction } from '../models/creature'\nimport { ImpactType, Game } from '../../engine'\n\nexport class RemoveImpactEvent extends CreatureEvent {\n  constructor(\n    private impactType: ImpactType,\n    private source: string,\n    private game: Game\n  ) {\n    super()\n  }\n\n  public affectCreature(creature: Creature): Reaction {\n    return Reaction.NOTHING\n  }\n}\n","import { LevelMap, Tile, Item } from '../../engine'\nimport { Pool } from '../lib/pool'\nimport { Creature } from '../models/creature'\nimport { Point, cycle } from '../utils/utils'\n\nimport { random } from 'lodash'\n\nexport const addDoors = function(\n  level: LevelMap,\n  doorTile: () => Tile,\n  addDoor: () => boolean = () => true\n): LevelMap {\n  for (let j = 1; j < level.height - 1; j++) {\n    for (let i = 1; i < level.width; i++) {\n      const tile = level.at(i, j),\n        up = level.at(i, j - 1),\n        down = level.at(i, j + 1),\n        left = level.at(i - 1, j),\n        right = level.at(i + 1, j)\n\n      if (!addDoor() || tile.key !== 'C') {\n        continue\n      }\n\n      if (\n        left.key === 'D' ||\n        right.key === 'D' ||\n        up.key === 'D' ||\n        down.key === 'D'\n      ) {\n        continue\n      }\n\n      if (\n        left.key !== 'R' &&\n        right.key !== 'R' &&\n        up.key !== 'R' &&\n        down.key !== 'R'\n      ) {\n        continue\n      }\n\n      if (\n        (left.key === 'W' && right.key === 'W') ||\n        (up.key === 'W' && down.key === 'W')\n      ) {\n        level.setTile(i, j, doorTile())\n      }\n    }\n  }\n\n  return level\n}\n\nexport const addCreatures = function(\n  chance: number,\n  level: LevelMap,\n  creaturesPool: Pool<null, Creature>\n): LevelMap {\n  for (let i = 1; i < level.width - 1; i++) {\n    for (let j = 1; j < level.height - 1; j++) {\n      if (level.at(i, j).passibleThrough() && Math.random() < chance) {\n        level.addCreature(new Point(i, j), creaturesPool.pick(null))\n      }\n    }\n  }\n\n  return level\n}\n\nexport const addItems = function(\n  chance: number,\n  level: LevelMap,\n  itemsPool: Pool<null, Item>\n): LevelMap {\n  for (let j = 1; j < level.height - 1; j++) {\n    for (let i = 1; i < level.width - 1; i++) {\n      const tile = level.at(i, j)\n      if (tile.passibleThrough() && Math.random() < chance) {\n        tile.addItem(itemsPool.pick(null), 1)\n      }\n    }\n  }\n\n  return level\n}\n\nexport const centralize = function(level: LevelMap): LevelMap {\n  let minX = level.width,\n    minY = level.height,\n    maxX = 0,\n    maxY = 0\n\n  for (let j = 1; j < level.height - 1; j++) {\n    for (let i = 1; i < level.width - 1; i++) {\n      if (!level.at(i, j).passibleThrough()) {\n        continue\n      }\n\n      maxY = Math.max(j, maxY)\n      maxX = Math.max(i, maxX)\n      minY = Math.min(j, minY)\n      minX = Math.min(i, minX)\n    }\n  }\n\n  const dx = Math.floor((level.width - (maxX - minX)) / 2) - minX,\n    dy = Math.floor((level.height - (maxY - minY)) / 2) - minY\n\n  cycle(level.map, dx)\n  level.map.forEach(row => cycle(row, dy))\n\n  return level\n}\n\n// TODO: Move away from generators\n// TODO: Do not throw\nexport const withMatchingTile = function(\n  level: LevelMap,\n  match: (tile: Tile) => boolean,\n  onValid: (x: number, y: number) => void\n): LevelMap {\n  let iters = level.width * level.height\n\n  while (iters > 0) {\n    const x = random(0, level.width - 1),\n      y = random(0, level.height - 1)\n\n    if (match(level.at(x, y))) {\n      onValid(x, y)\n      return level\n    }\n\n    iters--\n  }\n\n  throw 'post add failed to add tile'\n}\n\nexport const safeWithMatchingTile = function(\n  level: LevelMap,\n  match: (tile: Tile) => boolean\n): { tile: Tile; x: number; y: number } | undefined {\n  let iters = level.width * level.height\n\n  while (iters > 0) {\n    const x = random(0, level.width - 1),\n      y = random(0, level.height - 1),\n      tile = level.at(x, y)\n\n    if (match(tile)) {\n      return { tile, x, y }\n    }\n\n    iters--\n  }\n}\n\nexport const withEachTile = function(\n  level: LevelMap,\n  match: (tile: Tile) => boolean,\n  onValid: (tile: Tile, x: number, y: number) => void\n): void {\n  level.each((tile, x, y) => {\n    if (match(tile)) {\n      onValid(tile, x, y)\n    }\n  })\n}\n","import { CreatureEvent } from './internal'\nimport { Reaction } from '../models/creature'\nimport { Player } from '../models/player'\nimport { LevelMap } from '../models/level_map'\nimport { Game } from '../models/game'\nimport { Trap } from '../models/tile'\nimport { Point } from '../utils/utils'\n\nexport class UntrapEvent extends CreatureEvent {\n  constructor(\n    private trapPosition: Point,\n    private trap: Trap,\n    private levelMap: LevelMap,\n    private game: Game\n  ) {\n    super()\n  }\n\n  public affectCreature(): Reaction {\n    return Reaction.NOTHING\n  }\n\n  public affectPlayer(player: Player): Reaction {\n    this.trap.untrap(this.trapPosition, player, this.levelMap, this.game)\n    return Reaction.NOTHING\n  }\n}\n","import { Rect, Point, rand, twoDimArray, minUnsafe } from '../utils/utils'\nimport { min } from 'lodash'\n\nconst THICKNESS = 0\nconst RAY_TURNS = 60\nconst DELTA_ANGLE = Math.PI / (RAY_TURNS * 2)\n\nclass Room<T> extends Rect {\n  notCross(rect: Rect): boolean {\n    return (\n      rect.x - THICKNESS > this.x + this.w ||\n      rect.y - THICKNESS > this.y + this.h ||\n      rect.x + rect.w < this.x - THICKNESS ||\n      rect.y + rect.h < this.y - THICKNESS\n    )\n  }\n\n  pointWithin(): Point {\n    return new Point(\n      this.x + 1 + rand(this.w - 1),\n      this.y + 1 + rand(this.h - 1)\n    )\n  }\n\n  add(stage: T[][], walls: boolean[][], newRoomSpace: () => T): void {\n    let i: number = 0\n    while (i < this.w) {\n      let j: number = 0\n      while (j < this.h) {\n        stage[this.x + i][this.y + j] = newRoomSpace()\n        walls[this.x + i][this.y + j] = false\n        j++\n      }\n\n      i++\n    }\n  }\n}\n\nclass Road<T> extends Rect {\n  lined: boolean\n\n  constructor(x: number, y: number, w: number, h: number) {\n    super(x, y, w, h)\n    this.lined = (x >= w && y >= h) || (w >= x && h >= y)\n  }\n\n  add(stage: T[][], walls: boolean[][], newCorridor: () => T): void {\n    let [hx, hy, w] = this.horizontalLine()\n\n    let i = 0\n    while (i < w) {\n      if (walls[hx + i][hy]) {\n        stage[hx + i][hy] = newCorridor()\n      }\n      i += 1\n    }\n\n    let [vx, vy, h] = this.verticalLine()\n    let j = 0\n    while (j < h) {\n      if (walls[vx][vy + j]) {\n        stage[vx][vy + j] = newCorridor()\n      }\n      j += 1\n    }\n  }\n\n  horizontalLine(): [number, number, number] {\n    // x\n    // |\\\n    // .-x\n    if (this.lined)\n      return [\n        Math.min(this.x, this.w),\n        Math.max(this.y, this.h),\n        Math.abs(this.w - this.x),\n      ]\n    // .-x\n    // |/\n    // x\n    else\n      return [\n        Math.min(this.x, this.w),\n        Math.min(this.y, this.h),\n        Math.abs(this.w - this.x),\n      ]\n  }\n\n  verticalLine(): [number, number, number] {\n    // x\n    // |\\\n    // .-x\n    if (this.lined)\n      return [\n        Math.min(this.x, this.w),\n        Math.min(this.y, this.h),\n        Math.abs(this.h - this.y),\n      ]\n    // .-x\n    // |/\n    // x\n    else\n      return [\n        Math.min(this.x, this.w),\n        Math.min(this.y, this.h),\n        Math.abs(this.h - this.y),\n      ]\n  }\n}\n\nclass DungeonGenerator<T> {\n  rooms: Room<T>[]\n  roads: Road<T>[]\n\n  constructor(\n    protected maxX: number,\n    protected maxY: number,\n    private minSize: number,\n    private maxSize: number,\n    private roomsCount: number\n  ) {\n    let rooms: Room<T>[] = new Array(this.roomsCount)\n      .fill(undefined)\n      .map(_ => this.generateRoom())\n\n    this.rooms = this.normalize(this.ray(rooms))\n    this.roads = this.buildRoads(this.rooms)\n  }\n\n  private generateRoom(): Room<T> {\n    return new Room(\n      0,\n      0,\n      this.minSize + rand(this.maxSize - this.minSize),\n      this.minSize + rand(this.maxSize - this.minSize)\n    )\n  }\n\n  // Takes a room and tries to put it on a ray coming from (0, 0)\n  // until the room finds empty place for it.\n  private ray(rooms: Room<T>[]): Room<T>[] {\n    return rooms.reduce((pickedRooms: Room<T>[], currentRoom: Room<T>) => {\n      for (\n        let i = 0, angle = (rand(360) / 180) * Math.PI;\n        i < RAY_TURNS;\n        angle += DELTA_ANGLE, i++\n      ) {\n        // TODO: Build table with these values.\n        const cos: number = Math.cos(angle)\n        const sin: number = Math.sin(angle)\n        let l: number = 1\n        let dx: number = 0\n        let dy: number = 0\n\n        let roomToMove = new Room(\n          currentRoom.x,\n          currentRoom.y,\n          currentRoom.w,\n          currentRoom.h\n        )\n\n        while (Math.abs(dx) < this.maxX / 2 && Math.abs(dy) < this.maxY / 2) {\n          let ndx = Math.round(l * cos)\n          let ndy = Math.round(l * sin)\n\n          while (ndx === dx && ndy === dy) {\n            l += 1\n            ndx = Math.round(l * cos)\n            ndy = Math.round(l * sin)\n          }\n\n          roomToMove.move(ndx - dx, ndy - dy)\n          dx = ndx\n          dy = ndy\n\n          if (pickedRooms.every(room => roomToMove.notCross(room))) {\n            pickedRooms.push(roomToMove)\n            return pickedRooms\n          }\n        }\n      }\n\n      return pickedRooms\n    }, [])\n  }\n\n  private normalize(rooms: Room<T>[]): Room<T>[] {\n    if (rooms.length === 0) {\n      return rooms\n    }\n\n    const minX = minUnsafe(rooms.map(room => room.x)) - 1\n    rooms.forEach(room => {\n      room.move(-minX, 0)\n    })\n    rooms = rooms.filter((room: Room<T>) => room.x + room.w < this.maxX)\n\n    const minY = minUnsafe(rooms.map(room => room.y)) - 1\n    rooms.forEach(room => {\n      room.move(0, -minY)\n    })\n    return rooms.filter((room: Room<T>) => room.y + room.h < this.maxY)\n  }\n\n  private buildRoads(rooms: Room<T>[]): Road<T>[] {\n    let points: Point[] = rooms.map(room => {\n      return room.pointWithin()\n    })\n\n    const firstPoint = points.shift()\n\n    if (!firstPoint) {\n      throw 'Dungeon.buildRoads rooms array is empty'\n    }\n\n    let connectedPoints: Point[] = [firstPoint]\n    let roads: Road<T>[] = []\n\n    const distance = function(point1: Point, point2: Point): number {\n      // No need to calc square root since it's being used for comparison only.\n      return (point1.x - point2.x) ** 2 + (point1.y - point2.y) ** 2\n    }\n\n    while (points.length) {\n      let maybePoint = points.shift()\n      if (!maybePoint) {\n        throw 'Dungeon.buildRoads rooms array is empty'\n      }\n\n      let currentPoint: Point = maybePoint\n\n      let pointToConnect = connectedPoints[0]\n      let minDistance = distance(currentPoint, pointToConnect)\n\n      connectedPoints.forEach(point => {\n        const currentDistance = distance(point, currentPoint)\n        if (currentDistance < minDistance) {\n          pointToConnect = point\n          minDistance = currentDistance\n        }\n      })\n\n      connectedPoints.push(currentPoint)\n\n      roads.push(\n        new Road(\n          currentPoint.x,\n          currentPoint.y,\n          pointToConnect.x,\n          pointToConnect.y\n        )\n      )\n    }\n\n    return roads\n  }\n}\n\nexport default function<T>(\n  dimX: number,\n  dimY: number,\n  minSize: number,\n  maxSize: number,\n  roomsCount: number,\n  newRoomSpace: () => T,\n  newCorridor: () => T,\n  newWall: () => T\n): T[][] {\n  // TODO: Validate min or max size is lower than map's sizes\n  const dungeon = new DungeonGenerator<T>(\n    dimX,\n    dimY,\n    minSize,\n    maxSize,\n    roomsCount\n  )\n\n  let stage = twoDimArray(dimX, dimY, newWall)\n  let walls = twoDimArray(dimX, dimY, () => true)\n\n  for (let i = 0; i < dungeon.rooms.length; i++)\n    dungeon.rooms[i].add(stage, walls, newRoomSpace)\n  for (let i = 0; i < dungeon.roads.length; i++)\n    dungeon.roads[i].add(stage, walls, newCorridor)\n\n  return stage\n}\n","import { Resistance } from '../models/specie'\n\nexport enum DamageType {\n  Melee,\n  Pierce,\n  Blunt,\n  Magic,\n  Pure,\n}\n\nexport type Dice = {\n  times: number\n  max: number\n}\n\nexport type Damage = {\n  extra: number\n  dice: Dice\n  type: DamageType\n  resistances?: Resistance[]\n}\n","export enum Gender {\n  Neuter,\n  Female,\n  Male,\n}\n","import { Creature, Reaction } from './creature'\nimport { Item, Potion, CorrosionLevel } from './item'\n\nimport { last } from 'lodash'\nimport { Player } from './player'\nimport { BodyPart } from './inventory_slot'\n\nexport enum LogLevel {\n  DEBUG,\n  INFO,\n  WARNING,\n  DANGER,\n}\n\nexport interface LogMessage {\n  level: LogLevel\n  message: string\n  counter: number\n}\n\n// TODO: Do not display messages while being blind\nexport class Logger {\n  public messages: LogMessage[] = []\n\n  public trapAirBlow: TrapAirBlowLogger\n  public trapBareWire: TrapBareWireLogger\n  public trapHole: TrapHoleLogger\n  public trapFallingRock: TrapFallingRockLogger\n\n  constructor(player: Player) {\n    this.trapAirBlow = new TrapAirBlowLogger(this, player)\n    this.trapBareWire = new TrapBareWireLogger(this, player)\n    this.trapFallingRock = new TrapFallingRockLogger(this, player)\n    this.trapHole = new TrapHoleLogger(this, player)\n  }\n\n  public reset() {\n    this.messages = []\n  }\n\n  public hurtMessage(\n    player: Player,\n    damage: number,\n    actor: Creature,\n    target: Creature\n  ) {\n    this.debug(`${target.name} got ${damage} damage from ${actor.name}`)\n  }\n\n  public killMessage(\n    player: Player,\n    damage: number,\n    actor: Creature,\n    target: Creature\n  ) {\n    this.warning(\n      `${target.name} got ${damage} damage from ${\n        actor.name\n      } causes them to die`\n    )\n  }\n\n  public missMessage(player: Player, actor: Creature, target: Creature) {\n    this.debug(`${actor.name} misses ${target.name}!`)\n  }\n\n  public throwMissMessage(\n    player: Player,\n    actor: Creature,\n    target: Creature,\n    missile: Item\n  ) {\n    this.debug(\n      `${actor.name} throws ${missile.name} in ${target.name}, but misses!`\n    )\n  }\n\n  public throwKillMessage(\n    player: Player,\n    damage: number,\n    actor: Creature,\n    target: Creature,\n    missile: Item\n  ) {\n    this.warning(\n      `${target.name} got ${damage} damage from ${actor.name} by ${\n        missile.name\n      } causes them to die`\n    )\n  }\n\n  public throwHurtMessage(\n    player: Player,\n    damage: number,\n    actor: Creature,\n    target: Creature,\n    missile: Item\n  ) {\n    this.debug(\n      `${target.name} got ${damage} damage from ${actor.name} by ${\n        missile.name\n      }`\n    )\n  }\n\n  public ranIntoAnObstacle(): void {\n    this.addMessage(LogLevel.DEBUG, 'You ran into a wall')\n  }\n\n  public howToHandle(): void {\n    this.addMessage(LogLevel.DEBUG, \"Don't know how to handle it\")\n  }\n\n  public noItemsToPickUp(): void {\n    this.addMessage(LogLevel.DEBUG, \"You don't see anything to pick up\")\n  }\n\n  public takeOff(item: Item): void {\n    this.addMessage(LogLevel.DEBUG, `You took off ${item.name}`)\n  }\n\n  public putOn(item: Item): void {\n    this.addMessage(LogLevel.DEBUG, `You put on ${item.name}`)\n  }\n\n  public drink(item: Potion): void {\n    this.addMessage(LogLevel.INFO, `You drunk ${item.name}`)\n  }\n\n  public nothingToShotWith(): void {\n    this.addMessage(LogLevel.DEBUG, 'You have nothing to shoot with')\n  }\n\n  public needMissileWeapon(): void {\n    this.addMessage(LogLevel.DEBUG, 'Мне нужен лук или типа того')\n  }\n\n  public youSteppedInTrap(): void {\n    this.addMessage(LogLevel.DANGER, 'Я наступил в ловушку')\n  }\n\n  public creatureSteppedInTrap(creature: Creature): void {\n    this.addMessage(LogLevel.DANGER, `${creature.name} наступил в ловушку`)\n  }\n\n  public noDamageToPlayer(actor: Creature): void {\n    this.addMessage(\n      LogLevel.DEBUG,\n      `${actor.name} ударил по мне, но я не почувствовал боли`\n    )\n  }\n\n  public noDamageToTarget(actor: Creature): void {\n    this.addMessage(\n      LogLevel.DEBUG,\n      `Удар пришелся по ${actor.name} но остался незамеченным`\n    )\n  }\n\n  public playerIgnoresDamage(target: Creature): void {\n    this.addMessage(LogLevel.DEBUG, `Я игнорирую урон ${target.name}`)\n  }\n\n  public targetIgnoresDamage(target: Creature): void {\n    this.addMessage(LogLevel.INFO, `${target.name} игнорирует урон`)\n  }\n\n  public creatureTeleported(actor: Creature): void {\n    this.addMessage(LogLevel.INFO, `${actor.name} иcчез`)\n  }\n\n  public creatureNotTeleported(actor: Creature): void {\n    this.addMessage(\n      LogLevel.INFO,\n      `${actor.name} озарился светом, но ничего не произошло`\n    )\n  }\n\n  public creatureDodgesTeleportationTrap(actor: Creature): void {\n    this.addMessage(\n      LogLevel.INFO,\n      `${actor.name} попал в ловушку телепортации но смог увернуться`\n    )\n  }\n\n  public playerTeleportationCaused(): void {\n    this.addMessage(LogLevel.INFO, `Что-то заставило меня телепортироваться`)\n  }\n\n  public playerTeleported(): void {\n    this.addMessage(LogLevel.INFO, `Яркая вспышка и я оказался в другом месте`)\n  }\n\n  public playerNotTeleported(): void {\n    this.addMessage(\n      LogLevel.INFO,\n      `Я озарился ярким светом, но ничего не произошло`\n    )\n  }\n\n  public playerTeleportedWhereTheyWere(): void {\n    this.addMessage(LogLevel.INFO, `Я решил никуда не телепортироваться`)\n  }\n\n  public playerDodgesTeleportationTrap(): void {\n    this.addMessage(\n      LogLevel.INFO,\n      `Я попал в ловушку телепортации но смог увернуться`\n    )\n  }\n\n  public lightTrapActivated(\n    player: Player,\n    sees: boolean,\n    isPlayer: boolean,\n    actor: Creature\n  ): void {\n    if (isPlayer) {\n      this.addMessage(LogLevel.INFO, `Яркая вспышка света ослепила меня`)\n    } else {\n      this.addMessage(\n        LogLevel.INFO,\n        `${actor.name} озарился яркой вспышкой света`\n      )\n    }\n  }\n\n  public lightTrapDodge(\n    player: Player,\n    sees: boolean,\n    isPlayer: boolean,\n    actor: Creature\n  ): void {\n    if (isPlayer) {\n      this.addMessage(LogLevel.INFO, `Вспышка света чуть не ослепила меня`)\n    } else {\n      this.addMessage(\n        LogLevel.INFO,\n        `${actor.name} озарился яркой вспышкой света`\n      )\n    }\n  }\n\n  public canNotUntrap(): void {\n    this.addMessage(LogLevel.INFO, `Не представляю, как это обезвредить`)\n  }\n\n  public failedToUntrap(player: Player): void {\n    this.addMessage(\n      LogLevel.WARNING,\n      `У меня не получилось обезвредить ловушку`\n    )\n  }\n\n  public succeededToUntrap(player: Player): void {\n    this.addMessage(LogLevel.INFO, `Успешно обезвредил ловушку`)\n  }\n\n  public pickedUpItem(item: Item, count: number): void {\n    if (count === 1) {\n      this.addMessage(LogLevel.INFO, `You picked up ${item.name}`)\n    } else {\n      this.addMessage(LogLevel.INFO, `You picked up ${count} ${item.name}`)\n    }\n  }\n\n  public droppedItem(item: Item, count: number): void {\n    if (count === 1) {\n      this.addMessage(LogLevel.INFO, `You dropped a ${item.name}`)\n    } else {\n      this.addMessage(LogLevel.INFO, `You dropped ${count} ${item.name}`)\n    }\n  }\n\n  public waterTrapActivated(): void {\n    this.info(`Я попал в ловушку с водой`)\n  }\n\n  public waterBodyPartEquipmentResist(bodyPart: BodyPart, item: Item): void {\n    this.debug(`${item.name} защитил ${bodyPart.name} от воды`)\n  }\n\n  public waterBodyPartDamage(bodyPart: BodyPart, reaction: Reaction): void {\n    switch (reaction) {\n      case Reaction.DIE:\n        this.danger(\n          `Вода попала мне на ${bodyPart.name}, рана не совместима с жизнью`\n        )\n        break\n      case Reaction.HURT:\n        this.danger(`Вода обожгла мне ${bodyPart.name}`)\n        break\n      case Reaction.NOTHING:\n      case Reaction.RESIST:\n        this.danger(`Вода попала мне на ${bodyPart.name}, но все обошлось`)\n        break\n    }\n  }\n\n  public waterTrapDamage(\n    player: Player,\n    sees: boolean,\n    isPlayer: boolean,\n    reaction: Reaction,\n    creature: Creature\n  ): void {\n    if (!sees) {\n      return\n    }\n\n    switch (reaction) {\n      case Reaction.DIE:\n        this.danger(`${creature.name} растворился в потоках воды`)\n        break\n      case Reaction.DODGE:\n        this.info(`${creature.name} уклонился от потока воды`)\n        break\n      case Reaction.HURT:\n        this.warning(`${creature.name} пострадал от воды`)\n        break\n      case Reaction.NOTHING:\n      case Reaction.RESIST:\n        if (!isPlayer) {\n          this.debug(`${creature.name} был облит водой`)\n        }\n        break\n    }\n  }\n\n  public itemCorrode(item: Item): void {\n    switch (item.corrosionLevel) {\n      case CorrosionLevel.Slightly:\n        return this.info(`${item.name} немного заржавел`)\n      case CorrosionLevel.Mostly:\n        return this.info(`${item.name} значительно проржавел`)\n      case CorrosionLevel.Fully:\n        return this.warning(`${item.name} полностью проржавел`)\n    }\n  }\n\n  public itemDestroyByWater(item: Item, count: number): void {\n    this.warning(`${count} ${item.name} были уничтожены водой`)\n  }\n\n  public debug(message: string): void {\n    this.addMessage(LogLevel.DEBUG, message)\n  }\n\n  public info(message: string): void {\n    this.addMessage(LogLevel.INFO, message)\n  }\n\n  public warning(message: string): void {\n    this.addMessage(LogLevel.WARNING, message)\n  }\n\n  public danger(message: string): void {\n    this.addMessage(LogLevel.DANGER, message)\n  }\n\n  protected addMessage(level: LogLevel, message: string): void {\n    const lastRow: LogMessage | undefined = last(this.messages)\n\n    if (lastRow && lastRow.message === message) {\n      lastRow.counter += 1\n    } else {\n      this.messages.push({ level, message, counter: 1 })\n    }\n  }\n}\n\nclass SubLogger {\n  constructor(private logger: Logger, protected player: Player) {}\n\n  protected debug(message: string): void {\n    this.logger.debug(message)\n  }\n\n  protected info(message: string): void {\n    this.logger.info(message)\n  }\n\n  protected warning(message: string): void {\n    this.logger.warning(message)\n  }\n\n  protected danger(message: string): void {\n    this.logger.danger(message)\n  }\n}\n\nclass TrapAirBlowLogger extends SubLogger {\n  public dodge(sees: boolean, isPlayer: boolean, creature: Creature): void {\n    if (isPlayer) {\n      this.info(`Я увернулся от потока воздуха`)\n    } else if (sees) {\n      this.info(`${creature.name} увернулся от потока воздуха`)\n    }\n  }\n\n  public resist(sees: boolean, isPlayer: boolean, creature: Creature): void {\n    if (isPlayer) {\n      this.debug('Поток воздуха чуть не снес меня')\n    } else if (sees) {\n      this.debug(`${creature.name} попал в поток воздуха`)\n    }\n  }\n\n  public activate(sees: boolean, isPlayer: boolean, creature: Creature): void {\n    if (isPlayer) {\n      this.info('Меня снесло потоком воздуха')\n    } else if (sees) {\n      this.info(`${creature.name} снесло потоком воздуха`)\n    }\n  }\n\n  public handBlow(item: Item): void {\n    this.warning(`Поток воздуха выбил ${item.name} у меня из руки`)\n  }\n\n  public headBlow(item: Item): void {\n    this.warning(`Поток воздуха снял ${item.name} с моей головы`)\n  }\n}\n\nclass TrapHoleLogger extends SubLogger {\n  public dodge(sees: boolean, isPlayer: boolean, creature: Creature): void {\n    if (isPlayer) {\n      this.warning(`Я чуть не упал в яму`)\n    } else if (sees) {\n      this.warning(`${creature.name} чуть не упал в яму`)\n    }\n  }\n\n  public activated(sees: boolean, isPlayer: boolean, creature: Creature): void {\n    if (isPlayer) {\n      this.warning(`Я упал в яму`)\n    } else if (sees) {\n      this.warning(`${creature.name} упал в яму`)\n    }\n  }\n\n  public shallowActivated(\n    sees: boolean,\n    isPlayer: boolean,\n    creature: Creature\n  ): void {\n    if (isPlayer) {\n      this.warning(`Я упал в неглубокую яму`)\n    } else if (sees) {\n      this.warning(`${creature.name} упал в неглубокую яму`)\n    }\n  }\n}\n\nclass TrapBareWireLogger extends SubLogger {\n  public activated(\n    sees: boolean,\n    reaction: Reaction,\n    creature: Creature\n  ): void {\n    // TODO: Better messages\n    this.info(`${creature.name} наступил на оголенный провод`)\n  }\n\n  public doNotWant() {\n    this.info('Трогать оголенный провод руками так себе затея')\n  }\n\n  public resist(): void {\n    this.info('Я наступил на оголенный провод, но все обошлось')\n  }\n}\n\nclass TrapFallingRockLogger extends SubLogger {\n  public resist(player: Player): void {\n    // TODO: Different messages when head is firm or item if firm\n    return this.info('Камень упал мне на голову, но каска защитила меня')\n  }\n\n  public ranOut(): void {\n    return this.debug('Громкий щелчок, но ничего не произошло')\n  }\n\n  public dodge(\n    player: Player,\n    sees: boolean,\n    isPlayer: boolean,\n    actor: Creature\n  ): void {\n    this.info(`${actor.name} увернулся от ловушки`)\n  }\n\n  public activate(\n    player: Player,\n    sees: boolean,\n    isPlayer: boolean,\n    reaction: Reaction,\n    actor: Creature\n  ): void {\n    this.info(`${actor.name} попал в ловушку`)\n  }\n}\n","import { Game } from './game'\n\nexport enum TalentStatus {\n  Available,\n  Completed,\n  Unavailable,\n}\n\nexport abstract class Talent {\n  constructor(\n    public readonly id: number,\n    public readonly name: string,\n    public readonly depth: number,\n    public rank: number,\n    public readonly maxRank: number,\n    public readonly description: string\n  ) {}\n\n  public abstract onObtain(game: Game): void\n}\n","import { PresenterType } from './internal'\n\nimport { LevelMap, Game, IdlePresenter } from '../../engine'\nimport { PickPointPresenter } from './pick_point_presenter'\n\nexport enum LookPresenterVisibility {\n  See,\n  Recall,\n  Hidden,\n}\n\nexport class LookPresenter extends PickPointPresenter<\n  LookPresenterVisibility,\n  string\n> {\n  constructor(levelMap: LevelMap, game: Game) {\n    super(PresenterType.Look, levelMap, game, '_', target =>\n      this.memory.inRange(target)\n    )\n  }\n\n  get title(): LookPresenterVisibility {\n    if (this.memoryTile.visible) {\n      return LookPresenterVisibility.See\n    } else if (this.memoryTile.seen) {\n      return LookPresenterVisibility.Recall\n    } else {\n      return LookPresenterVisibility.Hidden\n    }\n  }\n\n  get body(): string[] {\n    let messages = []\n\n    if (this.memoryTile.creature) {\n      if (this.memoryTile.creature.id === this.player.id) {\n        messages.push('Это я')\n      } else {\n        messages.push(`Это ${this.memoryTile.creature.name}`)\n      }\n    }\n\n    if (this.memoryTile.items) {\n      switch (this.memoryTile.items.bunch.length) {\n        case 0:\n          break\n        case 1:\n          messages.push(`Лежит ${this.memoryTile.items.bunch[0].item.name}`)\n          break\n        default:\n          messages.push('Лежит несколько предметов')\n      }\n    }\n\n    return messages\n  }\n\n  protected close(): void {\n    this.redirect(new IdlePresenter(this.levelMap, this.game))\n  }\n}\n","export class Level {\n  public current: number = 1\n  public currentExperience: number = 0\n  public requiredExperience: number\n\n  private doneLeveling: boolean = false\n\n  constructor(private requires: number[]) {\n    this.requiredExperience = this.requires[0]\n  }\n\n  public add(exp: number): number[] {\n    if (this.doneLeveling) {\n      return []\n    }\n\n    this.currentExperience += exp\n\n    let levelUps = []\n\n    while (\n      !this.doneLeveling &&\n      this.currentExperience >= this.requiredExperience\n    ) {\n      this.levelUp()\n      levelUps.push(this.current)\n    }\n\n    return levelUps\n  }\n\n  protected levelUp(): void {\n    this.current += 1\n\n    let level = this.requires[this.current - 1]\n\n    if (level) {\n      this.currentExperience -= this.requiredExperience\n      this.requiredExperience = level\n    } else {\n      this.currentExperience = this.requiredExperience\n      this.doneLeveling = true\n    }\n  }\n}\n","import { random } from 'lodash'\n\nexport class Pool<Input, Output> {\n  private totalWeight: number = 0\n  private items: [number, (input: Input) => Output][] = []\n\n  constructor(items: [number, (input: Input) => Output][]) {\n    items.forEach(([weight, item]) => this.add(weight, item))\n  }\n\n  public add(weight: number, item: (input: Input) => Output): void {\n    if (weight < 1) {\n      throw `Item's weight is lower than 1`\n    }\n\n    this.items.push([weight, item])\n    this.totalWeight += Math.ceil(weight)\n  }\n\n  public pick(input: Input): Output {\n    if (this.items.length === 0) {\n      throw 'Tried to use empty pool'\n    }\n\n    let pick = random(this.totalWeight)\n\n    const found = this.items.find(([weight, item]) => {\n      pick -= weight\n\n      return pick <= 0\n    })\n\n    if (found !== undefined) {\n      return found[1](input)\n    }\n\n    throw 'Pool failed to pick anything'\n  }\n\n  public merge(pool: Pool<Input, Output>): Pool<Input, Output> {\n    let totalPool = new Pool<Input, Output>([])\n\n    this.items.forEach(([weight, item]) => totalPool.add(weight, item))\n    pool.items.forEach(([weight, item]) => totalPool.add(weight, item))\n\n    return totalPool\n  }\n}\n","import {\n  forEach,\n  keys,\n  min,\n  remove,\n  size,\n  pullAt,\n  pickBy,\n  includes,\n} from 'lodash'\n\nexport class Timeline<T> {\n  public step: number = 0\n  public turns: { [key: number]: T[] } = {}\n\n  public add(item: T, delta: number): void {\n    const ts = this.step + delta\n\n    if (this.turns[ts]) {\n      if (!includes(this.turns[ts], item)) {\n        this.turns[ts].push(item)\n      }\n    } else {\n      this.turns[ts] = [item]\n    }\n  }\n\n  public remove(item: T): void {\n    forEach(this.turns, (value, key) => {\n      remove(value, element => element === item)\n    })\n\n    this.turns = pickBy(this.turns, (val: T[]) => val.length > 0)\n  }\n\n  public next(): T {\n    this.step = this.nextStep()\n\n    const [element] = pullAt(this.turns[this.step], 0)\n\n    if (this.turns[this.step].length === 0) {\n      delete this.turns[this.step]\n    }\n\n    return element === undefined ? this.next() : element\n  }\n\n  public actors(): T[] {\n    if (size(this.turns) === 0) {\n      return []\n    }\n\n    this.step = this.nextStep()\n    const actors = this.turns[this.step]\n\n    delete this.turns[this.step]\n\n    return actors\n  }\n\n  private nextStep(): number {\n    let step = min(keys(this.turns).map(x => parseInt(x)))\n\n    if (step === undefined) {\n      throw 'Timeline.nextStep called when there is no ones turn'\n    }\n\n    return step\n  }\n}\n","import { withMatchingTile } from '../generator/post'\nimport { StairwayDown, StairwayUp, Tile } from './tile'\nimport { LevelMap } from './level_map'\nimport { Game } from './game'\nimport { Player } from './player'\n\nexport abstract class Dungeon {\n  protected levels: LevelMap[] = []\n\n  constructor() {}\n  public abstract enter(game: Game, player: Player): void\n  public abstract register(game: Game): void\n\n  protected addStairDown(map: LevelMap, adjustMapName: string): LevelMap {\n    return this.addStairs(map, new StairwayDown(map, adjustMapName))\n  }\n\n  protected addStairUp(map: LevelMap, adjustMapName: string): LevelMap {\n    return this.addStairs(map, new StairwayUp(map, adjustMapName))\n  }\n\n  private addStairs(map: LevelMap, tile: Tile): LevelMap {\n    withMatchingTile(\n      map,\n      tile => tile.free(),\n      (x, y) => {\n        map.setTile(x, y, tile)\n      }\n    )\n\n    return map\n  }\n}\n","import { Creature, CreatureId } from './creature'\nimport { Mapped, Point } from '../utils/utils'\nimport { Timeline } from '../lib/timeline'\nimport { Tile, StairwayDown, StairwayUp } from './tile'\n\nimport { remove } from 'lodash'\n\nexport class LevelMap extends Mapped<Tile> {\n  public creatures: Creature[] = []\n  public timeline: Timeline<CreatureId>\n\n  constructor(public readonly name: string, map: Tile[][]) {\n    super(map)\n    this.timeline = new Timeline()\n  }\n\n  public reset(): void {\n    this.timeline = new Timeline()\n  }\n\n  public enter(): void {\n    this.reset()\n    this.creatures.forEach(creature =>\n      this.timeline.add(creature.id, creature.speed)\n    )\n  }\n\n  public creatureTile(creature: Creature): Tile {\n    let tile: Tile | undefined\n\n    this.each(t => {\n      if (t.creature && t.creature.id === creature.id) {\n        tile = t\n      }\n    })\n\n    if (!tile) {\n      throw `Creature ${creature.id} ${creature.name} is not found on map ${\n        this.name\n      }`\n    }\n\n    return tile\n  }\n\n  public creaturePos(creature: Creature): Point {\n    let pos: Point | undefined\n\n    this.each((tile, x, y) => {\n      if (tile.creature && tile.creature.id === creature.id) {\n        pos = new Point(x, y)\n      }\n    })\n\n    if (!pos) {\n      throw `Creature ${creature.id} ${creature.name} is not found on map ${\n        this.name\n      }`\n    }\n\n    return pos\n  }\n\n  public addCreature(pos: Point, creature: Creature) {\n    this.creatures.push(creature)\n    // TODO fail if taken\n    this.at(pos.x, pos.y).creature = creature\n    this.timeline.add(creature.id, creature.speed)\n  }\n\n  public removeCreature(creature: Creature) {\n    let pos = this.creaturePos(creature),\n      tile = this.at(pos.x, pos.y)\n\n    tile.creature = undefined\n    remove(this.creatures, c => c.id === creature.id)\n    this.timeline.remove(creature.id)\n  }\n\n  public visibleThrough(x: number, y: number): boolean {\n    return this.map[x][y].visibleThrough()\n  }\n\n  public passibleThrough(x: number, y: number): boolean {\n    return this.map[x][y].passibleThrough()\n  }\n\n  public setTile(x: number, y: number, tile: Tile): void {\n    this.map[x][y] = tile\n  }\n\n  public matchStairs(adjustName: string): Point {\n    let stairPos: Point | undefined\n\n    this.each((tile, x, y) => {\n      if (tile instanceof StairwayDown || tile instanceof StairwayUp) {\n        if (tile.adjacentMapName === adjustName) {\n          stairPos = new Point(x, y)\n        }\n      }\n    })\n\n    if (stairPos) {\n      return stairPos\n    }\n\n    throw `LevelMap ${this.name} failed to find stairs to ${adjustName}`\n  }\n}\n","import { ProfessionPicker } from './profession'\nimport { TileEffect } from './tile_effect'\nimport { LevelMap } from './level_map'\nimport { Logger } from './logger'\nimport { Player } from './player'\n\ntype MapGenerator = (name: string, game: Game) => LevelMap\n\nexport class Game {\n  public logger: Logger\n  public currentMap: LevelMap | undefined\n  public playerTurn: boolean = false\n  public running: boolean = false\n  public effect: TileEffect | null = null\n\n  protected maps: Map<string, LevelMap | MapGenerator> = new Map()\n\n  constructor(\n    public player: Player,\n    public professionPicker: ProfessionPicker\n  ) {\n    this.logger = new Logger(player)\n  }\n\n  public turn(): void {\n    if (this.running || (this.player.ai.presenter && !this.effect)) {\n      return\n    }\n    this.running = true\n\n    this.mutexTurn()\n\n    this.running = false\n  }\n\n  protected mutexTurn(): void {\n    if (this.player.ai.runEvents()) {\n      return\n    }\n\n    if (!this.currentMap) {\n      throw 'mutexTurn: Map is undefined'\n    }\n\n    if (this.effect) {\n      this.player.rebuildVision(this.currentMap)\n      this.effect.patchMemory(this.player.stageMemory(this.currentMap))\n\n      if (this.effect.done()) {\n        this.effect.onDone()\n        this.effect = null\n      }\n    } else {\n      while (!this.player.dead && !this.playerTurn) {\n        this.levelMapTurn()\n      }\n\n      this.player.rebuildVision(this.currentMap)\n    }\n  }\n\n  public getMap(name: string): LevelMap {\n    const levelMap = this.maps.get(name)\n\n    if (!levelMap) {\n      throw `Map ${name} is not found`\n    }\n\n    if (levelMap instanceof LevelMap) {\n      return levelMap\n    } else if (levelMap instanceof Function) {\n      const builtLevelMap = levelMap(name, this)\n      this.maps.set(name, builtLevelMap)\n      return builtLevelMap\n    } else {\n      throw `LevelMap with id ${name} is not found`\n    }\n  }\n\n  public addMap(name: string, generator: MapGenerator): void {\n    // TODO: Raise if presence\n    this.maps.set(name, generator)\n  }\n\n  private levelMapTurn(): void {\n    // TODO: Remove!!!\n    if (!this.currentMap) {\n      throw 'levelMapTurn: Map is undefined'\n    }\n\n    let timeline = this.currentMap.timeline,\n      map = this.currentMap\n\n    const actorId = timeline.next()\n\n    if (actorId === undefined) {\n      throw 'Timeline event is empty!'\n    }\n\n    const actor = map.creatures.find(creature => actorId === creature.id)\n\n    if (actor) {\n      const speed = actor.act(map, this)\n\n      // If they are still on a map\n      if (speed && map.creatures.find(creature => actorId === creature.id)) {\n        timeline.add(actorId, speed)\n      }\n    }\n  }\n}\n","import { Usage, Item, Missile, Weapon } from './item'\nimport { intersection } from 'lodash'\nimport { Inventory } from './inventory'\nimport { GroupedItem } from '../lib/bunch'\nimport { Material } from '../../engine'\n\nexport abstract class InventorySlot<Equipment extends Item = Item> {\n  public name: string = 'InventorySlot'\n\n  constructor(\n    // What kind of items can be put in slot\n    public readonly usages: Usage[],\n    // Has to put only a single item or can put a bunch of them\n    public readonly useSingleItem: boolean,\n    public equipment?: GroupedItem<Equipment>\n  ) {}\n\n  public matchingItems(inventory: Inventory): GroupedItem<Item>[] {\n    return inventory.cares().filter(itemGroup => this.match(itemGroup.item))\n  }\n\n  get insulator(): boolean {\n    return !!(this.equipment && this.equipment.item.insulator)\n  }\n\n  get firm(): boolean {\n    return !!(this.equipment && this.equipment.item.firm)\n  }\n\n  public equip(item: Equipment, count: number) {\n    if (this.equipment) {\n      throw `Slot ${this.name} is already equipped with ${this.equipment.item}`\n    }\n\n    this.equipment = { count, item }\n  }\n\n  public takeOff(): void {\n    if (!this.equipment) {\n      throw `Slot ${this.name} has nothing to take off`\n    }\n\n    this.equipment = undefined\n  }\n\n  protected match(item: Item): boolean {\n    return intersection(item.usages, this.usages).length > 0\n  }\n\n  protected withPairItem(\n    baseMatch: GroupedItem<Item>[],\n    item: Item\n  ): GroupedItem<Item>[] {\n    return baseMatch.filter(groupedItem => groupedItem.item.worksWith(item))\n  }\n}\n\nexport abstract class BodyPart<\n  Equipment extends Item = Item\n> extends InventorySlot<Equipment> {\n  public abstract material: Material\n\n  get affectedWithWater(): boolean {\n    return this.material.affectedWithWater !== undefined\n  }\n}\n\nexport class RightHandSlot extends BodyPart<Weapon> {\n  public name: string = 'Правая рука'\n  constructor(public material: Material) {\n    super([Usage.WeaponOneHand], true)\n  }\n}\n\nexport class LeftHandSlot extends BodyPart<Weapon> {\n  public name: string = 'Левая рука'\n  constructor(public material: Material) {\n    super([Usage.WeaponOneHand], true)\n  }\n}\n\nexport class HeadSlot extends BodyPart {\n  public name: string = 'Голова'\n  constructor(public material: Material) {\n    super([Usage.WearsOnHead], true)\n  }\n}\n\nexport class ChestSlot extends BodyPart {\n  public name: string = 'Корпус'\n  constructor(public material: Material) {\n    super([Usage.WearsOnBody], true)\n  }\n}\n\nexport class BootsSlot extends BodyPart {\n  public name: string = 'Ботинки'\n  constructor(public material: Material) {\n    super([Usage.Boots], true)\n  }\n}\n\nexport class GlovesSlot extends InventorySlot {\n  public name: string = 'Перчатки'\n  constructor() {\n    super([Usage.Gloves], true)\n  }\n}\n\nexport class GauntletsSlot extends InventorySlot {\n  public name: string = 'Наручи'\n  constructor() {\n    super([Usage.Gauntlets], true)\n  }\n}\n\nexport class BeltSlot extends InventorySlot {\n  public name: string = 'Пояс'\n  constructor() {\n    super([Usage.Belt], true)\n  }\n}\n\nexport class AmuletSlot extends InventorySlot {\n  public name: string = 'Амулет'\n  constructor() {\n    super([Usage.Amulet], true)\n  }\n}\n\nexport class LeftFingerSlot extends InventorySlot {\n  public name: string = 'Левый палец'\n  constructor() {\n    super([Usage.Ring], true)\n  }\n}\n\nexport class RightFingerSlot extends InventorySlot {\n  public name: string = 'Правый палец'\n  constructor() {\n    super([Usage.Ring], true)\n  }\n}\n\nexport class CloakSlot extends InventorySlot {\n  public name: string = 'Плащ'\n  constructor() {\n    super([Usage.Cloak], true)\n  }\n}\n\nexport class MissileWeaponSlot extends InventorySlot<Weapon> {\n  public name: string = 'Метательное'\n  constructor() {\n    super([Usage.Shoot], true)\n  }\n\n  public matchingItems(inventory: Inventory): GroupedItem<Item>[] {\n    let baseMatch = super.matchingItems(inventory),\n      missile = inventory.missileSlot.equipment\n\n    if (missile) {\n      return this.withPairItem(baseMatch, missile.item)\n    }\n\n    return baseMatch\n  }\n}\n\nexport class MissileSlot extends InventorySlot<Missile> {\n  public name: string = 'Снаряды'\n  constructor() {\n    super([Usage.Throw], false)\n  }\n\n  public matchingItems(inventory: Inventory): GroupedItem<Item>[] {\n    let baseMatch = inventory.cares(),\n      missileWeapon = inventory.missileWeaponSlot.equipment\n\n    if (missileWeapon) {\n      return this.withPairItem(baseMatch, missileWeapon.item)\n    }\n\n    return baseMatch\n  }\n}\n\nexport class ToolsSlot extends InventorySlot {\n  public name: string = 'Инструмент'\n  constructor() {\n    super([Usage.Tool], true)\n  }\n}\n","import {\n  InventorySlot,\n  RightHandSlot,\n  LeftHandSlot,\n  ChestSlot,\n  MissileWeaponSlot,\n  MissileSlot,\n  BootsSlot,\n  HeadSlot,\n  AmuletSlot,\n  LeftFingerSlot,\n  RightFingerSlot,\n  GlovesSlot,\n  GauntletsSlot,\n  BeltSlot,\n  ToolsSlot,\n  CloakSlot,\n  BodyPart,\n} from './inventory_slot'\nimport { Item } from './item'\nimport { ItemsBunch, GroupedItem } from '../lib/bunch'\nimport { concat, compact } from 'lodash'\nimport { Material } from '../lib/material'\n\nexport class Inventory {\n  private bag: ItemsBunch<Item> = new ItemsBunch()\n\n  public headSlot = new HeadSlot(Material.flesh)\n  public amuletSlot = new AmuletSlot()\n  public cloakSlot = new CloakSlot()\n  public chestSlot = new ChestSlot(Material.flesh)\n  public rightHandSlot = new RightHandSlot(Material.flesh)\n  public leftHandSlot = new LeftHandSlot(Material.flesh)\n  public leftFingerSlot = new LeftFingerSlot()\n  public rightFingerSlot = new RightFingerSlot()\n  public glovesSlot = new GlovesSlot()\n  public gauntletsSlot = new GauntletsSlot()\n  public beltSlot = new BeltSlot()\n  public bootsSlot = new BootsSlot(Material.flesh)\n  public missileWeaponSlot = new MissileWeaponSlot()\n  public missileSlot = new MissileSlot()\n  public toolsSlot = new ToolsSlot()\n\n  get bodyParts(): BodyPart[] {\n    return [\n      this.headSlot,\n      this.rightHandSlot,\n      this.leftHandSlot,\n      this.chestSlot,\n      this.bootsSlot,\n    ]\n  }\n\n  public slots(): InventorySlot[] {\n    return [\n      this.headSlot,\n      this.amuletSlot,\n      this.cloakSlot,\n      this.chestSlot,\n      this.rightHandSlot,\n      this.leftHandSlot,\n      this.leftFingerSlot,\n      this.rightFingerSlot,\n      this.glovesSlot,\n      this.gauntletsSlot,\n      this.beltSlot,\n      this.bootsSlot,\n      this.missileWeaponSlot,\n      this.missileSlot,\n      this.toolsSlot,\n    ]\n  }\n\n  get allItems(): GroupedItem<Item>[] {\n    return concat(\n      this.cares(),\n      compact(this.slots().map(slot => slot.equipment))\n    )\n  }\n\n  get unarmoredSlotsCount(): number {\n    return [\n      this.headSlot,\n      this.chestSlot,\n      this.glovesSlot,\n      this.gauntletsSlot,\n      this.beltSlot,\n      this.bootsSlot,\n    ].filter((slot: InventorySlot) => !slot.equipment).length\n  }\n\n  public cares(): GroupedItem<Item>[] {\n    return this.bag.bunch\n  }\n\n  public findInBag(item: Item): GroupedItem<Item> | undefined {\n    return this.bag.find(item)\n  }\n\n  public putToBag(item: Item, count: number): void {\n    this.bag.put(item, count)\n  }\n\n  public removeFromBag(item: Item, count: number): void {\n    this.bag.remove(item, count)\n  }\n}\n","import { Tile, Wall, TileVisitor } from './tile'\nimport { Creature, twoDimArray, ItemsBunch } from '../../engine'\nimport { Mapped } from '../utils/utils'\nimport { Item } from './item'\n\nexport class MemoryTile {\n  public visible: boolean = false\n  public degree: number = 0\n  public seen: boolean = false\n  public effect?: string\n\n  constructor(public tile: Tile) {}\n\n  get items(): ItemsBunch<Item> | undefined {\n    return this.tile.items\n  }\n\n  get creature(): Creature | undefined {\n    return this.tile.creature\n  }\n\n  public see(tile: Tile, degree: number) {\n    this.visible = true\n    this.degree = degree\n    this.seen = true\n    this.tile = tile.clone()\n  }\n\n  public tangible(actor?: Creature): boolean {\n    return this.seen && !this.tile.passibleThrough(actor)\n  }\n\n  public reset(): void {\n    this.visible = false\n    this.effect = undefined\n    this.tile.creature = undefined\n  }\n\n  public visit(tileVisitor: TileVisitor): void {\n    this.tile.visit(tileVisitor)\n  }\n}\n\nexport class Memory extends Mapped<MemoryTile> {\n  constructor(width: number, height: number) {\n    const baseTile = new Wall()\n    super(twoDimArray(width, height, () => new MemoryTile(baseTile)))\n  }\n\n  public resetVisible(): void {\n    this.each(tile => tile.reset())\n  }\n}\n","import { sortBy } from 'lodash'\n\nexport class KillStat {\n  public total: number = 0\n  private stat: Map<string, number> = new Map()\n\n  public add(name: string): void {\n    const current = this.stat.get(name)\n    if (current) {\n      this.stat.set(name, current + 1)\n    } else {\n      this.stat.set(name, 1)\n    }\n  }\n\n  get all(): [string, number][] {\n    return sortBy(Array.from(this.stat), ([name, count]) => name)\n  }\n}\n","import { concat, cloneDeep, sumBy } from 'lodash'\nimport { Game, GroupedItem, Inventory, LevelMap, PlayerAI } from '../../engine'\nimport { AfterEvent } from '../events/after_event'\nimport { CreatureEvent } from '../events/internal'\nimport { Level } from '../lib/level'\nimport {\n  CapacityLimitStat,\n  Stat,\n  StrengthStat,\n  DexterityStat,\n  ConstitutionStat,\n} from '../lib/stat'\nimport { Item, Missile, Protection, ProtectionType } from './item'\nimport { Damage } from '../lib/damage'\nimport { Profession } from './profession'\nimport { Specie, Resistance } from './specie'\nimport { Creature, Reaction } from './creature'\nimport { KillStat } from '../utils/kill_stat'\n\nexport class Player extends Creature {\n  public professions: Profession[] = []\n  public inventory: Inventory = new Inventory()\n\n  public itemsProtections: Protection[] = []\n  public itemsResistances: Resistance[] = []\n\n  public stuffWeight: Stat\n  public carryingCapacity: CapacityLimitStat\n\n  public killStat: KillStat = new KillStat()\n\n  // Main attributes\n  public strength: StrengthStat\n  public dexterity: DexterityStat\n  public constitution: ConstitutionStat\n  public intelligence: Stat\n  public wisdom: Stat\n  public charisma: Stat\n\n  constructor(\n    public level: Level,\n    public ai: PlayerAI,\n    specie: Specie,\n    strengthValue: number,\n    dexterityValue: number,\n    constitutionValue: number\n  ) {\n    super(specie)\n\n    this.strength = new StrengthStat(strengthValue)\n    this.dexterity = new DexterityStat(dexterityValue)\n    this.constitution = new ConstitutionStat(constitutionValue)\n    this.intelligence = new Stat(10)\n    this.wisdom = new Stat(2)\n    this.charisma = new Stat(2)\n\n    this.stuffWeight = new Stat(0)\n    this.carryingCapacity = new CapacityLimitStat(\n      this.strength.current,\n      this.constitution.current\n    )\n  }\n\n  public act(levelMap: LevelMap, game: Game): number {\n    this.statsTurn()\n    this.visionMask(levelMap)\n\n    const command = this.ai.act(this, levelMap, game)\n    if (command) {\n      this.on(command)\n    }\n    this.on(new AfterEvent(levelMap, game))\n\n    return this.speed\n  }\n\n  public rebuildVision(levelMap: LevelMap): void {\n    this.visionMask(levelMap)\n  }\n\n  public on(event: CreatureEvent): Reaction {\n    return event.affectPlayer(this)\n  }\n\n  get missile(): GroupedItem<Missile> | undefined {\n    // TODO: Validate item on slot\n    return this.inventory.missileSlot.equipment\n  }\n\n  get inventoryItems(): GroupedItem<Item>[] {\n    return this.inventory.allItems\n  }\n\n  public addItem(item: Item, count: number): void {\n    this.inventory.putToBag(item, count)\n  }\n\n  public removeItem(item: Item, count: number): void {\n    this.inventory.removeFromBag(item, count)\n  }\n\n  get weightWithCarryings(): number {\n    return (\n      this.specie.weight +\n      sumBy(this.inventory.allItems, ({ item, count }) => item.weight * count)\n    )\n  }\n\n  get bodyControl(): number {\n    return this.specie.bodyControl + this.dexterity.bodyControlAdjustment\n  }\n\n  get throwDamages(): Damage[] {\n    const dexterityAdjustment = this.dexterity.missileAdjustment\n\n    return concat(this.specie.throwingDamages, this.missileItemsDamages()).map(\n      (damage: Damage) => {\n        let dmg = cloneDeep(damage)\n        dmg.extra += dexterityAdjustment\n        return dmg\n      }\n    )\n  }\n\n  get damages(): Damage[] {\n    const strengthAdjustment = this.strength.meleeAdjustment\n\n    return concat(this.specie.damages, this.meleeItemsDamages()).map(\n      (damage: Damage) => {\n        let dmg = cloneDeep(damage)\n        dmg.extra += strengthAdjustment\n        return dmg\n      }\n    )\n  }\n\n  get protections(): Protection[] {\n    const perEmptySlotArmor = 1\n    return concat(this.specie.protections, this.itemsProtections, [\n      {\n        type: ProtectionType.Unarmored,\n        value: perEmptySlotArmor * this.inventory.unarmoredSlotsCount,\n      },\n    ])\n  }\n\n  get resistances(): Resistance[] {\n    return concat(this.specie.resistances, this.itemsResistances)\n  }\n\n  protected meleeItemsDamages(): Damage[] {\n    const rightHandEq = this.inventory.rightHandSlot.equipment,\n      leftHandEq = this.inventory.leftHandSlot.equipment\n\n    // TODO: Default damage\n    return concat(\n      rightHandEq ? rightHandEq.item.damages : [],\n      leftHandEq ? leftHandEq.item.damages : []\n    )\n  }\n\n  protected missileItemsDamages(): Damage[] {\n    const missileEq = this.inventory.missileSlot.equipment,\n      missileWeaponEq = this.inventory.missileWeaponSlot.equipment\n\n    // TODO: Default damage\n    return concat(\n      // Can throw literally anything, so damage might be undefined\n      missileEq ? missileEq.item.damages || [] : [],\n      missileWeaponEq ? missileWeaponEq.item.damages : []\n    )\n  }\n}\n","import { Player } from './player'\n\nimport { includes, sample } from 'lodash'\nimport { Talent } from './talent'\n\nexport class Profession {\n  public talents: Talent[] = []\n  public readonly depthCost: number = 3\n\n  constructor(\n    public readonly id: number,\n    public readonly name: string,\n    public level: number = 1,\n    public points: number = 0\n  ) {}\n}\n\nexport class ProfessionPicker {\n  constructor(\n    private pool: Profession[],\n    private maxLevel: number,\n    private maxTaken: number\n  ) {}\n\n  public available(player: Player): Profession[] {\n    let professions: Profession[] = []\n    let pickedProfession: Profession | undefined\n\n    if (this.canUpdate(player)) {\n      pickedProfession = this.updatableProfession(player)\n    } else if (this.canTakeNewProfession(player)) {\n      pickedProfession = this.newFromPool(player)\n    }\n\n    if (pickedProfession !== undefined) {\n      professions.push(pickedProfession)\n    }\n\n    if (this.canTakeNewProfession(player)) {\n      pickedProfession = this.newFromPool(\n        player,\n        pickedProfession && pickedProfession.id\n      )\n    } else if (this.canUpdate(player)) {\n      pickedProfession = this.updatableProfession(\n        player,\n        pickedProfession && pickedProfession.id\n      )\n    }\n\n    if (pickedProfession !== undefined) {\n      professions.push(pickedProfession)\n    }\n\n    return professions\n  }\n\n  protected canUpdate(player: Player): boolean {\n    return player.professions.some(\n      profession => profession.level < this.maxLevel\n    )\n  }\n\n  protected updatableProfession(\n    player: Player,\n    excludeId: number | undefined = undefined\n  ): Profession | undefined {\n    return sample(\n      player.professions.filter(profession => {\n        return excludeId !== profession.id\n      })\n    )\n  }\n\n  protected canTakeNewProfession(player: Player): boolean {\n    return (\n      player.professions.length < this.maxTaken &&\n      this.pool.length > player.professions.length\n    )\n  }\n\n  protected newFromPool(\n    player: Player,\n    excludeId: number | undefined = undefined\n  ): Profession | undefined {\n    const excluding = player.professions.map(profession => profession.id)\n\n    if (excludeId !== undefined) {\n      excluding.push(excludeId)\n    }\n\n    return sample(\n      this.pool.filter(profession => !includes(excluding, profession.id))\n    )\n  }\n}\n","import { Game, GroupedItem, Item, LevelMap } from '../../engine'\nimport { Presenter, PresenterType } from './internal'\n\nexport abstract class ItemsListingPresenter extends Presenter {\n  public positions: GroupedItem<Item>[] = []\n\n  constructor(levelMap: LevelMap, game: Game) {\n    super(PresenterType.ItemsListing, levelMap, game)\n    this.initPositions()\n  }\n\n  abstract get title(): string\n  abstract get singleItemMode(): boolean\n\n  protected abstract initPositions(): void\n\n  public close(): void {\n    this.goIdle()\n  }\n}\n\nexport abstract class SingleItemUseListingPresenter extends ItemsListingPresenter {\n  get singleItemMode(): boolean {\n    return true\n  }\n\n  public abstract withItem(items: GroupedItem<Item>): void\n}\n\nexport abstract class MultipleItemUseListingPresenter extends ItemsListingPresenter {\n  get singleItemMode(): boolean {\n    return false\n  }\n\n  public abstract withItems(items: GroupedItem<Item>[]): void\n}\n","import { SingleItemUseListingPresenter } from './items_listing_presenter'\n\nexport class BagPresenter extends SingleItemUseListingPresenter {\n  public readonly title: string = 'Сумка'\n\n  protected initPositions(): void {\n    this.positions = this.player.inventory.cares()\n  }\n\n  public withItem(): void {\n    this.endTurn()\n  }\n}\n","import { DrinkPotionEvent, GroupedItem } from '../../engine'\nimport { ItemGroup, Potion } from '../models/item'\nimport { SingleItemUseListingPresenter } from './items_listing_presenter'\n\nexport class DrinkPresenter extends SingleItemUseListingPresenter {\n  public readonly title: string = 'Что выпить?'\n\n  protected initPositions(): void {\n    this.positions = this.player.inventory\n      .cares()\n      .filter(itemGroup => itemGroup.item.group === ItemGroup.Potion)\n  }\n\n  public withItem({ item }: GroupedItem<Potion>): void {\n    this.player.on(new DrinkPotionEvent(item, this.game))\n    this.endTurn()\n  }\n}\n","import { MultipleItemUseListingPresenter } from './items_listing_presenter'\nimport { GroupedItem } from '../lib/bunch'\nimport { Item } from '../models/item'\nimport { DropItemsEvent } from '../events/drop_items_event'\n\nexport class DropItemsPresenter extends MultipleItemUseListingPresenter {\n  public readonly title: string = 'Что положить?'\n\n  protected initPositions(): void {\n    this.positions = this.player.inventory.cares()\n  }\n\n  public withItems(items: GroupedItem<Item>[]): void {\n    if (items.length) {\n      this.player.on(new DropItemsEvent(this.tile, items, this.game))\n      this.endTurn()\n    } else {\n      this.goIdle()\n    }\n  }\n}\n","import { Presenter, PresenterType } from './internal'\nimport {\n  Game,\n  Item,\n  InventorySlot,\n  GroupedItem,\n  PutOnItemsPresenter,\n  PutOnItemEvent,\n  TakeOffItemEvent,\n  LevelMap,\n} from '../../engine'\nimport { IdlePresenter } from './idle_presenter'\n\nexport interface InventoryPresenterPosition {\n  inventorySlot: InventorySlot\n  item?: Item\n  count?: number\n  availableItems: GroupedItem<Item>[]\n}\n\nexport class InventoryPresenter extends Presenter {\n  public positions: InventoryPresenterPosition[] = []\n  private takeTime: boolean = false\n\n  constructor(levelMap: LevelMap, game: Game) {\n    super(PresenterType.Inventory, levelMap, game)\n    this.rebuildPositions()\n  }\n\n  public takeOff(position: InventoryPresenterPosition) {\n    this.player.on(new TakeOffItemEvent(position.inventorySlot, this.game))\n    this.takeTime = true\n    this.rebuildPositions()\n  }\n\n  public putOn(position: InventoryPresenterPosition) {\n    this.redirect(\n      new PutOnItemsPresenter(\n        itemGroup => {\n          this.player.on(\n            new PutOnItemEvent(\n              position.inventorySlot,\n              itemGroup.item,\n              this.game\n            )\n          )\n\n          this.takeTime = true\n          this.rebuildPositions()\n          this.redirect(this)\n        },\n        position.availableItems,\n        this.levelMap,\n        this.game\n      )\n    )\n  }\n\n  public close() {\n    if (this.takeTime) {\n      this.endTurn()\n    } else {\n      this.redirect(new IdlePresenter(this.levelMap, this.game))\n    }\n  }\n\n  private rebuildPositions(): void {\n    this.positions = this.player.inventory.slots().map(inventorySlot => {\n      return {\n        inventorySlot: inventorySlot,\n        item: inventorySlot.equipment && inventorySlot.equipment.item,\n        count: inventorySlot.equipment && inventorySlot.equipment.count,\n        availableItems: inventorySlot.matchingItems(this.player.inventory),\n      }\n    })\n  }\n}\n","import { Presenter, PresenterType } from './internal'\nimport { Point, bresenhamInclusion, Direction } from '../utils/utils'\nimport { Memory } from '../models/memory'\nimport { IdlePresenter } from './idle_presenter'\nimport { MissileAttackEvent, Game, LevelMap } from '../../engine'\n\nexport class MissilePresenter extends Presenter {\n  public targetPos: Point\n  private memory: Memory\n  private targetEnemyIndex: number | undefined = undefined\n  private enemies: Point[] = []\n  private path: Point[] = []\n\n  constructor(levelMap: LevelMap, game: Game) {\n    super(PresenterType.Missile, levelMap, game)\n\n    this.findEnemies()\n    this.memory = this.player.stageMemory(this.levelMap)\n    this.targetPos = this.resetTargetId()\n  }\n\n  public nextTarget(): void {\n    if (this.targetEnemyIndex === undefined) {\n      this.resetTargetId()\n      return\n    }\n\n    this.targetEnemyIndex += 1\n\n    if (this.targetEnemyIndex >= this.enemies.length) {\n      this.targetEnemyIndex = 0\n    }\n\n    this.updateTarget(this.enemies[this.targetEnemyIndex])\n  }\n\n  public previousTarget(): void {\n    if (this.targetEnemyIndex === undefined) {\n      this.resetTargetId()\n      return\n    }\n\n    this.targetEnemyIndex -= 1\n\n    if (this.targetEnemyIndex < 0) {\n      this.targetEnemyIndex = this.enemies.length - 1\n    }\n\n    this.updateTarget(this.enemies[this.targetEnemyIndex])\n  }\n\n  public moveTarget(direction: Direction): void {\n    const dest = this.targetPos.add(direction),\n      tile = this.levelMap.at(dest.x, dest.y)\n\n    if (\n      tile.visibleThrough() &&\n      this.player.stageMemory(this.levelMap).at(dest.x, dest.y).visible\n    ) {\n      this.updateTarget(dest)\n      this.targetEnemyIndex = undefined\n    }\n  }\n\n  public attack(): void {\n    if (!this.targetPos.eq(this.levelMap.creaturePos(this.player))) {\n      this.player.on(\n        new MissileAttackEvent(this.path, this.game, this.levelMap, () =>\n          this.endTurn()\n        )\n      )\n    }\n  }\n\n  public close(): void {\n    this.resetPath()\n    this.redirect(new IdlePresenter(this.levelMap, this.game))\n  }\n\n  private resetTargetId(): Point {\n    let point: Point\n\n    if (this.enemies.length) {\n      this.targetEnemyIndex = 0\n      point = this.enemies[this.targetEnemyIndex]\n    } else {\n      this.targetEnemyIndex = undefined\n      point = this.levelMap.creaturePos(this.player)\n    }\n\n    this.updateTarget(point)\n    return point\n  }\n\n  private resetPath(): void {\n    this.path.forEach(({ x, y }) => (this.memory.at(x, y).effect = undefined))\n  }\n\n  private updateTarget(newPos: Point): void {\n    this.resetPath()\n    this.targetPos = newPos.copy()\n    this.drawPath()\n  }\n\n  private drawPath(): void {\n    this.path = []\n    let stop = false\n    const stage = this.levelMap,\n      pos = this.levelMap.creaturePos(this.player)\n\n    bresenhamInclusion(pos, this.targetPos, (x, y) => {\n      if (!stage.at(x, y).passibleThrough()) {\n        stop = true\n      }\n\n      this.path.push(new Point(x, y))\n      this.memory.at(x, y).effect = stop ? 'o' : 'x'\n    })\n  }\n\n  private findEnemies(): void {\n    this.enemies = []\n\n    this.player.stageMemory(this.levelMap).each((tile, x, y) => {\n      if (\n        tile.visible &&\n        tile.creature &&\n        tile.creature.id !== this.player.id\n      ) {\n        this.enemies.push(new Point(x, y))\n      }\n    })\n  }\n}\n","import { Presenter, PresenterType } from './internal'\nimport { LevelMap } from '../models/level_map'\nimport { Game } from '../models/game'\n\nexport class PickSingleOptionPresenter<Option> extends Presenter {\n  constructor(\n    public options: Option[],\n    levelMap: LevelMap,\n    game: Game,\n    private withOption: (option: Option) => void\n  ) {\n    super(PresenterType.PickHandleOption, levelMap, game)\n  }\n\n  public pick(option: Option): void {\n    this.withOption(option)\n  }\n\n  public close(): void {\n    this.goIdle()\n  }\n}\n","import { Presenter, PresenterType } from './internal'\nimport {\n  Game,\n  Direction,\n  DropItemsPresenter,\n  DrinkPresenter,\n  BagPresenter,\n  AttackEvent,\n  PickUpItemsEvent,\n  PickUpPresenter,\n  TileVisitor,\n  Stairway,\n  LevelMap,\n  LookPresenter,\n  UntrapEvent,\n  Point,\n} from '../../engine'\nimport { InventoryPresenter } from './inventory_presenter'\nimport { MissilePresenter } from './missile_presenter'\nimport { MoveEvent } from '../events/move_event'\nimport { CreatureEvent } from '../events/internal'\nimport { concat } from 'lodash'\nimport { Trap } from '../models/tile'\nimport { PickSingleOptionPresenter } from './pick_single_option_presenter'\nimport { StayEvent } from '../events/stay_event'\n\nclass HandleTileVisitor extends TileVisitor {\n  // TODO: Add direction since commands might duplicate\n  public commands: [string, CreatureEvent][] = []\n\n  constructor(\n    public position: Point,\n    private game: Game,\n    private levelMap: LevelMap\n  ) {\n    super()\n  }\n\n  protected onStairway(stairway: Stairway): void {\n    const adjacentMap = this.game.getMap(stairway.adjacentMapName)\n\n    this.commands.push([\n      'stairway',\n      new MoveEvent(\n        this.game,\n        this.levelMap,\n        stairway.enterPos(this.levelMap, adjacentMap),\n        adjacentMap\n      ),\n    ])\n  }\n\n  public onTrap(trap: Trap): void {\n    if (!trap.revealed) {\n      return\n    }\n\n    this.commands.push([\n      'untrap',\n      new UntrapEvent(this.position, trap, this.levelMap, this.game),\n    ])\n  }\n}\n\nclass AdjustHandleTileVisitor extends HandleTileVisitor {\n  protected onStairway(): void {}\n}\n\nexport class IdlePresenter extends Presenter {\n  constructor(levelMap: LevelMap, game: Game) {\n    super(PresenterType.Idle, levelMap, game)\n  }\n\n  public inventoryCommand(): void {\n    this.redirect(new InventoryPresenter(this.levelMap, this.game))\n  }\n\n  public bagCommand(): void {\n    this.redirect(new BagPresenter(this.levelMap, this.game))\n  }\n\n  public stayCommand(): void {\n    this.player.on(new StayEvent(this.levelMap))\n    this.endTurn()\n  }\n\n  public dropCommand(): void {\n    this.redirect(new DropItemsPresenter(this.levelMap, this.game))\n  }\n\n  public drinkCommand(): void {\n    this.redirect(new DrinkPresenter(this.levelMap, this.game))\n  }\n\n  public lookCommand(): void {\n    this.redirect(new LookPresenter(this.levelMap, this.game))\n  }\n\n  public move(direction: Direction): void {\n    const pos = this.levelMap.creaturePos(this.player),\n      dest = pos.add(direction),\n      tile = this.levelMap.at(dest.x, dest.y)\n\n    if (tile.passibleThrough(this.player)) {\n      this.player.on(new MoveEvent(this.game, this.levelMap, dest))\n    } else if (tile.creature) {\n      this.player.on(new AttackEvent(tile.creature, this.levelMap, this.game))\n    } else {\n      this.game.logger.ranIntoAnObstacle()\n      this.player\n        .stageMemory(this.levelMap)\n        .at(dest.x, dest.y)\n        .see(tile, 0)\n    }\n\n    this.endTurn()\n  }\n\n  public pickUpCommand(): void {\n    const tile = this.tile,\n      items = tile.items\n\n    if (items === undefined || items.bunch.length === 0) {\n      this.game.logger.noItemsToPickUp()\n    } else if (items.bunch.length === 1) {\n      this.player.on(new PickUpItemsEvent(tile, items.bunch, this.game))\n      this.endTurn()\n    } else {\n      this.redirect(new PickUpPresenter(this.levelMap, this.game))\n    }\n  }\n\n  public missileCommand(): void {\n    const missile = this.player.inventory.missileSlot.equipment\n\n    if (missile && missile.item) {\n      if (missile.item.canThrow(this.player)) {\n        this.redirect(new MissilePresenter(this.levelMap, this.game))\n      } else {\n        this.game.logger.needMissileWeapon()\n      }\n    } else {\n      this.game.logger.nothingToShotWith()\n    }\n  }\n\n  public handleCommand(): void {\n    let pos = this.levelMap.creaturePos(this.player),\n      visitor = new HandleTileVisitor(pos, this.game, this.levelMap),\n      adjustVisitor = new AdjustHandleTileVisitor(pos, this.game, this.levelMap)\n\n    this.tile.visit(visitor)\n\n    pos.wrappers().forEach((point: Point) => {\n      adjustVisitor.position = point\n      this.levelMap.at(point.x, point.y).visit(adjustVisitor)\n    })\n\n    const commands = concat(visitor.commands, adjustVisitor.commands)\n\n    switch (commands.length) {\n      case 0:\n        this.game.logger.howToHandle()\n        break\n      case 1:\n        this.player.on(commands[0][1])\n        this.endTurn()\n        break\n      default:\n        this.redirect(\n          new PickSingleOptionPresenter(\n            commands,\n            this.levelMap,\n            this.game,\n            ([name, command]) => {\n              this.player.on(command)\n              this.endTurn()\n            }\n          )\n        )\n    }\n  }\n}\n","import { Presenter, PresenterType } from './internal'\nimport { Memory, MemoryTile } from '../models/memory'\nimport { Point, Direction } from '../utils/utils'\nimport { Game } from '../models/game'\nimport { LevelMap } from '../models/level_map'\n\nexport abstract class PickPointPresenter<Title, Body> extends Presenter {\n  public targetPos: Point\n  protected memory: Memory\n\n  constructor(\n    type: PresenterType,\n    levelMap: LevelMap,\n    game: Game,\n    private effect: string,\n    private match: (point: Point) => boolean\n  ) {\n    super(type, levelMap, game)\n\n    this.memory = this.player.stageMemory(this.levelMap)\n    this.targetPos = levelMap.creaturePos(this.player)\n    this.drawTarget()\n  }\n\n  abstract get title(): Title\n\n  abstract get body(): Body[]\n\n  protected abstract close(): void\n\n  public act(): void {\n    this.removeEffect()\n    this.close()\n  }\n\n  get memoryTile(): MemoryTile {\n    return this.memory.at(this.targetPos.x, this.targetPos.y)\n  }\n\n  public moveTarget(direction: Direction): void {\n    const dest = this.targetPos.add(direction)\n\n    if (this.match(dest)) {\n      this.updateTarget(dest)\n    }\n  }\n\n  private removeEffect(): void {\n    this.memory.at(this.targetPos.x, this.targetPos.y).effect = undefined\n  }\n\n  private updateTarget(newPos: Point): void {\n    this.removeEffect()\n    this.targetPos = newPos.copy()\n    this.drawTarget()\n  }\n\n  private drawTarget(): void {\n    this.memoryTile.effect = this.effect\n  }\n}\n","import { Presenter, PresenterType } from './internal'\nimport { Game, LevelMap, Talent, TalentStatus } from '../../engine'\nimport { Profession } from '../models/profession'\nimport { LevelUpEvent } from '../events/level_up_event'\n\ninterface TalentWithStatus extends Talent {\n  status: TalentStatus\n}\n\ninterface TalentsTreePresenterProfession {\n  profession: Profession\n  talents: TalentWithStatus[]\n}\n\nexport class TalentsTreePresenter extends Presenter {\n  public readonly options: TalentsTreePresenterProfession[] = []\n\n  constructor(public readonly level: number, levelMap: LevelMap, game: Game) {\n    super(PresenterType.AbilitiesPicking, levelMap, game)\n\n    this.options = this.player.professions.map(profession => {\n      return {\n        profession,\n        talents: profession.talents.map(talent => {\n          return Object.assign({}, talent, {\n            status: this.status(talent, profession),\n          })\n        }),\n      }\n    })\n  }\n\n  get title(): string {\n    return 'Pick new talent'\n  }\n\n  public pickTalent(professionId: number, talentId: number): void {\n    const profession: Profession | undefined = this.player.professions.find(\n      profession => profession.id === professionId\n    )\n\n    if (profession === undefined) {\n      throw `Profession with id ${professionId} is not found`\n    }\n\n    let talent: Talent | undefined = profession.talents.find(\n      talent => talent.id === talentId\n    )\n\n    if (talent === undefined) {\n      throw `Talent with id ${talentId} for profession ${\n        profession.name\n      } is not found`\n    }\n\n    if (this.status(talent, profession) !== TalentStatus.Available) {\n      throw `Talent with id ${talentId} for profession ${\n        profession.name\n      } can not be upgraded`\n    }\n\n    talent.rank += 1\n    if (talent.rank === 1) {\n      talent.onObtain(this.game)\n    }\n\n    profession.points += 1\n\n    this.player.on(new LevelUpEvent())\n\n    this.endTurn()\n  }\n\n  private status(talent: Talent, profession: Profession): TalentStatus {\n    if (talent.rank === talent.maxRank) {\n      return TalentStatus.Completed\n    } else if (talent.depth * profession.depthCost > profession.points) {\n      return TalentStatus.Unavailable\n    } else {\n      return TalentStatus.Available\n    }\n  }\n}\n","import {\n  Item,\n  PickUpItemsEvent,\n  MultipleItemUseListingPresenter,\n} from '../../engine'\nimport { GroupedItem } from '../lib/bunch'\n\nexport class PickUpPresenter extends MultipleItemUseListingPresenter {\n  public readonly title: string = 'Что поднять?'\n\n  protected initPositions(): void {\n    const items = this.tile.items\n\n    if (items === undefined) {\n      throw `Failed to show pick up dialog - tile has no items`\n    }\n\n    this.positions = items.bunch.map(itemGroup => {\n      return { item: itemGroup.item, count: itemGroup.count }\n    })\n  }\n\n  public withItems(items: GroupedItem<Item>[]): void {\n    // TODO: Validate items are part of positions\n    this.player.on(new PickUpItemsEvent(this.tile, items, this.game))\n    this.endTurn()\n  }\n}\n","import { PresenterType, Presenter } from './internal'\nimport { Profession } from '../models/profession'\nimport { TalentsTreePresenter } from './talents_tree_presenter'\nimport { Game, LevelMap } from '../../engine'\n\nexport class ProfessionPickingPresenter extends Presenter {\n  constructor(public readonly level: number, levelMap: LevelMap, game: Game) {\n    super(PresenterType.ProfessionPicking, levelMap, game)\n  }\n\n  get title(): string {\n    return `Gained ${this.level} level`\n  }\n\n  get options(): Profession[] {\n    return this.game.professionPicker.available(this.player)\n  }\n\n  public pickProfession(pickedProfession: Profession) {\n    let playerProfession = this.player.professions.find(\n      profession => profession.id === pickedProfession.id\n    )\n\n    if (playerProfession) {\n      playerProfession.level += 1\n    } else {\n      this.player.professions.push(pickedProfession)\n    }\n\n    this.redirect(\n      new TalentsTreePresenter(this.level, this.levelMap, this.game)\n    )\n  }\n}\n","import { GroupedItem } from '../lib/bunch'\nimport { SingleItemUseListingPresenter } from './items_listing_presenter'\nimport { Item } from '../models/item'\nimport { LevelMap } from '../models/level_map'\nimport { Game } from '../models/game'\nimport { InventoryPresenter } from './inventory_presenter'\n\nexport class PutOnItemsPresenter extends SingleItemUseListingPresenter {\n  public readonly title: string = 'Что надеть?'\n\n  constructor(\n    private onWithItem: (itemGroup: GroupedItem<Item>) => void,\n    public positions: GroupedItem<Item>[],\n    levelMap: LevelMap,\n    game: Game\n  ) {\n    super(levelMap, game)\n  }\n\n  protected initPositions(): void {}\n\n  public withItem(itemGroup: GroupedItem<Item>): void {\n    this.onWithItem(itemGroup)\n  }\n\n  public close(): void {\n    this.redirect(new InventoryPresenter(this.levelMap, this.game))\n  }\n}\n","import { Point, twoDimArray, Mapped } from './utils'\n\nimport { sample } from 'lodash'\n\nconst FIRST_STEP: number = 1\n\nexport const leePath = function<Tile>(\n  map: Mapped<Tile>,\n  pos: Point,\n  tangible: (tile: Tile) => boolean,\n  destination: (point: Point, tile: Tile) => boolean,\n  randomDestination: boolean = false\n): Point[] {\n  let stageMemory: number[][] = twoDimArray(map.width, map.height, () => -1)\n  let pointsToVisit: Point[] = []\n  let pointsToCheck: Point[] = [pos]\n\n  let step = 0\n  while (pointsToCheck.length && !pointsToVisit.length) {\n    let wavePoints: Point[] = []\n\n    pointsToCheck.forEach((point: Point) => {\n      if (!map.inRange(point)) {\n        return\n      }\n\n      const tile = map.at(point.x, point.y)\n      // TODO: Compare, current value might be lower\n      if (tangible(tile) || stageMemory[point.x][point.y] !== -1) {\n        return\n      }\n\n      stageMemory[point.x][point.y] = step\n      if (destination(point, tile)) {\n        pointsToVisit.push(point)\n      } else {\n        point.wrappers().forEach(dist => wavePoints.push(dist))\n      }\n    })\n    step++\n\n    pointsToCheck = wavePoints\n  }\n\n  if (pointsToVisit.length) {\n    // TODO: Remove this check\n    let randomPointToVisit = sample(pointsToVisit)\n    if (randomDestination && randomPointToVisit) {\n      return buildRoad(randomPointToVisit, stageMemory)\n    } else {\n      return buildRoad(pointsToVisit[0], stageMemory)\n    }\n  } else {\n    return []\n  }\n}\n\nconst buildRoad = function(point: Point, stageMemory: number[][]): Point[] {\n  let lastPoint = point\n  let chain = [lastPoint]\n\n  let delta: Point | undefined\n\n  while (stageMemory[lastPoint.x][lastPoint.y] !== FIRST_STEP) {\n    delta = Point.dxy.find(\n      (dp): boolean => {\n        return (\n          stageMemory[lastPoint.x + dp.x] &&\n          stageMemory[lastPoint.x + dp.x][lastPoint.y + dp.y] ===\n            stageMemory[lastPoint.x][lastPoint.y] - 1\n        )\n      }\n    )\n\n    if (delta === undefined) {\n      return []\n    }\n\n    lastPoint = lastPoint.add(delta)\n\n    chain.unshift(lastPoint)\n  }\n\n  return chain\n}\n","import { Talent, Game } from '../engine'\n\n// TODO: Validate all Talent's ids are uniq\nexport enum OnisunTalentId {\n  AttackerTwoHandedWeapons,\n  AttackerHeavyWeapons,\n  AttackerLightWeapons,\n  AttackerTwoWeapons,\n  AttackerDoubleTwoHandedWeapons,\n  AttackerStrongGrip,\n}\n\nexport abstract class OnisunTalent extends Talent {\n  constructor(\n    id: number,\n    name: string,\n    depth: number,\n    rank: number,\n    maxRank: number,\n    description: string = ''\n  ) {\n    super(id, name, depth, rank, maxRank, description)\n  }\n}\n\nexport class AttackerTwoHandedWeapons extends OnisunTalent {\n  constructor() {\n    super(OnisunTalentId.AttackerTwoHandedWeapons, 'Двуручные оружия', 0, 0, 3)\n  }\n\n  public onObtain(game: Game): void {}\n}\n\nexport class AttackerLightWeapons extends OnisunTalent {\n  constructor() {\n    super(OnisunTalentId.AttackerLightWeapons, 'Легкие оружия', 0, 0, 3)\n  }\n\n  public onObtain(game: Game): void {}\n}\n\nexport class AttackerHeavyWeapons extends OnisunTalent {\n  constructor() {\n    super(OnisunTalentId.AttackerHeavyWeapons, 'Тяжелые оружия', 0, 0, 3)\n  }\n\n  public onObtain(game: Game): void {}\n}\n\nexport class AttackerTwoWeapons extends OnisunTalent {\n  constructor() {\n    super(\n      OnisunTalentId.AttackerTwoWeapons,\n      'Два оружия',\n      1,\n      0,\n      1,\n      'Позволяет брать оружие в каждую руку'\n    )\n  }\n\n  public onObtain(game: Game): void {}\n}\n\nexport class AttackerDoubleTwoHandedWeapons extends OnisunTalent {\n  constructor() {\n    super(\n      OnisunTalentId.AttackerDoubleTwoHandedWeapons,\n      'Два двуручных оружия',\n      2,\n      0,\n      2\n    )\n  }\n\n  public onObtain(game: Game): void {}\n}\n\nexport class AttackerStrongGrip extends OnisunTalent {\n  constructor() {\n    super(\n      OnisunTalentId.AttackerStrongGrip,\n      'Крепкий хват',\n      2,\n      0,\n      2,\n      'Оружие не выбивается из рук'\n    )\n  }\n\n  public onObtain(game: Game): void {}\n}\n","import { ProfessionPicker, Profession, Player } from '../engine'\nimport { AttackerTwoHandedWeapons } from './talents'\n\nenum OnisunProfessionId {\n  Attacker,\n  Defender,\n}\n\nexport class OnisunAttackerProfession extends Profession {\n  constructor(level: number = 1) {\n    super(OnisunProfessionId.Attacker, 'Оружейник', level)\n\n    this.talents.push(new AttackerTwoHandedWeapons())\n  }\n}\n\nexport class OnisunDefenderProfession extends Profession {\n  constructor(level: number = 1) {\n    super(OnisunProfessionId.Defender, 'Защитник', level)\n  }\n}\n\nexport class OnisunProfessionPicker extends ProfessionPicker {\n  constructor(\n    player: Player,\n    public attacker = new OnisunAttackerProfession(),\n    public defender = new OnisunDefenderProfession()\n  ) {\n    super([attacker, defender], 3, 6)\n  }\n}\n","import {\n  BodyArmor,\n  Boots,\n  DamageType,\n  ImpactType,\n  Item,\n  Missile,\n  MissileWeapon,\n  OneHandWeapon,\n  Player,\n  Pool,\n  ProtectionType,\n} from '../engine'\nimport { HealPotion } from './potions'\nimport { Material } from '../engine/lib/material'\n\nclass MissileRock extends Missile {\n  public worksWith(item: Item): boolean {\n    return item instanceof Sling\n  }\n}\n\nclass Arrow extends Missile {\n  public worksWith(item: Item): boolean {\n    return item instanceof Bow\n  }\n\n  public canThrow(player: Player): boolean {\n    return !!player.inventory.missileWeaponSlot.equipment\n  }\n}\n\nclass Sling extends MissileWeapon {\n  public worksWith(item: Item): boolean {\n    return item instanceof MissileRock\n  }\n}\n\nclass Bow extends MissileWeapon {\n  public worksWith(item: Item): boolean {\n    return item instanceof Arrow\n  }\n}\n\nexport const commonBow = () =>\n  new Bow(\n    'Обычный лук',\n    1,\n    [{ type: DamageType.Pierce, dice: { times: 1, max: 3 }, extra: 3 }],\n    Material.wood\n  )\n\nexport const smallRock = () =>\n  new MissileRock(\n    'Маленький камень',\n    0.3,\n    [{ type: DamageType.Blunt, dice: { times: 1, max: 3 }, extra: 2 }],\n    Material.stone\n  )\n\nexport const woodenArrow = () =>\n  new Arrow(\n    'Деревянная стрела',\n    0.2,\n    [{ type: DamageType.Pierce, dice: { times: 1, max: 4 }, extra: 3 }],\n    Material.wood\n  )\nexport const ironArrow = () =>\n  new Arrow(\n    'Железная стрела',\n    0.25,\n    [{ type: DamageType.Pierce, dice: { times: 2, max: 3 }, extra: 3 }],\n    Material.iron\n  )\n\nexport const weapons = new Pool<null, Item>([\n  [\n    1,\n    () =>\n      new OneHandWeapon('Катана', 1, Material.iron, [\n        { type: DamageType.Melee, dice: { times: 5, max: 2 }, extra: 0 },\n      ]),\n  ],\n  [\n    7,\n    () =>\n      new OneHandWeapon('Кинжал', 0.8, Material.iron, [\n        { type: DamageType.Melee, dice: { times: 1, max: 3 }, extra: 2 },\n      ]),\n  ],\n])\n\nexport const itemsPool = new Pool<null, Item>([\n  [\n    1,\n    () =>\n      new BodyArmor('Кольчуга', 5, Material.iron, [\n        { type: ProtectionType.Medium, value: 3 },\n      ]),\n  ],\n  [\n    5,\n    () =>\n      new BodyArmor('Латы', 3, Material.iron, [\n        { type: ProtectionType.Heavy, value: 5 },\n      ]),\n  ],\n  [\n    10,\n    () =>\n      new BodyArmor('Роба', 1, Material.iron, [\n        { type: ProtectionType.Unarmored, value: 1 },\n      ]),\n  ],\n  [100, () => new HealPotion()],\n])\n\nexport class LightSpeedBoots extends Boots {\n  public impacts: ImpactType[] = [ImpactType.Blind]\n\n  constructor() {\n    super('Кроссовки скорости света', 0.1, Material.cloth, [])\n  }\n}\n","import { Game, Potion } from '../engine'\n\nexport class HealPotion extends Potion {\n  constructor() {\n    super('Зелье лечения')\n  }\n\n  public onDrink(game: Game) {\n    game.player.health.increase(5)\n  }\n}\n","import {\n  MetaAI,\n  Escaper,\n  Explorer,\n  Chaser,\n  Attacker,\n  Picker,\n  Patrol,\n  Loiter,\n  Thrower,\n  Descender,\n  Creature,\n  LevelMap,\n  Game,\n  CreatureEvent,\n  SelfHealer,\n} from '../engine'\n\nexport class Dispatcher extends MetaAI {\n  private escaper: Escaper\n  private explorer: Explorer\n  private chaser: Chaser\n  private attacker: Attacker\n  private picker: Picker\n  private patrol: Patrol\n  private loiter: Loiter\n  private thrower: Thrower\n\n  private descender: Descender\n\n  constructor() {\n    super()\n    this.escaper = new Escaper()\n    this.explorer = new Explorer()\n    this.chaser = new Chaser()\n    this.attacker = new Attacker()\n    this.picker = new Picker()\n    this.patrol = new Patrol()\n    this.loiter = new Loiter()\n    this.thrower = new Thrower()\n\n    this.descender = new Descender()\n  }\n\n  public act(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    this.runEvents()\n    let event: CreatureEvent | undefined\n\n    if (this.feelsGood(actor)) {\n      if ((event = this.attacker.act(actor, levelMap, game))) {\n      } else if ((event = this.thrower.act(actor, levelMap, game))) {\n      } else if ((event = this.chaser.act(actor, levelMap, game))) {\n      } else if ((event = this.picker.act(actor, levelMap, game))) {\n      } else {\n        event = this.explore(actor, levelMap, game)\n      }\n    } else if (\n      this.healthCritical(actor) &&\n      (event = this.escaper.act(actor, levelMap, game))\n    ) {\n    } else if ((event = this.attacker.act(actor, levelMap, game))) {\n    } else if ((event = this.thrower.act(actor, levelMap, game))) {\n    } else if ((event = this.chaser.act(actor, levelMap, game))) {\n    } else {\n      event = new SelfHealer().act(actor, levelMap)\n    }\n\n    this.resetEvents()\n\n    return event\n  }\n\n  private feelsGood(actor: Creature): boolean {\n    return actor.health.currentValue > actor.health.maximum * 0.9\n  }\n\n  private healthCritical(actor: Creature): boolean {\n    return actor.health.currentValue < actor.health.maximum / 4\n  }\n\n  private explore(\n    actor: Creature,\n    levelMap: LevelMap,\n    game: Game\n  ): CreatureEvent | undefined {\n    let event: CreatureEvent | undefined\n\n    if ((event = this.explorer.act(actor, levelMap, game))) {\n      if (!actor.dead) {\n        this.patrol.trackMovement(\n          levelMap.creaturePos(actor),\n          levelMap.creatureTile(actor)\n        )\n      }\n    } else if ((event = this.descender.act(actor, levelMap, game))) {\n    } else if ((event = this.patrol.act(actor, levelMap, game))) {\n    } else {\n      event = this.loiter.act(actor, levelMap, game)\n    }\n\n    return event\n  }\n}\n","import {\n  Creature,\n  Clan,\n  Pool,\n  AICreature,\n  DamageType,\n  Protection,\n  ProtectionType,\n  Damage,\n} from '../engine'\nimport { Dispatcher } from './ai'\nimport { Material } from '../engine/lib/material'\n\nconst newCreature = (\n  name: string,\n  protections: Protection[] = [],\n  damages: Damage[]\n) => {\n  return new AICreature(new Dispatcher(), {\n    name: name,\n    weight: 10,\n    clan: Clan.PlayerOnlyEnemy,\n    abilities: [],\n    protections: protections,\n    damages: damages,\n\n    maxHealthValue: 1,\n    regenerationRate: 5,\n    regenerationValue: 1,\n\n    resistances: [],\n    visionRadius: 5,\n\n    moveSpeed: 20,\n    attackSpeed: 20,\n    bodyControl: 5,\n\n    leavesCorpseRatio: 50,\n    material: Material.flesh,\n\n    throwingDamages: [],\n  })\n}\n\nexport const rat = () => {\n  return newCreature(\n    'Rat',\n    [],\n    [{ type: DamageType.Melee, dice: { times: 2, max: 2 }, extra: 0 }]\n  )\n}\n\nexport const golem = () => {\n  return newCreature(\n    'Golem',\n    [{ type: ProtectionType.Solid, value: 5 }],\n    [{ type: DamageType.Blunt, dice: { times: 1, max: 5 }, extra: 10 }]\n  )\n}\n\nexport const creaturesPool1 = new Pool<null, Creature>([[100, rat], [3, golem]])\n","import {\n  Corridor,\n  Door,\n  drawn,\n  Dungeon,\n  Floor,\n  LevelMap,\n  Point,\n  Tile,\n  TileTypes,\n  Wall,\n  Game,\n  Player,\n  StairwayDown,\n  StairwayUp,\n  LogMessageTrigger,\n  TeleportationTrap,\n  Room,\n  LightTrap,\n  HoleTrap,\n} from '../../engine'\nimport { rat, golem } from '../creatures'\nimport { BareWireTrap } from '../../engine/models/traps/bare_wire_trap'\nimport { FallingRockTrap } from '../../engine/models/traps/falling_rock_trap'\nimport { smallRock } from '../items'\nimport { WaterTrap } from '../../engine/models/traps/water_trap'\nimport { AirBlowTrap } from '../../engine/models/traps/air_blow_trap'\n\nconst tiles: Map<string, () => Tile> = new Map()\ntiles.set('C', () => new Corridor('C', TileTypes.Floor))\ntiles.set('W', () => new Wall())\ntiles.set('R', () => new Floor('R', TileTypes.Floor))\ntiles.set('D', () => new Door())\n\nconst trapsLevel = 'Traps',\n  secondLevel = '2nd'\n\nexport class TutorialDungeon extends Dungeon {\n  public enter(game: Game, player: Player): void {\n    const levelMap = (game.currentMap = game.getMap(trapsLevel))\n\n    levelMap.addCreature(new Point(3, 27), player)\n  }\n\n  public register(game: Game): void {\n    game.addMap(trapsLevel, (name, game) => {\n      let map = this.generateMap(name, [\n        'WWWWWWWWWWWWW',\n        'WWWWRRRWWWWWW',\n        'WWWWRRRWWWWWW',\n        'WWWWRRRWWWWWW',\n        'WWWWWCWWWWWWW',\n        'WRRRWCWRRRWWW',\n        'WRRRCCCRRRWWW',\n        'WRRRWCWRRRWWW',\n        'WWWWWCWWWWWWW',\n        'WRRRWCWRRRWWW',\n        'WRRRCCCRRRWWW',\n        'WRRRWCWRRRWWW',\n        'WWWWWCWWWWWWW',\n        'WRRRWCWRRRWWW',\n        'WRRRCCCRRRWWW',\n        'WRRRWCWRRRWWW',\n        'WWWWWCWWWWWWW',\n        'WRRRWCWRRRWWW',\n        'WRRRCCCRRRWWW',\n        'WRRRWCWRRRWWW',\n        'WWWWWCWWWWWWW',\n        'WRRRWCWRRRWWW',\n        'WRRRCCCRRRWWW',\n        'WRRRWCWRRRWWW',\n        'WWWWWCWWWWWWW',\n        'WWWWWCWRRRRRW',\n        'WRRRWCWRRRRRW',\n        'WRRRCCCRRRRRW',\n        'WRRRWCWRRRRRW',\n        'WWWWWCWRRRRRW',\n        'WWWWWWWWWWWWW',\n      ])\n\n      map.setTile(5, 2, new StairwayDown(map, secondLevel))\n\n      map.setTile(\n        4,\n        6,\n        new LogMessageTrigger('Teleportation trap', false, new Room())\n      )\n      map.setTile(2, 6, new TeleportationTrap(new Room()))\n\n      map.setTile(6, 6, new LogMessageTrigger('Light trap', false, new Room()))\n      map.setTile(8, 6, new LightTrap(new Room()))\n\n      map.setTile(4, 10, new LogMessageTrigger('Hole trap', false, new Room()))\n      map.setTile(2, 10, new HoleTrap(new Room()))\n\n      map.setTile(6, 10, new LogMessageTrigger('Bare wire', false, new Room()))\n      map.setTile(8, 10, new BareWireTrap(new Room()))\n\n      map.setTile(4, 14, new LogMessageTrigger('Water trap', false, new Room()))\n      map.setTile(2, 14, new WaterTrap(new Room()))\n\n      map.setTile(\n        6,\n        14,\n        new LogMessageTrigger('Falling rock trap', false, new Room())\n      )\n      map.setTile(8, 14, new FallingRockTrap(smallRock, new Room()))\n\n      map.setTile(\n        6,\n        27,\n        new LogMessageTrigger('Air blow trap', false, new Room())\n      )\n      map.setTile(9, 27, new AirBlowTrap(new Room()))\n\n      return map\n    })\n\n    game.addMap(secondLevel, (name, game) => {\n      let map = this.generateMap(name, [\n        'WWWWW',\n        'WRRRW',\n        'WRRRW',\n        'WRRRW',\n        'WWWWW',\n      ])\n\n      map.setTile(2, 1, new StairwayUp(map, trapsLevel))\n\n      map.addCreature(new Point(1, 1), golem())\n\n      return map\n    })\n  }\n\n  private generateMap(name: string, scheme: string[]): LevelMap {\n    let map = new LevelMap(name, drawn(scheme, tiles))\n    return map\n  }\n}\n","import {\n  addCreatures,\n  addDoors,\n  addItems,\n  withMatchingTile,\n  centralize,\n  Corridor,\n  Door,\n  drawn,\n  Dungeon,\n  dungeon,\n  Floor,\n  LevelMap,\n  Point,\n  Room,\n  Tile,\n  TileTypes,\n  Wall,\n  Game,\n  Player,\n} from '../../engine'\nimport { creaturesPool1 } from '../creatures'\n\nconst titleId: string = 'title'\n\nconst config = {\n  addDoors: false,\n  minSize: 3,\n  maxSize: 8,\n  roomsCount: 20,\n  addTraps: false,\n  width: 100,\n  height: 100,\n}\n\nconst tiles: Map<string, () => Tile> = new Map()\ntiles.set('C', () => new Corridor('C', TileTypes.Floor))\ntiles.set('W', () => new Wall())\ntiles.set('R', () => new Floor('R', TileTypes.Floor))\ntiles.set('D', () => new Door())\n\nexport class TitleDungeon extends Dungeon {\n  public enter(game: Game, player: Player): void {\n    const levelMap = (game.currentMap = game.getMap(titleId))\n\n    withMatchingTile(\n      levelMap,\n      tile => tile.isFloor() && tile.passibleThrough(),\n      (x, y) => {\n        levelMap.addCreature(new Point(x, y), player)\n      }\n    )\n  }\n\n  public register(game: Game): void {\n    game.addMap(titleId, (id, game) =>\n      addCreatures(0, this.generateMap(titleId), creaturesPool1)\n    )\n  }\n\n  private generateMap(name: string): LevelMap {\n    let map = new LevelMap(\n      name,\n      dungeon<Tile>(\n        config.width,\n        config.height,\n        config.minSize,\n        config.maxSize,\n        config.roomsCount,\n        () => new Room(),\n        () => new Corridor('C', TileTypes.Floor),\n        () => new Wall()\n      )\n    )\n\n    centralize(map)\n\n    // addItems(0.05, map, weapons.merge(itemsPool))\n\n    return map\n  }\n}\n","import {\n  Clan,\n  Player,\n  allAbilities,\n  OneHandWeapon,\n  Game,\n  Level,\n  PlayerAI,\n  PickUpItemsEvent,\n  DamageType,\n  BodyArmor,\n  ProtectionType,\n  PutOnItemEvent,\n  PlayerBorgAI,\n} from './engine'\n\nimport { OnisunProfessionPicker } from './onisun/professions'\nimport {\n  woodenArrow,\n  ironArrow,\n  commonBow,\n  smallRock,\n  LightSpeedBoots,\n} from './onisun/items'\nimport { TutorialDungeon } from './onisun/dungeons/tutorial_dungeon'\nimport { Material } from './engine/lib/material'\nimport { Scroll } from './engine/models/item'\nimport { TitleDungeon } from './onisun/dungeons/title_dungeon'\nimport { Dispatcher } from './onisun/ai'\n\nexport * from './engine'\nexport * from './onisun/ai'\nexport * from './onisun/professions'\nexport * from './onisun/talents'\nexport * from './onisun/items'\n\nexport class TmpApplication {\n  public game: Onisun\n  constructor() {\n    this.game = new Onisun(this.initPlayer())\n\n    const dungeon = new TutorialDungeon()\n    dungeon.register(this.game)\n    dungeon.enter(this.game, this.game.player)\n\n    const player = this.game.player,\n      prof = this.game.professionPicker.available(player)[1]\n\n    if (prof) {\n      player.professions.push(prof)\n    }\n\n    const dagger = new OneHandWeapon('Кинжал', 0.8, Material.iron, [\n      { type: DamageType.Melee, dice: { times: 1, max: 3 }, extra: 2 },\n    ])\n    const katana = new OneHandWeapon('Катана', 1, Material.iron, [\n      { type: DamageType.Melee, dice: { times: 5, max: 2 }, extra: 0 },\n    ])\n    const plateArmor = new BodyArmor('Латы', 1, Material.iron, [\n      { type: ProtectionType.Heavy, value: 5 },\n    ])\n    const scroll = new Scroll('Свиток ххх')\n\n    const wooden = woodenArrow()\n    const iron = ironArrow()\n    const rock = smallRock()\n\n    const bow = commonBow()\n\n    if (this.game.currentMap) {\n      const tile = this.game.currentMap.creatureTile(player)\n\n      tile.addItem(dagger, 2)\n      tile.addItem(katana, 1)\n      tile.addItem(plateArmor, 1)\n      tile.addItem(wooden, 5)\n      tile.addItem(iron, 5)\n      tile.addItem(rock, 5)\n      tile.addItem(bow, 2)\n      tile.addItem(scroll, 20)\n\n      player.on(\n        new PickUpItemsEvent(\n          tile,\n          [\n            { item: dagger, count: 2 },\n            { item: katana, count: 1 },\n            { item: plateArmor, count: 1 },\n            { item: wooden, count: 5 },\n            { item: iron, count: 5 },\n            { item: rock, count: 5 },\n            { item: bow, count: 2 },\n            { item: scroll, count: 20 },\n          ],\n          this.game\n        )\n      )\n\n      player.on(\n        new PutOnItemEvent(player.inventory.missileWeaponSlot, bow, this.game)\n      )\n      player.on(\n        new PutOnItemEvent(player.inventory.missileSlot, wooden, this.game)\n      )\n      player.on(\n        new PutOnItemEvent(player.inventory.rightHandSlot, katana, this.game)\n      )\n      player.on(\n        new PutOnItemEvent(player.inventory.chestSlot, plateArmor, this.game)\n      )\n\n      player.addItem(new LightSpeedBoots(), 1)\n\n      this.game.logger.reset()\n    }\n  }\n\n  protected initPlayer(): Player {\n    return new Player(\n      new Level([1, 3, 5, 10, 20]),\n      new PlayerAI(),\n      {\n        name: 'Player',\n        weight: 80,\n        clan: Clan.Player,\n        abilities: allAbilities,\n        protections: [],\n        damages: [],\n        maxHealthValue: 10,\n        regenerationRate: 30,\n        regenerationValue: 1,\n        resistances: [],\n        visionRadius: 10,\n        moveSpeed: 20,\n        attackSpeed: 20,\n        bodyControl: 5,\n        leavesCorpseRatio: 0,\n        material: Material.flesh,\n        throwingDamages: [],\n      },\n      12,\n      12,\n      15\n    )\n  }\n}\n\nexport class Onisun extends Game {\n  constructor(player: Player) {\n    super(player, new OnisunProfessionPicker(player))\n  }\n}\n\nexport class TitleGame extends Game {\n  private turns = 0\n\n  public turn(): void {\n    super.turn()\n\n    if (this.currentMap && this.playerTurn) {\n      this.turns += 1\n      this.player.ai.endTurn(this, this.currentMap)\n    }\n  }\n\n  get done(): boolean {\n    return this.player.dead || this.turns > 150\n  }\n}\n\nexport class Application {\n  public static titleGame() {\n    let player = new Player(\n        new Level([1, 3, 5, 10, 20]),\n        new PlayerBorgAI(new Dispatcher()),\n        {\n          name: 'Player',\n          weight: 80,\n          clan: Clan.Player,\n          abilities: allAbilities,\n          protections: [],\n          damages: [\n            { type: DamageType.Pure, dice: { times: 3, max: 3 }, extra: 1 },\n          ],\n          maxHealthValue: 10,\n          regenerationRate: 1,\n          regenerationValue: 1,\n          resistances: [],\n          visionRadius: 10,\n          moveSpeed: 20,\n          attackSpeed: 20,\n          bodyControl: 5,\n          leavesCorpseRatio: 0,\n          material: Material.flesh,\n          throwingDamages: [],\n        },\n        12,\n        12,\n        15\n      ),\n      game = new TitleGame(player, new OnisunProfessionPicker(player)),\n      dungeon = new TitleDungeon()\n\n    dungeon.register(game)\n    dungeon.enter(game, player)\n\n    return game\n  }\n}\n\nexport enum Race {\n  Human,\n  Dwarf\n}\n","/// This file contains the main tile engine namespace.\n/// All coordinates are assumed to be integers - behaviour is undefined\n/// if you feed in floats (or anything other) as x and y (or similar) parameters.\n\n/// Class: Tile\n/// Represents a unicode character tile with various attributes.\nexport class Tile {\n  /// Constructor: Tile\n  /// Constructs a new Tile object.\n  ///\n  /// Parameters:\n  ///   ch - a character to display for this tile\n  ///   r - (optional) red foregorund color component 0-255\n  ///   g - (optional) green foreground color component 0-255\n  ///   b - (optional) blue foreground color component 0-255\n  ///   br - (optional) red background color component 0-255\n  ///   bg - (optional) green background color component 0-255\n  ///   bb - (optional) blue background color component 0-255\n  constructor(\n    public ch: string,\n    public r?: number,\n    public g?: number,\n    public b?: number,\n    public br?: number,\n    public bg?: number,\n    public bb?: number,\n  ) {}\n\n  /// Function: getChar\n  /// Returns the character of this tile.\n  public getChar() { return this.ch }\n\n  /// Function: setChar\n  /// Sets the character of this tile.\n  public setChar(ch: string) { this.ch = ch }\n\n  /// Function: setColor\n  /// Sets the foreground color of this tile.\n  public setColor(r: number, g: number, b: number) {\n    this.r = r\n    this.g = g\n    this.b = b\n  }\n\n  /// Function: setGrey\n  /// Sets the foreground color to the given shade (0-255) of grey.\n  public setGrey(grey: number) {\n    this.r = grey\n    this.g = grey\n    this.b = grey\n  }\n\n  /// Function: setBackground\n  /// Sets the background color of this tile.\n  public setBackground(r: number, g: number, b: number) {\n    this.br = r\n    this.bg = g\n    this.bb = b\n  }\n\n  public backgroundToColor() {\n    this.r = this.br\n    this.g = this.bg\n    this.b = this.bb\n  }\n\n  public swapColors() {\n    this.r = [this.br, this.br = this.r][0]\n    this.g = [this.bg, this.bg = this.g][0]\n    this.b = [this.bb, this.bb = this.b][0]\n  }\n\n  /// Function: resetColor\n  /// Clears the color of this tile / assigns default color.\n  public resetColor() { this.r = this.g = this.b = undefined }\n\n  /// Function: resetBackground\n  /// Clears the background color of this tile.\n  public resetBackground() { this.br = this.bg = this.bb = undefined }\n\n  /// Function: getColorHex\n  /// Returns the hexadecimal representation of the color\n  public getColorHex() {\n    if (this.r !== undefined && this.g !== undefined && this.b !== undefined)\n      return '#' + this.r.toString(16) + this.g.toString(16) + this.b.toString(16)\n    else return ''\n  }\n\n  /// Function: getBackgroundHex\n  /// Returns the hexadecimal representation of the background color\n  public getBackgroundHex() {\n    if (this.br !== undefined && this.bg !== undefined && this.bb !== undefined)\n      return '#' + this.br.toString(16) + this.bg.toString(16) + this.bb.toString(16)\n    else return ''\n  }\n\n  /// Function: getColorRGB\n  /// Returns the CSS rgb(r,g,b) representation of the color\n  public getColorRGB() {\n    if (this.r !== undefined && this.g !== undefined && this.b !== undefined)\n      return `rgb(${this.r},${this.g},${this.b})`\n    else return ''\n  }\n\n  /// Function: getBackgroundRGB\n  /// Returns the CSS rgb(r,g,b) representation of the background color\n  public getBackgroundRGB() {\n    if (this.br !== undefined && this.bg !== undefined && this.bb !== undefined)\n      return `rgb(${this.br},${this.bg},${this.bb})`\n    else return ''\n  }\n\n  /// Function: getColorJSON\n  /// Returns the JSON representation of the color, i.e. object { r, g, b }\n  public getColorJSON() {\n    if (this.r !== undefined && this.g !== undefined && this.b !== undefined)\n      return { 'r': this.r, 'g': this.g, 'b': this.b }\n    else return {}\n  }\n\n  /// Function: getBackgroundJSON\n  /// Returns the JSON representation of the background color, i.e. object { r, g, b }\n  public getBackgroundJSON() {\n    if (this.r !== undefined && this.g !== undefined && this.b !== undefined)\n      return { 'r': this.br, 'g': this.bg, 'b': this.bb }\n    else return {}\n  }\n\n  /// Function: copy\n  /// Makes this tile identical to the one supplied. Custom properties are not copied.\n  public copy(other: Tile) {\n    this.ch = other.ch\n    this.r = other.r\n    this.g = other.g\n    this.b = other.b\n    this.br = other.br\n    this.bg = other.bg\n    this.bb = other.bb\n  }\n\n  /// Function: clone\n  /// Returns a new copy of this tile. Custom properties are not cloned.\n  public clone() {\n    return new Tile(this.ch, this.r, this.g, this.b, this.br, this.bg, this.bb)\n  }\n}\n\n/// Constants: Semi-internal constants for ut namespace\n/// VERSION  - Version of the library as string.\n/// NULLCHAR - Character used when none is specified otherwise.\n/// CSSCLASS - The CSS class name used for the tile engine element.\n/// NULLTILE - The tile used as placeholder for empty tile.\nexport const VERSION = '2.1'\nexport const NULLCHAR = ' '\nexport const CSSCLASS = 'unicodetiles'\nexport const NULLTILE = new Tile(NULLCHAR)\n\nexport interface Renderer {\n  updateStyle(s?: any): void\n\n    // if (this.renderer instanceof ut.WebGLRenderer) return ''\n    // if (this.renderer instanceof ut.CanvasRenderer) return 'canvas'\n    // if (this.renderer instanceof ut.DOMRenderer) return 'dom'\n  getRendererString(): string\n\n  clear(): void\n  render(): void\n}\n\n/// Class: Viewport\n/// The tile engine viewport / window. Takes care of initializing a proper renderer.\n\n/// Constructor: Viewport\n/// Constructs a new Viewport object.\n/// If you wish to display a player character at the center, you should use odd sizes.\n///\n/// Parameters:\n///   elem - the DOM element which shall be transformed into the tile engine\n///   w - (integer) width in tiles\n///   h - (integer) height in tiles\n///   renderer - (optional) choose rendering engine, see <Viewport.setRenderer>, defaults to 'auto'.\n///   squarify - (optional) set to true to force the tiles square; may break some box drawing\nexport class Viewport {\n  public cx: number\n  public cy: number\n\n  public buffer: Tile[][]\n  public renderer: Renderer\n\n  public defaultColor?: string\n  public defaultBackground?: string\n\n  constructor(\n    public elem: HTMLElement,\n    public w: number,\n    public h: number,\n    renderer: (viewport: Viewport) => Renderer,\n    public squarify: boolean = false,\n    ) {\n    this.cx = Math.floor(w / 2)\n    this.cy = Math.floor(h / 2)\n\n    this.elem.innerHTML = ''\n\n    // Add CSS class if not added already\n    if (elem.className.indexOf(CSSCLASS) === -1) {\n      if (elem.className.length === 0) {\n        elem.className = CSSCLASS\n      }\n      else elem.className += ' ' + CSSCLASS\n    }\n\n    // Create two 2-dimensional array to hold the viewport tiles\n    this.buffer = new Array(h)\n    for (let j = 0; j < h; ++j) {\n      this.buffer[j] = new Array(w)\n      for (let i = 0; i < w; ++i) {\n        this.buffer[j][i] = NULLTILE\n      }\n    }\n\n    this.renderer = renderer(this)\n  }\n\n  /// Function: updateStyle\n  /// If the style of the parent element is modified, this needs to be called.\n  private updateStyle(updateRenderer: boolean) {\n    const s = window.getComputedStyle(this.elem, null)\n\n    this.defaultColor = s.color || undefined // OMG\n    this.defaultBackground = s.backgroundColor || undefined\n    if (updateRenderer) {\n      this.renderer.updateStyle(s)\n    }\n  };\n\n  /// Function: getRendererString\n  /// Gets the currently used renderer.\n  ///\n  /// Returns:\n  ///   One of 'webgl', 'canvas', 'dom', ''.\n  public getRendererString(): string {\n    return this.renderer.getRendererString()\n  }\n\n  /// Function: put\n  /// Puts a tile to the given coordinates.\n  /// Checks bounds and does nothing if invalid coordinates are given.\n  ///\n  /// Parameters:\n  ///   tile - the tile to put\n  ///   x - (integer) x coordinate\n  ///   y - (integer) y coordinate\n  public put(tile: Tile, x: number, y: number): void {\n    if (x < 0 || y < 0 || x >= this.w || y >= this.h) return\n    this.buffer[y][x] = tile\n  }\n\n  /// Function: unsafePut\n  /// Puts a tile to the given coordinates.\n  /// Does *not* check bounds throws exception if invalid coordinates are given.\n  ///\n  /// Parameters:\n  ///   tile - the tile to put\n  ///   x - (integer) x coordinate\n  ///   y - (integer) y coordinate\n  public unsafePut(tile: Tile, x: number, y: number) {\n    this.buffer[y][x] = tile\n  }\n\n  /// Function: putString\n  /// Creates a row of tiles with the chars of the given string.\n  /// Wraps to next line if it can't fit the chars on one line.\n  ///\n  /// Parameters:\n  ///   str - (string) the string to put\n  ///   x - (integer) x coordinate (column)\n  ///   y - (integer) y coordinate (row)\n  ///   r - (optional) red foregorund color component 0-255\n  ///   g - (optional) green foreground color component 0-255\n  ///   b - (optional) blue foreground color component 0-255\n  ///   br - (optional) red background color component 0-255\n  ///   bg - (optional) green background color component 0-255\n  ///   bb - (optional) blue background color component 0-255\n  public putString(\n    str: string,\n    x: number,\n    y: number,\n    r?: number,\n    g?: number,\n    b?: number,\n    br?: number,\n    bg?: number,\n    bb?: number,\n  ) {\n    const len = str.length\n    if (x < 0 || y < 0) return\n\n    for (let i = 0; i < len; ++i) {\n      if (x >= this.w) {\n        x = 0\n        ++y\n      }\n      if (y >= this.h) return\n\n      const tile = new Tile(str[i], r, g, b, br, bg, bb)\n      this.unsafePut(tile, x, y)\n      ++x\n    }\n  }\n\n  /// Function: get\n  /// Returns the tile in the given coordinates.\n  /// Checks bounds and returns empty tile if invalid coordinates are given.\n  ///\n  /// Parameters:\n  ///   x - (integer) x coordinate\n  ///   y - (integer) y coordinate\n  ///\n  /// Returns:\n  ///   The tile.\n  public get(x: number, y: number): Tile {\n    if (x < 0 || y < 0 || x >= this.w || y >= this.h) return NULLTILE\n    return this.buffer[y][x]\n  }\n\n  /// Function: clear\n  /// Clears the viewport buffer by assigning empty tiles.\n  public clear() {\n    for (let j = 0; j < this.h; ++j) {\n      for (let i = 0; i < this.w; ++i) {\n        this.buffer[j][i] = NULLTILE\n      }\n    }\n    this.renderer.clear()\n  }\n\n  /// Function: render\n  /// Renders the buffer as html to the element specified at construction.\n  public render() {\n    this.renderer.render()\n  }\n}\n\n/// Class: Engine\n/// The tile engine itself.\nexport class Engine {\n  private refreshCache: boolean = true\n  private cacheEnabled: boolean = false\n  private transitionTimer?: number\n\n  private transitionDuration: number = 0\n  private transition?: (x: number, y: number, w: number, h: number, new_t: Tile, old_t: Tile, factor: number) => Tile\n  private maskFunc?: (x: number, y: number) => boolean\n  private shaderFunc?: (tile: Tile, x: number, y: number, timeNow: number) => Tile\n  private cachex: number = 0\n  private cachey: number = 0\n\n  private tileCache: Tile[][]\n  private tileCache2: Tile[][]\n\n  /// Constructor: Engine\n  /// Constructs a new Engine object. If width or height is given,\n  /// it will not attempt to fetch tiles outside the boundaries.\n  /// In that case 0,0 is assumed as the upper-left corner of the world,\n  /// but if no width/height is given also negative coords are valid.\n  ///\n  /// Parameters:\n  ///   vp - the <Viewport> instance to use as the viewport\n  ///   func - the function used for fetching tiles\n  ///   w - (integer) (optional) world width in tiles\n  ///   h - (integer) (optional) world height in tiles\n  constructor(\n    public viewport: Viewport,\n    public tileFunc: (x: number, y: number) => Tile,\n    public w: number,\n    public h: number,\n  ) {\n\n    this.tileCache = new Array(viewport.h)\n    this.tileCache2 = new Array(viewport.h)\n\n    for (let j = 0; j < viewport.h; ++j) {\n      this.tileCache[j] = new Array(viewport.w)\n      this.tileCache2[j] = new Array(viewport.w)\n    }\n  }\n\n  /// Function: setTileFunc\n  /// Sets the function to be called with coordinates to fetch each tile.\n  /// Optionally can apply a transition effect. Effects are:\n  /// 'boxin', 'boxout', 'circlein', 'circleout', 'random'\n  ///\n  /// Parameters:\n  ///   func - function taking parameters (x, y) and returning an ut.Tile\n  ///   effect - (string) (optional) name of effect to use (see above for legal values)\n  ///   duration - (integer) (optional) how many milliseconds the transition effect should last\n  public setTileFunc(func: (x: number, y: number) => Tile, effect?: string, duration?: number) {\n    if (effect) {\n      this.transition = undefined\n      if (typeof effect === 'string') {\n        if (effect === 'boxin') this.transition = function(x, y, w, h, new_t, old_t, factor) {\n          const halfw = w * 0.5, halfh = h * 0.5\n          x -= halfw\n          y -= halfh\n          if (Math.abs(x) < halfw * factor && Math.abs(y) < halfh * factor) return new_t\n          else return old_t\n        }\n        else if (effect === 'boxout') this.transition = function(x, y, w, h, new_t, old_t, factor) {\n          const halfw = w * 0.5, halfh = h * 0.5\n          x -= halfw\n          y -= halfh\n          factor = 1.0 - factor\n          if (Math.abs(x) < halfw * factor && Math.abs(y) < halfh * factor) return old_t\n          else return new_t\n        }\n        else if (effect === 'circlein') this.transition = function(x, y, w, h, new_t, old_t, factor) {\n          const halfw = w * 0.5, halfh = h * 0.5\n          x -= halfw\n          y -= halfh\n          if (x * x + y * y < (halfw * halfw + halfh * halfh) * factor) return new_t\n          else return old_t\n        }\n        else if (effect === 'circleout') this.transition = function(x, y, w, h, new_t, old_t, factor) {\n          const halfw = w * 0.5, halfh = h * 0.5\n          x -= halfw\n          y -= halfh\n          factor = 1.0 - factor\n          if (x * x + y * y > (halfw * halfw + halfh * halfh) * factor) return new_t\n          else return old_t\n        }\n        else if (effect === 'random') this.transition = function(x, y, w, h, new_t, old_t, factor) {\n          if (Math.random() > factor) return old_t\n          else return new_t\n        }\n      }\n      if (this.transition) {\n        this.transitionTimer = (new Date()).getTime()\n        this.transitionDuration = duration || 500\n      }\n    }\n    this.tileFunc = func\n  }\n\n  /// Function: setMaskFunc\n  /// Sets the function to be called to fetch mask information according to coordinates.\n  /// If mask function returns false to some coordinates, then that tile is not rendered.\n  ///\n  /// Parameters:\n  ///   func - function taking parameters (x, y) and returning a true if the tile is visible\n  public setMaskFunc(func: (x: number, y: number) => boolean) { this.maskFunc = func }\n\n  /// Function: setShaderFunc\n  /// Sets the function to be called to post-process / shade each visible tile.\n  /// Shader function is called even if caching is enabled, see <Engine.setCacheEnabled>.\n  ///\n  /// Parameters:\n  ///   func - function taking parameters (tile, x, y) and returning an ut.Tile\n  public setShaderFunc(func: (tile: Tile, x: number, y: number) => Tile) { this.shaderFunc = func }\n\n  /// Function: setWorldSize\n  /// Tiles outside of the range x = [0,width[ y = [0,height[ are not fetched.\n  /// Set to undefined in order to make the world infinite.\n  ///\n  /// Parameters:\n  ///   width - (integer) new world width\n  ///   height - (integer) new world height\n  public setWorldSize(width: number, height: number) {\n    this.w = width\n    this.h = height\n  }\n\n  /// Function: setCacheEnabled\n  /// Enables or disables the usage of tile cache. This means that\n  /// extra measures are taken to not call the tile function unnecessarily.\n  /// This means that all animating must be done in a shader function,\n  /// see <Engine.setShaderFunc>.\n  /// Cache is off by default, but should be enabled if the tile function\n  /// does more computation than a simple array look-up.\n  ///\n  /// Parameters:\n  ///   mode - true to enable, false to disable\n  public setCacheEnabled(mode: boolean) {\n    this.cacheEnabled = mode\n    this.refreshCache = true\n  }\n\n  /// Function: update\n  /// Updates the viewport according to the given player coordinates.\n  /// The algorithm goes as follows:\n  ///   * Record the current time\n  ///   * For each viewport tile:\n  ///   * Check if the tile is visible by testing the mask\n  ///   * If not visible, continue to the next tile in the viewport\n  ///   * Otherwise, if cache is enabled try to fetch the tile from there\n  ///   * Otherwise, call the tile function and check for shader function presence\n  ///   * If there is shader function, apply it to the tile, passing the recorded time\n  ///   * Put the tile to viewport\n  ///\n  /// Parameters:\n  ///   x - (integer) viewport center x coordinate in the tile world\n  ///   y - (integer) viewport center y coordinate in the tile world\n  public update(x?: number, y?: number) {\n    x = x || 0\n    y = y || 0\n\n    // World coords of upper left corner of the viewport\n    const xx = x - this.viewport.cx\n    const yy = y - this.viewport.cy\n    const timeNow = (new Date()).getTime() // For passing to shaderFunc\n    let transTime\n    if (this.transition && this.transitionTimer) transTime = (timeNow - this.transitionTimer) / this.transitionDuration\n    if (transTime && transTime >= 1.0) this.transition = undefined\n\n    let tile: Tile\n\n    // For each tile in viewport...\n    for (let j = 0; j < this.viewport.h; ++j) {\n      for (let i = 0; i < this.viewport.w; ++i) {\n        const ixx = i + xx, jyy = j + yy\n        // Check horizontal bounds if requested\n        if (this.w && (ixx < 0 || ixx >= this.w)) {\n          tile = NULLTILE\n        // Check vertical bounds if requested\n        } else if (this.h && (jyy < 0 || jyy >= this.h)) {\n          tile = NULLTILE\n        // Check mask\n        } else if (this.maskFunc && !this.maskFunc(ixx, jyy)) {\n          tile = NULLTILE\n        // Check transition effect\n        } else if (this.transition && !this.refreshCache) {\n          tile = this.transition(\n            i,\n            j,\n            this.viewport.w,\n            this.viewport.h,\n            this.tileFunc(ixx, jyy),\n            this.tileCache[j][i],\n            transTime || 0\n          )\n        // Check cache\n        } else if (this.cacheEnabled && !this.refreshCache) {\n          const lookupx = ixx - this.cachex\n          const lookupy = jyy - this.cachey\n          if (lookupx >= 0 && lookupx < this.viewport.w && lookupy >= 0 && lookupy < this.viewport.h) {\n            tile = this.tileCache[lookupy][lookupx]\n            if (tile === NULLTILE) tile = this.tileFunc(ixx, jyy)\n          } else // Cache miss\n            tile = this.tileFunc(ixx, jyy)\n        // If all else fails, call tileFunc\n        } else tile = this.tileFunc(ixx, jyy)\n        // Save the tile to cache (always due to transition effects)\n        this.tileCache2[j][i] = tile\n        // Apply shader function\n        if (this.shaderFunc && tile !== NULLTILE)\n          tile = this.shaderFunc(tile, ixx, jyy, timeNow)\n        // Put shaded tile to viewport\n        this.viewport.unsafePut(tile, i, j)\n      }\n    }\n    // Cache stuff is enabled always, because it is also required by transitions\n    // Save the new cache origin\n    this.cachex = xx\n    this.cachey = yy\n\n    // Swap cache buffers\n    const tempCache = this.tileCache\n    this.tileCache = this.tileCache2\n    this.tileCache2 = tempCache\n    this.refreshCache = false\n  }\n}\n","import { Renderer, Viewport } from './unicodetiles'\n\n/// Class: CanvasRenderer\n/// Renders the <Viewport> into an HTML5 <canvas> element.\n///\n/// *Note:* This is an internal class used by <Viewport>\nclass CanvasRenderer implements Renderer {\n  private canvas: HTMLCanvasElement\n  private offscreen: HTMLCanvasElement\n  private ctx: CanvasRenderingContext2D\n  private ctx2: CanvasRenderingContext2D\n\n  private th?: number\n  private tw?: number\n  private gap?: number\n\n  constructor(private view: Viewport) {\n    this.canvas = document.createElement('canvas')\n    if (!this.canvas.getContext) throw('Canvas not supported')\n    this.ctx2 = this.canvas.getContext('2d')\n    if (!this.ctx2 || !this.ctx2.fillText) throw('Canvas not supported')\n    view.elem.appendChild(this.canvas)\n\n    // Create an offscreen canvas for rendering\n    this.offscreen = document.createElement('canvas')\n    this.ctx = this.offscreen.getContext('2d')\n    this.updateStyle()\n    this.canvas.width = (view.squarify ? this.th : this.tw) * view.w\n    this.canvas.height = this.th * view.h\n    this.offscreen.width = this.canvas.width\n    this.offscreen.height = this.canvas.height\n    // Doing this again since setting canvas w/h resets the state\n    this.updateStyle()\n  }\n\n  public getRendererString(): string { return 'canvas' }\n\n  public updateStyle(s?: any) {\n    s = s || window.getComputedStyle(this.view.elem, null)\n    this.ctx.font = `${s.fontSize}/${s.lineHeight} ${s.fontFamily}`\n    this.ctx.textBaseline = 'middle'\n    this.tw = this.ctx.measureText('M').width\n    this.th = parseInt(s.fontSize, 10)\n    this.gap = this.view.squarify ? (this.th - this.tw) : 0\n    if (this.view.squarify) this.tw = this.th\n  }\n\n  public clear() { /* No op */ }\n\n  public render() {\n    let tile, ch, fg, bg, x, y\n    const view = this.view,\n          buffer = this.view.buffer,\n          w = view.w, h = view.h,\n          hth = 0.5 * this.th,\n          hgap = 0.5 * this.gap // Squarification\n\n    // Clearing with one big rect is much faster than with individual char rects\n    this.ctx.fillStyle = view.defaultBackground\n    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height)\n    y = hth // half because textBaseline is middle\n    for (let j = 0; j < h; ++j) {\n      x = 0\n      for (let i = 0; i < w; ++i) {\n        tile = buffer[j][i]\n        ch = tile.ch\n        fg = tile.getColorRGB()\n        bg = tile.getBackgroundRGB()\n        // Only render background if the color is non-default\n        if (bg.length && bg !== view.defaultBackground) {\n          this.ctx.fillStyle = bg\n          this.ctx.fillRect(x, y - hth, this.tw, this.th)\n        }\n        // Do not attempt to render empty char\n        if (ch.length) {\n          if (!fg.length) fg = view.defaultColor\n          this.ctx.fillStyle = fg\n          this.ctx.fillText(ch, x + hgap, y)\n        }\n        x += this.tw\n      }\n      y += this.th\n    }\n    this.ctx2.drawImage(this.offscreen, 0, 0)\n  }\n}\n\nexport const canvasRenderer = function(viewport: Viewport): Renderer {\n  return new CanvasRenderer(viewport)\n}\n","import { Renderer, Viewport } from './unicodetiles'\n\nconst VERTEX_SHADER = `\nattribute vec2 position;\nattribute vec2 texCoord;\nattribute vec3 color;\nattribute vec3 bgColor;\nattribute float charIndex;\nuniform vec2 uResolution;\nuniform vec2 uTileCounts;\nuniform vec2 uPadding;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec2 tileCoords = floor(vec2(mod(charIndex, uTileCounts.x), charIndex / uTileCounts.x));\n  vTexCoord = (texCoord + tileCoords) / uTileCounts;\n  vTexCoord += (0.5 - texCoord) * uPadding;\n  vColor = color;\n  vBgColor = bgColor;\n  vec2 pos = position / uResolution * 2.0 - 1.0;\n  gl_Position = vec4(pos.x, -pos.y, 0.0, 1.0);\n}\n`\n\nconst FRAGMENT_SHADER = `\nprecision mediump float;\nuniform sampler2D uFont;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec4 color = texture2D(uFont, vTexCoord);\n  color.rgb = mix(vBgColor, vColor, color.rgb);\n  gl_FragColor = color;\n}\n`\n\n/// Class: WebGLRenderer\n/// Renders the <Viewport> with WebGL.\n/// Given decent GPU drivers and browser support, this is the fastest renderer.\n///\n/// *Note:* This is an internal class used by <Viewport>\nclass WebGLRenderer implements Renderer {\n  private canvas: HTMLCanvasElement\n  private ctx: CanvasRenderingContext2D\n  private offscreen: HTMLCanvasElement\n\n  public gl: WebGLRenderingContext\n\n  private charMap: any\n  private charArray: any\n  private defaultColors: any\n  private attribs: any\n\n  private th?: number\n  private tw?: number\n  private gap?: number\n  private pad?: number\n\n  private tileCountsLocation: WebGLUniformLocation\n  private paddingLocation: WebGLUniformLocation\n\n  constructor(private view: Viewport) {\n    this.view = view\n    this.canvas = document.createElement('canvas')\n    // Try to fetch the context\n    if (!this.canvas.getContext) throw('Canvas not supported')\n    this.gl = this.canvas.getContext('experimental-webgl')\n    if (!this.gl) throw('WebGL not supported')\n    view.elem.appendChild(this.canvas)\n\n    this.charMap = {}\n    this.charArray = []\n    this.defaultColors = { r: 1.0, g: 1.0, b: 1.0, br: 0.0, bg: 0.0, bb: 0.0 }\n\n    this.attribs = {\n      position:  { buffer: null, data: null, itemSize: 2, location: null, hint: this.gl.STATIC_DRAW },\n      texCoord:  { buffer: null, data: null, itemSize: 2, location: null, hint: this.gl.STATIC_DRAW },\n      color:     { buffer: null, data: null, itemSize: 3, location: null, hint: this.gl.DYNAMIC_DRAW },\n      bgColor:   { buffer: null, data: null, itemSize: 3, location: null, hint: this.gl.DYNAMIC_DRAW },\n      charIndex: { buffer: null, data: null, itemSize: 1, location: null, hint: this.gl.DYNAMIC_DRAW }\n    }\n\n\n    // Create an offscreen canvas for rendering text to texture\n    if (!this.offscreen)\n      this.offscreen = document.createElement('canvas')\n    this.offscreen.style.position = 'absolute'\n    this.offscreen.style.top = '0px'\n    this.offscreen.style.left = '0px'\n    this.ctx = this.offscreen.getContext('2d')\n    if (!this.ctx) throw 'Failed to acquire offscreen canvas drawing context'\n    // WebGL drawing canvas\n    this.updateStyle()\n    this.canvas.width = (view.squarify ? this.th : this.tw) * view.w\n    this.canvas.height = this.th * view.h\n    this.offscreen.width = 0\n    this.offscreen.height = 0\n    // Doing this again since setting canvas w/h resets the state\n    this.updateStyle()\n\n    this.gl.viewport(0, 0, this.canvas.width, this.canvas.height)\n\n    let vertexShader = this.compileShader(this.gl.VERTEX_SHADER, VERTEX_SHADER)\n    let fragmentShader = this.compileShader(this.gl.FRAGMENT_SHADER, FRAGMENT_SHADER)\n    let program = this.gl.createProgram()\n    this.gl.attachShader(program, vertexShader)\n    this.gl.attachShader(program, fragmentShader)\n    this.gl.linkProgram(program)\n    this.gl.deleteShader(vertexShader)\n    this.gl.deleteShader(fragmentShader)\n    const ok = this.gl.getProgramParameter(program, this.gl.LINK_STATUS)\n    if (!ok) {\n      const msg = `Error linking program: ${this.gl.getProgramInfoLog(program)}`\n      this.gl.deleteProgram(program)\n      throw msg\n    }\n    this.gl.useProgram(program)\n\n    // Get attribute locations\n    this.attribs.position.location  = this.gl.getAttribLocation(program, 'position')\n    this.attribs.texCoord.location  = this.gl.getAttribLocation(program, 'texCoord')\n    this.attribs.color.location     = this.gl.getAttribLocation(program, 'color')\n    this.attribs.bgColor.location   = this.gl.getAttribLocation(program, 'bgColor')\n    this.attribs.charIndex.location = this.gl.getAttribLocation(program, 'charIndex')\n\n    // Setup buffers and uniforms\n    this.initBuffers()\n    let resolutionLocation = this.gl.getUniformLocation(program, 'uResolution')\n    this.gl.uniform2f(resolutionLocation, this.canvas.width, this.canvas.height)\n    this.tileCountsLocation = this.gl.getUniformLocation(program, 'uTileCounts')\n    this.gl.uniform2f(this.tileCountsLocation, this.view.w, this.view.h)\n    this.paddingLocation = this.gl.getUniformLocation(program, 'uPadding')\n    this.gl.uniform2f(this.paddingLocation, 0.0, 0.0)\n\n    // Setup texture\n    // view.elem.appendChild(this.offscreen) // Debug offscreen\n    let texture = this.gl.createTexture()\n    this.gl.bindTexture(this.gl.TEXTURE_2D, texture)\n    this.cacheChars(` !\\\"#$%&'()*+,-./0123456789:<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_\\`abcdefghijklmnopqrstuvwxyz{|}~`)\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MAG_FILTER, this.gl.NEAREST)\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MIN_FILTER, this.gl.NEAREST)\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_S, this.gl.CLAMP_TO_EDGE)\n    this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_T, this.gl.CLAMP_TO_EDGE)\n    this.gl.activeTexture(this.gl.TEXTURE0)\n\n    setTimeout(() => {\n      this.updateStyle()\n      this.buildTexture()\n      this.render()\n    }, 100)\n  }\n\n  public getRendererString(): string { return 'webgl' }\n\n  private buildTexture() {\n    let w = this.offscreen.width / (this.tw + this.pad),\n          h = this.offscreen.height / (this.th + this.pad)\n    // Check if need to resize the canvas\n    const charCount = this.charArray.length\n    if (charCount > Math.floor(w) * Math.floor(h)) {\n      w = Math.ceil(Math.sqrt(charCount))\n      h = w + 2 // Allocate some extra space too\n      this.offscreen.width = w * (this.tw + this.pad)\n      this.offscreen.height = h * (this.th + this.pad)\n      this.updateStyle()\n      this.gl.uniform2f(this.tileCountsLocation, w, h)\n    }\n    this.gl.uniform2f(this.paddingLocation, this.pad / this.offscreen.width, this.pad / this.offscreen.height)\n\n    let c = 0, ch: string\n    this.ctx.fillStyle = '#000000'\n    this.ctx.fillRect(0, 0, this.offscreen.width, this.offscreen.height)\n    this.ctx.fillStyle = '#ffffff'\n\n    const halfGap = 0.5 * this.gap // Squarification\n    const tw = this.tw + this.pad,\n          th = this.th + this.pad\n    let y = 0.5 * th // Half because textBaseline is middle\n    for (let j = 0; j < h; ++j) {\n      let x = this.pad * 0.5\n      for (let i = 0; i < w; ++i, ++c) {\n        ch = this.charArray[c]\n        if (ch === undefined) break\n        this.ctx.fillText(ch, x + halfGap, y)\n        x += tw\n      }\n      if (!ch) break\n      y += th\n    }\n    this.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, this.gl.RGBA, this.gl.UNSIGNED_BYTE, this.offscreen)\n  }\n\n  private cacheChars(chars: string, build: boolean = true) {\n    if (!this.gl) return // Nothing to do if not using WebGL renderer\n    let changed = false\n    for (let i = 0; i < chars.length; ++i) {\n      if (!this.charMap[chars[i]]) {\n        changed = true\n        this.charArray.push(chars[i])\n        this.charMap[chars[i]] = this.charArray.length - 1\n      }\n    }\n\n    if (changed && build) this.buildTexture()\n  }\n\n  public updateStyle(s?: any) {\n    s = s || window.getComputedStyle(this.view.elem, null)\n    this.ctx.font = s.fontSize + '/' + s.lineHeight + ' ' + s.fontFamily\n    this.ctx.textBaseline = 'middle'\n    this.ctx.fillStyle = '#ffffff'\n    this.tw = this.ctx.measureText('幅').width // TODO: Make a parameter\n    this.th = parseInt(s.fontSize, 10)\n    this.gap = this.view.squarify ? (this.th - this.tw) : 0\n    if (this.view.squarify) this.tw = this.th\n    this.pad = Math.ceil(this.th * 0.2) * 2.0 // Must be even number\n\n    const color = s.color.match(/\\d+/g)\n    const bgColor = s.backgroundColor.match(/\\d+/g)\n    this.defaultColors.r = parseInt(color[0], 10) / 255\n    this.defaultColors.g = parseInt(color[1], 10) / 255\n    this.defaultColors.b = parseInt(color[2], 10) / 255\n    this.defaultColors.br = parseInt(bgColor[0], 10) / 255\n    this.defaultColors.bg = parseInt(bgColor[1], 10) / 255\n    this.defaultColors.bb = parseInt(bgColor[2], 10) / 255\n  }\n\n  public clear() { /* No op */ }\n\n  public render() {\n    this.gl.clear(this.gl.COLOR_BUFFER_BIT)\n    const w = this.view.w,\n      h = this.view.h\n\n    // Create new tile data\n    let tiles = this.view.buffer\n    let defaultColor = this.view.defaultColor\n    let defaultBgColor = this.view.defaultBackground\n    let newChars = false\n\n    for (let j = 0; j < h; ++j) {\n      for (let i = 0; i < w; ++i) {\n        const tile = tiles[j][i]\n        let ch = this.charMap[tile.ch]\n        if (ch === undefined) { // Auto-cache new characters\n          this.cacheChars(tile.ch, false)\n          newChars = true\n          ch = this.charMap[tile.ch]\n        }\n        const k = this.attribs.color.itemSize * 6 * (j * w + i)\n        const kk = this.attribs.charIndex.itemSize * 6 * (j * w + i)\n        const r = tile.r === undefined ? this.defaultColors.r : tile.r / 255\n        const g = tile.g === undefined ? this.defaultColors.g : tile.g / 255\n        const b = tile.b === undefined ? this.defaultColors.b : tile.b / 255\n        const br = tile.br === undefined ? this.defaultColors.br : tile.br / 255\n        const bg = tile.bg === undefined ? this.defaultColors.bg : tile.bg / 255\n        const bb = tile.bb === undefined ? this.defaultColors.bb : tile.bb / 255\n        for (let m = 0; m < 6; ++m) {\n          const n = k + m * this.attribs.color.itemSize\n          this.attribs.color.data[n + 0] = r\n          this.attribs.color.data[n + 1] = g\n          this.attribs.color.data[n + 2] = b\n          this.attribs.bgColor.data[n + 0] = br\n          this.attribs.bgColor.data[n + 1] = bg\n          this.attribs.bgColor.data[n + 2] = bb\n          this.attribs.charIndex.data[kk + m] = ch\n        }\n      }\n    }\n\n    // Upload\n    if (newChars) this.buildTexture()\n    this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.attribs.color.buffer)\n    this.gl.bufferData(this.gl.ARRAY_BUFFER, this.attribs.color.data, this.attribs.color.hint)\n    this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.attribs.bgColor.buffer)\n    this.gl.bufferData(this.gl.ARRAY_BUFFER, this.attribs.bgColor.data, this.attribs.bgColor.hint)\n    this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.attribs.charIndex.buffer)\n    this.gl.bufferData(this.gl.ARRAY_BUFFER, this.attribs.charIndex.data, this.attribs.charIndex.hint)\n\n    const attrib = this.attribs.position\n    this.gl.drawArrays(this.gl.TRIANGLES, 0, attrib.data.length / attrib.itemSize)\n  }\n\n  // Setup GLSL\n  private compileShader(type: number, source: string) {\n    const shader = this.gl.createShader(type)\n    this.gl.shaderSource(shader, source)\n    this.gl.compileShader(shader)\n    const ok = this.gl.getShaderParameter(shader, this.gl.COMPILE_STATUS)\n    if (!ok) {\n      const msg = 'Error compiling shader: ' + this.gl.getShaderInfoLog(shader)\n      this.gl.deleteShader(shader)\n      throw msg\n    }\n    return shader\n  }\n\n  private initBuffers() {\n    let a, attrib, attribs = this.attribs\n\n    const w = this.view.w,\n          h = this.view.h\n\n    // Allocate data arrays\n    for (a in this.attribs) {\n      attrib = attribs[a]\n      attrib.data = new Float32Array(attrib.itemSize * 6 * w * h)\n    }\n    // Generate static data\n    for (let j = 0; j < h; ++j) {\n      for (let i = 0; i < w; ++i) {\n        // Position & texCoords\n        const k = attribs.position.itemSize * 6 * (j * w + i)\n        this.insertQuad(attribs.position.data, k, i * this.tw, j * this.th, this.tw, this.th)\n        this.insertQuad(attribs.texCoord.data, k, 0.0, 0.0, 1.0, 1.0)\n      }\n    }\n    // Upload\n    for (a in this.attribs) {\n      attrib = attribs[a]\n      if (attrib.buffer) this.gl.deleteBuffer(attrib.buffer)\n      attrib.buffer = this.gl.createBuffer()\n      this.gl.bindBuffer(this.gl.ARRAY_BUFFER, attrib.buffer)\n      this.gl.bufferData(this.gl.ARRAY_BUFFER, attrib.data, attrib.hint)\n      this.gl.enableVertexAttribArray(attrib.location)\n      this.gl.vertexAttribPointer(attrib.location, attrib.itemSize, this.gl.FLOAT, false, 0, 0)\n    }\n  }\n\n  private insertQuad(arr: number[], i: number, x: number, y: number, w: number, h: number) {\n    const x1 = x,\n          y1 = y,\n          x2 = x + w,\n          y2 = y + h\n\n    arr[  i] = x1\n    arr[++i] = y1\n    arr[++i] = x2\n    arr[++i] = y1\n    arr[++i] = x1\n    arr[++i] = y2\n    arr[++i] = x1\n    arr[++i] = y2\n    arr[++i] = x2\n    arr[++i] = y1\n    arr[++i] = x2\n    arr[++i] = y2\n  }\n}\n\nexport const webGLRenderer = function(viewport: Viewport): Renderer {\n  return new WebGLRenderer(viewport)\n}\n","import { Tile as UniTile } from '../vendor/unicodetiles.ts/src/index'\n\nimport {\n  Item,\n  ItemGroup,\n  TileVisitor,\n\n  Wall,\n  Floor,\n  Tile,\n  StairwayDown,\n  StairwayUp,\n  Door,\n  Trap,\n  TriggerTile,\n  TrapType,\n  FallingRockTrap,\n} from '../src/onisun'\n\nconst DEFAULT_GREY: number = 120\nconst IMPORTANT_GREY: number = 180\nconst DEFAULT_LIT = { r: 255, g: 165, b: 0 }\n\nexport class DisplayTile extends UniTile {\n  public lighted(degree: number): UniTile {\n    return this\n  }\n\n  constructor(char: string, r = DEFAULT_GREY, g = DEFAULT_GREY, b = DEFAULT_GREY) {\n    super(char, r, g, b)\n  }\n\n  protected litBackground(tile: UniTile, degree: number): UniTile {\n    tile.setBackground(\n      DEFAULT_LIT.r * degree,\n      DEFAULT_LIT.g * degree,\n      DEFAULT_LIT.b * degree,\n    )\n    return tile\n  }\n\n  protected litColor(tile: UniTile, degree: number): UniTile {\n    tile.setColor(\n      DEFAULT_LIT.r * degree,\n      DEFAULT_LIT.g * degree,\n      DEFAULT_LIT.b * degree,\n    )\n    return tile\n  }\n}\n\nabstract class ImportantTile extends DisplayTile {\n  constructor(char: string) {\n    super(char, IMPORTANT_GREY, IMPORTANT_GREY, IMPORTANT_GREY)\n  }\n}\n\nexport class CreatureTile extends ImportantTile {\n  constructor(\n    char: string,\n    public vr: number,\n    public vg: number,\n    public vb: number,\n  ) {\n    super(char)\n  }\n\n  public lighted(degree: number) {\n    let tile = this.clone()\n    tile.setColor(this.vr, this.vg, this.vb)\n\n    return tile\n  }\n}\n\nexport class DoorTile extends DisplayTile {\n  constructor() {\n    super('戸')\n  }\n\n  public lighted(degree: number) {\n    let tile = this.clone()\n    this.litColor(tile, degree)\n    tile.swapColors()\n\n    return tile\n  }\n}\n\nexport class FloorTile extends DisplayTile {\n  constructor() {\n    super('・')\n  }\n\n  public lighted(degree: number) {\n    return this.litColor(this.clone(), degree)\n  }\n}\n\nexport class WallTile extends DisplayTile {\n  constructor() {\n    super('＃')\n  }\n\n  public lighted(degree: number) {\n    let tile = this.clone()\n    this.litBackground(tile, degree)\n    tile.backgroundToColor()\n\n    return tile\n  }\n}\n\nexport class StairwayDownD extends DisplayTile {\n  constructor() {\n    super('＞')\n  }\n}\n\nexport class StairwayUpD extends DisplayTile {\n  constructor() {\n    super('＜')\n  }\n}\n\nexport class ItemTile extends DisplayTile {\n  constructor(\n    char: string,\n    public vr: number,\n    public vg: number,\n    public vb: number,\n  ) {\n    super(char)\n  }\n\n  public lighted(degree: number) {\n    let tile = this.clone()\n    tile.setColor(this.vr, this.vg, this.vb)\n\n    return tile\n  }\n}\n\nconst WEAPON = new ItemTile('刀', 200, 200, 200)\nconst CORPSE = new ItemTile('体', 200, 200, 200)\nconst BODY_ARMOR = new ItemTile('胸', 200, 200, 200)\nconst MISSILE = new ItemTile('石', 200, 200, 200)\nconst MISSILE_WEAPON = new ItemTile(']', 200, 200, 200)\nconst BOOTS = new ItemTile('[', 255, 255, 0)\nconst SCROLL = new ItemTile('?', 255, 255, 255)\n\nconst POTION = new ItemTile('！', 200, 200, 200)\n\nexport const displayItem = function(item: Item): ItemTile {\n  switch (item.group) {\n    case ItemGroup.OneHandWeapon:\n      return WEAPON\n    case ItemGroup.Consumable:\n      return CORPSE\n    case ItemGroup.BodyArmor:\n      return BODY_ARMOR\n    case ItemGroup.Missile:\n      return MISSILE\n    case ItemGroup.MissileWeapon:\n      return MISSILE_WEAPON\n    case ItemGroup.Potion:\n      return POTION\n    case ItemGroup.Boots:\n      return BOOTS\n    case ItemGroup.Scrolls:\n      return SCROLL\n    default:\n      return CORPSE\n  }\n}\n\nconst DOOR = new DoorTile()\nconst WALL = new WallTile()\nconst FLOOR = new FloorTile()\nconst STAIRWAY_DOWN = new StairwayDownD()\nconst STAIRWAY_UP = new StairwayUpD()\nconst NULL_TILE = new DisplayTile('　', 0, 0, 0)\n\nconst AIR_BLOW_TRAP = new DisplayTile('^', 255, 255, 255)\nconst TELEPORTATION_TRAP = new DisplayTile('^', 0, 191, 255)\nconst LIGHT_TRAP = new DisplayTile('^', 255, 255, 0)\nconst HOLE_TRAP = new DisplayTile('^', 139, 69, 19)\nconst BARE_WIRE_TRAP = new DisplayTile('^', 255, 165, 0)\nconst FALLING_ROCK_TRAP = new DisplayTile('^', 200, 200, 200)\nconst WATER_TRAP = new DisplayTile('^', 0, 0, 205)\n\nexport class DisplayTileVisitor extends TileVisitor {\n  public tile: DisplayTile\n\n  public onWall(wall: Wall): void {\n    this.tile = WALL\n  }\n\n  public onFloor(floor: Floor): void {\n    this.tile = FLOOR\n  }\n\n  public onStairwayDown(stairway: StairwayDown): void {\n    this.tile = STAIRWAY_DOWN\n  }\n\n  public onStairwayUp(stairway: StairwayUp): void {\n    this.tile = STAIRWAY_UP\n  }\n\n  public onDoor(door: Door): void {\n    this.tile = DOOR\n  }\n\n  public onTrap(trap: Trap): void {\n    if (!trap.revealed) {\n      trap.tile.visit(this)\n      return\n    }\n\n    switch (trap.type) {\n    case TrapType.AirBlow:\n      this.tile = AIR_BLOW_TRAP\n      break\n    case TrapType.Teleportation:\n      this.tile = TELEPORTATION_TRAP\n      break\n    case TrapType.Light:\n      this.tile = LIGHT_TRAP\n      break\n    case TrapType.Hole:\n      this.tile = HOLE_TRAP\n      break\n    case TrapType.BareWire:\n      this.tile = BARE_WIRE_TRAP\n      break\n    case TrapType.FallingRock:\n      this.tile = FALLING_ROCK_TRAP\n      break\n    case TrapType.Water:\n      this.tile = WATER_TRAP\n      break\n    }\n  }\n\n  public onTrigger(trigger: TriggerTile): void {\n    trigger.tile.visit(this)\n  }\n\n  protected default(tile: Tile): void {\n    this.tile = NULL_TILE\n  }\n}\n\nconst displayTileVisitor = new DisplayTileVisitor()\n\nexport const displayTile = function(tile): DisplayTile {\n  tile.visit(displayTileVisitor)\n  return displayTileVisitor.tile\n}\n","\n\n\n\n\nimport Vue from 'vue'\n\nimport {\n  domRenderer,\n  canvasRenderer,\n  webGLRenderer,\n  Engine,\n  Viewport,\n  Tile,\n} from '../vendor/unicodetiles.ts/src/index'\n\nimport {\n  CreatureTile,\n  ItemTile,\n  DisplayTile,\n\n  displayItem,\n  displayTile,\n} from './scene_tiles'\nimport { Creature, Point } from 'src/engine';\n\nconst HUMAN  = new CreatureTile('＠', 0, 255, 0)\nconst RAT = new CreatureTile('r', 197, 65, 38)\nconst GOLEM = new CreatureTile('G', 120, 120, 120)\nconst NULL_TILE = new DisplayTile('　', 0, 0, 0)\n\nconst nextItemAnimation = [\n  new ItemTile('｜', 200, 200, 200),\n  new ItemTile('／', 200, 200, 200),\n  new ItemTile('ー', 200, 200, 200),\n  new ItemTile('＼', 200, 200, 200),\n]\n\nexport default Vue.extend({\n  props: ['level', 'player', 'pos'],\n  data() {\n    return {\n      wholeMap: false,\n      term: null,\n      eng: null,\n      drawInterval: null,\n      ts: Date.now(),\n      interval: 100,\n      step: 0,\n    }\n  },\n  methods: {\n    getTile(x: number, y: number) {\n      const effect = this.stage.at(x, y).effect\n      const tile = this.wholeMap ? this.stage.at(x, y) : this.stage.at(x, y).tile\n\n      if (!tile) {\n        return NULL_TILE\n      }\n\n      if (effect) {\n        if (tile.creature) {\n          let dTile = this.creatureTile(tile.creature).clone()\n          dTile.setBackground(200, 0, 0)\n          return dTile\n        } else {\n          return new DisplayTile(effect, 200, 200, 0)\n        }\n      }\n\n      if (tile.creature) {\n        return this.creatureTile(tile.creature)\n      }\n\n      if (tile.items) {\n        switch (tile.items.bunch.length) {\n        case 0:\n          break;\n        case 1:\n          return displayItem(tile.items.bunch[0].item)\n        default:\n          const frame = this.step % (this.animationFps * 3 + 4)\n          if (frame < nextItemAnimation.length) {\n            return nextItemAnimation[frame]\n          } else {\n            const itemId = Math.floor(this.step / (this.animationFps * 3 + 4))\n\n            return displayItem(tile.items.bunch[itemId % tile.items.bunch.length].item)\n          }\n        }\n      }\n\n      return displayTile(tile)\n    },\n    creatureTile(creature: Creature) {\n      if (creature.name == 'Rat') {\n        return RAT\n      }\n\n      if (creature.name == 'Golem') {\n        return GOLEM\n      }\n\n      return HUMAN\n    },\n    initViewport() {\n      this.term = new Viewport(\n        this.$refs.scene,\n        Math.max(this.level.width, 40),\n        Math.max(this.level.height, 40),\n        webGLRenderer,\n        true,\n      )\n\n      this.eng = new Engine(\n        this.term,\n        (x: number, y: number) => this.getTile(x, y),\n        this.level.width,\n        this.level.height,\n      )\n\n      this.eng.setMaskFunc((x, y) => {\n        return this.wholeMap || this.stage.at(x, y).seen\n      });\n\n      this.eng.setShaderFunc((tile, x, y, time) => {\n        return this.lighting(tile, x, y, time)\n      })\n\n      clearInterval(this.drawInterval)\n      this.drawInterval = setInterval(() => { this.drawScene() }, this.interval)\n    },\n    drawScene() {\n      const ts = Date.now()\n      if (this.ts + 1000 < ts) {\n        this.ts = ts\n      }\n\n      this.eng.update(this.pos.x, this.pos.y);\n      // this.eng.update(this.term.cx, this.term.cy);\n      this.term.render();\n\n      this.step += 1\n    },\n    lighting(tile, x, y, time) {\n      if (this.wholeMap) {\n        return tile.lighted(1)\n      }\n      const fovTile = this.stage.at(x, y)\n\n      if (fovTile.visible && tile.lighted) {\n        return tile.lighted(fovTile.degree)\n      }\n\n      return tile\n    },\n  },\n  computed: {\n    stage() {\n      return this.wholeMap ? this.level : this.player.stageMemory(this.level)\n    },\n    animationFps(): number {\n      return 1000 / this.interval\n    }\n  },\n  mounted() {\n    this.initViewport()\n  },\n  beforeDestroy() {\n    clearInterval(this.drawInterval)\n  },\n  watch: {\n    interval() {\n      this.initViewport()\n    },\n    level() {\n      clearInterval(this.drawInterval)\n      this.initViewport()\n    }\n  }\n})\n","import mod from \"-!../node_modules/ts-loader/index.js??ref--14-0!../node_modules/vue-loader/lib/index.js??vue-loader-options!./Scene.vue?vue&type=script&lang=ts&\"; export default mod; export * from \"-!../node_modules/ts-loader/index.js??ref--14-0!../node_modules/vue-loader/lib/index.js??vue-loader-options!./Scene.vue?vue&type=script&lang=ts&\"","import { render, staticRenderFns } from \"./Scene.vue?vue&type=template&id=0e91ae7c&lang=pug&\"\nimport script from \"./Scene.vue?vue&type=script&lang=ts&\"\nexport * from \"./Scene.vue?vue&type=script&lang=ts&\"\nimport style0 from \"./Scene.vue?vue&type=style&index=0&lang=scss&\"\n\n\n/* normalize component */\nimport normalizer from \"!../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\ncomponent.options.__file = \"Scene.vue\"\nexport default component.exports","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('div',{ref:\"scene\",staticClass:\"unicodetiles\"})}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nimport Vue from 'vue'\n\nimport { Application, Point, TitleGame, Gender, Race } from '../src/onisun'\nimport { sample } from 'lodash'\n\nimport Scene from './Scene.vue'\n\nconst LOOP_INTERVAL = 100\n\nenum Stage {\n  Title,\n  Gender,\n  Race,\n  PrimaryAttributes,\n\n  Final,\n}\n\ntype Option = {\n  char: string,\n  name: string,\n  command: () => void,\n  separator?: true\n}\n\ntype State\n  = { stage: Stage.Title }\n  | { stage: Stage.Gender }\n  | { stage: Stage.Race, gender: Gender }\n  | { stage: Stage.PrimaryAttributes, gender: Gender, race: Race }\n  | { stage: Stage.Final, gender: Gender, race: Race }\n\nexport default Vue.extend({\n  name: 'Title',\n  data() {\n    return {\n      game: null as TitleGame | null,\n      loopIntervalId: undefined as number | undefined,\n      state: { stage: Stage.Title } as State\n    }\n  },\n  computed: {\n    genderName(): string {\n      return this.state.gender === Gender.Male ? 'male' : 'female'\n    },\n    raceName(): string {\n      return this.state.race === Race.Human ? 'human' : 'dwarf'\n    },\n    subtitle(): string {\n      switch (this.state.stage) {\n      case Stage.Gender:\n        return 'Choose a gender:'\n      case Stage.Race:\n        return `You are ${this.genderName}. Choose a race:`\n      case Stage.PrimaryAttributes:\n        return `You are ${this.genderName} ${this.raceName}. Choose your attributes:`\n      default:\n        return ''\n      }\n    },\n    options(): Option[] {\n      switch (this.state.stage) {\n      case Stage.Title:\n        return [\n          { char: 'N', name: 'New game', command: () => this.state = { stage: Stage.Gender } },\n        ]\n      case Stage.Gender:\n        return [\n          { char: 'M', name: 'Male',\n            command: () => this.state = { stage: Stage.Race, gender: Gender.Male } },\n          { char: 'F', name: 'Female',\n            command: () => this.state = { stage: Stage.Race, gender: Gender.Female } },\n          { char: '*', name: 'Random', separator: true,\n            command: () => this.state = { stage: Stage.Race, gender: sample([Gender.Male, Gender.Female]) || Gender.Male } },\n          { char: '=', name: 'Back', separator: true,\n            command: () => this.state = { stage: Stage.Title } },\n        ]\n      case Stage.Race:\n        return [\n          { char: 'H', name: 'Human',\n            command: () => Object.assign(this.state, { stage: Stage.PrimaryAttributes, race: Race.Human }) },\n          { char: 'D', name: 'Dwarf',\n            command: () => Object.assign(this.state, { stage: Stage.PrimaryAttributes, race: Race.Dwarf }) },\n          { char: '*', name: 'Random', separator: true,\n            command: () => Object.assign(this.state, { stage: Stage.PrimaryAttributes, race: sample([Race.Dwarf, Race.Human]) || Race.Human }) },\n          { char: '=', name: 'Back', separator: true,\n            command: () => this.state = { stage: Stage.Gender } },\n        ]\n      case Stage.PrimaryAttributes:\n        return [\n          { char: '*', name: 'Random', separator: true,\n            command: () => Object.assign(this.state, { stage: Stage.Final }) },\n          { char: 'M', name: 'Manually',\n            command: () => Object.assign(this.state, { stage: Stage.PrimaryAttributes }) },\n          { char: '=', name: 'Back', separator: true,\n            command: () => this.state = { stage: Stage.Gender } },\n        ]\n      default:\n        return []\n      }\n    },\n    pos(): Point | undefined {\n      if (this.game && this.game.currentMap) {\n        return new Point(\n          Math.round(this.game.currentMap.width * 0.5),\n          Math.round(this.game.currentMap.height * 0.4)\n        )\n      }\n    }\n  },\n  components: {\n    Scene\n  },\n  methods: {\n    loop() {\n      if (this.game) {\n        this.game.turn()\n\n        if (this.game.done) {\n          this.game = Application.titleGame()\n        }\n      }\n    },\n    onEvent(event: KeyboardEvent) {\n      let option = this.options.find(option => option.char === event.key.toUpperCase())\n\n      if (option) {\n        option.command()\n      } else {\n        console.log(event.key)\n      }\n    }\n  },\n  created() {\n    this.loopIntervalId = window.setInterval(this.loop, LOOP_INTERVAL)\n    document.addEventListener('keydown', this.onEvent)\n  },\n  mounted() {\n    this.game = Application.titleGame()\n  },\n  beforeDestroy() {\n    clearInterval(this.loopIntervalId)\n    document.removeEventListener('keydown', this.onEvent)\n  }\n})\n","import mod from \"-!../node_modules/ts-loader/index.js??ref--14-0!../node_modules/vue-loader/lib/index.js??vue-loader-options!./Title.vue?vue&type=script&lang=ts&\"; export default mod; export * from \"-!../node_modules/ts-loader/index.js??ref--14-0!../node_modules/vue-loader/lib/index.js??vue-loader-options!./Title.vue?vue&type=script&lang=ts&\"","import { render, staticRenderFns } from \"./Title.vue?vue&type=template&id=4ba0d40e&scoped=true&lang=pug&\"\nimport script from \"./Title.vue?vue&type=script&lang=ts&\"\nexport * from \"./Title.vue?vue&type=script&lang=ts&\"\nimport style0 from \"./Title.vue?vue&type=style&index=0&id=4ba0d40e&lang=scss&scoped=true&\"\n\n\n/* normalize component */\nimport normalizer from \"!../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"4ba0d40e\",\n  null\n  \n)\n\ncomponent.options.__file = \"Title.vue\"\nexport default component.exports","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('div',{attrs:{\"id\":\"app\"}},[(_vm.game)?_c('Scene',{attrs:{\"level\":_vm.game.currentMap,\"player\":_vm.game.player,\"pos\":_vm.pos}}):_vm._e(),_c('div',{staticClass:\"title-view screen-modal\"},[_c('pre',{staticClass:\"title\"},[_vm._v(\" ██████╗ ███╗   ██╗██╗███████╗██╗   ██╗███╗   ██╗\\n██╔═══██╗████╗  ██║██║██╔════╝██║   ██║████╗  ██║\\n██║   ██║██╔██╗ ██║██║███████╗██║   ██║██╔██╗ ██║\\n██║   ██║██║╚██╗██║██║╚════██║██║   ██║██║╚██╗██║\\n╚██████╔╝██║ ╚████║██║███████║╚██████╔╝██║ ╚████║\\n ╚═════╝ ╚═╝  ╚═══╝╚═╝╚══════╝ ╚═════╝ ╚═╝  ╚═══╝\")]),_c('div',{staticClass:\"subtitle\",domProps:{\"textContent\":_vm._s(_vm.subtitle)}}),_c('div',{staticClass:\"content\"},_vm._l((_vm.options),function(option){return _c('div',{staticClass:\"menu-option\",class:{ 'mt-2': option.separator }},[_vm._v(\"[\"),_c('span',{staticClass:\"char\",domProps:{\"textContent\":_vm._s(option.char)}}),_vm._v(\"]\\n\"+_vm._s(option.name))])}))])],1)}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","import Vue from 'vue'\nimport App from './App.vue'\nimport Title from './Title.vue'\nimport BootstrapVue from 'bootstrap-vue'\n\nVue.use(BootstrapVue)\n\nimport './application.scss'\n\nimport 'bootstrap/dist/css/bootstrap.css'\nimport 'bootstrap-vue/dist/bootstrap-vue.css'\n\nnew Vue({\n  el: '#app',\n  render: h => h(Title)\n})\n"],"sourceRoot":""}
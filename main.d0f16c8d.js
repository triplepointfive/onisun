!function(t){function i(i){for(var e,o,a=i[0],n=i[1],l=i[2],u=0,d=[];u<a.length;u++)o=a[u],h[o]&&d.push(h[o][0]),h[o]=0;for(e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e]);for(c&&c(i);d.length;)d.shift()();return r.push.apply(r,l||[]),s()}function s(){for(var t,i=0;i<r.length;i++){for(var s=r[i],e=!0,a=1;a<s.length;a++){var n=s[a];0!==h[n]&&(e=!1)}e&&(r.splice(i--,1),t=o(o.s=s[0]))}return t}var e={},h={1:0};var r=[];function o(i){if(e[i])return e[i].exports;var s=e[i]={i:i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=t,o.c=e,o.d=function(t,i,s){o.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:s})},o.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},o.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(i,"a",i),i},o.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},o.p="/";var a=window.webpackJsonp=window.webpackJsonp||[],n=a.push.bind(a);a.push=i,a=a.slice();for(var l=0;l<a.length;l++)i(a[l]);var c=n;r.push([40,0]),s()}({11:function(t,i,s){"use strict";s.r(i);var e=s(1),h=e.a.extend({props:["cell","player"],computed:{style(){return this.player?"player":this.cell.isWall()?"wall":this.cell.isDoor()?"door":"floor"},symbol(){return this.player?"俺":" "==this.cell.display?"・":"+"==this.cell.display?"戸":"#"==this.cell.display?"＃":"E"}}}),r=s(2);var o=function(t){s(34)},a=Object(r.a)(h,function(){var t=this,i=t.$createElement;return(t._self._c||i)("td",{class:t.style,domProps:{textContent:t._s(t.symbol)},on:{click:function(i){t.$emit("setPosition")}}})},[],!1,o,null,null).exports;class n{constructor(t,i,s,e,h,r,o){this.ch=t,this.r=i,this.g=s,this.b=e,this.br=h,this.bg=r,this.bb=o}getChar(){return this.ch}setChar(t){this.ch=t}setColor(t,i,s){this.r=t,this.g=i,this.b=s}setGrey(t){this.r=t,this.g=t,this.b=t}setBackground(t,i,s){this.br=t,this.bg=i,this.bb=s}resetColor(){this.r=this.g=this.b=void 0}resetBackground(){this.br=this.bg=this.bb=void 0}getColorHex(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?"#"+this.r.toString(16)+this.g.toString(16)+this.b.toString(16):""}getBackgroundHex(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?"#"+this.br.toString(16)+this.bg.toString(16)+this.bb.toString(16):""}getColorRGB(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?`rgb(${this.r},${this.g},${this.b})`:""}getBackgroundRGB(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?`rgb(${this.br},${this.bg},${this.bb})`:""}getColorJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.r,g:this.g,b:this.b}:{}}getBackgroundJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.br,g:this.bg,b:this.bb}:{}}copy(t){this.ch=t.ch,this.r=t.r,this.g=t.g,this.b=t.b,this.br=t.br,this.bg=t.bg,this.bb=t.bb}clone(){return new n(this.ch,this.r,this.g,this.b,this.br,this.bg,this.bb)}}const l="unicodetiles",c=new n(" ");const u="\nattribute vec2 position;\nattribute vec2 texCoord;\nattribute vec3 color;\nattribute vec3 bgColor;\nattribute float charIndex;\nuniform vec2 uResolution;\nuniform vec2 uTileCounts;\nuniform vec2 uPadding;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec2 tileCoords = floor(vec2(mod(charIndex, uTileCounts.x), charIndex / uTileCounts.x));\n  vTexCoord = (texCoord + tileCoords) / uTileCounts;\n  vTexCoord += (0.5 - texCoord) * uPadding;\n  vColor = color;\n  vBgColor = bgColor;\n  vec2 pos = position / uResolution * 2.0 - 1.0;\n  gl_Position = vec4(pos.x, -pos.y, 0.0, 1.0);\n}\n",d="\nprecision mediump float;\nuniform sampler2D uFont;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec4 color = texture2D(uFont, vTexCoord);\n  color.rgb = mix(vBgColor, vColor, color.rgb);\n  gl_FragColor = color;\n}\n";const g=function(t){return new class{constructor(t){if(this.view=t,this.view=t,this.canvas=document.createElement("canvas"),!this.canvas.getContext)throw"Canvas not supported";if(this.gl=this.canvas.getContext("experimental-webgl"),!this.gl)throw"WebGL not supported";if(t.elem.appendChild(this.canvas),this.charMap={},this.charArray=[],this.defaultColors={r:1,g:1,b:1,br:0,bg:0,bb:0},this.attribs={position:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},texCoord:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},color:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},bgColor:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},charIndex:{buffer:null,data:null,itemSize:1,location:null,hint:this.gl.DYNAMIC_DRAW}},this.offscreen||(this.offscreen=document.createElement("canvas")),this.offscreen.style.position="absolute",this.offscreen.style.top="0px",this.offscreen.style.left="0px",this.ctx=this.offscreen.getContext("2d"),!this.ctx)throw"Failed to acquire offscreen canvas drawing context";this.updateStyle(),this.canvas.width=(t.squarify?this.th:this.tw)*t.w,this.canvas.height=this.th*t.h,this.offscreen.width=0,this.offscreen.height=0,this.updateStyle(),this.gl.viewport(0,0,this.canvas.width,this.canvas.height);let i=this.compileShader(this.gl.VERTEX_SHADER,u),s=this.compileShader(this.gl.FRAGMENT_SHADER,d),e=this.gl.createProgram();if(this.gl.attachShader(e,i),this.gl.attachShader(e,s),this.gl.linkProgram(e),this.gl.deleteShader(i),this.gl.deleteShader(s),!this.gl.getProgramParameter(e,this.gl.LINK_STATUS)){const t=`Error linking program: ${this.gl.getProgramInfoLog(e)}`;throw this.gl.deleteProgram(e),t}this.gl.useProgram(e),this.attribs.position.location=this.gl.getAttribLocation(e,"position"),this.attribs.texCoord.location=this.gl.getAttribLocation(e,"texCoord"),this.attribs.color.location=this.gl.getAttribLocation(e,"color"),this.attribs.bgColor.location=this.gl.getAttribLocation(e,"bgColor"),this.attribs.charIndex.location=this.gl.getAttribLocation(e,"charIndex"),this.initBuffers();let h=this.gl.getUniformLocation(e,"uResolution");this.gl.uniform2f(h,this.canvas.width,this.canvas.height),this.tileCountsLocation=this.gl.getUniformLocation(e,"uTileCounts"),this.gl.uniform2f(this.tileCountsLocation,this.view.w,this.view.h),this.paddingLocation=this.gl.getUniformLocation(e,"uPadding"),this.gl.uniform2f(this.paddingLocation,0,0);let r=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.cacheChars(" !\"#$%&'()*+,-./0123456789:<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.activeTexture(this.gl.TEXTURE0),setTimeout(()=>{this.updateStyle(),this.buildTexture(),this.render()},100)}getRendererString(){return"webgl"}buildTexture(){let t=this.offscreen.width/(this.tw+this.pad),i=this.offscreen.height/(this.th+this.pad);const s=this.charArray.length;s>Math.floor(t)*Math.floor(i)&&(i=(t=Math.ceil(Math.sqrt(s)))+2,this.offscreen.width=t*(this.tw+this.pad),this.offscreen.height=i*(this.th+this.pad),this.updateStyle(),this.gl.uniform2f(this.tileCountsLocation,t,i)),this.gl.uniform2f(this.paddingLocation,this.pad/this.offscreen.width,this.pad/this.offscreen.height);let e,h=0;this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.offscreen.width,this.offscreen.height),this.ctx.fillStyle="#ffffff";const r=.5*this.gap,o=this.tw+this.pad,a=this.th+this.pad;let n=.5*a;for(let s=0;s<i;++s){let i=.5*this.pad;for(let s=0;s<t&&void 0!==(e=this.charArray[h]);++s,++h)this.ctx.fillText(e,i+r,n),i+=o;if(!e)break;n+=a}this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.offscreen)}cacheChars(t,i=!0){if(!this.gl)return;let s=!1;for(let i=0;i<t.length;++i)this.charMap[t[i]]||(s=!0,this.charArray.push(t[i]),this.charMap[t[i]]=this.charArray.length-1);s&&i&&this.buildTexture()}updateStyle(t){t=t||window.getComputedStyle(this.view.elem,null),this.ctx.font=t.fontSize+"/"+t.lineHeight+" "+t.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="#ffffff",this.tw=this.ctx.measureText("M").width,this.th=parseInt(t.fontSize,10),this.gap=this.view.squarify?this.th-this.tw:0,this.view.squarify&&(this.tw=this.th),this.pad=2*Math.ceil(.2*this.th);const i=t.color.match(/\d+/g),s=t.backgroundColor.match(/\d+/g);this.defaultColors.r=parseInt(i[0],10)/255,this.defaultColors.g=parseInt(i[1],10)/255,this.defaultColors.b=parseInt(i[2],10)/255,this.defaultColors.br=parseInt(s[0],10)/255,this.defaultColors.bg=parseInt(s[1],10)/255,this.defaultColors.bb=parseInt(s[2],10)/255}clear(){}render(){this.gl.clear(this.gl.COLOR_BUFFER_BIT);const t=this.view.w,i=this.view.h;let s=this.view.buffer,e=(this.view.defaultColor,this.view.defaultBackground,!1);for(let h=0;h<i;++h)for(let i=0;i<t;++i){const r=s[h][i];let o=this.charMap[r.ch];void 0===o&&(this.cacheChars(r.ch,!1),e=!0,o=this.charMap[r.ch]);const a=6*this.attribs.color.itemSize*(h*t+i),n=6*this.attribs.charIndex.itemSize*(h*t+i),l=void 0===r.r?this.defaultColors.r:r.r/255,c=void 0===r.g?this.defaultColors.g:r.g/255,u=void 0===r.b?this.defaultColors.b:r.b/255,d=void 0===r.br?this.defaultColors.br:r.br/255,g=void 0===r.bg?this.defaultColors.bg:r.bg/255,f=void 0===r.bb?this.defaultColors.bb:r.bb/255;for(let t=0;t<6;++t){const i=a+t*this.attribs.color.itemSize;this.attribs.color.data[i+0]=l,this.attribs.color.data[i+1]=c,this.attribs.color.data[i+2]=u,this.attribs.bgColor.data[i+0]=d,this.attribs.bgColor.data[i+1]=g,this.attribs.bgColor.data[i+2]=f,this.attribs.charIndex.data[n+t]=o}}e&&this.buildTexture(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.color.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.color.data,this.attribs.color.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.bgColor.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.bgColor.data,this.attribs.bgColor.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.charIndex.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.charIndex.data,this.attribs.charIndex.hint);const h=this.attribs.position;this.gl.drawArrays(this.gl.TRIANGLES,0,h.data.length/h.itemSize)}compileShader(t,i){const s=this.gl.createShader(t);if(this.gl.shaderSource(s,i),this.gl.compileShader(s),!this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)){const t="Error compiling shader: "+this.gl.getShaderInfoLog(s);throw this.gl.deleteShader(s),t}return s}initBuffers(){let t,i,s=this.attribs;const e=this.view.w,h=this.view.h;for(t in this.attribs)(i=s[t]).data=new Float32Array(6*i.itemSize*e*h);for(let t=0;t<h;++t)for(let i=0;i<e;++i){const h=6*s.position.itemSize*(t*e+i);this.insertQuad(s.position.data,h,i*this.tw,t*this.th,this.tw,this.th),this.insertQuad(s.texCoord.data,h,0,0,1,1)}for(t in this.attribs)(i=s[t]).buffer&&this.gl.deleteBuffer(i.buffer),i.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,i.data,i.hint),this.gl.enableVertexAttribArray(i.location),this.gl.vertexAttribPointer(i.location,i.itemSize,this.gl.FLOAT,!1,0,0)}insertQuad(t,i,s,e,h,r){const o=s,a=e,n=s+h,l=e+r;t[i]=o,t[++i]=a,t[++i]=n,t[++i]=a,t[++i]=o,t[++i]=l,t[++i]=o,t[++i]=l,t[++i]=n,t[++i]=a,t[++i]=n,t[++i]=l}}(t)},f=new n("俺",255,255,255),b=new n("戸",255,255,255),p=new n("＃",200,200,200),y=new n("・",250,250,250),v=new n("　",0,0,0);var x=e.a.extend({props:["scene","player","fov"],data:()=>({term:null,eng:null,drawInterval:null}),methods:{getTile(t,i){switch(this.scene.at(t,i).display){case"#":return p;case"+":return b;case" ":return y;default:return v}},initViewport(){this.term=new class{constructor(t,i,s,e,h=!1){this.elem=t,this.w=i,this.h=s,this.squarify=h,this.cx=Math.floor(i/2),this.cy=Math.floor(s/2),this.elem.innerHTML="",-1===t.className.indexOf(l)&&(0===t.className.length?t.className=l:t.className+=" "+l),this.buffer=new Array(s);for(let t=0;t<s;++t){this.buffer[t]=new Array(i);for(let s=0;s<i;++s)this.buffer[t][s]=c}this.renderer=e(this)}updateStyle(t){const i=window.getComputedStyle(this.elem,null);this.defaultColor=i.color||void 0,this.defaultBackground=i.backgroundColor||void 0,t&&this.renderer.updateStyle(i)}getRendererString(){return this.renderer.getRendererString()}put(t,i,s){i<0||s<0||i>=this.w||s>=this.h||(this.buffer[s][i]=t)}unsafePut(t,i,s){this.buffer[s][i]=t}putString(t,i,s,e,h,r,o,a,l){const c=t.length;if(!(i<0||s<0))for(let u=0;u<c;++u){if(i>=this.w&&(i=0,++s),s>=this.h)return;const c=new n(t[u],e,h,r,o,a,l);this.unsafePut(c,i,s),++i}}get(t,i){return t<0||i<0||t>=this.w||i>=this.h?c:this.buffer[i][t]}clear(){for(let t=0;t<this.h;++t)for(let i=0;i<this.w;++i)this.buffer[t][i]=c;this.renderer.clear()}render(){this.renderer.render()}}(this.$refs.scene,this.scene.width,this.scene.height,g,!0),this.eng=new class{constructor(t,i,s,e){this.viewport=t,this.tileFunc=i,this.w=s,this.h=e,this.refreshCache=!0,this.cacheEnabled=!1,this.transitionDuration=0,this.cachex=0,this.cachey=0,this.tileCache=new Array(t.h),this.tileCache2=new Array(t.h);for(let i=0;i<t.h;++i)this.tileCache[i]=new Array(t.w),this.tileCache2[i]=new Array(t.w)}setTileFunc(t,i,s){i&&(this.transition=void 0,"string"==typeof i&&("boxin"===i?this.transition=function(t,i,s,e,h,r,o){const a=.5*s,n=.5*e;return t-=a,i-=n,Math.abs(t)<a*o&&Math.abs(i)<n*o?h:r}:"boxout"===i?this.transition=function(t,i,s,e,h,r,o){const a=.5*s,n=.5*e;return t-=a,i-=n,o=1-o,Math.abs(t)<a*o&&Math.abs(i)<n*o?r:h}:"circlein"===i?this.transition=function(t,i,s,e,h,r,o){const a=.5*s,n=.5*e;return(t-=a)*t+(i-=n)*i<(a*a+n*n)*o?h:r}:"circleout"===i?this.transition=function(t,i,s,e,h,r,o){const a=.5*s,n=.5*e;return(t-=a)*t+(i-=n)*i>(a*a+n*n)*(o=1-o)?h:r}:"random"===i&&(this.transition=function(t,i,s,e,h,r,o){return Math.random()>o?r:h})),this.transition&&(this.transitionTimer=(new Date).getTime(),this.transitionDuration=s||500)),this.tileFunc=t}setMaskFunc(t){this.maskFunc=t}setShaderFunc(t){this.shaderFunc=t}setWorldSize(t,i){this.w=t,this.h=i}setCacheEnabled(t){this.cacheEnabled=t,this.refreshCache=!0}update(t,i){t=t||0,i=i||0;const s=t-this.viewport.cx,e=i-this.viewport.cy,h=(new Date).getTime();let r,o;this.transition&&this.transitionTimer&&(r=(h-this.transitionTimer)/this.transitionDuration),r&&r>=1&&(this.transition=void 0);for(let t=0;t<this.viewport.h;++t)for(let i=0;i<this.viewport.w;++i){const a=i+s,n=t+e;if(this.w&&(a<0||a>=this.w))o=c;else if(this.h&&(n<0||n>=this.w))o=c;else if(this.maskFunc&&!this.maskFunc(a,n))o=c;else if(this.transition&&!this.refreshCache)o=this.transition(i,t,this.viewport.w,this.viewport.h,this.tileFunc(a,n),this.tileCache[t][i],r||0);else if(this.cacheEnabled&&!this.refreshCache){const t=a-this.cachex,i=n-this.cachey;t>=0&&t<this.viewport.w&&i>=0&&i<this.viewport.h?(o=this.tileCache[i][t])===c&&(o=this.tileFunc(a,n)):o=this.tileFunc(a,n)}else o=this.tileFunc(a,n);this.tileCache2[t][i]=o,this.shaderFunc&&o!==c&&(o=this.shaderFunc(o,a,n,h)),this.viewport.unsafePut(o,i,t)}this.cachex=s,this.cachey=e;const a=this.tileCache;this.tileCache=this.tileCache2,this.tileCache2=a,this.refreshCache=!1}}(this.term,(t,i)=>this.getTile(t,i),this.scene.width,this.scene.height),this.eng.setMaskFunc((t,i)=>this.fov[i][t].seen),this.eng.setShaderFunc((t,i,s,e)=>this.lighting(t,i,s,e)),clearInterval(this.drawInterval),this.drawInterval=setInterval(()=>{this.drawScene()},50)},drawScene(){this.eng.update(this.player.x,this.player.y),this.term.put(f,this.term.cx,this.term.cy),this.term.render()},lighting(t,i,s,e){const h=this.fov[s][i];if(!h.visible)return t;let r=t.clone();return t!==b?(r.r=255*h.degree,r.g=165*h.degree,r.b=0*h.degree):(r.r=0,r.g=0,r.b=0),t!==y&&(r.br=255*h.degree,r.bg=165*h.degree,r.bb=0*h.degree),r}},mounted(){this.initViewport()},watch:{scene(){this.initViewport()}}});var m,w=function(t){s(32)},C=Object(r.a)(x,function(){var t=this.$createElement;return(this._self._c||t)("div",{ref:"scene",staticClass:"unicodetiles"})},[],!1,w,null,null).exports;!function(t){t[t.Wall=0]="Wall",t[t.Door=1]="Door",t[t.Floor=2]="Floor"}(m||(m={}));class T{constructor(t,i,s){this.key=t,this.display=i,this.kind=s}static retrive(t){this.repository[t];switch(t){case"R":return new T("R"," ",m.Floor);case"C":return new T("C"," ",m.Floor);case"W":return new T("W","#",m.Wall);case"D":return new T("D","+",m.Door);default:throw`Tile '${t}' is not registered!`}}isDoor(){return this.kind===m.Door}isWall(){return this.kind===m.Wall}visibleThrough(){return this.kind===m.Floor}passibleThrough(){return this.kind!==m.Wall}}T.repository={};class R{constructor(t){this.map=t,this.width=t[0].length,this.height=t.length}visibleThrough(t,i){return this.map[i][t].visibleThrough()}passibleThrough(t,i){return this.map[i][t].passibleThrough()}at(t,i){return this.map[i][t]}setTile(t,i,s){this.map[i][t]=s}}class S{constructor(t,i,s,e){this.x=t,this.y=i,this.w=s,this.h=e}move(t,i){this.x+=t,this.y+=i}}const k=function(t){return String.fromCharCode(t.charCodeAt(0)+1)},M=function(t){return Math.floor(Math.random()*t)},E=function(t,i,s){let e=Array(t),h=0;for(;h<t;){e[h]=new Array(i);let t=0;for(;t<i;)e[h][t]=s(h,t),t++;h++}return e},A=function(t){return Math.min.apply(Math,t)};const D=function(t,i){const s=t.stageMemory;let e=E(s.height,s.width,()=>{}),h=[],r=[{x:t.x,y:t.y}],o=0;for(;r.length&&!h.length;){let t=[];r.forEach(r=>{s.at(r.x,r.y).tangible||void 0!==e[r.x][r.y]||(e[r.x][r.y]=o,i(r.x,r.y)?h.push(r):(t.push({x:r.x-1,y:r.y}),t.push({x:r.x+1,y:r.y}),t.push({x:r.x,y:r.y-1}),t.push({x:r.x,y:r.y+1}),t.push({x:r.x-1,y:r.y-1}),t.push({x:r.x+1,y:r.y-1}),t.push({x:r.x+1,y:r.y+1}),t.push({x:r.x-1,y:r.y+1})))}),o++,r=t}return h.length?(h[Math.floor(Math.random()*h.length)],_(h[0],e)):[]},_=function(t,i){let s=t.x,e=t.y,h=[{x:s,y:e}],r=void 0;for(;0!==i[s][e];)r=[{x:-1,y:0},{x:1,y:0},{x:0,y:-1},{x:0,y:1},{x:-1,y:-1},{x:1,y:1},{x:1,y:-1},{x:-1,y:1}].find(t=>i[s+t.x]&&i[s+t.x][e+t.y]===i[s][e]-1),s+=r.x,e+=r.y,h.unshift({x:s,y:e});return h};var I=s(10);class F{constructor(t,i){this.i="a",this.step=0,this.graph=new I.Graph,this.addNode(t,i,!1),this.lastNodeVisit={},this.markNodeVisited(this.currentNodeID),this.path=[]}act(t){this.path.length?this.moveToTarget(t):(this.targetNodeID&&(this.markNodeVisited(this.targetNodeID),this.currentNodeID=this.targetNodeID),this.pickUpNewTarget(t),this.moveToTarget(t)),this.step+=1}addNode(t,i,s=!0){this.graph.setNode(this.i,{x:t,y:i}),s&&this.graph.setEdge(this.currentNodeID,this.i),this.currentNodeID=this.i,this.i=k(this.i)}buildNewPath(t){const i=this.graph.node(this.targetNodeID);this.path=D(t,(t,s)=>i.x===t&&i.y===s)}pickUpNewTarget(t){let i=this.currentNodeID,s=this.lastNodeVisit[i];this.graph.neighbors(this.currentNodeID).forEach(t=>{s>(this.lastNodeVisit[t]||0)&&(i=t),s=this.lastNodeVisit[i]}),this.targetNodeID=i,this.buildNewPath(t)}moveToTarget(t){const i=this.path.shift();t.stageMemory.at(i.x,i.y).tangible?(this.path=[],this.act(t)):(t.x=i.x,t.y=i.y)}markNodeVisited(t){this.lastNodeVisit[t]=this.step}}const N=10;class P{constructor(t){this.patrol=t,this.path=[],this.step=N}act(t){if(this.step===N&&this.updatePatrol(t),this.path.length){const i=this.path.shift();t.stageMemory.at(i.x,i.y).tangible?(this.path=[],this.act(t)):(t.x=i.x,t.y=i.y,this.shouldAddNode(t)&&this.updatePatrol(t))}else this.buildNewPath(t),this.path.length?this.act(t):t.ai=this.patrol}buildNewPath(t){this.path=D(t,(i,s)=>!t.stageMemory.at(i,s).seen)}updatePatrol(t){this.step=0,void 0===this.patrol?this.patrol=new F(t.x,t.y):this.patrol.addNode(t.x,t.y),this.step++}shouldAddNode(t){return t.stageMemory.at(t.previousPos.x,t.previousPos.y).tile.isDoor()}}class B{constructor(t,i,s,e,h,r,o){this.startx=t,this.starty=i,this.radius=s,this.width=e,this.height=h,this.checkSolid=r,this.markVisible=o,this.doubleRadius=this.radius*this.radius}calc(){this.markVisible(this.startx,this.starty,1),this.checkSolid(this.startx,this.starty)||[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([t,i])=>{this.castLight(1,1,0,0,t,i,0),this.castLight(1,1,0,t,0,0,i)})}castLight(t,i,s,e,h,r,o){if(i<s)return;let a=0,n=!1;for(let l=t;l<=this.radius&&!n;l++){let t=-l;for(let c=-l;c<=0;c++){let u=Math.round(this.startx+c*e+t*h),d=Math.round(this.starty+c*r+t*o),g=(c-.5)/(t+.5),f=(c+.5)/(t-.5);if(u>=0&&d>=0&&u<this.width&&d<this.height&&!(i<f)){if(s>g)break;this.doubleDistance(c,t)<=this.doubleRadius&&this.markVisible(u,d,1-this.doubleDistance(c,t)/this.doubleRadius),n?this.checkSolid(u,d)?a=f:(n=!1,i=a):this.checkSolid(u,d)&&l<this.radius&&(n=!0,this.castLight(l+1,i,g,e,h,r,o),a=f)}}}}doubleDistance(t,i){return t*t+i*i}}class L{constructor(t){this.tile=t,this.visible=!1,this.degree=0,this.seen=!1,this.tangible=!1}}class U{constructor(t,i,s=(()=>new L)){this.width=t,this.height=i,this.field=E(i,t,s)}at(t,i){return this.field[i][t]}resetVisible(){this.field.forEach(t=>{t.forEach(t=>{t.visible=!1,t.tile=void 0})})}}const W=0,z=4,O=10,V=15,G=function(){return T.retrive("R")},X=function(){return T.retrive("C")},Y=function(){return T.retrive("W")},$=function(t,i){const s=new class{constructor(t,i){this.maxX=t,this.maxY=i;let s=[],e=0;for(;e<V;)s.push(this.generateRoom()),e+=1;this.rooms=this.normalize(this.fuzzifyRooms(s)),this.roads=this.buildRoads(this.rooms)}generateRoom(){return new j(0,0,z+M(O-z),z+M(O-z))}fuzzifyRooms(t){let i=[t.shift()];for(;t.length;){let s=t.shift(),e=M(360)/180*Math.PI;const h=Math.cos(e),r=Math.sin(e);let o=0,a=0,n=0;for(;!i.every(t=>s.notCross(t));){let t=Math.round(o*h),i=Math.round(o*r);for(;o+=1,t=Math.round(o*h),i=Math.round(o*r),t===a&&i===n;);s.move(t-a,i-n),a=t,n=i}i.push(s)}return i}normalize(t){const i=A(t.map(t=>t.x))-1,s=A(t.map(t=>t.y))-1;return t.forEach(t=>{t.move(-i,-s)}),t.filter(t=>t.x+t.w<this.maxX&&t.y+t.h<this.maxY)}buildRoads(t){let i=t.map(t=>t.pointWithin()),s=[i.shift()],e=[];const h=function(t,i){return Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2)};for(;i.length;){let t=i.shift(),r=s[0],o=h(t,r);s.forEach(i=>{const s=h(i,t);s<o&&(r=i,o=s)}),s.push(t),e.push(new q(t.x,t.y,r.x,r.y))}return e}}(t,i);let e=E(t,i,Y);for(let t=0;t<s.rooms.length;t++)s.rooms[t].add(e);for(let t=0;t<s.roads.length;t++)s.roads[t].add(e);return new R(e)};class j extends S{notCross(t){return t.x-W>this.x+this.w||t.y-W>this.y+this.h||t.x+t.w<this.x-W||t.y+t.h<this.y-W}pointWithin(){return{x:this.x+1+M(this.w-1),y:this.y+1+M(this.h-1)}}add(t){let i=0;for(;i<this.w;){let s=0;for(;s<this.h;)t[this.x+i][this.y+s]=G(),s++;i++}}}class q extends S{constructor(t,i,s,e){super(t,i,s,e),this.lined=t>=s&&i>=e||s>=t&&e>=i}add(t){let[i,s,e]=this.horizontalLine(),h=0;for(;h<e;)"W"===t[i+h][s].key&&(t[i+h][s]=X()),h+=1;let[r,o,a]=this.verticallLine(),n=0;for(;n<a;)"W"===t[r][o+n].key&&(t[r][o+n]=X()),n+=1}horizontalLine(){return this.lined?[Math.min(this.x,this.w),Math.max(this.y,this.h),Math.abs(this.w-this.x)]:[Math.min(this.x,this.w),Math.min(this.y,this.h),Math.abs(this.w-this.x)]}verticallLine(){return this.lined,[Math.min(this.x,this.w),Math.min(this.y,this.h),Math.abs(this.h-this.y)]}}var H=e.a.extend({data:()=>({map:new R([[]]),radius:10,player:{x:10,y:10},pause:!0,ts:Date.now()}),components:{Cell:a,Scene:C},computed:{walker(){if(this.map)return new class{constructor(t,i,s=10,e,h){this.x=t,this.y=i,this.radius=s,this.stageMemory=new U(e,h),this.ai=new P,this.previousPos={x:t,y:i}}act(t){this.visionMask(t),this.previousPos={x:this.x,y:this.y},this.ai.act(this)}visionMask(t){this.stageMemory.resetVisible(),new B(this.x,this.y,this.radius,t.width,t.height,this.isSolid(t),(i,s,e)=>{const h=this.stageMemory.at(i,s);h.visible=!0,h.degree=e,h.seen=!0,h.tangible=!t.passibleThrough(i,s),h.tile=t.at(i,s)}).calc()}isSolid(t){return(i,s)=>!(t.visibleThrough(i,s)||t.at(i,s).isDoor()&&this.x===i&&this.y===s)}}(this.player.x,this.player.y,this.radius,this.map.width,this.map.height)},fov(){return this.ts&&this.map?this.walker.stageMemory.field:[]}},methods:{generateMap(){this.map=this.buildMap();let t=1,i=1;for(;!this.map.visibleThrough(t,i);)t<this.map.width-1?t+=1:(t=1,i+=1);this.player={x:t,y:i}},updatePlayerPosition(t,i){this.pause=!1,this.player.x=t,this.player.y=i},buildMap(){let t=function(t,i=(()=>!0)){for(let s=1;s<t.height-1;s++)for(let e=1;e<t.width;e++){const h=t.at(e,s),r=t.at(e,s-1),o=t.at(e,s+1),a=t.at(e-1,s),n=t.at(e+1,s);i()&&"C"===h.key&&"D"!==a.key&&"D"!==n.key&&"D"!==r.key&&"D"!==o.key&&("R"!==a.key&&"R"!==n.key&&"R"!==r.key&&"R"!==o.key||("W"===a.key&&"W"===n.key||"W"===r.key&&"W"===o.key)&&t.setTile(e,s,T.retrive("D")))}return t}($(50,50));return clearInterval(this.walkerinterval),this.walkerinterval=setInterval(()=>{if(!this.pause)try{this.walker&&e.a.nextTick(()=>{this.walker.act(this.map),this.ts=Date.now()})}catch(t){console.error(t),this.pause=!0}},50),t},visibility(t,i){return this.pause?{background:"black",color:"darkgrey",opacity:.3}:this.fov.length?this.fov[t][i].visible?{opacity:this.fov[t][i].degree}:this.fov[t][i].seen?{background:"black",color:"darkgrey",opacity:.3}:{background:"black",color:"black"}:{background:"black",color:"darkgrey"}}},created(){this.generateMap()}});var J=function(t){s(36)},Q=Object(r.a)(H,function(){var t=this,i=t.$createElement,s=t._self._c||i;return s("div",{attrs:{id:"app"}},[s("Scene",{attrs:{fov:t.fov,player:t.walker,scene:t.map}}),s("div",{staticClass:"col"},[s("button",{on:{click:function(i){t.generateMap()}}},[t._v("Generate!")]),s("label",[t._v("radius")]),s("input",{directives:[{name:"model",rawName:"v-model",value:t.radius,expression:"radius"}],attrs:{type:"number"},domProps:{value:t.radius},on:{input:function(i){i.target.composing||(t.radius=i.target.value)}}}),s("button",{on:{click:function(i){t.pause=!t.pause}}},[t._v(t._s(t.pause?"Start":"Pause"))])])],1)},[],!1,J,null,null).exports;s(16),s(14);new e.a({el:"#app",render:t=>t(Q)})},16:function(t,i,s){},32:function(t,i,s){},34:function(t,i,s){},36:function(t,i,s){},40:function(t,i,s){t.exports=s(11)}});
//# sourceMappingURL=main.d0f16c8d.js.map
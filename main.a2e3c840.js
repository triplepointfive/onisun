!function(t){function e(e){for(var i,n,h=e[0],o=e[1],c=e[2],u=0,d=[];u<h.length;u++)n=h[u],r[n]&&d.push(r[n][0]),r[n]=0;for(i in o)Object.prototype.hasOwnProperty.call(o,i)&&(t[i]=o[i]);for(l&&l(e);d.length;)d.shift()();return a.push.apply(a,c||[]),s()}function s(){for(var t,e=0;e<a.length;e++){for(var s=a[e],i=!0,h=1;h<s.length;h++){var o=s[h];0!==r[o]&&(i=!1)}i&&(a.splice(e--,1),t=n(n.s=s[0]))}return t}var i={},r={0:0},a=[];function n(e){if(i[e])return i[e].exports;var s=i[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=i,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(s,i,function(e){return t[e]}.bind(null,i));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/onisun/";var h=window.webpackJsonp=window.webpackJsonp||[],o=h.push.bind(h);h.push=e,h=h.slice();for(var c=0;c<h.length;c++)e(h[c]);var l=o;a.push([27,1]),s()}([,,,,,,,function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},function(t,e,s){},,,,,,,,,,,function(t,e,s){t.exports=s(77)},,,,,,,,,,,,,,,,function(t,e,s){"use strict";var i=s(7);s.n(i).a},,function(t,e,s){"use strict";var i=s(8);s.n(i).a},,function(t,e,s){"use strict";var i=s(9);s.n(i).a},,function(t,e,s){"use strict";var i=s(10);s.n(i).a},,function(t,e,s){"use strict";var i=s(11);s.n(i).a},,function(t,e,s){"use strict";var i=s(12);s.n(i).a},,function(t,e,s){"use strict";var i=s(13);s.n(i).a},,function(t,e,s){"use strict";var i=s(14);s.n(i).a},,function(t,e,s){"use strict";var i=s(15);s.n(i).a},,function(t,e,s){"use strict";var i=s(16);s.n(i).a},,,,,,,,,,function(t,e,s){},,,,,,function(t,e,s){"use strict";s.r(e);var i=s(1),r=s(0);class a{constructor(t,e,s,i){this.x=t,this.y=e,this.w=s,this.h=i}move(t,e){this.x+=t,this.y+=e}}const n=function(t){return String.fromCharCode(t.charCodeAt(0)+1)},h=function(t){return Math.floor(Math.random()*t)},o=function(t,e,s){let i=Array(t);for(let r=0;r<t;r++){i[r]=new Array(e);for(let t=0;t<e;t++)i[r][t]=s(r,t)}return i};class c{constructor(t,e){this.x=t,this.y=e}eq(t){return this.x===t.x&&this.y===t.y}nextTo(t){return Math.abs(this.x-t.x)<=1&&Math.abs(this.y-t.y)<=1}copy(){return new c(this.x,this.y)}add(t){return new c(this.x+t.x,this.y+t.y)}wrappers(){return c.dxy.map(t=>this.add(t))}}c.dxy=[new c(-1,-1),new c(0,-1),new c(1,-1),new c(-1,0),new c(1,0),new c(-1,1),new c(0,1),new c(1,1)];class l{constructor(t){this.map=t,this.width=t.length,this.height=t[0].length}at(t,e){return this.map[t][e]}inRange(t){return t.x>=0&&t.y>=0&&t.x<this.width&&t.y<this.height}each(t){this.map.forEach((e,s)=>{e.forEach((e,i)=>{t(e,s,i)})})}}const u=function(t,e){let s;if(e>0)for(let i=0;i<e;i++)s=t.pop(),t.unshift(s);else if(e<0)for(let i=e;i<0;i++)s=t.shift(),t.push(s);return t},d=function(t,e,s){let[i,r,a,n]=[t.x,e.x,t.y,e.y],h=Math.max(Math.abs(i-r),Math.abs(a-n));const o=new c((r-i)/h,(n-a)/h);for(;h>1;)i+=o.x,a+=o.y,s(Math.round(i),Math.round(a)),h-=1},p=function(t,e,s){d(t,e,s),s(e.x,e.y)};class m extends c{constructor(t,e){super(t,e)}}m.up=new m(0,-1),m.down=new m(0,1),m.left=new m(-1,0),m.right=new m(1,0),m.upLeft=new m(-1,-1),m.upRight=new m(1,-1),m.downLeft=new m(-1,1),m.downRight=new m(1,1);const g=function(t){const e=Object(r.min)(t);if(void 0!==e)return e;throw"minUnsafe got empty array"};class f{constructor(t,e=1,s=0){this.base=t,this.rate=e,this.extra=s}get current(){return this.base*this.rate-this.extra}add(t){this.base+=t}subtract(t){this.base-=t}}class v{constructor(t,e){this.strength=t,this.constitution=e,this.strengthRatio=5,this.constitutionRatio=3,this.base=10}recalculate(t,e){this.strength=t,this.constitution=e}get stressed(){return this.base+this.strength*this.strengthRatio+this.constitution*this.constitutionRatio}get loadedStart(){return 1.5*this.stressed}get overloadedStart(){return 2*this.loadedStart}get flattenedStart(){return 3*this.overloadedStart}}class w{constructor(t,e,s,i,r,a,n){this.startx=t,this.starty=e,this.radius=s,this.width=i,this.height=r,this.solidChecker=a,this.markVisible=n,this.doubleRadius=this.radius*this.radius}calc(){this.markVisible(this.startx,this.starty,1),this.solidChecker.isSolid(this.startx,this.starty)||[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([t,e])=>{this.castLight(1,1,0,0,t,e,0),this.castLight(1,1,0,t,0,0,e)})}castLight(t,e,s,i,r,a,n){if(e<s)return;let h=0,o=!1;for(let c=t;c<=this.radius&&!o;c++){let t=-c;for(let l=-c;l<=0;l++){let u=Math.round(this.startx+l*i+t*r),d=Math.round(this.starty+l*a+t*n),p=(l-.5)/(t+.5),m=(l+.5)/(t-.5);if(u>=0&&d>=0&&u<this.width&&d<this.height&&!(e<m)){if(s>p)break;this.doubleDistance(l,t)<=this.doubleRadius&&this.markVisible(u,d,1-this.doubleDistance(l,t)/this.doubleRadius),o?this.solidChecker.isSolid(u,d)?h=m:(o=!1,e=h):this.solidChecker.isSolid(u,d)&&c<this.radius&&(o=!0,this.castLight(c+1,e,p,i,r,a,n),h=m)}}}}doubleDistance(t,e){return t*t+e*e}}class b{constructor(){this.bunch=[]}find(t){return this.bunch.find(e=>e.item.groupsWith(t))}remove(t,e){const s=this.find(t);void 0!==s&&(s.count===e?Object(r.remove)(this.bunch,t=>t.item.groupsWith(s.item)):s.count-=e)}put(t,e){const s=this.bunch.find(e=>e.item.groupsWith(t));s?s.count+=e:this.bunch.push({count:e,item:t})}clone(){let t=new b;return this.bunch.forEach(e=>{t.put(e.item,e.count)}),t}}var y,x,M;!function(t){t[t.Wall=0]="Wall",t[t.Door=1]="Door",t[t.Floor=2]="Floor",t[t.StairwayDown=3]="StairwayDown",t[t.StairwayUp=4]="StairwayUp",t[t.Trap=5]="Trap"}(y||(y={}));class C{constructor(t,e){this.key=t,this.kind=e}addItem(t,e){this.items||(this.items=new b),this.items.put(t,e)}isFloor(){return this.kind===y.Floor}visibleThrough(){return!0}passibleThrough(t){return t&&this.creature?this.kind!==y.Wall&&this.creature.id===t.id:this.kind!==y.Wall&&!this.creature}clone(){let t=this.buildNew();return this.creature&&(t.creature=this.creature),t.items=this.items&&this.items.clone(),t}}class k extends C{visibleThrough(){return!0}visit(t){t.onFloor(this)}buildNew(){return new k(this.key,this.kind)}}class T extends k{}class I extends k{constructor(){super("R",y.Floor)}}class R extends C{constructor(){super("D",y.Door)}visibleThrough(){return!1}visit(t){t.onDoor(this)}buildNew(){return new R}}class E extends C{constructor(){super("W",y.Wall)}visibleThrough(){return!1}visit(t){t.onWall(this)}buildNew(){return new E}}class S extends C{constructor(t,e,s,i){super(t,e),this.currentMap=s,this.adjacentMapId=i}visibleThrough(){return!0}}class P extends S{constructor(t,e){super(">",y.StairwayDown,t,e)}visit(t){t.onStairwayDown(this)}buildNew(){return new P(this.currentMap,this.adjacentMapId)}}class _ extends S{constructor(t,e){super("<",y.StairwayUp,t,e)}visit(t){t.onStairwayUp(this)}buildNew(){return new _(this.currentMap,this.adjacentMapId)}}class D extends C{constructor(t=!1,e){super("^",y.Trap),this.revealed=t,this.type=e}visit(t){t.onTrap(this)}activate(t,e,s){this.affect(t,e,s)}}class A{onWall(t){this.default(t)}onFloor(t){this.default(t)}onStairwayDown(t){this.onStairway(t)}onStairwayUp(t){this.onStairway(t)}onDoor(t){this.default(t)}onTrap(t){this.default(t)}onStairway(t){this.default(t)}default(t){}}class W{affectPlayer(t){return this.affectCreature(t)}}class O extends W{constructor(t,e){super(),this.levelMap=t,this.game=e}affectCreature(t){return t.removeImpact(le.Overloaded,"bag"),t.removeImpact(le.Stressed,"bag"),t.removeImpact(le.Loaded,"bag"),t.stuffWeight.current>t.carryingCapacity.flattenedStart?t.on(new $t(this.game,this.levelMap,bt.Overloaded)):(t.stuffWeight.current>t.carryingCapacity.overloadedStart?t.addImpact(le.Overloaded,"bag"):t.stuffWeight.current>t.carryingCapacity.loadedStart?t.addImpact(le.Loaded,"bag"):t.stuffWeight.current>t.carryingCapacity.stressed&&t.addImpact(le.Stressed,"bag"),L.NOTHING)}}!function(t){t[t.Player=0]="Player",t[t.PlayerOnlyEnemy=1]="PlayerOnlyEnemy",t[t.FreeForAll=2]="FreeForAll"}(x||(x={})),function(t){t[t.GoStairwayDown=0]="GoStairwayDown",t[t.Inventory=1]="Inventory",t[t.PutOn=2]="PutOn",t[t.Throwing=3]="Throwing"}(M||(M={}));const N=[M.GoStairwayDown,M.Inventory,M.PutOn,M.Throwing];class B{constructor(t,e,s,i){this.name=t,this.weight=e,this.clan=s,this.abilities=i}}var L;!function(t){t[t.DIE=0]="DIE",t[t.HURT=1]="HURT",t[t.DODGE=2]="DODGE",t[t.THROW_DODGE=3]="THROW_DODGE",t[t.NOTHING=4]="NOTHING"}(L||(L={}));class U extends A{constructor(t,e){super(),this.stage=t,this.pos=e,this.visible=!1}isSolid(t,e){return this.x=t,this.y=e,this.stage.at(t,e).visit(this),!this.visible}onDoor(t){this.visible=this.pos.x===this.x&&this.pos.y===this.y}default(t){this.x&&this.y&&(this.visible=this.stage.visibleThrough(this.x,this.y))}}class ${constructor(t,e,s=$.getId()){this.characteristics=t,this.specie=e,this.id=s,this.stageMemories={},this.dead=!1,this.inventory=new _e,this.stuffWeight=new f(0),this.carryingCapacity=new v(1,4)}static getId(){return this.lastId++}get name(){return this.specie.name}get clan(){return this.specie.clan}can(t){return Object(r.includes)(this.specie.abilities,t)}on(t){return t.affectCreature(this)}speed(){return this.characteristics.speed.currentValue}radius(){return this.characteristics.radius.currentValue}stageMemory(t){return this.stageMemories[t.id]}visionMask(t){this.stageMemories[t.id]?this.stageMemory(t).resetVisible():this.stageMemories[t.id]=new Ae(t.width,t.height);const e=t.creaturePos(this);new w(e.x,e.y,this.radius(),t.width,t.height,new U(t,e),(e,s,i)=>{this.stageMemory(t).at(e,s).see(t.at(e,s),i)}).calc()}addImpact(t,e){this.impactsBunch||(this.impactsBunch=new ge),this.impactsBunch.addConstImpact(t,e)}removeImpact(t,e){this.impactsBunch||(this.impactsBunch=new ge),this.impactsBunch.removeConstImpact(t,e)}get impacts(){return this.impactsBunch?this.impactsBunch.activeImpacts:[]}}$.lastId=0;class F extends ${constructor(t,e,s,i){super(e,i),this.level=t,this.ai=s,this.professions=[]}act(t,e){this.visionMask(t);const s=this.ai.act(this,t,e);s&&this.on(s),this.on(new O(t,e))}rebuildVision(t){this.visionMask(t)}on(t){return t.affectPlayer(this)}}class j extends A{constructor(t,e,s){super(),this.creature=t,this.levelMap=e,this.game=s}onTrap(t){t.activate(this.game,this.levelMap,this.creature)}}class H extends W{constructor(t,e,s,i){super(),this.game=t,this.levelMap=e,this.nextPoint=s,this.nextLevel=i}affectCreature(t){const e=this.levelMap.creaturePos(t);return this.nextLevel&&this.nextLevel.id!==this.levelMap.id?(this.levelMap.removeCreature(t),this.nextLevel.addCreature(this.nextPoint,t)):(this.levelMap.at(e.x,e.y).creature=void 0,this.levelMap.at(this.nextPoint.x,this.nextPoint.y).creature=t),(this.nextLevel||this.levelMap).at(this.nextPoint.x,this.nextPoint.y).visit(new j(t,this.levelMap,this.game)),L.NOTHING}affectPlayer(t){return this.nextLevel&&this.levelMap.id!==this.nextLevel.id?(this.levelMap.reset(),this.nextLevel.enter(),this.affectCreature(t),this.game.currentMap=this.nextLevel):this.affectCreature(t),L.NOTHING}}class V{moveTo(t,e,s,i){return this.move(t,s,i,t=>e.eq(t))}move(t,e,s,i){const[r]=this.buildPath(t,e,i);if(r)return new H(s,e,r)}buildPath(t,e,s){return Xe(t.stageMemory(e),e.creaturePos(t),e=>e.tangible(t),s)}withinView(t,e,s){let i=o(t.width,t.height,()=>!1),r=[e];for(;r.length;){let e=[];r.forEach(r=>{if(!t.inRange(r))return;const a=t.at(r.x,r.y);a.visible&&!i[r.x][r.y]&&(i[r.x][r.y]=!0,s(r,a),r.wrappers().forEach(t=>e.push(t)))}),r=e}}enemies(t,e){return t.id!==e.id&&(t.clan===x.FreeForAll||e.clan===x.FreeForAll||(t.clan===x.Player&&e.clan===x.PlayerOnlyEnemy||e.clan===x.Player&&t.clan===x.PlayerOnlyEnemy))}}class G extends V{constructor(){super(...arguments),this.destination=void 0}act(t,e,s){if(!this.foundNewTarget(t,e)||!this.destination)return this.checkCurrentTile(t,e,s);const i=this.goTo(t,e,s,this.destination);if(i)return i;this.destination=void 0,this.onCantMove(t)}goTo(t,e,s,i){return this.moveTo(t,i,e,s)}checkCurrentTile(t,e,s){if(this.destination&&e.creaturePos(t).eq(this.destination))return this.destination=void 0,this.onReach(t,e,s)}onMove(t){}onReach(t,e,s){}onCantMove(t){}}class q extends G{constructor(t){super(),this.matcher=t}checkCurrentTile(t,e,s){let i=super.checkCurrentTile(t,e,s);if(i)return i;const r=e.creaturePos(t);return this.matcher(t.stageMemory(e).at(r.x,r.y))?(this.destination=void 0,this.onReach(t,e,s)):void 0}foundNewTarget(t,e){const s=Xe(t.stageMemory(e),e.creaturePos(t),e=>e.tangible(t),(t,e)=>this.matcher(e),!0);return!!s.length&&(this.destination=s.pop(),!0)}}class z extends V{act(t,e,s,i=!0){if(this.canAttack(t,e)){if(this.victim&&this.victimInAccess(t,e,this.victim))return new Ft(this.victim,e,s);if(!i)throw"Attacker got called twice";return this.pickNewVictim(t,e),this.act(t,e,s,!1)}}canAttack(t,e){return!!this.findCreature(t,e,e=>this.enemies(t,e))}victimInAccess(t,e,s){if(void 0===s)return!1;return!!this.findCreature(t,e,t=>t.id===s.id)}pickNewVictim(t,e){this.victim=this.findCreature(t,e,e=>this.enemies(t,e))}findCreature(t,e,s){const i=t.stageMemory(e);return e.creaturePos(t).wrappers().map(({x:t,y:e})=>i.at(t,e).creature).find(t=>!!t&&s(t))}}class Y extends G{foundNewTarget(t,e){return this.victimSet()&&this.buildVictimPath(t,e)||this.foundNewVictim(t,e)}onCantMove(){this.victimId=void 0}onReach(){this.victimId=void 0}victimSet(){return!!this.victimId}goTo(t,e,s){if(!this.destination)throw"Chaser.goTo: no destination";return this.followTo(t,this.destination,e,s)}buildVictimPath(t,e){return this.findCreature(t,e,t=>t.id===this.victimId)}foundNewVictim(t,e){return this.findCreature(t,e,e=>this.enemies(t,e))&&this.buildVictimPath(t,e)}findCreature(t,e,s){let i=!1;return this.withinView(t.stageMemory(e),e.creaturePos(t),({x:t,y:e},r)=>{const a=r.creature;!i&&a&&s(a)&&(this.destination=new c(t,e),this.victimId=a.id,i=!0)}),i}followTo(t,e,s,i){return this.move(t,s,i,t=>e.nextTo(t))}}class X{constructor(t){this.game=t,this.player=t.player,this.logger=t.logger}}class J extends X{constructor(t,e){super(e),this.items=t}run(){this.player.inventory.cares().forEach(t=>{})}immediate(){return!1}}class K extends V{constructor(t){super(),this.aiToRun=t,this.events=[]}pushEvent(t){this.events.push(t)}resetEvents(){this.events=[]}runEvents(){this.events.forEach(t=>{t.run()}),this.resetEvents()}}const Q=2;class Z extends G{constructor(){super(...arguments),this.escapesFrom=[]}foundNewTarget(t,e){return this.foundEnemies(t,e)&&this.buildEscapePath(t,e)}buildEscapePath(t,e,s=t.radius()/2){if(s<=1)return this.destination=void 0,!1;const i=this.buildPath(t,e,({x:t,y:e})=>{return Object(r.sumBy)(this.escapesFrom,([s,i])=>Math.max(Math.abs(t-s.x),Math.abs(e-s.y)))>=s});return i.length?(this.destination=i.pop(),!0):this.buildEscapePath(t,e,s-Q)}foundEnemies(t,e){return this.escapesFrom=[],this.withinView(t.stageMemory(e),e.creaturePos(t),(e,s)=>{const i=s.creature;i&&this.enemies(t,i)&&this.escapesFrom.push([e,i])}),this.escapesFrom.length>0}}class tt extends q{constructor(){super(t=>!t.seen)}}class et extends q{constructor(){super(t=>!!t.items)}act(t,e,s){if(t.can(M.Inventory))return super.act(t,e,s)}onReach(t,e,s){const i=e.creatureTile(t);if(!i.items)throw"Picker.act : nothing to pick up";return t.ai.pushEvent(new J(i.items,s)),new Yt(i,i.items.bunch,s)}}var st=s(25);class it extends V{act(t,e,s){const i=e.creaturePos(t);return this.move(t,e,s,t=>!i.eq(t))}}const rt=10;class at extends A{constructor(t){super(),this.tile=t,this.status=!1}addNode(){return this.status=!1,this.tile.visit(this),this.status}onDoor(){this.status=!0}}class nt extends V{constructor(){super(),this.step=rt,this.firstCallPatrol=!0,this.i="a",this.graph=new st.Graph,this.lastNodeVisit={},this.currentNodeID="a",this.markNodeVisited(this.currentNodeID),this.path=[]}act(t,e,s,i=!0){if(!(this.graph.nodes().length<=1)){if(this.firstCallPatrol){const s=e.creaturePos(t);this.addNode(s),this.firstCallPatrol=!1}return this.step+=1,this.path.length?this.moveToTarget(t,e,s,i):(this.targetNodeID&&(this.markNodeVisited(this.targetNodeID),this.currentNodeID=this.targetNodeID),this.pickUpNewTarget(t,e),this.moveToTarget(t,e,s,i))}}reset(){this.path=[]}trackMovement(t,e){(this.step>=rt||new at(e).addNode())&&this.addNode(t),this.step+=1}addNode(t){this.graph.setNode(this.i,t),this.currentNodeID&&this.currentNodeID!==this.i&&this.graph.setEdge(this.currentNodeID,this.i),this.currentNodeID=this.i,this.i=n(this.i),this.step=0}buildNewPath(t,e){if(!this.targetNodeID)throw"Patrol has no next targetID";const s=this.graph.node(this.targetNodeID);this.path=this.buildPath(t,e,t=>s.eq(t))}pickUpNewTarget(t,e){let s=this.graph.nodes()[0],i=this.lastNodeVisit[s],r=this.graph.neighbors(this.currentNodeID);r&&r.forEach(t=>{i>(this.lastNodeVisit[t]||0)&&(s=t,i=this.lastNodeVisit[s])}),this.targetNodeID=s,this.buildNewPath(t,e)}moveToTarget(t,e,s,i){const r=this.path.shift();return r?t.stageMemory(e).at(r.x,r.y).tangible()?(this.buildNewPath(t,e),this.path.length?this.act(t,e,s,!1):void 0):new H(s,e,r):i?(this.path=[],this.act(t,e,s,!1)):(new it).act(t,e,s)}markNodeVisited(t){this.lastNodeVisit[t]=this.step}}class ht extends V{act(t,e,s){if(!t.can(M.Throwing)||!this.hasMissile(t)||!this.canAttack(t,e,s))return;let i=[];if(!this.victim)throw"Thrower.act called when there is no victim";return d(e.creaturePos(t),e.creaturePos(this.victim),(t,e)=>i.push(new c(t,e))),new zt(i,s,e,t=>{t===L.DIE&&(this.victim=void 0,this.previousVictim=void 0)})}hasMissile(t){return this.missiles=t.inventory.missileSlot.equipment,void 0!==this.missiles}canAttack(t,e,s){return this.previousVictim=this.victim,this.victim=void 0,!(!this.previousVictim||!this.findWithId(t,e,this.previousVictim.id))||this.findCreature(t,e,e=>this.enemies(t,e))}findWithId(t,e,s){return this.findCreature(t,e,t=>s===t.id)}findCreature(t,e,s){const i=t.stageMemory(e),r=e.creaturePos(t);return this.withinView(i,e.creaturePos(t),(a,n)=>{const h=n.creature;!this.victim&&h&&s(h)&&!this.obstacles(t,r,i,a)&&(this.victim=e.at(a.x,a.y).creature)}),!!this.victim}obstacles(t,e,s,i){let r=!1;return d(e,i,(e,i)=>{r=r||s.at(e,i).tangible(t)}),r}}class ot extends A{constructor(){super(...arguments),this.match=!1}onStairwayDown(){this.match=!0}}class ct extends A{constructor(t,e,s){super(),this.actor=t,this.game=e,this.levelMap=s}onStairwayDown(t){const e=this.game.getMap(t.adjacentMapId);t.enterPos=e.matchStairs(this.levelMap.id,this.levelMap.creaturePos(this.actor)),this.event=new H(this.game,this.levelMap,t.enterPos,e)}}class lt extends q{constructor(){super(t=>{const e=new ot;return t.visit(e),e.match})}act(t,e,s){if(t.can(M.GoStairwayDown))return super.act(t,e,s)}onReach(t,e,s){const i=new ct(t,s,e);return e.creatureTile(t).visit(i),i.event}}class ut extends W{affectCreature(t){return L.NOTHING}}class dt extends V{act(t,e,s){if(!t.characteristics.health.atMax)return new ut}}var pt,mt,gt,ft,vt,wt,bt;!function(t){t[t.AbilitiesPicking=0]="AbilitiesPicking",t[t.Death=1]="Death",t[t.Idle=2]="Idle",t[t.Inventory=3]="Inventory",t[t.ItemsListing=4]="ItemsListing",t[t.Missile=5]="Missile",t[t.ProfessionPicking=6]="ProfessionPicking"}(pt||(pt={}));class yt{constructor(t,e,s){this.type=t,this.levelMap=e,this.game=s,this.player=this.game.player}build(){}get tile(){return this.levelMap.creatureTile(this.player)}endTurn(){this.game.player.ai.endTurn()}redirect(t){this.game.player.ai.redirect(t)}}class xt extends yt{constructor(t,e,s){super(pt.Death,e,s),this.dieReason=t}get playerName(){return this.game.player.name}}class Mt extends X{constructor(t,e,s){super(s),this.level=t,this.levelMap=e}run(){if(!this.game.ai)throw"AINewLevelEvent.run: game.ai is undefined";this.level%3==0?this.game.ai.presenter=new Ye(this.level,this.levelMap,this.game):this.game.ai.presenter=new ze(this.level,this.levelMap,this.game)}immediate(){return!0}}class Ct extends X{constructor(t,e,s){super(s),this.dieReason=t,this.levelMap=e}run(){if(!this.game.ai)throw"AINewLevelEvent.run: game.ai is undefined";this.game.ai.presenter=new xt(this.dieReason,this.levelMap,this.game)}immediate(){return!0}}class kt extends K{constructor(){super(...arguments),this.presenter=null,this.levelUps=0}act(t,e,s){this.game=s,this.levelMap=e,this.presenter=new $e(e,this.game),this.game.ai=this}endTurn(){let t=this.events.pop();if(t)t.run();else if(this.game&&this.levelMap){this.game.player.on(new O(this.levelMap,this.game));let t=this.events.pop();t?t.run():(this.game.player.ai.runEvents(),this.game.ai=null,this.presenter=null)}}redirect(t){this.presenter=t}}class Tt extends W{constructor(t,e,s){super(),this.actor=t,this.levelMap=e,this.game=s}affectCreature(t){return L.NOTHING}affectPlayer(t){return t.level.add(1).forEach(e=>{t.ai.pushEvent(new Mt(e,this.levelMap,this.game))}),L.NOTHING}}class It{constructor(t,e=t){this.max=t,this.current=e,this.modifiers=[]}get maximum(){return this.max}get atMax(){return this.max===this.current}decrease(t){this.current-=t}increase(t){this.current=Math.min(this.current+t,this.max)}constantIncrease(t){this.max+=t,this.increase(t)}constantDecrease(t){this.max-=t,this.decrease(t)}addModifier(t){this.modifiers.push(t)}removeModifier(t){Object(r.remove)(this.modifiers,e=>e===t)}get currentValue(){return this.current+Object(r.sum)(this.modifiers)}}class Rt extends It{get currentValue(){const t=super.currentValue;return t>=1?t:1}constantDecrease(t){this.max=Math.max(1,this.max-t),this.decrease(t)}decrease(t){this.current=Math.max(1,this.current-t)}}class Et{constructor(t,e,s,i,r,a){this.attack=t,this.defense=e,this.dexterity=s,this.health=i,this.radius=r,this.speed=a}with(t,e){e(this.attack,t.attack),e(this.defense,t.defense),e(this.health,t.health),e(this.radius,t.radius),e(this.speed,t.speed)}}class St extends Et{constructor({attack:t=0,defense:e=0,dexterity:s=0,health:i=0,radius:r=0,speed:a=0}){super(t,e,s,i,r,a)}withWeight(t,e,s){s(this.attack,t.attack,e.attack),s(this.defense,t.defense,e.defense),s(this.health,t.health,e.health),s(this.radius,t.radius,e.radius),s(this.speed,t.speed,e.speed)}}!function(t){t[t.WeaponOneHand=0]="WeaponOneHand",t[t.WearsOnBody=1]="WearsOnBody",t[t.Throw=2]="Throw",t[t.Shoot=3]="Shoot",t[t.Boots=4]="Boots"}(mt||(mt={})),function(t){t[t.BodyArmor=0]="BodyArmor",t[t.OneHandWeapon=1]="OneHandWeapon",t[t.Consumable=2]="Consumable",t[t.Missile=3]="Missile",t[t.Potion=4]="Potion",t[t.MissileWeapon=5]="MissileWeapon",t[t.Boots=6]="Boots"}(gt||(gt={})),function(t){t[t.MissileRock=0]="MissileRock",t[t.Sling=1]="Sling",t[t.Bow=2]="Bow",t[t.Arrows=3]="Arrows"}(ft||(ft={}));class Pt{constructor(t,e,s,i=[],r=new St({}),a=Pt.getId()){this.group=t,this.name=e,this.weight=s,this.usages=i,this.modifier=r,this.id=a}static getId(){return this.lastId++}get canSeeDetails(){return!0}clone(){return new Pt(this.group,this.name,this.weight)}onPutOn(t){t.characteristics.addModifier(this.modifier)}onTakeOff(t){t.characteristics.removeModifier(this.modifier)}groupsWith(t){return this.name===t.name}worksWith(t){return!1}canThrow(t){return!0}}Pt.lastId=0;class _t extends Pt{constructor(t){super(gt.Consumable,`${t.name}'s corpse`,t.weight),this.specie=t}}class Dt extends Pt{constructor(t){super(gt.Potion,t,.2),this.name=t}}class At extends Pt{constructor(t,e,s){super(gt.Missile,t,e,[],s)}}class Wt extends Pt{constructor(t,e,s){super(gt.MissileWeapon,t,e,[mt.Shoot],s)}}!function(t){t[t.Melee=0]="Melee",t[t.Pierce=1]="Pierce",t[t.Blunt=2]="Blunt",t[t.Magic=3]="Magic",t[t.Pure=4]="Pure"}(vt||(vt={}));class Ot extends Pt{constructor(t,e,s,i,r){super(t,e,s,[r]),this.damages=i}}class Nt extends Ot{constructor(t,e,s){super(gt.OneHandWeapon,t,e,s,mt.WeaponOneHand)}}!function(t){t[t.Light=0]="Light",t[t.Medium=1]="Medium",t[t.Heavy=2]="Heavy",t[t.Solid=3]="Solid",t[t.Unarmored=4]="Unarmored"}(wt||(wt={}));class Bt extends Pt{constructor(t,e,s,i,r){super(t,e,s,[r]),this.protections=i}}class Lt extends Bt{constructor(t,e,s){super(gt.BodyArmor,t,e,s,mt.WearsOnBody)}}class Ut extends Bt{constructor(t,e,s){super(gt.Boots,t,e,s,mt.Boots)}}!function(t){t[t.Attack=0]="Attack",t[t.Missile=1]="Missile",t[t.Trap=2]="Trap",t[t.Overloaded=3]="Overloaded"}(bt||(bt={}));class $t extends W{constructor(t,e,s){super(),this.game=t,this.levelMap=e,this.reason=s}affectCreature(t){let e=this.levelMap.creatureTile(t);return this.levelMap.removeCreature(t),t.dead=!0,e.addItem(new _t(t.specie),1),t.inventory.slots().forEach(({equipment:t})=>{t&&e.addItem(t.item,t.count)}),t.inventory.cares().forEach(t=>{e.addItem(t.item,t.count)}),L.DIE}affectPlayer(t){return t.ai.pushEvent(new Ct(this.reason,this.levelMap,this.game)),L.DIE}}class Ft extends W{constructor(t,e,s){super(),this.subject=t,this.levelMap=e,this.game=s}affectCreature(t){if(t.characteristics.misses(this.subject.characteristics))return this.game.logger.missMessage(t,this.subject),L.DODGE;const e=t.characteristics.damageTo(this.subject.characteristics);return e>=this.subject.characteristics.health.currentValue?(t.on(new Tt(this.subject,this.levelMap,this.game)),this.game.logger.killMessage(e,t,this.subject),this.subject.on(new $t(this.game,this.levelMap,bt.Attack)),L.DIE):(this.subject.characteristics.health.decrease(e),this.game.logger.hurtMessage(e,t,this.subject),L.HURT)}}class jt extends W{constructor(t,e){super(),this.potion=t,this.game=e}affectCreature(t){return t.inventory.removeFromBag(this.potion,1),this.potion.onDrink(this.game),this.game.logger.drink(this.potion),L.NOTHING}}class Ht extends W{constructor(t,e,s){super(),this.tile=t,this.items=e,this.game=s}affectCreature(t){return this.items.forEach(({item:e,count:s})=>{t.inventory.removeFromBag(e,s),t.stuffWeight.subtract(e.weight*s),this.game.logger.droppedItem(e,s),this.tile.addItem(e,s)}),L.NOTHING}}class Vt{constructor(t){this.onDone=t}speed(){return-1}}class Gt extends Vt{constructor(t,e,s){super(s),this.item=t,this.frames=e}patchMemory(t){if(this.done())return;const[e]=this.frames.splice(0,1),s=t.at(e.x,e.y);s.visible?s.effect="-":this.patchMemory(t)}done(){return 0===this.frames.length}}class qt extends W{constructor(t,e,s,i){super(),this.subject=t,this.missile=e,this.levelMap=s,this.game=i}affectCreature(t){if(this.subject.characteristics.throwMisses(t.characteristics))return this.game.logger.throwMissMessage(this.subject,t,this.missile),L.THROW_DODGE;const e=this.subject.characteristics.throwDamageTo(t.characteristics,this.missile);return e>=t.characteristics.health.currentValue?(this.subject.on(new Tt(t,this.levelMap,this.game)),this.game.logger.throwKillMessage(e,this.subject,t,this.missile),t.on(new $t(this.game,this.levelMap,bt.Missile)),L.DIE):(t.characteristics.health.decrease(e),this.game.logger.throwHurtMessage(e,this.subject,t,this.missile),L.HURT)}}class zt extends W{constructor(t,e,s,i){super(),this.path=t,this.game=e,this.levelMap=s,this.done=i}affectCreature(t){const e=t.inventory.missileSlot;if(void 0===e.equipment)throw"MissileAttackEvent: slot has no items";const s=e.equipment.item;e.removeItem(t,1),t.stuffWeight.subtract(s.weight);let i,r=[];return this.path.forEach(t=>{if(!i){const e=this.levelMap.at(t.x,t.y);i=e.creature,r.push(t)}}),this.game.effect=new Gt(s,r,()=>{i?this.done(i.on(new qt(t,s,this.levelMap,this.game))):this.done(L.NOTHING)}),L.NOTHING}}class Yt extends W{constructor(t,e,s){super(),this.tile=t,this.items=e,this.game=s}affectCreature(t){let e=this.tile.items;if(void 0===e)throw"Failed to pick up items - tile has no items";return this.withTileItems(t,e),L.NOTHING}withTileItems(t,e){this.items.forEach(({item:s,count:i})=>{t.inventory.putToBag(s,i),t.stuffWeight.add(s.weight*i),this.game.logger.pickedUpItem(s,i),e.remove(s,i)})}}class Xt extends W{constructor(t,e,s){super(),this.slot=t,this.item=e,this.game=s}affectCreature(t){return this.slot.equip(t,this.item),this.game.logger.putOn(this.item),L.NOTHING}}class Jt extends W{constructor(t,e){super(),this.slot=t,this.game=e}affectCreature(t){const e=this.slot.equipment;if(void 0===e)throw`Can not take off item from ${this.slot.name} - nothing equipped`;return this.slot.takeOff(t),this.game.logger.takeOff(e.item),L.NOTHING}}class Kt extends W{constructor(t,e,s){super(),this.trap=t,this.levelMap=e,this.game=s}affectCreature(t){let e=this.levelMap.creaturePos(t);return this.game.player.stageMemory(this.levelMap).at(e.x,e.y).visible&&(this.trap.revealed=!0,this.game.logger.creatureSteppedInTrap(t)),this.doDamage(t)}affectPlayer(t){return this.game.logger.youSteppedInTrap(),this.trap.revealed=!0,this.doDamage(t)}doDamage(t){return 10>=t.characteristics.health.currentValue?(t.on(new $t(this.game,this.levelMap,bt.Trap)),L.DIE):(t.characteristics.health.decrease(10),L.HURT)}}const Qt=function(t,e,s=(()=>!0)){for(let i=1;i<t.height-1;i++)for(let r=1;r<t.width;r++){const a=t.at(r,i),n=t.at(r,i-1),h=t.at(r,i+1),o=t.at(r-1,i),c=t.at(r+1,i);s()&&"C"===a.key&&("D"!==o.key&&"D"!==c.key&&"D"!==n.key&&"D"!==h.key&&("R"!==o.key&&"R"!==c.key&&"R"!==n.key&&"R"!==h.key||("W"===o.key&&"W"===c.key||"W"===n.key&&"W"===h.key)&&t.setTile(r,i,e())))}return t},Zt=function(t,e,s){for(let i=1;i<e.width-1;i++)for(let r=1;r<e.height-1;r++)e.at(i,r).passibleThrough()&&Math.random()<t&&e.addCreature(new c(i,r),s.pick(null));return e},te=function(t,e,s){for(let i=1;i<e.height-1;i++)for(let r=1;r<e.width-1;r++){const a=e.at(r,i);a.passibleThrough()&&Math.random()<t&&a.addItem(s.pick(null),1)}return e},ee=function(t){let e=t.width,s=t.height,i=0,r=0;for(let a=1;a<t.height-1;a++)for(let n=1;n<t.width-1;n++)t.at(n,a).passibleThrough()&&(r=Math.max(a,r),i=Math.max(n,i),s=Math.min(a,s),e=Math.min(n,e));const a=Math.floor((t.width-(i-e))/2)-e,n=Math.floor((t.height-(r-s))/2)-s;return u(t.map,a),t.map.forEach(t=>u(t,n)),t},se=function(t,e,s){let i=t.width*t.height;for(;i>0;){const a=Object(r.random)(0,t.width-1),n=Object(r.random)(0,t.height-1);if(e(t.at(a,n)))return s(a,n),t;i--}throw"post add failed to add tile"};var ie=function(t,e){return o(t[0].length,t.length,(s,i)=>{const r=e.get(t[i].charAt(s));if(r)return r();throw`drawn: Can not find char ${t[i].charAt(s)}`})};const re=0,ae=60,ne=Math.PI/(2*ae);class he extends a{notCross(t){return t.x-re>this.x+this.w||t.y-re>this.y+this.h||t.x+t.w<this.x-re||t.y+t.h<this.y-re}pointWithin(){return new c(this.x+1+h(this.w-1),this.y+1+h(this.h-1))}add(t,e,s){let i=0;for(;i<this.w;){let r=0;for(;r<this.h;)t[this.x+i][this.y+r]=s(),e[this.x+i][this.y+r]=!1,r++;i++}}}class oe extends a{constructor(t,e,s,i){super(t,e,s,i),this.lined=t>=s&&e>=i||s>=t&&i>=e}add(t,e,s){let[i,r,a]=this.horizontalLine(),n=0;for(;n<a;)e[i+n][r]&&(t[i+n][r]=s()),n+=1;let[h,o,c]=this.verticalLine(),l=0;for(;l<c;)e[h][o+l]&&(t[h][o+l]=s()),l+=1}horizontalLine(){return this.lined?[Math.min(this.x,this.w),Math.max(this.y,this.h),Math.abs(this.w-this.x)]:[Math.min(this.x,this.w),Math.min(this.y,this.h),Math.abs(this.w-this.x)]}verticalLine(){return this.lined,[Math.min(this.x,this.w),Math.min(this.y,this.h),Math.abs(this.h-this.y)]}}var ce=function(t,e,s,i,r,a,n,c){const l=new class{constructor(t,e,s,i,r){this.maxX=t,this.maxY=e,this.minSize=s,this.maxSize=i,this.roomsCount=r;let a=new Array(this.roomsCount).fill(void 0).map(t=>this.generateRoom());this.rooms=this.normalize(this.ray(a)),this.roads=this.buildRoads(this.rooms)}generateRoom(){return new he(0,0,this.minSize+h(this.maxSize-this.minSize),this.minSize+h(this.maxSize-this.minSize))}ray(t){return t.reduce((t,e)=>{for(let s=0,i=h(360)/180*Math.PI;s<ae;i+=ne,s++){const s=Math.cos(i),r=Math.sin(i);let a=1,n=0,h=0,o=new he(e.x,e.y,e.w,e.h);for(;Math.abs(n)<this.maxX/2&&Math.abs(h)<this.maxY/2;){let e=Math.round(a*s),i=Math.round(a*r);for(;e===n&&i===h;)a+=1,e=Math.round(a*s),i=Math.round(a*r);if(o.move(e-n,i-h),n=e,h=i,t.every(t=>o.notCross(t)))return t.push(o),t}}return t},[])}normalize(t){if(0===t.length)return t;const e=g(t.map(t=>t.x))-1;t.forEach(t=>{t.move(-e,0)}),t=t.filter(t=>t.x+t.w<this.maxX);const s=g(t.map(t=>t.y))-1;return t.forEach(t=>{t.move(0,-s)}),t.filter(t=>t.y+t.h<this.maxY)}buildRoads(t){let e=t.map(t=>t.pointWithin());const s=e.shift();if(!s)throw"Dungeon.buildRoads rooms array is empty";let i=[s],r=[];const a=function(t,e){return Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)};for(;e.length;){let t=e.shift();if(!t)throw"Dungeon.buildRoads rooms array is empty";let s=t,n=i[0],h=a(s,n);i.forEach(t=>{const e=a(t,s);e<h&&(n=t,h=e)}),i.push(s),r.push(new oe(s.x,s.y,n.x,n.y))}return r}}(t,e,s,i,r);let u=o(t,e,c),d=o(t,e,()=>!0);for(let t=0;t<l.rooms.length;t++)l.rooms[t].add(u,d,a);for(let t=0;t<l.roads.length;t++)l.roads[t].add(u,d,n);return u};var le,ue,de,pe;!function(t){t[t.Blind=0]="Blind",t[t.Stressed=1]="Stressed",t[t.Loaded=2]="Loaded",t[t.Overloaded=3]="Overloaded"}(le||(le={}));class me{constructor(){this.constEffects=[],this.tempEffects=0}addTempEffect(t){this.tempEffects+=t}addConstEffect(t){this.constEffects.push(t)}removeTempEffect(){this.tempEffects=0}removeConstEffect(t){Object(r.remove)(this.constEffects,e=>e===t)}active(){return this.tempEffects>0||this.constEffects.length>0}turn(){this.tempEffects>=1&&(this.tempEffects-=1)}}class ge{constructor(){this.impacts=new Map}get activeImpacts(){let t=[];return this.impacts.forEach((e,s)=>{e.active()&&t.push(s)}),t}addImpact(t,e){this.impactByType(t).addTempEffect(e)}removeImpact(t){this.impactByType(t).removeTempEffect()}addConstImpact(t,e){this.impactByType(t).addConstEffect(e)}removeConstImpact(t,e){this.impactByType(t).removeConstEffect(e)}turn(){this.impacts.forEach(t=>t.turn())}impactByType(t){let e=this.impacts.get(t);return void 0!==e?e:(e=new me,this.impacts.set(t,e),e)}}class fe{constructor(t){this.requires=t,this.current=1,this.currentExperience=0,this.doneLeveling=!1,this.requiredExperience=this.requires[0]}add(t){if(this.doneLeveling)return[];this.currentExperience+=t;let e=[];for(;!this.doneLeveling&&this.currentExperience>=this.requiredExperience;)this.levelUp(),e.push(this.current);return e}levelUp(){this.current+=1;let t=this.requires[this.current-1];t?(this.currentExperience-=this.requiredExperience,this.requiredExperience=t):(this.currentExperience=this.requiredExperience,this.doneLeveling=!0)}}class ve{constructor(t){this.totalWeight=0,this.items=[],t.forEach(([t,e])=>this.add(t,e))}add(t,e){if(t<1)throw"Item's weight is lower than 1";this.items.push([t,e]),this.totalWeight+=Math.ceil(t)}pick(t){if(0===this.items.length)throw"Tried to use empty pool";let e=Object(r.random)(this.totalWeight);const s=this.items.find(([t,s])=>(e-=t)<=0);if(void 0!==s)return s[1](t);throw"Pool failed to pick anything"}merge(t){let e=new ve([]);return this.items.forEach(([t,s])=>e.add(t,s)),t.items.forEach(([t,s])=>e.add(t,s)),e}}class we{constructor(){this.step=0,this.turns={}}add(t,e){const s=this.step+e;this.turns[s]?Object(r.includes)(this.turns[s],t)||this.turns[s].push(t):this.turns[s]=[t]}remove(t){Object(r.forEach)(this.turns,(e,s)=>{Object(r.remove)(e,e=>e===t)}),this.turns=Object(r.pickBy)(this.turns,t=>t.length>0)}next(){this.step=this.nextStep();const[t]=Object(r.pullAt)(this.turns[this.step],0);return 0===this.turns[this.step].length&&delete this.turns[this.step],void 0===t?this.next():t}actors(){if(0===Object(r.size)(this.turns))return[];this.step=this.nextStep();const t=this.turns[this.step];return delete this.turns[this.step],t}nextStep(){let t=Object(r.min)(Object(r.keys)(this.turns).map(t=>parseInt(t)));if(void 0===t)throw"Timeline.nextStep called when there is no ones turn";return t}}class be extends Et{constructor({attack:t,defense:e,dexterity:s,health:i,radius:r,speed:a}){super(new Rt(t),new Rt(e),new Rt(s),new It(i),new Rt(r),new Rt(a))}addModifier(t){this.with(t,(t,e)=>{0!==e&&t.addModifier(e)})}removeModifier(t){this.with(t,(t,e)=>{0!==e&&t.removeModifier(e)})}damageTo(t){return Math.round(10*this.attack.currentValue/t.defense.currentValue)}misses(t){let e=this.dexterity.currentValue;return Math.random()>e/(e+Math.pow(.25*t.dexterity.currentValue,.8))}throwMisses(t){return this.misses(t)}throwDamageTo(t,e){return 10}regenerate(){this.health.increase(this.regenerationValue())}regenerationValue(){return 1}regenerateEvery(){return 8}levelUp(t){this.health.constantIncrease(3),Math.random()>.5?this.attack.constantIncrease(1):this.defense.constantIncrease(1)}}class ye{constructor(){this.levels=[]}addStairDown(t,e){return this.addStairs(t,new P(t,e))}addStairUp(t,e){return this.addStairs(t,new _(t,e))}addStairs(t,e){return se(t,t=>t.isFloor()&&t.passibleThrough(),(s,i)=>{t.setTile(s,i,e)}),t}}class xe extends l{constructor(t,e){super(e),this.id=t,this.creatures=[],this.name="unnamed",this.timeline=new we}reset(){this.timeline=new we}enter(){this.reset(),this.creatures.forEach(t=>this.timeline.add(t.id,t.speed()))}creatureTile(t){let e;if(this.each(s=>{s.creature&&s.creature.id===t.id&&(e=s)}),!e)throw`Creature ${t.id} is not found on map ${this.id}`;return e}creaturePos(t){let e;if(this.each((s,i,r)=>{s.creature&&s.creature.id===t.id&&(e=new c(i,r))}),!e)throw`Creature ${t.id} is not found on map ${this.id}`;return e}addCreature(t,e){this.creatures.push(e),this.at(t.x,t.y).creature=e,this.timeline.add(e.id,e.speed())}removeCreature(t){let e=this.creaturePos(t);this.at(e.x,e.y).creature=void 0,Object(r.remove)(this.creatures,e=>e.id===t.id),this.timeline.remove(t.id)}visibleThrough(t,e){return this.map[t][e].visibleThrough()}passibleThrough(t,e){return this.map[t][e].passibleThrough()}setTile(t,e,s){this.map[t][e]=s}matchStairs(t,e){let s;if(this.each((i,r,a)=>{(i instanceof P||i instanceof _)&&i.adjacentMapId===t&&(i.enterPos=e,s=new c(r,a))}),s)return s;throw`LevelMap ${this.name} failed to find stairs to ${t}`}}!function(t){t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARNING=2]="WARNING",t[t.DANGER=3]="DANGER"}(ue||(ue={}));class Me{constructor(){this.messages=[]}reset(){this.messages=[]}hurtMessage(t,e,s){this.debug(`${s.name} got ${t} damage from ${e.name}`)}killMessage(t,e,s){this.warning(`${s.name} got ${t} damage from ${e.name} causes them to die`)}missMessage(t,e){this.debug(`${t.name} misses ${e.name}!`)}throwMissMessage(t,e,s){this.debug(`${t.name} throws ${s.name} in ${e.name}, but misses!`)}throwKillMessage(t,e,s,i){this.warning(`${s.name} got ${t} damage from ${e.name} by ${i.name} causes them to die`)}throwHurtMessage(t,e,s,i){this.debug(`${s.name} got ${t} damage from ${e.name} by ${i.name}`)}ranIntoAnObstacle(){this.addMessage(ue.DEBUG,"You ran into a wall")}howToHandle(){this.addMessage(ue.DEBUG,"Don't know how to handle it")}noItemsToPickUp(){this.addMessage(ue.DEBUG,"You don't see anything to pick up")}takeOff(t){this.addMessage(ue.DEBUG,`You took off ${t.name}`)}putOn(t){this.addMessage(ue.DEBUG,`You put on ${t.name}`)}drink(t){this.addMessage(ue.INFO,`You drunk ${t.name}`)}nothingToShotWith(){this.addMessage(ue.DEBUG,"You have nothing to shoot with")}needMissileWeapon(){this.addMessage(ue.DEBUG,"Мне нужен лук или типа того")}youSteppedInTrap(){this.addMessage(ue.DANGER,"Я наступил в ловушку")}creatureSteppedInTrap(t){this.addMessage(ue.DANGER,`${t.name} наступил в ловушку`)}pickedUpItem(t,e){1===e?this.addMessage(ue.INFO,`You picked up ${t.name}`):this.addMessage(ue.INFO,`You picked up ${e} ${t.name}`)}droppedItem(t,e){1===e?this.addMessage(ue.INFO,`You dropped a ${t.name}`):this.addMessage(ue.INFO,`You dropped ${e} ${t.name}`)}debug(t){this.addMessage(ue.DEBUG,t)}info(t){this.addMessage(ue.INFO,t)}warning(t){this.addMessage(ue.WARNING,t)}danger(t){this.addMessage(ue.DANGER,t)}addMessage(t,e){const s=Object(r.last)(this.messages);s&&s.message===e?s.counter+=1:this.messages.push({level:t,message:e,counter:1})}}class Ce{constructor(t,e){this.player=t,this.professionPicker=e,this.logger=new Me,this.ai=null,this.running=!1,this.effect=null,this.maps=new Map}turn(){if(!(this.running||this.ai&&!this.effect)){if(this.running=!0,!this.currentMap)throw"levelMapTurn: Map is undefined";if(this.effect)this.player.rebuildVision(this.currentMap),this.effect.patchMemory(this.player.stageMemory(this.currentMap)),this.effect.done()&&(this.effect.onDone(),this.effect=null),this.running=!1;else{for(;!this.player.dead&&!this.ai;)this.levelMapTurn();this.player.rebuildVision(this.currentMap)}this.running=!1}}getMap(t){const e=this.maps.get(t);if(!e)throw`Map with id ${t} is not found`;if(e instanceof xe)return e;if(e instanceof Function){const s=e(t,this);return this.maps.set(t,s),s}throw`LevelMap with id ${t} is not found`}addMap(t,e){this.maps.set(t,e)}levelMapTurn(){if(!this.currentMap)throw"levelMapTurn: Map is undefined";let t=this.currentMap.timeline,e=this.currentMap;const s=t.next();if(void 0===s)throw"Timeline event is empty!";const i=e.creatures.find(t=>s===t.id);i&&(i.act(e,this),e.creatures.find(t=>s===t.id)&&t.add(s,i.speed()))}}class ke{constructor(t,e,s){this.usages=t,this.useSingleItem=e,this.equipment=s,this.name="InventorySlot"}matchingItems(t){return t.cares().filter(t=>this.match(t.item))}removeItem(t,e){this.equipment&&(this.equipment.count===e?(this.equipment.item.onTakeOff(t),this.equipment=void 0):this.equipment.count-=e)}equip(t,e){let s=t.inventory,i=s.findInBag(e);if(void 0===i)throw`Item ${e.name} can not be equipped - not found in inventory`;this.equipment&&this.takeOff(t);const r=this.useSingleItem?1:i.count;this.equipment={count:r,item:e},s.removeFromBag(e,r),e.onPutOn(t)}takeOff(t){if(!this.equipment)throw`Slot ${this.name} has nothing to take off`;t.inventory.putToBag(this.equipment.item,this.equipment.count),this.equipment.item.onTakeOff(t),this.equipment=void 0}match(t){return Object(r.intersection)(t.usages,this.usages).length>0}withPairItem(t,e){return t.filter(t=>t.item.worksWith(e))}}class Te extends ke{constructor(){super([mt.WeaponOneHand],!0),this.name="Правая рука"}}class Ie extends ke{constructor(){super([mt.WeaponOneHand],!0),this.name="Левая рука"}}class Re extends ke{constructor(){super([mt.WearsOnBody],!0),this.name="Корпус"}}class Ee extends ke{constructor(){super([mt.Boots],!0),this.name="Ботинки"}}class Se extends ke{constructor(){super([mt.Shoot],!0),this.name="Метательное"}matchingItems(t){let e=super.matchingItems(t),s=t.missileSlot.equipment;return s?this.withPairItem(e,s.item):e}}class Pe extends ke{constructor(){super([mt.Throw],!1),this.name="Снаряды"}matchingItems(t){let e=t.cares(),s=t.missileWeaponSlot.equipment;return s?this.withPairItem(e,s.item):e}}class _e{constructor(){this.bag=new b,this.rightHandSlot=new Te,this.leftHandSlot=new Ie,this.bodySlot=new Re,this.missileWeaponSlot=new Se,this.missileSlot=new Pe,this.bootsSlot=new Ee}slots(){return[this.rightHandSlot,this.leftHandSlot,this.bodySlot,this.bootsSlot,this.missileWeaponSlot,this.missileSlot]}cares(){return this.bag.bunch}findInBag(t){return this.bag.find(t)}putToBag(t,e){this.bag.put(t,e)}removeFromBag(t,e){this.bag.remove(t,e)}}class De{constructor(t){this.tile=t,this.visible=!1,this.degree=0,this.seen=!1}get items(){return this.tile.items}get creature(){return this.tile.creature}see(t,e){this.visible=!0,this.degree=e,this.seen=!0,this.tile=t.clone()}tangible(t){return this.seen&&!this.tile.passibleThrough(t)}reset(){this.visible=!1,this.effect=void 0,this.tile.creature=void 0}visit(t){this.tile.visit(t)}}class Ae extends l{constructor(t,e){const s=new E;super(o(t,e,()=>new De(s)))}resetVisible(){this.each(t=>t.reset())}}class We{constructor(t,e,s=1,i=0){this.id=t,this.name=e,this.level=s,this.points=i,this.talents=[],this.depthCost=3}}class Oe{constructor(t,e,s){this.pool=t,this.maxLevel=e,this.maxTaken=s}available(t){let e,s=[];return this.canUpdate(t)?e=this.updatableProfession(t):this.canTakeNewProfession(t)&&(e=this.newFromPool(t)),void 0!==e&&s.push(e),this.canTakeNewProfession(t)?e=this.newFromPool(t,e&&e.id):this.canUpdate(t)&&(e=this.updatableProfession(t,e&&e.id)),void 0!==e&&s.push(e),s}canUpdate(t){return t.professions.some(t=>t.level<this.maxLevel)}updatableProfession(t,e){return Object(r.sample)(t.professions.filter(t=>e!==t.id))}canTakeNewProfession(t){return t.professions.length<this.maxTaken&&this.pool.length>t.professions.length}newFromPool(t,e){const s=t.professions.map(t=>t.id);return void 0!==e&&s.push(e),Object(r.sample)(this.pool.filter(t=>!Object(r.includes)(s,t.id)))}}!function(t){t[t.Available=0]="Available",t[t.Completed=1]="Completed",t[t.Unavailable=2]="Unavailable"}(de||(de={}));class Ne{constructor(t,e,s,i,r,a){this.id=t,this.name=e,this.depth=s,this.rank=i,this.maxRank=r,this.description=a}}class Be extends yt{constructor(t,e){super(pt.Inventory,t,e),this.positions=[],this.takeTime=!1,this.rebuildPositions()}takeOff(t){this.player.on(new Jt(t.inventorySlot,this.game)),this.takeTime=!0,this.rebuildPositions()}putOn(t){this.redirect(new Ve(e=>{this.player.on(new Xt(t.inventorySlot,e.item,this.game)),this.takeTime=!0,this.rebuildPositions(),this.redirect(this)},t.availableItems,this.levelMap,this.game))}close(){this.takeTime?this.endTurn():this.redirect(new $e(this.levelMap,this.game))}rebuildPositions(){this.positions=this.player.inventory.slots().map(t=>({inventorySlot:t,item:t.equipment&&t.equipment.item,count:t.equipment&&t.equipment.count,availableItems:t.matchingItems(this.player.inventory)}))}}class Le extends yt{constructor(t,e){super(pt.Missile,t,e),this.targetEnemyIndex=void 0,this.enemies=[],this.path=[],this.findEnemies(),this.memory=this.player.stageMemory(this.levelMap),this.targetPos=this.resetTargetId()}nextTarget(){void 0!==this.targetEnemyIndex?(this.targetEnemyIndex+=1,this.targetEnemyIndex>=this.enemies.length&&(this.targetEnemyIndex=0),this.updateTarget(this.enemies[this.targetEnemyIndex])):this.resetTargetId()}previousTarget(){void 0!==this.targetEnemyIndex?(this.targetEnemyIndex-=1,this.targetEnemyIndex<0&&(this.targetEnemyIndex=this.enemies.length-1),this.updateTarget(this.enemies[this.targetEnemyIndex])):this.resetTargetId()}moveTarget(t){const e=this.targetPos.add(t);this.levelMap.at(e.x,e.y).visibleThrough()&&this.player.stageMemory(this.levelMap).at(e.x,e.y).visible&&(this.updateTarget(e),this.targetEnemyIndex=void 0)}attack(){this.targetPos.eq(this.levelMap.creaturePos(this.player))||this.player.on(new zt(this.path,this.game,this.levelMap,()=>this.endTurn()))}close(){this.resetPath(),this.redirect(new $e(this.levelMap,this.game))}resetTargetId(){let t;return this.enemies.length?(this.targetEnemyIndex=0,t=this.enemies[this.targetEnemyIndex]):(this.targetEnemyIndex=void 0,t=this.levelMap.creaturePos(this.player)),this.updateTarget(t),t}resetPath(){this.path.forEach(({x:t,y:e})=>this.memory.at(t,e).effect=void 0)}updateTarget(t){this.resetPath(),this.targetPos=t.copy(),this.drawPath()}drawPath(){this.path=[];let t=!1;const e=this.levelMap,s=this.levelMap.creaturePos(this.player);p(s,this.targetPos,(s,i)=>{e.at(s,i).passibleThrough()||(t=!0),this.path.push(new c(s,i)),this.memory.at(s,i).effect=t?"o":"x"})}findEnemies(){this.enemies=[],this.player.stageMemory(this.levelMap).each((t,e,s)=>{t.visible&&t.creature&&t.creature.id!==this.player.id&&this.enemies.push(new c(e,s))})}}!function(t){t[t.Right=0]="Right",t[t.Left=1]="Left",t[t.Down=2]="Down",t[t.Up=3]="Up",t[t.UpRight=4]="UpRight",t[t.UpLeft=5]="UpLeft",t[t.DownRight=6]="DownRight",t[t.DownLeft=7]="DownLeft",t[t.Handle=8]="Handle",t[t.Missile=9]="Missile",t[t.Inventory=10]="Inventory",t[t.Bag=11]="Bag",t[t.PickUp=12]="PickUp",t[t.Drop=13]="Drop",t[t.Drink=14]="Drink"}(pe||(pe={}));class Ue extends A{constructor(t,e,s,i){super(),this.game=t,this.levelMap=e,this.player=s,this.done=i}onStairway(t){const e=this.game.getMap(t.adjacentMapId);t.enterPos=e.matchStairs(this.levelMap.id,this.levelMap.creaturePos(this.player)),this.player.on(new H(this.game,this.levelMap,t.enterPos,e)),this.done()}default(){this.game.logger.howToHandle()}}class $e extends yt{constructor(t,e){super(pt.Idle,t,e)}onInput(t){switch(t){case pe.Right:return this.move(m.right);case pe.Left:return this.move(m.left);case pe.Down:return this.move(m.down);case pe.Up:return this.move(m.up);case pe.UpRight:return this.move(m.upRight);case pe.UpLeft:return this.move(m.upLeft);case pe.DownRight:return this.move(m.downRight);case pe.DownLeft:return this.move(m.downLeft);case pe.Handle:return this.handle();case pe.PickUp:return this.pickUpDialog();case pe.Missile:return this.missileDialog();case pe.Drop:return void this.redirect(new He(this.levelMap,this.game));case pe.Drink:return void this.redirect(new Ge(this.levelMap,this.game));case pe.Inventory:return void this.redirect(new Be(this.levelMap,this.game));case pe.Bag:return void this.redirect(new qe(this.levelMap,this.game))}}move(t){const e=this.levelMap.creaturePos(this.player).add(t),s=this.levelMap.at(e.x,e.y);s.passibleThrough(this.player)?this.player.on(new H(this.game,this.levelMap,e)):s.creature?this.player.on(new Ft(s.creature,this.levelMap,this.game)):this.game.logger.ranIntoAnObstacle(),this.endTurn()}pickUpDialog(){const t=this.tile,e=t.items;void 0===e||0===e.bunch.length?this.game.logger.noItemsToPickUp():1===e.bunch.length?(this.player.on(new Yt(t,e.bunch,this.game)),this.endTurn()):this.redirect(new je(this.levelMap,this.game))}missileDialog(){const t=this.player.inventory.missileSlot.equipment;t&&t.item?t.item.canThrow(this.player)?this.redirect(new Le(this.levelMap,this.game)):this.game.logger.needMissileWeapon():this.game.logger.nothingToShotWith()}handle(){this.tile.visit(new Ue(this.game,this.levelMap,this.player,()=>this.endTurn()))}}class Fe extends yt{constructor(t,e){super(pt.ItemsListing,t,e),this.positions=[],this.title="unnamed",this.initPositions()}close(){this.redirect(new $e(this.levelMap,this.game))}}class je extends Fe{constructor(){super(...arguments),this.title="Что поднять?"}initPositions(){const t=this.tile.items;if(void 0===t)throw"Failed to show pick up dialog - tile has no items";this.positions=t.bunch.map(t=>({item:t.item,count:t.count}))}pickUpItems(t){this.player.on(new Yt(this.tile,t,this.game)),this.endTurn()}}class He extends Fe{constructor(){super(...arguments),this.title="Что положить?"}initPositions(){this.positions=this.player.inventory.cares()}pickUpItems(t){t.length?(this.player.on(new Ht(this.tile,t,this.game)),this.endTurn()):this.redirect(new $e(this.levelMap,this.game))}}class Ve extends Fe{constructor(t,e,s,i){super(s,i),this.onWithItem=t,this.positions=e,this.title="Что надеть?",this.singleItemMode=!0}initPositions(){}pickUpItems(t){}withItem(t){this.onWithItem(t)}close(){this.redirect(new Be(this.levelMap,this.game))}}class Ge extends Fe{constructor(){super(...arguments),this.title="Что выпить?",this.singleItemMode=!0}initPositions(){this.positions=this.player.inventory.cares().filter(t=>t.item.group===gt.Potion)}pickUpItems(t){}withItem(t){this.player.on(new jt(t.item,this.game)),this.endTurn()}}class qe extends Fe{constructor(){super(...arguments),this.title="Сумка",this.singleItemMode=!0}initPositions(){this.positions=this.player.inventory.cares()}pickUpItems(t){}withItem(t){this.endTurn()}}class ze extends yt{constructor(t,e,s){super(pt.AbilitiesPicking,e,s),this.level=t,this.options=[],this.options=this.player.professions.map(t=>({profession:t,talents:t.talents.map(e=>Object.assign({},e,{status:this.status(e,t)}))}))}get title(){return"Pick new talent"}pickTalent(t,e){const s=this.player.professions.find(e=>e.id===t);if(void 0===s)throw`Profession with id ${t} is not found`;let i=s.talents.find(t=>t.id===e);if(void 0===i)throw`Talent with id ${e} for profession ${s.name} is not found`;if(this.status(i,s)!==de.Available)throw`Talent with id ${e} for profession ${s.name} can not be upgraded`;i.rank+=1,s.points+=1,this.player.characteristics.levelUp(this.player.specie),this.endTurn()}status(t,e){return t.rank===t.maxRank?de.Completed:t.depth*e.depthCost>e.points?de.Unavailable:de.Available}}class Ye extends yt{constructor(t,e,s){super(pt.ProfessionPicking,e,s),this.level=t}get title(){return`Gained ${this.level} level`}get options(){return this.game.professionPicker.available(this.player)}pickProfession(t){let e=this.player.professions.find(e=>e.id===t.id);e?e.level+=1:this.player.professions.push(t),this.redirect(new ze(this.level,this.levelMap,this.game))}}const Xe=function(t,e,s,i,a=!1){let n=o(t.width,t.height,()=>-1),h=[],c=[e],l=0;for(;c.length&&!h.length;){let e=[];c.forEach(r=>{if(!t.inRange(r))return;const a=t.at(r.x,r.y);s(a)||-1!==n[r.x][r.y]||(n[r.x][r.y]=l,i(r,a)?h.push(r):r.wrappers().forEach(t=>e.push(t)))}),l++,c=e}if(h.length){let t=Object(r.sample)(h);return Je(a&&t?t:h[0],n)}return[]},Je=function(t,e){let s,i=t,r=[i];for(;1!==e[i.x][i.y];){if(void 0===(s=c.dxy.find(t=>e[i.x+t.x]&&e[i.x+t.x][i.y+t.y]===e[i.x][i.y]-1)))return[];i=i.add(s),r.unshift(i)}return r};var Ke=i.a.extend({name:"Logger",props:["logger"],data:()=>({lastId:0}),computed:{messages(){return Object(r.takeRight)(this.logger.messages,5)}},methods:{counter(t){if(t>1)return`x${t}`},rowClass(t){switch(t.level){case ue.DEBUG:return"debug";case ue.INFO:return"info";case ue.WARNING:return"warning";case ue.DANGER:return"danger"}}}}),Qe=(s(43),s(2)),Ze=Object(Qe.a)(Ke,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"logger"},t._l(t.messages,function(e,i){return s("div",{key:i,class:t.rowClass(e)},[t._v(t._s(e.message)+"\n"+t._s(t.counter(e.counter)))])}))},[],!1,null,"e78aa69c",null);Ze.options.__file="Logger.vue";var ts=Ze.exports;class es{constructor(t,e,s,i,r,a,n){this.ch=t,this.r=e,this.g=s,this.b=i,this.br=r,this.bg=a,this.bb=n}getChar(){return this.ch}setChar(t){this.ch=t}setColor(t,e,s){this.r=t,this.g=e,this.b=s}setGrey(t){this.r=t,this.g=t,this.b=t}setBackground(t,e,s){this.br=t,this.bg=e,this.bb=s}backgroundToColor(){this.r=this.br,this.g=this.bg,this.b=this.bb}swapColors(){this.r=[this.br,this.br=this.r][0],this.g=[this.bg,this.bg=this.g][0],this.b=[this.bb,this.bb=this.b][0]}resetColor(){this.r=this.g=this.b=void 0}resetBackground(){this.br=this.bg=this.bb=void 0}getColorHex(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?"#"+this.r.toString(16)+this.g.toString(16)+this.b.toString(16):""}getBackgroundHex(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?"#"+this.br.toString(16)+this.bg.toString(16)+this.bb.toString(16):""}getColorRGB(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?`rgb(${this.r},${this.g},${this.b})`:""}getBackgroundRGB(){return void 0!==this.br&&void 0!==this.bg&&void 0!==this.bb?`rgb(${this.br},${this.bg},${this.bb})`:""}getColorJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.r,g:this.g,b:this.b}:{}}getBackgroundJSON(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b?{r:this.br,g:this.bg,b:this.bb}:{}}copy(t){this.ch=t.ch,this.r=t.r,this.g=t.g,this.b=t.b,this.br=t.br,this.bg=t.bg,this.bb=t.bb}clone(){return new es(this.ch,this.r,this.g,this.b,this.br,this.bg,this.bb)}}const ss="unicodetiles",is=new es(" ");const rs="\nattribute vec2 position;\nattribute vec2 texCoord;\nattribute vec3 color;\nattribute vec3 bgColor;\nattribute float charIndex;\nuniform vec2 uResolution;\nuniform vec2 uTileCounts;\nuniform vec2 uPadding;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec2 tileCoords = floor(vec2(mod(charIndex, uTileCounts.x), charIndex / uTileCounts.x));\n  vTexCoord = (texCoord + tileCoords) / uTileCounts;\n  vTexCoord += (0.5 - texCoord) * uPadding;\n  vColor = color;\n  vBgColor = bgColor;\n  vec2 pos = position / uResolution * 2.0 - 1.0;\n  gl_Position = vec4(pos.x, -pos.y, 0.0, 1.0);\n}\n",as="\nprecision mediump float;\nuniform sampler2D uFont;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vBgColor;\n\nvoid main() {\n  vec4 color = texture2D(uFont, vTexCoord);\n  color.rgb = mix(vBgColor, vColor, color.rgb);\n  gl_FragColor = color;\n}\n";const ns=function(t){return new class{constructor(t){if(this.view=t,this.view=t,this.canvas=document.createElement("canvas"),!this.canvas.getContext)throw"Canvas not supported";if(this.gl=this.canvas.getContext("experimental-webgl"),!this.gl)throw"WebGL not supported";if(t.elem.appendChild(this.canvas),this.charMap={},this.charArray=[],this.defaultColors={r:1,g:1,b:1,br:0,bg:0,bb:0},this.attribs={position:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},texCoord:{buffer:null,data:null,itemSize:2,location:null,hint:this.gl.STATIC_DRAW},color:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},bgColor:{buffer:null,data:null,itemSize:3,location:null,hint:this.gl.DYNAMIC_DRAW},charIndex:{buffer:null,data:null,itemSize:1,location:null,hint:this.gl.DYNAMIC_DRAW}},this.offscreen||(this.offscreen=document.createElement("canvas")),this.offscreen.style.position="absolute",this.offscreen.style.top="0px",this.offscreen.style.left="0px",this.ctx=this.offscreen.getContext("2d"),!this.ctx)throw"Failed to acquire offscreen canvas drawing context";this.updateStyle(),this.canvas.width=(t.squarify?this.th:this.tw)*t.w,this.canvas.height=this.th*t.h,this.offscreen.width=0,this.offscreen.height=0,this.updateStyle(),this.gl.viewport(0,0,this.canvas.width,this.canvas.height);let e=this.compileShader(this.gl.VERTEX_SHADER,rs),s=this.compileShader(this.gl.FRAGMENT_SHADER,as),i=this.gl.createProgram();if(this.gl.attachShader(i,e),this.gl.attachShader(i,s),this.gl.linkProgram(i),this.gl.deleteShader(e),this.gl.deleteShader(s),!this.gl.getProgramParameter(i,this.gl.LINK_STATUS)){const t=`Error linking program: ${this.gl.getProgramInfoLog(i)}`;throw this.gl.deleteProgram(i),t}this.gl.useProgram(i),this.attribs.position.location=this.gl.getAttribLocation(i,"position"),this.attribs.texCoord.location=this.gl.getAttribLocation(i,"texCoord"),this.attribs.color.location=this.gl.getAttribLocation(i,"color"),this.attribs.bgColor.location=this.gl.getAttribLocation(i,"bgColor"),this.attribs.charIndex.location=this.gl.getAttribLocation(i,"charIndex"),this.initBuffers();let r=this.gl.getUniformLocation(i,"uResolution");this.gl.uniform2f(r,this.canvas.width,this.canvas.height),this.tileCountsLocation=this.gl.getUniformLocation(i,"uTileCounts"),this.gl.uniform2f(this.tileCountsLocation,this.view.w,this.view.h),this.paddingLocation=this.gl.getUniformLocation(i,"uPadding"),this.gl.uniform2f(this.paddingLocation,0,0);let a=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.cacheChars(" !\"#$%&'()*+,-./0123456789:<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.activeTexture(this.gl.TEXTURE0),setTimeout(()=>{this.updateStyle(),this.buildTexture(),this.render()},100)}getRendererString(){return"webgl"}buildTexture(){let t=this.offscreen.width/(this.tw+this.pad),e=this.offscreen.height/(this.th+this.pad);const s=this.charArray.length;s>Math.floor(t)*Math.floor(e)&&(e=(t=Math.ceil(Math.sqrt(s)))+2,this.offscreen.width=t*(this.tw+this.pad),this.offscreen.height=e*(this.th+this.pad),this.updateStyle(),this.gl.uniform2f(this.tileCountsLocation,t,e)),this.gl.uniform2f(this.paddingLocation,this.pad/this.offscreen.width,this.pad/this.offscreen.height);let i,r=0;this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.offscreen.width,this.offscreen.height),this.ctx.fillStyle="#ffffff";const a=.5*this.gap,n=this.tw+this.pad,h=this.th+this.pad;let o=.5*h;for(let s=0;s<e;++s){let e=.5*this.pad;for(let s=0;s<t&&void 0!==(i=this.charArray[r]);++s,++r)this.ctx.fillText(i,e+a,o),e+=n;if(!i)break;o+=h}this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.offscreen)}cacheChars(t,e=!0){if(!this.gl)return;let s=!1;for(let e=0;e<t.length;++e)this.charMap[t[e]]||(s=!0,this.charArray.push(t[e]),this.charMap[t[e]]=this.charArray.length-1);s&&e&&this.buildTexture()}updateStyle(t){t=t||window.getComputedStyle(this.view.elem,null),this.ctx.font=t.fontSize+"/"+t.lineHeight+" "+t.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="#ffffff",this.tw=this.ctx.measureText("幅").width,this.th=parseInt(t.fontSize,10),this.gap=this.view.squarify?this.th-this.tw:0,this.view.squarify&&(this.tw=this.th),this.pad=2*Math.ceil(.2*this.th);const e=t.color.match(/\d+/g),s=t.backgroundColor.match(/\d+/g);this.defaultColors.r=parseInt(e[0],10)/255,this.defaultColors.g=parseInt(e[1],10)/255,this.defaultColors.b=parseInt(e[2],10)/255,this.defaultColors.br=parseInt(s[0],10)/255,this.defaultColors.bg=parseInt(s[1],10)/255,this.defaultColors.bb=parseInt(s[2],10)/255}clear(){}render(){this.gl.clear(this.gl.COLOR_BUFFER_BIT);const t=this.view.w,e=this.view.h;let s=this.view.buffer,i=(this.view.defaultColor,this.view.defaultBackground,!1);for(let r=0;r<e;++r)for(let e=0;e<t;++e){const a=s[r][e];let n=this.charMap[a.ch];void 0===n&&(this.cacheChars(a.ch,!1),i=!0,n=this.charMap[a.ch]);const h=6*this.attribs.color.itemSize*(r*t+e),o=6*this.attribs.charIndex.itemSize*(r*t+e),c=void 0===a.r?this.defaultColors.r:a.r/255,l=void 0===a.g?this.defaultColors.g:a.g/255,u=void 0===a.b?this.defaultColors.b:a.b/255,d=void 0===a.br?this.defaultColors.br:a.br/255,p=void 0===a.bg?this.defaultColors.bg:a.bg/255,m=void 0===a.bb?this.defaultColors.bb:a.bb/255;for(let t=0;t<6;++t){const e=h+t*this.attribs.color.itemSize;this.attribs.color.data[e+0]=c,this.attribs.color.data[e+1]=l,this.attribs.color.data[e+2]=u,this.attribs.bgColor.data[e+0]=d,this.attribs.bgColor.data[e+1]=p,this.attribs.bgColor.data[e+2]=m,this.attribs.charIndex.data[o+t]=n}}i&&this.buildTexture(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.color.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.color.data,this.attribs.color.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.bgColor.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.bgColor.data,this.attribs.bgColor.hint),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.attribs.charIndex.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.attribs.charIndex.data,this.attribs.charIndex.hint);const r=this.attribs.position;this.gl.drawArrays(this.gl.TRIANGLES,0,r.data.length/r.itemSize)}compileShader(t,e){const s=this.gl.createShader(t);if(this.gl.shaderSource(s,e),this.gl.compileShader(s),!this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)){const t="Error compiling shader: "+this.gl.getShaderInfoLog(s);throw this.gl.deleteShader(s),t}return s}initBuffers(){let t,e,s=this.attribs;const i=this.view.w,r=this.view.h;for(t in this.attribs)(e=s[t]).data=new Float32Array(6*e.itemSize*i*r);for(let t=0;t<r;++t)for(let e=0;e<i;++e){const r=6*s.position.itemSize*(t*i+e);this.insertQuad(s.position.data,r,e*this.tw,t*this.th,this.tw,this.th),this.insertQuad(s.texCoord.data,r,0,0,1,1)}for(t in this.attribs)(e=s[t]).buffer&&this.gl.deleteBuffer(e.buffer),e.buffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e.data,e.hint),this.gl.enableVertexAttribArray(e.location),this.gl.vertexAttribPointer(e.location,e.itemSize,this.gl.FLOAT,!1,0,0)}insertQuad(t,e,s,i,r,a){const n=s,h=i,o=s+r,c=i+a;t[e]=n,t[++e]=h,t[++e]=o,t[++e]=h,t[++e]=n,t[++e]=c,t[++e]=n,t[++e]=c,t[++e]=o,t[++e]=h,t[++e]=o,t[++e]=c}}(t)};var hs,os;!function(t){t[t.AttackerTwoHandedWeapons=0]="AttackerTwoHandedWeapons",t[t.AttackerHeavyWeapons=1]="AttackerHeavyWeapons",t[t.AttackerLightWeapons=2]="AttackerLightWeapons",t[t.AttackerTwoWeapons=3]="AttackerTwoWeapons",t[t.AttackerDoubleTwoHandedWeapons=4]="AttackerDoubleTwoHandedWeapons",t[t.AttackerStrongGrip=5]="AttackerStrongGrip"}(hs||(hs={}));class cs extends Ne{constructor(t,e,s,i,r,a=""){super(t,e,s,i,r,a)}}class ls extends cs{constructor(){super(hs.AttackerTwoHandedWeapons,"Двуручные оружия",0,0,3)}onObtain(t){}}!function(t){t[t.Attacker=0]="Attacker",t[t.Defender=1]="Defender"}(os||(os={}));class us extends We{constructor(t=1){super(os.Attacker,"Оружейник",t),this.talents.push(new ls)}}class ds extends We{constructor(t=1){super(os.Defender,"Защитник",t),this.talents.push(new ls)}}class ps extends Oe{constructor(t,e=new us,s=new ds){super([e,s],3,6),this.attacker=e,this.defender=s}}class ms extends At{worksWith(t){return t instanceof fs}}class gs extends At{worksWith(t){return t instanceof vs}canThrow(t){return!!t.inventory.missileWeaponSlot.equipment}}class fs extends Wt{worksWith(t){return t instanceof ms}}class vs extends Wt{worksWith(t){return t instanceof gs}}const ws=new St({}),bs=()=>new vs("Обычный лук",1,ws),ys=()=>new ms("Маленький камень",.3,ws),xs=()=>new gs("Деревянная стрела",.2,ws),Ms=()=>new gs("Железная стрела",.25,ws),Cs=new ve([[1,()=>new Nt("Катана",1,[{type:vt.Melee,dice:{times:5,max:2},extra:0}])],[7,()=>new Nt("Кинжал",.8,[{type:vt.Melee,dice:{times:1,max:3},extra:2}])]]),ks=new ve([[1,()=>new Lt("Кольчуга",5,[{type:wt.Medium,value:3}])],[5,()=>new Lt("Латы",3,[{type:wt.Heavy,value:5}])],[10,()=>new Lt("Роба",1,[{type:wt.Unarmored,value:1}])],[100,()=>new class extends Dt{constructor(){super("Зелье лечения")}onDrink(t){t.player.characteristics.health.increase(5)}}]]);class Ts extends Ut{constructor(){super("Кроссовки скорости света",.1,[])}onPutOn(t){t.addImpact(le.Blind,this.name)}onTakeOff(t){t.removeImpact(le.Blind,this.name)}}const Is=(t,e)=>new class extends ${constructor(t,e,s,i=$.getId()){super(t,s,i),this.ai=e}act(t,e){this.visionMask(t);const s=this.ai.act(this,t,e);s&&this.on(s),this.on(new O(t,e))}}(t,new class extends K{constructor(){super(),this.step=0,this.escaper=new Z,this.explorer=new tt,this.chaser=new Y,this.attacker=new z,this.picker=new et,this.patrol=new nt,this.loiter=new it,this.thrower=new ht,this.descender=new lt}act(t,e,s){let i;return this.step+=1,this.step%t.characteristics.regenerateEvery()==0&&t.characteristics.regenerate(),this.runEvents(),this.feelsGood(t)?(i=this.attacker.act(t,e,s))||(i=this.thrower.act(t,e,s))||(i=this.chaser.act(t,e,s))||(i=this.picker.act(t,e,s))||(i=this.explore(t,e,s)):this.healthCritical(t)&&(i=this.escaper.act(t,e,s))||(i=this.attacker.act(t,e,s))||(i=this.thrower.act(t,e,s))||(i=this.chaser.act(t,e,s))||(i=(new dt).act(t,e,s)),this.resetEvents(),i}feelsGood(t){return t.characteristics.health.currentValue>.9*t.characteristics.health.maximum}healthCritical(t){return t.characteristics.health.currentValue<t.characteristics.health.maximum/4}explore(t,e,s){let i;return(i=this.explorer.act(t,e,s))?t.dead||this.patrol.trackMovement(e.creaturePos(t),e.creatureTile(t)):(i=this.descender.act(t,e,s))||(i=this.patrol.act(t,e,s))||(i=this.loiter.act(t,e,s)),i}},new B(e,10,x.PlayerOnlyEnemy,[])),Rs=()=>Is(new be({attack:1,defense:1,dexterity:1,health:1,radius:5,speed:90}),"Rat"),Es=()=>Is(new be({attack:3,defense:3,dexterity:2,health:5,radius:5,speed:100}),"Orc"),Ss=()=>Is(new be({attack:2,defense:7,dexterity:1,health:10,radius:5,speed:120}),"Undead"),Ps=()=>Is(new be({attack:5,defense:5,dexterity:3,health:7,radius:7,speed:90}),"Robot"),_s=new ve([[10,Rs],[1,()=>Is(new be({attack:1,defense:1,dexterity:1,health:100,radius:5,speed:200}),"Floating eye")]]);new ve([[1,Rs],[2,Es]]),new ve([[1,Rs],[1,Es],[2,Ss]]),new ve([[2,Ss],[2,Ps]]),new ve([[2,Ps],[1,()=>Is(new be({attack:7,defense:7,dexterity:7,health:30,radius:5,speed:100}),"Dragon")]]);var Ds;!function(t){t[t.Fire=0]="Fire",t[t.Ice=1]="Ice"}(Ds||(Ds={}));class As extends D{constructor(t=!1){super(t,Ds.Fire)}buildNew(){return new As(this.revealed)}affect(t,e,s){s.on(new Kt(this,e,t))}}class Ws extends D{constructor(t=!1){super(t,Ds.Ice)}buildNew(){return new Ws(this.revealed)}affect(t,e,s){s.on(new Kt(this,e,t))}}const Os=-1,Ns={addDoors:!1,minSize:3,maxSize:10,roomsCount:10,simple:!0},Bs=new Map;Bs.set("C",()=>new T("C",y.Floor)),Bs.set("W",()=>new E),Bs.set("R",()=>new k("R",y.Floor)),Bs.set("D",()=>new R);class Ls extends ye{enter(t,e){const s=t.currentMap=t.getMap(Os);se(s,t=>t.isFloor()&&t.passibleThrough(),(t,i)=>{s.addCreature(new c(t,i),e)})}register(t){t.addMap(-1,(t,e)=>Zt(.1,this.addStairDown(this.generateMap(t),0),_s));for(let e=0;e<5;e++)t.addMap(e,(t,s)=>Zt(.01*e,this.addStairUp(this.addStairDown(this.generateMap(t),e+1),e-1),_s));t.addMap(5,(t,e)=>this.addStairUp(this.generateMap(t),4))}generateMap(t){let e=new xe(t,ce(40,30,Ns.minSize,Ns.maxSize,Ns.roomsCount,()=>new I,()=>new T("C",y.Floor),()=>new E));if(Ns.simple&&(e=new xe(t,ie(["WWWWWWWWWWWWWWWWWWWWWW","WRRRRRRRRRRRRRRRRRRRRW","WRRRRRRRRRRRRRRRRRRRRW","WRRRRRRRRRRRRRRRRRRRRW","WRRRRRRRRRRRRRRRRRRRRW","WRRRRRRRRRRRRRRRRRRRRW","WWWWWWWWWWWWWWWWWWWWWW"],Bs))),Ns.addDoors){const t=Bs.get("D");if(void 0===t)throw"Door is not found";Qt(e,t)}ee(e),e.name=`MP ${t}`;for(let t=0;t<10;t++)se(e,t=>t.isFloor()&&t.passibleThrough(),(t,s)=>{e.setTile(t,s,new As)}),se(e,t=>t.isFloor()&&t.passibleThrough(),(t,s)=>{e.setTile(t,s,new Ws)});return te(.05,e,Cs.merge(ks)),e}}class Us extends Ce{constructor(t){super(t,new ps(t))}}const $s=120,Fs=180,js={r:255,g:165,b:0};class Hs extends es{lighted(t){return this}constructor(t,e=$s,s=$s,i=$s){super(t,e,s,i)}litBackground(t,e){return t.setBackground(js.r*e,js.g*e,js.b*e),t}litColor(t,e){return t.setColor(js.r*e,js.g*e,js.b*e),t}}class Vs extends Hs{constructor(t){super(t,Fs,Fs,Fs)}}class Gs extends Vs{constructor(t,e,s,i){super(t),this.vr=e,this.vg=s,this.vb=i}lighted(t){let e=this.clone();return e.setColor(this.vr,this.vg,this.vb),e}}class qs extends Hs{constructor(t,e,s,i){super(t),this.vr=e,this.vg=s,this.vb=i}lighted(t){let e=this.clone();return e.setColor(this.vr,this.vg,this.vb),e}}const zs=new qs("刀",200,200,200),Ys=new qs("体",200,200,200),Xs=new qs("胸",200,200,200),Js=new qs("石",200,200,200),Ks=new qs("]",200,200,200),Qs=new qs("[",255,255,0),Zs=new qs("！",200,200,200),ti=function(t){switch(t.group){case gt.OneHandWeapon:return zs;case gt.Consumable:return Ys;case gt.BodyArmor:return Xs;case gt.Missile:return Js;case gt.MissileWeapon:return Ks;case gt.Potion:return Zs;case gt.Boots:return Qs;default:return console.error(`Unknown group ${t} with type ${t.group}`),Ys}},ei=new class extends Hs{constructor(){super("戸")}lighted(t){let e=this.clone();return this.litColor(e,t),e.swapColors(),e}},si=new class extends Hs{constructor(){super("＃")}lighted(t){let e=this.clone();return this.litBackground(e,t),e.backgroundToColor(),e}},ii=new class extends Hs{constructor(){super("・")}lighted(t){return this.litColor(this.clone(),t)}},ri=new class extends Hs{constructor(){super("＞")}},ai=new class extends Hs{constructor(){super("＜")}},ni=new Hs("　",0,0,0),hi=new Hs("^",200,0,0),oi=new Hs("^",0,0,200);const ci=new class extends A{onWall(t){this.tile=si}onFloor(t){this.tile=ii}onStairwayDown(t){this.tile=ri}onStairwayUp(t){this.tile=ai}onDoor(t){this.tile=ei}onTrap(t){if(t.revealed)switch(t.type){case Ds.Fire:this.tile=hi;break;case Ds.Ice:this.tile=oi}else this.tile=ii}default(t){this.tile=ni}},li=new Gs("＠",0,255,0),ui=new Gs("r",197,65,38),di=new Hs("　",0,0,0),pi=[new qs("｜",200,200,200),new qs("／",200,200,200),new qs("ー",200,200,200),new qs("＼",200,200,200)];var mi=i.a.extend({props:["level","player","pos"],data:()=>({wholeMap:!1,term:null,eng:null,drawInterval:null,ts:Date.now(),interval:100,step:0}),methods:{getTile(t,e){const s=this.stage.at(t,e).effect,i=this.wholeMap?this.stage.at(t,e):this.stage.at(t,e).tile;if(!i)return di;if(s){if(i.creature){let t=this.creatureTile(i.creature).clone();return t.setBackground(200,0,0),t}return new Hs(s,200,200,0)}if(i.creature)return this.creatureTile(i.creature);if(i.items)switch(i.items.bunch.length){case 0:break;case 1:return ti(i.items.bunch[0].item);default:const t=this.step%(3*this.animationFps+4);if(t<pi.length)return pi[t];{const t=Math.floor(this.step/(3*this.animationFps+4));return ti(i.items.bunch[t%i.items.bunch.length].item)}}return function(t){return t.visit(ci),ci.tile}(i)},creatureTile:t=>"Rat"==t.name?ui:li,initViewport(){this.term=new class{constructor(t,e,s,i,r=!1){this.elem=t,this.w=e,this.h=s,this.squarify=r,this.cx=Math.floor(e/2),this.cy=Math.floor(s/2),this.elem.innerHTML="",-1===t.className.indexOf(ss)&&(0===t.className.length?t.className=ss:t.className+=" "+ss),this.buffer=new Array(s);for(let t=0;t<s;++t){this.buffer[t]=new Array(e);for(let s=0;s<e;++s)this.buffer[t][s]=is}this.renderer=i(this)}updateStyle(t){const e=window.getComputedStyle(this.elem,null);this.defaultColor=e.color||void 0,this.defaultBackground=e.backgroundColor||void 0,t&&this.renderer.updateStyle(e)}getRendererString(){return this.renderer.getRendererString()}put(t,e,s){e<0||s<0||e>=this.w||s>=this.h||(this.buffer[s][e]=t)}unsafePut(t,e,s){this.buffer[s][e]=t}putString(t,e,s,i,r,a,n,h,o){const c=t.length;if(!(e<0||s<0))for(let l=0;l<c;++l){if(e>=this.w&&(e=0,++s),s>=this.h)return;const c=new es(t[l],i,r,a,n,h,o);this.unsafePut(c,e,s),++e}}get(t,e){return t<0||e<0||t>=this.w||e>=this.h?is:this.buffer[e][t]}clear(){for(let t=0;t<this.h;++t)for(let e=0;e<this.w;++e)this.buffer[t][e]=is;this.renderer.clear()}render(){this.renderer.render()}}(this.$refs.scene,Math.max(this.level.width,40),Math.max(this.level.height,40),ns,!0),this.eng=new class{constructor(t,e,s,i){this.viewport=t,this.tileFunc=e,this.w=s,this.h=i,this.refreshCache=!0,this.cacheEnabled=!1,this.transitionDuration=0,this.cachex=0,this.cachey=0,this.tileCache=new Array(t.h),this.tileCache2=new Array(t.h);for(let e=0;e<t.h;++e)this.tileCache[e]=new Array(t.w),this.tileCache2[e]=new Array(t.w)}setTileFunc(t,e,s){e&&(this.transition=void 0,"string"==typeof e&&("boxin"===e?this.transition=function(t,e,s,i,r,a,n){const h=.5*s,o=.5*i;return t-=h,e-=o,Math.abs(t)<h*n&&Math.abs(e)<o*n?r:a}:"boxout"===e?this.transition=function(t,e,s,i,r,a,n){const h=.5*s,o=.5*i;return t-=h,e-=o,n=1-n,Math.abs(t)<h*n&&Math.abs(e)<o*n?a:r}:"circlein"===e?this.transition=function(t,e,s,i,r,a,n){const h=.5*s,o=.5*i;return(t-=h)*t+(e-=o)*e<(h*h+o*o)*n?r:a}:"circleout"===e?this.transition=function(t,e,s,i,r,a,n){const h=.5*s,o=.5*i;return(t-=h)*t+(e-=o)*e>(h*h+o*o)*(n=1-n)?r:a}:"random"===e&&(this.transition=function(t,e,s,i,r,a,n){return Math.random()>n?a:r})),this.transition&&(this.transitionTimer=(new Date).getTime(),this.transitionDuration=s||500)),this.tileFunc=t}setMaskFunc(t){this.maskFunc=t}setShaderFunc(t){this.shaderFunc=t}setWorldSize(t,e){this.w=t,this.h=e}setCacheEnabled(t){this.cacheEnabled=t,this.refreshCache=!0}update(t,e){t=t||0,e=e||0;const s=t-this.viewport.cx,i=e-this.viewport.cy,r=(new Date).getTime();let a,n;this.transition&&this.transitionTimer&&(a=(r-this.transitionTimer)/this.transitionDuration),a&&a>=1&&(this.transition=void 0);for(let t=0;t<this.viewport.h;++t)for(let e=0;e<this.viewport.w;++e){const h=e+s,o=t+i;if(this.w&&(h<0||h>=this.w))n=is;else if(this.h&&(o<0||o>=this.h))n=is;else if(this.maskFunc&&!this.maskFunc(h,o))n=is;else if(this.transition&&!this.refreshCache)n=this.transition(e,t,this.viewport.w,this.viewport.h,this.tileFunc(h,o),this.tileCache[t][e],a||0);else if(this.cacheEnabled&&!this.refreshCache){const t=h-this.cachex,e=o-this.cachey;t>=0&&t<this.viewport.w&&e>=0&&e<this.viewport.h?(n=this.tileCache[e][t])===is&&(n=this.tileFunc(h,o)):n=this.tileFunc(h,o)}else n=this.tileFunc(h,o);this.tileCache2[t][e]=n,this.shaderFunc&&n!==is&&(n=this.shaderFunc(n,h,o,r)),this.viewport.unsafePut(n,e,t)}this.cachex=s,this.cachey=i;const h=this.tileCache;this.tileCache=this.tileCache2,this.tileCache2=h,this.refreshCache=!1}}(this.term,(t,e)=>this.getTile(t,e),this.level.width,this.level.height),this.eng.setMaskFunc((t,e)=>this.wholeMap||this.stage.at(t,e).seen),this.eng.setShaderFunc((t,e,s,i)=>this.lighting(t,e,s,i)),clearInterval(this.drawInterval),this.drawInterval=setInterval(()=>{this.drawScene()},this.interval)},drawScene(){const t=Date.now();this.ts+1e3<t&&(this.ts=t),this.eng.update(this.pos.x,this.pos.y),this.term.render(),this.step+=1},lighting(t,e,s,i){if(this.wholeMap)return t.lighted(1);const r=this.stage.at(e,s);return r.visible&&t.lighted?t.lighted(r.degree):t}},computed:{stage(){return this.wholeMap?this.level:this.player.stageMemory(this.level)},animationFps(){return 1e3/this.interval},tileItems(){let t=this.stage.at(this.player.pos.x,this.player.pos.y).items();return t&&t.bunch}},mounted(){this.initViewport()},beforeDestroy(){clearInterval(this.drawInterval)},watch:{interval(){this.initViewport()}}}),gi=(s(45),Object(Qe.a)(mi,function(){var t=this.$createElement;return(this._self._c||t)("div",{ref:"scene",staticClass:"unicodetiles"})},[],!1,null,null,null));gi.options.__file="Scene.vue";var fi=gi.exports,vi=i.a.extend({name:"PrimaryAttribute",props:["name","slug","attr","fullName"],computed:{id(){return`${this.slug}-container`},modifier(){return Object(r.sum)(this.attr.modifiers)}}}),wi=Object(Qe.a)(vi,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"simple-popover",attrs:{id:t.id}},[s("div",{staticClass:"title"},[t._v(t._s(t.name))]),s("div",{staticClass:"value"},[t._v(t._s(t.attr.currentValue))]),s("b-popover",{attrs:{target:t.id,triggers:"hover",container:t.id,placement:"top"}},[[s("big",{staticClass:"name"},[t._v(t._s(t.fullName))]),s("p",[s("span",{staticClass:"name"},[t._v("Базовый:")]),t._v(" "),s("span",{staticClass:"description"},[t._v(t._s(t.attr.current))])]),s("p",[s("span",{staticClass:"name"},[t._v("Модификатор:")]),t._v(" "),s("span",{staticClass:"description"},[t._v(t._s(t.modifier))])])]],2)],1)},[],!1,null,null,null);wi.options.__file="PrimaryAttribute.vue";var bi=wi.exports,yi=i.a.extend({name:"Stats",props:["creature","levelMap"],components:{PrimaryAttribute:bi},computed:{levelProgress(){const t=this.creature.level;return`${t.currentExperience/t.requiredExperience*100}%`},healthLevel(){const t=this.creature.characteristics.health;return`${t.currentValue/(t.maximum||0)*100}%`}},methods:{displayAttribute:t=>t.currentValue!=t.maximum?`${t.currentValue} / ${t.maximum}`:t.currentValue}}),xi=(s(47),Object(Qe.a)(yi,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"panel container"},[s("div",{staticClass:"level cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.creature.level.current))]),s("div",{staticClass:"note"},[t._v("Уровень"),s("div",{staticClass:"progress"},[s("div",{staticClass:"progress-bar bg-success",style:{width:t.levelProgress},attrs:{role:"progressbar"}})])])]),s("div",{staticClass:"hp cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.displayAttribute(t.creature.characteristics.health)))]),s("div",{staticClass:"bar",style:{height:t.healthLevel}})]),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"attack",name:"А","full-name":"Атака",attr:t.creature.characteristics.attack}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"defense",name:"З","full-name":"Защита",attr:t.creature.characteristics.defense}}),s("PrimaryAttribute",{staticClass:"attribute",attrs:{slug:"speed",name:"С","full-name":"Скорость",attr:t.creature.characteristics.speed}}),s("div",{staticClass:"cell"},[s("div",{staticClass:"value"},[t._v(t._s(t.levelMap.name))])])],1)},[],!1,null,"b8b31b14",null));xi.options.__file="Stats.vue";var Mi=xi.exports,Ci=i.a.extend({name:"Impacts",props:["impacts"],methods:{icon(t){switch(t){case le.Blind:return"blind";case le.Stressed:case le.Loaded:case le.Overloaded:return"weight"}},title(t){switch(t){case le.Blind:return"Слепота";case le.Stressed:return"Нагружен";case le.Loaded:return"Груженый";case le.Overloaded:return"Перегруженый"}}}}),ki=(s(49),Object(Qe.a)(Ci,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"panel"},t._l(t.impacts,function(e){return s("div",{staticClass:"impact-block"},[s("img",{staticClass:"icon",attrs:{src:"assets/impacts/"+t.icon(e)+".svg"}}),s("div",{staticClass:"title",domProps:{textContent:t._s(t.title(e))}})])}))},[],!1,null,"436b0ad3",null));ki.options.__file="Impacts.vue";var Ti=ki.exports,Ii=i.a.extend({name:"IdleView",props:["screen"],methods:{close(t){this.screen.onInput(t)},onEvent(t){switch(t.key){case"l":case"ArrowRight":return this.close(pe.Right);case"h":case"ArrowLeft":return this.close(pe.Left);case"k":case"ArrowUp":return this.close(pe.Up);case"j":case"ArrowDown":return this.close(pe.Down);case"y":return this.close(pe.UpLeft);case"u":return this.close(pe.UpRight);case"b":return this.close(pe.DownLeft);case"n":return this.close(pe.DownRight);case"H":return this.close(pe.Handle);case"i":return this.close(pe.Inventory);case"I":return this.close(pe.Bag);case"t":return this.close(pe.Missile);case",":return this.close(pe.PickUp);case"d":return this.close(pe.Drop);case"D":return this.close(pe.Drink)}}}}),Ri=Object(Qe.a)(Ii,function(){var t=this.$createElement;return(this._self._c||t)("div")},[],!1,null,null,null);Ri.options.__file="IdleView.vue";var Ei=Ri.exports,Si=i.a.extend({props:["screen"],data:()=>({picked:null}),methods:{close(t){const e=t||this.picked;e&&this.screen.pickProfession(e)},onEvent(t){switch(t.key){case"a":this.picked=this.screen.options[0];break;case"b":this.picked=this.screen.options[1];break;case" ":case"Enter":this.close();default:return}},iconPath:t=>"assets/professions/"+["acrobatic.svg","button-finger.svg","disintegrate.svg","flying-fox.svg","amputation.svg","catch.svg","divert.svg","fruiting.svg","annexation.svg","conversation.svg","dodging.svg","grab.svg","arrest.svg","convince.svg","drinking.svg","journey.svg","back-forth.svg","coronation.svg","drop-weapon.svg","juggler.svg","backstab.svg","crafting.svg","drowning.svg","jump-across.svg","boot-stomp.svg","crush.svg","eating.svg","kindle.svg","bowman.svg","discussion.svg","expander.svg","kneeling.svg"][t]}}),Pi=(s(51),Object(Qe.a)(Si,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal text-center"},[s("div",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("div",{staticClass:"content"},t._l(t.screen.options,function(e){return s("div",{key:e.id,staticClass:"option p-2 m-3",class:{picked:t.picked&&t.picked.id===e.id},on:{click:function(s){t.picked=e},dblclick:function(s){t.close(e)}}},[s("img",{staticClass:"icon",attrs:{src:t.iconPath(e.id)}}),s("div",{staticClass:"name"},[t._v(t._s(e.name))])])})),s("div",{staticClass:"bottom"},[null!==t.picked?s("b-btn",{attrs:{variant:"success"},on:{click:t.close}},[t._v("Подтвердить")]):t._e()],1)])},[],!1,null,null,null));Pi.options.__file="ProfessionPickingView.vue";var _i=Pi.exports;var Di=i.a.extend({name:"Inventory",props:["screen"],data:()=>({page:0,perPage:20,selected:[]}),computed:{player(){return this.screen.player},carryingWeight(){return`Нагрузка ${Math.round(100*this.player.stuffWeight.current)/100} из ${this.player.carryingCapacity.stressed}`}},methods:{onEvent(t){switch(t.key){case"Escape":return this.screen.close();case"Enter":case" ":return this.screen.pickUpItems(this.selected.map(t=>this.screen.positions[t]));default:return this.selectAt(t.key.charCodeAt(0)-97)}},selectAt(t){t>=0&&t<Math.min(this.perPage,this.screen.positions.length)&&(this.screen.singleItemMode?this.screen.withItem(this.screen.positions[t]):this.selected.indexOf(t)>=0?this.selected.splice(this.selected.indexOf(t),1):this.selected.push(t))},indexLetter:t=>String.fromCharCode(97+t),positionSelected(t){return this.selected.indexOf(t)>=0},positionStatus:t=>t.item?"text-success":"",itemWeight:t=>t.item.weight*t.count}}),Ai=(s(53),Object(Qe.a)(Di,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("span",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("div",{staticClass:"subtitle my-3",domProps:{textContent:t._s(t.carryingWeight)}}),s("table",{staticClass:"container positions-list"},t._l(t.screen.positions,function(e,i){return s("tr",{key:i,class:t.positionStatus(e)},[s("td",{staticClass:"selected"},[t.positionSelected(i)?s("div",{staticClass:"sign"},[t._v("+")]):t._e()]),s("td",{staticClass:"letter"},[t._v(t._s(t.indexLetter(i)))]),s("td",{staticClass:"separator"},[t._v("—")]),s("td",{staticClass:"name"},[t._v(t._s(e.item.name)+" ("+t._s(e.count)+")")]),s("td",{staticClass:"weight"},[t._v("["+t._s(t.itemWeight(e))+"kg]")])])}))])},[],!1,null,null,null));Ai.options.__file="ItemsListingView.vue";var Wi=Ai.exports;var Oi=i.a.extend({props:["screen"],data:()=>({picked:null,professionIndex:0}),computed:{option(){return this.screen.options[this.professionIndex]},profession(){return this.option.profession},groupedTalents(){let t=new Array(5);for(let e=0;e<t.length;e++)t[e]=[];let e=0;return this.option.talents.forEach(s=>{s.status===de.Available&&Object.assign(s,{letter:String.fromCharCode(97+e++)}),t[s.depth].push(s)}),t}},methods:{close(t){const e=t||this.picked;e&&e.status===de.Available&&(this.screen.pickTalent(this.profession.id,e.id),this.picked=null)},pickTalent(t){t.status===de.Available&&(this.picked=t)},onEvent(t){switch(t.key){case" ":case"Enter":this.close();default:this.groupedTalents.forEach(e=>e.forEach(e=>{e.letter===t.key&&(this.picked=e)}));const e=parseInt(t.key);e>=1&&e<=this.screen.options.length&&(this.professionIndex=e-1)}},talentTip(t){let e=`${t.rank}/${t.maxRank}`;return t.rank>=t.maxRank?e:`${t.letter} ${e}`},talentStatus(t){if(this.picked&&this.picked.id===t.id)return"-selected";switch(t.status){case de.Available:return"-available";case de.Unavailable:return"-unavailable";case de.Completed:return"-completed"}},iconPath(t){switch(t){case hs.AttackerTwoHandedWeapons:return"AttackerTwoHandedWeapons.svg";case hs.AttackerHeavyWeapons:return"AttackerHeavyWeapons.svg";case hs.AttackerLightWeapons:return"AttackerLightWeapons.svg";case hs.AttackerTwoWeapons:return"AttackerTwoWeapons.svg";case hs.AttackerDoubleTwoHandedWeapons:return"AttackerDoubleTwoHandedWeapons.svg";case hs.AttackerStrongGrip:return"AttackerStrongGrip.svg"}}},watch:{professionIndex(){this.picked=null}}}),Ni=(s(55),Object(Qe.a)(Oi,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"simple-popover screen-modal text-center",attrs:{id:"talents-tree-container"}},[s("div",{staticClass:"title"},[t._v(t._s(t.screen.title))]),s("b-tabs",{staticClass:"tabs-list",attrs:{card:""},model:{value:t.professionIndex,callback:function(e){t.professionIndex=e},expression:"professionIndex"}},t._l(t.screen.player.professions,function(t){return s("b-tab",{key:t.id,attrs:{title:t.name,"no-body":""}})})),s("table",{staticClass:"content"},t._l(t.groupedTalents,function(e,i){return s("tr",{key:i},t._l(e,function(e,r){return s("td",{key:r,staticClass:"cell"},[s("div",{staticClass:"talent-cell",class:t.talentStatus(e),attrs:{id:r+"talentTree-"+i,variant:"primary"},on:{click:function(s){t.pickTalent(e)},dblclick:function(s){t.close(e)}}},[s("img",{staticClass:"icon",attrs:{src:"assets/talents/"+t.iconPath(e.id)}}),s("span",{staticClass:"level"},[t._v(t._s(t.talentTip(e)))]),s("b-popover",{attrs:{target:r+"talentTree-"+i,triggers:"hover",container:"talents-tree-container"}},[[s("p",{staticClass:"name"},[t._v(t._s(e.name))]),s("small",[s("p",{staticClass:"rank"},[t._v("Уровень "+t._s(e.rank)+"/"+t._s(e.maxRank))]),"-unavailable"===t.talentStatus(e)?s("p",{staticClass:"requirements"},[t._v("Требуется "+t._s(e.depth*t.profession.depthCost)+" очков в "+t._s(t.profession.name))]):t._e(),s("p",{staticClass:"description"},[t._v(t._s(e.description))])])]],2)],1)])}))})),null!==t.picked?s("b-btn",{attrs:{variant:"default"},on:{click:function(e){t.close()}}},[t._v("Подтвердить")]):t._e()],1)},[],!1,null,null,null));Ni.options.__file="TalentsTreeView.vue";var Bi=Ni.exports;var Li=i.a.extend({name:"Inventory",props:["screen"],data:()=>({page:0,perPage:20}),computed:{player(){return this.screen.player},carryingWeight(){return`Нагрузка ${Math.round(100*this.player.stuffWeight.current)/100} из ${this.player.carryingCapacity.stressed}`}},methods:{onEvent(t){switch(t.key){case" ":case"Escape":return this.screen.close();default:return this.selectAt(t.key.charCodeAt(0)-97)}},selectAt(t){if(t>=0&&t<Math.min(this.perPage,this.screen.positions.length)){const e=this.screen.positions[t];e.item?this.screen.takeOff(e):e.availableItems.length&&this.screen.putOn(e)}},indexLetter:t=>String.fromCharCode(97+t),positionStatus:t=>t.item?"text-success":"",positionDetails(t){if(t.item&&t.item.canSeeDetails)return t.item instanceof Ot?t.item.damages.map(this.showDamage).join(","):t.item instanceof Bt?t.item.protections.map(this.showProtection).join(","):void 0},showDamage({extra:t,dice:{times:e,max:s},type:i}){let r=`${this.showDamageType(i)} ${e}d${s}`;return t&&(r+=`+${t}`),r},showDamageType(t){switch(t){case vt.Melee:return"Me";case vt.Pierce:return"Pi";case vt.Blunt:return"B";case vt.Magic:return"Mg";case vt.Pure:return"Pu";default:return"unknown damage type"}},showProtection({type:t,value:e}){switch(t){case wt.Light:return`L${e}`;case wt.Medium:return`M${e}`;case wt.Heavy:return`H${e}`;case wt.Solid:return`S${e}`;case wt.Unarmored:return`U${e}`;default:return"unknown protection type"}},displayBodyPart:t=>t.name,displayItem(t){if(t)return`${ti(t).getChar()} ${t.name}`},itemName:t=>t.item&&t.count?`${t.item.name} ${t.count>1?`(${t.count})`:""}`:"-",itemWeight(t){if(t.item&&t.count)return`[${t.item.weight*t.count}kg]`},available:t=>t.item||t.availableItems.length,availableStatus(t){return this.available(t)?"-available":"-unavailable"}}}),Ui=(s(57),Object(Qe.a)(Li,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"screen-modal"},[s("div",{staticClass:"h4 title"},[t._v("Инвентарь")]),s("div",{staticClass:"subtitle my-3",domProps:{textContent:t._s(t.carryingWeight)}}),s("table",{staticClass:"content inventory-list"},t._l(t.screen.positions,function(e,i){return s("tr",{key:i,class:t.availableStatus(e)},[s("td",{staticClass:"slot"},[s("span",{staticClass:"letter"},[t._v(t._s(t.indexLetter(i)))]),s("span",{staticClass:"dash"},[t._v("—")]),s("span",{staticClass:"part"},[t._v(t._s(t.displayBodyPart(e.inventorySlot)))]),s("span",{staticClass:"separator"},[t._v(":")])]),s("td",{staticClass:"name-slot"},[s("div",{staticClass:"name",class:t.positionStatus(e)},[t._v(t._s(t.itemName(e)))]),s("small",{staticClass:"details",domProps:{textContent:t._s(t.positionDetails(e))}})]),s("td",{staticClass:"weight"},[t._v(t._s(t.itemWeight(e)))])])}))])},[],!1,null,null,null));Ui.options.__file="InventoryView.vue";var $i=Ui.exports,Fi=i.a.extend({name:"MissileView",props:["screen"],methods:{close(t){this.screen.onInput(t)},onEvent(t){switch(t.key){case"l":case"ArrowRight":return this.screen.moveTarget(m.right);case"h":case"ArrowLeft":return this.screen.moveTarget(m.left);case"k":case"ArrowUp":return this.screen.moveTarget(m.up);case"j":case"ArrowDown":return this.screen.moveTarget(m.down);case"y":return this.screen.moveTarget(m.upLeft);case"u":return this.screen.moveTarget(m.upRight);case"b":return this.screen.moveTarget(m.downLeft);case"n":return this.screen.moveTarget(m.downRight);case">":this.screen.nextTarget();break;case"<":this.screen.previousTarget();break;case"t":this.screen.attack();break;case"Escape":this.screen.close()}}}}),ji=Object(Qe.a)(Fi,function(){var t=this.$createElement;return(this._self._c||t)("div")},[],!1,null,null,null);ji.options.__file="MissileView.vue";var Hi=ji.exports,Vi=i.a.extend({name:"DeathView",props:["screen"],computed:{message(){switch(this.screen.dieReason){case bt.Attack:return"Смерть в бою честь для героя. Но жить мне все-таки нравилось больше";case bt.Missile:return"Раньше меня вела дорога приключений, но теперь и мне прострелили колено";case bt.Trap:return"Я так и не научился смотреть под ноги";case bt.Overloaded:return"Тяжко уйти от бремени, которое сам себе навязываешь.";default:return"Скучная смерть, которая даже не заслужила отдельного сообщения"}},signature(){return`Признался ${this.screen.playerName} перед смертью`}},methods:{onEvent(t){}}}),Gi=(s(59),Object(Qe.a)(Vi,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"screen-modal"},[e("div",{staticClass:"h4 title"},[this._v("Ты умер")]),e("div",{staticClass:"content mt-5"},[e("blockquote",{staticClass:"blockquote text-center signature"},[e("p",{staticClass:"mb-0",domProps:{textContent:this._s(this.message)}}),e("footer",{staticClass:"blockquote-footer",domProps:{textContent:this._s(this.signature)}})])])])},[],!1,null,null,null));Gi.options.__file="DeathView.vue";var qi=Gi.exports,zi=s(17),Yi=i.a.extend({data:()=>({game:(new class{constructor(){this.game=new Us(this.initPlayer());const t=new Ls;t.register(this.game),t.enter(this.game,this.game.player);const e=this.game.player,s=this.game.professionPicker.available(e)[1];s&&e.professions.push(s);const i=new Nt("Dagger",.8,[{type:vt.Melee,dice:{times:1,max:3},extra:2}]),r=new Nt("Katana",1,[{type:vt.Melee,dice:{times:5,max:2},extra:0}]),a=new Lt("Латы",1,[{type:wt.Heavy,value:5}]),n=xs(),h=Ms(),o=ys(),c=bs();if(this.game.currentMap){const t=this.game.currentMap.creatureTile(e);t.addItem(i,2),t.addItem(r,1),t.addItem(a,1),t.addItem(n,5),t.addItem(h,5),t.addItem(o,5),t.addItem(c,2),e.on(new Yt(t,[{item:i,count:2},{item:r,count:1},{item:a,count:1},{item:n,count:5},{item:h,count:5},{item:o,count:5},{item:c,count:2}],this.game)),e.inventory.missileWeaponSlot.equip(e,c),e.inventory.missileSlot.equip(e,n),e.inventory.rightHandSlot.equip(e,r),e.inventory.bodySlot.equip(e,a),e.inventory.putToBag(new Ts,1),this.game.logger.reset()}}initPlayer(){return new F(new fe([1,3,5,10,20]),new be({attack:1,defense:4,dexterity:3,health:100,radius:10,speed:80}),new kt,new B("Player",80,x.Player,N))}}).game,ts:Date.now(),loopIntervalId:void 0}),components:{Impacts:Ti,Logger:ts,Scene:fi,Stats:Mi},computed:{viewComponent(){switch(this.game.ai&&this.game.ai.presenter&&this.game.ai.presenter.type){case pt.AbilitiesPicking:return Bi;case pt.ProfessionPicking:return _i;case pt.Idle:return Ei;case pt.ItemsListing:return Wi;case pt.Inventory:return $i;case pt.Missile:return Hi;case pt.Death:return qi}}},methods:{loop(){this.game.turn()},onEvent(t){const e=this.$refs.viewComponent;e&&e.onEvent(t)}},created(){this.loopIntervalId=Object(zi.setInterval)(this.loop,10),document.addEventListener("keydown",this.onEvent)},beforeDestroy(){Object(zi.clearInterval)(this.loopIntervalId),document.removeEventListener("keydown",this.onEvent)}}),Xi=(s(61),Object(Qe.a)(Yi,function(){var t=this,e=t.$createElement,s=t._self._c||e;return t.game?s("div",{staticClass:"container-fluid",attrs:{id:"app"}},[t.game.player&&!t.game.player.dead?s("Scene",{staticClass:"scene",attrs:{level:t.game.currentMap,player:t.game.player,pos:t.game.currentMap.creaturePos(t.game.player)}}):t._e(),t.game.player&&!t.game.player.dead?s("Stats",{staticClass:"player-stats",attrs:{creature:t.game.player,"level-map":t.game.currentMap}}):t._e(),s("Logger",{staticClass:"logger-panel",attrs:{logger:t.game.logger}}),s("Impacts",{staticClass:"effect-panel",attrs:{impacts:t.game.player.impacts}}),t.game.player&&t.game.player.dead?s("div",[t._v("You are dead")]):t._e(),t.game.ai?s(t.viewComponent,{ref:"viewComponent",tag:"component",attrs:{screen:t.game.ai.presenter}}):t._e()],1):t._e()},[],!1,null,null,null));Xi.options.__file="App.vue";var Ji=Xi.exports,Ki=s(26);s(71),s(73),s(75);i.a.use(Ki.a),new i.a({el:"#app",render:t=>t(Ji)})}]);
//# sourceMappingURL=main.a2e3c840.js.map
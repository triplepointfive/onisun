!function(t){function i(i){for(var s,h,a=i[0],n=i[1],l=i[2],d=0,u=[];d<a.length;d++)h=a[d],o[h]&&u.push(o[h][0]),o[h]=0;for(s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s]);for(c&&c(i);u.length;)u.shift()();return r.push.apply(r,l||[]),e()}function e(){for(var t,i=0;i<r.length;i++){for(var e=r[i],s=!0,a=1;a<e.length;a++){var n=e[a];0!==o[n]&&(s=!1)}s&&(r.splice(i--,1),t=h(h.s=e[0]))}return t}var s={},o={1:0};var r=[];function h(i){if(s[i])return s[i].exports;var e=s[i]={i:i,l:!1,exports:{}};return t[i].call(e.exports,e,e.exports,h),e.l=!0,e.exports}h.m=t,h.c=s,h.d=function(t,i,e){h.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:e})},h.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},h.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return h.d(i,"a",i),i},h.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},h.p="/";var a=window.webpackJsonp=window.webpackJsonp||[],n=a.push.bind(a);a.push=i,a=a.slice();for(var l=0;l<a.length;l++)i(a[l]);var c=n;r.push([38,0]),e()}({12:function(t,i,e){"use strict";e.r(i);var s,o,r,h=e(2),a=e(0);!function(t){t[t.Wall=0]="Wall",t[t.Door=1]="Door",t[t.Floor=2]="Floor"}(s||(s={}));class n{constructor(t,i,e){this.key=t,this.display=i,this.type=e,n.register(t,this)}static register(t,i){if(this.repository[t])throw`Tile '${t}' is already registered!`;this.repository[t]=i}static retrive(t){let i=this.repository[t];if(!i)throw`Tile '${t}' is not registered!`;return i}visibleThrough(){return this.type===s.Floor}passibleThrough(){return this.type!==s.Wall}}n.repository={},new n("R"," ",s.Floor),new n("C"," ",s.Floor),new n("W","#",s.Wall),new n("D","+",s.Door);class l{constructor(t,i){if(this.content=t,this.weight=i,t.length!==l.Dimensions||t.some(t=>t.length!==l.Dimensions))throw`Invalid block '${t}'`;this.id=t.map(t=>t.map(t=>t.key).join("")).join("")}matchRight(t){return this.matchHorizontal(this,t)}matchLeft(t){return this.matchHorizontal(t,this)}matchTop(t){return this.matchVertical(t,this)}matchBootom(t){return this.matchVertical(this,t)}mirrorVertically(){return new l(a.cloneDeep(this.content).reverse(),this.weight)}mirrorHorizontally(){return new l(a.cloneDeep(this.content).map(t=>t.reverse()),this.weight)}rotateRight(){return new l(this.rotate(a.cloneDeep(this.content)),this.weight)}rotate(t){let i;t=t.reverse();for(let e=0;e<t.length;e++)for(let s=0;s<e;s++)i=t[e][s],t[e][s]=t[s][e],t[s][e]=i;return t}matchHorizontal(t,i){return a.isEqual(t.content.map(t=>t[l.Dimensions-1]),i.content.map(t=>t[0]))}matchVertical(t,i){return a.isEqual(t.content[l.Dimensions-1],i.content[0])}}l.Dimensions=3,function(t){t[t.Top=0]="Top",t[t.Bottom=1]="Bottom",t[t.Left=2]="Left",t[t.Right=3]="Right"}(o||(o={}));!function(t){t[t.EMPTY=0]="EMPTY",t[t.CONFIRMED=1]="CONFIRMED"}(r||(r={}));class c{constructor(){this.state=r.EMPTY}isFinished(){return void 0!==this.block&&this.state===r.CONFIRMED}confirmBlock(){this.state=r.CONFIRMED}}class d{static addDoor(){return Math.random()>.5}}var u=h.a.extend({props:["cell","player"],computed:{style(){return this.player?"player":this.cell.type==s.Wall?"wall":this.cell.type==s.Door?"door":"floor"},symbol(){return this.player?"俺":" "==this.cell.display?"・":"+"==this.cell.display?"戸":"#"==this.cell.display?"＃":"E"}}}),p=e(4);var g=function(t){e(32)},b=Object(p.a)(u,function(){var t=this,i=t.$createElement;return(t._self._c||i)("td",{class:t.style,domProps:{textContent:t._s(t.symbol)},on:{click:function(i){t.$emit("setPosition")}}})},[],!1,g,null,null).exports;const y=function(t){return String.fromCharCode(t.charCodeAt(0)+1)},f=function(t,i,e){let s=Array(t),o=0;for(;o<t;){s[o]=new Array(i);let t=0;for(;t<i;)s[o][t]=e(o,t),t++;o++}return s};const m=function(t,i){const e=t.stageMemory;let s=f(e.height,e.width,()=>{}),o=[],r=[{x:t.x,y:t.y}],h=0;for(;r.length&&!o.length;){let t=[];r.forEach(r=>{e.at(r.x,r.y).tangible||void 0!==s[r.x][r.y]||(s[r.x][r.y]=h,i(r.x,r.y)?o.push(r):(t.push({x:r.x-1,y:r.y}),t.push({x:r.x+1,y:r.y}),t.push({x:r.x,y:r.y-1}),t.push({x:r.x,y:r.y+1}),t.push({x:r.x-1,y:r.y-1}),t.push({x:r.x+1,y:r.y-1}),t.push({x:r.x+1,y:r.y+1}),t.push({x:r.x-1,y:r.y+1})))}),h++,r=t}return o.length?(o[Math.floor(Math.random()*o.length)],k(o[0],s)):[]},k=function(t,i){let e=t.x,s=t.y,o=[{x:e,y:s}],r=void 0;for(;0!==i[e][s];)r=[{x:-1,y:0},{x:1,y:0},{x:0,y:-1},{x:0,y:1},{x:-1,y:-1},{x:1,y:1},{x:1,y:-1},{x:-1,y:1}].find(t=>i[e+t.x]&&i[e+t.x][s+t.y]===i[e][s]-1),e+=r.x,s+=r.y,o.unshift({x:e,y:s});return o};var w=e(11);class v{constructor(t,i){this.i="a",this.step=0,this.graph=new w.Graph,this.addNode(t,i,!1),this.lastNodeVisit={},this.markNodeVisited(this.currentNodeID),this.path=[]}act(t){this.path.length?this.moveToTarget(t):(this.targetNodeID&&(this.markNodeVisited(this.targetNodeID),this.currentNodeID=this.targetNodeID),this.pickUpNewTarget(t),this.moveToTarget(t)),this.step+=1}addNode(t,i,e=!0){this.graph.setNode(this.i,{x:t,y:i}),e&&this.graph.setEdge(this.currentNodeID,this.i),this.currentNodeID=this.i,this.i=y(this.i)}buildNewPath(t){const i=this.graph.node(this.targetNodeID);this.path=m(t,(t,e)=>i.x===t&&i.y===e)}pickUpNewTarget(t){let i=this.currentNodeID,e=this.lastNodeVisit[i];this.graph.neighbors(this.currentNodeID).forEach(t=>{e>(this.lastNodeVisit[t]||0)&&(i=t),e=this.lastNodeVisit[i]}),this.targetNodeID=i,this.buildNewPath(t)}moveToTarget(t){const i=this.path.shift();t.stageMemory[i.x][i.y].tangible?(this.path=[],this.act(t)):(t.x=i.x,t.y=i.y)}markNodeVisited(t){this.lastNodeVisit[t]=this.step}}const R=10;class x{constructor(t){this.patrol=t,this.path=[],this.step=R}act(t){if(this.updatePatrol(t),this.path.length){const i=this.path.shift();t.stageMemory.at(i.x,i.y).tangible?(this.path=[],this.act(t)):(t.x=i.x,t.y=i.y)}else this.buildNewPath(t),this.path.length?this.act(t):t.ai=this.patrol}buildNewPath(t){this.path=m(t,(i,e)=>!t.stageMemory.at(i,e).seen)}updatePatrol(t){this.step===R&&(this.step=0,void 0===this.patrol?this.patrol=new v(t.x,t.y):this.patrol.addNode(t.x,t.y)),this.step++}}class W{constructor(t,i,e,s,o,r,h){this.startx=t,this.starty=i,this.radius=e,this.width=s,this.height=o,this.checkSolid=r,this.markVisible=h,this.doubleRadius=this.radius*this.radius}calc(){this.markVisible(this.startx,this.starty,1),this.checkSolid(this.startx,this.starty)||[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([t,i])=>{this.castLight(1,1,0,0,t,i,0),this.castLight(1,1,0,t,0,0,i)})}castLight(t,i,e,s,o,r,h){if(i<e)return;let a=0,n=!1;for(let l=t;l<=this.radius&&!n;l++){let t=-l;for(let c=-l;c<=0;c++){let d=Math.round(this.startx+c*s+t*o),u=Math.round(this.starty+c*r+t*h),p=(c-.5)/(t+.5),g=(c+.5)/(t-.5);if(d>=0&&u>=0&&d<this.width&&u<this.height&&!(i<g)){if(e>p)break;this.doubleDistance(c,t)<=this.doubleRadius&&this.markVisible(d,u,1-this.doubleDistance(c,t)/this.doubleRadius),n?this.checkSolid(d,u)?a=g:(n=!1,i=a):this.checkSolid(d,u)&&l<this.radius&&(n=!0,this.castLight(l+1,i,p,s,o,r,h),a=g)}}}}doubleDistance(t,i){return t*t+i*i}}class M{constructor(t){this.tile=t,this.visible=!1,this.degree=0,this.seen=!1,this.tangible=!1}}class C{constructor(t,i,e=(()=>new M)){this.width=t,this.height=i,this.field=f(i,t,e)}at(t,i){return this.field[i][t]}resetVisible(){this.field.forEach(t=>{t.forEach(t=>{t.visible=!1})})}}var N=h.a.extend({data:()=>({blocks:[{content:["WWW","WWW","WWW"],weight:.5},{content:["RRR","RRR","RRR"],weight:20},{content:["WCW","RRR","RRR"],weight:20},{content:["WWC","RRR","RRR"],weight:20},{content:["CWC","RRR","RRR"],weight:20},{content:["WWW","RRR","RRR"],weight:20},{content:["WCW","CRR","WRR"],weight:20},{content:["WWW","WRR","WRR"],weight:20},{content:["WWW","CRR","WRR"],weight:20},{content:["WWC","WRR","WRR"],weight:20},{content:["WWC","WRR","CRR"],weight:20},{content:["WWW","CCW","WCW"],weight:20},{content:["WWW","CCC","WWW"],weight:20},{content:["WCW","CCC","WWW"],weight:20},{content:["WCW","CCC","WCW"],weight:20}],map:[],radius:10,player:{x:1,y:1},pause:!0,ts:Date.now()}),components:{Cell:b},computed:{walker(){if(this.map)return new class{constructor(t,i,e=10,s,o){this.x=t,this.y=i,this.radius=e,this.stageMemory=new C(s,o),this.ai=new x}act(t){this.visionMask(t),this.ai.act(this)}visionMask(t){this.stageMemory.resetVisible(),new W(this.x,this.y,this.radius,t.width,t.height,(i,e)=>!t.visibleThrough(i,e),(i,e,s)=>{const o=this.stageMemory.at(i,e);o.visible=!0,o.degree=s,o.seen=!0,o.tangible=!t.passibleThrough(i,e)}).calc()}}(this.player.x,this.player.y,this.radius,this.levelMap.width,this.levelMap.height)},levelMap(){if(this.map)return new class{constructor(t){this.map=t,this.width=t[0].length,this.height=t.length}visibleThrough(t,i){return this.map[i][t].visibleThrough()}passibleThrough(t,i){return this.map[i][t].passibleThrough()}}(this.map)},fov(){return this.ts&&this.map?this.walker.stageMemory.field:[]}},methods:{updatePlayerPosition(t,i){this.pause=!1,this.player.x=t,this.player.y=i},buildMap(){let t=new class{constructor(t){this.borderBlock=t,this.blocks=[],this.uniqBlockIds=new Set,this.neighbors={},this.addBlock(t)}addBlock(t,i=!1){if(this.uniqBlockIds.has(t.id))return;if(this.blocks.push(t),this.uniqBlockIds.add(t.id),this.findNeighbors(t),!i){const i=t.mirrorHorizontally();this.addBlock(i,!0),this.addBlock(t.mirrorVertically(),!0),this.addBlock(i.mirrorVertically(),!0)}let e=t.rotateRight();for(let t=0;t<3;t++)this.addBlock(e,!0),e=e.rotateRight()}available(t,i,e,s){let r=this.blocks;return void 0!==t&&(r=a.intersection(r,this.neighbors[t.id][o.Bottom])),void 0!==i&&(r=a.intersection(r,this.neighbors[i.id][o.Top])),void 0!==e&&(r=a.intersection(r,this.neighbors[e.id][o.Right])),void 0!==s&&(r=a.intersection(r,this.neighbors[s.id][o.Left])),a.sortBy(r,t=>Math.random()*t.weight)}findNeighbors(t){this.blocks.forEach(i=>{t.matchTop(i)&&(this.addNeighbor(t,i,o.Top),this.addNeighbor(i,t,o.Bottom)),t.matchBootom(i)&&(this.addNeighbor(t,i,o.Bottom),this.addNeighbor(i,t,o.Top)),t.matchLeft(i)&&(this.addNeighbor(t,i,o.Left),this.addNeighbor(i,t,o.Right)),t.matchRight(i)&&(this.addNeighbor(t,i,o.Right),this.addNeighbor(i,t,o.Left))})}addNeighbor(t,i,e){this.neighbors[t.id]||(this.neighbors[t.id]={[o.Top]:[],[o.Bottom]:[],[o.Left]:[],[o.Right]:[]}),this.neighbors[t.id][e].push(i)}}(new l(this.rawToTiles(this.blocks[0].content),this.blocks[0].weight));a.tail(this.blocks).forEach(({content:i,weight:e})=>{t.addBlock(new l(this.rawToTiles(i),e))});let i=new class{constructor(t,i,e){this.width=t,this.height=i,this.blockRepository=e,this.blockMap=[],this.map=[],this.steps=0,this.initializeBlockMap()}initializeBlockMap(){for(let t=0;t<this.height;t++){let i=[];for(let e=0;e<this.width;e++){let s=new c;0!==t&&0!==e&&t!==this.height-1&&e!==this.width-1||(s.confirmBlock(),s.block=this.blockRepository.borderBlock),i.push(s)}this.blockMap.push(i)}}toMap(){return this.map}fillMap(t,i){if(void 0!==this.blockMap[t][i].block)return!0;if(this.steps+=1,this.steps>1e5)throw"failed to generate";const e=this.blockMap[t-1][i].block,s=this.blockMap[t+1][i].block,o=this.blockMap[t][i-1].block,r=this.blockMap[t][i+1].block,h=this.blockRepository.available(e,s,o,r);for(let e=0;e<h.length;e++){const s=h[e];if(this.blockMap[t][i].block=s,this.fillMap(t-1,i)&&this.fillMap(t,i-1)&&this.fillMap(t+1,i)&&this.fillMap(t,i+1))break;this.blockMap[t][i].block=void 0}return void 0!==this.blockMap[t][i].block}postProcess(){this.buildMap(),this.addDoors()}buildMap(){const t=this.height-1,i=this.width-1;for(let e=1;e<t;e++)for(let s=0;s<l.Dimensions-(e===t-1?0:1);s++){let t=[];for(let o=1;o<i;o++){const r=this.blockMap[e][o].block;if(r){const e=r.content[s];t=t.concat(o===i-1?e:a.initial(e))}else{const i=new Array(l.Dimensions).fill(" ");t=t.concat(i)}}this.map.push(t)}}addDoors(){for(let t=1;t<this.map.length;t++){const i=this.map[t];for(let e=1;e<i.length;e++)"C"!==i[e].key||"R"!==this.map[t][e-1].key&&"R"!==this.map[t-1][e].key||!d.addDoor()||(i[e]=n.retrive("D"))}}}(20,20,t);return i.fillMap(1,1),i.postProcess(),clearInterval(this.walkerinterval),this.walkerinterval=setInterval(()=>{if(!this.pause)try{this.walker&&(this.walker.act(this.levelMap),this.ts=Date.now())}catch(t){console.error(t),this.pause=!0}},300),i.toMap()},rawToTiles(t){let i=[];return t.forEach(t=>{let e=[];t.split("").forEach(t=>{e.push(n.retrive(t))}),i.push(e)}),i},visibility(t,i){return this.pause?{background:"black",color:"darkgrey",opacity:.3}:this.fov.length?this.fov[t][i].visible?{opacity:this.fov[t][i].degree}:this.fov[t][i].seen?{background:"black",color:"darkgrey",opacity:.3}:{background:"black",color:"black"}:{background:"black",color:"darkgrey"}}},created(){this.map=this.buildMap()}});var D=function(t){e(34)},T=Object(p.a)(N,function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{attrs:{id:"app"}},[e("div",{staticClass:"col"},[e("table",{staticClass:"game-table"},t._l(t.map,function(i,s){return e("tr",{staticClass:"row"},t._l(i,function(i,o){return e("Cell",{key:s+"-"+o,style:t.visibility(s,o),attrs:{cell:i,player:t.walker.x==o&&t.walker.y==s},on:{setPosition:function(i){t.updatePlayerPosition(o,s)}}})}))})),e("button",{on:{click:function(i){t.map=t.buildMap()}}},[t._v("Generate!")]),e("label",[t._v("radius")]),e("input",{directives:[{name:"model",rawName:"v-model",value:t.radius,expression:"radius"}],attrs:{type:"number"},domProps:{value:t.radius},on:{input:function(i){i.target.composing||(t.radius=i.target.value)}}}),e("button",{on:{click:function(i){t.pause=!t.pause}}},[t._v(t._s(t.pause?"Start":"Pause"))])]),e("div",{staticClass:"col"},t._l(t.blocks,function(i,s){return e("div",{staticClass:"block"},[e("div",{staticClass:"wrapper"},[e("table",{staticClass:"content game-table"},t._l(t.rawToTiles(i.content),function(i,s){return e("tr",{staticClass:"row"},t._l(i,function(t,i){return e("Cell",{key:s+"-"+i,attrs:{cell:t}})}))})),e("input",{directives:[{name:"model",rawName:"v-model",value:i.weight,expression:"tile.weight"}],attrs:{type:"number"},domProps:{value:i.weight},on:{input:function(e){e.target.composing||t.$set(i,"weight",e.target.value)}}})])])}))])},[],!1,D,null,null).exports;e(17),e(15);new h.a({el:"#app",render:t=>t(T)})},17:function(t,i,e){},32:function(t,i,e){},34:function(t,i,e){},38:function(t,i,e){t.exports=e(12)}});
//# sourceMappingURL=main.c31196df.js.map